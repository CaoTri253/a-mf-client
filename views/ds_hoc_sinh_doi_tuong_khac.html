<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh (Đối tượng khác)</title>

  <!-- Disable Devtool -->
  <script src="/js/anti-devtools.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .sticky-header-box { position: sticky; top: 0; z-index: 999; background: #f8f9fa; padding-bottom: 2px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 8px; padding-bottom: 6px; background: #f8f9fa; }
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002; }
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer; }
    .table-responsive { overflow-x: auto; }
    .search-row { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; gap: 12px;
      position: sticky; top: 52px; z-index: 998; background: #f8f9fa; padding-bottom: 6px; }
    .search-input { flex: 1; min-width: 180px; }
    .total-count { font-size: 1rem; font-weight: 400; color: #444; }
    th.sortable { cursor: pointer; user-select: none; }
    .sort-icon { font-size: 15px; vertical-align: middle; margin-left: 3px; }
    .th-action { min-width: 90px; }

    /* ====== Compact modal forms for mobile ====== */
    .modal-body { padding-top: 10px; }
    .section-title { font-size: 13px; font-weight: 600; color: #333; margin: 4px 0 6px; }

    .ggrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px 10px;
      align-items: start;
    }
    .gitem .form-label { font-size: 12px; margin-bottom: 4px; color: #333; }
    .gitem .form-control { padding: 6px 10px; height: 38px; }
    .gitem .form-check-label { font-size: 13px; }
    .gitem .form-check-input { transform: scale(0.95); }

    .gitem-radio {
      padding-top: 2px;
      display: flex; gap: 16px; align-items: center;
    }

    .modal-content {
      max-height: 90vh;
      display: flex; flex-direction: column;
    }
    .modal-body { overflow: auto; }
    .modal-footer {
      position: sticky;
      bottom: 0;
      background: #fff;
      z-index: 2;
      border-top: 1px solid #eee;
    }

    @media (max-width: 600px) {
      body { padding: 12px; }
      .header { font-size: 18px; }
      .search-row { flex-direction: column; align-items: stretch; gap: 8px; }
      .btn-main { width: 100%; }
      .th-action { min-width: 70px; }
      .action-btns { display: flex; flex-direction: column; gap: 6px; }
      .action-btns .btn { width: 100%; }
      .gitem .form-control { height: 36px; padding: 6px 10px; }
    }
    @media (min-width: 601px) and (max-width: 999px) {
      .header { font-size: 20px; }
      .search-row { flex-direction: row; }
      .action-btns { display: flex; flex-direction: row; gap: 4px; }
    }
    @media (min-width: 1000px) {
      .header { font-size: 22px; }
      .search-row { flex-direction: row; }
      .action-btns { display: flex; flex-direction: row; gap: 4px; }
    }

    .btn-back {
      position: fixed; bottom: 26px; right: 20px; z-index: 1099;
      border-radius: 50%; width: 54px; height: 54px;
      box-shadow: 0 2px 14px #0003; font-size: 25px;
      display: flex; align-items: center; justify-content: center;
      background: #fff; border: 2px solid #eee; color: #2563eb; transition: box-shadow 0.12s;
    }
    .btn-back:hover { box-shadow: 0 4px 24px #2563eb33; color: #fff; background: #2563eb; }

    @media (max-width: 999px){
      nav .pagination { display: none !important; }
    }

    th.th-hoten, td.td-hoten{
      white-space: nowrap;
      min-width: 220px;
      max-width: none;
    }
  </style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span> – <span class="text-primary">ĐỐI TƯỢNG KHÁC</span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <!-- Giữ chỗ actions nhưng sẽ không render gì -->
    <div id="ds-actions" style="margin-bottom:8px;"></div>
    <div class="search-row mb-2">
      <input class="form-control search-input" id="search-box" placeholder="Tìm kiếm theo tên, mã BHXH, số ĐT, số định danh..." oninput="doSearch()">
      <button class="btn btn-danger d-none" id="btn-delete-multi" onclick="showConfirmDeleteMany()">Xóa các dòng đã chọn</button>
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

  <!-- Modal sửa học sinh (giữ nguyên để cho phép chỉnh sửa / xóa) -->
  <div class="modal fade" id="modalSuaHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Sửa thông tin học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-suahs" onsubmit="event.preventDefault();handleSuaHS();" class="form-grid">
          <input type="hidden" id="sua-stt"/>
          <div class="ggrid">
            <div class="gitem">
              <label class="form-label" for="sua-ma-so-bhxh">Mã số BHXH</label>
              <input class="form-control" id="sua-ma-so-bhxh" placeholder="Mã số BHXH" disabled/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ho-ten-hs">Họ tên học sinh</label>
              <input class="form-control" id="sua-ho-ten-hs" placeholder="Họ tên học sinh"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ngay-sinh">Ngày sinh</label>
              <input class="form-control" id="sua-ngay-sinh" type="text" placeholder="dd/mm/yyyy" autocomplete="off"/>
            </div>
            <div class="gitem">
              <label class="form-label d-block">Giới tính</label>
              <div class="gitem-radio">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="sua_gioi_tinh" id="sua-gt-nam" value="Nam">
                  <label class="form-check-label" for="sua-gt-nam">Nam</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="sua_gioi_tinh" id="sua-gt-nu" value="Nữ">
                  <label class="form-check-label" for="sua-gt-nu">Nữ</label>
                </div>
              </div>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-lop">Lớp</label>
              <input class="form-control" id="sua-lop" placeholder="Lớp" disabled/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-dia-chi">Địa chỉ</label>
              <input class="form-control" id="sua-dia-chi" placeholder="Địa chỉ"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-sdt-lienhe">Số ĐT liên hệ</label>
              <input class="form-control" id="sua-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-so-dinh-danh">Số định danh</label>
              <input class="form-control" id="sua-so-dinh-danh" placeholder="Số định danh" disabled/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ten-cha-me">Tên cha/mẹ học sinh</label>
              <input class="form-control" id="sua-ten-cha-me" placeholder="Tên cha/mẹ học sinh"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ngay-het-han-bhyt">Hạn BHYT</label>
              <input class="form-control" id="sua-ngay-het-han-bhyt" type="text" placeholder="dd/mm/yyyy" autocomplete="off"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ngay-het-han-bhtn">Hạn BHTN</label>
              <input class="form-control" id="sua-ngay-het-han-bhtn" type="text" placeholder="dd/mm/yyyy" autocomplete="off"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-noi-kham-bhyt">Nơi khám BHYT</label>
              <input class="form-control" id="sua-noi-kham-bhyt" placeholder="Nhập nơi khám BHYT" list="noiKhamList"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-doi-tuong-dong">Đối tượng đóng (tùy chọn)</label>
              <input class="form-control" id="sua-doi-tuong-dong" placeholder="Học sinh / Cận nghèo / ..." list="doiTuongList"/>
            </div>
            <div class="gitem">
              <label class="form-label" for="sua-ghi-chu">Ghi chú (tùy chọn)</label>
              <input class="form-control" id="sua-ghi-chu" placeholder="Ghi chú (nếu có)"/>
            </div>
          </div>
        </form>
        <div id="suahs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleSuaHS()">Lưu thay đổi</button>
      </div>
    </div></div>
  </div>

  <!-- Datalist gợi ý (giữ nguyên) -->
  <datalist id="noiKhamList">
    <option value="Bệnh viện Đa khoa Trung tâm An Giang">
    <option value="Bệnh viện Sản Nhi An Giang">
    <option value="Bệnh viện Đa khoa khu vực Châu Đốc">
    <option value="Bệnh viện Đa khoa khu vực Tân Châu">
    <option value="Bệnh viện Đa khoa khu vực tỉnh Tri Tôn">
    <option value="Bệnh viện Mắt – Tai Mũi Họng – Răng Hàm Mặt An Giang">
    <option value="Trung tâm Y tế thành phố Long Xuyên">
    <option value="Trung tâm Y tế thành phố Châu Đốc">
    <option value="Trung tâm Y tế huyện Châu Phú">
    <option value="Trung tâm Y tế huyện Châu Thành">
    <option value="Trung tâm Y tế huyện An Phú">
    <option value="Trung tâm Y tế huyện Tịnh Biên">
    <option value="Trung tâm Y tế huyện Tri Tôn">
    <option value="Trung tâm Y tế huyện Thoại Sơn">
    <option value="Trung tâm Y tế huyện Phú Tân">
    <option value="Trung tâm Y tế huyện Chợ Mới">
  </datalist>

  <datalist id="doiTuongList">
    <option value="Học sinh">
    <option value="Hộ nghèo">
    <option value="Cận nghèo">
    <option value="Con thương binh, liệt sĩ">
    <option value="Trẻ mồ côi">
    <option value="Bảo trợ xã hội">
    <option value="Dân tộc thiểu số">
    <option value="Hộ cận nghèo khu vực nông thôn">
  </datalist>

  <!-- Modal xác nhận xóa -->
  <div class="modal fade" id="modalConfirm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="modalConfirmTitle">Xác nhận</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalConfirmBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-danger" id="btnConfirmAction">Đồng ý</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast thông báo -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastNoti" class="toast align-items-center text-white bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastNotiBody"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Nút quay về -->
  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="../js/api.js"></script>

  <script>
    // ==== XỬ LÝ NGƯỜI DÙNG VÀ BIẾN TOÀN CỤC ====
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    let pageSize = 20, currentPage = 1, totalPages = 1, totalRecords = 0;
    let sortField = "ho_ten_hoc_sinh", sortDir = 1, selectedRows = [], allData = [], lastPageData = [];

    // ==== HÀM XỬ LÝ NGÀY (giữ nguyên từ bản gốc) ====
    function parseDDMMYYYY(str) {
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return null;
      const [d, m, y] = str.split('/').map(Number);
      const dt = new Date(y, m - 1, d);
      if (dt.getFullYear() === y && (dt.getMonth() + 1) === m && dt.getDate() === d) return dt;
      return null;
    }
    function excelDateToString(dateCell) {
      if (typeof dateCell === 'string') {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateCell)) {
          const [y,m,d] = dateCell.split('-'); return `${d}/${m}/${y}`;
        }
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateCell)) return dateCell;
        return dateCell;
      }
      if (typeof dateCell === 'number') {
        var utc_days = Math.floor(dateCell - 25569);
        var date = new Date(utc_days * 86400 * 1000);
        date.setUTCHours(0,0,0,0);
        let day = String(date.getDate()).padStart(2,'0');
        let month = String(date.getMonth()+1).padStart(2,'0');
        let year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return "";
    }
    function displayNgay(raw) {
      if (!raw) return "";
      if (typeof raw === "number") return excelDateToString(raw);
      if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) {
        const d = new Date(raw);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) { const [y,m,d] = raw.split('-'); return `${d}/${m}/${y}`; }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;
      if (!isNaN(Number(raw))) return excelDateToString(Number(raw));
      return raw;
    }

    // ==== LOADING, TOAST, XÁC NHẬN ====
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
    function showToast(msg, type = "primary") {
      const toast = document.getElementById('toastNoti');
      document.getElementById('toastNotiBody').innerText = msg;
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      new bootstrap.Toast(toast, { delay: 3500 }).show();
    }
    function showConfirm(msg, onConfirm, title = "Xác nhận") {
      document.getElementById('modalConfirmTitle').innerText = title;
      document.getElementById('modalConfirmBody').innerHTML = msg;
      const btn = document.getElementById('btnConfirmAction');
      btn.onclick = function () {
        bootstrap.Modal.getInstance(document.getElementById('modalConfirm')).hide();
        onConfirm?.();
      };
      new bootstrap.Modal(document.getElementById('modalConfirm')).show();
    }

    // ===== No-paging khi màn hình ≤ 999px
    const NO_PAGING_MAX_WIDTH = 999;
    function isNoPagingDevice(){ return window.innerWidth <= NO_PAGING_MAX_WIDTH; }
    function detectPageSize(){
      if (isNoPagingDevice()){
        pageSize = Number.MAX_SAFE_INTEGER;
      } else {
        pageSize = 20;
      }
    }
    window.addEventListener('resize', function () {
      const prevPageSize = pageSize;
      detectPageSize();
      if (pageSize !== prevPageSize) { currentPage = 1; renderAllView(); }
    });

    // ==== HỖ TRỢ XỬ LÝ DỮ LIỆU, SẮP XẾP, LỌC TÊN ====
    function stripVN(s){
      return String(s||"").normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/đ/g,'d').replace(/Đ/g,'D');
    }
    function getTen(fullname){
      const s = String(fullname||'').trim().replace(/\s+/g,' ');
      if (!s) return '';
      const parts = s.split(' ');
      return parts[parts.length - 1];
    }
    function keyVN(s){ return stripVN(String(s||'')).toLowerCase(); }

    // ✅ Chỉ nhận những bản ghi có doi_tuong_dong KHÁC "HS"/"Học sinh" (không phân biệt hoa/thường, có/không dấu)
    function isOtherDoiTuong(hs){
      const raw = (hs?.doi_tuong_dong ?? "").toString().trim();
      if (!raw || raw.toLowerCase() === "null") return false; // loại trống/null
      const k = keyVN(raw);
      return !(k === "hs" || k === "hoc sinh");
    }


    // Hiển thị doi_tuong_dong: rỗng hoặc "null" => dấu gạch ngang
    function formatDoiTuong(val){
      const raw = (val ?? "").toString().trim();
      if (!raw || raw.toLowerCase() === "null") return "—";
      return raw;
    }



    function getFilteredSortedData() {
      const q = document.getElementById('search-box').value.trim().toLowerCase();

      // Lọc theo đối tượng trước
      let filtered = allData.filter(isOtherDoiTuong);

      // Sau đó áp dụng search
      filtered = filtered.filter(hs =>
        !q ||
        (hs.ho_ten_hoc_sinh || "").toLowerCase().includes(q) ||
        (hs.ma_so_bhxh || "").toLowerCase().includes(q) ||
        (hs.sdt_lienhe || "").toLowerCase().includes(q) ||
        (hs.so_dinh_danh || "").toLowerCase().includes(q) ||
        (hs.ten_cha_me || "").toLowerCase().includes(q)
      );

      // Sắp xếp như bản gốc
      if (sortField) {
        filtered.sort((a,b)=>{
          if (sortField === 'ho_ten_hoc_sinh'){
            const av = keyVN(getTen(a.ho_ten_hoc_sinh));
            const bv = keyVN(getTen(b.ho_ten_hoc_sinh));
            if (av < bv) return -sortDir;
            if (av > bv) return  sortDir;
            const af = keyVN(a.ho_ten_hoc_sinh);
            const bf = keyVN(b.ho_ten_hoc_sinh);
            if (af < bf) return -sortDir;
            if (af > bf) return  sortDir;
            return 0;
          }
          let av = (a[sortField] || "").toString().toLowerCase();
          let bv = (b[sortField] || "").toString().toLowerCase();
          if (!isNaN(av) && !isNaN(bv)) { av = Number(av); bv = Number(bv); }
          if (av < bv) return -sortDir;
          if (av > bv) return  sortDir;
          return 0;
        });
      }
      return filtered;
    }

    function doSort(field) { if (sortField === field) sortDir = -sortDir; else { sortField = field; sortDir = 1; } renderAllView(); }
    function renderPagination() {
      const pagin = document.getElementById('pagination');
      if (!pagin) return;
      if (isNoPagingDevice()){ pagin.innerHTML = ''; return; }
      pagin.innerHTML = '';
      if (totalPages <= 1) return;
      pagin.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP = Math.max(1, currentPage - 2), maxP = Math.min(totalPages, currentPage + 2);
      if (minP > 1) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP > 2) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p = minP; p <= maxP; p++) {
        pagin.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      }
      if (maxP < totalPages - 1) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP < totalPages) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      pagin.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function (p) { if (p<1||p>totalPages||p===currentPage) return; currentPage = p; renderAllView(); }
    function doSearch() { currentPage = 1; renderAllView(); }

    // ==== LOAD & HIỂN THỊ DANH SÁCH ====
    async function fetchAllHocsinhOnce() {
      detectPageSize();
      showLoading();
      let url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(user.ma_truong)}&lop_hoc=${encodeURIComponent(user.lop_hoc)}`;
      let res = await fetch(url);
      let data = await res.json();
      hideLoading();
      allData = (data.success && Array.isArray(data.data)) ? data.data : [];
      currentPage = 1;
      renderAllView();
    }
    function renderAllView() {
      let filtered = getFilteredSortedData();
      totalRecords = filtered.length;
      totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
      let start = (currentPage - 1) * pageSize;
      let ds = filtered.slice(start, start + pageSize);
      lastPageData = ds;
      renderDanhSachHS(ds, start);
      renderPagination();
      renderActions();
    }

    function renderDanhSachHS(ds, offset) {
      selectedRows = [];
      if (!ds || ds.length === 0) {
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Không có học sinh thuộc nhóm đối tượng khác.</div>`;
        document.getElementById('btn-delete-multi').classList.add('d-none'); return;
      }
      function sortIcon(field) { if (sortField !== field) return ''; return sortDir === 1 ? ' ▲' : ' ▼'; }
      let html = `<table class="table table-bordered table-hs align-middle"><thead>
        <tr>
          <th><input type="checkbox" id="chk-all" onclick="toggleSelectAll(this)"></th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('ma_so_bhxh')">Mã số BHXH${sortIcon('ma_so_bhxh')}</th>
          <th class="sortable th-hoten" onclick="doSort('ho_ten_hoc_sinh')">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('gioi_tinh')">Giới tính${sortIcon('gioi_tinh')}</th>
          <th class="sortable" onclick="doSort('dia_chi')">Địa chỉ${sortIcon('dia_chi')}</th>
          <th class="sortable" onclick="doSort('lop_hoc')">Lớp${sortIcon('lop_hoc')}</th>
          <th class="sortable" onclick="doSort('sdt_lienhe')">SĐT liên hệ${sortIcon('sdt_lienhe')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh${sortIcon('so_dinh_danh')}</th>
          <th class="sortable" onclick="doSort('ten_cha_me')">Tên cha/mẹ${sortIcon('ten_cha_me')}</th>
        </tr></thead><tbody>`;
      ds.forEach((hs, i) => {
        html += `<tr>
          <td><input type="checkbox" class="chk-row" value="${hs.stt}" onchange="onSelectRow('${hs.stt}', this)"></td>
          <td>
            <div class="d-flex flex-column">
              <div class="text-danger fw-bold small mb-1">${formatDoiTuong(hs.doi_tuong_dong)}</div>
              <div class="action-btns">
                <button class="btn btn-warning btn-sm" onclick="showModalSuaHSByIndex(${i})" title="Sửa học sinh">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="showConfirmDelete('${hs.stt}')" title="Xóa học sinh">
                  <i class="bi bi-trash3"></i>
                </button>
              </div>
            </div>
          </td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td class="td-hoten">${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgay(hs.ngay_sinh)}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop_hoc||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
          <td>${hs.ten_cha_me||""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;
      document.getElementById('btn-delete-multi').classList.add('d-none');
    }

    // ❌ Không render 3 nút hành động theo yêu cầu
    function renderActions() { document.getElementById('ds-actions').innerHTML = ``; }

    // ==== SỬA, XÓA HỌC SINH (giữ nguyên hành vi) ====
    function isValidDateVN(str) {
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return false;
      const [d, m, y] = str.split('/').map(Number);
      const date = new Date(y, m-1, d);
      return date.getFullYear() === y && (date.getMonth()+1) === m && date.getDate() === d;
    }
    function showError(id, msg) { document.getElementById(id).innerText = msg; }

    // Khởi tạo Flatpickr cho form sửa
    let fpSua = {};
    function initSuaPickers() {
      fpSua.ngaySinh = flatpickr('#sua-ngay-sinh', { dateFormat: 'd/m/Y', allowInput: true });
      fpSua.hanBHYT  = flatpickr('#sua-ngay-het-han-bhyt', { dateFormat: 'd/m/Y', allowInput: true });
      fpSua.hanBHTN  = flatpickr('#sua-ngay-het-han-bhtn', { dateFormat: 'd/m/Y', allowInput: true });
    }

    function readDateStr(selector) {
      const el = document.querySelector(selector);
      return (el && el.value) ? el.value.trim() : "";
    }

    function showModalSuaHSByIndex(i) {
      showLoading();
      try {
        let hs = (Array.isArray(lastPageData) && lastPageData[i]) ? lastPageData[i] : null;

        if (!hs && typeof event !== 'undefined') {
          const tr = event.target?.closest('tr');
          const stt = tr?.querySelector('.chk-row')?.value;
          if (stt) hs = allData.find(x => String(x.stt) === String(stt)) || null;
        }
        if (!hs) {
          const filtered = getFilteredSortedData();
          const start = (currentPage - 1) * pageSize;
          hs = filtered.slice(start, start + pageSize)[i] || null;
        }
        if (!hs) {
          hideLoading();
          showToast("Không mở được form sửa (không tìm thấy bản ghi).", "danger");
          return;
        }

        if (!fpSua || !fpSua.ngaySinh || !fpSua.hanBHYT || !fpSua.hanBHTN) { initSuaPickers(); }
        document.getElementById('suahs-error').innerText = "";

        const modalEl = document.getElementById('modalSuaHS');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        const fill = () => {
          document.getElementById('sua-stt').value = hs.stt;
          document.getElementById('sua-ma-so-bhxh').value = hs.ma_so_bhxh || "";
          document.getElementById('sua-ho-ten-hs').value = hs.ho_ten_hoc_sinh || "";

          const dNS   = displayNgay(hs.ngay_sinh) || "";
          const dBHYT = displayNgay(hs.ngay_het_han_bhyt) || "";
          const dBHTN = displayNgay(hs.ngay_het_han_bhtn) || "";

          if (fpSua?.ngaySinh) { fpSua.ngaySinh.clear(); if (dNS) fpSua.ngaySinh.setDate(dNS, false, "d/m/Y"); }
          document.getElementById('sua-ngay-sinh').value = dNS;

          if (fpSua?.hanBHYT)  { fpSua.hanBHYT.clear();  if (dBHYT) fpSua.hanBHYT.setDate(dBHYT, false, "d/m/Y"); }
          document.getElementById('sua-ngay-het-han-bhyt').value = dBHYT;

          if (fpSua?.hanBHTN)  { fpSua.hanBHTN.clear();  if (dBHTN) fpSua.hanBHTN.setDate(dBHTN, false, "d/m/Y"); }
          document.getElementById('sua-ngay-het-han-bhtn').value = dBHTN;

          document.getElementById('sua-gt-nam').checked = (hs.gioi_tinh === "Nam");
          document.getElementById('sua-gt-nu').checked  = (hs.gioi_tinh === "Nữ");

          document.getElementById('sua-dia-chi').value = hs.dia_chi || "";
          document.getElementById('sua-lop').value = hs.lop_hoc || "";
          document.getElementById('sua-sdt-lienhe').value = hs.sdt_lienhe || "";
          document.getElementById('sua-so-dinh-danh').value = hs.so_dinh_danh || "";
          document.getElementById('sua-ten-cha-me').value = hs.ten_cha_me || "";
          document.getElementById('sua-noi-kham-bhyt').value = hs.noi_kham_bhyt || "";
          document.getElementById('sua-doi-tuong-dong').value =
            (hs.doi_tuong_dong && hs.doi_tuong_dong !== "null") ? hs.doi_tuong_dong : "";
          document.getElementById('sua-ghi_chu')?.value; // safe
          const ghi = (hs.ghi_chu && hs.ghi_chu !== "null") ? hs.ghi_chu : "";
          const ghiEl = document.getElementById('sua-ghi-chu'); if (ghiEl) ghiEl.value = ghi;
        };

        const onShown = () => {
          try { fill(); } finally {
            modalEl.removeEventListener('shown.bs.modal', onShown);
            hideLoading();
          }
        };
        modalEl.addEventListener('shown.bs.modal', onShown);
        modal.show();
      } catch (e) {
        console.error(e);
        hideLoading();
        showToast("Không mở được form sửa. Vui lòng thử lại!", "danger");
      }
    }

    async function handleSuaHS() {
      let hoTen = document.getElementById('sua-ho-ten-hs').value.trim();
      let ngaySinh = readDateStr('#sua-ngay-sinh');
      let gioiTinh = document.querySelector('input[name="sua_gioi_tinh"]:checked')?.value || "";
      let diaChi = document.getElementById('sua-dia-chi').value.trim();
      let lop = document.getElementById('sua-lop').value.trim();
      let sdtLienHe = document.getElementById('sua-sdt-lienhe').value.trim();
      let soDinhDanh = document.getElementById('sua-so-dinh-danh').value.trim();
      let tenChaMe = document.getElementById('sua-ten-cha-me').value.trim();
      let maSoBHXH = document.getElementById('sua-ma-so-bhxh').value.trim();

      if (!hoTen || !ngaySinh || !gioiTinh || !diaChi || !lop || !sdtLienHe || !tenChaMe) {
        showError('suahs-error', "Vui lòng nhập đầy đủ tất cả các trường!");
        return;
      }
      if (!isValidDateVN(ngaySinh)) { showError('suahs-error', "Ngày sinh không hợp lệ! Định dạng dd/mm/yyyy."); return; }

      const _bhyt = readDateStr('#sua-ngay-het-han-bhyt');
      const _bhtn = readDateStr('#sua-ngay-het-han-bhtn');
      if (_bhyt && !isValidDateVN(_bhyt)) { showError('suahs-error', "Hạn BHYT không hợp lệ!"); return; }
      if (_bhtn && !isValidDateVN(_bhtn)) { showError('suahs-error', "Hạn BHTN không hợp lệ!"); return; }

      if (!/^0\d{9}$/.test(sdtLienHe)) { showError('suahs-error', "Số điện thoại không hợp lệ!"); return; }
      if (!/^\d{12}$/.test(soDinhDanh)) { showError('suahs-error', "Số định danh phải gồm 12 số!"); return; }

      showLoading();
      const hs = {
        stt: document.getElementById('sua-stt').value,
        ma_so_bhxh: maSoBHXH,
        ho_ten_hoc_sinh: hoTen,
        ngay_sinh: ngaySinh,
        gioi_tinh: gioiTinh,
        dia_chi: diaChi,
        ngay_het_han_bhyt: _bhyt,
        ngay_het_han_bhtn: _bhtn,
        lop_hoc: lop,
        sdt_lienhe: sdtLienHe,
        so_dinh_danh: soDinhDanh,
        noi_kham_bhyt: document.getElementById('sua-noi-kham-bhyt').value.trim(),
        ten_cha_me: tenChaMe,
        doi_tuong_dong: (document.getElementById('sua-doi-tuong-dong').value || "null").trim() || "null",
        ghi_chu: (document.getElementById('sua-ghi-chu').value || "null").trim() || "null",
        ma_truong: user.ma_truong
      };

      const res = await suaHocsinh(hs);
      hideLoading();
      if (res.success) {
        showToast("Cập nhật học sinh thành công!","success");
        await fetchAllHocsinhOnce();
        bootstrap.Modal.getInstance(document.getElementById('modalSuaHS')).hide();
      } else {
        showError('suahs-error', res.message || "Lỗi cập nhật!");
      }
    }

    // ==== XÓA HỌC SINH ====
    window.onSelectRow = function (stt, cb) { if (cb.checked) selectedRows.push(stt); else selectedRows = selectedRows.filter(x => x !== stt); updateDeleteMultiButton(); }
    function toggleSelectAll(mainCb) {
      let all = document.querySelectorAll('.chk-row');
      selectedRows = [];
      all.forEach(cb => { cb.checked = mainCb.checked; if (mainCb.checked) selectedRows.push(cb.value); });
      updateDeleteMultiButton();
    }
    function updateDeleteMultiButton() {
      let btn = document.getElementById('btn-delete-multi');
      if (selectedRows.length > 0) btn.classList.remove('d-none'); else btn.classList.add('d-none');
    }
    function showConfirmDeleteMany() {
      if (selectedRows.length === 0) return;
      showConfirm(`Bạn có chắc chắn muốn xóa <b>${selectedRows.length}</b> học sinh đã chọn?`, doDeleteMany, "Xác nhận xóa nhiều học sinh");
    }
    async function doDeleteMany() {
      showLoading();
      const res = await xoaNhieuHocsinh(selectedRows);
      hideLoading();
      if (res.success) { showToast("Xóa nhiều học sinh thành công!","success"); await fetchAllHocsinhOnce(); selectedRows = []; }
      else { showToast(res.message || "Xóa nhiều học sinh thất bại!","danger"); }
    }
    window.showConfirmDelete = function (stt) { showConfirm("Bạn có chắc chắn muốn xóa học sinh này?", () => doDelete(stt), "Xác nhận xóa"); }
    async function doDelete(stt) {
      showLoading();
      const res = await xoaHocsinh(stt);
      hideLoading();
      if (res.success) { showToast("Xóa học sinh thành công!","success"); await fetchAllHocsinhOnce(); }
      else { showToast(res.message || "Xóa học sinh thất bại!","danger"); }
    }

    // ==== KHÁC ====
    function goBack(){showLoading();location.href="bhyt_giaovien.html"}

    // ==== KHỞI TẠO ====
    window.showModalSuaHSByIndex = showModalSuaHSByIndex;
    window.onload = function() {
      initSuaPickers();
      fetchAllHocsinhOnce();
    };
  </script>

  <script>
    // Một số helper còn tham chiếu ở form sửa
    function isValidPhoneNumber(phone) { return /^0\d{9}$/.test(phone.trim()); }
  </script>
</body>
</html>
