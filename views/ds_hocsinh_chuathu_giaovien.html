<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh chưa thu - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .sticky-header-box {
      position: sticky; top: 0; z-index: 999;
      background: #f8f9fa; padding-bottom: 2px;
    }
    .header {
      font-size: 22px; font-weight: bold; margin-bottom: 8px;
      padding-bottom: 6px; background: #f8f9fa;
    }
    .search-row {
      display: flex; flex-wrap: wrap; align-items: center;
      margin-bottom: 10px; gap: 10px;
      position: sticky; top: 52px; z-index: 998;
      background: #f8f9fa; padding-bottom: 4px;
    }
    .search-input { flex: 1; min-width: 180px;}
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .table-responsive { overflow-x: auto; }
    .total-count { font-size: 1rem; font-weight: 400; color: #444;}
    th.th-action { min-width: 170px; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: #f1f1f1; }
    .sort-icon { font-size: 15px; vertical-align: middle; margin-left: 3px; }

    .btn-back {
      position: fixed; bottom: 26px; right: 20px; z-index: 1099;
      border-radius: 50%; width: 54px; height: 54px;
      box-shadow: 0 2px 14px #0003; font-size: 25px;
      display: flex; align-items: center; justify-content: center;
      background: #fff; border: 2px solid #eee; color: #2563eb;
      transition: box-shadow 0.12s;
    }
    .btn-back:hover { box-shadow: 0 4px 24px #2563eb33; color: #fff; background: #2563eb; }

    @media (max-width: 600px) {
      .header { font-size: 18px; }
      th.th-action { min-width: 120px; }
      .search-row { flex-direction: column; align-items: stretch; }
      .action-btns { display: flex; flex-direction: column; gap: 6px; }
      .action-btns .btn { width: 100%; }
    }

    @media (min-width: 601px) {
      .action-btns { display: flex; flex-direction: row; gap: 4px; }
    }
  </style>
</head>
<body>
  <!-- Sticky header & search -->
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH CHƯA THU LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row mb-2">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>

    <!-- NÚT NỘP NHIỀU HỒ SƠ (MỚI) -->
    <button id="btn-bulk-submit" class="btn btn-primary" onclick="showBulkNopHoSoModal()" style="display:none;">
      Nộp nhiều hồ sơ
    </button>

  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>
  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>
  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>



  <!-- Modal Nộp Hồ Sơ BHYT -->
  <div class="modal fade" id="modalNopHoSoBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nộp hồ sơ BHYT</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Họ tên học sinh:</label>
          <input class="form-control" id="nhs-hoten" readonly>
        </div>
        <div class="mb-2">
          <label>Ngày sinh:</label>
          <input class="form-control" id="nhs-ngaysinh" readonly>
        </div>
        <div class="mb-2">
          <label>Nơi khám BHYT:</label>
          <input class="form-control" id="nhs-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT">
          <datalist id="noikham-list">
            <!-- Gợi ý sẽ render tự động -->
          </datalist>
        </div>
        <div class="mb-2">
          <label>Số tháng đóng:</label>
          <div>
            <input type="radio" name="nhs-thang" value="3" id="nhs-thang-3"> <label for="nhs-thang-3">3 tháng</label>
            <input type="radio" name="nhs-thang" value="6" id="nhs-thang-6" style="margin-left:18px"> <label for="nhs-thang-6">6 tháng</label>
            <input type="radio" name="nhs-thang" value="12" id="nhs-thang-12" style="margin-left:18px" checked> <label for="nhs-thang-12">12 tháng</label>
          </div>
        </div>

        <div class="mt-2 small">
          <div><strong>Hạn sử dụng dự kiến:</strong> <span id="nhs-exp-preview" class="fw-bold text-danger">—</span></div>
          <div><strong>Số tiền cần đóng:</strong> <span id="nhs-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>

        <div id="nhs-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="submitNopHoSoBHYT()">Nộp hồ sơ</button>
      </div>
    </div></div>
  </div>




  <!-- Modal Sửa Hồ Sơ BHYT -->
  <div class="modal fade" id="modalSuaHoSoBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHYT</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Họ tên học sinh:</label>
          <input class="form-control" id="shs-hoten" readonly>
        </div>
        <div class="mb-2">
          <label>Ngày sinh:</label>
          <input class="form-control" id="shs-ngaysinh" readonly>
        </div>
        <div class="mb-2">
          <label>Nơi khám BHYT:</label>
          <input class="form-control" id="shs-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT">
        </div>
        <div class="mb-2">
          <label>Số tháng đóng:</label>
          <div>
            <input type="radio" name="shs-thang" value="3" id="shs-thang-3"> <label for="shs-thang-3">3 tháng</label>
            <input type="radio" name="shs-thang" value="6" id="shs-thang-6" style="margin-left:18px"> <label for="shs-thang-6">6 tháng</label>
            <input type="radio" name="shs-thang" value="12" id="shs-thang-12" style="margin-left:18px"> <label for="shs-thang-12">12 tháng</label>
          </div>
        </div>

        <div class="mt-2 small">
          <div><strong>Hạn sử dụng dự kiến:</strong> <span id="shs-exp-preview" class="fw-bold text-danger">—</span></div>
          <div><strong>Số tiền cần đóng:</strong> <span id="shs-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>

        <div id="shs-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="submitSuaHoSoBHYT()">Lưu thay đổi</button>
      </div>
    </div></div>
  </div>





  <!-- Modal Nộp Nhiều Hồ Sơ (MỚI) -->
  <div class="modal fade" id="modalBulkNopHoSo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nộp nhiều hồ sơ BHYT</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <div><b>Đã chọn:</b> <span id="bulk-count-label">0</span> học sinh</div>
        </div>

        <div class="mb-2">
          <label>Nơi khám BHYT (áp dụng chung nếu nhập):</label>
          <input class="form-control" id="bulk-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT (có thể để trống để dùng theo từng học sinh)">
        </div>
        <div class="mb-2">
          <label>Số tháng đóng (áp dụng chung):</label>
          <div>
            <input type="radio" name="bulk-thang" value="3" id="bulk-thang-3"> <label for="bulk-thang-3">3 tháng</label>
            <input type="radio" name="bulk-thang" value="6" id="bulk-thang-6" style="margin-left:18px"> <label for="bulk-thang-6">6 tháng</label>
            <input type="radio" name="bulk-thang" value="12" id="bulk-thang-12" style="margin-left:18px" checked> <label for="bulk-thang-12">12 tháng</label>
          </div>
        </div>

        <div class="mt-2 small">
          <div><strong class="text-danger">Hạn sử dụng dự kiến:</strong> <span id="bulk-exp-preview" class="fw-bold text-danger">—</span></div>
          <div><strong class="text-danger">Số tiền cần đóng (mỗi HS):</strong> <span id="bulk-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>

        <div id="bulk-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" id="btnBulkNop" onclick="submitBulkNopHoSo()">Nộp nhiều hồ sơ</button>
      </div>
    </div></div>
  </div>






  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Nộp hồ sơ thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";
    let pageSize = 20, currentPage = 1, totalRecords = 0, totalPages = 1, sortField = "ho_ten_hoc_sinh", sortDir = 1, allData = [], lastFiltered = [];

    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

    function displayNgaySinh(raw) {
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) {
        let d = new Date(raw);
        return d.toLocaleDateString('vi-VN');
      }
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y,m,d] = raw.split('-'); return `${d}/${m}/${y}`;
      }
      return raw;
    }

    function detectPageSize() {
      const width = window.innerWidth;
      if (width <= 600) pageSize = 3;          // Mobile
      else if (width <= 999) pageSize = 7;     // Tablet
      else pageSize = 20;                      // Desktop
    }

    window.addEventListener('resize', function() {
      const prevPageSize = pageSize;
      detectPageSize();
      if (pageSize !== prevPageSize) {
        currentPage = 1;
        renderAllView();
      }
    });

    // Thêm hàm gọi API lấy danh sách BHYT (nếu chưa có)
    async function getAllBHYT(ma_truong, lop) {
      const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
      const res = await fetch(url);
      return await res.json();
    }

    // Hàm chính lấy danh sách học sinh chưa thu, merge trạng thái BHYT
    async function fetchChuaThuHocsinh() {
      detectPageSize();
      showLoading();

      // 1. Lấy danh sách học sinh
      // CHANGED: tham số đúng là lop_hoc (không phải lop)
      let url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(user.ma_truong)}&lop_hoc=${encodeURIComponent(user.lop_hoc)}`; // CHANGED
      let res = await fetch(url);
      let data = await res.json();
      console.log("[fetchChuaThuHocsinh] raw data:", data);

      // 2. Lấy danh sách BHYT
      let bhytRes = await getAllBHYT(user.ma_truong, user.lop_hoc);
      let dsBHYT = Array.isArray(bhytRes.data) ? bhytRes.data : [];
      let bhytMap = {};
      dsBHYT.forEach(row => {
        const key = String(row.so_dinh_danh).replace(/^'/, '').trim();
        bhytMap[key] = row.trang_thai;
      });


      // 3. Merge trạng thái BHYT vào học sinh
      if (data.success && Array.isArray(data.data)) {
        allData = data.data.map(hs => {
          let trangThai = bhytMap[hs.so_dinh_danh];
          return {
            ...hs,
            _bhyt_trangthai: trangThai === undefined ? undefined : Number(trangThai),
            trang_thai: trangThai // để log tiện tra cứu
          };
        }).filter(hs => hs._bhyt_trangthai !== 1); // Ẩn dòng đã duyệt
      } else {
        allData = [];
      }

      console.log("[fetchChuaThuHocsinh] allData after merge BHYT:", allData);

      currentPage = 1;
      doSearch();
      hideLoading();
    }



    function doSearch() {
      let q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q ? allData : allData.filter(hs =>
        (hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q) ||
        (displayNgaySinh(hs.ngay_sinh)||"").toLowerCase().includes(q) ||
        (hs.so_dinh_danh||"").toLowerCase().includes(q)
      );
      currentPage = 1;
      renderAllView();
    }
    function clearSearch() {
      document.getElementById('search-box').value = "";
      doSearch();
    }

    function renderAllView() {
      let dataToShow = lastFiltered || allData;
      // Sort
      if (sortField) {
        dataToShow = [...dataToShow].sort(function(a, b) {
          let av = (a[sortField] || "").toLowerCase(), bv = (b[sortField] || "").toLowerCase();
          if (!isNaN(av) && !isNaN(bv)) { av = Number(av); bv = Number(bv); }
          if (av < bv) return -sortDir; if (av > bv) return sortDir; return 0;
        });
      }
      totalRecords = dataToShow.length;
      totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
      let start = (currentPage - 1) * pageSize;
      let ds = dataToShow.slice(start, start + pageSize);
      renderDanhSachHS(ds);
      renderPagination();
    }

    function sortIcon(field) {
      if (sortField !== field) return '';
      return sortDir === 1 ? '<span class="sort-icon">&#9650;</span>' : '<span class="sort-icon">&#9660;</span>';
    }






    // Gợi ý danh sách nơi khám (demo, có thể fetch từ backend sau)
    const NOIKHAM_SUGGEST = [
      "TTYT huyện Châu Phú", "BVĐK tỉnh An Giang", "TTYT huyện Châu Thành", "BV Nhi Đồng 2", "BV Nhi Đồng 1"
    ];




    /* Khi đổi số tháng (Modal Nộp) -> cập nhật preview */
    ['nhs-thang-3','nhs-thang-6','nhs-thang-12'].forEach(id=>{
      const el = document.getElementById(id);
      el?.addEventListener('change', async ()=>{
        if(!_currentHS) return;
        const gia = await ensureGiaBHYT();
        const months = document.querySelector('input[name="nhs-thang"]:checked').value;
        const {exp, amount} = computeAmountAndExp(_currentHS.ngay_het_han_bhyt, months, gia?.gia_tien);
        setPreviewNop(exp, amount);
      });
    });

    /* Khi đổi số tháng (Modal Sửa) -> cập nhật preview */
    ['shs-thang-3','shs-thang-6','shs-thang-12'].forEach(id=>{
      const el = document.getElementById(id);
      el?.addEventListener('change', async ()=>{
        if(!_currentHS_Sua) return;
        const gia = await ensureGiaBHYT();
        const months = document.querySelector('input[name="shs-thang"]:checked').value;
        const {exp, amount} = computeAmountAndExp(_currentHS_Sua.ngay_het_han_bhyt, months, gia?.gia_tien);
        setPreviewSua(exp, amount);
      });
    });






    // API lấy trạng thái hồ sơ BHYT theo số định danh học sinh
    async function getBHYTStatusByHS(so_dinh_danh, ma_truong, lop_hoc) {
      // CHANGED: chuẩn hoá tên endpoint theo Controller (getstatus)
      const url = `${API_BASE}?func=GetStatus&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`; // CHANGED
      const res = await fetch(url);
      return await res.json();
    }

    // API nộp hồ sơ BHYT
    async function nopHoSoBHYTApi(payload) {
      const params = Object.entries(payload)
        .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
      const url = `${API_BASE}?func=NopHoSoBHYT&${params}`;
      const res = await fetch(url);
      return await res.json();
    }

    // API lấy phí và hoa hồng BHYT
    async function getGiaBHYT() {
      const url = `${API_BASE}?func=GetGiaBHYT`;
      const res = await fetch(url);
      return await res.json();
    }






    // Biến toàn cục để lưu học sinh đang sửa
    // Sửa hồ sơ BHYT
    async function suaHoSo(stt) {

      showLoading();
      // Tìm học sinh chưa thu có stt này
      const hs = (lastFiltered || allData).find(h => String(h.stt) === String(stt));
      if (!hs || hs._bhyt_trangthai !== 0) {
        showToast("Chỉ sửa được hồ sơ đang chờ duyệt!"); return;
        hideLoading();
      }
      _currentHS_Sua = hs;
      document.getElementById('shs-hoten').value = hs.ho_ten_hoc_sinh || "";
      document.getElementById('shs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh || "");
      document.getElementById('shs-error').innerText = "";
      // Gợi ý nơi khám
      let datalist = document.getElementById('noikham-list');
      datalist.innerHTML = NOIKHAM_SUGGEST.map(item=>`<option value="${item}">`).join('');

      // GỌI API lấy hồ sơ BHYT cũ
      // CHANGED: dùng hs.lop_hoc đúng cột
      let bhytRes = await getHosoBHYTByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc); // CHANGED
      if (bhytRes && bhytRes.success && bhytRes.data) {
        document.getElementById('shs-noikham').value = bhytRes.data.noi_kham || "";
        ["3","6","12"].forEach(t => {
          document.getElementById('shs-thang-' + t).checked = (String(bhytRes.data.so_thang_dong) === t);
        });
        // Bạn cũng có thể show hoa_hong, so_tien nếu muốn
        hideLoading();
      } else {
        // Nếu không có dữ liệu thì clear
        document.getElementById('shs-noikham').value = "";
        ["3","6","12"].forEach(t => {
          document.getElementById('shs-thang-' + t).checked = false;
        });
        hideLoading();
      }

      /* ✅ YÊU CẦU #1: Preview ban đầu khi mở modal Sửa */
      ensureGiaBHYT().then(gia => {
        const checked = document.querySelector('input[name="shs-thang"]:checked');
        const months = checked ? checked.value : "12";
        const {exp, amount} = computeAmountAndExp(hs.ngay_het_han_bhyt, months, gia?.gia_tien);
        setPreviewSua(exp, amount);
      });

      hideLoading();
      new bootstrap.Modal(document.getElementById('modalSuaHoSoBHYT')).show();
    }



    // API cập nhật hồ sơ BHYT (cần thêm trên backend)
    async function suaHoSoBHYTApi(payload) {
      const params = Object.entries(payload)
        .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
      const url = `${API_BASE}?func=SuaHoSoBHYT&${params}`;
      const res = await fetch(url);
      return await res.json();
    }






    // Render danh sách học sinh chưa thu
    function renderDanhSachHS(ds) {
      if (!ds || ds.length === 0) {
        document.getElementById('ds-container').innerHTML =
          `<div class='text-center text-secondary mt-4'>Không có học sinh chưa thu trong lớp này.</div>`;
        return;
      }
      console.log("[renderDanhSachHS] render list:", ds);

      let html = `<table class="table table-bordered table-hs align-middle"><thead>
      <tr>
        <!-- CỘT CHECKBOX CHỌN NHIỀU (MỚI) -->
        <th style="width:42px;">
          <input type="checkbox" id="chk-bulk-all" onchange="toggleSelectAllBulk(this)">
        </th>
        <th class="th-action">Thao tác</th>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
      </tr></thead><tbody>`;


      ds.forEach((hs) => {
        // Ẩn dòng đã duyệt (giữ nguyên logic cũ)
        console.log(`[renderDanhSachHS] Học sinh: ${hs.ho_ten_hoc_sinh} | _bhyt_trangthai:`, hs._bhyt_trangthai, "| trang_thai:", hs.trang_thai);
        if (hs._bhyt_trangthai === 1) return;

        // ✅ Chỉ hiện Sửa/In nếu đã nộp (0: chờ duyệt) hoặc đã duyệt (1)
        const submitted = (hs._bhyt_trangthai === 0 || hs._bhyt_trangthai === 1);

        html += `<tr>
          <!-- Ô checkbox chọn dòng (MỚI).
              Chỉ cho tick khi CHƯA nộp: _bhyt_trangthai undefined (hoặc khác 0/1).
              Nếu đã nộp và đang chờ duyệt (0) thì disable. -->
          <td>
            <input
              type="checkbox"
              class="chk-bulk-row"
              data-stt="${hs.stt}"
              onchange="onSelectRowBulk('${hs.stt}', this)"
              ${hs._bhyt_trangthai===0 ? 'disabled' : ''}
            >
          </td>

          <td>
            <div class="action-btns">
              <button class="btn btn-success btn-sm"
                      onclick="showNopHoSoModal('${hs.stt}')"
                      ${hs._bhyt_trangthai===0 ? 'disabled' : ''}>
                ${hs._bhyt_trangthai===0 ? "Chờ duyệt" : "Nộp hồ sơ"}
              </button>
              ${(hs._bhyt_trangthai === 0 || hs._bhyt_trangthai === 1) ? `
                <button class="btn btn-warning btn-sm" onclick="suaHoSo('${hs.stt}')">Sửa hồ sơ</button>
                <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${hs.stt}')">In phiếu thu</button>
              ` : ``}
            </div>
          </td>
          <td>${hs.ho_ten_hoc_sinh || ""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.so_dinh_danh || ""}</td>
        </tr>`;

      });

      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;



      // Đồng bộ lại checkbox theo danh sách đã chọn (MỚI)
      document.querySelectorAll('.chk-bulk-row').forEach(cb => {
        const stt = cb.getAttribute('data-stt');
        if (bulkSelected.indexOf(stt) !== -1 && !cb.disabled) cb.checked = true;
      });

      // Cập nhật trạng thái nút bulk
      updateBulkButton();

    }



    function doSort(field) {
      if (sortField === field) sortDir = -sortDir;
      else { sortField = field; sortDir = 1; }
      renderAllView();
    }

    function renderPagination() {
      const pagin = document.getElementById('pagination');
      pagin.innerHTML = '';
      if (totalPages <= 1) return;
      pagin.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP = Math.max(1, currentPage-2), maxP = Math.min(totalPages, currentPage+2);
      if (minP > 1) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP > 2) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p = minP; p <= maxP; p++) {
        pagin.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      }
      if (maxP < totalPages-1) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP < totalPages) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      pagin.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function(p) {
      if (p<1||p>totalPages||p===currentPage) return;
      currentPage = p;
      renderAllView();
    };


    function goBack() { showLoading(); window.location.href = "bhyt_giaovien.html"; }
    window.onload = fetchChuaThuHocsinh;







    /* ======= TÍNH NGÀY/PHÍ CHO DỰ KIẾN ======= */
    function parseVNDate(str){
      const m = String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const d = new Date(+m[3], +m[2]-1, +m[1]);
      return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1]) ? d : null;
    }
    function formatVNDate(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function addDaysExact(dateObj, days){
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0);
      d.setDate(d.getDate()+days);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    // Giữ nguyên để tương thích (không dùng cho tính hạn mới)
    const DAYS_MAP = {3:90, 6:180, 12:365};

    // NEW: cộng THÁNG đúng chuẩn (giữ ngày trong tháng)
    function addMonthsExact(dateObj, months){
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0);
      const m  = Number(months)||0;
      const t  = new Date(d.getFullYear(), d.getMonth()+m, d.getDate(), 12,0,0);
      return new Date(t.getFullYear(), t.getMonth(), t.getDate());
    }

    let _cachedGiaBHYT = null;
    async function ensureGiaBHYT(){
      if(_cachedGiaBHYT) return _cachedGiaBHYT;
      const giaRes = await getGiaBHYT();
      _cachedGiaBHYT = giaRes?.data?.[0] || null;
      return _cachedGiaBHYT;
    }
    // NEW: Hạn mới = (ngày sau hạn cũ) + N THÁNG rồi TRỪ 1 NGÀY
    function computeAmountAndExp(oldEndStr, months, basePrice){
      const oldEnd = parseVNDate(oldEndStr);
      const start = oldEnd ? addDaysExact(oldEnd, 1) : new Date();
      const afterMonths = addMonthsExact(start, parseInt(months,10)||0);
      const expDate = addDaysExact(afterMonths, -1);
      const exp = formatVNDate(expDate);
      const amount = (parseInt(basePrice||0,10) || 0) * (parseInt(months,10)||0);
      return {exp, amount};
    }
    function setPreviewNop(exp, amount){
      document.getElementById('nhs-exp-preview').innerText = exp;
      document.getElementById('nhs-amount-preview').innerText = amount.toLocaleString('vi-VN');
    }
    function setPreviewSua(exp, amount){
      document.getElementById('shs-exp-preview').innerText = exp;
      document.getElementById('shs-amount-preview').innerText = amount.toLocaleString('vi-VN');
    }








    let _currentHS = null;

    function showNopHoSoModal(stt) {
      showLoading();
      const hs = (lastFiltered || allData).find(h => String(h.stt) === String(stt));
      if (!hs) return;
      _currentHS = hs;
      document.getElementById('nhs-hoten').value = hs.ho_ten_hoc_sinh || "";
      document.getElementById('nhs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh || "");
      document.getElementById('nhs-noikham').value = "";
      document.getElementById('nhs-error').innerText = "";
      // Gợi ý nơi khám
      let datalist = document.getElementById('noikham-list');
      datalist.innerHTML = NOIKHAM_SUGGEST.map(item=>`<option value="${item}">`).join('');
      new bootstrap.Modal(document.getElementById('modalNopHoSoBHYT')).show();

      /* ✅ YÊU CẦU #3: Prefill nơi khám từ DanhSach_Hocsinh */
      document.getElementById('nhs-noikham').value = _currentHS.noi_kham_bhyt || "";

      /* ✅ YÊU CẦU #1: tải giá & hiển thị dự kiến lúc mở modal */
      ensureGiaBHYT().then(gia => {
        const months = document.querySelector('input[name="nhs-thang"]:checked').value;
        const {exp, amount} = computeAmountAndExp(_currentHS.ngay_het_han_bhyt, months, gia?.gia_tien);
        setPreviewNop(exp, amount);
      });
      hideLoading();
    }

    // Hàm ép kiểu an toàn cho trường hợp chuỗi hoặc số
    function parseFloatSafe(val) {
      if (typeof val === 'number') return val;
      if (typeof val === 'string') return parseFloat(val.replace(',', '.'));
      return 0;
    }

    async function submitNopHoSoBHYT() {
      if (!_currentHS) return;
      let noikham = _currentHS.noi_kham_bhyt || document.getElementById('nhs-noikham').value.trim();
      let so_thang = document.querySelector('input[name="nhs-thang"]:checked').value;
      if (!noikham) {
        document.getElementById('nhs-error').innerText = "Vui lòng nhập nơi khám!";
        return;
      }
      showLoading();
      try {
        let gia = await ensureGiaBHYT();

        let so_tien = gia ? (parseInt(gia.gia_tien) * so_thang) : 0;
        let hoa_hong = "null";
        if (so_thang == 3 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_3_thang) * so_tien * 100) / 100;
        else if (so_thang == 6 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_6_thang) * so_tien * 100) / 100;
        else if (so_thang == 12 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_12_thang) * so_tien * 100) / 100;

        // NEW: hạn mới = (ngày sau hạn cũ) + N THÁNG - 1 ngày
        const oldEnd = parseVNDate(_currentHS.ngay_het_han_bhyt);
        const startDate = oldEnd ? addDaysExact(oldEnd, 1) : new Date();
        const afterMonths = addMonthsExact(startDate, parseInt(so_thang,10)||0);
        const han_su_dung_bhyt_moi = formatVNDate(addDaysExact(afterMonths, -1));

        let payload = {
          // các cột DanhSach_BHYT mới
          ma_so_bhxh: _currentHS.ma_so_bhxh || "null",
          ho_ten_hoc_sinh: _currentHS.ho_ten_hoc_sinh || "null",
          ngay_sinh: displayNgaySinh(_currentHS.ngay_sinh) || "null",
          gioi_tinh: _currentHS.gioi_tinh || "null",
          dia_chi: _currentHS.dia_chi || "null",
          ngay_het_han_bhyt_cu: _currentHS.ngay_het_han_bhyt || "null",
          han_su_dung_bhyt_moi: han_su_dung_bhyt_moi,
          so_thang_dong: so_thang,
          lop_hoc: _currentHS.lop_hoc || "null",       // CHANGED (lop -> lop_hoc)
          sdt_lienhe: _currentHS.sdt_lienhe || "null", // CHANGED (sdt -> sdt_lienhe)
          so_dinh_danh: _currentHS.so_dinh_danh || "null",
          noi_kham_bhyt: noikham,                      // CHANGED (noi_kham -> noi_kham_bhyt)
          ten_cha_me: _currentHS.ten_cha_me || "null",
          doi_tuong_dong: "HS",
          ghi_chu: "null",
          so_tien,
          hoa_hong,
          trang_thai: 0,
          so_ho_so: "null",
          ma_truong: user.ma_truong || "null"
        };

        let res = await nopHoSoBHYTApi(payload);
        hideLoading();
        if (res.success) {
          let modalEl = document.getElementById('modalNopHoSoBHYT');
          let modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modal.hide();
          showToast("Nộp hồ sơ thành công!");
          console.log("[submitNopHoSoBHYT] Nộp thành công, reload danh sách...");
          await fetchChuaThuHocsinh(); // Gọi lại để render lại nút thành "Chờ duyệt"
        } else {
          document.getElementById('nhs-error').innerText = res.message || "Nộp hồ sơ thất bại!";
          console.log("[submitNopHoSoBHYT] Nộp thất bại:", res);
        }

      } catch (err) {
        hideLoading();
        document.getElementById('nhs-error').innerText = err.message || "Có lỗi xảy ra!";
      }
    }







    // Hàm sửa hồ sơ BHYT
    async function submitSuaHoSoBHYT() {
      if (!_currentHS_Sua) return;
      let noikham = document.getElementById('shs-noikham').value.trim();
      let so_thang = document.querySelector('input[name="shs-thang"]:checked').value;
      if (!noikham) {
        document.getElementById('shs-error').innerText = "Vui lòng nhập nơi khám!";
        return;
      }
      showLoading();
      try {
        let gia = await ensureGiaBHYT();

        let so_tien = gia ? (parseInt(gia.gia_tien) * so_thang) : 0;
        let hoa_hong = "null";
        if (so_thang == 3 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_3_thang) * so_tien * 100) / 100;
        else if (so_thang == 6 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_6_thang) * so_tien * 100) / 100;
        else if (so_thang == 12 && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_12_thang) * so_tien * 100) / 100;

        // BE map 'noi_kham' -> cột 'noi_kham_bhyt' trong Model
        let payload = {
          so_dinh_danh: _currentHS_Sua.so_dinh_danh,
          ma_truong: user.ma_truong,
          lop_hoc: _currentHS_Sua.lop_hoc,  // CHANGED (lop -> lop_hoc)
          noi_kham: noikham,
          so_thang_dong: so_thang,
          hoa_hong,
          so_tien
        };
        let res = await suaHoSoBHYTApi(payload);
        hideLoading();
        if (res.success) {
          let modalEl = document.getElementById('modalSuaHoSoBHYT');
          let modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modal.hide();
          showToast("Đã cập nhật hồ sơ!");
          await fetchChuaThuHocsinh();
        } else {
          document.getElementById('shs-error').innerText = res.message || "Cập nhật thất bại!";
        }
      } catch (err) {
        hideLoading();
        document.getElementById('shs-error').innerText = err.message || "Có lỗi xảy ra!";
      }
    }






    function showToast(msg) {
      document.getElementById('toast-message').innerText = msg;
      let toastEl = document.getElementById('success-toast');
      let toast = bootstrap.Toast.getOrCreateInstance(toastEl);
      toast.show();
    }









    /* ===========================
    *  CHỌN NHIỀU & NỘP NHIỀU (MỚI)
    * =========================== */

    // Danh sách stt đã chọn
    let bulkSelected = [];

    /** Lấy danh sách record HS theo stt đã chọn (từ allData) */
    function getSelectedRowsData() {
      const map = {};
      allData.forEach(h => { map[String(h.stt)] = h; });
      return bulkSelected
        .map(stt => map[String(stt)])
        .filter(Boolean)
        // chỉ xử lý những HS thật sự CHƯA nộp (không trạng thái 0/1)
        .filter(hs => !(hs._bhyt_trangthai === 0 || hs._bhyt_trangthai === 1));
    }

    /** Tick chọn/bỏ chọn từng dòng */
    function onSelectRowBulk(stt, el) {
      if (el.checked) {
        if (bulkSelected.indexOf(stt) === -1) bulkSelected.push(stt);
      } else {
        bulkSelected = bulkSelected.filter(x => x !== stt);
        const allCb = document.getElementById('chk-bulk-all');
        if (allCb) allCb.checked = false;
      }
      updateBulkButton();
    }

    /** Chọn tất cả / bỏ tất cả TRONG TRANG HIỆN TẠI */
    function toggleSelectAllBulk(el) {
      const cbs = document.querySelectorAll('.chk-bulk-row');
      cbs.forEach(cb => {
        if (cb.disabled) return; // không tick những dòng đã nộp (đang chờ)
        cb.checked = el.checked;
        const stt = cb.getAttribute('data-stt');
        if (el.checked) {
          if (bulkSelected.indexOf(stt) === -1) bulkSelected.push(stt);
        } else {
          bulkSelected = bulkSelected.filter(x => x !== stt);
        }
      });
      updateBulkButton();
    }

    /** Cập nhật nút "Nộp nhiều hồ sơ" (hiện/ẩn, kèm số lượng) */
    function updateBulkButton() {
      const btn = document.getElementById('btn-bulk-submit');
      const count = getSelectedRowsData().length;
      if (!btn) return;
      if (count > 0) {
        btn.style.display = '';
        btn.innerText = `Nộp nhiều hồ sơ (${count})`;
      } else {
        btn.style.display = 'none';
      }
    }

    /** Xóa lựa chọn sau khi nộp xong */
    function clearBulkSelection() {
      bulkSelected = [];
      // Bỏ tick các checkbox đang hiện
      document.querySelectorAll('.chk-bulk-row').forEach(cb => cb.checked = false);
      const allCb = document.getElementById('chk-bulk-all');
      if (allCb) allCb.checked = false;
      updateBulkButton();
    }

    /** Hiện modal nộp nhiều hồ sơ */
    function showBulkNopHoSoModal() {
      const selectedList = getSelectedRowsData();
      if (selectedList.length === 0) return;

      // Gợi ý nơi khám (datalist dùng chung)
      const datalist = document.getElementById('noikham-list');
      if (datalist) {
        datalist.innerHTML = NOIKHAM_SUGGEST.map(item => `<option value="${item}">`).join('');
      }

      // Fill số lượng & reset lỗi
      document.getElementById('bulk-count-label').innerText = String(selectedList.length);
      document.getElementById('bulk-noikham').value = '';
      document.getElementById('bulk-error').innerText = '';

      // Set checked mặc định 12 tháng
      document.getElementById('bulk-thang-12').checked = true;

      // Tính preview ban đầu (lấy ngày hết hạn cũ của HS đầu tiên; nếu không có thì lấy hôm nay)
      ensureGiaBHYT().then(gia => {
        const first = selectedList[0];
        const months = document.querySelector('input[name="bulk-thang"]:checked').value;
        const {exp, amount} = computeAmountAndExp(first?.ngay_het_han_bhyt || "", months, gia?.gia_tien);
        document.getElementById('bulk-exp-preview').innerText = exp;
        document.getElementById('bulk-amount-preview').innerText = amount.toLocaleString('vi-VN');
      });

      new bootstrap.Modal(document.getElementById('modalBulkNopHoSo')).show();
    }

    /** Sự kiện đổi số tháng trong modal bulk -> cập nhật preview */
    ['bulk-thang-3','bulk-thang-6','bulk-thang-12'].forEach(id => {
      const el = document.getElementById(id);
      el?.addEventListener('change', async () => {
        const selectedList = getSelectedRowsData();
        if (selectedList.length === 0) return;
        const gia = await ensureGiaBHYT();
        const months = document.querySelector('input[name="bulk-thang"]:checked').value;
        const {exp, amount} = computeAmountAndExp(selectedList[0]?.ngay_het_han_bhyt || "", months, gia?.gia_tien);
        document.getElementById('bulk-exp-preview').innerText = exp;
        document.getElementById('bulk-amount-preview').innerText = amount.toLocaleString('vi-VN');
      });
    });

    /** Nộp nhiều hồ sơ — gọi tuần tự endpoint hiện có (không cần sửa backend) */
    async function submitBulkNopHoSo() {
      const selectedList = getSelectedRowsData();
      if (selectedList.length === 0) return;

      const btn = document.getElementById('btnBulkNop');
      btn.disabled = true;
      showLoading();

      try {
        // Tham số chung
        const months = document.querySelector('input[name="bulk-thang"]:checked').value;
        const gia   = await ensureGiaBHYT();
        const price = gia ? parseInt(gia.gia_tien,10) : 0;

        // Kiểm tra Nơi khám: dùng giá trị nhập chung nếu có, nếu để trống thì fallback theo từng HS
        const userNoiKham = (document.getElementById('bulk-noikham').value || "").trim();
        const missing = selectedList.filter(hs => !userNoiKham && !(hs.noi_kham_bhyt && String(hs.noi_kham_bhyt).trim()));
        if (missing.length > 0) {
          document.getElementById('bulk-error').innerText =
            'Một số học sinh thiếu "Nơi khám BHYT". Hãy nhập Nơi khám ở trên để áp dụng chung, hoặc cập nhật từng học sinh. Ví dụ: ' +
            missing.slice(0,5).map(h => h.ho_ten_hoc_sinh || h.so_dinh_danh || h.stt).join(', ') +
            (missing.length > 5 ? '...' : '');
          return;
        }

        // Tính tiền/hoa hồng theo từng hồ sơ (giống logic đơn lẻ, giữ nguyên BE)
        let ok = 0, fail = 0, failNames = [];
        for (const hs of selectedList) {
          const noikham = userNoiKham || hs.noi_kham_bhyt;
          const so_tien = price * parseInt(months,10);

          let hoa_hong = "null";
          if (String(months) === "3"  && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_3_thang)  * so_tien * 100) / 100;
          if (String(months) === "6"  && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_6_thang)  * so_tien * 100) / 100;
          if (String(months) === "12" && gia) hoa_hong = Math.round(parseFloatSafe(gia.hoa_hong_12_thang) * so_tien * 100) / 100;

          // NEW: hạn mới = (ngày sau hạn cũ) + N THÁNG - 1 ngày
          const od = parseVNDate(hs.ngay_het_han_bhyt);
          const startDate = od ? addDaysExact(od, 1) : new Date();
          const afterMonths = addMonthsExact(startDate, parseInt(months,10)||0);
          const han_su_dung_bhyt_moi = formatVNDate(addDaysExact(afterMonths, -1));

          const payload = {
            ma_so_bhxh: hs.ma_so_bhxh || "null",
            ho_ten_hoc_sinh: hs.ho_ten_hoc_sinh || "null",
            ngay_sinh: displayNgaySinh(hs.ngay_sinh) || "null",
            gioi_tinh: hs.gioi_tinh || "null",
            dia_chi: hs.dia_chi || "null",
            ngay_het_han_bhyt_cu: hs.ngay_het_han_bhyt || "null",
            han_su_dung_bhyt_moi: han_su_dung_bhyt_moi,
            so_thang_dong: months,
            lop_hoc: hs.lop_hoc || "null",
            sdt_lienhe: hs.sdt_lienhe || "null",
            so_dinh_danh: hs.so_dinh_danh || "null",
            noi_kham_bhyt: noikham,
            ten_cha_me: hs.ten_cha_me || "null",
            doi_tuong_dong: "HS",
            ghi_chu: "null",
            so_tien,
            hoa_hong,
            trang_thai: 0,
            so_ho_so: "null",
            ma_truong: user.ma_truong || "null"
          };

          const res = await nopHoSoBHYTApi(payload);
          if (res && res.success) ok++;
          else { fail++; failNames.push(hs.ho_ten_hoc_sinh || hs.so_dinh_danh || hs.stt); }
        }

        // Đóng modal + clear selection + refresh
        (bootstrap.Modal.getInstance(document.getElementById('modalBulkNopHoSo')) || new bootstrap.Modal(document.getElementById('modalBulkNopHoSo'))).hide();
        clearBulkSelection();
        await fetchChuaThuHocsinh();

        // Thông báo kết quả
        if (fail === 0) {
          showToast(`Đã nộp thành công ${ok} hồ sơ!`);
        } else {
          showToast(`Nộp xong: thành công ${ok}, thất bại ${fail}.`);
          // Bạn có thể log chi tiết nếu cần:
          console.log("Các hồ sơ lỗi:", failNames);
        }

      } catch (err) {
        document.getElementById('bulk-error').innerText = err.message || "Có lỗi xảy ra!";
      } finally {
        hideLoading();
        btn.disabled = false;
      }
    }


  </script>
</body>
</html>
