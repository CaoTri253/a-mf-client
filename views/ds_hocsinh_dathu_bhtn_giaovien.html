<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DS học sinh đã tham gia BHTN - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px;padding-bottom:6px}
    .search-row{display:flex;flex-wrap:wrap;align-items:center;margin-top:-6px;gap:10px;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{font-size:1rem;font-weight:400;color:#444}
    th.th-action{min-width:220px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:14px;vertical-align:middle;margin-left:4px}
    .action-btns{display:flex;gap:6px;flex-wrap:wrap}
    .btn-back{
      position:fixed;bottom:26px;right:20px;z-index:1099;width:54px;height:54px;border-radius:50%;
      background:#fff;border:2px solid #eee;color:#2563eb;font-size:25px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 14px #0003
    }
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}
    .status-badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;font-size:.8rem;font-weight:600}
    .status-active{color:#065f46;background:#d1fae5}
    .status-pending{color:#b91c1c;background:#fee2e2}
    .hoso-text{margin-left:.5rem;color:#444}

    /* ========= Thẻ BHTN (xem thẻ) ========= */
    :root{ --cardW: 420px; --cardH: 280px; }
    #cardScaleWrap{ width:var(--cardW); height:var(--cardH); transform-origin:top left; margin:0 auto; }
    .bhtn-card{
      width:var(--cardW); height:var(--cardH); background:#e9f3ff; border:4px solid #ff9f1c; border-radius:10px;
      box-shadow:0 2px 10px #0002 inset; overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .bhtn-inner{padding:10px 14px;height:100%;display:flex;flex-direction:column}
    .bhtn-top{display:flex;align-items:center;justify-content:space-between}
    .bhtn-logo{display:flex;align-items:center;gap:8px}
    .bhtn-logo img{height:28px}
    .bhtn-logo .brand{font-weight:800;color:#1570ef;font-size:20px;letter-spacing:.5px}
    .bhtn-logo .brand .sub{color:#ff9f1c;margin-left:4px}
    .bhtn-obj{font-weight:700;color:#0f766e;background:#d1fae5;border:1px solid #99f6e4;border-radius:6px;padding:2px 8px}
    .bhtn-title{margin-top:2px;font-weight:800;font-size:18px;color:#0f172a}
    .bhtn-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;margin-top:8px}
    .kv{display:flex;gap:6px}
    .k{min-width:120px;color:#334155;font-weight:600}
    .v{color:#0f172a}
    .v-blue{color:#1d4ed8;font-weight:700}
    .v-red{color:#b91c1c;font-weight:700}
    .v-green{color:#047857;font-weight:700}
    .big-class{position:absolute;right:12px;top:42px;font-size:38px;font-weight:800;color:#1f2937;opacity:.25}
    .status-ok{margin-top:4px;color:#047857;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
    .card-footer-note{position:absolute;bottom:10px;right:16px;background:#ffecb5;border:1px solid #f0ad4e;border-radius:6px;padding:2px 8px;font-weight:700}
    .so-the{color:#0c4a6e;font-weight:800}
    .sep{height:2px;background:linear-gradient(90deg,#ff9f1c,#0ea5e9);margin:6px 0 8px;border-radius:2px}

    @media print{
      @page{ size: A6 landscape; margin: 6mm; }
      #cardScaleWrap{ width:148mm; height:105mm; transform:none!important; }
      .bhtn-card{ width:148mm; height:105mm; }
      .modal{ position:static!important; }
      .no-print{ display:none!important; }
    }
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA BHTN LỚP <span id="lop-hoc">—</span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
      <button class="btn btn-outline-secondary" onclick="goBack()">Quay lại</button>
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Modal XEM THẺ BHTN -->
  <div class="modal fade" id="modalTheBHTN" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ BHTN (ĐÃ KÍCH HOẠT)</h5>
        <div class="d-flex gap-2 no-print">
          <button class="btn btn-secondary btn-sm" onclick="downloadCardImage()">Lưu ảnh thẻ</button>
          <button class="btn btn-primary btn-sm" onclick="window.print()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="cardScaleWrap">
          <div class="bhtn-card position-relative" id="cardArea">
            <div class="bhtn-inner">
              <div class="bhtn-top">
                <div class="bhtn-logo">
                  <img id="c-logo" src="../assets/image/baoviet.png" alt="BAOVIET"/>
                  <div class="brand">BAOVIET <span class="sub">Insurance</span></div>
                </div>
                <div class="bhtn-obj" id="c-doituong">Học sinh</div>
              </div>
              <div class="bhtn-title">BẢO HIỂM BẢO VIỆT</div>
              <div class="sep"></div>

              <div class="kv"><div class="k">HS</div><div class="v">Số thẻ: <span id="c-sothe" class="so-the">—</span></div></div>

              <div class="bhtn-grid">
                <div>
                  <div class="kv"><div class="k">Họ và tên</div><div class="v" id="c-hoten">—</div></div>
                  <div class="kv"><div class="k">Ngày sinh</div><div class="v" id="c-ngaysinh">—</div></div>
                  <div class="kv"><div class="k">Sử dụng từ</div><div class="v v-blue" id="c-tu">—</div></div>
                  <div class="kv"><div class="k">Ngày hết hạn</div><div class="v v-red" id="c-den">—</div></div>
                  <div class="kv"><div class="k">Địa chỉ</div><div class="v" id="c-diachi">—</div></div>
                  <div class="kv"><div class="k">Điện thoại</div><div class="v" id="c-sdt">—</div></div>
                  <div class="kv"><div class="k">Tên Cha/Mẹ</div><div class="v" id="c-cha">—</div></div>
                </div>
                <div>
                  <div class="kv"><div class="k">Giới tính</div><div class="v" id="c-gioitinh">—</div></div>
                  <div class="kv"><div class="k">Lớp</div><div class="v" id="c-lop">—</div></div>
                  <div class="kv"><div class="k">Số tiền đóng</div><div class="v v-green" id="c-sotien">—</div></div>
                  <div class="kv"><div class="k">Trường</div><div class="v" id="c-truong">—</div></div>
                  <div class="status-ok" id="c-status">ĐÃ KÍCH HOẠT</div>
                </div>
              </div>

              <div class="big-class" id="c-lop-big"></div>
              <div class="card-footer-note" id="c-footer-code"></div>
            </div>
          </div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ========= State & guards ========= */
    const logPrefix='[BHTN-DaThu]';
    const user = JSON.parse(localStorage.getItem("user")||"{}");
    if (!user.sdt || user.phan_quyen!=="giao_vien") window.location.href="../index.html";
    document.getElementById('lop-hoc').innerText = user.lop_hoc||'(chưa xác định)';

    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField='ho_ten_hoc_sinh',sortDir=1;
    let allData=[],lastFiltered=[];

    function showLoading(){ document.getElementById('loadingSpinner').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingSpinner').style.display='none'; }
    function goBack(){ showLoading(); window.location.href='bhtn_giaovien.html'; }
    const isMobile = ()=>/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    /* ========= Helpers ========= */
    function displayNgaySinh(raw){
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) return new Date(raw).toLocaleDateString('vi-VN');
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
      return raw;
    }
    function parseVNDate(str){
      const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const d=new Date(+m[3],+m[2]-1,+m[1]);
      return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1]) ? d : null;
    }
    function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function addDaysExact(dateObj, days){ const d=new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function numberWithCommas(n){ n=Number(String(n||0).replace(/[^\d.-]/g,''))||0; return n.toLocaleString('vi-VN'); }

    async function getTenTruong(ma_truong){
      try{
        const url = `${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;
        const res = await fetch(url); const j=await res.json();
        return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—';
      }catch(e){ return user.ten_truong || ma_truong || '—'; }
    }

    function detectPageSize(){
      const w=window.innerWidth;
      if (w<=600) pageSize=5; else if (w<=999) pageSize=10; else pageSize=20;
    }
    window.addEventListener('resize',()=>{ const p=pageSize; detectPageSize(); if (p!==pageSize){ currentPage=1; renderAllView(); } });

    /* ========= Fetch list: đã tham gia BHTN ========= */
    async function fetchDanhSachDaThu(){
      try{
        detectPageSize(); showLoading();
        const res = await getDanhSachBHTN(user.ma_truong, user.lop_hoc);
        const arr = Array.isArray(res?.data) ? res.data : [];
        allData = arr.filter(r => String(r.lop_hoc||'').trim() === String(user.lop_hoc||'').trim());
        doSearch();
      }catch(e){
        console.error(logPrefix,'fetchDanhSachDaThu error',e);
      }finally{ hideLoading(); }
    }

    /* ========= Search / Sort / Paging ========= */
    function doSearch(){
      const q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q ? allData : allData.filter(r =>
        String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
        String(displayNgaySinh(r.ngay_sinh)||'').toLowerCase().includes(q) ||
        String(r.so_dinh_danh||'').toLowerCase().includes(q) ||
        String(r.ma_so_bhtn||'').toLowerCase().includes(q)
      );
      currentPage=1; renderAllView();
    }

    function sortIcon(field){ if (sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
    function setSort(field){ if (sortField===field) sortDir=-sortDir; else { sortField=field; sortDir=1; } renderAllView(); }

    function renderAllView(){
      let dataToShow = lastFiltered||allData;
      if (sortField){
        dataToShow = [...dataToShow].sort((a,b)=>{
          let av=(a[sortField]||'').toString().toLowerCase(), bv=(b[sortField]||'').toString().toLowerCase();
          if (!isNaN(av) && !isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if (av<bv) return -sortDir; if (av>bv) return sortDir; return 0;
        });
      }
      totalRecords=dataToShow.length;
      totalPages=Math.max(1, Math.ceil(totalRecords/pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} hồ sơ)`;
      const start=(currentPage-1)*pageSize;
      renderTable(dataToShow.slice(start,start+pageSize));
      renderPagination();
    }

    function renderPagination(){
      const el=document.getElementById('pagination'); el.innerHTML='';
      if (totalPages<=1) return;
      el.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
      if (minP>1) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP>2) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p=minP;p<=maxP;p++) el.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      if (maxP<totalPages-1) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP<totalPages) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    function gotoPage(p){ if (p<1||p>totalPages||p===currentPage) return; currentPage=p; renderAllView(); }

    /* ========= Table ========= */
    function statusCell(row){
      const st = Number(String(row.trang_thai||'').replace(/^'/,'').trim());
      const shs = String(row.so_ho_so||'').replace(/^'/,'').trim();
      if (st===1) return `<div><span class="status-badge status-active">Đã kích hoạt</span>${shs? `<span class="hoso-text">${shs}</span>` : ''}</div>`;
      return '<span class="status-badge status-pending">Đang xử lý</span>';
    }
    function actionsCell(i,row){
      const st = Number(row.trang_thai??-1);
      const hasCard = st===1;
      const btnView = `<button class="btn btn-info btn-sm" onclick="onViewCardIdx(${i})" ${hasCard?'':'disabled'}>Xem thẻ</button>`;
      return `<div class="action-btns">${btnView}</div>`;
    }
    function buildHead(){
      return `
        <thead>
          <tr>
            <th class="th-action">Thao tác</th>
            <th>Trạng thái</th>
            <th class="sortable" onclick="setSort('ho_ten_hoc_sinh')">Họ tên ${sortIcon('ho_ten_hoc_sinh')}</th>
            <th class="sortable" onclick="setSort('ngay_sinh')">Ngày sinh ${sortIcon('ngay_sinh')}</th>
            <th class="sortable" onclick="setSort('so_dinh_danh')">Số định danh ${sortIcon('so_dinh_danh')}</th>
            <th class="sortable" onclick="setSort('so_thang_dong')">Số tháng đóng ${sortIcon('so_thang_dong')}</th>
            <th class="sortable" onclick="setSort('han_su_dung_bhtn_moi')">Hạn mới ${sortIcon('han_su_dung_bhtn_moi')}</th>
          </tr>
        </thead>`;
    }
    function renderTable(rows){
      if (!rows||rows.length===0){
        document.getElementById('ds-container').innerHTML = "<div class='text-center text-secondary mt-4'>Không có hồ sơ trong lớp này.</div>";
        return;
      }
      let html = `<table class="table table-bordered table-hs align-middle">${buildHead()}<tbody>`;
      rows.forEach((r,i)=>{
        html += `
          <tr>
            <td>${actionsCell(i,r)}</td>
            <td>${statusCell(r)}</td>
            <td>${r.ho_ten_hoc_sinh||''}</td>
            <td>${displayNgaySinh(r.ngay_sinh)||''}</td>
            <td>${r.so_dinh_danh||''}</td>
            <td>${r.so_thang_dong||''}</td>
            <td>${r.han_su_dung_bhtn_moi||''}</td>
          </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ========= Xem thẻ ========= */
    function calcRangeBHTN(oldEndStr){
      const od=parseVNDate(oldEndStr);
      if (!od) return {startText:'—', endText:'(không xác định)'};
      const start=addDaysExact(od,1);
      const end=new Date(start.getFullYear(), start.getMonth()+12, 0);
      return {startText: formatVNDate(start), endText: formatVNDate(end)};
    }

    async function onViewCardIdx(idx){
      const rows = lastFiltered||allData;
      const r = rows[idx]; if (!r) return;

      const schoolName = await getTenTruong(r.ma_truong || user.ma_truong);
      const lop = r.lop_hoc || user.lop_hoc || '';

      const range = calcRangeBHTN(r.ngay_het_han_bhtn_cu || r.ngay_het_han_bhtn || '');
      const soTien = numberWithCommas(r.so_tien);

      document.getElementById('c-doituong').innerText = r.doi_tuong_dong || 'Học sinh';
      document.getElementById('c-sothe').innerText = r.ma_so_bhtn || '(chưa có)';
      document.getElementById('c-hoten').innerText = r.ho_ten_hoc_sinh || '';
      document.getElementById('c-ngaysinh').innerText = displayNgaySinh(r.ngay_sinh)||'';
      document.getElementById('c-tu').innerText = range.startText;
      document.getElementById('c-den').innerText = range.endText;
      document.getElementById('c-diachi').innerText = r.dia_chi || '';
      document.getElementById('c-sdt').innerText = r.sdt_lienhe || '';
      document.getElementById('c-cha').innerText = r.ten_cha_me || '';
      document.getElementById('c-gioitinh').innerText = r.gioi_tinh || '';
      document.getElementById('c-lop').innerText = lop;
      document.getElementById('c-sotien').innerText = soTien;
      document.getElementById('c-truong').innerText = schoolName;
      document.getElementById('c-lop-big').innerText = String(lop||'').trim();
      document.getElementById('c-footer-code').innerText = (lop?lop:'') + (r.so_thang_dong?(' - '+r.so_thang_dong+'T'):'');
      new bootstrap.Modal(document.getElementById('modalTheBHTN')).show();
    }

    async function downloadCardImage(){
      try{
        const node=document.getElementById('cardArea');
        const canvas=await html2canvas(node,{scale:2, backgroundColor:'#ffffff'});
        const dataURL=canvas.toDataURL("image/png");
        const canDownload='download' in document.createElement('a') && !isMobile();
        if (canDownload){
          const a=document.createElement('a'); a.href=dataURL; a.download='the-bhtn.png';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        } else {
          const w=window.open();
          if (w){
            w.document.write(`<html><head><title>Lưu ảnh thẻ</title></head><body style="margin:0"><img src="${dataURL}" style="max-width:100%;display:block"/></body></html>`);
            w.document.close();
          } else {
            alert('Trình duyệt chặn tải trực tiếp. Ảnh sẽ mở ở tab mới để bạn lưu thủ công.');
            window.location.href=dataURL;
          }
        }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }

    /* ========= Toast ========= */
    function showToast(msg){
      document.getElementById('toast-message').innerText = msg;
      bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show();
    }

    /* ========= Boot ========= */
    window.onload = fetchDanhSachDaThu;
  </script>
</body>
</html>
