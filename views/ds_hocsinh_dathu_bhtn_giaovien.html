<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã tham gia BHTN - Giáo viên</title>
  <!-- Disable Devtool -->
  <script src="/js/anti-devtools.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>


  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px;padding-bottom:6px}
    .search-row{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:10px;gap:10px;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{font-size:1rem;font-weight:400;color:#444}
    th.th-action{min-width:220px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:13px;margin-left:4px;vertical-align:middle}
    .btn-back{position:fixed;bottom:26px;right:20px;z-index:1099;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 14px #0003;font-size:25px;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid #eee;color:#2563eb}
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}

    @media(max-width:600px){
      .header{font-size:18px}
      th.th-action{min-width:180px}
      .search-row{flex-direction:column;align-items:stretch}
      .action-btns{display:flex;flex-direction:column;gap:6px}
      .action-btns .btn{width:100%}
    }
    @media(min-width:601px){.action-btns{display:flex;flex-direction:row;gap:6px}}

    /* trạng thái */
    .status-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .status-pending{color:#b91c1c;background:#fee2e2}
    .status-paid-wait{color:#b91c1c;background:#ffe4e6}
    .status-active{color:#065f46;background:#d1fae5}
    .hoso-text{display:block;font-size:12px;color:#1d4ed8;margin-top:4px}

    /* ==== THẺ BHTN ==== */
    :root{--cardW-bhtn:900px;--cardH-bhtn:560px;--orange:#f59e0b}
    #cardScaleWrapBHTN{position:relative;width:var(--cardW-bhtn);height:var(--cardH-bhtn);transform-origin:top left;margin:0 auto}
    .bhtn-card{width:var(--cardW-bhtn);height:var(--cardH-bhtn);background:#fff;border:8px solid var(--orange);border-radius:14px;padding:8px;box-shadow:0 2px 10px #0001;overflow:hidden;position:relative}
    .bhtn-inner{height:100%;border:3px solid var(--orange);border-radius:12px;padding:16px 24px 24px;display:flex;flex-direction:column}
    .bhtn-top{display:flex;align-items:center;justify-content:center;margin-bottom:4px}
    .bhtn-logo{height:60px;object-fit:contain}
    .bhtn-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:22px;margin-top:6px}
    .kv{display:flex;gap:12px;margin:8px 0;align-items:flex-start}
    .kv .k{min-width:190px;color:#6b7280;font-weight:800}
    .kv .v{color:#111827;font-weight:800}
    .v-blue{color:#0b53ff!important}
    .v-red{color:#e11d48!important}
    .v-green{color:#0f9d58!important}
    .bhtn-lop{font-size:56px;font-weight:900;color:#9ca3af;text-align:right}
    .bhtn-stamp{margin-top:8px;text-align:center;font-weight:900;color:#16a34a;font-size:30px}
    .bhtn-badge{margin-top:8px;display:flex;justify-content:center}
    .bhtn-badge span{background:#fff3b0;border:2px solid #facc15;padding:8px 16px;border-radius:6px;font-weight:900;color:#1d4ed8}
    .bhtn-qr{position:absolute;right:16px;bottom:16px;width:96px;height:96px;border:2px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:6px}

    /* ==== A5 preview ==== */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}

    @media print{
      @page{size:A5 portrait;margin:10mm}
      body{background:#fff!important}
      .modal{position:static!important}
      .modal-content{box-shadow:none!important;border:none!important}
      .no-print{display:none!important}
      .a5-paper{box-shadow:none!important;margin:0!important}
      #cardScaleWrapBHTN{transform:none!important}
    }


    /* Ẩn phân trang khi màn hình ≤ 999px */
    @media (max-width: 999px){
      nav .pagination { display: none !important; }
    }



    /* Cột Họ tên: không wrap, rộng tối thiểu */
    th.th-hoten, td.td-hoten{
      white-space: nowrap;
      min-width: 220px;   /* bạn có thể chỉnh con số này */
      max-width: none;
    }


  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA BHTN LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row mb-2">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);align-items:center;justify-content:center">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal THẺ -->
  <div class="modal fade" id="modalTheBHTN" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ bảo hiểm tai nạn</h5>
        <div class="d-flex gap-2 no-print"><button class="btn btn-secondary btn-sm" onclick="downloadCardImage()">Lưu ảnh thẻ</button></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="cardScaleWrapBHTN">
          <div id="cardAreaBHTN" class="bhtn-card">
            <div class="bhtn-inner">
              <div class="bhtn-top">
                <img class="bhtn-logo" src="../assets/image/baoviet-logo.png" alt="BAOVIET" onerror="this.style.display='none'">
              </div>

              <div class="kv"><div class="k">Đối tượng đóng</div><div class="v" id="c-doituong">—</div></div>
              <div class="kv"><div class="k">Số thẻ</div><div class="v v-blue" id="c-so-the">—</div></div>

              <div class="bhtn-grid">
                <div>
                  <div class="kv"><div class="k">Họ và tên</div><div class="v" id="c-hoten">—</div></div>
                  <div class="kv"><div class="k">Ngày sinh</div><div class="v" id="c-ngaysinh">—</div></div>
                  <div class="kv"><div class="k">Sử dụng từ</div><div class="v v-blue" id="c-tu">—</div></div>
                  <div class="kv"><div class="k">Ngày hết hạn</div><div class="v v-red" id="c-den">—</div></div>
                  <div class="kv"><div class="k">Địa chỉ</div><div class="v" id="c-diachi">—</div></div>
                  <div class="kv"><div class="k">Điện thoại</div><div class="v" id="c-sdt">—</div></div>
                  <div class="kv"><div class="k">Tên Cha/Mẹ</div><div class="v" id="c-tencha">—</div></div>
                </div>
                <div>
                  <div class="kv"><div class="k">Giới tính</div><div class="v" id="c-gioitinh">—</div></div>
                  <div class="kv"><div class="k">Lớp</div><div class="v" id="c-lop">—</div></div>
                  <div class="kv"><div class="k">Số tiền đóng</div><div class="v v-green" id="c-sotien">—</div></div>
                  <div class="bhtn-lop" id="c-lop-big"> </div>
                </div>
              </div>

              <div class="bhtn-stamp">ĐÃ KÍCH HOẠT</div>
              <div class="bhtn-badge"><span id="c-badge">—</span></div>

              <div id="card-qr" class="bhtn-qr"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex gap-2 no-print"><button class="btn btn-secondary btn-sm" onclick="downloadCardImage()">Lưu ảnh thẻ</button></div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div></div>
  </div>

  <!-- Modal PHIẾU THU -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5) – BHTN</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col"><div class="receipt-meta"><div><strong id="rec-school">Trường …</strong></div><div>Lớp: <strong id="rec-class">—</strong></div></div></div>
            <div class="col text-center"><div class="receipt-meta"><div><strong>Mẫu số:</strong> C45-BB</div><div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div><div>ngày 10/10/2017 của Bộ Tài Chính</div></div></div>
          </div>
          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center"><div class="receipt-title">BIÊN LAI THU TIỀN</div><div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div></div>
          </div>
          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">Thu tiền BHTN</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>
          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== INIT ====== */
    const isIOS=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.userAgent.includes('Mac')&&'ontouchend'in document);
    let user=JSON.parse(localStorage.getItem("user")||"{}");
    if(!user.sdt||user.phan_quyen!=="giao_vien") location.href="../index.html";
    document.getElementById("lop-hoc").innerText=user.lop_hoc||"(chưa xác định)";

    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1,allData=[],lastFiltered=[];
    window._viewData=[];

    function showLoading(){document.getElementById('loadingSpinner').style.display='flex'}
    function hideLoading(){document.getElementById('loadingSpinner').style.display='none'}
    function goBack(){showLoading();location.href="bhtn_giaovien.html"}

    // ===== No-paging khi màn hình ≤ 999px
    const NO_PAGING_MAX_WIDTH = 999;
    function isNoPagingDevice(){ return window.innerWidth <= NO_PAGING_MAX_WIDTH; }

    // Thay toàn bộ detectPageSize cũ:
    function detectPageSize(){
      if (isNoPagingDevice()){
        pageSize = Number.MAX_SAFE_INTEGER;   // gom hết vào 1 trang
      } else {
        pageSize = 20;                         // desktop giữ như cũ
      }
    }

    // function detectPageSize(){const w=innerWidth;if(w<=600)pageSize=5;else if(w<=999)pageSize=10;else pageSize=20}
    addEventListener('resize',()=>{const old=pageSize;detectPageSize();if(old!==pageSize){currentPage=1;renderAllView()}});

    /* ====== Helpers ====== */
    const norm = v => String(v??"").replace(/^'/,'').trim();
    const toNum = v => {const n=Number(norm(v));return isNaN(n)?0:n;}
    const toTrangThai = v => {const n=Number(norm(v));return isNaN(n)?undefined:n;}
    const cleanVal = v => {const s=norm(v);return (!s||s==='null'||s==='undefined'||s==='NaN')?"":s}

    function displayDate(raw){
      if(!raw)return "";
      if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
      if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(raw)){const [y,m,d]=raw.split('-');return `${d}/${m}/${y}`}
      return raw;
    }
    function getSoHoSo(row){return cleanVal(row.so_ho_so??row.sohoso??row.so_hs)}

    /* ====== Fetch ====== */
    async function fetchDaThuBHTN(){
      try{
        detectPageSize();showLoading();
        const bhtnRes=await getDanhSachBHTN(user.ma_truong,user.lop_hoc);
        const rows=Array.isArray(bhtnRes?.data)?bhtnRes.data:[];
        allData=rows.filter(r=>r&&r.so_dinh_danh).map(r=>({
          ...r,
          trang_thai: toTrangThai(r.trang_thai),
          so_ho_so: getSoHoSo(r),
          ma_so_bhtn: cleanVal(r.ma_so_bhtn)
        }));
        currentPage=1;doSearch();
      }catch(e){allData=[];doSearch()}finally{hideLoading()}
    }

    /* ====== Table & sort ====== */
    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
    function statusCell(row){
      const st=toTrangThai(row.trang_thai), shs=getSoHoSo(row);
      if (st===0) return `<span class="status-badge status-pending">Chờ duyệt</span>`;
      if (st===1 && !shs) return `<span class="status-badge status-paid-wait">Đã nộp, chờ kích hoạt</span>`;
      if (st===1 && shs) return `<div><span class="status-badge status-active">Đã kích hoạt</span><span class="hoso-text">${shs}</span></div>`;
      return `<span class="status-badge status-pending">Đang xử lý</span>`;
    }
    function actionsCell(i,row){
      const st = toTrangThai(row.trang_thai);
      const shs = getSoHoSo(row);

      if (st === 1 && shs){
        // ĐÃ KÍCH HOẠT: giữ nút Xem thẻ, đổi nút In sang icon printer
        return `<div class="action-btns">
                  <button class="btn btn-sm btn-info" onclick="onViewCardIdx(${i})">Xem thẻ</button>
                  <button class="btn btn-sm btn-primary" onclick="onPrintReceiptIdx(${i})" title="In phiếu thu">
                    <i class="bi bi-printer"></i>
                  </button>
                </div>`;
      }

      // Các trạng thái khác: chỉ cho in phiếu thu (icon printer)
      return `<div class="action-btns">
                <button class="btn btn-sm btn-primary" onclick="onPrintReceiptIdx(${i})" title="In phiếu thu">
                  <i class="bi bi-printer"></i>
                </button>
              </div>`;
    }

    function buildTableHead(){
      return `<thead><tr>
        <th class="th-action">Thao tác</th>
        <th>Trạng thái</th>
        <th class="sortable th-hoten" data-field="ho_ten_hoc_sinh">Họ tên ${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" data-field="ngay_sinh">Ngày sinh ${sortIcon('ngay_sinh')}</th>
        <th class="sortable" data-field="so_dinh_danh">Số định danh ${sortIcon('so_dinh_danh')}</th>
        <th class="sortable" data-field="doi_tuong_dong">Đối tượng đóng ${sortIcon('doi_tuong_dong')}</th>
        <th class="sortable" data-field="so_thang_dong">Số tháng đóng ${sortIcon('so_thang_dong')}</th>
        <th class="sortable" data-field="han_su_dung_bhtn_moi">Hạn BHTN mới ${sortIcon('han_su_dung_bhtn_moi')}</th>
      </tr></thead>`;
    }
    function attachSortHandlers(){
      document.querySelectorAll('th.sortable').forEach(th=>{
        th.onclick=()=>{const field=th.getAttribute('data-field');if(!field)return; if(sortField===field)sortDir=-sortDir;else{sortField=field;sortDir=1;} renderAllView();}
      });
    }
    function renderDanhSachHS(ds,startIdx){
      if(!ds||ds.length===0){document.getElementById('ds-container').innerHTML=`<div class='text-center text-secondary mt-4'>Không có hồ sơ BHTN trong lớp này.</div>`;return}
      const thead=buildTableHead();
      const rows=ds.map((r,i)=>`<tr>
        <td>${actionsCell(startIdx+i,r)}</td>
        <td>${statusCell(r)}</td>
        <td class="td-hoten">${(r.ho_ten_hoc_sinh||"")}</td>
        <td>${displayDate(r.ngay_sinh)||""}</td>
        <td>${(r.so_dinh_danh||"")}</td>
        <td>${(r.doi_tuong_dong||"Học sinh")}</td>
        <td class="text-center">${(r.so_thang_dong||"")}</td>
        <td>${displayDate(r.han_su_dung_bhtn_moi||"")}</td>
      </tr>`).join('');
      document.getElementById('ds-container').innerHTML=`<table class="table table-bordered table-hs align-middle">${thead}<tbody>${rows}</tbody></table>`;
      attachSortHandlers();
    }
    function renderPagination(){
      const el=document.getElementById('pagination');
      if (!el) return;

      // Màn hình nhỏ: không phân trang
      if (isNoPagingDevice()){
        el.innerHTML = '';
        return;
      }
      
      let html='';if(totalPages<=1){el.innerHTML='';return}
      const add=(p,lab,act=false,dis=false)=>`<li class="page-item ${act?'active':''} ${dis?'disabled':''}"><a class="page-link" href="javascript:void(0)" onclick="gotoPage(${p})">${lab}</a></li>`;
      html+=add(Math.max(1,currentPage-1),'&laquo;',false,currentPage===1);
      for(let i=1;i<=totalPages;i++) html+=add(i,i,i===currentPage,false);
      html+=add(Math.min(totalPages,currentPage+1),'&raquo;',false,currentPage===totalPages);
      el.innerHTML=html;
    }
    function gotoPage(p){if(p<1||p>totalPages)return;currentPage=p;renderAllView()}
    function doSearch(){
      const q=document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered=!q?allData:allData.filter(h=>
        (h.ho_ten_hoc_sinh||"").toLowerCase().includes(q)||
        (displayDate(h.ngay_sinh)||"").toLowerCase().includes(q)||
        (h.so_dinh_danh||"").toLowerCase().includes(q)||
        (h.doi_tuong_dong||"").toLowerCase().includes(q)
      );
      currentPage=1;renderAllView();
    }
    // function renderAllView(){
    //   let data=lastFiltered||allData;
    //   if(sortField){
    //     data=[...data].sort((a,b)=>{
    //       let av=(a[sortField]??"").toString().toLowerCase(),bv=(b[sortField]??"").toString().toLowerCase();
    //       if(!isNaN(+av)&&!isNaN(+bv)){av=+av;bv=+bv}
    //       return av<bv?-sortDir:av>bv?sortDir:0
    //     });
    //   }
    //   window._viewData=data;
    //   totalRecords=data.length;totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));
    //   document.getElementById('total-hs').innerText=`(${totalRecords} hồ sơ)`;
    //   const start=(currentPage-1)*pageSize;
    //   renderDanhSachHS(data.slice(start,start+pageSize),start);
    //   renderPagination();
    // }

    function renderAllView(){
      let data = lastFiltered || allData;

      if (sortField){
        data = [...data].sort((a,b)=>{
          if (sortField === 'ho_ten_hoc_sinh'){
            // ✅ Sort theo TÊN (given name), không dấu, không phân biệt hoa/thường
            const av = toSortKeyVN(getTen(a.ho_ten_hoc_sinh));
            const bv = toSortKeyVN(getTen(b.ho_ten_hoc_sinh));
            if (av < bv) return -sortDir;
            if (av > bv) return  sortDir;

            // tie-breaker: nếu trùng tên, so tiếp full name (không dấu)
            const af = toSortKeyVN(a.ho_ten_hoc_sinh||'');
            const bf = toSortKeyVN(b.ho_ten_hoc_sinh||'');
            if (af < bf) return -sortDir;
            if (af > bf) return  sortDir;
            return 0;
          }

          // Các cột khác giữ nguyên logic cũ
          let av=(a[sortField]??"").toString().toLowerCase(),
              bv=(b[sortField]??"").toString().toLowerCase();
          if(!isNaN(+av) && !isNaN(+bv)){ av=+av; bv=+bv; }
          return av<bv ? -sortDir : av>bv ? sortDir : 0;
        });
      }

      window._viewData = data;
      totalRecords = data.length;
      totalPages   = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} hồ sơ)`;

      const start=(currentPage-1)*pageSize;
      renderDanhSachHS(data.slice(start,start+pageSize),start);
      renderPagination();
    }




    /* ====== Actions ====== */
    function onViewCardIdx(i){const row=window._viewData[i];if(!row)return;showLoading();setTimeout(()=>onViewCard(row),50)}
    function onPrintReceiptIdx(i){const row=window._viewData[i];if(!row)return;showLoading();setTimeout(()=>onPrintReceipt(row),50)}

    function parseDate(s){if(!s)return null;if(typeof s==='string'&&/^\d{2}\/\d{2}\/\d{4}$/.test(s)){const[d,m,y]=s.split('/').map(Number);return new Date(y,m-1,d)} if(typeof s==='string'&&/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);return null}
    function formatDateVN(d){return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`}
    function makeRangeBHTN(row){const end=row.han_su_dung_bhtn_moi||"";const months=Number(row.so_thang_dong||0);const e=parseDate(end);if(!e||!months)return{tu:"",den:""};const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);return {tu:formatDateVN(s),den:formatDateVN(e)}}
    const toVND=n=>Number(n||0).toLocaleString('vi-VN');
    const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s="";if(tr>0){s+=VI_DIGITS[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ"}if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv]}return s.trim()}
    function numberToVietnamese(n){n=Math.round(Number(n)||0);if(n===0)return"Không đồng";const u=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";while(n>0&&i<u.length){const b=n%1000;if(b>0){const p=readTriple(b);str=p+u[i]+(str?" "+str:"")}n=Math.floor(n/1000);i++}return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim()}
    function todayText(){const d=new Date();return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`}
    function buildQRPayload(mt,school,cls,name,months,endDate){const _mt=String(mt||"").slice(0,24),s=(school||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').slice(0,60),c=String(cls||"").slice(0,12),n=(name||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').slice(0,60),m=String(months||""),e=String(endDate||"").slice(0,10);return `MT=${_mt};S=${s};L=${c};N=${n};M=${m};E=${e}`}

    /* === Xem thẻ === */
    function onViewCard(row){
      const {tu,den}=makeRangeBHTN(row);
      const sohoso=getSoHoSo(row)||"—";
      const lop=row.lop_hoc||user.lop_hoc||"—";

      document.getElementById('c-doituong').innerText=row.doi_tuong_dong||'Học sinh';
      document.getElementById('c-so-the').innerText=cleanVal(row.ma_so_bhtn)||'—';
      document.getElementById('c-hoten').innerText=row.ho_ten_hoc_sinh||'—';
      document.getElementById('c-ngaysinh').innerText=displayDate(row.ngay_sinh)||'—';
      document.getElementById('c-tu').innerText=tu||'—';
      document.getElementById('c-den').innerText=den||'—';
      document.getElementById('c-diachi').innerText=cleanVal(row.dia_chi)||'—';
      document.getElementById('c-sdt').innerText=cleanVal(row.sdt_lienhe||row.sdt)||'—';
      document.getElementById('c-tencha').innerText=cleanVal(row.ten_cha_me)||'—';
      document.getElementById('c-gioitinh').innerText=cleanVal(row.gioi_tinh)||'—';
      document.getElementById('c-lop').innerText=lop;
      document.getElementById('c-lop-big').innerText=lop;
      document.getElementById('c-sotien').innerText=toVND(row.so_tien||0);
      document.getElementById('c-badge').innerText=sohoso;

      const qrBox=document.getElementById('card-qr'); qrBox.innerHTML='';
      const months=parseInt(row.so_thang_dong||"12",10);
      const qrText=buildQRPayload(user.ma_truong,(user.ten_truong||''),lop,(row.ho_ten_hoc_sinh||""),months,den);
      try{new QRCode(qrBox,{text:qrText,width:92,height:92,correctLevel:QRCode.CorrectLevel.L})}catch(_){qrBox.innerHTML='<small>QR</small>'}

      const modalEl=document.getElementById('modalTheBHTN');
      new bootstrap.Modal(modalEl).show(); hideLoading();
      setTimeout(scaleCardToViewportBHTN,10);
    }

    function scaleCardToViewportBHTN(){
      const wrap=document.getElementById('cardScaleWrapBHTN'); if(!wrap) return;
      const W=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW-bhtn'))||900;
      const H=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardH-bhtn'))||560;
      const modalBody=document.querySelector('#modalTheBHTN .modal-body');
      const pad=24; const vw=Math.max(320,modalBody.clientWidth-pad); const vh=Math.max(260,modalBody.clientHeight-pad);
      wrap.style.transform=`scale(${Math.min(vw/W,vh/H)})`;
    }
    // gắn sự kiện (không dùng ?. để tránh crash)
    (function(){
      const el=document.getElementById('modalTheBHTN');
      if(!el) return;
      el.addEventListener('shown.bs.modal',()=>{setTimeout(scaleCardToViewportBHTN,10);window.addEventListener('resize',scaleCardToViewportBHTN);});
      el.addEventListener('hidden.bs.modal',()=>{window.removeEventListener('resize',scaleCardToViewportBHTN);});
    })();

    async function downloadCardImage(){
      try{
        const src = document.getElementById('cardAreaBHTN');
        if (!src) return;

        // Kích thước gốc của thẻ
        const W = parseFloat(getComputedStyle(document.documentElement)
                  .getPropertyValue('--cardW-bhtn')) || 900;
        const H = parseFloat(getComputedStyle(document.documentElement)
                  .getPropertyValue('--cardH-bhtn')) || 560;

        // Sân khấu off-screen
        const stage = document.createElement('div');
        stage.style.position = 'fixed';
        stage.style.left = '-10000px';
        stage.style.top = '0';
        stage.style.width = W + 'px';
        stage.style.height = H + 'px';
        stage.style.background = '#fff';
        document.body.appendChild(stage);

        // Clone nội dung thẻ
        const clone = src.cloneNode(true);
        clone.style.transform = 'none';
        clone.style.width = W + 'px';
        clone.style.height = H + 'px';

        // 🔁 Copy mã QR từ bản thật sang clone (canvas -> img dataURL)
        const liveQR = src.querySelector('#card-qr canvas, #card-qr img');
        const cloneQRHolder = clone.querySelector('#card-qr');
        if (cloneQRHolder && liveQR){
          let dataURL = '';
          if (liveQR.tagName.toLowerCase() === 'canvas') dataURL = liveQR.toDataURL('image/png');
          else dataURL = liveQR.src;
          const imgQR = document.createElement('img');
          imgQR.src = dataURL;
          imgQR.style.display = 'block';
          imgQR.style.width  = getComputedStyle(cloneQRHolder).width  || '96px';
          imgQR.style.height = getComputedStyle(cloneQRHolder).height || '96px';
          cloneQRHolder.innerHTML = '';
          cloneQRHolder.appendChild(imgQR);
        }

        stage.appendChild(clone);

        // Đợi font sẵn sàng để tránh dồn chữ
        if (document.fonts && document.fonts.ready) { try{ await document.fonts.ready; }catch(_){} }
        // Đợi 1 frame cho QR-img gắn vào DOM xong
        await new Promise(r => requestAnimationFrame(() => setTimeout(r, 50)));

        // Chụp ảnh
        const canvas = await html2canvas(clone, {
          scale: Math.max(2, (window.devicePixelRatio || 1)),
          backgroundColor: '#ffffff',
          useCORS: true,
          allowTaint: true,
          width: W, height: H, windowWidth: W, windowHeight: H
        });

        // Dọn dẹp & lưu
        document.body.removeChild(stage);
        const dataURL = canvas.toDataURL('image/png');
        const canDownload = ('download' in document.createElement('a')) && !isIOS();
        if (canDownload){
          const a = document.createElement('a');
          a.href = dataURL; a.download = 'the-bhtn.png';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        } else {
          const w = window.open();
          if (w){ w.document.write(`<img src="${dataURL}" style="max-width:100%;display:block;margin:0 auto"/>`); w.document.close(); }
          else { location.href = dataURL; }
        }
      }catch(e){
        alert('Không thể lưu ảnh: ' + (e.message || e));
      }
    }

    /* ====== Phiếu thu ====== */
    async function getTenTruong(ma_truong){try{const u=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;const r=await fetch(u);const j=await r.json();return j?.ten_truong||j?.data?.ten_truong||user.ten_truong||ma_truong||'—'}catch(e){return user.ten_truong||ma_truong||'—'}}

    function onPrintReceipt(row){
      getTenTruong(user.ma_truong).then(truong=>{
        const lop=row.lop_hoc||user.lop_hoc||"—";
        const months=parseInt(row.so_thang_dong||"12",10);
        const amount=parseInt((row.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
        const end=row.han_su_dung_bhtn_moi||""; const e=parseDate(end);
        let startText="—",endText="(không xác định)";
        if(e&&months>0){const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);startText=formatDateVN(s);endText=formatDateVN(e)}
        document.getElementById('rec-school').innerText=truong;
        document.getElementById('rec-class').innerText=lop;
        document.getElementById('rec-date-today').innerText=todayText();
        document.getElementById('rec-student-name').innerText=row.ho_ten_hoc_sinh||"";
        document.getElementById('rec-address').innerText=row.dia_chi||"";
        document.getElementById('rec-content').innerText=`Thu tiền BHTN - ${lop}`;
        document.getElementById('rec-months').innerText=String(months);
        document.getElementById('rec-range').innerText=`từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText=toVND(amount);
        document.getElementById('rec-amount-text').innerText=numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText=user.ho_ten||"(Giáo viên)";
        const qrBox=document.getElementById('receipt-qr');qrBox.innerHTML="";
        const payload=buildQRPayload(user.ma_truong,truong,lop,row.ho_ten_hoc_sinh||"",months,endText);
        try{new QRCode(qrBox,{text:payload,width:90,height:90,correctLevel:QRCode.CorrectLevel.L})}catch(_){qrBox.innerHTML='<small>QR</small>'}
        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
        hideLoading();
      }).catch(()=>hideLoading());
    }

    async function downloadReceiptImage(){
      try{
        const node=document.getElementById('receiptA5');
        const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff',useCORS:true,allowTaint:true});
        const dataURL=canvas.toDataURL("image/png");
        if('download'in document.createElement('a')&&!isIOS()){
          const a=document.createElement('a');a.href=dataURL;a.download='phieu-thu-bhtn.png';document.body.appendChild(a);a.click();document.body.removeChild(a);
        }else{
          const w=window.open(); if(w){w.document.write(`<html><body style="margin:0"><img src="${dataURL}" style="max-width:100%"></body></html>`);w.document.close();}else{location.href=dataURL;}
        }
      }catch(e){alert('Không thể lưu ảnh: '+(e.message||e));}
    }

    function getReceiptPrintCSS(){return `
      <style>
        @page{size:A5 portrait;margin:10mm}
        html,body{background:#fff;margin:0;padding:0}
        .a5-paper{width:148mm;min-height:210mm;background:#fff;color:#000;margin:0 auto;padding:10mm 12mm;line-height:1.35;font-size:13px}
        .receipt-title{font-weight:700;font-size:20px;text-transform:uppercase;letter-spacing:.4px}
        .receipt-sub{font-style:italic}
        .receipt-meta{font-size:13px}
        .receipt-line{margin:2mm 0}
        .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
        .sign-col{text-align:center;margin-top:10mm;font-weight:500}
        .sign-name{margin-top:20mm;text-align:center;font-weight:600}
        .row{display:flex;flex-wrap:nowrap;width:100%}
        .col{flex:1 1 0}
        .text-center{text-align:center}
      </style>`}

    function printReceiptOnly(){
      const src=document.getElementById('receiptA5'); if(!src) return;
      const clone=src.cloneNode(true);
      // nhúng QR (canvas/img) sang bản in
      const live=src.querySelector('#receipt-qr canvas, #receipt-qr img');
      if(live){
        try{
          const dataURL=(live.tagName.toLowerCase()==='canvas')?live.toDataURL('image/png'):live.src;
          const holder=clone.querySelector('#receipt-qr'); holder.innerHTML='';
          const img=document.createElement('img'); img.src=dataURL; img.style.width='90px'; img.style.height='90px'; holder.appendChild(img);
        }catch(_){}
      }
      const html=`<!doctype html><html><head><meta charset="utf-8">${getReceiptPrintCSS()}</head><body>${clone.outerHTML}</body></html>`;
      // in qua iframe ẩn để chỉ in đúng nội dung
      const ifr=document.createElement('iframe');
      ifr.style.position='fixed';ifr.style.right='0';ifr.style.bottom='0';ifr.style.width='0';ifr.style.height='0';ifr.style.border='0';
      document.body.appendChild(ifr);
      const doc=ifr.contentWindow.document;
      doc.open();doc.write(html);doc.close();
      const done=()=>{ifr.contentWindow.focus();ifr.contentWindow.print();setTimeout(()=>document.body.removeChild(ifr),400);}
      const imgs=ifr.contentDocument.images; if(imgs.length===0){done();}else{
        let loaded=0; for(const im of imgs){im.onload=im.onerror=()=>{loaded++; if(loaded>=imgs.length) done();};}
      }
    }

    /* ====== Boot ====== */
    window.onload=fetchDaThuBHTN;



    // === SẮP XẾP CỘT HỌ TÊN THEO ALPHABET ===
    function stripVN(s){
      return String(s||"").normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/đ/g,'d').replace(/Đ/g,'D');
    }
    function getTen(fullname){
      const s = String(fullname || '').trim().replace(/\s+/g,' ');
      if (!s) return '';
      const parts = s.split(' ');
      return parts[parts.length - 1]; // lấy TÊN
    }
    function toSortKeyVN(s){
      return stripVN(String(s||'')).toLowerCase();
    }


  </script>
</body>
</html>
