<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DS học sinh đã tham gia BHTN - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:6px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px}
    .search-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;position:sticky;top:46px;z-index:998;background:#f8f9fa;padding:4px 0}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{color:#444;font-weight:400}
    th.th-action{min-width:200px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:15px;vertical-align:middle;margin-left:3px}
    .btn-back{
      position:fixed;bottom:26px;right:20px;z-index:1099;width:54px;height:54px;border-radius:50%;
      background:#fff;border:2px solid #eee;color:#2563eb;font-size:25px;
      display:flex;align-items:center;justify-content:center;box-shadow:0 2px 14px #0003
    }
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}

    @media (max-width:600px){
      .header{font-size:18px}
      th.th-action{min-width:150px}
      .search-row{flex-direction:column;align-items:stretch}
      .action-btns{display:flex;flex-direction:column;gap:6px}
      .action-btns .btn{width:100%}
    }
    @media (min-width:601px){
      .action-btns{display:flex;flex-direction:row;gap:6px}
    }

    /* ======= CARD (thẻ BHTN) ======= */
    .card-wrap{
      max-width:980px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 2px 14px #0002;
      padding:28px;position:relative;border:8px solid #f59e0b /* cam */;outline:10px solid #fff
    }
    .card-inner{border:6px solid #f59e0b;border-radius:12px;padding:26px;position:relative}
    .brand{display:flex;justify-content:center;margin-top:4px;margin-bottom:18px}
    .brand img{height:42px}
    .field{display:grid;grid-template-columns:220px 1fr 220px 1fr;gap:10px 18px;align-items:center}
    .field .label{color:#6b7280;font-weight:700}
    .field .val{font-weight:700;color:#0f172a}
    .field .val.em{color:#2563eb}
    .field .val.red{color:#ef4444}
    .field .val.green{color:#16a34a}
    .big-class{position:absolute;right:36px;bottom:120px;font-size:68px;font-weight:800;color:#94a3b8}
    .activated{margin-top:18px;text-align:center;font-size:34px;color:#16a34a;font-weight:800}
    .yellow-badge{display:inline-block;background:#fde68a;border:2px solid #f59e0b;color:#1f2937;
      padding:8px 18px;border-radius:12px;margin:10px auto 0;font-weight:800}
    .qr-bottom-right{position:absolute;right:36px;bottom:24px;width:110px;height:110px;border-radius:6px;overflow:hidden}

    /* ======= Receipt A5 inside modal ======= */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:20px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}

    .no-print{user-select:none}
    @media print{
      /* trang in chỉ có nội dung từ iframe nên không cần chỉnh ở đây */
    }
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA BHTN LỚP <span id="lop-hoc">—</span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Modal XEM THẺ BHTN -->
  <div class="modal fade" id="modalTheBHTN" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem thẻ BHTN</h5>
        <div class="d-flex gap-2 no-print">
          <button class="btn btn-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh thẻ</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="bhtnCard" class="card-wrap">
          <div class="card-inner">
            <div class="brand">
              <img src="../assets/image/baoviet-logo.png" alt="BAOVIET" crossOrigin="anonymous">
            </div>
            <div class="field">
              <div class="label">Đối tượng đóng</div><div class="val" id="c-doituong">—</div>
              <div class="label">Giới tính</div><div class="val" id="c-gioitinh">—</div>

              <div class="label">Số thẻ</div><div class="val em" id="c-sothe">—</div>
              <div class="label">Lớp</div><div class="val" id="c-lop">—</div>

              <div class="label">Họ và tên</div><div class="val" id="c-hoten">—</div>
              <div class="label">Số tiền đóng</div><div class="val green" id="c-sotien">—</div>

              <div class="label">Ngày sinh</div><div class="val" id="c-ngaysinh">—</div>
              <div class="label">Sử dụng từ</div><div class="val em" id="c-begin">—</div>

              <div class="label">Ngày hết hạn</div><div class="val red" id="c-end">—</div>
              <div></div><div></div>

              <div class="label">Địa chỉ</div><div class="val" id="c-diachi">—</div>
              <div class="label">Điện thoại</div><div class="val" id="c-phone">—</div>

              <div class="label">Tên Cha/Mẹ</div><div class="val" id="c-cha_me">—</div>
              <div></div><div></div>
            </div>

            <div class="big-class" id="c-class-big">—</div>
            <div class="activated">ĐÃ KÍCH HOẠT</div>
            <div class="text-center"><span class="yellow-badge" id="c-sohoso">—</span></div>
            <div class="qr-bottom-right"><div id="c-qr"></div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="saveCardImage()">Lưu ảnh thẻ</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xem trước & in Phiếu thu A5 (BHTN) -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5) – BHTN</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col">
              <div class="receipt-meta">
                <div><strong id="rec-school">Trường …</strong></div>
                <div>Lớp: <strong id="rec-class">—</strong></div>
              </div>
            </div>
            <div class="col text-center">
              <div class="receipt-meta">
                <div><strong>Mẫu số:</strong> C45-BB</div>
                <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                <div>ngày 10/10/2017 của Bộ Tài Chính</div>
              </div>
            </div>
          </div>

          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center">
              <div class="receipt-title">BIÊN LAI THU TIỀN</div>
              <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">Thu tiền BHTN</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">12</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>

          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small>
              <div class="sign-name" id="rec-teacher-name">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== State & guards ====== */
    const logPrefix='[BHTN-DaThu]';
    let user=JSON.parse(localStorage.getItem('user')||'{}');
    if(!user.sdt || user.phan_quyen!=='giao_vien') window.location.href='../index.html';
    document.getElementById('lop-hoc').innerText=user.lop_hoc||'(chưa xác định)';

    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1;
    let allData=[],lastFiltered=[];

    function showLoading(){document.getElementById('loadingSpinner').style.display='flex'}
    function hideLoading(){document.getElementById('loadingSpinner').style.display='none'}
    function goBack(){showLoading();window.location.href='bhtn_giaovien.html'}

    const isIOS=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.userAgent.includes('Mac')&&'ontouchend'in document);

    function displayNgaySinh(raw){
      if(!raw) return "";
      if(raw.match&&raw.match(/^\d{4}-\d{2}-\d{2}T/)) return new Date(raw).toLocaleDateString('vi-VN');
      if(raw.match&&raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if(raw.match&&raw.match(/^\d{4}-\d{2}-\d{2}$/)){const[y,m,d]=raw.split('-');return `${d}/${m}/${y}`;}
      return raw;
    }
    function parseVNDate(str){const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(!m)return null;const d=new Date(+m[3],+m[2]-1,+m[1]);return(d.getFullYear()==+m[3]&&d.getMonth()==+m[2]-1&&d.getDate()==+m[1])?d:null;}
    function formatVNDate(d){const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');const yy=d.getFullYear();return `${dd}/${mm}/${yy}`;}
    function addDaysExact(dateObj,days){const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0);d.setDate(d.getDate()+days);return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
    function todayText(){const d=new Date();return`Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`;}

    function detectPageSize(){const w=window.innerWidth;if(w<=600)pageSize=5;else if(w<=999)pageSize=10;else pageSize=20;}
    window.addEventListener('resize',()=>{const prev=pageSize;detectPageSize();if(pageSize!==prev){currentPage=1;renderAllView();}});

    /* ====== Fetch ====== */
    async function fetchDaThu(){
      try{
        detectPageSize();showLoading();
        const res=await getDanhSachBHTN(user.ma_truong,user.lop_hoc);
        const arr=Array.isArray(res?.data)?res.data:[];
        allData=arr.map(r=>({...r}));
        currentPage=1;doSearch();
      }catch(e){console.error(logPrefix,'fetch error',e)}
      finally{hideLoading();}
    }

    /* ====== Search/sort/paginate ====== */
    function doSearch(){
      const q=document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered=!q?allData:allData.filter(hs=>
        String(hs.ho_ten_hoc_sinh||'').toLowerCase().includes(q)||
        String(displayNgaySinh(hs.ngay_sinh)||'').toLowerCase().includes(q)||
        String(hs.so_dinh_danh||'').toLowerCase().includes(q)
      );
      currentPage=1;renderAllView();
    }
    function sortIcon(field){if(sortField!==field)return'';return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>';}
    function doSort(field){if(sortField===field)sortDir=-sortDir;else{sortField=field;sortDir=1;}renderAllView();}
    window.doSort=doSort;

    function renderAllView(){
      try{
        let data=lastFiltered||allData;
        if(sortField){
          data=[...data].sort((a,b)=>{
            let av=(a[sortField]||"").toString().toLowerCase(),bv=(b[sortField]||"").toString().toLowerCase();
            if(!isNaN(av)&&!isNaN(bv)){av=Number(av);bv=Number(bv);}
            if(av<bv)return -sortDir;if(av>bv)return sortDir;return 0;
          });
        }
        totalRecords=data.length;totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));
        document.getElementById('total-hs').innerText=`(${totalRecords} hồ sơ)`;
        const start=(currentPage-1)*pageSize;
        renderTable(data.slice(start,start+pageSize));
        renderPagination();
      }catch(e){console.error(logPrefix,'renderAllView error',e);}
    }
    function renderPagination(){
      const el=document.getElementById('pagination');el.innerHTML='';
      if(totalPages<=1)return;
      el.innerHTML+=`<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP=Math.max(1,currentPage-2),maxP=Math.min(totalPages,currentPage+2);
      if(minP>1)el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if(minP>2)el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for(let p=minP;p<=maxP;p++)el.innerHTML+=`<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      if(maxP<totalPages-1)el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if(maxP<totalPages)el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML+=`<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    function gotoPage(p){if(p<1||p>totalPages||p===currentPage)return;currentPage=p;renderAllView();}
    window.gotoPage=gotoPage;

    /* ====== Table ====== */
    function renderTable(ds){
      if(!ds||ds.length===0){
        document.getElementById('ds-container').innerHTML=`<div class='text-center text-secondary mt-4'>Không có hồ sơ.</div>`;
        return;
      }
      let html=`<table class="table table-bordered table-hs align-middle"><thead>
        <tr>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('trang_thai')">Trạng thái${sortIcon('trang_thai')}</th>
          <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh${sortIcon('so_dinh_danh')}</th>
        </tr></thead><tbody>`;
      ds.forEach(row=>{
        const st = String(row.trang_thai||'').replace(/^'/,'').trim(); // 0 chờ duyệt, 1 kích hoạt, ...
        const canViewCard = st==='1' && String(row.so_ho_so||'').replace(/^'/,'').trim()!=='';
        html+=`<tr>
          <td>
            <div class="action-btns">
              <button class="btn btn-${canViewCard?'success':'secondary'} btn-sm" ${canViewCard?'':'disabled'} onclick="xemThe('${row.so_dinh_danh||''}')">Xem thẻ</button>
              <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.so_dinh_danh||''}')">In phiếu thu</button>
            </div>
          </td>
          <td>${renderTrangThai(st,row.so_ho_so)}</td>
          <td>${row.ho_ten_hoc_sinh||''}</td>
          <td>${displayNgaySinh(row.ngay_sinh||'')}</td>
          <td>${row.so_dinh_danh||''}</td>
        </tr>`;
      });
      html+=`</tbody></table>`;
      document.getElementById('ds-container').innerHTML=html;
    }

    function renderTrangThai(st, sohoso){
      if(st==='1') return `Đã kích hoạt<br><small class="text-muted">${sohoso||''}</small>`;
      if(st==='0') return `Chờ duyệt`;
      return st||'—';
    }

    /* ====== XEM THẺ ====== */
    function numberToVND(n){n=Number(String(n||0).replace(/[^\d.-]/g,''))||0;return n.toLocaleString('vi-VN');}

    async function xemThe(so_dinh_danh){
      try{
        showLoading();
        const hsRes=await getHosoBHTNByHS(so_dinh_danh,user.ma_truong,user.lop_hoc);
        if(!hsRes?.success||!hsRes.data){hideLoading();return;}
        const r=hsRes.data;
        // Fill fields
        document.getElementById('c-doituong').innerText = r.doi_tuong_dong || 'Học sinh';
        document.getElementById('c-gioitinh').innerText = r.gioi_tinh || '—';
        document.getElementById('c-sothe').innerText   = r.ma_so_bhtn || '—';        // (1) số thẻ = ma_so_bhtn
        document.getElementById('c-lop').innerText     = r.lop_hoc || user.lop_hoc || '—';
        document.getElementById('c-hoten').innerText   = r.ho_ten_hoc_sinh || '—';
        document.getElementById('c-sotien').innerText  = numberToVND(r.so_tien);
        document.getElementById('c-ngaysinh').innerText= displayNgaySinh(r.ngay_sinh||'');
        // Tính ngày sử dụng/ hết hạn từ dữ liệu lớp DanhSach_Hocsinh nếu có:
        const startEnd = calcRangeFromOldEnd(r.ngay_het_han_bhtn_cu);
        document.getElementById('c-begin').innerText = startEnd.startText;
        document.getElementById('c-end').innerText   = startEnd.endText;

        document.getElementById('c-diachi').innerText = r.dia_chi || '—';
        document.getElementById('c-phone').innerText  = r.sdt_lienhe || '—';
        document.getElementById('c-cha_me').innerText = r.ten_cha_me || '—';
        document.getElementById('c-class-big').innerText = (r.lop_hoc || user.lop_hoc || '').toUpperCase();
        document.getElementById('c-sohoso').innerText = r.so_ho_so || '—';            // (2) ô vàng = số hồ sơ

        // QR bottom-right
        const qrBox=document.getElementById('c-qr'); qrBox.innerHTML='';
        const payload = `SOTHE=${(r.ma_so_bhtn||'').slice(0,40)};S=${(user.ten_truong||'').slice(0,40)};L=${(r.lop_hoc||'').slice(0,12)};N=${(r.ho_ten_hoc_sinh||'').slice(0,40)};E=${(startEnd.endText||'').slice(0,10)}`;
        new QRCode(qrBox,{text:payload,width:110,height:110,correctLevel:QRCode.CorrectLevel.L});

        new bootstrap.Modal(document.getElementById('modalTheBHTN')).show();
      }catch(e){console.error('xemThe error',e);}
      finally{hideLoading();}
    }

    function calcRangeFromOldEnd(oldEndStr){
      const od=parseVNDate(oldEndStr);
      if(!od) return {startText:'—',endText:'—'};
      const start=addDaysExact(od,1);
      const end=new Date(start.getFullYear(),start.getMonth()+12,0);
      return {startText:formatVNDate(start), endText:formatVNDate(end)};
    }

    async function saveCardImage(){
      try{
        const node=document.getElementById('bhtnCard');
        const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff',useCORS:true,allowTaint:true});
        const dataURL=canvas.toDataURL('image/png');
        const link=document.createElement('a');
        link.href=dataURL; link.download='the-bhtn.png';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      }catch(e){alert('Không thể lưu ảnh thẻ: '+(e.message||e));}
    }

    /* ====== PHIẾU THU ====== */
    function numberToVietnamese(n){
      const VI=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
      function triple(num){let tr=Math.floor(num/100),ch=Math.floor((num%100)/10),dv=num%10,s="";
        if(tr>0){s+=VI[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ";}
        if(ch>1){s+=(s?" ":"")+VI[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI[dv];}
        else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI[dv];}
        else if(ch==0&&dv>0){s+=(s?" ":"")+VI[dv];}
        return s.trim();
      }
      n=Math.round(Number(n)||0); if(n===0) return "Không đồng";
      const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";
      while(n>0&&i<units.length){const b=n%1000;if(b>0){const part=triple(b);str=part+units[i]+(str?" "+str:"");}n=Math.floor(n/1000);i++;}
      return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();
    }
    function calcRangeBHTN(oldEndStr){
      const od=parseVNDate(oldEndStr); if(!od) return {startText:"—",endText:"(không xác định)"};
      const start=addDaysExact(od,1); const end=new Date(start.getFullYear(),start.getMonth()+12,0);
      return {startText:formatVNDate(start), endText:formatVNDate(end)};
    }
    function stripVN(str){return String(str||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase();}
    async function getTenTruong(ma_truong){
      try{const url=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;
        const res=await fetch(url);const j=await res.json();
        return j?.ten_truong||j?.data?.ten_truong||user.ten_truong||ma_truong||'—';
      }catch(e){return user.ten_truong||ma_truong||'—';}
    }

    async function inPhieuThu(so_dinh_danh){
      try{
        showLoading();
        const hs = (lastFiltered||allData).find(x=>String(x.so_dinh_danh)===String(so_dinh_danh));
        if(!hs){hideLoading();return;}
        const hoSo = await getHosoBHTNByHS(so_dinh_danh,user.ma_truong,hs.lop_hoc||user.lop_hoc);
        if(!hoSo?.success||!hoSo.data){hideLoading();return;}

        const months = 12;
        const amount = parseInt(String(hoSo.data.so_tien||"0").replace(/[^\d]/g,''),10)||0;
        const { startText, endText } = calcRangeBHTN(hs.ngay_het_han_bhtn||hoSo.data.ngay_het_han_bhtn_cu);
        const schoolName = await getTenTruong(user.ma_truong);
        const classCode = hoSo.data.lop_hoc || hs.lop_hoc || (user.lop_hoc || "");
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText = schoolName;
        document.getElementById('rec-class').innerText = classCode;
        document.getElementById('rec-date-today').innerText = todayText();
        document.getElementById('rec-student-name').innerText = hoSo.data.ho_ten_hoc_sinh || hs.ho_ten_hoc_sinh || "";
        document.getElementById('rec-address').innerText = hoSo.data.dia_chi || hs.dia_chi || "";
        document.getElementById('rec-content').innerText = `Thu tiền BHTN - ${classCode}`;
        document.getElementById('rec-months').innerText = String(months);
        document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText = teacherName;

        const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const payload = `MT=${String(user.ma_truong).slice(0,24)};S=${stripVN(schoolName).slice(0,60)};L=${String(classCode).slice(0,12)};N=${stripVN(hoSo.data.ho_ten_hoc_sinh||hs.ho_ten_hoc_sinh||"").slice(0,60)};M=${months};E=${endText}`;
        try{ new QRCode(qrBox,{text:payload,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
        catch(e){ const fb=`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hoSo.data.ho_ten_hoc_sinh||hs.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
          try{ new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
          catch(e2){ qrBox.innerHTML='<small>QR lỗi</small>'; }
        }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(e){console.error('inPhieuThu error',e);}
      finally{hideLoading();}
    }

    /* In đúng nội dung phiếu thu trong modal – in trong cùng cửa sổ, không mở tab mới */
    function getReceiptPrintCSS(){
      return `
        <style>
          @page{size:A5 portrait;margin:10mm}
          html,body{background:#fff;margin:0;padding:0}
          .a5-paper{width:148mm;min-height:210mm;background:#fff;color:#000;margin:0 auto;padding:10mm 12mm;line-height:1.35;font-size:13px}
          .receipt-title{font-weight:700;font-size:20px;text-transform:uppercase;letter-spacing:.4px}
          .receipt-sub{font-style:italic}
          .receipt-meta{font-size:13px}
          .receipt-line{margin:2mm 0}
          .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
          .sign-col{text-align:center;margin-top:10mm;font-weight:500}
          .sign-name{margin-top:20mm;text-align:center;font-weight:600}
          .row{display:flex;flex-wrap:nowrap;width:100%}
          .col{flex:1 1 0}
          .text-center{text-align:center}
        </style>`;
    }
    function printReceiptOnly(){
      const container=document.getElementById('receiptA5');
      if(!container) return;
      const iframe=document.createElement('iframe');
      iframe.style.position='fixed';iframe.style.right='0';iframe.style.bottom='0';
      iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';
      document.body.appendChild(iframe);
      const doc=iframe.contentWindow.document;
      doc.open();
      doc.write(`<!doctype html><html><head><meta charset="utf-8">${getReceiptPrintCSS()}</head><body>${container.outerHTML}</body></html>`);
      doc.close();
      iframe.onload=()=>{ setTimeout(()=>{ iframe.contentWindow.focus(); iframe.contentWindow.print(); setTimeout(()=>document.body.removeChild(iframe), 500); }, 50); };
    }

    /* ====== Toast ====== */
    function showToast(msg){
      document.getElementById('toast-message').innerText=msg;
      bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show();
    }

    /* ====== Boot ====== */
    window.onload=fetchDaThu;
  </script>
</body>
</html>
