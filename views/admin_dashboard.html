<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard – ABT Medu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{
      --sidebar-w: 260px;
      --brand: #0d47a1;
      --brand-2: #2563eb;
      --muted: #6b7280;
      --card-radius: 14px;
    }
    body{ background:#f5f7fb; min-height:100vh; overflow-x:hidden; }

    /* ===== Layout ===== */
    .app{ display:flex; min-height:100vh; width:100%; }

    /* ===== Sidebar (match superadmin) ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(180deg, #0d47a1, #1e3a8a 60%, #0f172a); color:#fff; padding:16px 14px; position:sticky; top:0; height:100vh; }
    .brand{ display:flex; gap:10px; align-items:center; padding:10px 10px 18px 6px; border-bottom:1px solid rgba(255,255,255,.12); margin-bottom:8px; }
    .brand .logo{ width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; font-size:22px; }
    .brand .name{ font-weight:800; letter-spacing:.3px; line-height:1.1 }
    .nav-section{ margin-top:10px; }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; color:#dbeafe; text-decoration:none; margin:4px 0; cursor:pointer; }
    .nav-item:hover{ background:rgba(255,255,255,.08); color:#fff; }
    .nav-item.active{ background:rgba(59,130,246,.35); color:#fff; }
    .nav-item .bi{ font-size:18px; width:22px; text-align:center; }

    /* ===== Content ===== */
    .content{ flex:1; padding:18px; max-width:1600px; margin:0 auto; }
    .page-title{ font-weight:800; letter-spacing:.3px; color:#0f172a; }
    .sub-muted{ color:var(--muted); }

    /* ===== Cards / KPI ===== */
    .kpi-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .kpi-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .kpi-card .icon{ width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:26px; flex:0 0 auto; }
    .kpi-card .val{ font-size:28px; font-weight:900; line-height:1; }
    .kpi-card .lbl{ font-size:13px; color:#334155; margin-top:2px; }
    .ic-emerald{ background:#10b981; }
    .ic-indigo{ background:#6366f1; }
    .ic-orange{ background:#f59e0b; }
    .ic-blue{ background:#2563eb; }
    @media (min-width: 576px){ .kpi-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .kpi-card{ grid-column: span 3; } }

    /* ===== Panels & Tables ===== */
    .panel{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .table-box{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .table thead th{ background:#f1f5f9; font-weight:700; }
    .rank-num{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; font-weight:800; border-radius:999px; color:#0f172a; background:#e2e8f0; }
    .rank-1{ background:#fde047; }
    .rank-2{ background:#d1d5db; }
    .rank-3{ background:#f59e0b; color:#fff; }

    /* ===== User overview ===== */
    .user-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .user-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .user-card .icon{ width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:22px; }
    .uc-all .icon{ background:#0ea5e9; }
    .uc-admin .icon{ background:#f97316; }
    .uc-teacher .icon{ background:#22c55e; }
    .uc-parent .icon{ background:#06b6d4; }
    .user-card .val{ font-weight:800; font-size:22px; }
    .user-card .lbl{ color:#334155; font-size:13px; }
    @media (min-width: 576px){ .user-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .user-card{ grid-column: span 3; } }

    /* ===== Top split ===== */
    .top-split{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 1200px){ .top-split{ grid-template-columns: 2fr 1fr; } }

    /* ===== Responsive sidebar ===== */
    .toggle-btn{ display:none; }
    @media (max-width: 991px){
      .sidebar{ position:fixed; left:-100%; z-index:1045; transition:left .25s ease; }
      .sidebar.show{ left:0; }
      .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
      .backdrop.show{ display:block; }
      .toggle-btn{ display:inline-flex; }
    }

    /* Loading overlay */
    #loadingSpinner{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(255,255,255,.6); backdrop-filter: blur(1px); align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="brand mb-3">
        <div class="logo"><i class="bi bi-shield-check"></i></div>
        <div>
          <div class="name">ABT Medu</div>
          <div class="small" style="opacity:.8">Admin trường</div>
        </div>
      </div>

      <div class="nav-section" id="sidebarMenu">
        <div class="nav-item active" data-page="overview"><i class="bi bi-speedometer2"></i><span>Tổng quan</span></div>
        <div class="nav-item" data-page="students"><i class="bi bi-people"></i><span>Danh sách học sinh</span></div>
        <div class="nav-item" data-page="teachers"><i class="bi bi-person-badge"></i><span>Danh sách giáo viên</span></div>
        <div class="nav-item" data-page="bhyt"><i class="bi bi-hospital"></i><span>Bảo hiểm y tế</span></div>
        <div class="nav-item" data-page="bhtn"><i class="bi bi-heart-pulse"></i><span>Bảo Hiểm Tai Nạn</span></div>
        <div class="nav-item" data-page="stats"><i class="bi bi-bar-chart"></i><span>Thống kê</span></div>
        <div class="nav-item" data-page="rewards"><i class="bi bi-cash-coin"></i><span>Thù lao</span></div>
        <div class="nav-item" data-page="profile"><i class="bi bi-person-badge"></i><span>Cá nhân</span></div>
        <div class="nav-item" data-page="settings"><i class="bi bi-gear-wide-connected"></i><span>Cài đặt</span></div>
        <div class="nav-item" id="btnLogout"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></div>
      </div>
    </aside>

    <div class="backdrop" id="backdrop"></div>

    <!-- Content -->
    <main class="content w-100">
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <div class="page-title h4 mb-1">Bảng điều khiển – <span id="schoolName">Trường ...</span></div>
          <div class="sub-muted">Người dùng: <strong id="userName">—</strong> • Quyền: <span id="userRole">admin</span></div>
        </div>
      </div>

      <!-- OVERVIEW PAGE (default) -->
      <section id="page-overview">
        <!-- Top split: KPIs + Filters -->
        <div class="top-split mb-3">
          <!-- Left: KPIs (5 cards) -->
          <div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="icon ic-emerald"><i class="bi bi-people"></i></div>
                <div>
                  <div class="val" id="kpiStudents">0</div>
                  <div class="lbl">Tổng số học sinh</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-indigo"><i class="bi bi-hospital"></i></div>
                <div>
                  <div class="val" id="kpiBHYTCount">0</div>
                  <div class="lbl">Tổng số BHYT đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-orange"><i class="bi bi-heart-pulse"></i></div>
                <div>
                  <div class="val" id="kpiBHTNCount">0</div>
                  <div class="lbl">Tổng số BHTN đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer2"></i></div>
                <div>
                  <div class="val" id="progressBHYTText">0%</div>
                  <div class="lbl">Tiến độ thu BHYT</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                <div>
                  <div class="val" id="progressBHTNTextCard">0%</div>
                  <div class="lbl">Tiến độ thu BHTN</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Filters only -->
          <div class="panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">Bộ lọc dữ liệu</div>
              <small class="text-secondary">Áp dụng cho bảng xếp hạng</small>
            </div>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="filterScope" style="width:auto">
                <option value="school" selected>Cả trường</option>
                <option value="class">Theo lớp</option>
              </select>
              <select class="form-select form-select-sm d-none" id="filterClass" style="width:auto"></select>
            </div>
          </div>
        </div>

        <!-- Rankings -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-primary">BHYT</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHYT"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-warning">BHTN</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHTN"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Users overview -->
        <div class="mt-3">
          <div class="fw-bold mb-2">Tổng quan người dùng</div>
          <div class="user-grid">
            <div class="user-card uc-all">
              <div class="icon"><i class="bi bi-people-fill"></i></div>
              <div>
                <div class="val" id="uAll">0</div>
                <div class="lbl">Tổng user của trường</div>
              </div>
            </div>
            <div class="user-card uc-admin">
              <div class="icon"><i class="bi bi-building-gear"></i></div>
              <div>
                <div class="val" id="uAdmin">0</div>
                <div class="lbl">Số Admin trường</div>
              </div>
            </div>
            <div class="user-card uc-teacher">
              <div class="icon"><i class="bi bi-mortarboard"></i></div>
              <div>
                <div class="val" id="uTeacher">0</div>
                <div class="lbl">Số giáo viên</div>
              </div>
            </div>
            <div class="user-card uc-parent">
              <div class="icon"><i class="bi bi-person-heart"></i></div>
              <div>
                <div class="val" id="uParent">0</div>
                <div class="lbl">Số phụ huynh</div>
              </div>
            </div>
            <div class="user-card">
              <div class="icon" style="background:#22c55e;"><i class="bi bi-emoji-smile"></i></div>
              <div>
                <div class="val" id="uStudent">0</div>
                <div class="lbl">Số học sinh</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Placeholder other pages (hidden by default) -->
      <section id="page-students" class="d-none">
      <h4 class="page-title mb-3">Danh sách học sinh</h4>

      <!-- Bộ lọc -->
      <div class="row g-2 mb-2">
        <div class="col-sm-3">
          <input class="form-control" id="ad-filter-ma-truong" placeholder="Mã trường (để trống = tất cả)">
        </div>
        <div class="col-sm-3">
          <input class="form-control" id="ad-filter-lop" placeholder="Lớp (để trống = tất cả)">
        </div>
        <div class="col-sm-6 d-flex gap-2">
          <input class="form-control" id="ad-search-box" placeholder="Tìm theo tên, mã BHXH, số định danh…">
          <button class="btn btn-primary" id="ad-btn-refresh">Tải lại</button>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ad-modalThemHS">Thêm học sinh</button>
          <button class="btn btn-danger d-none" id="ad-btn-delete-multi">Xóa đã chọn</button>
        </div>
      </div>

      <!-- Bảng -->
      <div class="table-responsive table-box">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:34px;"><input type="checkbox" id="ad-chk-all"></th>
              <th>STT</th>
              <th>MS BHXH</th>
              <th>Họ tên</th>
              <th>Ngày sinh</th>
              <th>Giới tính</th>
              <th>Lớp</th>
              <th>Số định danh</th>
              <th>SĐT</th>
              <th>Mã trường</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="ad-tbody"></tbody>
        </table>
      </div>

      <nav class="mt-3">
        <ul class="pagination justify-content-center" id="ad-pagination"></ul>
      </nav>
    </section>

      <section id="page-teachers" class="d-none">
        <div class="panel"><div>Danh sách giáo viên (đang phát triển).</div></div>
      </section>
      <section id="page-bhyt" class="d-none">
        <div class="panel"><div>Đi tới <a href="bhyt_giaovien.html">BHYT</a> / <a href="bhyt.html">BHYT (menu chung)</a>.</div></div>
      </section>
      <section id="page-bhtn" class="d-none">
        <div class="panel"><div>Đi tới <a href="bhtn_giaovien.html">BHTN</a>.</div></div>
      </section>
      <section id="page-stats" class="d-none"><div class="panel"><div>Trang thống kê nâng cao (đang phát triển).</div></div></section>
      <section id="page-rewards" class="d-none"><div class="panel"><div>Trang thù lao (đang phát triển).</div></div></section>
      <section id="page-profile" class="d-none"><div class="panel"><div>Thông tin cá nhân (đang phát triển).</div></div></section>
      <section id="page-settings" class="d-none"><div class="panel"><div> Cài đặt (đang phát triển).</div></div></section>

    </main>
  </div>





  <!-- Modal: Thêm học sinh -->
<div class="modal fade" id="ad-modalThemHS" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Thêm học sinh</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="ad-form-themhs" onsubmit="event.preventDefault();AD_handleThemHS();">
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">MS BHXH</label><input class="form-control" id="ad-inp-msbhxh"></div>
          <div class="col-sm-6"><label class="form-label">Họ tên</label><input class="form-control" id="ad-inp-hoten"></div>
          <div class="col-sm-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="ad-inp-ngaysinh" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-4"><label class="form-label d-block">Giới tính</label>
            <div class="d-flex gap-3">
              <label class="form-check"><input class="form-check-input" type="radio" name="ad-gt" value="Nam" checked> Nam</label>
              <label class="form-check"><input class="form-check-input" type="radio" name="ad-gt" value="Nữ"> Nữ</label>
            </div>
          </div>
          <div class="col-sm-4"><label class="form-label">Lớp</label><input class="form-control" id="ad-inp-lop"></div>
          <div class="col-sm-6"><label class="form-label">Địa chỉ</label><input class="form-control" id="ad-inp-diachi"></div>
          <div class="col-sm-6"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="ad-inp-sdt"></div>
          <div class="col-sm-6"><label class="form-label">Số định danh</label><input class="form-control" id="ad-inp-sdd"></div>
          <div class="col-sm-6"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="ad-inp-cha-me"></div>
          <div class="col-sm-6"><label class="form-label">Hạn BHYT</label><input class="form-control" id="ad-inp-han-bhyt" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-6"><label class="form-label">Hạn BHTN</label><input class="form-control" id="ad-inp-han-bhtn" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-6"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="ad-inp-noikham"></div>
          <div class="col-sm-6"><label class="form-label">Đối tượng đóng</label><input class="form-control" id="ad-inp-doituong"></div>
          <div class="col-12"><label class="form-label">Ghi chú</label><input class="form-control" id="ad-inp-ghichu"></div>
          <div class="col-sm-6"><label class="form-label">Mã trường</label><input class="form-control" id="ad-inp-ma-truong"></div>
        </div>
      </form>
      <div id="ad-themhs-error" class="text-danger mt-2" style="min-height:18px"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      <button class="btn btn-primary" onclick="AD_handleThemHS()">Thêm</button>
    </div>
  </div></div>
</div>

<!-- Modal: Sửa học sinh -->
<div class="modal fade" id="ad-modalSuaHS" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Sửa học sinh</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="ad-form-suahs" onsubmit="event.preventDefault();AD_handleSuaHS();">
        <input type="hidden" id="ad-edit-stt">
        <div class="row g-2">
          <div class="col-sm-6"><label class="form-label">MS BHXH</label><input class="form-control" id="ad-edit-msbhxh"></div>
          <div class="col-sm-6"><label class="form-label">Họ tên</label><input class="form-control" id="ad-edit-hoten"></div>
          <div class="col-sm-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="ad-edit-ngaysinh" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-4"><label class="form-label d-block">Giới tính</label>
            <div class="d-flex gap-3">
              <label class="form-check"><input class="form-check-input" type="radio" name="ad-edit-gt" value="Nam"> Nam</label>
              <label class="form-check"><input class="form-check-input" type="radio" name="ad-edit-gt" value="Nữ"> Nữ</label>
            </div>
          </div>
          <div class="col-sm-4"><label class="form-label">Lớp</label><input class="form-control" id="ad-edit-lop"></div>
          <div class="col-sm-6"><label class="form-label">Địa chỉ</label><input class="form-control" id="ad-edit-diachi"></div>
          <div class="col-sm-6"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="ad-edit-sdt"></div>
          <div class="col-sm-6"><label class="form-label">Số định danh</label><input class="form-control" id="ad-edit-sdd"></div>
          <div class="col-sm-6"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="ad-edit-cha-me"></div>
          <div class="col-sm-6"><label class="form-label">Hạn BHYT</label><input class="form-control" id="ad-edit-han-bhyt" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-6"><label class="form-label">Hạn BHTN</label><input class="form-control" id="ad-edit-han-bhtn" placeholder="dd/mm/yyyy" autocomplete="off"></div>
          <div class="col-sm-6"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="ad-edit-noikham"></div>
          <div class="col-sm-6"><label class="form-label">Đối tượng đóng</label><input class="form-control" id="ad-edit-doituong"></div>
          <div class="col-12"><label class="form-label">Ghi chú</label><input class="form-control" id="ad-edit-ghichu"></div>
          <div class="col-sm-6"><label class="form-label">Mã trường</label><input class="form-control" id="ad-edit-ma-truong"></div>
        </div>
      </form>
      <div id="ad-suahs-error" class="text-danger mt-2" style="min-height:18px"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      <button class="btn btn-primary" onclick="AD_handleSuaHS()">Lưu</button>
    </div>
  </div></div>
</div>




  <!-- Loading -->
  <div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/api.js"></script>


  <script>
  // === Utilities ===
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  function ensureLoggedInAsAdmin() {
    const raw = localStorage.getItem('user');
    if (!raw) { window.location.href = '../index.html'; return null; }
    let user; try { user = JSON.parse(raw); } catch(e){ localStorage.removeItem('user'); window.location.href='../index.html'; return null; }
    const role = String(user.phan_quyen||'').toLowerCase();
    if (!(role === 'admin' || role === 'super_admin' || role === 'superadmin')) {
      alert('Bạn không có quyền truy cập trang này.');
      window.location.href = '../index.html';
      return null;
    }
    return user;
  }

  function setActivePage(page){
    $$('#sidebarMenu .nav-item').forEach(el=> el.classList.toggle('active', el.dataset.page === page));
    $$('[id^="page-"]').forEach(sec => sec.classList.add('d-none'));
    $(`#page-${page}`)?.classList.remove('d-none');
  }

  function toggleSidebar(open){
    const sb = $('#sidebar');
    const bd = $('#backdrop');
    const willOpen = open ?? !sb.classList.contains('show');
    sb.classList.toggle('show', willOpen);
    bd.classList.toggle('show', willOpen);
  }

  function showLoading(){ $('#loadingSpinner').style.display='flex'; }
  function hideLoading(){ $('#loadingSpinner').style.display='none'; }

  // === State for filters ===
  let STATE = { students: [], bhytPaid: [], bhtnPaid: [] };
  function applyFilters(){
    const scope = $('#filterScope')?.value || 'school';
    const cls = ($('#filterClass')?.value || '').trim();
    let students = STATE.students;
    let bhyt = STATE.bhytPaid;
    let bhtn = STATE.bhtnPaid;
    if (scope === 'class' && cls){
      const byCls = r => String(r.lop_hoc||'').trim() === cls;
      students = students.filter(byCls);
      bhyt = bhyt.filter(byCls);
      bhtn = bhtn.filter(byCls);
    }
    renderRanking('#rankBHYT', buildClassRanking(students, bhyt));
    renderRanking('#rankBHTN', buildClassRanking(students, bhtn));
  }

  // === API helpers (use functions from ../js/api.js) ===
  async function listUsers(){
    try{
      const url = `${API_BASE}?func=ListUsers`;
      const res = await fetch(url);
      return await res.json();
    }catch(e){ return { success:false, data:[] }; }
  }
  async function countStudentsBySchool(ma_truong){
    const resp = await getAllDanhSachHocsinh(ma_truong||'', '');
    const arr = Array.isArray(resp?.data) ? resp.data : [];
    return { total: arr.length, rows: arr };
  }
  async function fetchBHYT(ma_truong){
    const resp = await getDanhSachBHYT(ma_truong||'', '');
    return Array.isArray(resp?.data) ? resp.data : [];
  }
  async function fetchBHTN(ma_truong){
    try{ const resp = await getDanhSachBHTN(ma_truong||'', ''); return Array.isArray(resp?.data) ? resp.data : []; }
    catch(e){ return []; }
  }

  // === Rendering ===
  function renderKPIs(studentsTotal, bhytPaidCount, bhtnPaidCount){
    $('#kpiStudents').textContent = studentsTotal.toLocaleString('vi-VN');
    $('#kpiBHYTCount').textContent = bhytPaidCount.toLocaleString('vi-VN');
    $('#kpiBHTNCount').textContent = bhtnPaidCount.toLocaleString('vi-VN');
    const rateBHYT = studentsTotal ? Math.round(bhytPaidCount * 100 / studentsTotal) : 0;
    const rateBHTN = studentsTotal ? Math.round(bhtnPaidCount * 100 / studentsTotal) : 0;
    $('#progressBHYTText').textContent = rateBHYT + '%';
    $('#progressBHTNTextCard').textContent = rateBHTN + '%';
  }

  function renderRanking(tbodySel, items){
    const tbody = $(tbodySel);
    if (!tbody) return;
    const rows = items.map((r,i)=>{
      const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
      return `<tr>
        <td><span class="rank-num ${rankCls}">${i+1}</span></td>
        <td>${r.cls}</td>
        <td class="text-end">${r.done}</td>
        <td class="text-end">${r.total}</td>
        <td class="text-end fw-bold">${r.pct}%</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="5" class="text-center text-secondary">Không có dữ liệu</td></tr>`;
  }

  function buildClassRanking(students, paidRows){
    const totalByClass = students.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    const paidByClass = paidRows.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    return Object.entries(totalByClass).map(([cls,total])=>{ const done = paidByClass[cls]||0; const pct = total? Math.round(done*100/total):0; return { cls, done, total, pct }; })
      .sort((a,b)=> b.pct - a.pct || b.done - a.done || a.cls.localeCompare(b.cls));
  }

  function wireSidebar(){
    setActivePage('overview');
    $$('#sidebarMenu .nav-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        const page = item.dataset.page; if (!page) return; setActivePage(page);
      });
    });
    $('#btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); window.location.href = '../index.html'; });
    $('#btnToggleSidebar')?.addEventListener('click', ()=> toggleSidebar(true));
    $('#backdrop')?.addEventListener('click', ()=> toggleSidebar(false));
    $('#filterScope').addEventListener('change', (e)=>{
      const v = e.target.value; const clsSel = $('#filterClass');
      clsSel.classList.toggle('d-none', v !== 'class');
      if (v !== 'class') clsSel.value = '';
      applyFilters();
    });
    $('#filterClass').addEventListener('change', applyFilters);
  }

  // === Boot ===
  (async function init(){
    const user = ensureLoggedInAsAdmin(); if (!user) return;
    $('#userName').textContent = user.ho_ten||user.sdt||'Admin';
    $('#userRole').textContent = user.phan_quyen||'admin';
    $('#schoolName').textContent = user.ten_truong || (user.ma_truong||'');

    wireSidebar();
    setActivePage('overview');

    try{
      showLoading();
      const ma_truong = (user.ma_truong||'').trim();

      const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
        countStudentsBySchool(ma_truong),
        fetchBHYT(ma_truong),
        fetchBHTN(ma_truong)
      ]);

      const isPaid = r => { const so_tien = Number(String(r.so_tien||'').replaceAll(',','')); const trang_thai = String(r.trang_thai ?? ''); const so_ho_so = String(r.so_ho_so||''); return so_tien>0 || trang_thai==='1' || !!so_ho_so; };
      const bhytPaid = bhytRows.filter(isPaid);
      const bhtnPaid = bhtnRows.filter(isPaid);

      renderKPIs(studentsTotal, bhytPaid.length, bhtnPaid.length);

      const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
      const sel = $('#filterClass');
      sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

      STATE = { students, bhytPaid, bhtnPaid };
      applyFilters();

      // Users overview
      try{
        const rs = await listUsers();
        const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
        const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
        const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
        const parentCount = uSchool.filter(u => {
          const r = String(u.phan_quyen||'').trim().toLowerCase();
          return r === 'phu_huynh' || r === 'user';
        }).length;
        $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
        $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
        $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
        $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      } catch(e){
        $('#uAll').textContent = '-';
        $('#uAdmin').textContent = '-';
        $('#uTeacher').textContent = '-';
        $('#uParent').textContent = '-';
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      }

    } catch(err){
      console.error(err);
      alert('Không tải được dữ liệu tổng quan. Vui lòng kiểm tra API_BASE trong js/api.js');
    } finally{
      hideLoading();
    }
  })();
</script>




<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
(() => {
  // ===== Phân quyền: chỉ admin/super_admin =====
  const user = JSON.parse(localStorage.getItem("user") || "{}");
  const role = String(user.phan_quyen || "").toLowerCase();
  if (!user.sdt || (role !== "admin" && role !== "super_admin")) {
    window.location.href = "../index.html";
    return;
  }

  // ====== State ======
  let AD_STATE = {
    ma_truong: "", lop_hoc: "",
    page: 0, limit: 10, total: 0,
    sortField: "", sortDir: 1,
    query: "",
    selected: new Set()
  };

  // ====== Elements ======
  const $ = (s, p=document) => p.querySelector(s);
  const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
  const viewHS = $("#view-hocsinh");
  const navHS = $("#nav-hocsinh");

  // ====== Active nav -> show panel ======
  navHS?.addEventListener("click", () => {
    // deactivate others
    $$(".nav-item").forEach(n => n.classList.remove("active"));
    navHS.classList.add("active");
    // hide other sections
    $$("section[id^='view-']").forEach(sec => sec.classList.add("d-none"));
    viewHS.classList.remove("d-none");
    AD_initOnce();
  });

  // ====== One-time init for HS panel ======
  let inited = false;
  function AD_initOnce(){
    if (inited) return;
    inited = true;

    // Date pickers
    flatpickr("#ad-inp-ngaysinh", {dateFormat:"d/m/Y"});
    flatpickr("#ad-inp-han-bhyt", {dateFormat:"d/m/Y"});
    flatpickr("#ad-inp-han-bhtn", {dateFormat:"d/m/Y"});
    flatpickr("#ad-edit-ngaysinh", {dateFormat:"d/m/Y"});
    flatpickr("#ad-edit-han-bhyt", {dateFormat:"d/m/Y"});
    flatpickr("#ad-edit-han-bhtn", {dateFormat:"d/m/Y"});

    // Bind filters/search/paging
    $("#ad-filter-ma-truong").addEventListener("input", e => { AD_STATE.ma_truong = e.target.value.trim(); AD_reload(true); });
    $("#ad-filter-lop").addEventListener("input", e => { AD_STATE.lop_hoc = e.target.value.trim(); AD_reload(true); });
    $("#ad-search-box").addEventListener("input", e => { AD_STATE.query = e.target.value.trim(); AD_reload(true); });
    $("#ad-btn-refresh").addEventListener("click", () => AD_reload(true));
    $("#ad-chk-all").addEventListener("change", e => {
      const checked = e.target.checked;
      $$("#ad-tbody input[type='checkbox']").forEach(ch => {
        ch.checked = checked;
        const id = ch.dataset.id;
        if (checked) AD_STATE.selected.add(id); else AD_STATE.selected.delete(id);
      });
      AD_toggleDeleteMulti();
    });

    // Sort handlers
    $$("#view-hocsinh th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        const f = th.dataset.field || "";
        if (AD_STATE.sortField === f) AD_STATE.sortDir = -AD_STATE.sortDir;
        else { AD_STATE.sortField = f; AD_STATE.sortDir = 1; }
        AD_reload(true);
      });
    });

    // Load first
    AD_reload(true);
  }

  function AD_toggleDeleteMulti(){
    const btn = $("#ad-btn-delete-multi");
    btn.classList.toggle("d-none", AD_STATE.selected.size === 0);
  }

  // ===== Render table =====
  function renderRows(items){
    const tbody = $("#ad-tbody");
    tbody.innerHTML = items.map(row => {
      const id = row.stt ?? row.so_dinh_danh ?? "";
      const gt = (row.gioi_tinh || "").toString();
      return `
        <tr>
          <td><input type="checkbox" data-id="${id}" onchange="AD_onSelectRow(this)"></td>
          <td>${row.stt ?? ""}</td>
          <td>${row.ma_so_bhxh ?? ""}</td>
          <td>${row.ho_ten_hoc_sinh ?? ""}</td>
          <td>${row.ngay_sinh ?? ""}</td>
          <td>${gt}</td>
          <td>${row.lop_hoc ?? ""}</td>
          <td>${row.so_dinh_danh ?? ""}</td>
          <td>${row.sdt_lienhe ?? ""}</td>
          <td>${row.ma_truong ?? ""}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary me-1" onclick='AD_openEdit(${JSON.stringify(row).replace(/'/g,"&#39;")})'>Sửa</button>
            <button class="btn btn-sm btn-outline-danger" onclick="AD_deleteOne('${id}')">Xóa</button>
          </td>
        </tr>`;
    }).join("");
    // row checkbox change (delegated)
    $$("#ad-tbody input[type='checkbox']").forEach(ch=>{
      ch.addEventListener("change", e=>{
        const id = e.target.dataset.id;
        if (e.target.checked) AD_STATE.selected.add(id);
        else AD_STATE.selected.delete(id);
        AD_toggleDeleteMulti();
      })
    });
  }

  // ===== Pagination =====
  function renderPagination(total, page, limit){
    const ul = $("#ad-pagination");
    const pages = Math.max(1, Math.ceil(total/limit));
    const btn = (p, label, disabled=false, active=false) =>
      `<li class="page-item ${disabled?'disabled':''} ${active?'active':''}">
        <a class="page-link" href="javascript:void(0)" data-p="${p}">${label}</a>
      </li>`;
    let html = "";
    html += btn(Math.max(0, page-1), "«", page===0);
    for(let i=0;i<pages;i++){
      if (i===0 || i===pages-1 || Math.abs(i-page)<=2){
        html += btn(i, (i+1), false, i===page);
      } else if (i===page-3 || i===page+3) {
        html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
      }
    }
    html += btn(Math.min(pages-1, page+1), "»", page>=pages-1);
    ul.innerHTML = html;
    $$("#ad-pagination a.page-link").forEach(a=>{
      a.addEventListener("click", e=>{
        const p = Number(a.dataset.p||0);
        AD_STATE.page = p;
        AD_reload(false);
      });
    });
  }

  // ===== Load data =====
  async function AD_reload(resetPage=false){
    if (resetPage) AD_STATE.page = 0;
    const start = AD_STATE.page * AD_STATE.limit;
    const res = await getDanhSachHocsinhPaginated(
      AD_STATE.ma_truong, AD_STATE.lop_hoc,
      start, AD_STATE.limit,
      AD_STATE.query, AD_STATE.sortField, AD_STATE.sortDir
    ); // dùng API sẵn có 

    if (!res || !res.success){
      $("#ad-tbody").innerHTML = `<tr><td colspan="11" class="text-danger">Không tải được dữ liệu.</td></tr>`;
      $("#ad-total-hs").textContent = "0";
      renderPagination(0, 0, AD_STATE.limit);
      return;
    }
    const items = res.data?.items || res.data || [];
    AD_STATE.total = res.data?.total ?? items.length ?? 0;

    $("#ad-total-hs").textContent = AD_STATE.total;
    $("#ad-lop-label").textContent = AD_STATE.lop_hoc || "tất cả";
    AD_STATE.selected.clear(); AD_toggleDeleteMulti();
    renderRows(items);
    renderPagination(AD_STATE.total, AD_STATE.page, AD_STATE.limit);
  }

  // ===== CRUD Helpers =====
  window.AD_onSelectRow = function(ch){ /* handled in renderRows */ };

  window.AD_openEdit = function(row){
    $("#ad-edit-stt").value = row.stt || "";
    $("#ad-edit-msbhxh").value = row.ma_so_bhxh || "";
    $("#ad-edit-hoten").value = row.ho_ten_hoc_sinh || "";
    $("#ad-edit-ngaysinh").value = row.ngay_sinh || "";
    $$("input[name='ad-edit-gt']").forEach(r => r.checked = (r.value === String(row.gioi_tinh||"")));
    $("#ad-edit-lop").value = row.lop_hoc || "";
    $("#ad-edit-diachi").value = row.dia_chi || "";
    $("#ad-edit-sdt").value = row.sdt_lienhe || "";
    $("#ad-edit-sdd").value = row.so_dinh_danh || "";
    $("#ad-edit-cha-me").value = row.ten_cha_me || "";
    $("#ad-edit-han-bhyt").value = row.ngay_het_han_bhyt || "";
    $("#ad-edit-han-bhtn").value = row.ngay_het_han_bhtn || "";
    $("#ad-edit-noikham").value = row.noi_kham_bhyt || "";
    $("#ad-edit-doituong").value = row.doi_tuong_dong || "";
    $("#ad-edit-ghichu").value = row.ghi_chu || "";
    $("#ad-edit-ma-truong").value = row.ma_truong || "";

    new bootstrap.Modal($("#ad-modalSuaHS")).show();
  };

  window.AD_deleteOne = async function(id){
    if (!confirm("Bạn chắc chắn muốn xóa dòng này?")) return;
    const r = await xoaHocsinh(id); // API có sẵn 
    if (!r || !r.success) { alert(r?.message || "Xóa thất bại"); return; }
    AD_reload(false);
  };

  $("#ad-btn-delete-multi").addEventListener("click", async ()=>{
    if (AD_STATE.selected.size===0) return;
    if (!confirm(`Xóa ${AD_STATE.selected.size} dòng đã chọn?`)) return;
    const ids = Array.from(AD_STATE.selected);
    const r = await xoaNhieuHocsinh(ids); // API có sẵn 
    if (!r || !r.success) { alert(r?.message || "Xóa nhiều thất bại"); return; }
    AD_reload(true);
  });

  window.AD_handleThemHS = async function(){
    const payload = {
      ma_so_bhxh: $("#ad-inp-msbhxh").value.trim(),
      ho_ten_hoc_sinh: $("#ad-inp-hoten").value.trim(),
      ngay_sinh: $("#ad-inp-ngaysinh").value.trim(),
      gioi_tinh: $$("input[name='ad-gt']:checked")[0]?.value || "",
      dia_chi: $("#ad-inp-diachi").value.trim(),
      ngay_het_han_bhyt: $("#ad-inp-han-bhyt").value.trim(),
      ngay_het_han_bhtn: $("#ad-inp-han-bhtn").value.trim(),
      lop_hoc: $("#ad-inp-lop").value.trim(),
      sdt_lienhe: $("#ad-inp-sdt").value.trim(),
      so_dinh_danh: $("#ad-inp-sdd").value.trim(),
      noi_kham_bhyt: $("#ad-inp-noikham").value.trim(),
      ten_cha_me: $("#ad-inp-cha-me").value.trim(),
      doi_tuong_dong: $("#ad-inp-doituong").value.trim(),
      ghi_chu: $("#ad-inp-ghichu").value.trim(),
      ma_truong: $("#ad-inp-ma-truong").value.trim() || $("#ad-filter-ma-truong").value.trim() || ""
    };
    const r = await themHocsinh(payload); // API có sẵn 
    if (!r || !r.success){ $("#ad-themhs-error").textContent = r?.message || "Thêm thất bại"; return; }
    $("#ad-themhs-error").textContent = "";
    bootstrap.Modal.getInstance($("#ad-modalThemHS")).hide();
    AD_reload(true);
  };

  window.AD_handleSuaHS = async function(){
    const payload = {
      stt: $("#ad-edit-stt").value,
      ma_so_bhxh: $("#ad-edit-msbhxh").value.trim(),
      ho_ten_hoc_sinh: $("#ad-edit-hoten").value.trim(),
      ngay_sinh: $("#ad-edit-ngaysinh").value.trim(),
      gioi_tinh: $$("input[name='ad-edit-gt']:checked")[0]?.value || "",
      dia_chi: $("#ad-edit-diachi").value.trim(),
      ngay_het_han_bhyt: $("#ad-edit-han-bhyt").value.trim(),
      ngay_het_han_bhtn: $("#ad-edit-han-bhtn").value.trim(),
      lop_hoc: $("#ad-edit-lop").value.trim(),
      sdt_lienhe: $("#ad-edit-sdt").value.trim(),
      so_dinh_danh: $("#ad-edit-sdd").value.trim(),
      noi_kham_bhyt: $("#ad-edit-noikham").value.trim(),
      ten_cha_me: $("#ad-edit-cha-me").value.trim(),
      doi_tuong_dong: $("#ad-edit-doituong").value.trim(),
      ghi_chu: $("#ad-edit-ghichu").value.trim(),
      ma_truong: $("#ad-edit-ma-truong").value.trim() || $("#ad-filter-ma-truong").value.trim() || ""
    };
    const r = await suaHocsinh(payload); // API có sẵn 
    if (!r || !r.success){ $("#ad-suahs-error").textContent = r?.message || "Cập nhật thất bại"; return; }
    $("#ad-suahs-error").textContent = "";
    bootstrap.Modal.getInstance($("#ad-modalSuaHS")).hide();
    AD_reload(false);
  };

})();
</script>

</body>
</html>
