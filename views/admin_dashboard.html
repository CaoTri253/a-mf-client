<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard – ABT Medu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{
      --sidebar-w: 260px;
      --brand: #0d47a1;
      --brand-2: #2563eb;
      --muted: #6b7280;
      --card-radius: 14px;
    }
    body{ background:#f5f7fb; min-height:100vh; overflow-x:hidden; }

    /* ===== Layout ===== */
    .app{ display:flex; min-height:100vh; width:100%; }

    /* ===== Sidebar (match superadmin) ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(180deg, #0d47a1, #1e3a8a 60%, #0f172a); color:#fff; padding:16px 14px; position:sticky; top:0; height:100vh; }
    .brand{ display:flex; gap:10px; align-items:center; padding:10px 10px 18px 6px; border-bottom:1px solid rgba(255,255,255,.12); margin-bottom:8px; }
    .brand .logo{ width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; font-size:22px; }
    .brand .name{ font-weight:800; letter-spacing:.3px; line-height:1.1 }
    .nav-section{ margin-top:10px; }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; color:#dbeafe; text-decoration:none; margin:4px 0; cursor:pointer; }
    .nav-item:hover{ background:rgba(255,255,255,.08); color:#fff; }
    .nav-item.active{ background:rgba(59,130,246,.35); color:#fff; }
    .nav-item .bi{ font-size:18px; width:22px; text-align:center; }

    /* ===== Content ===== */
    .content{ flex:1; padding:18px; max-width:1600px; margin:0 auto; }
    .page-title{ font-weight:800; letter-spacing:.3px; color:#0f172a; }
    .sub-muted{ color:var(--muted); }

    /* ===== Cards / KPI ===== */
    .kpi-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .kpi-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .kpi-card .icon{ width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:26px; flex:0 0 auto; }
    .kpi-card .val{ font-size:28px; font-weight:900; line-height:1; }
    .kpi-card .lbl{ font-size:13px; color:#334155; margin-top:2px; }
    .ic-emerald{ background:#10b981; }
    .ic-indigo{ background:#6366f1; }
    .ic-orange{ background:#f59e0b; }
    .ic-blue{ background:#2563eb; }
    @media (min-width: 576px){ .kpi-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .kpi-card{ grid-column: span 3; } }

    /* ===== Panels & Tables ===== */
    .panel{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .table-box{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .table thead th{ background:#f1f5f9; font-weight:700; }
    .rank-num{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; font-weight:800; border-radius:999px; color:#0f172a; background:#e2e8f0; }
    .rank-1{ background:#fde047; }
    .rank-2{ background:#d1d5db; }
    .rank-3{ background:#f59e0b; color:#fff; }

    /* ===== User overview ===== */
    .user-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .user-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .user-card .icon{ width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:22px; }
    .uc-all .icon{ background:#0ea5e9; }
    .uc-admin .icon{ background:#f97316; }
    .uc-teacher .icon{ background:#22c55e; }
    .uc-parent .icon{ background:#06b6d4; }
    .user-card .val{ font-weight:800; font-size:22px; }
    .user-card .lbl{ color:#334155; font-size:13px; }
    @media (min-width: 576px){ .user-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .user-card{ grid-column: span 3; } }

    /* ===== Top split ===== */
    .top-split{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 1200px){ .top-split{ grid-template-columns: 2fr 1fr; } }

    /* ===== Responsive sidebar ===== */
    .toggle-btn{ display:none; }
    @media (max-width: 991px){
      .sidebar{ position:fixed; left:-100%; z-index:1045; transition:left .25s ease; }
      .sidebar.show{ left:0; }
      .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
      .backdrop.show{ display:block; }
      .toggle-btn{ display:inline-flex; }
    }

    /* Loading overlay */
    #loadingSpinner{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(255,255,255,.6); backdrop-filter: blur(1px); align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="brand mb-3">
        <div class="logo"><i class="bi bi-shield-check"></i></div>
        <div>
          <div class="name">ABT Medu</div>
          <div class="small" style="opacity:.8">Admin trường</div>
        </div>
      </div>

      <div class="nav-section" id="sidebarMenu">
        <div class="nav-item active" data-page="overview"><i class="bi bi-speedometer2"></i><span>Tổng quan</span></div>
        <div class="nav-item" data-page="students"><i class="bi bi-people"></i><span>Danh sách học sinh</span></div>
        <div class="nav-item" data-page="teachers"><i class="bi bi-person-badge"></i><span>Danh sách giáo viên</span></div>
        <div class="nav-item" data-page="bhyt"><i class="bi bi-hospital"></i><span>Bảo hiểm y tế</span></div>
        <div class="nav-item" data-page="bhtn"><i class="bi bi-heart-pulse"></i><span>Bảo Hiểm Tai Nạn</span></div>
        <div class="nav-item" data-page="stats"><i class="bi bi-bar-chart"></i><span>Thống kê</span></div>
        <div class="nav-item" data-page="rewards"><i class="bi bi-cash-coin"></i><span>Thù lao</span></div>
        <div class="nav-item" data-page="profile"><i class="bi bi-person-badge"></i><span>Cá nhân</span></div>
        <div class="nav-item" data-page="settings"><i class="bi bi-gear-wide-connected"></i><span>Cài đặt</span></div>
        <div class="nav-item" id="btnLogout"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></div>
      </div>
    </aside>

    <div class="backdrop" id="backdrop"></div>

    <!-- Content -->
    <main class="content w-100">
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <div class="page-title h4 mb-1">Bảng điều khiển – <span id="schoolName">Trường ...</span></div>
          <div class="sub-muted">Người dùng: <strong id="userName">—</strong> • Quyền: <span id="userRole">admin</span></div>
        </div>
      </div>

      <!-- OVERVIEW PAGE (default) -->
      <section id="page-overview">
        <!-- Top split: KPIs + Filters -->
        <div class="top-split mb-3">
          <!-- Left: KPIs (5 cards) -->
          <div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="icon ic-emerald"><i class="bi bi-people"></i></div>
                <div>
                  <div class="val" id="kpiStudents">0</div>
                  <div class="lbl">Tổng số học sinh</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-indigo"><i class="bi bi-hospital"></i></div>
                <div>
                  <div class="val" id="kpiBHYTCount">0</div>
                  <div class="lbl">Tổng số BHYT đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-orange"><i class="bi bi-heart-pulse"></i></div>
                <div>
                  <div class="val" id="kpiBHTNCount">0</div>
                  <div class="lbl">Tổng số BHTN đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer2"></i></div>
                <div>
                  <div class="val" id="progressBHYTText">0%</div>
                  <div class="lbl">Tiến độ thu BHYT</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                <div>
                  <div class="val" id="progressBHTNTextCard">0%</div>
                  <div class="lbl">Tiến độ thu BHTN</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Filters only -->
          <div class="panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">Bộ lọc dữ liệu</div>
              <small class="text-secondary">Áp dụng cho bảng xếp hạng</small>
            </div>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="filterScope" style="width:auto">
                <option value="school" selected>Cả trường</option>
                <option value="class">Theo lớp</option>
              </select>
              <select class="form-select form-select-sm d-none" id="filterClass" style="width:auto"></select>
            </div>
          </div>
        </div>

        <!-- Rankings -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-primary">BHYT</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHYT"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-warning">BHTN</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHTN"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Users overview -->
        <div class="mt-3">
          <div class="fw-bold mb-2">Tổng quan người dùng</div>
          <div class="user-grid">
            <div class="user-card uc-all">
              <div class="icon"><i class="bi bi-people-fill"></i></div>
              <div>
                <div class="val" id="uAll">0</div>
                <div class="lbl">Tổng user của trường</div>
              </div>
            </div>
            <div class="user-card uc-admin">
              <div class="icon"><i class="bi bi-building-gear"></i></div>
              <div>
                <div class="val" id="uAdmin">0</div>
                <div class="lbl">Số Admin trường</div>
              </div>
            </div>
            <div class="user-card uc-teacher">
              <div class="icon"><i class="bi bi-mortarboard"></i></div>
              <div>
                <div class="val" id="uTeacher">0</div>
                <div class="lbl">Số giáo viên</div>
              </div>
            </div>
            <div class="user-card uc-parent">
              <div class="icon"><i class="bi bi-person-heart"></i></div>
              <div>
                <div class="val" id="uParent">0</div>
                <div class="lbl">Số phụ huynh</div>
              </div>
            </div>
            <div class="user-card">
              <div class="icon" style="background:#22c55e;"><i class="bi bi-emoji-smile"></i></div>
              <div>
                <div class="val" id="uStudent">0</div>
                <div class="lbl">Số học sinh</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Placeholder other pages (hidden by default) -->
      <!-- STUDENTS PAGE (embedded, for admin) -->
      <section id="page-students" class="d-none">
        <h4 class="page-title mb-3">Danh sách học sinh</h4>

        <!-- Thanh tác vụ + bộ lọc phạm vi -->
        <div class="row g-2 mb-2">
          <div class="col-sm-3">
            <input class="form-control" id="adhs-filter-ma-truong" placeholder="Mã trường (mặc định: của bạn)">
          </div>
          <div class="col-sm-3">
            <input class="form-control" id="adhs-filter-lop" placeholder="Lọc theo lớp (để trống = tất cả)">
          </div>
          <div class="col-sm-6 d-flex gap-2">
            <input class="form-control" id="adhs-search" placeholder="Tìm theo tên, BHXH, SĐT, Số định danh…">
            <button class="btn btn-primary" id="adhs-btn-refresh">Tải lại</button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#adhs-modalThem">Thêm học sinh</button>
            <button class="btn btn-danger d-none" id="adhs-btn-del-many">Xóa đã chọn</button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#adhs-modalImport">Nhập Excel</button>
          </div>
        </div>

        <!-- Thống kê nhỏ -->
        <div class="text-muted mb-2">
          Lớp: <span id="adhs-lop-label">tất cả</span> • Tổng: <span id="adhs-total">0</span>
        </div>

        <!-- Bảng -->
        <div class="table-responsive table-box">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:34px;"><input type="checkbox" id="adhs-chk-all"></th>
                <th class="sortable" data-field="stt">STT</th>
                <th class="sortable" data-field="ma_so_bhxh">MS BHXH</th>
                <th class="sortable" data-field="ho_ten_hoc_sinh">Họ tên</th>
                <th class="sortable" data-field="ngay_sinh">Ngày sinh</th>
                <th class="sortable" data-field="gioi_tinh">Giới tính</th>
                <th class="sortable" data-field="lop_hoc">Lớp</th>
                <th class="sortable" data-field="so_dinh_danh">Số định danh</th>
                <th class="sortable" data-field="sdt_lienhe">SĐT</th>
                <th class="sortable" data-field="ma_truong">Mã trường</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="adhs-tbody"></tbody>
          </table>
        </div>

        <!-- Phân trang -->
        <nav class="mt-3">
          <ul class="pagination justify-content-center" id="adhs-pagin"></ul>
        </nav>
      </section>

      <!-- Modal: Thêm -->
      <div class="modal fade" id="adhs-modalThem" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Thêm học sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="adhs-form-them" onsubmit="event.preventDefault();ADMHS_handleAdd();">
              <div class="row g-2">
                <div class="col-sm-6"><label class="form-label">MS BHXH</label><input class="form-control" id="adhs-add-bhxh"></div>
                <div class="col-sm-6"><label class="form-label">Họ tên</label><input class="form-control" id="adhs-add-hoten"></div>
                <div class="col-sm-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="adhs-add-ngaysinh" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-4"><label class="form-label d-block">Giới tính</label>
                  <div class="d-flex gap-3">
                    <label class="form-check"><input class="form-check-input" type="radio" name="adhs-add-gt" value="Nam" checked> Nam</label>
                    <label class="form-check"><input class="form-check-input" type="radio" name="adhs-add-gt" value="Nữ"> Nữ</label>
                  </div>
                </div>
                <div class="col-sm-4"><label class="form-label">Lớp</label><input class="form-control" id="adhs-add-lop"></div>

                <div class="col-sm-6"><label class="form-label">Địa chỉ</label><input class="form-control" id="adhs-add-diachi"></div>
                <div class="col-sm-6"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="adhs-add-sdt"></div>
                <div class="col-sm-6"><label class="form-label">Số định danh</label><input class="form-control" id="adhs-add-sdd"></div>
                <div class="col-sm-6"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="adhs-add-chame"></div>

                <div class="col-sm-6"><label class="form-label">Hạn BHYT</label><input class="form-control" id="adhs-add-han-bhyt" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-6"><label class="form-label">Hạn BHTN</label><input class="form-control" id="adhs-add-han-bhtn" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-6"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="adhs-add-noikham"></div>
                <div class="col-sm-6"><label class="form-label">Đối tượng đóng</label><input class="form-control" id="adhs-add-doituong"></div>
                <div class="col-12"><label class="form-label">Ghi chú</label><input class="form-control" id="adhs-add-ghichu"></div>

                <div class="col-sm-6"><label class="form-label">Mã trường</label><input class="form-control" id="adhs-add-ma-truong"></div>
              </div>
            </form>
            <div id="adhs-add-err" class="text-danger mt-2" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" onclick="ADMHS_handleAdd()">Thêm</button>
          </div>
        </div></div>
      </div>

      <!-- Modal: Sửa -->
      <div class="modal fade" id="adhs-modalSua" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Sửa học sinh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="adhs-form-sua" onsubmit="event.preventDefault();ADMHS_handleEdit();">
              <input type="hidden" id="adhs-edit-stt">
              <div class="row g-2">
                <div class="col-sm-6"><label class="form-label">MS BHXH</label><input class="form-control" id="adhs-edit-bhxh"></div>
                <div class="col-sm-6"><label class="form-label">Họ tên</label><input class="form-control" id="adhs-edit-hoten"></div>
                <div class="col-sm-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="adhs-edit-ngaysinh" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-4"><label class="form-label d-block">Giới tính</label>
                  <div class="d-flex gap-3">
                    <label class="form-check"><input class="form-check-input" type="radio" name="adhs-edit-gt" value="Nam"> Nam</label>
                    <label class="form-check"><input class="form-check-input" type="radio" name="adhs-edit-gt" value="Nữ"> Nữ</label>
                  </div>
                </div>
                <div class="col-sm-4"><label class="form-label">Lớp</label><input class="form-control" id="adhs-edit-lop"></div>

                <div class="col-sm-6"><label class="form-label">Địa chỉ</label><input class="form-control" id="adhs-edit-diachi"></div>
                <div class="col-sm-6"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="adhs-edit-sdt"></div>
                <div class="col-sm-6"><label class="form-label">Số định danh</label><input class="form-control" id="adhs-edit-sdd"></div>
                <div class="col-sm-6"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="adhs-edit-chame"></div>

                <div class="col-sm-6"><label class="form-label">Hạn BHYT</label><input class="form-control" id="adhs-edit-han-bhyt" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-6"><label class="form-label">Hạn BHTN</label><input class="form-control" id="adhs-edit-han-bhtn" placeholder="dd/mm/yyyy"></div>
                <div class="col-sm-6"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="adhs-edit-noikham"></div>
                <div class="col-sm-6"><label class="form-label">Đối tượng đóng</label><input class="form-control" id="adhs-edit-doituong"></div>
                <div class="col-12"><label class="form-label">Ghi chú</label><input class="form-control" id="adhs-edit-ghichu"></div>

                <div class="col-sm-6"><label class="form-label">Mã trường</label><input class="form-control" id="adhs-edit-ma-truong"></div>
              </div>
            </form>
            <div id="adhs-edit-err" class="text-danger mt-2" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" onclick="ADMHS_handleEdit()">Lưu</button>
          </div>
        </div></div>
      </div>

      <!-- Modal: Import -->
      <div class="modal fade" id="adhs-modalImport" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Nhập danh sách học sinh (Excel)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="file" id="adhs-import-file" class="form-control mb-2" accept=".xlsx,.xls" />
            <div class="small text-secondary">Nếu file thiếu <b>ma_truong/lop_hoc</b>, hệ thống sẽ dùng giá trị đang lọc.</div>
            <div id="adhs-import-err" class="text-danger mt-2" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" onclick="ADMHS_handleImport()">Nhập</button>
          </div>
        </div></div>
      </div>






      <section id="page-teachers" class="d-none">
        <div class="panel"><div>Danh sách giáo viên (đang phát triển).</div></div>
      </section>
      <section id="page-bhyt" class="d-none">
        <div class="panel"><div>Đi tới <a href="bhyt_giaovien.html">BHYT</a> / <a href="bhyt.html">BHYT (menu chung)</a>.</div></div>
      </section>
      <section id="page-bhtn" class="d-none">
        <div class="panel"><div>Đi tới <a href="bhtn_giaovien.html">BHTN</a>.</div></div>
      </section>
      <section id="page-stats" class="d-none"><div class="panel"><div>Trang thống kê nâng cao (đang phát triển).</div></div></section>
      <section id="page-rewards" class="d-none"><div class="panel"><div>Trang thù lao (đang phát triển).</div></div></section>
      <section id="page-profile" class="d-none"><div class="panel"><div>Thông tin cá nhân (đang phát triển).</div></div></section>
      <section id="page-settings" class="d-none"><div class="panel"><div> Cài đặt (đang phát triển).</div></div></section>

    </main>
  </div>

  <!-- Loading -->
  <div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="../js/api.js"></script>


  <script>
  /** ===== Admin – Danh sách học sinh (embedded) =====
   *  Giữ nguyên triết lý & hành vi như ds_hocsinh.html,
   *  nhưng nạp dữ liệu theo trường (ma_truong) + mọi lớp (lop_hoc="").
   *  Dùng API đã có: getDanhSachHocsinhPaginated, themHocsinh, suaHocsinh, xoaHocsinh, xoaNhieuHocsinh, importDanhSachHocsinh.
   */

  (() => {
    const U = JSON.parse(localStorage.getItem('user')||'{}');
    const ROLE = String(U.phan_quyen||'').toLowerCase();
    if (!U.sdt || !(ROLE==='admin' || ROLE==='super_admin' || ROLE==='superadmin')) return;

    // One-time init khi click menu "students"
    let inited = false;
    const onStudentsShown = () => { if (!inited){ inited = true; boot(); } };

    // Gắn vào menu sẵn có data-page="students"
    document.querySelectorAll('#sidebarMenu .nav-item[data-page="students"]').forEach(el=>{
      el.addEventListener('click', onStudentsShown);
    });

    // Nếu trang load với hash ?page=students thì mở luôn (không bắt buộc)
    if (location.hash.includes('students')) onStudentsShown();

    // ====== STATE ======
    const S = {
      ma_truong: U.ma_truong || '',
      lop_hoc: '',
      page: 0, limit: 20, total: 0,
      sortField: '', sortDir: 1,
      query: '',
      selected: new Set(),
      lastItems: []
    };

    // ====== Helpers ======
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    function setBusy(on){ const sp = document.getElementById('loadingSpinner'); if (!sp) return; sp.style.display = on?'flex':'none'; }
    function setDelManyVisible(){ $('#adhs-btn-del-many')?.classList.toggle('d-none', S.selected.size===0); }
    function fmt(v){ return (v??''); }

    // ====== Paging & Sorting render ======
    function renderRows(items){
      const tb = $('#adhs-tbody');
      if (!items || !items.length){
        tb.innerHTML = `<tr><td colspan="11" class="text-center text-secondary py-4">Không có dữ liệu</td></tr>`;
        return;
      }
      S.lastItems = items.slice(0);
      tb.innerHTML = items.map(row=>{
        const id = row.stt ?? row.so_dinh_danh ?? '';
        const rowEsc = encodeURIComponent(JSON.stringify(row));
        return `
          <tr>
            <td><input type="checkbox" data-id="${id}"></td>
            <td>${fmt(row.stt)}</td>
            <td>${fmt(row.ma_so_bhxh)}</td>
            <td>${fmt(row.ho_ten_hoc_sinh)}</td>
            <td>${fmt(row.ngay_sinh)}</td>
            <td>${fmt(row.gioi_tinh)}</td>
            <td>${fmt(row.lop_hoc)}</td>
            <td>${fmt(row.so_dinh_danh)}</td>
            <td>${fmt(row.sdt_lienhe)}</td>
            <td>${fmt(row.ma_truong)}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-row='${rowEsc}'>Sửa</button>
              <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${id}">Xóa</button>
            </td>
          </tr>`;
      }).join('');

      // bind row events
      $$('#adhs-tbody input[type="checkbox"]').forEach(ch=>{
        ch.addEventListener('change', e=>{
          const id = e.target.dataset.id;
          if (e.target.checked) S.selected.add(id); else S.selected.delete(id);
          setDelManyVisible();
        });
      });
      // edit/delete
      $$('#adhs-tbody [data-action]').forEach(btn=>{
        const act = btn.dataset.action;
        if (act==='edit'){
          btn.addEventListener('click', ()=>{
            const row = JSON.parse(decodeURIComponent(btn.dataset.row||'%7B%7D'));
            openEdit(row);
          });
        } else if (act==='del'){
          btn.addEventListener('click', async ()=>{
            if (!confirm('Xóa bản ghi này?')) return;
            setBusy(true);
            try{
              const rs = await xoaHocsinh(btn.dataset.id);
              if (!rs?.success) alert(rs?.message||'Xóa thất bại');
              await reload(false);
            } finally { setBusy(false); }
          });
        }
      });
    }

    function renderPagination(){
      const ul = $('#adhs-pagin');
      const pages = Math.max(1, Math.ceil(S.total / S.limit));
      const cur = S.page;
      const mk = (p, lbl, dis, act) => `<li class="page-item ${dis?'disabled':''} ${act?'active':''}"><a class="page-link" href="#" data-p="${p}">${lbl}</a></li>`;
      let html = '';
      html += mk(Math.max(0,cur-1),'«',cur===0,false);
      for(let i=0;i<pages;i++){
        if (i===0 || i===pages-1 || Math.abs(i-cur)<=2) html += mk(i, i+1, false, i===cur);
        else if (i===cur-3 || i===cur+3) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
      }
      html += mk(Math.min(pages-1,cur+1),'»',cur>=pages-1,false);
      ul.innerHTML = html;
      $$('#adhs-pagin a.page-link').forEach(a=>{
        a.addEventListener('click', e=>{
          e.preventDefault();
          const p = Number(a.dataset.p||0);
          if (p===S.page) return;
          S.page = p;
          reload(false);
        });
      });
    }

    async function reload(resetPage){
      if (resetPage) S.page = 0;
      setBusy(true);
      try{
        const start = S.page * S.limit;
        const res = await getDanhSachHocsinhPaginated(
          S.ma_truong || '', S.lop_hoc || '', start, S.limit,
          S.query || '', S.sortField || '', S.sortDir || 1
        ); // tái dùng API trang gốc :contentReference[oaicite:4]{index=4}

        const items = res?.data?.items ?? res?.data ?? [];
        S.total = res?.data?.total ?? (Array.isArray(items)? items.length : 0);

        $('#adhs-total').textContent = S.total;
        $('#adhs-lop-label').textContent = S.lop_hoc || 'tất cả';
        S.selected.clear(); setDelManyVisible();
        renderRows(items);
        renderPagination();
      } finally { setBusy(false); }
    }

    function bindSort(){
      $$('#page-students th.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const f = th.dataset.field||'';
          if (S.sortField===f) S.sortDir = -S.sortDir;
          else { S.sortField=f; S.sortDir=1; }
          reload(true);
        });
      });
    }

    function bindHeader(){
      // mặc định đổ mã trường của admin
      $('#adhs-filter-ma-truong').value = S.ma_truong;
      $('#adhs-filter-ma-truong').addEventListener('input', e=>{ S.ma_truong = e.target.value.trim(); reload(true); });
      $('#adhs-filter-lop').addEventListener('input', e=>{ S.lop_hoc = e.target.value.trim(); reload(true); });
      $('#adhs-search').addEventListener('input', e=>{ S.query = e.target.value.trim(); reload(true); });
      $('#adhs-btn-refresh').addEventListener('click', ()=> reload(true));
      $('#adhs-chk-all').addEventListener('change', e=>{
        const checked = e.target.checked;
        $$('#adhs-tbody input[type="checkbox"]').forEach(ch=>{
          ch.checked = checked;
          const id = ch.dataset.id;
          if (checked) S.selected.add(id); else S.selected.delete(id);
        });
        setDelManyVisible();
      });
      $('#adhs-btn-del-many').addEventListener('click', async ()=>{
        if (S.selected.size===0) return;
        if (!confirm(`Xóa ${S.selected.size} dòng đã chọn?`)) return;
        setBusy(true);
        try{
          const ids = Array.from(S.selected);
          const rs = await xoaNhieuHocsinh(ids);
          if (!rs?.success) alert(rs?.message||'Xóa nhiều thất bại');
          await reload(true);
        } finally { setBusy(false); }
      });
    }

    // ====== Add / Edit ======
    function getRadio(name){ return document.querySelector(`input[name="${name}"]:checked`)?.value || ''; }

    async function ADMHS_handleAdd(){
      const payload = {
        ma_so_bhxh: $('#adhs-add-bhxh').value.trim(),
        ho_ten_hoc_sinh: $('#adhs-add-hoten').value.trim(),
        ngay_sinh: $('#adhs-add-ngaysinh').value.trim(),
        gioi_tinh: getRadio('adhs-add-gt'),
        dia_chi: $('#adhs-add-diachi').value.trim(),
        ngay_het_han_bhyt: $('#adhs-add-han-bhyt').value.trim(),
        ngay_het_han_bhtn: $('#adhs-add-han-bhtn').value.trim(),
        lop_hoc: $('#adhs-add-lop').value.trim() || S.lop_hoc || '',
        sdt_lienhe: $('#adhs-add-sdt').value.trim(),
        so_dinh_danh: $('#adhs-add-sdd').value.trim(),
        noi_kham_bhyt: $('#adhs-add-noikham').value.trim(),
        ten_cha_me: $('#adhs-add-chame').value.trim(),
        doi_tuong_dong: $('#adhs-add-doituong').value.trim() || 'null',
        ghi_chu: $('#adhs-add-ghichu').value.trim() || 'null',
        ma_truong: $('#adhs-add-ma-truong').value.trim() || S.ma_truong || ''
      };
      setBusy(true);
      try{
        const rs = await themHocsinh(payload);
        if (!rs?.success){ $('#adhs-add-err').textContent = rs?.message || 'Thêm thất bại'; return; }
        $('#adhs-add-err').textContent = '';
        bootstrap.Modal.getInstance($('#adhs-modalThem')).hide();
        await reload(true);
      } finally { setBusy(false); }
    }
    window.ADMHS_handleAdd = ADMHS_handleAdd;

    function openEdit(row){
      $('#adhs-edit-stt').value = row.stt || '';
      $('#adhs-edit-bhxh').value = row.ma_so_bhxh || '';
      $('#adhs-edit-hoten').value = row.ho_ten_hoc_sinh || '';
      $('#adhs-edit-ngaysinh').value = row.ngay_sinh || '';
      $$('input[name="adhs-edit-gt"]').forEach(r=> r.checked = (r.value === String(row.gioi_tinh||'')));
      $('#adhs-edit-lop').value = row.lop_hoc || '';
      $('#adhs-edit-diachi').value = row.dia_chi || '';
      $('#adhs-edit-sdt').value = row.sdt_lienhe || '';
      $('#adhs-edit-sdd').value = row.so_dinh_danh || '';
      $('#adhs-edit-chame').value = row.ten_cha_me || '';
      $('#adhs-edit-han-bhyt').value = row.ngay_het_han_bhyt || '';
      $('#adhs-edit-han-bhtn').value = row.ngay_het_han_bhtn || '';
      $('#adhs-edit-noikham').value = row.noi_kham_bhyt || '';
      $('#adhs-edit-doituong').value = row.doi_tuong_dong || '';
      $('#adhs-edit-ghichu').value = row.ghi_chu || '';
      $('#adhs-edit-ma-truong').value = row.ma_truong || S.ma_truong || '';
      bootstrap.Modal.getOrCreateInstance($('#adhs-modalSua')).show();
    }

    async function ADMHS_handleEdit(){
      const payload = {
        stt: $('#adhs-edit-stt').value,
        ma_so_bhxh: $('#adhs-edit-bhxh').value.trim(),
        ho_ten_hoc_sinh: $('#adhs-edit-hoten').value.trim(),
        ngay_sinh: $('#adhs-edit-ngaysinh').value.trim(),
        gioi_tinh: getRadio('adhs-edit-gt'),
        dia_chi: $('#adhs-edit-diachi').value.trim(),
        ngay_het_han_bhyt: $('#adhs-edit-han-bhyt').value.trim(),
        ngay_het_han_bhtn: $('#adhs-edit-han-bhtn').value.trim(),
        lop_hoc: $('#adhs-edit-lop').value.trim(),
        sdt_lienhe: $('#adhs-edit-sdt').value.trim(),
        so_dinh_danh: $('#adhs-edit-sdd').value.trim(),
        noi_kham_bhyt: $('#adhs-edit-noikham').value.trim(),
        ten_cha_me: $('#adhs-edit-chame').value.trim(),
        doi_tuong_dong: $('#adhs-edit-doituong').value.trim() || 'null',
        ghi_chu: $('#adhs-edit-ghichu').value.trim() || 'null',
        ma_truong: $('#adhs-edit-ma-truong').value.trim() || S.ma_truong || ''
      };
      setBusy(true);
      try{
        const rs = await suaHocsinh(payload);
        if (!rs?.success){ $('#adhs-edit-err').textContent = rs?.message || 'Cập nhật thất bại'; return; }
        $('#adhs-edit-err').textContent = '';
        bootstrap.Modal.getInstance($('#adhs-modalSua')).hide();
        await reload(false);
      } finally { setBusy(false); }
    }
    window.ADMHS_handleEdit = ADMHS_handleEdit;

    // ====== Import Excel ======
    async function ADMHS_handleImport(){
      const input = $('#adhs-import-file');
      const file = input?.files?.[0];
      if (!file){ $('#adhs-import-err').textContent = 'Hãy chọn file .xlsx/.xls'; return; }
      $('#adhs-import-err').textContent = '';
      setBusy(true);
      try{
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {defval:''});

        // Chuẩn hóa key, fallback ma_truong/lop_hoc theo filter
        const norm = rows.map(r=>({
          ma_so_bhxh: r.ma_so_bhxh || r.MS_BHXH || r['ma so bhxh'] || '',
          ho_ten_hoc_sinh: r.ho_ten_hoc_sinh || r.ho_ten || r['ho ten'] || r['Họ tên'] || '',
          ngay_sinh: r.ngay_sinh || r['ngay sinh'] || r['Ngày sinh'] || '',
          gioi_tinh: r.gioi_tinh || r['gioi tinh'] || r['Giới tính'] || '',
          dia_chi: r.dia_chi || r['dia chi'] || r['Địa chỉ'] || '',
          ngay_het_han_bhyt: r.ngay_het_han_bhyt || r['han bhyt'] || '',
          ngay_het_han_bhtn: r.ngay_het_han_bhtn || r['han bhtn'] || '',
          lop_hoc: r.lop_hoc || r.lop || S.lop_hoc || '',
          sdt_lienhe: r.sdt_lienhe || r.sdt || '',
          so_dinh_danh: r.so_dinh_danh || r['so dinh danh'] || '',
          noi_kham_bhyt: r.noi_kham_bhyt || r['noi kham'] || '',
          ten_cha_me: r.ten_cha_me || r['ten cha me'] || '',
          doi_tuong_dong: r.doi_tuong_dong || r['doi tuong dong'] || 'null',
          ghi_chu: r.ghi_chu || r['ghi chu'] || 'null',
          ma_truong: r.ma_truong || S.ma_truong || ''
        }));

        const rs = await importDanhSachHocsinh(norm);
        if (!rs?.success){ $('#adhs-import-err').textContent = rs?.message || 'Nhập thất bại'; return; }
        bootstrap.Modal.getInstance($('#adhs-modalImport')).hide();
        await reload(true);
      } catch(err){
        $('#adhs-import-err').textContent = 'Không đọc được file: ' + (err?.message||err);
      } finally { setBusy(false); }
    }
    window.ADMHS_handleImport = ADMHS_handleImport;

    // ====== Boot (first show) ======
    function boot(){
      // init pickers
      flatpickr('#adhs-add-ngaysinh', {dateFormat:'d/m/Y', allowInput:true});
      flatpickr('#adhs-add-han-bhyt', {dateFormat:'d/m/Y', allowInput:true});
      flatpickr('#adhs-add-han-bhtn', {dateFormat:'d/m/Y', allowInput:true});
      flatpickr('#adhs-edit-ngaysinh', {dateFormat:'d/m/Y', allowInput:true});
      flatpickr('#adhs-edit-han-bhyt', {dateFormat:'d/m/Y', allowInput:true});
      flatpickr('#adhs-edit-han-bhtn', {dateFormat:'d/m/Y', allowInput:true});

      bindHeader();
      bindSort();
      reload(true);
    }
  })();
  </script>


  <script>
  // === Utilities ===
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  function ensureLoggedInAsAdmin() {
    const raw = localStorage.getItem('user');
    if (!raw) { window.location.href = '../index.html'; return null; }
    let user; try { user = JSON.parse(raw); } catch(e){ localStorage.removeItem('user'); window.location.href='../index.html'; return null; }
    const role = String(user.phan_quyen||'').toLowerCase();
    if (!(role === 'admin' || role === 'super_admin' || role === 'superadmin')) {
      alert('Bạn không có quyền truy cập trang này.');
      window.location.href = '../index.html';
      return null;
    }
    return user;
  }

  function setActivePage(page){
    $$('#sidebarMenu .nav-item').forEach(el=> el.classList.toggle('active', el.dataset.page === page));
    $$('[id^="page-"]').forEach(sec => sec.classList.add('d-none'));
    $(`#page-${page}`)?.classList.remove('d-none');
  }

  function toggleSidebar(open){
    const sb = $('#sidebar');
    const bd = $('#backdrop');
    const willOpen = open ?? !sb.classList.contains('show');
    sb.classList.toggle('show', willOpen);
    bd.classList.toggle('show', willOpen);
  }

  function showLoading(){ $('#loadingSpinner').style.display='flex'; }
  function hideLoading(){ $('#loadingSpinner').style.display='none'; }

  // === State for filters ===
  let STATE = { students: [], bhytPaid: [], bhtnPaid: [] };
  function applyFilters(){
    const scope = $('#filterScope')?.value || 'school';
    const cls = ($('#filterClass')?.value || '').trim();
    let students = STATE.students;
    let bhyt = STATE.bhytPaid;
    let bhtn = STATE.bhtnPaid;
    if (scope === 'class' && cls){
      const byCls = r => String(r.lop_hoc||'').trim() === cls;
      students = students.filter(byCls);
      bhyt = bhyt.filter(byCls);
      bhtn = bhtn.filter(byCls);
    }
    renderRanking('#rankBHYT', buildClassRanking(students, bhyt));
    renderRanking('#rankBHTN', buildClassRanking(students, bhtn));
  }

  // === API helpers (use functions from ../js/api.js) ===
  async function listUsers(){
    try{
      const url = `${API_BASE}?func=ListUsers`;
      const res = await fetch(url);
      return await res.json();
    }catch(e){ return { success:false, data:[] }; }
  }
  async function countStudentsBySchool(ma_truong){
    const resp = await getAllDanhSachHocsinh(ma_truong||'', '');
    const arr = Array.isArray(resp?.data) ? resp.data : [];
    return { total: arr.length, rows: arr };
  }
  async function fetchBHYT(ma_truong){
    const resp = await getDanhSachBHYT(ma_truong||'', '');
    return Array.isArray(resp?.data) ? resp.data : [];
  }
  async function fetchBHTN(ma_truong){
    try{ const resp = await getDanhSachBHTN(ma_truong||'', ''); return Array.isArray(resp?.data) ? resp.data : []; }
    catch(e){ return []; }
  }

  // === Rendering ===
  function renderKPIs(studentsTotal, bhytPaidCount, bhtnPaidCount){
    $('#kpiStudents').textContent = studentsTotal.toLocaleString('vi-VN');
    $('#kpiBHYTCount').textContent = bhytPaidCount.toLocaleString('vi-VN');
    $('#kpiBHTNCount').textContent = bhtnPaidCount.toLocaleString('vi-VN');
    const rateBHYT = studentsTotal ? Math.round(bhytPaidCount * 100 / studentsTotal) : 0;
    const rateBHTN = studentsTotal ? Math.round(bhtnPaidCount * 100 / studentsTotal) : 0;
    $('#progressBHYTText').textContent = rateBHYT + '%';
    $('#progressBHTNTextCard').textContent = rateBHTN + '%';
  }

  function renderRanking(tbodySel, items){
    const tbody = $(tbodySel);
    if (!tbody) return;
    const rows = items.map((r,i)=>{
      const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
      return `<tr>
        <td><span class="rank-num ${rankCls}">${i+1}</span></td>
        <td>${r.cls}</td>
        <td class="text-end">${r.done}</td>
        <td class="text-end">${r.total}</td>
        <td class="text-end fw-bold">${r.pct}%</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="5" class="text-center text-secondary">Không có dữ liệu</td></tr>`;
  }

  function buildClassRanking(students, paidRows){
    const totalByClass = students.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    const paidByClass = paidRows.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    return Object.entries(totalByClass).map(([cls,total])=>{ const done = paidByClass[cls]||0; const pct = total? Math.round(done*100/total):0; return { cls, done, total, pct }; })
      .sort((a,b)=> b.pct - a.pct || b.done - a.done || a.cls.localeCompare(b.cls));
  }

  function wireSidebar(){
    setActivePage('overview');
    $$('#sidebarMenu .nav-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        const page = item.dataset.page; if (!page) return; setActivePage(page);
      });
    });
    $('#btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); window.location.href = '../index.html'; });
    $('#btnToggleSidebar')?.addEventListener('click', ()=> toggleSidebar(true));
    $('#backdrop')?.addEventListener('click', ()=> toggleSidebar(false));
    $('#filterScope').addEventListener('change', (e)=>{
      const v = e.target.value; const clsSel = $('#filterClass');
      clsSel.classList.toggle('d-none', v !== 'class');
      if (v !== 'class') clsSel.value = '';
      applyFilters();
    });
    $('#filterClass').addEventListener('change', applyFilters);
  }

  // === Boot ===
  (async function init(){
    const user = ensureLoggedInAsAdmin(); if (!user) return;
    $('#userName').textContent = user.ho_ten||user.sdt||'Admin';
    $('#userRole').textContent = user.phan_quyen||'admin';
    $('#schoolName').textContent = user.ten_truong || (user.ma_truong||'');

    wireSidebar();
    setActivePage('overview');

    try{
      showLoading();
      const ma_truong = (user.ma_truong||'').trim();

      const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
        countStudentsBySchool(ma_truong),
        fetchBHYT(ma_truong),
        fetchBHTN(ma_truong)
      ]);

      const isPaid = r => { const so_tien = Number(String(r.so_tien||'').replaceAll(',','')); const trang_thai = String(r.trang_thai ?? ''); const so_ho_so = String(r.so_ho_so||''); return so_tien>0 || trang_thai==='1' || !!so_ho_so; };
      const bhytPaid = bhytRows.filter(isPaid);
      const bhtnPaid = bhtnRows.filter(isPaid);

      renderKPIs(studentsTotal, bhytPaid.length, bhtnPaid.length);

      const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
      const sel = $('#filterClass');
      sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

      STATE = { students, bhytPaid, bhtnPaid };
      applyFilters();

      // Users overview
      try{
        const rs = await listUsers();
        const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
        const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
        const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
        const parentCount = uSchool.filter(u => {
          const r = String(u.phan_quyen||'').trim().toLowerCase();
          return r === 'phu_huynh' || r === 'user';
        }).length;
        $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
        $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
        $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
        $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      } catch(e){
        $('#uAll').textContent = '-';
        $('#uAdmin').textContent = '-';
        $('#uTeacher').textContent = '-';
        $('#uParent').textContent = '-';
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      }

    } catch(err){
      console.error(err);
      alert('Không tải được dữ liệu tổng quan. Vui lòng kiểm tra API_BASE trong js/api.js');
    } finally{
      hideLoading();
    }
  })();
</script>
</body>
</html>
