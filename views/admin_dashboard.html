<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard – ABT Medu</title>

  <!-- Disable Devtool -->
  <!-- <script src="/js/anti-devtools.js"></script> -->

  <link rel="icon" type="image/png" href="/assets/image/school.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  
  <style>
    :root{
      --sidebar-w: 260px;
      --brand: #0d47a1;
      --brand-2: #2563eb;
      --muted: #6b7280;
      --card-radius: 14px;
    }
    body{ background:#f5f7fb; min-height:100vh; overflow-x:hidden; }

    /* ===== Layout ===== */
    .app{ display:flex; min-height:100vh; width:100%; }

    /* ===== Sidebar (match superadmin) ===== */
    /* ===== Sidebar ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(180deg, #0d47a1, #1e3a8a 60%, #0f172a); color:#fff; padding:16px 14px; position:sticky; top:0; height:100vh; height:100dvh; display:flex; flex-direction:column; overflow:hidden;}
    .brand{ display:flex; gap:10px; align-items:center; padding:10px 10px 18px 6px; border-bottom:1px solid rgba(255,255,255,.12); margin-bottom:8px; }
    .brand .logo{ width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; font-size:22px; }
    .brand .name{ font-weight:800; letter-spacing:.3px; line-height:1.1 }
    .nav-section{ margin-top:10px; flex-grow:1; }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; color:#dbeafe; text-decoration:none; margin:4px 0; cursor:pointer; }
    .nav-item:hover{ background:rgba(255,255,255,.08); color:#fff; }
    .nav-item.active{ background:rgba(59,130,246,.35); color:#fff; }
    .nav-item .bi{ font-size:18px; width:22px; text-align:center; }

    @supports (height: 100svh){
      .sidebar{ height:100svh; }
    }

    /* Chỉ phần menu cuộn, tránh “kẹt” chiều cao trong flex */
    .sidebar-scroll{ flex:1; min-height:0; overflow-y:auto; overscroll-behavior:contain; }


    /* Đáy sidebar luôn thấy được, thêm safe-area cho mobile */
    .sidebar-bottom{
      position: sticky; bottom: 0;
      padding-top: 8px;
      padding-bottom: max(8px, env(safe-area-inset-bottom, 0px));
      background: linear-gradient(180deg, rgba(15,23,42,0) 0%, rgba(15,23,42,.35) 40%, rgba(15,23,42,.6) 100%);
    }

    /* Phân cách menu và logout */
    .sidebar hr{ border:none; border-top:1px solid rgba(255,255,255,.2); margin:12px 0; }

    /* Nút đăng xuất ở đáy: kích thước gọn, rõ hover */
    .sidebar-bottom .nav-item{
      margin: 0;                 /* gọn sát đáy */
      padding: 10px 12px;
    }
    .sidebar-bottom .nav-item:hover{
      background: rgba(255,255,255,.10);
    }

    /* Footer bản quyền nhỏ, cân màu */
    .sidebar footer{
      text-align: center;
      font-size: 14px;
      line-height: 1.2;
      color: #d1d5db;
      margin-top: 8px;
      opacity: .9;
    }

    /* ===== Tối ưu cho màn hình thấp (laptop 13" hoặc cửa sổ nhỏ) ===== */
    @media (max-height: 720px){
      .brand{ padding-bottom: 10px; margin-bottom: 6px; }
      .nav-item{ padding: 8px 10px; }
      .nav-section{ margin-top: 6px; }
    }

    /* ===== Cuộn mượt và đẹp (tùy chọn) ===== */
    .sidebar-scroll{ scroll-behavior: smooth; }
    .sidebar-scroll::-webkit-scrollbar{ width: 8px; }
    .sidebar-scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.25);
      border-radius: 8px;
    }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.35);
    }

    /* Tôn trọng người dùng giảm chuyển động (tùy chọn) */
    @media (prefers-reduced-motion: reduce){
      .sidebar{ scroll-behavior: auto; }
      .sidebar-scroll{ scroll-behavior: auto; }
    }




    /* ===== Content ===== */
    .content{ flex:1; padding:18px; max-width:1600px; margin:0 auto; }
    .page-title{ font-weight:800; letter-spacing:.3px; color:#0f172a; }
    .sub-muted{ color:var(--muted); }

    /* Link tải mẫu excel */
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer; }

    /* ===== Cards / KPI ===== */
    .kpi-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .kpi-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .kpi-card .icon{ width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:26px; flex:0 0 auto; }
    .kpi-card .val{ font-size:28px; font-weight:900; line-height:1; }
    .kpi-card .lbl{ font-size:13px; color:#334155; margin-top:2px; }
    .ic-emerald{ background:#10b981; }
    .ic-indigo{ background:#6366f1; }
    .ic-orange{ background:#f59e0b; }
    .ic-blue{ background:#2563eb; }
    .ic-amber{ background:#be0bf5; color:#fff; }

    @media (min-width: 576px){ .kpi-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .kpi-card{ grid-column: span 3; } }

    /* ===== Panels & Tables ===== */
    .panel{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .table-box{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .table thead th{ background:#f1f5f9; font-weight:700; }
    .rank-num{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; font-weight:800; border-radius:999px; color:#0f172a; background:#e2e8f0; }
    .rank-1{ background:#fde047; }
    .rank-2{ background:#d1d5db; }
    .rank-3{ background:#f59e0b; color:#fff; }

    /* ===== User overview ===== */
    .user-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .user-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .user-card .icon{ width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:22px; }
    .uc-all .icon{ background:#0ea5e9; }
    .uc-admin .icon{ background:#f97316; }
    .uc-teacher .icon{ background:#22c55e; }
    .uc-parent .icon{ background:#06b6d4; }
    .user-card .val{ font-weight:800; font-size:22px; }
    .user-card .lbl{ color:#334155; font-size:13px; }
    @media (min-width: 576px){ .user-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .user-card{ grid-column: span 3; } }

    /* ===== Top split ===== */
    .top-split{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 1200px){ .top-split{ grid-template-columns: 2fr 1fr; } }

    /* ===== Responsive sidebar ===== */
    .toggle-btn{ display:none; }
    @media (max-width: 991px){
      .sidebar{ position:fixed; left:-100%; z-index:1045; transition:left .25s ease; }
      .sidebar.show{ left:0; }
      .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
      .backdrop.show{ display:block; }
      .toggle-btn{ display:inline-flex; }
    }

    /* Loading overlay */
    #loadingSpinner{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(255,255,255,.6); backdrop-filter: blur(1px); align-items:center; justify-content:center; }

  </style>




  <!-- === BHYT (A5 & Print styles) === -->
  <style>
    /* A5 & print (nguyên lý từ ds_hocsinh_chuathu_giaovien.html) */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}
    @media print {
      @page { size: A5 portrait; margin: 10mm; }
      body{background:#fff!important}
      .modal{position:static!important}
      .modal-dialog{width:auto!important;max-width:none!important}
      .modal-content{box-shadow:none!important;border:none!important}
      .no-print{display:none!important}
      .a5-paper{box-shadow:none!important;margin:0!important}
    }
    @media print { html, body { height: auto !important; } }



    .action-btns .btn {
      margin-right: 4px;
      margin-bottom: 4px;
    }
  </style>
  <!-- === /BHYT (A5 & Print styles) === -->


  <!-- ====== BHYT ĐÃ THU (bảng + trạng thái + modal xem thẻ) ====== -->
  <style>
    /* ====== BHYT ĐÃ THU (bảng + trạng thái) ====== */
    #tab-other .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    #tab-other th.th-action{min-width:170px}
    #tab-other th.sortable{cursor:pointer;user-select:none}
    #tab-other th.sortable:hover{background:#f1f1f1}
    #tab-other .sort-icon{font-size:13px;margin-left:4px;vertical-align:middle}

    #tab-other .status-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    #tab-other .status-pending{color:#b91c1c;background:#fee2e2}
    #tab-other .status-paid-wait{color:#b91c1c;background:#ffe4e6}
    #tab-other .status-active{color:#065f46;background:#d1fae5}
    #tab-other .hoso-text{display:block;font-size:12px;color:#1d4ed8;margin-top:4px}
    #tab-other .action-btns .btn{margin-right:6px;margin-bottom:6px}

    /* ====== THẺ BHYT (modal xem thẻ) ====== */
    :root{ --cardW:920px; --cardH:580px; }
    .bhyt-card{max-width:980px;margin:0 auto;background:#fff;border:8px solid #2d66d5;border-radius:14px;padding:6px;box-shadow:0 2px 10px rgba(0,0,0,.06);width:var(--cardW);height:var(--cardH);overflow:hidden}
    .bhyt-inner{border:3px solid #2d66d5;border-radius:12px;padding:18px 22px 34px;height:100%;display:flex;flex-direction:column}
    .bhyt-top{display:grid;grid-template-columns:120px 1fr 120px;align-items:center;column-gap:10px;margin-bottom:6px}
    .bhyt-logo-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    .bhyt-logo{width:84px;height:84px;border-radius:50%;border:4px solid #2d66d5;background:#e6f0ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .bhyt-logo img{width:86%;height:86%;object-fit:contain}
    .bhyt-obj{font-weight:800;color:#4b5563;letter-spacing:.5px}
    .bhyt-title{text-align:center;font-weight:900;color:#ef4444;letter-spacing:1px;font-size:30px}
    .bhyt-ms{text-align:center;font-weight:800;font-size:30px;margin:4px 0 2px}
    .bhyt-sdd-line{text-align:center;color:#4b5563;font-weight:700}
    .bhyt-sdd{color:#0b53ff;font-weight:900;font-size:22px;margin-left:8px}
    .bhyt-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:18px;margin-top:8px}
    .bhyt-col .kv{display:flex;gap:12px;margin:6px 0;align-items:flex-start}
    .kv .k{min-width:160px;color:#6b7280;font-weight:800}
    .kv .v{color:#111827;font-weight:800}
    .kv .v.v-blue{color:#0b53ff!important}
    .kv .v.v-red{color:#e11d48!important}
    .kv .v.v-green{color:#0f9d58!important}
    .bhyt-lop-big{text-align:right;font-size:44px;font-weight:900;color:#9ca3af}
    .bhyt-footer{display:flex;justify-content:center;gap:16px;margin-top:8px}
    .bhyt-stamp{font-weight:900;color:#16a34a;font-size:28px}
    .bhyt-sohoso{padding:6px 14px;border-radius:6px;background:#fff3b0;border:2px solid #facc15;font-weight:900;color:#1d4ed8;display:inline-block}

    #cardScaleWrap{position:relative;width:var(--cardW);height:var(--cardH);transform-origin:top left;margin:0 auto}
    .bhyt-card.exporting{height:auto!important;overflow:visible!important}
    .bhyt-card.exporting .bhyt-inner{padding-bottom:48px!important}
    .bhyt-card.exporting, .bhyt-card.exporting *{font-family:Arial,"Helvetica Neue",Helvetica,Roboto,system-ui,sans-serif;letter-spacing:.2px}

    @media print{
      @page{ size:A6 landscape; margin:6mm }
      #cardScaleWrap{width:148mm;height:105mm;transform:none!important}
      .bhyt-card{width:148mm;height:105mm}
    }
  </style>
  <!-- ====== BHYT ĐÃ THU (bảng + trạng thái + modal xem thẻ) ====== -->





  <!-- ====== BHTN ĐÃ THU(bảng + trạng thái + modal xem thẻ) ====== -->
  <style>
    #bhtn-paid .status-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    #bhtn-paid .status-pending{color:#b91c1c;background:#fee2e2}       /* đỏ */
    #bhtn-paid .status-paid-wait{color:#b91c1c;background:#ffe4e6}     /* đỏ nhạt */
    #bhtn-paid .status-active{color:#065f46;background:#d1fae5}        /* xanh lá */
    #bhtn-paid .hoso-text{display:block;font-size:12px;color:#1d4ed8;margin-top:4px} /* số hồ sơ xuống dòng */
  </style>
  <!-- ====== BHTN ĐÃ THU(bảng + trạng thái + modal xem thẻ) ====== -->



  <!-- ====== /THẺ BHTN (Admin, theo mẫu) ====== -->
  <style>
    /* ==== THẺ BHTN (Admin) — theo mẫu gốc ==== */
    #modalTheBHTN_Admin :root{--cardW-bhtn:900px;--cardH-bhtn:560px;--orange:#f59e0b}

    /* Viền + nền đặt ở LỚP NGOÀI (.bhtn-card) để phủ toàn bộ thẻ */
    #modalTheBHTN_Admin .bhtn-card{
      box-sizing:border-box;
      width:var(--cardW-bhtn);
      height:var(--cardH-bhtn);
      border:8px solid var(--orange);     /* = mẫu gốc */
      border-radius:14px;
      /* NỀN phủ toàn thẻ (mềm, ấm) */
      background:
        radial-gradient(1200px 600px at -20% -40%, #fff1e6 0 55%, transparent 56%),
        radial-gradient(900px 420px at 120% 120%, #fff7ed 0 60%, transparent 61%),
        #fff;
      padding:8px;                         /* để lộ viền ngoài */
      box-shadow:0 2px 10px #0001;
      overflow:hidden; position:relative;
    }

    /* Viền trong — đúng mẫu gốc: border 3px ở .bhtn-inner */
    #modalTheBHTN_Admin .bhtn-inner{
      box-sizing:border-box;
      height:100%;
      border:3px solid var(--orange);      /* = mẫu gốc */
      border-radius:12px;
      padding:16px 24px 24px;
      display:flex; flex-direction:column;
      /* nền mờ rất nhẹ để tạo chiều sâu, KHÔNG thay thế nền full ở .bhtn-card */
      background:linear-gradient(0deg, rgba(255,255,255,.65), rgba(255,255,255,.65));
    }

    #modalTheBHTN_Admin .bhtn-top{display:flex;align-items:center;justify-content:center;margin-bottom:4px}
    #modalTheBHTN_Admin .bhtn-logo{height:60px;object-fit:contain}

    /* Lưới 2 cột chuẩn mẫu */
    #modalTheBHTN_Admin .bhtn-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:22px;margin-top:6px}
    #modalTheBHTN_Admin .kv{display:flex;gap:12px;margin:8px 0;align-items:flex-start;line-height:1.25}
    #modalTheBHTN_Admin .kv .k{min-width:190px;color:#6b7280;font-weight:800}
    #modalTheBHTN_Admin .kv .v{color:#111827;font-weight:800}
    #modalTheBHTN_Admin .v-blue{color:#0b53ff!important}
    #modalTheBHTN_Admin .v-red{color:#e11d48!important}
    #modalTheBHTN_Admin .v-green{color:#0f9d58!important}

    #modalTheBHTN_Admin .bhtn-lop{font-size:56px;font-weight:900;color:#9ca3af;text-align:right}
    #modalTheBHTN_Admin .bhtn-stamp{margin-top:8px;text-align:center;font-weight:900;color:#16a34a;font-size:30px}
    #modalTheBHTN_Admin .bhtn-badge{margin-top:8px;display:flex;justify-content:center}
    #modalTheBHTN_Admin .bhtn-badge span{background:#fff3b0;border:2px solid #facc15;padding:8px 16px;border-radius:6px;font-weight:900;color:#1d4ed8}
    #modalTheBHTN_Admin .bhtn-qr{position:absolute;right:16px;bottom:16px;width:96px;height:96px;border:2px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:6px}

    /* Mobile: modal full màn + grid 1 cột; auto-scale vẫn hoạt động */
    @media (max-width: 576px){
      #modalTheBHTN_Admin .bhtn-grid{grid-template-columns:1fr;gap:10px}
      #modalTheBHTN_Admin .bhtn-lop{font-size:40px;text-align:left}
    }

    /* In */
    @media print{
      @page{size:A5 portrait;margin:10mm}
      #modalTheBHTN_Admin .modal{position:static!important}
      #modalTheBHTN_Admin .modal-content{box-shadow:none!important;border:none!important}
      #cardScaleWrapBHTN_Admin{transform:none!important}
    }

  </style>
  <!-- ====== /THẺ BHTN (Admin, theo mẫu) ====== -->



  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="brand mb-3">
        <div class="logo"><i class="bi bi-shield-check"></i></div>
        <div>
          <div class="name">ABT Medu</div>
          <div class="small" style="opacity:.8">Admin trường</div>
        </div>
      </div>

      <div class="sidebar-scroll">
        <div class="nav-section" id="sidebarMenu">
          <div class="nav-item active" data-page="overview"><i class="bi bi-speedometer2"></i><span>Tổng quan</span></div>
          <div class="nav-item" data-page="students"><i class="bi bi-people"></i><span>Danh sách học sinh</span></div>
          <div class="nav-item" data-page="others"><i class="bi bi-people"></i><span>Ds Đối tượng khác</span></div>
          <div class="nav-item" data-page="teachers"><i class="bi bi-person-badge"></i><span>Danh sách giáo viên</span></div>
          <div class="nav-item" data-page="bhyt"><i class="bi bi-hospital"></i><span>Bảo hiểm y tế</span></div>
          <div class="nav-item" data-page="bhtn"><i class="bi bi-heart-pulse"></i><span>Bảo Hiểm Tai Nạn</span></div>
          <div class="nav-item" data-page="stats"><i class="bi bi-bar-chart"></i><span>Thống kê</span></div>
          <div class="nav-item" data-page="rewards"><i class="bi bi-cash-coin"></i><span>Thù lao</span></div>
          <div class="nav-item" data-page="profile"><i class="bi bi-person-badge"></i><span>Cá nhân</span></div>
          <div class="nav-item" data-page="settings"><i class="bi bi-gear-wide-connected"></i><span>Cài đặt</span></div>
        </div>
      </div>

      <div class="sidebar-bottom">
        <hr>
        <div class="nav-item" id="btnLogout"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></div>
        <footer>Copyright &copy; ABT Medu 2025</footer>
      </div>
    </aside>

    <div class="backdrop" id="backdrop"></div>

    <!-- Content -->
    <main class="content w-100">

      <!-- NỘI DUNG ĐẦU TRANG DASHBOARD -->
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <button id="btnToggleSidebar" class="btn btn-light border toggle-btn">
            <i class="bi bi-list"></i>
          </button>
          <div class="page-title h4 mb-1">Bảng điều khiển – <span id="schoolName">Trường ...</span></div>
          <div class="sub-muted">Người dùng: <strong id="userName">—</strong> • Quyền: <span id="userRole">admin</span></div>
        </div>
      </div>

      <!-- TRANG TỔNG QUAN (default) -->
      <section id="page-overview">
        <!-- Top split: KPIs + Filters -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 fw-bold mb-0">Tổng quan</div>
          <button id="btnOverviewReload" class="btn btn-sm btn-primary">
            <i class="bi bi-arrow-repeat"></i> Tải lại
          </button>
        </div>


        <div class="top-split mb-3">
          <!-- Left: KPIs (5 cards) -->
          <div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="icon ic-emerald"><i class="bi bi-people"></i></div>
                <div>
                  <div class="val" id="kpiStudents">0</div>
                  <div class="lbl">Tổng số học sinh</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-indigo"><i class="bi bi-hospital"></i></div>
                <div>
                  <div class="val" id="kpiBHYTCount">0</div>
                  <div class="lbl">Tổng số BHYT đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-orange"><i class="bi bi-heart-pulse"></i></div>
                <div>
                  <div class="val" id="kpiBHTNCount">0</div>
                  <div class="lbl">Tổng số BHTN đã thu</div>
                </div>
              </div>

              <div class="kpi-card">
                <div class="icon ic-amber"><i class="bi bi-people"></i></div>
                <div>
                  <div class="val" id="kpiOther">0</div>
                  <div class="lbl">Đối tượng khác</div>
                </div>
              </div>


              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer2"></i></div>
                <div>
                  <div class="val" id="progressBHYTText">0%</div>
                  <div class="lbl">Tiến độ thu BHYT</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                <div>
                  <div class="val" id="progressBHTNTextCard">0%</div>
                  <div class="lbl">Tiến độ thu BHTN</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Filters only -->
          <div class="panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">Bộ lọc dữ liệu</div>
              <small class="text-secondary">Áp dụng cho bảng xếp hạng</small>
            </div>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="filterScope" style="width:auto">
                <option value="school" selected>Cả trường</option>
                <option value="class">Theo lớp</option>
              </select>
              <select class="form-select form-select-sm d-none" id="filterClass" style="width:auto"></select>
            </div>
          </div>
        </div>

        <!-- Rankings -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-primary">BHYT</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHYT"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-warning">BHTN</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHTN"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Users overview -->
        <div class="mt-3">
          <div class="fw-bold mb-2">Tổng quan người dùng</div>
          <div class="user-grid">
            <div class="user-card uc-all">
              <div class="icon"><i class="bi bi-people-fill"></i></div>
              <div>
                <div class="val" id="uAll">0</div>
                <div class="lbl">Tổng user của trường</div>
              </div>
            </div>
            <div class="user-card uc-admin">
              <div class="icon"><i class="bi bi-building-gear"></i></div>
              <div>
                <div class="val" id="uAdmin">0</div>
                <div class="lbl">Số Admin trường</div>
              </div>
            </div>
            <div class="user-card uc-teacher">
              <div class="icon"><i class="bi bi-mortarboard"></i></div>
              <div>
                <div class="val" id="uTeacher">0</div>
                <div class="lbl">Số giáo viên</div>
              </div>
            </div>
            <div class="user-card uc-parent">
              <div class="icon"><i class="bi bi-person-heart"></i></div>
              <div>
                <div class="val" id="uParent">0</div>
                <div class="lbl">Số phụ huynh</div>
              </div>
            </div>
            <div class="user-card">
              <div class="icon" style="background:#22c55e;"><i class="bi bi-emoji-smile"></i></div>
              <div>
                <div class="val" id="uStudent">0</div>
                <div class="lbl">Số học sinh</div>
              </div>
            </div>
          </div>
        </div>
      </section>










      <!-- DANH SÁCH HỌC SINH (embedded, for admin) -->
      <section id="page-students" class="d-none">
        <div class="mb-2">
          <div class="h5 fw-bold mb-2">Danh sách học sinh</div>

          <!-- Hàng filter + search + actions (giống ds_hocsinh.html) -->
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <input id="adm-loc-lop" class="form-control" style="max-width:280px" placeholder="Lọc theo lớp (để trống = tất cả)" list="admClassList">
            <datalist id="admClassList"></datalist>

            <input id="adm-search" class="form-control flex-grow-1" placeholder="Tìm theo tên, BHXH, SĐT, Số định danh..." />

            <button id="adm-btn-reload" class="btn btn-primary">Tải lại</button>
            <button id="adm-btn-add" class="btn btn-success">Thêm học sinh</button>
            <button id="adm-btn-import" class="btn btn-outline-primary">Nhập Excel</button>
            <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
            <button id="adm-btn-delmany" class="btn btn-danger d-none">Xóa đã chọn</button>
          </div>

          <div class="text-secondary mb-2">Lớp: <span id="adm-lop-text">tất cả</span> • Tổng: <span id="adm-total">0</span></div>

          <div id="adm-tablebox" class="table-responsive table-box p-0"></div>
          <nav class="mt-2"><ul class="pagination justify-content-center" id="adm-pagin"></ul></nav>
        </div>

        <!-- Modal Thêm -->
        <div class="modal fade" id="admModalAdd" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Thêm mới học sinh</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="adm-form-add" onsubmit="event.preventDefault();">
                <div class="row g-2">
                  <div class="col-md-4"><label class="form-label">Mã số BHXH</label><input class="form-control" id="add-msbhxh"></div>
                  <div class="col-md-4"><label class="form-label">Họ tên</label><input class="form-control" id="add-hoten"></div>
                  <div class="col-md-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="add-ngaysinh" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>

                  <div class="col-md-4">
                    <label class="form-label d-block">Giới tính</label>
                    <div class="d-flex gap-3">
                      <div class="form-check"><input class="form-check-input" type="radio" name="add_gt" id="add-gt-nam" value="Nam" checked><label class="form-check-label" for="add-gt-nam">Nam</label></div>
                      <div class="form-check"><input class="form-check-input" type="radio" name="add_gt" id="add-gt-nu" value="Nữ"><label class="form-check-label" for="add-gt-nu">Nữ</label></div>
                    </div>
                  </div>
                  <div class="col-md-4"><label class="form-label">Lớp</label><input class="form-control" id="add-lop" list="admClassList" placeholder="VD: 3A"></div>
                  <div class="col-md-4"><label class="form-label">Địa chỉ</label><input class="form-control" id="add-diachi"></div>

                  <div class="col-md-4"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="add-sdt"></div>
                  <div class="col-md-4"><label class="form-label">Số định danh</label><input class="form-control" id="add-sdd"></div>
                  <div class="col-md-4"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="add-chaMe"></div>

                  <div class="col-md-4"><label class="form-label">Hạn BHYT</label><input class="form-control" id="add-bhyt" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Hạn BHTN</label><input class="form-control" id="add-bhtn" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="add-noikham"></div>

                  <div class="col-md-6"><label class="form-label">Đối tượng đóng (tùy chọn)</label><input class="form-control" id="add-doituong"></div>
                  <div class="col-md-6"><label class="form-label">Ghi chú (tùy chọn)</label><input class="form-control" id="add-ghichu"></div>
                </div>
              </form>
              <div id="adm-add-err" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-add-save" class="btn btn-primary">Thêm mới</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Sửa -->
        <div class="modal fade" id="admModalEdit" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Sửa thông tin học sinh</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="adm-form-edit" onsubmit="event.preventDefault();">
                <input type="hidden" id="edit-stt">
                <div class="row g-2">
                  <div class="col-md-4"><label class="form-label">Mã số BHXH</label><input class="form-control" id="edit-msbhxh"></div>
                  <div class="col-md-4"><label class="form-label">Họ tên</label><input class="form-control" id="edit-hoten"></div>
                  <div class="col-md-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="edit-ngaysinh" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>

                  <div class="col-md-4">
                    <label class="form-label d-block">Giới tính</label>
                    <div class="d-flex gap-3">
                      <div class="form-check"><input class="form-check-input" type="radio" name="edit_gt" id="edit-gt-nam" value="Nam"><label class="form-check-label" for="edit-gt-nam">Nam</label></div>
                      <div class="form-check"><input class="form-check-input" type="radio" name="edit_gt" id="edit-gt-nu" value="Nữ"><label class="form-check-label" for="edit-gt-nu">Nữ</label></div>
                    </div>
                  </div>
                  <div class="col-md-4"><label class="form-label">Lớp</label><input class="form-control" id="edit-lop" list="admClassList"></div>
                  <div class="col-md-4"><label class="form-label">Địa chỉ</label><input class="form-control" id="edit-diachi"></div>

                  <div class="col-md-4"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="edit-sdt"></div>
                  <div class="col-md-4"><label class="form-label">Số định danh</label><input class="form-control" id="edit-sdd"></div>
                  <div class="col-md-4"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="edit-chaMe"></div>

                  <div class="col-md-4"><label class="form-label">Hạn BHYT</label><input class="form-control" id="edit-bhyt" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Hạn BHTN</label><input class="form-control" id="edit-bhtn" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="edit-noikham"></div>

                  <div class="col-md-6"><label class="form-label">Đối tượng đóng (tùy chọn)</label><input class="form-control" id="edit-doituong"></div>
                  <div class="col-md-6"><label class="form-label">Ghi chú (tùy chọn)</label><input class="form-control" id="edit-ghichu"></div>
                </div>
              </form>
              <div id="adm-edit-err" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-edit-save" class="btn btn-primary">Lưu thay đổi</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Import -->
        <div class="modal fade" id="admModalImport" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <input type="file" id="adm-import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
              <div id="adm-import-err" class="text-danger" style="min-height:20px;"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-import-run" class="btn btn-primary">Nhập danh sách</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Xác nhận dùng cho danh sách học sinh -->
        <div class="modal fade" id="admModalConfirm" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header bg-danger text-white"><h5 class="modal-title" id="admConfirmTitle">Xác nhận xóa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="admConfirmBody"></div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
              <button id="admConfirmBtn" class="btn btn-danger">Đồng ý</button>
            </div>
          </div></div>
        </div>
      </section>
      <!-- DANH SÁCH HỌC SINH (embedded, for admin) -->








      <!-- DANH SÁCH ĐỐI TƯỢNG KHÁC (embedded, for admin) -->
      <section id="page-others" class="container-fluid d-none">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
          <label class="mb-0 fw-semibold">Chọn lớp:</label>
          <select id="others-classes" multiple class="form-select" style="min-width:260px; max-width:420px;"></select>

          <button id="others-btn-filter" class="btn btn-primary">
            <i class="bi bi-arrow-repeat"></i> Tải danh sách
          </button>

          <button id="others-btn-all" class="btn btn-info">
            <i class="bi bi-building"></i> Toàn trường
          </button>

          <button id="others-btn-export" class="btn btn-success">
            <i class="bi bi-file-earmark-spreadsheet"></i> Xuất Excel theo mẫu
          </button>

          <div class="small text-muted ms-2">
            Giữ <b>Ctrl/Cmd</b> để chọn nhiều. Bấm nút <b>“Toàn trường”</b> để xem toàn bộ lớp.
          </div>

          <div class="ms-auto d-flex align-items-center gap-2">
            <input id="others-search" class="form-control" placeholder="Tìm tên / SĐD / Mã BHXH...">
            <span class="text-muted">Tổng: <b id="others-total">0</b></span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle" id="others-table">
            <thead class="table-light">
              <tr>
                <th style="width:72px">Stt</th>
                <th>Họ và tên</th>
                <th>Ngày sinh</th>
                <th>Đối tượng</th>
                <th>Số định danh</th>
                <th>Mã thẻ BHYT</th>
                <th>Lớp</th>
                <th>Nơi KCB ban đầu</th>
                <th>Hạn dùng BHYT</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <nav class="mt-3">
          <ul id="others-pagin" class="pagination justify-content-center"></ul>
        </nav>
      </section>
      <!-- DANH SÁCH ĐỐI TƯỢNG KHÁC (embedded, for admin) -->






      <section id="page-teachers" class="d-none">
        <div class="panel"><div>Danh sách giáo viên (đang phát triển).</div></div>
      </section>









      <!-- BẢO HIỂM Y TẾ (embedded, for admin) -->
      <section id="page-bhyt" class="d-none">
        <div class="mb-2">
          <div class="h5 fw-bold">Bảo hiểm y tế</div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="bhytTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-unpaid-tab" data-bs-toggle="tab"
                    data-bs-target="#tab-unpaid" type="button" role="tab"
                    aria-controls="tab-unpaid" aria-selected="true">
              Danh sách BHYT chưa thu
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-other-tab" data-bs-toggle="tab"
                    data-bs-target="#tab-other" type="button" role="tab"
                    aria-controls="tab-other" aria-selected="false">
              Danh sách BHYT Đã thu
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- TAB 1: DANH SÁCH BHYT CHƯA THU -->
          <div class="tab-pane fade show active" id="tab-unpaid" role="tabpanel" aria-labelledby="tab-unpaid-tab">
            <!-- Sticky header + search + chọn nhiều lớp -->
            <div class="table-box p-3 mb-2">
              <div class="row g-2 align-items-center">
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
                  <select id="bhyt-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
                  <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Tìm kiếm</label>
                  <input class="form-control" id="bhyt-search" placeholder="Tìm theo tên, ngày sinh, số định danh..." />
                </div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button id="bhyt-btn-reload" class="btn btn-primary">
                  <i class="bi bi-arrow-repeat"></i> Tải danh sách
                </button>

                <!-- NEW: nút chọn toàn trường -->
                <button id="bhyt-btn-all" class="btn btn-info">
                  <i class="bi bi-building"></i> Toàn trường
                </button>

                <button id="btn-bulk-submit" class="btn btn-success" style="display:none" onclick="showBulkNopHoSoModal()">
                  Nộp nhiều hồ sơ (0)
                </button>

                <div class="ms-auto text-secondary">Tổng: <span id="bhyt-total">0</span> học sinh</div>
              </div>
            </div>

            <!-- Danh sách -->
            <div class="table-responsive table-box p-0" id="bhyt-ds"></div>
            <nav class="mt-2">
              <ul class="pagination justify-content-center" id="bhyt-pagin"></ul>
            </nav>

            <!-- === Các modal y nguyên từ trang nguồn === -->
            <!-- Nộp hồ sơ BHYT -->
            <div class="modal fade" id="modalNopHoSoBHYT" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog"><div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nộp hồ sơ BHYT</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="nhs-hoten" readonly></div>
                  <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="nhs-ngaysinh" readonly></div>
                  <div class="mb-2">
                    <label>Nơi khám BHYT:</label>
                    <input class="form-control" id="nhs-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT">
                    <datalist id="noikham-list"></datalist>
                  </div>
                  <div class="mb-2">
                    <label>Số tháng đóng:</label>
                    <div>
                      <input type="radio" name="nhs-thang" value="3" id="nhs-thang-3"> <label for="nhs-thang-3">3 tháng</label>
                      <input type="radio" name="nhs-thang" value="6" id="nhs-thang-6" class="ms-3"> <label for="nhs-thang-6">6 tháng</label>
                      <input type="radio" name="nhs-thang" value="12" id="nhs-thang-12" class="ms-3" checked> <label for="nhs-thang-12">12 tháng</label>
                    </div>
                  </div>
                  <div class="mt-2 small">
                    <div><strong>Hạn sử dụng dự kiến:</strong> <span id="nhs-exp-preview" class="fw-bold text-danger">—</span></div>
                    <div id="nhs-exp-note" class="text-muted" style="min-height:18px"></div>
                    <div><strong>Số tiền cần đóng:</strong> <span id="nhs-amount-preview" class="fw-bold text-danger">—</span></div>
                  </div>
                  <div id="nhs-error" class="text-danger" style="min-height:18px"></div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                  <button class="btn btn-primary" id="btnNopHoSo" onclick="submitNopHoSoBHYT()">Nộp hồ sơ</button>
                </div>
              </div></div>
            </div>

            <!-- Sửa hồ sơ BHYT -->
            <div class="modal fade" id="modalSuaHoSoBHYT" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog"><div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHYT</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="shs-hoten" readonly></div>
                  <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="shs-ngaysinh" readonly></div>
                  <div class="mb-2"><label>Nơi khám BHYT:</label><input class="form-control" id="shs-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT"></div>
                  <div class="mb-2">
                    <label>Số tháng đóng:</label>
                    <div>
                      <input type="radio" name="shs-thang" value="3" id="shs-thang-3"> <label for="shs-thang-3">3 tháng</label>
                      <input type="radio" name="shs-thang" value="6" id="shs-thang-6" class="ms-3"> <label for="shs-thang-6">6 tháng</label>
                      <input type="radio" name="shs-thang" value="12" id="shs-thang-12" class="ms-3"> <label for="shs-thang-12">12 tháng</label>
                    </div>
                  </div>
                  <div class="mt-2 small">
                    <div><strong>Hạn sử dụng dự kiến:</strong> <span id="shs-exp-preview" class="fw-bold text-danger">—</span></div>
                    <div id="shs-exp-note" class="text-muted" style="min-height:18px"></div>
                    <div><strong>Số tiền cần đóng:</strong> <span id="shs-amount-preview" class="fw-bold text-danger">—</span></div>
                  </div>
                  <div id="shs-error" class="text-danger" style="min-height:18px"></div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                  <button class="btn btn-primary" onclick="submitSuaHoSoBHYT()">Lưu thay đổi</button>
                </div>
              </div></div>
            </div>

            <!-- Nộp nhiều hồ sơ -->
            <div class="modal fade" id="modalBulkNopHoSo" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog"><div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Nộp nhiều hồ sơ BHYT</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><b>Đã chọn:</b> <span id="bulk-count-label">0</span> học sinh</div>
                  <div class="mb-2"><label>Nơi khám BHYT (áp dụng chung):</label><input class="form-control" id="bulk-noikham" list="noikham-list" placeholder="Có thể để trống"></div>
                  <div class="mb-2">
                    <label>Số tháng đóng (áp dụng chung):</label>
                    <div>
                      <input type="radio" name="bulk-thang" value="3" id="bulk-thang-3"> <label for="bulk-thang-3">3 tháng</label>
                      <input type="radio" name="bulk-thang" value="6" id="bulk-thang-6" class="ms-3"> <label for="bulk-thang-6">6 tháng</label>
                      <input type="radio" name="bulk-thang" value="12" id="bulk-thang-12" class="ms-3" checked> <label for="bulk-thang-12">12 tháng</label>
                    </div>
                  </div>
                  <div class="mt-2 small">
                    <div><strong class="text-danger">Hạn sử dụng dự kiến:</strong> <span id="bulk-exp-preview" class="fw-bold text-danger">—</span></div>
                    <div id="bulk-exp-note" class="text-muted" style="min-height:18px"></div>
                    <div><strong class="text-danger">Số tiền cần đóng (mỗi HS):</strong> <span id="bulk-amount-preview" class="fw-bold text-danger">—</span></div>
                  </div>
                  <div id="bulk-error" class="text-danger" style="min-height:18px"></div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                  <button class="btn btn-primary" id="btnBulkNop" onclick="submitBulkNopHoSo()">Nộp nhiều hồ sơ</button>
                </div>
              </div></div>
            </div>

            <!-- Xem trước & in Phiếu thu A5 cho BHYT -->
            <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-xl">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
                    <div class="no-print d-flex gap-2">
                      <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
                      <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body" style="display:flex;justify-content:center;">
                    <div id="receiptA5" class="a5-paper">
                      <div class="row">
                        <div class="col">
                          <div class="receipt-meta">
                            <div><strong id="rec-school">Trường …</strong></div>
                            <div>Lớp: <strong id="rec-class">—</strong></div>
                          </div>
                        </div>
                        <div class="col text-center">
                          <div class="receipt-meta">
                            <div><strong>Mẫu số:</strong> C45-BB</div>
                            <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                            <div>ngày 10/10/2017 của Bộ Tài Chính</div>
                          </div>
                        </div>
                      </div>
                      <div class="row align-items-center mt-3">
                        <div class="col-4" style="max-width:36mm"><div class="qr-box"><div id="receipt-qr"></div></div></div>
                        <div class="col text-center">
                          <div class="receipt-title">BIÊN LAI THU TIỀN</div>
                          <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
                        <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
                        <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
                        <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
                        <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
                        <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
                      </div>
                      <div class="row">
                        <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
                        <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer no-print">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
                    <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB 2: DANH SÁCH BHYT ĐÃ THU -->
          <div class="tab-pane fade" id="tab-other" role="tabpanel" aria-labelledby="tab-other-tab">
            <div class="table-box p-3 mb-2">
              <div class="row g-2 align-items-center">
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
                  <select id="bhytp-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
                  <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Tìm kiếm</label>
                  <input class="form-control" id="bhytp-search" placeholder="Tìm theo tên, ngày sinh, số định danh, nơi khám..." />
                </div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button id="bhytp-btn-reload" class="btn btn-primary">
                  <i class="bi bi-arrow-repeat"></i> Tải danh sách
                </button>
                <button id="bhytp-btn-all" class="btn btn-info">
                  <i class="bi bi-building"></i> Toàn trường
                </button>
                <div class="ms-auto text-secondary">Tổng: <span id="bhytp-total">0</span> hồ sơ</div>
              </div>
            </div>

            <div class="table-responsive table-box p-0" id="bhytp-ds"></div>
            <nav class="mt-2">
              <ul class="pagination justify-content-center" id="bhytp-pagin"></ul>
            </nav>

            <!-- Modal XEM THẺ BHYT (riêng, không trùng ID) -->
            <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
                    <div class="d-flex gap-2">
                      <button class="btn btn-secondary btn-sm" onclick="bhytp_downloadCardImage()">Lưu ảnh thẻ</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div id="cardScaleWrap">
                      <div id="cardArea" class="bhyt-card">
                        <div class="bhyt-inner">
                          <div class="bhyt-top">
                            <div class="bhyt-logo-wrap">
                              <div class="bhyt-logo"><img id="c-logo" src="../assets/image/bhxh-logo.png" alt="BHXH VN"></div>
                              <div class="bhyt-obj" id="c-doituong">Học sinh</div>
                            </div>
                            <div class="bhyt-title">THẺ BẢO HIỂM Y TẾ</div>
                            <div class="bhyt-lop-big" id="c-lop-big"></div>
                          </div>
                          <div class="bhyt-ms">Mã số: <span id="c-ms">—</span></div>
                          <div class="bhyt-sdd-line">Số định danh:<span class="bhyt-sdd" id="c-sdd">—</span></div>
                          <div class="bhyt-grid">
                            <div class="bhyt-col">
                              <div class="kv"><div class="k">Họ và tên</div><div class="v" id="c-hoten">—</div></div>
                              <div class="kv"><div class="k">Ngày sinh</div><div class="v" id="c-ngaysinh">—</div></div>
                              <div class="kv"><div class="k">Nơi ĐK KCB BĐ</div><div class="v" id="c-noikham">—</div></div>
                              <div class="kv"><div class="k">Sử dụng từ</div><div class="v v-blue" id="c-tu">—</div></div>
                              <div class="kv"><div class="k">Ngày hết hạn</div><div class="v v-red" id="c-den">—</div></div>
                              <div class="kv"><div class="k">Địa chỉ</div><div class="v" id="c-diachi">—</div></div>
                              <div class="kv"><div class="k">Điện thoại</div><div class="v" id="c-sdt">—</div></div>
                              <div class="kv"><div class="k">Ghi chú</div><div class="v" id="c-ghichu">—</div></div>
                            </div>
                            <div class="bhyt-col">
                              <div class="kv"><div class="k">Giới tính</div><div class="v" id="c-gioitinh">—</div></div>
                              <div class="kv"><div class="k">Lớp</div><div class="v" id="c-lop">—</div></div>
                              <div class="kv"><div class="k">Số tháng đóng</div><div class="v" id="c-thang">—</div></div>
                              <div class="kv"><div class="k">Số tiền đóng</div><div class="v v-green" id="c-sotien">—</div></div>
                              <div class="kv"><div class="k">Trường</div><div class="v" id="c-truong">—</div></div>
                              <div class="kv"><div class="k">QR</div><div class="v" id="card-qr"></div></div>
                            </div>
                          </div>
                          <div class="bhyt-footer">
                            <div class="bhyt-stamp">ĐÃ KÍCH HOẠT</div>
                            <div class="bhyt-sohoso" id="c-sohoso">—</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <div class="d-flex gap-2"><button class="btn btn-secondary btn-sm" onclick="bhytp_downloadCardImage()">Lưu ảnh thẻ</button></div>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                  </div>
                </div>
              </div>
            </div>


            <!-- Modal Sửa hồ sơ - TAB ĐÃ THU (đồng bộ với bản gốc) -->
            <div class="modal fade" id="modalSuaHoSoBHYT_DaThu" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog"><div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHYT (đã thu)</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="shspaid-hoten" readonly></div>
                  <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="shspaid-ngaysinh" readonly></div>
                  <div class="mb-2"><label>Nơi khám BHYT:</label><input class="form-control" id="shspaid-noikham" list="noikham-list" placeholder="Nhập nơi khám BHYT"></div>
                  <div class="mb-2">
                    <label>Số tháng đóng:</label>
                    <div>
                      <input type="radio" name="shspaid-thang" value="3" id="shspaid-thang-3"> <label for="shspaid-thang-3">3 tháng</label>
                      <input type="radio" name="shspaid-thang" value="6" id="shspaid-thang-6" class="ms-3"> <label for="shspaid-thang-6">6 tháng</label>
                      <input type="radio" name="shspaid-thang" value="12" id="shspaid-thang-12" class="ms-3"> <label for="shspaid-thang-12">12 tháng</label>
                    </div>
                  </div>
                  <div class="mt-2 small">
                    <div><strong>Hạn sử dụng dự kiến:</strong> <span id="shspaid-exp-preview" class="fw-bold text-danger">—</span></div>
                    <div id="shspaid-exp-note" class="text-muted" style="min-height:18px"></div>
                    <div><strong>Số tiền cần đóng:</strong> <span id="shspaid-amount-preview" class="fw-bold text-danger">—</span></div>
                  </div>
                  <hr>
                  <div class="mb-3">
                    <label for="shspaid-sohoso" class="form-label">Số hồ sơ</label>
                    <input type="text" class="form-control" id="shspaid-sohoso" placeholder="">
                    <div class="form-text text-danger" style="font-weight: bold;">
                      Nếu mã hồ sơ đã kích hoạt thì nhập mã hồ sơ vào đây
                    </div>
                  </div>
                  <div id="shspaid-error" class="text-danger" style="min-height:18px"></div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                  <button class="btn btn-primary" onclick="submitSuaHoSoBHYT_DaThu()">Lưu thay đổi</button>
                </div>
              </div></div>
            </div>


          </div>

        </div>


        <!-- Modal xác nhận xóa cho BHYT -->
        <div class="modal fade" id="bhytModalConfirm" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="bhytConfirmTitle">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="bhytConfirmBody"></div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button id="bhytConfirmBtn" class="btn btn-danger">Đồng ý</button>
              </div>
            </div>
          </div>
        </div>


        <div id="_printArea"></div>
        
      </section>
      <!-- BẢO HIỂM Y TẾ (embedded, for admin) -->





      



      <!-- BẢO HIỂM TAI NẠN (embedded, for admin) -->
      <section id="page-bhtn" class="d-none">
        <div class="mb-2">
          <div class="h5 fw-bold">Bảo hiểm tai nạn</div>
        </div>

        <ul class="nav nav-tabs" id="bhtnTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="bhtn-unpaid-tab" data-bs-toggle="tab"
                    data-bs-target="#bhtn-unpaid" type="button" role="tab"
                    aria-controls="bhtn-unpaid" aria-selected="true">
              Danh sách BHTN chưa thu
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="bhtn-paid-tab" data-bs-toggle="tab"
                    data-bs-target="#bhtn-paid" type="button" role="tab"
                    aria-controls="bhtn-paid" aria-selected="false">
              Danh sách BHTN Đã thu
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- TAB: BHTN CHƯA THU -->
          <div class="tab-pane fade show active" id="bhtn-unpaid" role="tabpanel" aria-labelledby="bhtn-unpaid-tab">
            <div class="table-box p-3 mb-2">
              <div class="row g-2 align-items-center">
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
                  <select id="bhtn-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
                  <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Tìm kiếm</label>
                  <input class="form-control" id="bhtn-search" placeholder="Tìm theo tên, ngày sinh, số định danh..." />
                </div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button id="bhtn-btn-reload" class="btn btn-primary">
                  <i class="bi bi-arrow-repeat"></i> Tải danh sách
                </button>
                <button id="bhtn-btn-all" class="btn btn-info">
                  <i class="bi bi-building"></i> Toàn trường
                </button>
                <button id="bhtn-btn-bulk" class="btn btn-success" style="display:none" onclick="bhtn_showBulkModal()">
                  Nộp nhiều hồ sơ (0)
                </button>
                <div class="ms-auto text-secondary">Tổng: <span id="bhtn-total">0</span> học sinh</div>
              </div>
            </div>

            <div class="table-responsive table-box p-0" id="bhtn-ds"></div>
            <nav class="mt-2">
              <ul class="pagination justify-content-center" id="bhtn-pagin"></ul>
            </nav>
          </div>

          <!-- TAB: BHTN ĐÃ THU -->
          <div class="tab-pane fade" id="bhtn-paid" role="tabpanel" aria-labelledby="bhtn-paid-tab">
            <div class="table-box p-3 mb-2">
              <div class="row g-2 align-items-center">
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
                  <select id="bhtnp-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
                  <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label fw-semibold">Tìm kiếm</label>
                  <input class="form-control" id="bhtnp-search" placeholder="Tìm theo tên, ngày sinh, số định danh, đối tượng..." />
                </div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button id="bhtnp-btn-reload" class="btn btn-primary">
                  <i class="bi bi-arrow-repeat"></i> Tải danh sách
                </button>
                <button id="bhtnp-btn-all" class="btn btn-info">
                  <i class="bi bi-building"></i> Toàn trường
                </button>
                <div class="ms-auto text-secondary">Tổng: <span id="bhtnp-total">0</span> hồ sơ</div>
              </div>
            </div>

            <div class="table-responsive table-box p-0" id="bhtnp-ds"></div>
            <nav class="mt-2">
              <ul class="pagination justify-content-center" id="bhtnp-pagin"></ul>
            </nav>
          </div>
        </div>
      </section>


      <!-- Modal Nộp hồ sơ BHTN -->
      <div class="modal fade" id="modalNopHoSoBHTN_Admin" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Nộp hồ sơ BHTN</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="bhtn-nhs-hoten" readonly></div>
            <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="bhtn-nhs-ngaysinh" readonly></div>
            <div class="mt-2 small">
              <div><strong>Số tháng đóng:</strong> 12 tháng</div>
              <div><strong>Hạn sử dụng dự kiến:</strong> <span id="bhtn-nhs-exp" class="fw-bold text-danger">—</span></div>
              <div id="bhtn-nhs-expnote" class="text-muted" style="min-height:18px"></div>
              <div><strong>Số tiền cần đóng (12T):</strong> <span id="bhtn-nhs-amount" class="fw-bold text-danger">—</span></div>
            </div>
            <div class="mt-3">
              <label class="fw-semibold d-block mb-2">Đối tượng đóng:</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bhtn-nhs-cat" id="bhtn-nhs-cat-hs" value="Học sinh" checked>
                <label class="form-check-label" for="bhtn-nhs-cat-hs">Học sinh</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bhtn-nhs-cat" id="bhtn-nhs-cat-cn" value="Cận nghèo">
                <label class="form-check-label" for="bhtn-nhs-cat-cn">Cận nghèo</label>
              </div>
            </div>
            <div id="bhtn-nhs-error" class="text-danger" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" id="bhtn-btn-nop" onclick="bhtn_submitNop()">Nộp hồ sơ</button>
          </div>
        </div></div>
      </div>

      <!-- Modal Sửa hồ sơ BHTN -->
      <div class="modal fade" id="modalSuaHoSoBHTN_Admin" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHTN</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="bhtn-shs-hoten" readonly></div>
            <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="bhtn-shs-ngaysinh" readonly></div>
            <div class="mt-2 small">
              <div><strong>Số tháng đóng:</strong> 12 tháng</div>
              <div><strong>Hạn sử dụng dự kiến:</strong> <span id="bhtn-shs-exp" class="fw-bold text-danger">—</span></div>
              <div id="bhtn-shs-expnote" class="text-muted" style="min-height:18px"></div>
              <div><strong>Số tiền cần đóng (12T):</strong> <span id="bhtn-shs-amount" class="fw-bold text-danger">—</span></div>
            </div>
            <div class="mt-3">
              <label class="fw-semibold d-block mb-2">Đối tượng đóng:</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bhtn-shs-cat" id="bhtn-shs-cat-hs" value="Học sinh" checked>
                <label class="form-check-label" for="bhtn-shs-cat-hs">Học sinh</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="bhtn-shs-cat" id="bhtn-shs-cat-cn" value="Cận nghèo">
                <label class="form-check-label" for="bhtn-shs-cat-cn">Cận nghèo</label>
              </div>
            </div>
            <div id="bhtn-shs-error" class="text-danger" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" onclick="bhtn_submitSua()">Lưu thay đổi</button>
          </div>
        </div></div>
      </div>

      <!-- Modal Nộp nhiều hồ sơ BHTN -->
      <div class="modal fade" id="modalBulkNopHoSoBHTN_Admin" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nộp nhiều hồ sơ BHTN</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><b>Đã chọn:</b> <span id="bhtn-bulk-count">0</span> học sinh</div>
            <div class="mt-2 small">
              <div><strong class="text-danger">Số tháng đóng:</strong> 12 tháng</div>
              <div><strong class="text-danger">Hạn sử dụng dự kiến (mẫu 1 HS):</strong> <span id="bhtn-bulk-exp" class="fw-bold text-danger">—</span></div>
              <div id="bhtn-bulk-expnote" class="text-muted" style="min-height:18px"></div>
              <div><strong class="text-danger">Số tiền cần đóng (mỗi HS, 12T):</strong> <span id="bhtn-bulk-amount" class="fw-bold text-danger">—</span></div>
            </div>
            <div id="bhtn-bulk-error" class="text-danger" style="min-height:18px"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" id="bhtn-btn-bulk-nop" onclick="bhtn_submitBulk()">Nộp nhiều hồ sơ</button>
          </div>
        </div></div>
      </div>

      <!-- Modal THẺ BHTN (Đã thu) -->
      <div class="modal fade" id="modalTheBHTN_Admin" tabindex="-1" aria-hidden="true" role="dialog" aria-labelledby="titleTheBHTN_Admin">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-sm-down">
          <div class="modal-content">
            <div class="modal-header">
              <h5 id="titleTheBHTN_Admin" class="modal-title">Thẻ bảo hiểm tai nạn</h5>
              <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-secondary btn-sm" onclick="bhtnp_downloadCardImage()">Lưu ảnh thẻ</button>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
              </div>
            </div>

            <div class="modal-body">
              <!-- Card layout copy từ ds_hocsinh_dathu_bhtn_giaovien -->
              <div id="cardScaleWrapBHTN_Admin" style="position:relative;width:900px;height:560px;transform-origin:top left;margin:0 auto">
                <div id="cardAreaBHTN_Admin" class="bhtn-card">
                  <div class="bhtn-inner">
                    <div class="bhtn-top">
                      <img class="bhtn-logo" src="../assets/image/baoviet-logo.png" alt="BAOVIET" onerror="this.style.display='none'">
                    </div>

                    <div class="kv"><div class="k">Đối tượng đóng</div><div class="v" id="c-doituong-bhtn">—</div></div>
                    <div class="kv"><div class="k">Số thẻ</div><div class="v v-blue" id="c-so-the-bhtn">—</div></div>

                    <div class="bhtn-grid">
                      <div>
                        <div class="kv"><div class="k">Họ và tên</div><div class="v" id="c-hoten-bhtn">—</div></div>
                        <div class="kv"><div class="k">Ngày sinh</div><div class="v" id="c-ngaysinh-bhtn">—</div></div>
                        <div class="kv"><div class="k">Sử dụng từ</div><div class="v v-blue" id="c-tu-bhtn">—</div></div>
                        <div class="kv"><div class="k">Ngày hết hạn</div><div class="v v-red" id="c-den-bhtn">—</div></div>
                        <div class="kv"><div class="k">Địa chỉ</div><div class="v" id="c-diachi-bhtn">—</div></div>
                        <div class="kv"><div class="k">Điện thoại</div><div class="v" id="c-sdt-bhtn">—</div></div>
                        <div class="kv"><div class="k">Tên Cha/Mẹ</div><div class="v" id="c-tencha-bhtn">—</div></div>
                      </div>
                      <div>
                        <div class="kv"><div class="k">Giới tính</div><div class="v" id="c-gioitinh-bhtn">—</div></div>
                        <div class="kv"><div class="k">Lớp</div><div class="v" id="c-lop-bhtn">—</div></div>
                        <div class="kv"><div class="k">Số tiền đóng</div><div class="v v-green" id="c-sotien-bhtn">—</div></div>
                        <div class="bhtn-lop" id="c-lop-big-bhtn"> </div>
                      </div>
                    </div>

                    <div class="bhtn-stamp">ĐÃ KÍCH HOẠT</div>
                    <div class="bhtn-badge"><span id="c-badge-bhtn">—</span></div>
                    <div id="card-qr-bhtn" class="bhtn-qr"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <div class="d-flex gap-2"><button class="btn btn-secondary btn-sm" onclick="bhtnp_downloadCardImage()">Lưu ảnh thẻ</button></div>
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
          </div>
        </div>
      </div>



    


      <!-- Xem trước & in Phiếu thu A5 cho BHTN -->
      <div class="modal fade" id="modalPhieuThuBHTN" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
              <div class="no-print d-flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImageBHTN()">Lưu ảnh</button>
                <button class="btn btn-primary btn-sm" onclick="printReceiptOnlyBHTN()">In</button>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="display:flex;justify-content:center;">
              <div id="receiptA5-bhtn" class="a5-paper">
                <div class="row">
                  <div class="col">
                    <div class="receipt-meta">
                      <div><strong id="rec-school-bhtn">Trường …</strong></div>
                      <div>Lớp: <strong id="rec-class-bhtn">—</strong></div>
                    </div>
                  </div>
                  <div class="col text-center">
                    <div class="receipt-meta">
                      <div><strong>Mẫu số:</strong> C45-BB</div>
                      <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                      <div>ngày 10/10/2017 của Bộ Tài Chính</div>
                    </div>
                  </div>
                </div>
                <div class="row align-items-center mt-3">
                  <div class="col-4" style="max-width:36mm"><div class="qr-box"><div id="receipt-qr-bhtn"></div></div></div>
                  <div class="col text-center">
                    <div class="receipt-title">BIÊN LAI THU TIỀN</div>
                    <div class="receipt-sub" id="rec-date-today-bhtn">Ngày … tháng … năm …</div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name-bhtn">—</strong></div>
                  <div class="receipt-line">Địa chỉ: <span id="rec-address-bhtn">—</span></div>
                  <div class="receipt-line">Nội dung thu: <span id="rec-content-bhtn">—</span></div>
                  <div class="receipt-line">Số tháng đóng: <span id="rec-months-bhtn">—</span> tháng (<span id="rec-range-bhtn">từ ngày … đến ngày …</span>)</div>
                  <div class="receipt-line">Số tiền thu: <strong id="rec-amount-bhtn">—</strong> VNĐ</div>
                  <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text-bhtn">—</strong>.</div>
                </div>
                <div class="row">
                  <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
                  <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name-bhtn">—</div></div>
                </div>
              </div>
            </div>
            <div class="modal-footer no-print">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button class="btn btn-outline-secondary" onclick="downloadReceiptImageBHTN()">Lưu ảnh</button>
              <button class="btn btn-primary" onclick="printReceiptOnlyBHTN()">In</button>
            </div>
          </div>
        </div>
      </div>

      <!-- BẢO HIỂM TAI NẠN (embedded, for admin) -->



      <!-- THỐNG KÊ (embedded, for admin) -->
      <section id="page-stats" class="d-none">
        <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-2">  
          <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-2">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-6">
              <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
              <select id="stats-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
              <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
            </div>
            <div class="col-12 col-lg-6 d-flex gap-2 align-items-start">
              <button id="stats-btn-load" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Tải dữ liệu
              </button>
              <button id="stats-btn-all" class="btn btn-info">
                <i class="bi bi-building"></i> Toàn trường
              </button>
            </div>
          </div>
        </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="statsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="stats-bhyt-tab" data-bs-toggle="tab"
                    data-bs-target="#stats-bhyt" type="button" role="tab"
                    aria-controls="stats-bhyt" aria-selected="true">
              Thống kê BHYT
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-bhtn-tab" data-bs-toggle="tab"
                    data-bs-target="#stats-bhtn" type="button" role="tab"
                    aria-controls="stats-bhtn" aria-selected="false">
              Thống kê BHTN
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">

          <!-- TAB: BHYT -->
          <div class="tab-pane fade show active" id="stats-bhyt" role="tabpanel" aria-labelledby="stats-bhyt-tab">
            <!-- KPI (đồng bộ mẫu GV) -->
            <div class="row g-3 mb-3">
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-emerald"><i class="bi bi-people-fill"></i></div>
                  <div>
                    <div class="val" id="bhyt-kpi-total">0</div>
                    <div class="lbl">Tổng số học sinh</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-indigo"><i class="bi bi-check2-circle"></i></div>
                  <div>
                    <div class="val" id="bhyt-kpi-paid">0</div>
                    <div class="lbl">Đã đóng (gồm đối tượng khác)</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-orange"><i class="bi bi-x-circle"></i></div>
                  <div>
                    <div class="val" id="bhyt-kpi-unpaid">0</div>
                    <div class="lbl">Chưa đóng</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-amber"><i class="bi bi-people"></i></div>
                  <div>
                    <div class="val" id="bhyt-kpi-other">0</div>
                    <div class="lbl">Đối tượng khác</div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                  <div>
                    <div class="val" id="bhyt-kpi-rate">0%</div>
                    <div class="lbl">Tỉ lệ hoàn thành</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ -->
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Tỷ lệ đóng BHYT</div>
                <div class="text-secondary small">Đơn vị: % và số lượng</div>
              </div>
              <div style="position:relative;width:100%;height:360px">
                <canvas id="bhytChart"></canvas>
              </div>
            </div>
          </div>

          <!-- TAB: BHTN -->
          <div class="tab-pane fade" id="stats-bhtn" role="tabpanel" aria-labelledby="stats-bhtn-tab">
            <!-- KPI (đồng bộ mẫu GV) -->
            <div class="row g-3 mb-3">
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-emerald"><i class="bi bi-people-fill"></i></div>
                  <div>
                    <div class="val" id="bhtn-kpi-total">0</div>
                    <div class="lbl">Tổng số học sinh</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-indigo"><i class="bi bi-check2-circle"></i></div>
                  <div>
                    <div class="val" id="bhtn-kpi-paid">0</div>
                    <div class="lbl">Đã đóng</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-orange"><i class="bi bi-x-circle"></i></div>
                  <div>
                    <div class="val" id="bhtn-kpi-unpaid">0</div>
                    <div class="lbl">Chưa đóng</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                  <div>
                    <div class="val" id="bhtn-kpi-rate">0%</div>
                    <div class="lbl">Tỉ lệ hoàn thành</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Biểu đồ -->
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Tỷ lệ đóng BHTN</div>
                <div class="text-secondary small">Đơn vị: % và số lượng</div>
              </div>
              <div style="position:relative;width:100%;height:360px">
                <canvas id="bhtnChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- THỐNG KÊ (embedded, for admin) -->
      





      
      <!-- THÙ LAO (embedded, for admin) -->
      <section id="page-rewards" class="d-none">
        <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-2">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-6">
              <label class="form-label fw-semibold">Chọn lớp (có thể chọn nhiều)</label>
              <select id="rw-classes" class="form-select" multiple size="6" aria-label="Chọn nhiều lớp"></select>
              <small class="text-secondary">Giữ Ctrl/Cmd để chọn nhiều; <br> Bấm nút "Toàn trường" để xem toàn bộ lớp</small>
            </div>
            <div class="col-12 col-lg-6 d-flex gap-2 align-items-start">
              <button id="rw-btn-load" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Tải dữ liệu
              </button>
              <button id="rw-btn-all" class="btn btn-info">
                <i class="bi bi-building"></i> Toàn trường
              </button>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="rwTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rw-bhyt-tab" data-bs-toggle="tab"
                    data-bs-target="#rw-bhyt" type="button" role="tab"
                    aria-controls="rw-bhyt" aria-selected="true">
              Thù lao BHYT
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="rw-bhtn-tab" data-bs-toggle="tab"
                    data-bs-target="#rw-bhtn" type="button" role="tab"
                    aria-controls="rw-bhtn" aria-selected="false">
              Thù lao BHTN
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">

          <!-- TAB: Thù lao BHYT -->
          <div class="tab-pane fade show active" id="rw-bhyt" role="tabpanel" aria-labelledby="rw-bhyt-tab">
            <div class="row g-3 mb-3">
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-emerald"><i class="bi bi-people-fill"></i></div>
                  <div>
                    <div class="val" id="rw-bhyt-kpi-total">0</div>
                    <div class="lbl">Tổng số học sinh</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-indigo"><i class="bi bi-journal-check"></i></div>
                  <div>
                    <div class="val" id="rw-bhyt-kpi-submitted">0</div>
                    <div class="lbl">Hồ sơ đã nộp</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-orange"><i class="bi bi-cash-coin"></i></div>
                  <div>
                    <div class="val" id="rw-bhyt-kpi-money">0</div>
                    <div class="lbl">Tổng số tiền đã thu</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-percent"></i></div>
                  <div>
                    <div class="val" id="rw-bhyt-kpi-commission">0</div>
                    <div class="lbl">Tổng thù lao</div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6 col-lg-4">
                <div class="kpi-card">
                  <div class="icon ic-indigo"><i class="bi bi-3-circle-fill"></i></div>
                  <div>
                    <div class="val"><span id="rw-bhyt-kpi-3m-count">0</span> HS</div>
                    <div class="lbl">Đóng 3 tháng · Thù lao: <strong id="rw-bhyt-kpi-3m-commission">0</strong></div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-4">
                <div class="kpi-card">
                  <div class="icon ic-amber"><i class="bi bi-6-circle-fill"></i></div>
                  <div>
                    <div class="val"><span id="rw-bhyt-kpi-6m-count">0</span> HS</div>
                    <div class="lbl">Đóng 6 tháng · Thù lao: <strong id="rw-bhyt-kpi-6m-commission">0</strong></div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-4">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-123"></i></div>
                  <div>
                    <div class="val"><span id="rw-bhyt-kpi-12m-count">0</span> HS</div>
                    <div class="lbl">Đóng 12 tháng · Thù lao: <strong id="rw-bhyt-kpi-12m-commission">0</strong></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Thống kê hồ sơ & thù lao theo gói tháng (BHYT)</div>
                <div class="text-secondary small">Đơn vị: hồ sơ / VNĐ</div>
              </div>
              <div style="position:relative;width:100%;height:360px">
                <canvas id="rw-bhyt-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- TAB: Thù lao BHTN -->
          <div class="tab-pane fade" id="rw-bhtn" role="tabpanel" aria-labelledby="rw-bhtn-tab">
            <div class="row g-3 mb-3">
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-emerald"><i class="bi bi-people-fill"></i></div>
                  <div>
                    <div class="val" id="rw-bhtn-kpi-total">0</div>
                    <div class="lbl">Tổng số học sinh</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-indigo"><i class="bi bi-journal-check"></i></div>
                  <div>
                    <div class="val" id="rw-bhtn-kpi-submitted">0</div>
                    <div class="lbl">Hồ sơ đã nộp</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-orange"><i class="bi bi-cash-coin"></i></div>
                  <div>
                    <div class="val" id="rw-bhtn-kpi-money">0</div>
                    <div class="lbl">Tổng số tiền đã thu (BHTN)</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-lg-3">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-percent"></i></div>
                  <div>
                    <div class="val" id="rw-bhtn-kpi-commission">0</div>
                    <div class="lbl">Tổng thù lao</div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6 col-lg-4">
                <div class="kpi-card">
                  <div class="icon ic-blue"><i class="bi bi-123"></i></div>
                  <div>
                    <div class="val"><span id="rw-bhtn-kpi-12m-count">0</span> HS</div>
                    <div class="lbl">Gói 12 tháng · Thù lao: <strong id="rw-bhtn-kpi-12m-commission">0</strong></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Thống kê hồ sơ & thù lao (BHTN 12 tháng)</div>
                <div class="text-secondary small">Đơn vị: hồ sơ / VNĐ</div>
              </div>
              <div style="position:relative;width:100%;height:360px">
                <canvas id="rw-bhtn-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- THÙ LAO (embedded, for admin) -->




      <section id="page-profile" class="d-none"><div class="panel"><div>Thông tin cá nhân (đang phát triển).</div></div></section>
      <section id="page-settings" class="d-none"><div class="panel"><div> Cài đặt (đang phát triển).</div></div></section>

    </main>
  </div>

  <!-- Loading -->
  <div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>



  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
    <div id="toastNoti" class="toast align-items-center text-white bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastNotiBody">—</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>




  <!-- Bootstrap JS & các thư viện khác -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- QRCode.js & html2canvas (for in phiếu thu A5) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


  <!-- ExcelJS (for xuất file Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>


  <!-- Chart.js + plugin nhãn (dùng cho 2 tab Thống kê) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>



  <!-- Thư viện nội bộ -->
  <script src="../js/api.js"></script>


  

  <!-- ====== KHỐI HỌC SINH CHO ADMIN ====== -->
  <script>
  // ====== KHỐI HỌC SINH CHO ADMIN ======
  let ADM = {
    all: [],           // toàn bộ HS trường
    filtered: [],      // sau lọc + search + sort
    pageSize: 20,
    page: 1,
    sortField: "",
    sortDir: 1,
    lastPageData: [],
    selected: new Set(),
    fpAdd: {}, fpEdit: {}
  };

  // utils ngày (từ ds_hocsinh.html)
  function adm_displayNgay(raw){
    if (!raw) return "";
    if (typeof raw === "number"){
      var utc_days = Math.floor(raw - 25569), date = new Date(utc_days*86400*1000); date.setUTCHours(0,0,0,0);
      const dd=String(date.getDate()).padStart(2,'0'), mm=String(date.getMonth()+1).padStart(2,'0'), yy=date.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    if (/^\d{4}-\d{2}-\d{2}T/.test(raw)){ const d=new Date(raw);
      return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
    return raw;
  }
  function adm_isValidDateVN(s){ if(!/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return false; const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d; }
  function adm_readDateStr(sel){ const el=document.querySelector(sel); return (el && el.value)? el.value.trim() : ""; }




  // phát hiện kích thước trang
  function adm_detectPageSize(){
    const w = window.innerWidth;
    // mobile <= 576 → 3; tablet <= 991 → 5; desktop → 10
    ADM.pageSize = (w <= 576) ? 3 : (w <= 991) ? 5 : 10;
  }
  window.addEventListener('resize', () => {
    const prev = ADM.pageSize;
    adm_detectPageSize();
    if (ADM.pageSize !== prev){
      ADM.page = 1;
      adm_renderTable();
      adm_renderPagin();
    }
  });







  function adm_isValidPhone(s){ return /^0\d{9}$/.test(String(s||'').trim()); }
  function adm_isValidSdd(s){ return /^\d{12}$/.test(String(s||'').trim()); }

  // Validate từng dòng import
  function adm_validateImportRowNew(
    row, rowNum,
    soDinhDanhSet, maSoBHXHSet,
    existedSoDinhDanhSet, existedMaSoBHXHSet,
    requiredMaTruong
  ){
    const required = [
      ['ma_so_bhxh', 'Mã số BHXH'],
      ['ho_ten_hoc_sinh', 'Họ tên học sinh'],
      ['ngay_sinh', 'Ngày sinh'],
      ['gioi_tinh', 'Giới tính'],
      ['dia_chi', 'Địa chỉ'],
      ['ngay_het_han_bhyt', 'Hạn BHYT'],
      ['ngay_het_han_bhtn', 'Hạn BHTN'],
      ['lop_hoc', 'Lớp'],
      ['sdt_lienhe', 'SĐT liên hệ'],
      ['so_dinh_danh', 'Số định danh'],
      ['noi_kham_bhyt', 'Nơi khám BHYT'],
      ['ten_cha_me', 'Tên cha/mẹ'],
      ['ma_truong', 'Mã trường']
    ];
    // Kiểm tra các trường bắt buộc
    for (const [k, label] of required){
      if (!row[k] || String(row[k]).trim()===''){
        return `Dòng ${rowNum}: Trường "${label}" không được để trống.`;
      }
    }

    // Kiểm tra lớp
    if (!row.lop_hoc || String(row.lop_hoc).trim() === '') {
      return `Dòng ${rowNum}: Trường "Lớp" không được để trống.`;
    }

    // Kiểm tra số điện thoại hợp lệ
    if (!adm_isValidPhone(row.sdt_lienhe)) {
      return `Dòng ${rowNum}: SĐT "${row.sdt_lienhe}" không hợp lệ.`;
    }

    // Kiểm tra định dạng ngày hợp lệ
    if (!adm_isValidDateVN(row.ngay_sinh)) return `Dòng ${rowNum}: Ngày sinh "${row.ngay_sinh}" không hợp lệ.`;
    if (!adm_isValidDateVN(row.ngay_het_han_bhyt)) return `Dòng ${rowNum}: Hạn BHYT "${row.ngay_het_han_bhyt}" không hợp lệ.`;
    if (!adm_isValidDateVN(row.ngay_het_han_bhtn)) return `Dòng ${rowNum}: Hạn BHTN "${row.ngay_het_han_bhtn}" không hợp lệ.`;

    if (!adm_isValidSdd(row.so_dinh_danh)) return `Dòng ${rowNum}: Số định danh "${row.so_dinh_danh}" không hợp lệ. Số định danh phải gồm 12 số!`;

    if (requiredMaTruong && String(row.ma_truong).trim() !== String(requiredMaTruong).trim()){
      return `Dòng ${rowNum}: Mã trường "${row.ma_truong}" không khớp với tài khoản hiện tại.`;
    }

    const ms = String(row.ma_so_bhxh).trim();
    const sdd = String(row.so_dinh_danh).trim();

    if (maSoBHXHSet.has(ms)) return `Dòng ${rowNum}: Mã số BHXH "${ms}" bị trùng trong file import.`;
    if (soDinhDanhSet.has(sdd)) return `Dòng ${rowNum}: Số định danh "${sdd}" bị trùng trong file import.`;

    if (existedMaSoBHXHSet.has(ms)) return `Dòng ${rowNum}: Mã số BHXH "${ms}" đã tồn tại trong hệ thống.`;
    if (existedSoDinhDanhSet.has(sdd)) return `Dòng ${rowNum}: Số định danh "${sdd}" đã tồn tại trong hệ thống.`;

    maSoBHXHSet.add(ms);
    soDinhDanhSet.add(sdd);
    return "";
  }





  // fetch toàn trường 1 lần – client-side filter/search/paginate
  async function adm_reloadStudents(){
    try{
      showLoading();
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const resp = await getAllDanhSachHocsinh(user.ma_truong||'', ''); // lop_hoc = '' → toàn trường
      ADM.all = Array.isArray(resp?.data) ? resp.data : [];
      // build datalist lớp
      const classes = [...new Set(ADM.all.map(r => String(r.lop_hoc||'').trim()).filter(Boolean))].sort();
      $('#admClassList').innerHTML = classes.map(c=>`<option value="${c}">`).join('');
      adm_detectPageSize();      // << thêm dòng này
      adm_applyFilters();
    } finally { hideLoading(); }
  }

  // áp dụng lọc + search + sort + phân trang
  function adm_applyFilters(){
    const q = $('#adm-search').value.trim().toLowerCase();
    const cls = $('#adm-loc-lop').value.trim();
    let arr = ADM.all.filter(r => (!cls || String(r.lop_hoc||'').trim()===cls));
    if (q){
      arr = arr.filter(r =>
        String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
        String(r.ma_so_bhxh||'').toLowerCase().includes(q) ||
        String(r.sdt_lienhe||'').toLowerCase().includes(q) ||
        String(r.so_dinh_danh||'').toLowerCase().includes(q) ||
        String(r.ten_cha_me||'').toLowerCase().includes(q)
      );
    }
    // sort
    if (ADM.sortField){
      const f = ADM.sortField, dir = ADM.sortDir;
      arr.sort((a,b)=>{
        let av = (a[f]??'').toString().toLowerCase(), bv=(b[f]??'').toString().toLowerCase();
        if(!isNaN(av) && !isNaN(bv)) { av=Number(av); bv=Number(bv); }
        if (av<bv) return -dir; if (av>bv) return dir; return 0;
      });
    }
    ADM.filtered = arr;
    ADM.page = Math.min(ADM.page, Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize))) || 1;
    $('#adm-lop-text').textContent = cls || 'tất cả';
    $('#adm-total').textContent = ADM.filtered.length.toLocaleString('vi-VN');
    adm_renderTable();
    adm_renderPagin();
  }

  // render bảng
  function adm_renderTable(){
    ADM.selected.clear();
    const start = (ADM.page-1)*ADM.pageSize;
    const data = ADM.filtered.slice(start, start+ADM.pageSize);
    ADM.lastPageData = data;

    const sortIcon = f => (ADM.sortField!==f)? '' : (ADM.sortDir===1?' ▲':' ▼');

    let html = `<table class="table table-hover align-middle mb-0">
      <thead class="table-light"><tr>
        <th style="width:42px"><input type="checkbox" id="adm-chk-all"></th>
        <th style="width:120px">Thao tác</th>
        <th class="text-nowrap" role="button" data-sort="ma_so_bhxh">MS BHXH${sortIcon('ma_so_bhxh')}</th>
        <th role="button" data-sort="ho_ten_hoc_sinh">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
        <th role="button" data-sort="ngay_sinh">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th role="button" data-sort="gioi_tinh">Giới tính${sortIcon('gioi_tinh')}</th>
        <th role="button" data-sort="lop_hoc">Lớp${sortIcon('lop_hoc')}</th>
        <th role="button" data-sort="so_dinh_danh">Số định danh${sortIcon('so_dinh_danh')}</th>
        <th role="button" data-sort="sdt_lienhe">SĐT${sortIcon('sdt_lienhe')}</th>
      </tr></thead><tbody>`;

    if (!data.length){
      html += `<tr><td colspan="9" class="text-center text-secondary py-4">Không có dữ liệu</td></tr>`;
    } else {
      data.forEach((r, i)=>{
        html += `<tr>
          <td><input type="checkbox" class="adm-chk" value="${r.stt}"></td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-warning me-1" data-action="edit" data-idx="${i}">Sửa</button>
            <button class="btn btn-sm btn-danger" data-action="del" data-id="${r.stt}">Xóa</button>
          </td>
          <td>${r.ma_so_bhxh||''}</td>
          <td>${r.ho_ten_hoc_sinh||''}</td>
          <td>${adm_displayNgay(r.ngay_sinh)}</td>
          <td>${r.gioi_tinh||''}</td>
          <td>${r.lop_hoc||''}</td>
          <td>${r.so_dinh_danh||''}</td>
          <td>${r.sdt_lienhe||''}</td>
        </tr>`;
      });
    }
    html += `</tbody></table>`;
    $('#adm-tablebox').innerHTML = html;

    // events: sort, check-all, row actions
    $('#adm-tablebox thead').addEventListener('click', e=>{
      const th = e.target.closest('[data-sort]');
      if (!th) return;
      const f = th.dataset.sort;
      ADM.sortField === f ? ADM.sortDir = -ADM.sortDir : (ADM.sortField=f, ADM.sortDir=1);
      adm_applyFilters();
    });
    $('#adm-chk-all')?.addEventListener('change', e=>{
      ADM.selected.clear();
      $$('.adm-chk').forEach(cb => { cb.checked=e.target.checked; if (e.target.checked) ADM.selected.add(cb.value); });
      $('#adm-btn-delmany').classList.toggle('d-none', ADM.selected.size===0);
    });
    $$('.adm-chk').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        cb.checked ? ADM.selected.add(cb.value) : ADM.selected.delete(cb.value);
        $('#adm-btn-delmany').classList.toggle('d-none', ADM.selected.size===0);
      });
    });
    $('#adm-tablebox tbody').addEventListener('click', e=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.dataset.action;
      if (action==='edit'){ adm_openEditModal(ADM.lastPageData[Number(btn.dataset.idx)||0]); }
      if (action==='del'){ adm_confirmDelete(btn.dataset.id); }
    });
  }

  function adm_renderPagin(){
    const ul = $('#adm-pagin'); ul.innerHTML='';
    const totalPages = Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize));
    if (totalPages<=1) return;
    const add = (p, active=false, disabled=false, label=p) => {
      ul.insertAdjacentHTML('beforeend', `<li class="page-item ${active?'active':''} ${disabled?'disabled':''}">
        <a class="page-link" href="#" data-page="${p}">${label}</a></li>`);
    };
    add(ADM.page-1, false, ADM.page===1, '«');
    const minP=Math.max(1,ADM.page-2), maxP=Math.min(totalPages,ADM.page+2);
    if (minP>1){ add(1); if(minP>2) ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>'); }
    for(let p=minP;p<=maxP;p++) add(p, ADM.page===p);
    if (maxP<totalPages-1){ ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>'); }
    if (maxP<totalPages) add(totalPages);
    add(ADM.page+1, false, ADM.page===totalPages, '»');

    ul.addEventListener('click', e=>{
      const a = e.target.closest('a[data-page]'); if(!a) return;
      e.preventDefault(); const p = Number(a.dataset.page);
      const totalPages = Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize));
      if (p>=1 && p<=totalPages && p!==ADM.page){ ADM.page = p; adm_renderTable(); adm_renderPagin(); }
    }, {once:true});
  }

  // mở modal Thêm
  function adm_openAddModal(){
    $('#adm-form-add').reset?.();
    $('#adm-add-err').textContent = '';
    // init datepickers
    ADM.fpAdd.ngay = ADM.fpAdd.ngay || flatpickr('#add-ngaysinh', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpAdd.bhyt = ADM.fpAdd.bhyt || flatpickr('#add-bhyt', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpAdd.bhtn = ADM.fpAdd.bhtn || flatpickr('#add-bhtn', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });

    new bootstrap.Modal('#admModalAdd').show();
  }

  // lưu thêm
  async function adm_saveAdd(){
    const user = JSON.parse(localStorage.getItem('user')||'{}');
    const hs = {
      ma_so_bhxh: $('#add-msbhxh').value.trim(),
      ho_ten_hoc_sinh: $('#add-hoten').value.trim(),
      ngay_sinh: adm_readDateStr('#add-ngaysinh'),
      gioi_tinh: $('input[name="add_gt"]:checked')?.value || '',
      dia_chi: $('#add-diachi').value.trim(),
      ngay_het_han_bhyt: adm_readDateStr('#add-bhyt'),
      ngay_het_han_bhtn: adm_readDateStr('#add-bhtn'),
      lop_hoc: $('#add-lop').value.trim(),
      sdt_lienhe: $('#add-sdt').value.trim(),
      so_dinh_danh: $('#add-sdd').value.trim(),
      noi_kham_bhyt: $('#add-noikham').value.trim(),
      ten_cha_me: $('#add-chaMe').value.trim(),
      doi_tuong_dong: ($('#add-doituong').value||'null').trim()||'null',
      ghi_chu: ($('#add-ghichu').value||'null').trim()||'null',
      ma_truong: user.ma_truong
    };
    // bắt buộc đơn giản
    const req = ['ma_so_bhxh','ho_ten_hoc_sinh','ngay_sinh','gioi_tinh','dia_chi','ngay_het_han_bhyt','ngay_het_han_bhtn','lop_hoc','sdt_lienhe','so_dinh_danh','noi_kham_bhyt','ten_cha_me'];
    for (const k of req){ if(!hs[k]) { $('#adm-add-err').textContent='Vui lòng nhập đầy đủ trường bắt buộc.'; return; } }
    if (!adm_isValidDateVN(hs.ngay_sinh) || !adm_isValidDateVN(hs.ngay_het_han_bhyt) || !adm_isValidDateVN(hs.ngay_het_han_bhtn)){
      $('#adm-add-err').textContent='Ngày không hợp lệ (dd/mm/yyyy).'; return;
    }
    showLoading();
    const rs = await themHocsinh(hs);
    hideLoading();
    if (rs.success){
      bootstrap.Modal.getInstance($('#admModalAdd')).hide();
      showToast('Thêm học sinh thành công!', 'success');
      await adm_reloadStudents();
    } else {
      $('#adm-add-err').textContent = rs.message || 'Thêm thất bại';
      showToast($('#adm-add-err').textContent, 'danger');
    }
  }

  // mở modal Sửa
  function adm_openEditModal(hs){
    if (!hs) return;
    // init pickers 1 lần
    ADM.fpEdit.ngay = ADM.fpEdit.ngay || flatpickr('#edit-ngaysinh', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpEdit.bhyt = ADM.fpEdit.bhyt || flatpickr('#edit-bhyt', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpEdit.bhtn = ADM.fpEdit.bhtn || flatpickr('#edit-bhtn', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });


    $('#adm-edit-err').textContent='';
    $('#edit-stt').value = hs.stt;
    $('#edit-msbhxh').value = hs.ma_so_bhxh||'';
    $('#edit-hoten').value = hs.ho_ten_hoc_sinh||'';
    $('#edit-ngaysinh').value = adm_displayNgay(hs.ngay_sinh)||'';
    $('#edit-gt-nam').checked = (hs.gioi_tinh==='Nam'); $('#edit-gt-nu').checked = (hs.gioi_tinh==='Nữ');
    $('#edit-lop').value = hs.lop_hoc||'';
    $('#edit-diachi').value = hs.dia_chi||'';
    $('#edit-sdt').value = hs.sdt_lienhe||'';
    $('#edit-sdd').value = hs.so_dinh_danh||'';
    $('#edit-chaMe').value = hs.ten_cha_me||'';
    $('#edit-bhyt').value = adm_displayNgay(hs.ngay_het_han_bhyt)||'';
    $('#edit-bhtn').value = adm_displayNgay(hs.ngay_het_han_bhtn)||'';
    $('#edit-noikham').value = hs.noi_kham_bhyt||'';
    $('#edit-doituong').value = (hs.doi_tuong_dong && hs.doi_tuong_dong!=='null')? hs.doi_tuong_dong : '';
    $('#edit-ghichu').value = (hs.ghi_chu && hs.ghi_chu!=='null')? hs.ghi_chu : '';

    // set lại giá trị cho datepickers
    if (ADM.fpEdit.ngay) ADM.fpEdit.ngay.setDate($('#edit-ngaysinh').value || null, true, 'd/m/Y');
    if (ADM.fpEdit.bhyt) ADM.fpEdit.bhyt.setDate($('#edit-bhyt').value || null, true, 'd/m/Y');
    if (ADM.fpEdit.bhtn) ADM.fpEdit.bhtn.setDate($('#edit-bhtn').value || null, true, 'd/m/Y');


    new bootstrap.Modal('#admModalEdit').show();
  }

  // lưu sửa
  async function adm_saveEdit(){
    const user = JSON.parse(localStorage.getItem('user')||'{}');
    const hs = {
      stt: $('#edit-stt').value,
      ma_so_bhxh: $('#edit-msbhxh').value.trim(),
      ho_ten_hoc_sinh: $('#edit-hoten').value.trim(),
      ngay_sinh: adm_readDateStr('#edit-ngaysinh'),
      gioi_tinh: $('input[name="edit_gt"]:checked')?.value || '',
      dia_chi: $('#edit-diachi').value.trim(),
      ngay_het_han_bhyt: adm_readDateStr('#edit-bhyt'),
      ngay_het_han_bhtn: adm_readDateStr('#edit-bhtn'),
      lop_hoc: $('#edit-lop').value.trim(),
      sdt_lienhe: $('#edit-sdt').value.trim(),
      so_dinh_danh: $('#edit-sdd').value.trim(),
      noi_kham_bhyt: $('#edit-noikham').value.trim(),
      ten_cha_me: $('#edit-chaMe').value.trim(),
      doi_tuong_dong: ($('#edit-doituong').value||'null').trim()||'null',
      ghi_chu: ($('#edit-ghichu').value||'null').trim()||'null',
      ma_truong: user.ma_truong
    };
    // required đơn giản
    const req = ['stt','ma_so_bhxh','ho_ten_hoc_sinh','ngay_sinh','gioi_tinh','dia_chi','lop_hoc','sdt_lienhe','so_dinh_danh','ten_cha_me'];
    for (const k of req){ if(!hs[k]){ $('#adm-edit-err').textContent='Vui lòng nhập đủ trường bắt buộc.'; return; } }
    if (!adm_isValidDateVN(hs.ngay_sinh)){ $('#adm-edit-err').textContent='Ngày sinh không hợp lệ (dd/mm/yyyy).'; return; }

    showLoading();
    const rs = await suaHocsinh(hs);
    hideLoading();
    if (rs.success){
      bootstrap.Modal.getInstance($('#admModalEdit')).hide();
      showToast('Cập nhật học sinh thành công!', 'success');
      await adm_reloadStudents();
    } else {
      $('#adm-edit-err').textContent = rs.message || 'Cập nhật thất bại';
      showToast($('#adm-edit-err').textContent, 'danger');
    }
  }

  // xóa 1 / xóa nhiều
  function adm_confirmDelete(stt){
    $('#admConfirmTitle').textContent='Xác nhận xóa';
    $('#admConfirmBody').innerHTML='Bạn có chắc chắn muốn xóa học sinh này?';
    const btn = $('#admConfirmBtn');
    btn.onclick = async ()=>{
      // Ẩn modal NGAY lập tức trước khi xóa (fix lỗi “modal treo”)
      const m = bootstrap.Modal.getInstance($('#admModalConfirm'));
      m?.hide();

      showLoading();
      const rs = await xoaHocsinh(stt);
      hideLoading();
      if (rs.success){
        // Ẩn nút xóa nhiều + bỏ chọn tất cả checkbox (nếu còn hiển thị)
        $('#adm-btn-delmany').classList.add('d-none');
        const chkAll = $('#adm-chk-all');
        if (chkAll) chkAll.checked = false;
        $$('.adm-chk').forEach(cb => { cb.checked = false; });

        
        showToast('Xóa học sinh thành công!', 'success');
        await adm_reloadStudents();
      } else {
        showToast(rs.message || 'Xóa học sinh thất bại!', 'danger');
      }
    };
    new bootstrap.Modal('#admModalConfirm').show();
  }

  function adm_confirmDeleteMany(){
    if (!ADM.selected.size) return;
    $('#admConfirmTitle').textContent='Xác nhận xóa nhiều';
    $('#admConfirmBody').innerHTML=`Bạn có chắc chắn muốn xóa <b>${ADM.selected.size}</b> học sinh đã chọn?`;
    const btn = $('#admConfirmBtn');
    btn.onclick = async ()=>{
      // Ẩn modal trước khi xóa
      const m = bootstrap.Modal.getInstance($('#admModalConfirm'));
      m?.hide();

      showLoading();
      const rs = await xoaNhieuHocsinh([...ADM.selected]);
      hideLoading();
      if (rs.success){
        ADM.selected.clear();
        
        // Ẩn nút xóa nhiều + bỏ chọn tất cả checkbox (nếu còn hiển thị)
        $('#adm-btn-delmany').classList.add('d-none');
        const chkAll = $('#adm-chk-all');
        if (chkAll) chkAll.checked = false;
        $$('.adm-chk').forEach(cb => { cb.checked = false; });


        showToast('Xóa nhiều học sinh thành công!', 'success');
        await adm_reloadStudents();
      } else {
        showToast(rs.message || 'Xóa nhiều học sinh thất bại!', 'danger');
      }
    };
    new bootstrap.Modal('#admModalConfirm').show();
  }


  // wire UI
  function adm_wireStudentsPage(){

    // detect page size
    adm_detectPageSize();


    // inputs
    $('#adm-loc-lop').addEventListener('input', ()=>{ ADM.page=1; adm_applyFilters(); });
    $('#adm-search').addEventListener('input', ()=>{ ADM.page=1; adm_applyFilters(); });
    $('#adm-btn-reload').addEventListener('click', ()=> {
      adm_reloadStudents().then(()=> showToast('Đã tải lại danh sách học sinh', 'success'));
    });

    $('#adm-btn-add').addEventListener('click', adm_openAddModal);
    $('#adm-btn-add-save').addEventListener('click', adm_saveAdd);
    $('#adm-btn-edit-save').addEventListener('click', adm_saveEdit);
    $('#adm-btn-import').addEventListener('click', ()=> new bootstrap.Modal('#admModalImport').show());
    $('#adm-btn-delmany').addEventListener('click', adm_confirmDeleteMany);
    // import: (tận dụng API importDanhSachHocsinh giống trang ds_hocsinh nếu bạn đã expose; nếu chưa dùng tạm thời ẩn nút)
    $('#adm-btn-import-run').addEventListener('click', async ()=>{
      const f = $('#adm-import-file'); const err = $('#adm-import-err'); err.textContent='';
      if (!f.files.length){ err.textContent='Vui lòng chọn file!'; return; }
      // Có thể tái dùng logic trong ds_hocsinh.html nếu muốn validate kỹ hơn.
      showLoading();
      try{
        const data = await f.files[0].arrayBuffer();
        const wb = XLSX.read(data, {type:'array'}); const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''}); rows.shift();

        // validate + chuẩn hóa dữ liệu
        const user = JSON.parse(localStorage.getItem('user')||'{}');
        const existedSoDinhDanhSet = new Set(ADM.all.map(r => String(r.so_dinh_danh||'').trim()).filter(Boolean));
        const existedMaSoBHXHSet  = new Set(ADM.all.map(r => String(r.ma_so_bhxh||'').trim()).filter(Boolean));

        const soDinhDanhSet = new Set();
        const maSoBHXHSet   = new Set();

        const list = rows.map(r => ({
          ma_so_bhxh:String(r[1]||'').trim(),
          ho_ten_hoc_sinh:(r[2]||'').toString().trim(),
          ngay_sinh:adm_displayNgay(r[3])||'',
          gioi_tinh:(r[4]||'').toString().trim(),
          dia_chi:(r[5]||'').toString().trim(),
          ngay_het_han_bhyt:adm_displayNgay(r[6])||'',
          ngay_het_han_bhtn:adm_displayNgay(r[7])||'',
          lop_hoc:String(r[8]||'').trim(),
          sdt_lienhe:String(r[9]||'').trim(),
          so_dinh_danh:String(r[10]||'').trim(),
          noi_kham_bhyt:String(r[11]||'').trim(),
          ten_cha_me:String(r[12]||'').trim(),
          doi_tuong_dong:(r[13]&&String(r[13]).trim())?String(r[13]).trim():'null',
          ghi_chu:(r[14]&&String(r[14]).trim())?String(r[14]).trim():'null',
          ma_truong:String(r[15]||user.ma_truong).trim()
        }));

        for (let i=0;i<list.length;i++){
          const errMsg = adm_validateImportRowNew(
            list[i], i+2,
            soDinhDanhSet, maSoBHXHSet,
            existedSoDinhDanhSet, existedMaSoBHXHSet,
            user.ma_truong
          );
          if (errMsg){
            hideLoading();
            err.textContent = errMsg;
            showToast(errMsg, 'danger');
            return;
          }
        }

        const rs = await importDanhSachHocsinh(list);
        hideLoading();
        if (rs.success){
          bootstrap.Modal.getInstance($('#admModalImport')).hide();
          showToast('Import danh sách thành công!', 'success');
          await adm_reloadStudents();
        } else {
          const msg = rs.message || 'Import thất bại';
          err.textContent = msg;
          showToast(msg, 'danger');
        }

      } catch (err) {
        hideLoading();
        console.error(err);
        err.textContent = 'Đã có lỗi xảy ra khi xử lý tệp!';
        showToast('Đã có lỗi xảy ra khi xử lý tệp!', 'danger');
      }
    });
  }
  </script>








  <!-- ====== KHỐI ĐỐI TƯỢNG KHÁC CHO ADMIN ====== -->
  <script>
    /* ===== Danh sách ĐỐI TƯỢNG KHÁC (namespaced) ===== */
    (function(){
      // state chỉ dùng nội bộ
      let _others_all = [], _others_view = [];
      let _others_page = 1, _others_pageSize = 20;

      // dùng helpers global $/$$ nếu có; nếu không, fallback
      const _$  = (typeof $  === 'function') ? $  : (s,r=document)=>r.querySelector(s);
      const _$$ = (typeof $$ === 'function') ? $$ : (s,r=document)=>Array.from(r.querySelectorAll(s));

      // ==== helpers đặt tên có tiền tố others_ để tránh trùng ====
      function others_stripVN(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D'); }
      function others_key(s){ return others_stripVN(String(s||'')).toLowerCase().trim(); }
      function others_isOther(val){
        const k = others_key(val||'');
        return k && k !== 'hs' && k !== 'hoc sinh';
      }

      function others_parseVNDate(str){
        const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(!m) return null;
        const d=new Date(+m[3],+m[2]-1,+m[1]);
        return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1])?d:null;
      }
      function others_formatVNDate(d){
        const dd=String(d.getDate()).padStart(2,'0');
        const mm=String(d.getMonth()+1).padStart(2,'0');
        return `${dd}/${mm}/${d.getFullYear()}`;
      }
      function others_addDaysExact(dateObj, days){
        const d=new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0);
        d.setDate(d.getDate()+days);
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }

      // Hạn dùng BHYT: (ngay_het_han_bhyt + 1) -> cuối tháng sau 12 tháng
      function others_calcRangeBHYT12M(oldEndStr){
        const oldEnd = others_parseVNDate(oldEndStr);
        if (!oldEnd) return "—";
        const start = others_addDaysExact(oldEnd, 1);
        const end   = new Date(start.getFullYear(), start.getMonth()+12, 0);
        return `${others_formatVNDate(start)} → ${others_formatVNDate(end)}`;
      }

      function others_detectPageSize(){
        const sec = document.getElementById('page-others');
        const width = sec?.offsetWidth || window.innerWidth;
        _others_pageSize = width <= 767 ? 3 : (width <= 1023 ? 7 : 20);
      }
      // resize handler riêng cho others
      addEventListener('resize', ()=>{
        const prev=_others_pageSize; others_detectPageSize();
        if(prev!==_others_pageSize){ _others_page=1; others_render(); }
      });

      // Nạp danh sách lớp
      async function others_loadClassOptions(){
        const user = JSON.parse(localStorage.getItem('user')||'{}');
        const res = await getAllDanhSachHocsinh?.(user.ma_truong, "");
        const el = document.getElementById('others-classes');
        if (!el) return; el.innerHTML="";
        if (res?.success && Array.isArray(res.data)){
          [...new Set(res.data.map(x=>String(x.lop_hoc||"").trim()).filter(Boolean))]
            .sort()
            .forEach(cls=>{
              const opt=document.createElement('option');
              opt.value=cls; opt.textContent=cls; el.appendChild(opt);
            });
        }
      }

      // Lấy dữ liệu theo lớp đã chọn (hoặc toàn trường) rồi lọc “đối tượng khác”
      async function others_fetchData(){
        others_detectPageSize();
        const user = JSON.parse(localStorage.getItem('user')||'{}');

        const sel = document.getElementById('others-classes');
        const selected = sel ? [...sel.querySelectorAll('option:checked')].map(o=>o.value) : [];
        const classes = selected.length ? selected : [""]; // "" = toàn trường

        const allRows = [];
        for (const cls of classes){
          const hsRes = await getAllDanhSachHocsinh?.(user.ma_truong, cls);
          if (hsRes?.success && Array.isArray(hsRes.data)) allRows.push(...hsRes.data);
        }

        _others_all = (allRows||[]).filter(r => others_isOther(r.doi_tuong_dong));
        others_doSearch();
      }

      // Tìm kiếm nhanh (riêng others)
      function others_doSearch(){
        const q = (document.getElementById('others-search')?.value||'').trim().toLowerCase();
        _others_view = !q ? _others_all : _others_all.filter(r =>
          String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
          String(r.so_dinh_danh||'').toLowerCase().includes(q) ||
          String(r.ma_so_bhxh||'').toLowerCase().includes(q)
        );
        _others_page = 1;
        others_render();
      }

      // Render bảng + phân trang (đặt tên riêng)
      function others_render(){
        const total = _others_view.length;
        const totalEl = document.getElementById('others-total');
        if (totalEl) totalEl.textContent = total;

        const start = (_others_page-1)*_others_pageSize;
        const pageData = _others_view.slice(start, start+_others_pageSize);

        const tbody = document.querySelector('#others-table tbody');
        if (!tbody) return;

        if (!pageData.length){
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-secondary">Không có dữ liệu phù hợp.</td></tr>`;
        } else {
          tbody.innerHTML = pageData.map((r, i)=>{
            const stt = (_others_page - 1) * _others_pageSize + i + 1;
            return `<tr>
              <td class="text-center">${stt}</td>
              <td>${r.ho_ten_hoc_sinh || ''}</td>
              <td>${r.ngay_sinh || ''}</td>
              <td>${r.doi_tuong_dong || ''}</td>
              <td>${r.so_dinh_danh || ''}</td>
              <td>${r.ma_so_bhxh || ''}</td>
              <td>${r.lop_hoc || ''}</td>
              <td>${r.noi_kham_bhyt || ''}</td>
              <td>${others_calcRangeBHYT12M(r.ngay_het_han_bhyt || '')}</td>
            </tr>`;
          }).join('');
        }

        others_renderPagin(total);
      }

      function others_renderPagin(total){
        const ul = document.getElementById('others-pagin'); if(!ul) return; ul.innerHTML='';
        const totalPages = Math.max(1, Math.ceil(total / _others_pageSize));
        if (totalPages <= 1) return;

        const add = (p, label, active=false, disabled=false)=>{
          const li=document.createElement('li');
          li.className=`page-item ${active?'active':''} ${disabled?'disabled':''}`;
          const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.innerHTML=label;
          a.onclick=(e)=>{ e.preventDefault(); if (p<1||p>totalPages||p===_others_page) return; _others_page = p; others_render(); };
          li.appendChild(a); ul.appendChild(li);
        };
        add(_others_page-1, 'Trước', false, _others_page===1);
        let minP = Math.max(1, _others_page-2), maxP = Math.min(totalPages, _others_page+2);
        if (minP > 1) add(1, '1');
        if (minP > 2){ const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">…</span>'; ul.appendChild(li); }
        for (let p=minP; p<=maxP; p++) add(p, String(p), p===_others_page);
        if (maxP < totalPages-1){ const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">…</span>'; ul.appendChild(li); }
        if (maxP < totalPages) add(totalPages, String(totalPages));
        add(_others_page+1, 'Sau', false, _others_page===totalPages);
      }

      // Bind UI (đặt tên riêng)
      function others_bindUI(){
        document.getElementById('others-btn-filter')?.addEventListener('click', ()=>{
          showLoading?.(); Promise.resolve(others_fetchData()).finally(()=>hideLoading?.());
        });
        document.getElementById('others-btn-all')?.addEventListener('click', ()=>{
          const sel = document.getElementById('others-classes'); if(!sel) return;
          [...sel.options].forEach(o=>o.selected=false);
          showLoading?.(); Promise.resolve(others_fetchData()).finally(()=>hideLoading?.());
        });
        document.getElementById('others-search')?.addEventListener('input', ()=>{
          _others_page=1; others_doSearch();
        });

        document.getElementById('others-btn-export')?.addEventListener('click', others_exportExcel);
      }

      // ===== Public API (duy nhất 2 hàm) =====
      window.others_wirePage = async function(){
        await others_loadClassOptions();
        others_bindUI();
      };
      window.others_reload = others_fetchData;





      // Xuất excel – Danh sách đối tượng khác
      // === HÀM XUẤT EXCEL THEO MẪU ===
      async function others_exportExcel(){
        const FONT = 'Times New Roman';

        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('Mau_02_BHYT');

        // 7 cột theo mẫu ảnh
        const widths = [6, 30, 12, 25, 6, 44, 22];
        ws.columns = widths.map((w, i) => ({ key: `c${i+1}`, width: w }));

        const thin   = { style: 'thin',   color: { argb: 'FF808080' } };
        const medium = { style: 'medium', color: { argb: 'FF000000' } };
        const cell = (r, c) => ws.getCell(r, c);
        const merge = (r1, c1, r2, c2, v, opt={})=>{
          ws.mergeCells(r1, c1, r2, c2);
          const cl = cell(r1, c1);
          cl.value = v ?? '';
          cl.font = { name: FONT, size: (opt.font?.size || 11), bold: !!opt.font?.bold, italic: !!opt.font?.italic };
          if (opt.alignment) cl.alignment = opt.alignment;
        };

        // Thông tin đơn vị
        const user = JSON.parse(localStorage.getItem('user')||'{}');
        const unitName = user.ten_truong || user.tenDonVi || user.truong || '';
        const unitCode = user.ma_don_vi || user.ma_truong || '';
        const today = new Date();
        const dd = String(today.getDate()).padStart(2,'0');
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const yyyy = today.getFullYear();

        // Đầu trang
        merge(2,1,2,4, `Tên đơn vị: ${unitName}`, { font:{bold:true}, alignment:{vertical:'middle'} });
        merge(1,5,1,7, `Mẫu số 02/BHYT`, { font:{bold:true}, alignment:{vertical:'middle', horizontal:'right'} });

        merge(3,1,3,4, `Mã đơn vị: ${unitCode}`, { font:{bold:true}, alignment:{vertical:'middle'} });
        merge(2,5,2,7, `Cộng Hòa Xã Hội Chủ Nghĩa Việt Nam`, { font:{bold:true}, alignment:{vertical:'middle', horizontal:'center'} });
        merge(3,5,3,7, `Độc lập - Tự do - Hạnh phúc`, { font:{bold:true}, alignment:{vertical:'middle', horizontal:'center'} });

        ws.addRow([]);

        merge(5,1,5,7, `DANH SÁCH HỌC SINH, SINH VIÊN`, { font:{bold:true, size:14}, alignment:{horizontal:'center', vertical:'middle'} });
        merge(6,1,6,7, `THAM GIA BHYT THEO NHÓM ĐỐI TƯỢNG KHÁC`, { font:{bold:true, size:14}, alignment:{horizontal:'center', vertical:'middle'} });

        ws.addRow([]);

        // Header bảng
        const startRow = 8;
        const headers = ['STT','Họ và tên','Ngày sinh','Mã thẻ BHYT','Lớp','Nơi KCB ban đầu','Hạn dùng'];
        ws.getRow(startRow).values = [ ...headers ];
        const headerRow = ws.getRow(startRow);
        headerRow.font = { name: FONT, size: 11, bold: true };
        headerRow.alignment = { vertical:'middle', horizontal:'center', wrapText:true };
        headerRow.height = 24;
        for (let c=1;c<=7;c++){
          const hcell = cell(startRow, c);
          hcell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFF2F2F2'} };
          hcell.border = { top:medium, left:medium, bottom:thin, right:thin };
          hcell.font = { name: FONT, size: 11, bold: true };
        }

        // Dữ liệu
        const data = (typeof _others_view!=='undefined' && Array.isArray(_others_view)) ? _others_view : [];
        let r = startRow + 1;
        data.forEach((x, idx)=>{
          const rowVals = [
            idx + 1,
            x.ho_ten_hoc_sinh || '',
            x.ngay_sinh || '',
            x.ma_so_bhxh || '',
            x.lop_hoc || '',
            x.noi_kham_bhyt || '',
            (function(){ return others_calcRangeBHYT12M(x.ngay_het_han_bhyt || ''); })()
          ];
          ws.getRow(r).values = rowVals;

          // Font mặc định cho cả dòng
          ws.getRow(r).font = { name: FONT, size: 11 };

          // Căn & viền
          cell(r,1).alignment = { vertical:'middle', horizontal:'center' };
          cell(r,2).alignment = { vertical:'middle', wrapText:true };
          cell(r,3).alignment = { vertical:'middle', horizontal:'center' };
          cell(r,4).alignment = { vertical:'middle', horizontal:'center' };
          cell(r,5).alignment = { vertical:'middle', horizontal:'center' };
          cell(r,6).alignment = { vertical:'middle', wrapText:true };
          cell(r,7).alignment = { vertical:'middle', wrapText:true };
          for (let c=1;c<=7;c++){
            cell(r,c).border = { top:thin, left:medium, bottom:thin, right:thin };
          }
          r++;
        });
        const endRow = r-1;

        // Khung dày ngoài
        for (let c=1;c<=7;c++){
          const topCell = cell(startRow, c);
          topCell.border = {
            top: medium,
            left: c===1?medium:thin,
            bottom: topCell.border.bottom || thin,
            right: c===7?medium:thin
          };
        }
        for (let rr=startRow+1; rr<=endRow; rr++){
          cell(rr,1).border = { top:thin, left:medium, bottom:thin, right:thin };
          cell(rr,7).border = { top:thin, left:thin,   bottom:thin, right:medium };
        }
        for (let c=1;c<=7;c++){
          const bcell = cell(endRow, c);
          bcell.border = {
            top: bcell.border.top || thin,
            left: c===1?medium:thin,
            bottom: medium,
            right: c===7?medium:thin
          };
        }

        ws.addRow([]); ws.addRow([]);

        // Chữ ký
        const signRow1 = endRow + 3;
        ws.mergeCells(signRow1, 1, signRow1, 3);
        cell(signRow1,1).value = 'NGƯỜI LẬP BIỂU';
        cell(signRow1,1).font = { name: FONT, size: 11, bold: true };
        cell(signRow1,1).alignment = { horizontal:'center' };

        ws.mergeCells(signRow1, 5, signRow1, 7);
        cell(signRow1,5).value = `..., ngày ${dd} tháng ${mm} năm ${yyyy}`;
        cell(signRow1,5).font = { name: FONT, size: 11 };
        cell(signRow1,5).alignment = { horizontal:'center' };

        const signRow2 = signRow1 + 1;
        ws.mergeCells(signRow2, 5, signRow2, 7);
        cell(signRow2,5).value = 'THỦ TRƯỞNG ĐƠN VỊ';
        cell(signRow2,5).font = { name: FONT, size: 11, bold: true };
        cell(signRow2,5).alignment = { horizontal:'center' };

        // Chừa dòng ký & tên người lập biểu
        ws.addRow([]); ws.addRow([]); ws.addRow([]);
        const signer = user.ho_ten || user.fullname || '';
        const signRowName = signRow2 + 4;
        ws.mergeCells(signRowName, 1, signRowName, 3);
        cell(signRowName,1).value = signer ? signer : '';
        cell(signRowName,1).font = { name: FONT, size: 11, bold: !!signer };
        cell(signRowName,1).alignment = { horizontal:'center' };

        // Đảm bảo mọi ô (kể cả trống) đều có font Times New Roman
        ws.eachRow({ includeEmpty: true }, (row) => {
          row.eachCell((c) => {
            const f = c.font || {};
            c.font = { name: FONT, size: f.size || 11, bold: !!f.bold, italic: !!f.italic, underline: f.underline || false };
          });
        });

        const blob = await wb.xlsx.writeBuffer()
          .then(buf => new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DS_BHYT_doi_tuong_khac_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      // (Giữ nguyên binding cũ)
      (function(){
        const _origWire = window.others_wirePage;
        window.others_wirePage = async function(){
          await _origWire?.();
          document.getElementById('others-btn-export')?.addEventListener('click', others_exportExcel_Mau02);
        };
      })();

    })();
  </script>
  <!-- ====== KHỐI ĐỐI TƯỢNG KHÁC CHO ADMIN ====== -->










  <!-- ====== KHỐI BHYT CHO ADMIN ===== -->
  <!-- ====== KHỐI BHYT CHƯA THU ===== -->
  <script>
    /* ================== BHYT – CHƯA THU (fixed v2.4) ================== */
    /* YÊU CẦU: đã có API_BASE và nạp qrcode.min.js + html2canvas.min.js */

    /* ===== Fallback Loading ===== */
    (function ensureLoading(){
      if (!document.getElementById('loadingSpinner')) {
        const div=document.createElement('div');
        div.id='loadingSpinner';
        div.style.cssText='display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,.6);align-items:center;justify-content:center;';
        div.innerHTML = '<div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"><span class="visually-hidden">Loading...</span></div>';
        document.body.appendChild(div);
      }
      if (typeof window.showLoading!=='function') window.showLoading = ()=>{ const el=document.getElementById('loadingSpinner'); if(el) el.style.display='flex'; };
      if (typeof window.hideLoading!=='function') window.hideLoading = ()=>{ const el=document.getElementById('loadingSpinner'); if(el) el.style.display='none'; };
    })();

    /* ===== Toast success (xanh lá) & Force unlock scroll ===== */
    function toastSuccess(msg){
      try { if (typeof window.showToast === 'function') return window.showToast(msg, 'success'); } catch(_) {}
      let cont = document.getElementById('toast-container');
      if(!cont){
        cont = document.createElement('div');
        cont.id = 'toast-container';
        cont.style.cssText = 'position:fixed;right:16px;bottom:16px;z-index:1060;';
        document.body.appendChild(cont);
      }
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-white bg-success border-0 show';
      el.setAttribute('role','alert');
      el.style.minWidth='280px';
      el.innerHTML =
        '<div class="d-flex"><div class="toast-body">'
        + (msg||'Thành công')
        + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button></div>';
      cont.appendChild(el);
      el.querySelector('.btn-close').onclick=()=>el.remove();
      setTimeout(()=>el.remove(), 2600);
    }
    
    /* ===== Force unlock scroll (nếu modal bị kẹt) & hook modal unlock ===== */
    function forceUnlockScroll(){
      try{
        document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show'));
        document.querySelectorAll('.modal-backdrop').forEach(b=>b.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.removeProperty('padding-right');
        document.documentElement.style.overflow = '';
      }catch(_){}
    }
    
    /* hook modal để gỡ khóa scroll khi modal đóng */
    function hookModalUnlock(id){
      const el = document.getElementById(id);
      if(!el) return;
      // khi đóng/hide modal (dù user bấm X hay backdrop), chắc chắn gỡ mờ & mở cuộn
      el.addEventListener('hidden.bs.modal', ()=>{ forceUnlockScroll(); }, {once:false});
      el.addEventListener('hidePrevented.bs.modal', ()=>{ forceUnlockScroll(); }, {once:false});
    }

    /* ===== Biến trạng thái ===== */
    const bhytNOIKHAM_SUGGEST = ["TTYT huyện Châu Phú","BVĐK tỉnh An Giang","TTYT huyện Châu Thành","BV Nhi Đồng 2","BV Nhi Đồng 1"];
    let bhyt_user = JSON.parse(localStorage.getItem("user")||"{}");
    let bhyt_allData = [], bhyt_lastFiltered = [];
    let bhyt_pageSize = 20, bhyt_page = 1, bhyt_total = 0;
    let bhyt_sortField = "ho_ten_hoc_sinh", bhyt_sortDir = 1;
    let _currentHS = null, _currentHS_Sua = null, _cachedGiaBHYT = null;
    let bulkSelected = [];

    /* ===== Utils ngày/tiền ===== */
    function displayNgaySinh(raw){
      if(!raw) return "";
      if (typeof raw==="string" && /^\d{4}-\d{2}-\d{2}T/.test(raw)){ const d=new Date(raw); return d.toLocaleDateString("vi-VN"); }
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(String(raw))) return String(raw);
      if (/^\d{4}-\d{2}-\d{2}$/.test(String(raw))){ const [y,m,d]=String(raw).split("-"); return `${d}/${m}/${y}`; }
      return raw;
    }
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1])?d:null; }
    function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }
    function addDaysExact(dateObj, days){ const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function numberToVietnameseText(num){ num=Math.floor(Number(num)||0); if(num===0) return "không đồng"; const dv=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"], cs=[""," một"," hai"," ba"," bốn"," năm"," sáu"," bảy"," tám"," chín"]; function docBa(ba){ let s="", tram=Math.floor(ba/100), chuc=Math.floor((ba%100)/10), don=ba%10; if(tram) s+=" "+cs[tram]+" trăm"; else if(chuc||don) s+=" không trăm"; if(chuc>1){ s+=" "+cs[chuc]+" mươi"; if(don===1) s+=" mốt"; else if(don===5) s+=" lăm"; else if(don) s+=cs[don]; } else if(chuc===1){ s+=" mười"; if(don===5) s+=" lăm"; else if(don) s+=cs[don]; } else if(chuc===0&&don){ s+=" lẻ"+cs[don]; } return s; } let i=0,str=""; while(num>0){ const ba=num%1000; if(ba){ str=docBa(ba)+dv[i]+(str?" "+str:""); } num=Math.floor(num/1000); i++; } return str.trim()+" đồng"; }

    /* ===== Giá BHYT & tính hạn/tiền/hoa hồng ===== */
    async function getGiaBHYT(){ const r=await fetch(`${API_BASE}?func=GetGiaBHYT`); return r.json(); }
    async function ensureGiaBHYT(){ if(_cachedGiaBHYT) return _cachedGiaBHYT; const g=await getGiaBHYT(); _cachedGiaBHYT=g?.data?.[0]||null; return _cachedGiaBHYT; }
    function computeAmountAndExp(oldEndStr, months, basePrice){
      const oldEnd=parseVNDate(oldEndStr), m=parseInt(months||0,10); let exp='—', note='';
      if(oldEnd && m>0){ const start=addDaysExact(oldEnd,1); const lastDay=new Date(start.getFullYear(), start.getMonth()+m, 0); exp=formatVNDate(lastDay); }
      else { exp='(không xác định)'; note='Không xác định do chưa nhập ngày hết hạn thẻ cũ trong DanhSach_Hocsinh.'; }
      const amount=(parseInt(basePrice||0,10)||0)*(m||0);
      return {exp, amount, note};
    }
    function toRate(val){ let n=Number(String(val??'').replace(',','.')); if(!isFinite(n)||n<=0) return 0; return n>1 ? n/100 : n; }
    function getRateByMonths(g, months){
      const m=String(months);
      if(m==='3') return toRate(g?.hoa_hong_3_thang);
      if(m==='6') return toRate(g?.hoa_hong_6_thang);
      return toRate(g?.hoa_hong_12_thang);
    }

    /* ===== API ===== */
    async function getAllBHYT(ma_truong, lop){ const r=await fetch(`${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`); return r.json(); }
    async function getHosoBHYTByHS(so_dinh_danh, ma_truong, lop){ const r=await fetch(`${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`); return r.json(); }
    async function getTenTruong(ma_truong){ try{ const r=await fetch(`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`); const j=await r.json(); return j?.ten_truong || j?.data?.ten_truong || bhyt_user.ten_truong || ma_truong || '—'; }catch(e){ return bhyt_user.ten_truong||ma_truong||'—'; } }
    async function getAllHocsinhByClass(ma_truong, lop){ const r=await fetch(`${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop||'')}`); return r.json(); }
    async function nopHoSoBHYTApi(payload){ const params=Object.entries(payload).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&'); const r=await fetch(`${API_BASE}?func=NopHoSoBHYT&${params}`); return r.json(); }
    async function suaHoSoBHYTApi(payload){ const params=Object.entries(payload).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&'); const r=await fetch(`${API_BASE}?func=SuaHoSoBHYT&${params}`); return r.json(); }

    /* ===== Lớp (multiple) ===== */
    async function loadClassOptions(){
      const res = await getAllHocsinhByClass(bhyt_user.ma_truong, "");
      const el = document.getElementById('bhyt-classes'); if(!el) return; el.innerHTML="";
      if(res?.success && Array.isArray(res.data)){
        [...new Set(res.data.map(x=>String(x.lop_hoc||"").trim()).filter(Boolean))].sort()
          .forEach(cls=>{ const opt=document.createElement('option'); opt.value=cls; opt.textContent=cls; el.appendChild(opt); });
      }
    }

    /* ===== Lấy dữ liệu “chưa thu” (nhiều lớp) ===== */
    async function fetchChuaThuHocsinh(){
      try{
        showLoading();
        const el = document.getElementById('bhyt-classes');
        const selected = el ? [...el.querySelectorAll('option:checked')].map(o=>o.value) : [];
        const classes = selected.length ? selected : [""];
        const allHS = [];
        for(const cls of classes){
          const hsRes = await getAllHocsinhByClass(bhyt_user.ma_truong, cls);
          if(hsRes?.success && Array.isArray(hsRes.data)) allHS.push(...hsRes.data);
        }
        const statusMap = {};
        for(const cls of classes){
          const bhytRes = await getAllBHYT(bhyt_user.ma_truong, cls);
          const ds = Array.isArray(bhytRes?.data) ? bhytRes.data : [];
          ds.forEach(row => { const key=String(row.so_dinh_danh).replace(/^'/,'').trim(); statusMap[key]=Number(row.trang_thai); });
        }
        bhyt_allData = (allHS||[]).map(hs=>{
          const k=String(hs.so_dinh_danh||"").replace(/^'/,'').trim();
          const tt=statusMap[k];
          return {...hs, _bhyt_trangthai:(tt===undefined?undefined:tt), trang_thai:tt};
        }).filter(hs=>hs._bhyt_trangthai !== 1);
        bhyt_page = 1; doSearchBHYT(); clearBulkSelection();
      } catch(e){ console.error('[BHYT] fetchChuaThuHocsinh error', e); }
      finally{ hideLoading(); }
    }

    /* ===== Tìm kiếm – Sắp xếp – Phân trang ===== */
    function detectPageSizeBHYT(){
      const width = document.querySelector('#page-bhyt')?.offsetWidth || window.innerWidth;
      if (width <= 767) bhyt_pageSize = 3;
      else if (width <= 1023) bhyt_pageSize = 7;
      else bhyt_pageSize = 20;
    }
    
    window.addEventListener('resize', () => {
      const prev = bhyt_pageSize; detectPageSizeBHYT();
      if (bhyt_pageSize !== prev){ bhyt_page = 1; renderAllViewBHYT(); }
    });
    
    function doSearchBHYT(){
      const q = String(document.getElementById('bhyt-search')?.value||"").trim().toLowerCase();
      bhyt_lastFiltered = !q ? bhyt_allData : bhyt_allData.filter(hs =>
        (String(hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q)) ||
        (String(displayNgaySinh(hs.ngay_sinh||"")||"").toLowerCase().includes(q)) ||
        (String(hs.so_dinh_danh||"").toLowerCase().includes(q))
      );
      bhyt_page=1; renderAllViewBHYT();
    }
    
    function renderAllViewBHYT(){
      let data = bhyt_lastFiltered || bhyt_allData;
      if (bhyt_sortField){
        data = [...data].sort((a,b)=>{
          let av=(a[bhyt_sortField]||"").toString().toLowerCase();
          let bv=(b[bhyt_sortField]||"").toString().toLowerCase();
          if(!isNaN(av)&&!isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if(av<bv) return -bhyt_sortDir; if(av>bv) return bhyt_sortDir; return 0;
        });
      }
      bhyt_total = data.length; const elT=document.getElementById('bhyt-total'); if(elT) elT.innerText = bhyt_total;
      detectPageSizeBHYT();
      const start=(bhyt_page-1)*bhyt_pageSize, pageData=data.slice(start, start+bhyt_pageSize);
      renderDanhSachHS(pageData);
      renderPaginationBHYT(data.length);
      updateBulkButton();
    }
    
    function renderPaginationBHYT(total){
      const totalPages = Math.max(1, Math.ceil(total / bhyt_pageSize));
      const ul = document.getElementById('bhyt-pagin'); if(!ul) return; ul.innerHTML='';
      if (totalPages <= 1) return;
      const add = (p, label, active=false, disabled=false) => {
        const li=document.createElement('li');
        li.className=`page-item ${active?'active':''} ${disabled?'disabled':''}`;
        const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.innerHTML=label;
        a.onclick=(e)=>{ e.preventDefault(); if (p<1||p>totalPages||p===bhyt_page) return; bhyt_page = p; renderAllViewBHYT(); };
        li.appendChild(a); ul.appendChild(li);
      };
      add(bhyt_page-1, 'Trước', false, bhyt_page===1);
      let minP = Math.max(1, bhyt_page-2), maxP = Math.min(totalPages, bhyt_page+2);
      if (minP > 1) add(1, '1');
      if (minP > 2) { const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; ul.appendChild(li); }
      for (let p=minP; p<=maxP; p++) add(p, String(p), p===bhyt_page, false);
      if (maxP < totalPages-1) { const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; ul.appendChild(li); }
      if (maxP < totalPages) add(totalPages, String(totalPages));
      add(bhyt_page+1, 'Sau', false, bhyt_page===totalPages);
    }

    /* ===== Bảng danh sách ===== */
    function sortIconBHYT(field){ if(bhyt_sortField!==field) return ''; return bhyt_sortDir===1 ? '<span class="sort-icon">&#9650;</span>' : '<span class="sort-icon">&#9660;</span>'; }
    window.doSort = function(field){ if(bhyt_sortField===field) bhyt_sortDir=-bhyt_sortDir; else { bhyt_sortField=field; bhyt_sortDir=1; } renderAllViewBHYT(); };
    
    /* hiển thị danh sách Học sinh */
    function renderDanhSachHS(ds){
      const wrap = document.getElementById('bhyt-ds'); if(!wrap) return;
      if (!ds || ds.length === 0){
        wrap.innerHTML = `<div class='text-center text-secondary mt-4'>Không có học sinh chưa thu trong lựa chọn này.</div>`;
        return;
      }
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
          <th style="width:42px;"><input type="checkbox" id="chk-bulk-all" onchange="toggleSelectAllBulk(this)"></th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh ${sortIconBHYT('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh ${sortIconBHYT('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân ${sortIconBHYT('so_dinh_danh')}</th>
        </tr></thead><tbody>`;
      ds.forEach((hs) => {
        if (hs._bhyt_trangthai === 1) return;
        const hasOld = !!parseVNDate(hs.ngay_het_han_bhyt);
        const nopDisabled = (hs._bhyt_trangthai === 0) || !hasOld;
        const nopLabel = (hs._bhyt_trangthai === 0) ? "Chờ duyệt" : (!hasOld ? "Thiếu hạn cũ" : "Nộp hồ sơ");
        html += `<tr>
          <td><input type="checkbox" class="chk-bulk-row" data-stt="${hs.stt}" onchange="onSelectRowBulk('${hs.stt}', this)" ${hs._bhyt_trangthai===0 ? 'disabled' : ''}></td>
          <td>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="showNopHoSoModal('${hs.stt}')" ${nopDisabled ? 'disabled' : ''}>${nopLabel}</button>
              ${!hasOld ? '<div class="text-danger small mt-1">Chưa có ngày hết hạn thẻ cũ</div>' : ''}
              ${(hs._bhyt_trangthai === 0 || hs._bhyt_trangthai === 1) ? `
                <button class="btn btn-warning btn-sm" onclick="suaHoSo('${hs.stt}')" title="Sửa hồ sơ">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${hs.stt}')" title="In phiếu thu">
                  <i class="bi bi-printer"></i>
                </button>
              ` : ``}
              ${(hs._bhyt_trangthai === 0) ? `
                <button class="btn btn-danger btn-sm" onclick="bhyt_cancelPending('${hs.stt}')" title="Hủy hồ sơ chờ duyệt">
                  <i class="bi bi-x-circle"></i>
                </button>
              ` : ``}
            </div>
          </td>
          <td>${hs.ho_ten_hoc_sinh || ""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh) || ""}</td>
          <td>${hs.so_dinh_danh || ""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      wrap.innerHTML = html;
    }

    /* ===== Bulk select ===== */
    function getSelectedRowsData(){ const map={}; (bhyt_lastFiltered||bhyt_allData).forEach(h=>{ map[String(h.stt)]=h; }); return bulkSelected.map(stt=>map[String(stt)]).filter(Boolean).filter(hs => !(hs._bhyt_trangthai === 0 || hs._bhyt_trangthai === 1)); }
    function onSelectRowBulk(stt, el){ if (el.checked){ if (!bulkSelected.includes(stt)) bulkSelected.push(stt); } else { bulkSelected = bulkSelected.filter(x => x !== stt); const allCb=document.getElementById('chk-bulk-all'); if(allCb) allCb.checked=false; } updateBulkButton(); }
    function toggleSelectAllBulk(el){ document.querySelectorAll('.chk-bulk-row').forEach(cb=>{ if(cb.disabled) return; cb.checked=el.checked; const stt=cb.getAttribute('data-stt'); if(el.checked){ if(!bulkSelected.includes(stt)) bulkSelected.push(stt); } else { bulkSelected = bulkSelected.filter(x=>x!==stt); } }); updateBulkButton(); }
    function updateBulkButton(){ const btn=document.getElementById('btn-bulk-submit'); const c=getSelectedRowsData().length; if(!btn) return; if(c>0){ btn.style.display=''; btn.innerText=`Nộp nhiều hồ sơ (${c})`; } else { btn.style.display='none'; btn.innerText='Nộp nhiều hồ sơ (0)'; } }
    function clearBulkSelection(){ bulkSelected=[]; document.querySelectorAll('.chk-bulk-row').forEach(cb=>cb.checked=false); const allCb=document.getElementById('chk-bulk-all'); if(allCb) allCb.checked=false; updateBulkButton(); }

    /* ===== Nộp/Sửa hồ sơ ===== */
    function showNopHoSoModal(stt){
      const hs = (bhyt_lastFiltered||bhyt_allData).find(h=>String(h.stt)===String(stt)); if(!hs) return;
      _currentHS = hs;
      document.getElementById('nhs-hoten').value = hs.ho_ten_hoc_sinh||"";
      document.getElementById('nhs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh||"");
      document.getElementById('nhs-noikham').value = hs.noi_kham_bhyt||"";
      document.getElementById('nhs-exp-note').innerText = "";
      document.getElementById('noikham-list').innerHTML = bhytNOIKHAM_SUGGEST.map(x=>`<option value="${x}">`).join('');
      new bootstrap.Modal(document.getElementById('modalNopHoSoBHYT')).show();
      (async ()=>{ const g=await ensureGiaBHYT(); const months=document.querySelector('input[name="nhs-thang"]:checked').value; const {exp,amount,note}=computeAmountAndExp(hs.ngay_het_han_bhyt, months, g?.gia_tien); document.getElementById('nhs-exp-preview').innerText=exp; document.getElementById('nhs-amount-preview').innerText=(amount||0).toLocaleString('vi-VN'); document.getElementById('nhs-exp-note').innerText=note||""; })();
    }
    async function submitNopHoSoBHYT(){
      if(!_currentHS) return;
      showLoading();
      try{
        const g = await ensureGiaBHYT();
        const months = document.querySelector('input[name="nhs-thang"]:checked').value;
        const noikham = document.getElementById('nhs-noikham').value.trim();
        const {exp, amount} = computeAmountAndExp(_currentHS.ngay_het_han_bhyt, months, g?.gia_tien);
        const rate = getRateByMonths(g, months);
        const hh = parseFloat((amount * rate).toFixed(2));

        const res = await nopHoSoBHYTApi({
          so_dinh_danh: _currentHS.so_dinh_danh,
          ma_truong: bhyt_user.ma_truong,
          lop_hoc: _currentHS.lop_hoc||"",
          so_thang_dong: months,
          noi_kham_bhyt: noikham,
          so_tien: amount,
          hoa_hong: hh,
          so_ho_so: 'null',
          han_su_dung_bhyt_moi: exp
        });

        if(res?.success){
          bootstrap.Modal.getInstance(document.getElementById('modalNopHoSoBHYT'))?.hide();
          forceUnlockScroll();
          toastSuccess('Nộp hồ sơ thành công');
          await fetchChuaThuHocsinh();
        } else {
          document.getElementById('nhs-error').innerText = res?.message || 'Lỗi nộp hồ sơ';
        }
      } catch(e){ console.error(e); }
      finally{ hideLoading(); }
    }


    /* ===== Hiển thị Modal sửa Hồ sơ Danh sách BHYT Chưa thu ===== */
    async function showSuaHoSoModal(stt){
      const hs = (bhyt_lastFiltered||bhyt_allData).find(h=>String(h.stt)===String(stt)); if(!hs) return;
      _currentHS_Sua = hs;
      showLoading();
      try{
        document.getElementById('shs-hoten').value = hs.ho_ten_hoc_sinh||"";
        document.getElementById('shs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh||"");
        document.getElementById('shs-noikham').value = hs.noi_kham_bhyt||"";
        const info = await getHosoBHYTByHS(hs.so_dinh_danh, bhyt_user.ma_truong, hs.lop_hoc||"");
        const months = String(info?.data?.so_thang_dong||'12');
        const rSel = document.querySelector(`input[name="shs-thang"][value="${months}"]`);
        if (rSel) rSel.checked = true;
        const g = await ensureGiaBHYT();
        const {exp, amount, note} = computeAmountAndExp(hs.ngay_het_han_bhyt, months, g?.gia_tien);
        document.getElementById('shs-exp-preview').innerText = exp;
        document.getElementById('shs-amount-preview').innerText = (amount||0).toLocaleString('vi-VN');
        document.getElementById('shs-exp-note').innerText = note||"";
        new bootstrap.Modal(document.getElementById('modalSuaHoSoBHYT')).show();
      } catch(e){ console.error(e); }
      finally{ hideLoading(); }
    }
    /* ===== Submit Modal sửa Hồ sơ Danh sách BHYT Chưa thu ===== */
    async function submitSuaHoSoBHYT(){
      if(!_currentHS_Sua) return;
      showLoading();
      try{
        const g = await ensureGiaBHYT();
        const months = document.querySelector('input[name="shs-thang"]:checked')?.value||'12';
        const noikham = document.getElementById('shs-noikham').value.trim();
        const {exp, amount} = computeAmountAndExp(_currentHS_Sua.ngay_het_han_bhyt, months, g?.gia_tien);
        const rate = getRateByMonths(g, months);
        const hh = parseFloat((amount * rate).toFixed(2));

        const res = await suaHoSoBHYTApi({
          so_dinh_danh: _currentHS_Sua.so_dinh_danh,
          ma_truong: bhyt_user.ma_truong,
          lop_hoc: _currentHS_Sua.lop_hoc||"",
          so_thang_dong: months,
          noi_kham_bhyt: noikham,
          so_tien: amount,
          hoa_hong: hh,
          han_su_dung_bhyt_moi: exp,
          phan_quyen: bhyt_user.phan_quyen
        });

        if(res?.success){
          bootstrap.Modal.getInstance(document.getElementById('modalSuaHoSoBHYT'))?.hide();
          forceUnlockScroll();
          toastSuccess('Đã lưu thay đổi');
          await fetchChuaThuHocsinh();

          // cũng reload danh sách ĐÃ THU nếu hàm reload có tồn tại
          if (window.bhyt_paid_reload) {
            await window.bhyt_paid_reload();
          }

        } else {
          document.getElementById('shs-error').innerText = res?.message || 'Lỗi lưu hồ sơ';
        }
      } catch(e){ console.error(e); }
      finally{ hideLoading(); }
    }




    // Hủy hồ sơ chờ duyệt trong tab Chưa thu
    // async function bhyt_cancelPending(stt){
    //   const hs = (bhyt_lastFiltered||bhyt_allData).find(h=>String(h.stt)===String(stt));
    //   if (!hs) return;
    //   if (!window.confirm(`Bạn có chắc muốn hủy hồ sơ BHYT đang chờ duyệt của học sinh "${hs.ho_ten_hoc_sinh}"?`)) return;

    //   showLoading();
    //   try{
    //     const rs = await deleteBHYTByKey({
    //       so_dinh_danh: hs.so_dinh_danh,
    //       ma_truong: bhyt_user.ma_truong,
    //       lop_hoc: hs.lop_hoc || "",
    //       phan_quyen: bhyt_user.phan_quyen || ""
    //     });
    //     if (rs?.success) {
    //       toastSuccess('Đã hủy hồ sơ BHYT đang chờ duyệt');
    //       await fetchChuaThuHocsinh();
    //       if (window.bhyt_paid_reload) await window.bhyt_paid_reload();
    //     } else {
    //       showToast(rs?.message || 'Không thể hủy hồ sơ', 'danger');
    //     }
    //   } finally {
    //     hideLoading();
    //   }
    // }

    function bhyt_cancelPending(stt) {
      const hs = (bhyt_lastFiltered || bhyt_allData).find(h => String(h.stt) === String(stt));
      if (!hs) return;

      showBHYTConfirm(
        `Bạn có chắc muốn hủy hồ sơ BHYT đang chờ duyệt của học sinh <strong>${hs.ho_ten_hoc_sinh}</strong>?`,
        async function () {
          showLoading();
          try {
            const rs = await deleteBHYTByKey({
              so_dinh_danh: hs.so_dinh_danh,
              ma_truong: bhyt_user.ma_truong,
              lop_hoc: hs.lop_hoc || "",
              phan_quyen: bhyt_user.phan_quyen || ""
            });
            if (rs?.success) {
              toastSuccess('Đã hủy hồ sơ BHYT đang chờ duyệt');
              await fetchChuaThuHocsinh();
              if (window.bhyt_paid_reload) await window.bhyt_paid_reload();
            } else {
              showToast(rs?.message || 'Không thể hủy hồ sơ', 'danger');
            }
          } finally {
            hideLoading();
          }
        }
      );
    }



    /* ===== Alias tên hàm theo mẫu ===== */
    window.suaHoSo = (stt)=>showSuaHoSoModal(stt);
    window.inPhieuThu = (stt)=>openPreviewReceipt(stt);






    /* ===== Bulk ===== */
    function showBulkNopHoSoModal(){
      const list = getSelectedRowsData(); if (!list.length) return;
      document.getElementById('bulk-count-label').innerText = list.length;
      document.getElementById('bulk-exp-note').innerText = "";
      new bootstrap.Modal(document.getElementById('modalBulkNopHoSo')).show();
      (async ()=>{
        const g=await ensureGiaBHYT();
        const months=document.querySelector('input[name="bulk-thang"]:checked')?.value||'12';
        const anyOld=parseVNDate(list[0]?.ngay_het_han_bhyt);
        const {exp,amount,note}=computeAmountAndExp(anyOld?formatVNDate(anyOld):"", months, g?.gia_tien);
        document.getElementById('bulk-exp-preview').innerText=exp;
        document.getElementById('bulk-amount-preview').innerText=(amount||0).toLocaleString('vi-VN');
        document.getElementById('bulk-exp-note').innerText=note||"";
      })();
    }
    async function submitBulkNopHoSo(){
      const list = getSelectedRowsData(); if(!list.length) return;
      const months=document.querySelector('input[name="bulk-thang"]:checked')?.value||'12';
      const noikham=document.getElementById('bulk-noikham').value.trim();
      showLoading();
      try{
        const g=await ensureGiaBHYT();
        const rate=getRateByMonths(g, months);
        for (const hs of list){
          const {exp, amount} = computeAmountAndExp(hs.ngay_het_han_bhyt, months, g?.gia_tien);
          const hh = parseFloat((amount * rate).toFixed(2));
          await nopHoSoBHYTApi({
            so_dinh_danh: hs.so_dinh_danh,
            ma_truong: bhyt_user.ma_truong,
            lop_hoc: hs.lop_hoc||"",
            so_thang_dong: months,
            noi_kham_bhyt: noikham || hs.noi_kham_bhyt || "",
            so_tien: amount,
            hoa_hong: hh,
            so_ho_so: 'null',
            han_su_dung_bhyt_moi: exp
          });
        }
        toastSuccess(`Đã nộp ${list.length} hồ sơ`);
        const mm = bootstrap.Modal.getInstance(document.getElementById('modalBulkNopHoSo'));
        if (mm) mm.hide();
        forceUnlockScroll();     // tránh kẹt cuộn/overlay
        await fetchChuaThuHocsinh();
      }catch(e){ console.error(e); }
      finally{ hideLoading(); }
    }

    /* ===== Radio change → cập nhật preview ngay ===== */
    ['nhs-thang-3','nhs-thang-6','nhs-thang-12'].forEach(id=>{
      document.getElementById(id)?.addEventListener('change', async ()=>{
        if(!_currentHS) return; const g=await ensureGiaBHYT(); const months=document.querySelector('input[name="nhs-thang"]:checked').value;
        const {exp, amount, note} = computeAmountAndExp(_currentHS.ngay_het_han_bhyt, months, g?.gia_tien);
        document.getElementById('nhs-exp-preview').innerText = exp;
        document.getElementById('nhs-amount-preview').innerText = (amount||0).toLocaleString('vi-VN');
        document.getElementById('nhs-exp-note').innerText = note||"";
      });
    });
    ['shs-thang-3','shs-thang-6','shs-thang-12'].forEach(id=>{
      document.getElementById(id)?.addEventListener('change', async ()=>{
        if(!_currentHS_Sua) return; const g=await ensureGiaBHYT(); const months=document.querySelector('input[name="shs-thang"]:checked').value;
        const {exp, amount, note} = computeAmountAndExp(_currentHS_Sua.ngay_het_han_bhyt, months, g?.gia_tien);
        document.getElementById('shs-exp-preview').innerText = exp;
        document.getElementById('shs-amount-preview').innerText = (amount||0).toLocaleString('vi-VN');
        document.getElementById('shs-exp-note').innerText = note||"";
      });
    });
    ['bulk-thang-3','bulk-thang-6','bulk-thang-12'].forEach(id=>{
      document.getElementById(id)?.addEventListener('change', async ()=>{
        const list=getSelectedRowsData(); if(!list.length) return; const g=await ensureGiaBHYT(); const months=document.querySelector('input[name="bulk-thang"]:checked')?.value||'12';
        const anyOld=parseVNDate(list[0]?.ngay_het_han_bhyt); const {exp,amount,note}=computeAmountAndExp(anyOld?formatVNDate(anyOld):"", months, g?.gia_tien);
        document.getElementById('bulk-exp-preview').innerText=exp; document.getElementById('bulk-amount-preview').innerText=(amount||0).toLocaleString('vi-VN'); document.getElementById('bulk-exp-note').innerText=note||"";
      });
    });

    /* ===== Phiếu thu (Preview & In TRONG TRANG) ===== */
    async function openPreviewReceipt(stt){
      const hs = (bhyt_lastFiltered||bhyt_allData).find(h=>String(h.stt)===String(stt)); if(!hs) return;
      showLoading();
      try{
        const school = await getTenTruong(bhyt_user.ma_truong);
        const g = await ensureGiaBHYT();
        const months = '12';
        const {exp, amount} = computeAmountAndExp(hs.ngay_het_han_bhyt, months, g?.gia_tien);

        document.getElementById('rec-school').innerText = school || (bhyt_user.ten_truong||'—');
        document.getElementById('rec-class').innerText = hs.lop_hoc||'—';
        document.getElementById('rec-student-name').innerText = hs.ho_ten_hoc_sinh||'—';
        document.getElementById('rec-address').innerText = hs.dia_chi||'—';
        document.getElementById('rec-content').innerText = 'Thu Bảo hiểm y tế (BHYT) học sinh';
        document.getElementById('rec-months').innerText = months;
        const startDate = formatVNDate(addDaysExact(parseVNDate(hs.ngay_het_han_bhyt)||new Date(),1));
        document.getElementById('rec-range').innerText = `từ ngày ${startDate} đến ngày ${exp}`;
        document.getElementById('rec-amount').innerText = (amount||0).toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnameseText(amount||0);
        document.getElementById('rec-teacher-name').innerText = bhyt_user.ho_ten || '—';
        const t=new Date(); document.getElementById('rec-date-today').innerText = `Ngày ${t.getDate()} tháng ${t.getMonth()+1} năm ${t.getFullYear()}`;
        const qrWrap = document.getElementById('receipt-qr'); 
        qrWrap.innerHTML = "";
        const schoolName = document.getElementById('schoolName').innerText.trim();
        const classCode = hs.lop_hoc || "";
        const studentName = hs.ho_ten_hoc_sinh || "";
        const endText = exp;

        
        const primaryText = buildQRPayload(
          bhyt_user.ma_truong,
          schoolName,
          classCode,
          studentName,
          months,
          endText
        );
        try {
          new QRCode(qrWrap, {
            text: primaryText,
            width: 96,
            height: 96,
            correctLevel: QRCode.CorrectLevel.L
          });
        } catch (e) {
          console.warn(logPrefix, "QR overflow, fallback", e);
          const fallbackText = `MT=${String(bhyt_user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(studentName)};M=${months};E=${endText}`;
          try {
            new QRCode(qrWrap, {
              text: fallbackText,
              width: 96,
              height: 96,
              correctLevel: QRCode.CorrectLevel.L
            });
          } catch (e2) {
            qrWrap.innerHTML = '<small>QR quá dài</small>';
          }
        }
        const _mEl = document.getElementById('modalPhieuThu');
        if (_mEl && _mEl.parentElement !== document.body) document.body.appendChild(_mEl);
        new bootstrap.Modal(_mEl).show();

      } finally{ hideLoading(); }
    }

    /* Tạo chuỗi QR theo chuẩn */
    function buildQRPayload(maTruong, school, lop, ten, thang, hanSuDung) {
      return `MT=${maTruong};S=${stripVN(school)};L=${lop};N=${stripVN(ten)};M=${thang};E=${hanSuDung}`;
    }


    /* Loại bỏ dấu tiếng Việt để QR ngắn hơn */
    function stripVN(str) {
      return String(str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }

    /* Lấy chữ cái đầu tên để QR ngắn hơn */
    function initials(str) {
      return String(str || "").trim().split(/\s+/).map(w => w[0] || '').join('').toUpperCase();
    }

    /* In ngay trong trang hiện tại – KHÔNG vỡ giao diện, không nhân bản */
    function printReceiptOnly() {
      const receipt = document.getElementById('receiptA5');
      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.top = '-1000px';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      document.body.appendChild(iframe);

      const css = `
        <style>
          @page { size: A5 portrait; margin: 10mm; }
          html,body{ background:#fff; margin:0; padding:0; height:auto !important; }
          .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000;
                    margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px;
                    page-break-inside: avoid; }
          .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
          .receipt-sub{ font-style:italic; }
          .receipt-meta{ font-size:13px; }
          .receipt-line{ margin:2mm 0; }
          .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
          .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
          .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
          .row{ display:flex; flex-wrap:nowrap; width:100%; }
          .col{ flex:1 1 0; }
          .text-center{ text-align:center; }
        </style>
      `;

      const content = receipt.outerHTML;
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <title>Phiếu thu</title>
            ${css}
          </head>
          <body>${content}</body>
        </html>
      `);
      doc.close();

      // Đợi QR render xong
      const check = () => {
        if (iframe.contentDocument.querySelector('#receipt-qr img')?.complete) {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
          setTimeout(() => {
            if (document.body.contains(iframe)) document.body.removeChild(iframe);
          }, 500);
        } else {
          setTimeout(check, 50);
        }
      };
      check();
    }

    /* Tải ảnh PNG của phiếu thu */
    async function downloadReceiptImage(){
      const el = document.getElementById('receiptA5'); if(!el) return;
      const canvas = await html2canvas(el,{useCORS:true,scale:2});
      const link = document.createElement('a'); link.download='phieu_thu_a5.png'; link.href=canvas.toDataURL('image/png'); link.click();
    }

    /* ===== Events + wire page ===== */
    document.getElementById('bhyt-btn-reload')?.addEventListener('click', fetchChuaThuHocsinh);
    document.getElementById('bhyt-search')?.addEventListener('input', doSearchBHYT);
    document.getElementById('btn-bulk-submit')?.addEventListener('click', showBulkNopHoSoModal);


    /* NEW: nút chọn toàn trường – bỏ chọn tất cả lớp và tải toàn trường */
    document.getElementById('bhyt-btn-all')?.addEventListener('click', ()=>{
      const sel = document.getElementById('bhyt-classes');
      if (!sel) return;
      [...sel.options].forEach(o => o.selected = false);
      fetchChuaThuHocsinh();
    });

    /* Hook modal để tránh kẹt màn mờ khi đóng mà chưa nộp */
    hookModalUnlock('modalBulkNopHoSo');
    hookModalUnlock('modalNopHoSoBHYT');
    hookModalUnlock('modalSuaHoSoBHYT');
    hookModalUnlock('modalPhieuThu');
    hookModalUnlock('modalSuaHoSoBHYT_DaThu');


    /* Router gọi khi vào tab BHYT */
    window.bhyt_wirePage = function(){
      if (window._bhytWired) return;
      window._bhytWired = true;
      if(!bhyt_user?.ma_truong){ console.warn('Thiếu thông tin trường'); }
      loadClassOptions();
      fetchChuaThuHocsinh();
    };

    /* NEW: map reload → fetch danh sách */
    window.bhyt_reload = fetchChuaThuHocsinh;

    /* Init nhẹ (không auto fetch) */
    (function initBHYT(){ if(!bhyt_user?.ma_truong) return; /* no-op */ })();
  </script>


  <!-- ====== KHỐI BHYT ĐÃ THU ===== -->
  <script>
    /* ================== BHYT ĐÃ THU – Admin Tab ================== */
    /* Dùng chung: API_BASE, showLoading/hideLoading, QRCode, html2canvas,
      numberToVietnameseText(), buildQRPayload(), getTenTruong(), bhyt_user (đã có ở tab Chưa thu) */
    (function(){

      // State chung
      let bhytp_allData = [], bhytp_lastFiltered = [];
      let bhytp_pageSize = 20, bhytp_page = 1, bhytp_total = 0;
      let bhytp_sortField = "ho_ten_hoc_sinh", bhytp_sortDir = 1;
      window._bhytpView = [];


      // Biến riêng cho modal "đã thu"
      let _currentHS_Sua_DaThu = null;


      // Logging toàn bộ dùng chung Danh sách BHYT ĐÃ THU
      const BHYTP_LOG_PREFIX = '[BHYT-PAID]';
      const log = (...a) => console.log(BHYTP_LOG_PREFIX, ...a);
      const warn = (...a) => console.warn(BHYTP_LOG_PREFIX, ...a);
      const err = (...a) => console.error(BHYTP_LOG_PREFIX, ...a);


      /* ===== Utils ===== */
      function bhytp_displayDate(raw){
        if(!raw) return "";
        if (typeof raw==='string' && /^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
        if (typeof raw==='string' && /^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
        if (typeof raw==='string' && /^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;
        return raw;
      }
      function bhytp_escapeHtml(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}
      function bhytp_cleanVal(v){const s=String(v??"").trim();return (!s||s==='null'||s==='NULL'||s==='undefined'||s==='NaN'||s==='-')?"":s}
      function bhytp_getSoHoSo(row){return bhytp_cleanVal(row.so_ho_so??row.sohoso??row.so_hs)}
      function bhytp_sortIcon(field){ if(bhytp_sortField!==field) return ''; return bhytp_sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
      function bhytp_detectPageSize(){
        const w = document.querySelector('#tab-other')?.offsetWidth || window.innerWidth;
        if (w <= 600) bhytp_pageSize = 5;
        else if (w <= 999) bhytp_pageSize = 10;
        else bhytp_pageSize = 20;
      }
      window.addEventListener('resize', ()=>{const prev=bhytp_pageSize; bhytp_detectPageSize(); if(prev!==bhytp_pageSize){ bhytp_page=1; bhytp_renderAllView(); }});

      /* ===== Classes (multiple) ===== */
      async function bhytp_loadClassOptions(){
        try{
          const res = await getAllHocsinhByClass(bhyt_user.ma_truong, "");
          const el = document.getElementById('bhytp-classes'); if(!el) return; el.innerHTML="";
          if(res?.success && Array.isArray(res.data)){
            [...new Set(res.data.map(x=>String(x.lop_hoc||"").trim()).filter(Boolean))]
              .sort()
              .forEach(cls=>{ const opt=document.createElement('option'); opt.value=cls; opt.textContent=cls; el.appendChild(opt); });
          }
        }catch(e){}
      }

      /* ===== Fetch data (ĐÃ THU = danh sách hồ sơ BHYT) ===== */
      async function bhytp_fetchPaidBHYT(){
        showLoading();
        try{
          bhytp_detectPageSize();
          const sel = document.getElementById('bhytp-classes');
          const selected = sel ? [...sel.querySelectorAll('option:checked')].map(o=>o.value) : [];
          const classes = selected.length ? selected : [""];  // "" = cả trường (API phía bạn)
          const allRows = [];
          for(const cls of classes){
            const rs = await getAllBHYT(bhyt_user.ma_truong, cls);
            const rows = Array.isArray(rs?.data) ? rs.data : [];
            // Chuẩn hóa trạng thái và lọc bản ghi hợp lệ
            rows.forEach(r=> allRows.push({...r, trang_thai: (r.trang_thai===undefined ? undefined : Number(r.trang_thai))}));
          }
          // Loại bỏ bản ghi không có số định danh (nếu muốn)
          bhytp_allData = allRows.filter(r => r && r.so_dinh_danh);
          bhytp_page = 1;
          bhytp_doSearch();
        }catch(e){
          bhytp_allData = []; bhytp_doSearch();
        }finally{
          hideLoading();
        }
      }

      /* ===== Search/Sort/Pagin ===== */
      function bhytp_doSearch(){
        const q = (document.getElementById('bhytp-search')?.value||'').trim().toLowerCase();
        bhytp_lastFiltered = !q ? bhytp_allData : bhytp_allData.filter(h=>
          (String(h.ho_ten_hoc_sinh||"").toLowerCase().includes(q)) ||
          (String(bhytp_displayDate(h.ngay_sinh)||"").toLowerCase().includes(q)) ||
          (String(h.so_dinh_danh||"").toLowerCase().includes(q)) ||
          (String(h.noi_kham_bhyt||"").toLowerCase().includes(q))
        );
        bhytp_page=1;
        bhytp_renderAllView();
      }

      /* Sort khi click header */
      function bhytp_renderAllView(){
        let data = bhytp_lastFiltered || bhytp_allData;
        if (bhytp_sortField){
          data = [...data].sort((a,b)=>{
            let av=(a[bhytp_sortField]??"").toString().toLowerCase();
            let bv=(b[bhytp_sortField]??"").toString().toLowerCase();
            if(!isNaN(+av) && !isNaN(+bv)){ av=+av; bv=+bv; }
            if(av<bv) return -bhytp_sortDir; if(av>bv) return bhytp_sortDir; return 0;
          });
        }
        window._bhytpView = data;
        bhytp_total = data.length;
        const totalEl = document.getElementById('bhytp-total'); if(totalEl) totalEl.innerText = bhytp_total;
        bhytp_detectPageSize();
        const start=(bhytp_page-1)*bhytp_pageSize;
        bhytp_renderTable(data.slice(start,start+bhytp_pageSize), start);
        bhytp_renderPagin(data.length);
      }

      /* Render bảng */
      function bhytp_renderPagin(total){
        const totalPages = Math.max(1, Math.ceil(total / bhytp_pageSize));
        const ul = document.getElementById('bhytp-pagin'); if(!ul) return; ul.innerHTML='';
        if (totalPages <= 1) return;
        const add=(p,label,active=false,disabled=false)=>{
          const li=document.createElement('li'); li.className=`page-item ${active?'active':''} ${disabled?'disabled':''}`;
          const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.innerHTML=label;
          a.onclick=(e)=>{ e.preventDefault(); if(p<1||p>totalPages||p===bhytp_page) return; bhytp_page=p; bhytp_renderAllView(); };
          li.appendChild(a); ul.appendChild(li);
        };
        add(bhytp_page-1,'Trước',false,bhytp_page===1);
        let minP=Math.max(1,bhytp_page-2), maxP=Math.min(totalPages,bhytp_page+2);
        if (minP>1) add(1,'1');
        if (minP>2){ const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; ul.appendChild(li); }
        for(let p=minP;p<=maxP;p++) add(p,String(p),p===bhytp_page,false);
        if (maxP<totalPages-1){ const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; ul.appendChild(li); }
        if (maxP<totalPages) add(totalPages,String(totalPages));
        add(bhytp_page+1,'Sau',false,bhytp_page===totalPages);
      }

      /* ===== Bảng dữ liệu ===== */
      function bhytp_statusCell(row){
        const st=Number(row.trang_thai??-1), shs=bhytp_getSoHoSo(row);
        if (st===0) return `<span class="status-badge status-pending">Chờ duyệt</span>`;
        if (st===1 && !shs) return `<span class="status-badge status-paid-wait">Đã nộp, chờ kích hoạt</span>`;
        if (st===1 && shs) return `<div><span class="status-badge status-active">Đã kích hoạt</span><span class="hoso-text">${shs}</span></div>`;
        return `<span class="status-badge status-pending">Đang xử lý</span>`;
      }

      /* Các nút thao tác trong bảng */
      function bhytp_actionsCell(i,row){
        const st=Number(row.trang_thai??-1), shs=bhytp_getSoHoSo(row);
        if (st===1 && shs){
          return `<div class="action-btns">
            <button class="btn btn-warning btn-sm" onclick="showSuaHoSoModal_DaThu('${row.stt}')" title="Sửa hồ sơ">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="bhytp_onViewCardIdx(${i})">Xem thẻ</button>
            <button class="btn btn-primary btn-sm" onclick="bhytp_onPrintReceiptIdx(${i})" title="In phiếu thu">
              <i class="bi bi-printer"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="bhytp_deleteIdx(${i})" title="Xóa hồ sơ">
              <i class="bi bi-trash"></i>
            </button>
          </div>`;
        }
        return `<div class="action-btns">
          <button class="btn btn-warning btn-sm" onclick="showSuaHoSoModal_DaThu('${row.stt}')" title="Sửa hồ sơ">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-primary btn-sm" onclick="bhytp_onPrintReceiptIdx(${i})" title="In phiếu thu">
            <i class="bi bi-printer"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="bhytp_deleteIdx(${i})" title="Xóa hồ sơ">
            <i class="bi bi-trash"></i>
          </button>
        </div>`;
      }

      
      function bhytp_buildHead(){
        return `<thead><tr>
          <th class="th-action">Thao tác</th>
          <th>Trạng thái</th>
          <th class="sortable" data-field="ho_ten_hoc_sinh">Họ tên ${bhytp_sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" data-field="ngay_sinh">Ngày sinh ${bhytp_sortIcon('ngay_sinh')}</th>
          <th class="sortable" data-field="so_dinh_danh">Số định danh ${bhytp_sortIcon('so_dinh_danh')}</th>
          <th>Nơi khám</th>
          <th class="sortable text-center" data-field="so_thang_dong">Số tháng đóng ${bhytp_sortIcon('so_thang_dong')}</th>
          <th class="sortable" data-field="han_su_dung_bhyt_moi">Hạn mới ${bhytp_sortIcon('han_su_dung_bhyt_moi')}</th>
        </tr></thead>`;
      }
      function bhytp_attachSortHandlers(){
        document.querySelectorAll('#bhytp-ds th.sortable').forEach(th=>{
          th.addEventListener('click', ()=>{
            const field=th.getAttribute('data-field'); if(!field) return;
            if (bhytp_sortField === field) bhytp_sortDir = -bhytp_sortDir; else { bhytp_sortField = field; bhytp_sortDir = 1; }
            bhytp_renderAllView();
          });
        });
      }
      function bhytp_renderTable(ds, startIdx){
        const wrap = document.getElementById('bhytp-ds'); if(!wrap) return;
        if (!ds || !ds.length){ wrap.innerHTML = `<div class="text-center text-secondary mt-4">Không có hồ sơ BHYT trong lựa chọn này.</div>`; return; }
        const thead = bhytp_buildHead();
        const rows = ds.map((r,i)=>{
          const iView=startIdx+i;
          const hanMoi = bhytp_displayDate(r.han_su_dung_bhyt_moi || r.ngay_het_han_bhyt_moi || "");
          return `<tr>
            <td>${bhytp_actionsCell(iView,r)}</td>
            <td>${bhytp_statusCell(r)}</td>
            <td>${bhytp_escapeHtml(r.ho_ten_hoc_sinh||"")}</td>
            <td>${bhytp_escapeHtml(bhytp_displayDate(r.ngay_sinh)||"")}</td>
            <td>${bhytp_escapeHtml(r.so_dinh_danh||"")}</td>
            <td>${bhytp_escapeHtml(r.noi_kham_bhyt||"")}</td>
            <td class="text-center">${bhytp_escapeHtml((r.so_thang_dong||"").toString())}</td>
            <td>${bhytp_escapeHtml(hanMoi)}</td>
          </tr>`;
        }).join('');
        wrap.innerHTML = `<table class="table table-bordered table-hs align-middle">${thead}<tbody>${rows}</tbody></table>`;
        bhytp_attachSortHandlers();
      }

      /* ===== Actions: Xem thẻ / In phiếu ===== */
      function bhytp_parseDate(s){
        if(!s) return null;
        if(typeof s==='string' && /^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,m-1,d); }
        if(typeof s==='string' && /^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
        return null;
      }
      function bhytp_formatVN(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }
      function bhytp_makeRange(row){
        const end=row.han_su_dung_bhyt_moi||row.ngay_het_han_bhyt_moi||"";
        const months=Number(row.so_thang_dong||0);
        const e=bhytp_parseDate(end);
        if(!e||!months) return {tu:"",den:""};
        const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);
        return {tu:bhytp_formatVN(s), den:bhytp_formatVN(e)};
      }

      window.bhytp_onViewCardIdx = (i)=>{ const row=window._bhytpView[i]; if(!row) return; showLoading(); setTimeout(()=>bhytp_onViewCard(row), 50); };
      window.bhytp_onPrintReceiptIdx = (i)=>{ const row=window._bhytpView[i]; if(!row) return; showLoading(); setTimeout(()=>bhytp_onPrintReceipt(row), 50); };
      
      //Xóa hồ sơ BHYT (ĐÃ THU)
      // window.bhytp_deleteIdx = async function(i){
      //   const row = window._bhytpView[i];
      //   if (!row) return;
      //   const name = row.ho_ten_hoc_sinh || '';
      //   if (!window.confirm(`Bạn có chắc muốn xóa hồ sơ BHYT của "${name}"?`)) return;

      //   showLoading();
      //   try{
      //     const rs = await deleteBHYTByStt(row.stt, bhyt_user.phan_quyen || "");
      //     if (rs?.success){
      //       toastSuccess('Đã xóa hồ sơ BHYT');
      //       await window.bhyt_paid_reload?.();
      //       // Cập nhật lại tab Chưa thu nếu cần
      //       if (typeof window.bhyt_reload === 'function') await window.bhyt_reload();
      //     } else {
      //       showToast(rs?.message || 'Không thể xóa hồ sơ', 'danger');
      //     }
      //   } finally {
      //     hideLoading();
      //   }
      // };

      //Xóa hồ sơ BHYT (ĐÃ THU)
      window.bhytp_deleteIdx = function (i) {
        const row = window._bhytpView[i];
        if (!row) return;
        const name = row.ho_ten_hoc_sinh || '';

        showBHYTConfirm(
          `Bạn có chắc muốn xóa hồ sơ BHYT của học sinh <strong>${name}</strong>?`,
          async function () {
            showLoading();
            try {
              const rs = await deleteBHYTByStt(row.stt, bhyt_user.phan_quyen || "");
              if (rs?.success) {
                toastSuccess('Đã xóa hồ sơ BHYT');
                await window.bhyt_paid_reload?.();
                if (typeof window.bhyt_reload === 'function') await window.bhyt_reload();
              } else {
                showToast(rs?.message || 'Không thể xóa hồ sơ', 'danger');
              }
            } finally {
              hideLoading();
            }
          }
        );
      };







      // === Hiển thị Modal Sửa hồ sơ BHYT (ĐÃ THU) ===
      async function showSuaHoSoModal_DaThu(stt) {
        log('Open edit modal (PAID) for stt=', stt);

        const hs = Array.isArray(window._bhytpView)
          ? window._bhytpView.find(h => String(h.stt) === String(stt))
          : null;
        if (!hs) {
          warn('Không tìm thấy hồ sơ trong _bhytpView:', stt);
          return;
        }

        // DÙNG STATE RIÊNG, KHÔNG DÙNG _currentHS_Sua CHUNG
        _currentHS_Sua_Paid = hs;

        showLoading();
        try {
          // Fill cơ bản
          document.getElementById('shspaid-hoten').value    = hs.ho_ten_hoc_sinh || "";
          document.getElementById('shspaid-ngaysinh').value = bhytp_displayDate(hs.ngay_sinh || "");
          document.getElementById('shspaid-noikham').value  = hs.noi_kham_bhyt || "";
          // Hiển thị Số hồ sơ (nếu null hoặc undefined thì để rỗng)
          document.getElementById('shspaid-sohoso').value = hs.so_ho_so && hs.so_ho_so !== 'null' ? hs.so_ho_so : '';


          // Months: ưu tiên trên dòng BHYT, fallback API chi tiết nếu thiếu, mặc định 12
          let months = String(hs.so_thang_dong ?? '12');
          if (!hs.so_thang_dong) {
            try {
              const info = await getHosoBHYTByHS(hs.so_dinh_danh, bhyt_user.ma_truong, hs.lop_hoc || "");
              if (info?.data?.so_thang_dong) months = String(info.data.so_thang_dong);
            } catch(e) {/* bỏ qua */}
          }
          const rSel = document.querySelector(`input[name="shspaid-thang"][value="${months}"]`);
          if (rSel) rSel.checked = true; else warn('Không tìm thấy radio tương ứng months=', months);

          // Hạn cũ: LẤY TRỰC TIẾP từ hồ sơ BHYT (đã thu)
          // Ưu tiên ngay_het_han_bhyt_cu; nếu không có thì thử ngay_het_han_bhyt (nếu backend trả),
          // nếu vẫn không có thì mới fallback theo hạn hiện tại (mang tính hiển thị).
          const baseEndStudent = (hs.ngay_het_han_bhyt_cu || hs.ngay_het_han_bhyt || "").trim();

          const g = await ensureGiaBHYT();
          let exp, amount, note = "";
          if (baseEndStudent) {
            const c = computeAmountAndExp(baseEndStudent, months, g?.gia_tien);
            exp = c.exp; amount = c.amount; note = "";
          } else {
            const currentEnd = (hs.han_su_dung_bhyt_moi || hs.ngay_het_han_bhyt_moi || "").trim();
            amount = (parseInt(g?.gia_tien || 0, 10) || 0) * (parseInt(months || 0, 10));
            exp = currentEnd ? bhytp_displayDate(currentEnd) : "(không xác định)";
            note = "Thiếu hạn cũ trong hồ sơ BHYT. Vui lòng bổ sung ngay_het_han_bhyt_cu để tính chuẩn.";
          }

          // Log theo yêu cầu
          log('Preview on open:', {
            stt, months, baseEndStudent, gia_tien: g?.gia_tien, exp, amount, note
          });

          // Update UI
          document.getElementById('shspaid-exp-preview').innerText    = exp;
          document.getElementById('shspaid-amount-preview').innerText = (amount || 0).toLocaleString('vi-VN');
          document.getElementById('shspaid-exp-note').innerText       = note;

          // Bind radio (once)
          bindShsPaidRadioOnce();

          new bootstrap.Modal(document.getElementById('modalSuaHoSoBHYT_DaThu')).show();
        } catch (e) {
          err('showSuaHoSoModal_DaThu error:', e);
          const el = document.getElementById('shspaid-error');
          if (el) el.innerText = (e && e.message) ? e.message : String(e);
        } finally {
          hideLoading();
        }
      }










      // Submit riêng cho modal Sửa hồ sơ (TAB ĐÃ THU) — hành vi giống submitSuaHoSoBHYT bên "Chưa thu"
      async function submitSuaHoSoBHYT_DaThu() {
        if (!_currentHS_Sua_Paid) {
          warn('Submit ignored: no _currentHS_Sua_Paid');
          return;
        }
        showLoading();
        try {
          const months  = document.querySelector('input[name="shspaid-thang"]:checked')?.value || '12';
          const noikham = document.getElementById('shspaid-noikham').value.trim();
          const g       = await ensureGiaBHYT();

          const hs = _currentHS_Sua_Paid;

          // LẤY HẠN CŨ TRỰC TIẾP TỪ HỒ SƠ ĐÃ THU
          const baseEndStudent = (hs.ngay_het_han_bhyt_cu || hs.ngay_het_han_bhyt || "").trim();

          let exp, amount;
          if (baseEndStudent) {
            const c = computeAmountAndExp(baseEndStudent, months, g?.gia_tien);
            exp = c.exp; amount = c.amount;
          } else {
            const currentEnd = (hs.han_su_dung_bhyt_moi || hs.ngay_het_han_bhyt_moi || "").trim();
            amount = (parseInt(g?.gia_tien || 0, 10) || 0) * (parseInt(months || 0, 10));
            exp = currentEnd ? bhytp_displayDate(currentEnd) : "(không xác định)";
          }

          const rate   = getRateByMonths(g, months);
          const hh     = parseFloat((amount * rate).toFixed(2));
          //const so_ho_so = bhytp_getSoHoSo(hs) || 'null';
          const stt      = hs.stt || '';
          const sohosoVal = document.getElementById('shspaid-sohoso').value.trim();
          let trang_thai = 0;
          let so_ho_so = null;
          if (sohosoVal) {
            trang_thai = 1;
            so_ho_so = sohosoVal;
          }


          log('Submit edit (PAID):', {
            stt, so_ho_so, sdd: hs.so_dinh_danh, lop: hs.lop_hoc || "",
            months, noikham, gia_tien: g?.gia_tien, amount, rate, hh, exp
          });

          const res = await suaHoSoBHYTApi({
            stt,
            so_ho_so, // đã set ở trên
            trang_thai, // mới thêm
            so_dinh_danh: hs.so_dinh_danh,
            ma_truong: bhyt_user.ma_truong,
            lop_hoc: hs.lop_hoc || "",
            so_thang_dong: months,
            noi_kham_bhyt: noikham,
            so_tien: amount,
            hoa_hong: hh,
            han_su_dung_bhyt_moi: exp,
            phan_quyen: bhyt_user.phan_quyen
          });

          log('Submit result:', res);

          if (res?.success) {
            bootstrap.Modal.getInstance(document.getElementById('modalSuaHoSoBHYT_DaThu'))?.hide();
            forceUnlockScroll();
            toastSuccess('Đã lưu thay đổi');
            await fetchChuaThuHocsinh?.();
            if (window.bhyt_paid_reload) await window.bhyt_paid_reload();
          } else {
            const msg = res?.message || 'Lỗi lưu hồ sơ';
            document.getElementById('shspaid-error').innerText = msg;
            warn('Submit failed:', msg, res);
          }
        } catch (e) {
          err('Submit error:', e);
          const el = document.getElementById('shspaid-error');
          if (el) el.innerText = (e && e.message) ? e.message : String(e);
        } finally {
          hideLoading();
        }
      }




      // Bắt sự kiện thay đổi số tháng để cập nhật preview trong modal BHYT đã thu
      function bindShsPaidRadioOnce() {
        const ids = ['shspaid-thang-3','shspaid-thang-6','shspaid-thang-12'];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) { warn('Radio not found:', id); return; }
          if (el.dataset.bound === '1') return;
          el.dataset.bound = '1';
          el.addEventListener('change', async () => {
            try {
              if(!_currentHS_Sua_Paid) { warn('Radio change ignored: no _currentHS_Sua_Paid'); return; }
              const g = await ensureGiaBHYT();
              const months = document.querySelector('input[name="shspaid-thang"]:checked')?.value || '12';

              const hs = _currentHS_Sua_Paid;
              const baseEndStudent = (hs.ngay_het_han_bhyt_cu || hs.ngay_het_han_bhyt || "").trim();

              let exp, amount, note = "";
              if (baseEndStudent) {
                const c = computeAmountAndExp(baseEndStudent, months, g?.gia_tien);
                exp = c.exp; amount = c.amount; note = "";
              } else {
                const currentEnd = (hs.han_su_dung_bhyt_moi || hs.ngay_het_han_bhyt_moi || "").trim();
                amount = (parseInt(g?.gia_tien || 0, 10) || 0) * (parseInt(months || 0, 10));
                exp = currentEnd ? bhytp_displayDate(currentEnd) : "(không xác định)";
                note = "Thiếu hạn cũ trong hồ sơ BHYT. Vui lòng bổ sung ngay_het_han_bhyt_cu để tính chuẩn.";
              }

              log('Radio change:', { months, baseEndStudent, gia_tien: g?.gia_tien, exp, amount, note });

              document.getElementById('shspaid-exp-preview').innerText    = exp;
              document.getElementById('shspaid-amount-preview').innerText = (amount || 0).toLocaleString('vi-VN');
              document.getElementById('shspaid-exp-note').innerText       = note;
            } catch (e) {
              err('Radio change error:', e);
              const msg = (e && e.message) ? e.message : String(e);
              const el = document.getElementById('shspaid-error');
              if (el) el.innerText = 'Lỗi cập nhật xem trước: ' + msg;
            }
          });
        });
      }

      /* Hiện biến hồ sơ đang sửa */
      window.showSuaHoSoModal_DaThu = showSuaHoSoModal_DaThu;
      window.submitSuaHoSoBHYT_DaThu = submitSuaHoSoBHYT_DaThu;

      // Clear state khi đóng modal
      document.getElementById('modalSuaHoSoBHYT_DaThu')?.addEventListener('hidden.bs.modal', () => {
        _currentHS_Sua_Paid = null;
      });




      function bhytp_onViewCard(row){
        const LOGO_BHXH = "../assets/image/bhxh-logo.png";
        const doiTuong = bhytp_cleanVal(row.doi_tuong_dong) || "Học sinh";
        const sohoso = bhytp_getSoHoSo(row) || "—";
        const lop = row.lop_hoc || "—";
        const thang = bhytp_cleanVal(row.so_thang_dong) || "—";
        const soTien = bhytp_cleanVal(row.so_tien) || "";
        const gioiTinh = bhytp_cleanVal(row.gioi_tinh) || "";
        const sdt = bhytp_cleanVal(row.sdt_lienhe||row.sdt||"");
        const ghichu = bhytp_cleanVal(row.ghi_chu||"");
        const {tu,den} = bhytp_makeRange(row);

        getTenTruong(bhyt_user.ma_truong).then(truong=>{
          document.getElementById('c-logo').src = LOGO_BHXH;
          document.getElementById('c-ms').innerText = row.ma_so_bhxh || '—';
          document.getElementById('c-sdd').innerText = row.so_dinh_danh || '—';
          document.getElementById('c-doituong').innerText = doiTuong;
          document.getElementById('c-hoten').innerText = row.ho_ten_hoc_sinh || '—';
          document.getElementById('c-ngaysinh').innerText = bhytp_displayDate(row.ngay_sinh)||'—';
          document.getElementById('c-noikham').innerText = row.noi_kham_bhyt || '—';
          document.getElementById('c-tu').innerText = tu || '—';
          document.getElementById('c-den').innerText = den || '—';
          document.getElementById('c-diachi').innerText = bhytp_cleanVal(row.dia_chi) || '—';
          document.getElementById('c-sdt').innerText = sdt || '—';
          document.getElementById('c-ghichu').innerText = ghichu || '—';
          document.getElementById('c-gioitinh').innerText = gioiTinh || '—';
          document.getElementById('c-lop').innerText = lop;
          document.getElementById('c-lop-big').innerText = lop;
          document.getElementById('c-thang').innerText = thang;
          document.getElementById('c-sotien').innerText = soTien ? Number(String(soTien).replace(/[^\d]/g,'')||0).toLocaleString('vi-VN') : '—';
          document.getElementById('c-truong').innerText = truong;
          document.getElementById('c-sohoso').innerText = sohoso;
          const el=document.getElementById('card-qr'); el.innerHTML="";
          new QRCode(el,{text:JSON.stringify({so_ho_so:sohoso,so_dinh_danh:row.so_dinh_danh||""}),width:80,height:80,correctLevel:QRCode.CorrectLevel.L});

          const m=new bootstrap.Modal(document.getElementById('modalTheBHYT')); m.show(); hideLoading();
        }).catch(()=> hideLoading());
      }

      function bhytp_todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }
      function bhytp_onPrintReceipt(row){
        getTenTruong(bhyt_user.ma_truong).then(truong=>{
          const lop = row.lop_hoc || "—";
          const months = parseInt(row.so_thang_dong||"12",10);
          const amount = parseInt((row.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
          const end = row.han_su_dung_bhyt_moi || row.ngay_het_han_bhyt_moi || "";
          const e = bhytp_parseDate(end);
          let startText="—",endText="(không xác định)";
          if(e && months>0){ const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1); startText=bhytp_formatVN(s); endText=bhytp_formatVN(e); }

          document.getElementById('rec-school').innerText = truong;
          document.getElementById('rec-class').innerText = lop;
          document.getElementById('rec-date-today').innerText = bhytp_todayText();
          document.getElementById('rec-student-name').innerText = row.ho_ten_hoc_sinh || "";
          document.getElementById('rec-address').innerText = row.dia_chi || "";
          document.getElementById('rec-content').innerText = `Thu tiền BHYT - ${lop}`;
          document.getElementById('rec-months').innerText = String(months);
          document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
          document.getElementById('rec-amount').innerText = Number(amount).toLocaleString('vi-VN');
          document.getElementById('rec-amount-text').innerText = numberToVietnameseText(amount || 0);
          document.getElementById('rec-teacher-name').innerText = bhyt_user.ho_ten || "(Cán bộ)";

          const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
          try{
            const text = buildQRPayload(bhyt_user.ma_truong, truong, lop, row.ho_ten_hoc_sinh || "", months, endText);
            new QRCode(qrBox,{text, width:90, height:90, correctLevel: QRCode.CorrectLevel.L});
          }catch(e2){
            const initials = (str)=>String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase();
            const fb=`MT=${String(bhyt_user.ma_truong).slice(0,24)};L=${String(lop).slice(0,12)};N=${initials(row.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
            try{ new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }catch(_){ qrBox.innerHTML='<small>QR quá dài</small>'; }
          }

          const _mEl = document.getElementById('modalPhieuThu');
          if (_mEl && _mEl.parentElement !== document.body) document.body.appendChild(_mEl);
          new bootstrap.Modal(_mEl).show();

          hideLoading();
        }).catch(()=> hideLoading());
      }

      /* Xuất ảnh thẻ (clone node, scale cao) */
      window.bhytp_downloadCardImage = async function(){
        try{
          showLoading();
          const W = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW')) || 920;
          const src = document.getElementById('cardArea');
          const clone = src.cloneNode(true);
          clone.id = 'cardExport';
          clone.classList.add('exporting');
          Object.assign(clone.style, {
            position:'fixed', left:'-10000px', top:'0',
            width: W+'px', height:'auto', transform:'none', overflow:'visible', background:'#fff', zIndex:'-1'
          });
          document.body.appendChild(clone);
          await new Promise(r=>setTimeout(r,20));
          const canvas = await html2canvas(clone, { scale:3, backgroundColor:'#fff', useCORS:true });
          document.body.removeChild(clone);
          const a=document.createElement('a'); a.download='the-bhyt.png'; a.href=canvas.toDataURL('image/png'); a.click();
        }finally{ hideLoading(); }
      };

      /* Scale thẻ theo viewport khi mở modal */
      function bhytp_scaleCardToViewport(){
        const wrap = document.getElementById('cardScaleWrap'); if(!wrap) return;
        const W = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW')) || 920;
        const H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardH')) || 580;
        const modalBody = document.querySelector('#modalTheBHYT .modal-body');
        const pad = 24;
        const vw = Math.max(320, modalBody.clientWidth  - pad);
        const vh = Math.max(240, modalBody.clientHeight - pad);
        const s = Math.min(vw / W, vh / H);
        wrap.style.transform = `scale(${s})`;
        wrap.style.marginBottom = '0px';
      }
      document.getElementById('modalTheBHYT')?.addEventListener('shown.bs.modal', ()=>{
        setTimeout(bhytp_scaleCardToViewport, 10);
        window.addEventListener('resize', bhytp_scaleCardToViewport);
      });
      document.getElementById('modalTheBHYT')?.addEventListener('hidden.bs.modal', ()=>{
        window.removeEventListener('resize', bhytp_scaleCardToViewport);
      });

      /* ===== Wire Tab ===== */
      function bhyt_paid_bindUI(){
        document.getElementById('bhytp-btn-reload')?.addEventListener('click', bhytp_fetchPaidBHYT);
        document.getElementById('bhytp-search')?.addEventListener('input', bhytp_doSearch);
        document.getElementById('bhytp-btn-all')?.addEventListener('click', ()=>{
          const sel = document.getElementById('bhytp-classes'); if(!sel) return;
          [...sel.options].forEach(o=>o.selected=false);
          bhytp_fetchPaidBHYT();
        });
      }

      window.bhyt_paid_wireTab = async function(){
        if (window._bhytPaidWired) return;
        window._bhytPaidWired = true;
        await bhytp_loadClassOptions();
        bhyt_paid_bindUI();
      };
      window.bhyt_paid_reload = bhytp_fetchPaidBHYT;

      /* Tự khởi động khi tab "Đã thu" được chọn */
      document.getElementById('tab-other-tab')?.addEventListener('shown.bs.tab', async ()=>{
        await window.bhyt_paid_wireTab();
        await window.bhyt_paid_reload();
      });
    })();
  </script>


  <!-- Hiển thị Modal xác nhận BHYT (dùng chung cho 2 tab chưa thu và đã thu) -->
  <script>
    function showBHYTConfirm(message, onConfirm) {
      // Set nội dung modal
      document.getElementById('bhytConfirmBody').innerHTML = message;

      // Gỡ sự kiện cũ để tránh bị gọi nhiều lần
      const btn = document.getElementById('bhytConfirmBtn');
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);

      // Gán sự kiện mới
      newBtn.addEventListener('click', function () {
        const modalEl = document.getElementById('bhytModalConfirm');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        if (typeof onConfirm === 'function') onConfirm();
      });

      // Hiển thị modal
      const modalEl = document.getElementById('bhytModalConfirm');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.show();
    }

  </script>










  <!-- ====== KHỐI BHTN CHƯA THU ===== -->
  <script>
    /* ================== BHTN – CHƯA THU (Admin) ================== */
    (function(){
      let bhtn_user = JSON.parse(localStorage.getItem("user")||"{}");
      let bhtn_allData = [], bhtn_lastFiltered = [];
      let bhtn_pageSize = 20, bhtn_page = 1;
      let bhtn_sortField = "ho_ten_hoc_sinh", bhtn_sortDir = 1;
      let bhtn_bulk = [];

      // Helpers ngày/tiền (giữ nguyên logic trang GV)
      function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1])?d:null; }
      function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; }
      function addDaysExact(dateObj, days){ const d=new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
      function displayNgaySinh(raw){
        if (!raw) return "";
        if (typeof raw==="string" && /^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
        if (typeof raw==="string" && /^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
        if (typeof raw==="string" && /^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;
        return raw;
      }

      // Giá BHTN & tính hạn 12T (giữ nguyên)
      let _cachedGiaBHTN = null;
      function unwrapGiaBHTN(res){ if (!res) return {}; const d = (res.data !== undefined) ? res.data : res; if (Array.isArray(d)) return d[0] || {}; return d || {}; }
      async function ensureGiaBHTN(){ if (_cachedGiaBHTN) return _cachedGiaBHTN; const res = await getGiaBHTN(); _cachedGiaBHTN = unwrapGiaBHTN(res); return _cachedGiaBHTN; }
      function computeExp12M(oldEndStr){
        const oldEnd = parseVNDate(oldEndStr);
        if (!oldEnd) return { exp:'(không xác định)', note:'Chưa nhập Ngày hết hạn BHTN cũ trong DanhSach_Hocsinh.' };
        const start = addDaysExact(oldEnd, 1);
        const end = new Date(start.getFullYear(), start.getMonth()+12, 0);
        return { exp: formatVNDate(end), note: '' };
      }

      // Quy tắc số tiền/hoa hồng theo đối tượng (giữ nguyên)
      function _toNum(x){ const n = Number(String(x||0).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; }
      function _toRate(x){ const r = _toNum(x); return (r>1)?(r/100):r; }
      function calcAmountCommissionByCategory(gia, category){
        const giaTien = _toNum(gia?.gia_tien);
        const giaTienCanNgheo = _toNum(gia?.gia_tien_can_ngheo);
        const rate = _toRate(gia?.hoa_hong_12_thang);
        const cat = String(category||'Học sinh').toLowerCase();
        const isCN = (cat==='cận nghèo' || cat==='can ngheo');
        const so_tien = isCN ? giaTienCanNgheo : giaTien;
        const base = isCN ? giaTienCanNgheo : giaTien;
        const hoa_hong = Math.round(base * rate);
        return { so_tien, hoa_hong };
      }

      // Detect page size (giống BHYT)
      function detectPageSize(){
        const width = document.querySelector('#page-bhtn')?.offsetWidth || window.innerWidth;
        if (width <= 767) bhtn_pageSize = 3;
        else if (width <= 1023) bhtn_pageSize = 7;
        else bhtn_pageSize = 20;
      }
      addEventListener('resize',()=>{const prev=bhtn_pageSize;detectPageSize(); if(prev!==bhtn_pageSize){ bhtn_page=1; bhtn_renderAll(); }});

      // Load options lớp (multi) & fetch “chưa thu”
      async function bhtn_loadClassOptions(){
        const res = await getAllDanhSachHocsinh(bhtn_user.ma_truong, "");
        const el = document.getElementById('bhtn-classes'); if(!el) return; el.innerHTML="";
        if(res?.success && Array.isArray(res.data)){
          [...new Set(res.data.map(x=>String(x.lop_hoc||"").trim()).filter(Boolean))].sort()
            .forEach(cls=>{ const opt=document.createElement('option'); opt.value=cls; opt.textContent=cls; el.appendChild(opt); });
        }
      }

      async function bhtn_fetchUnpaid(){
        try{
          showLoading();
          detectPageSize();
          const el = document.getElementById('bhtn-classes');
          const selected = el ? [...el.querySelectorAll('option:checked')].map(o=>o.value) : [];
          const classes = selected.length ? selected : [""]; // "" = cả trường

          const allHS = [];
          for (const cls of classes){
            const hsRes = await getAllDanhSachHocsinh(bhtn_user.ma_truong, cls);
            if(hsRes?.success && Array.isArray(hsRes.data)) allHS.push(...hsRes.data);
          }

          // Map trạng thái từ bảng BHTN
          const statusMap = {};
          for (const cls of classes){
            const bhtnRes = await getDanhSachBHTN(bhtn_user.ma_truong, cls);
            const ds = Array.isArray(bhtnRes?.data) ? bhtnRes.data : [];
            ds.forEach(row=>{
              const key = String(row.so_dinh_danh).replace(/^'/,'').trim();
              statusMap[key] = Number(row.trang_thai);
            });
          }

          bhtn_allData = (allHS||[]).map(hs=>{
            const k = String(hs.so_dinh_danh||"").replace(/^'/,'').trim();
            const tt = statusMap[k];
            return {...hs, _bhtn_trangthai:(tt===undefined?undefined:tt), trang_thai:tt};
          }).filter(hs => hs._bhtn_trangthai !== 1);

          bhtn_bulk = [];
          bhtn_page = 1;
          bhtn_doSearch();
        } finally { hideLoading(); }
      }

      function bhtn_doSearch(){
        const q = (document.getElementById('bhtn-search')?.value||'').trim().toLowerCase();
        bhtn_lastFiltered = !q ? bhtn_allData : bhtn_allData.filter(hs =>
          (String(hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q)) ||
          (String(displayNgaySinh(hs.ngay_sinh)||"").toLowerCase().includes(q)) ||
          (String(hs.so_dinh_danh||"").toLowerCase().includes(q))
        );
        bhtn_page=1; bhtn_renderAll();
      }

      function bhtn_renderAll(){
        let data = bhtn_lastFiltered || bhtn_allData;
        if (bhtn_sortField){
          data = [...data].sort((a,b)=>{
            let av=(a[bhtn_sortField]??"").toString().toLowerCase(), bv=(b[bhtn_sortField]??"").toString().toLowerCase();
            if(!isNaN(+av)&&!isNaN(+bv)){ av=+av; bv=+bv; }
            if (av<bv) return -bhtn_sortDir; if (av>bv) return bhtn_sortDir; return 0;
          });
        }
        const total = data.length;
        document.getElementById('bhtn-total').innerText = total;

        const start=(bhtn_page-1)*bhtn_pageSize;
        const pageData = data.slice(start, start+bhtn_pageSize);
        bhtn_renderTable(pageData);
        bhtn_renderPagin(total);
        bhtn_updateBulkBtn();
      }

      function bhtn_renderPagin(total){
        const el = document.getElementById('bhtn-pagin'); if(!el) return; el.innerHTML='';
        const totalPages = Math.max(1, Math.ceil(total / bhtn_pageSize));
        if (totalPages<=1) return;
        const add = (p,label,active=false,disabled=false)=>{
          const li=document.createElement('li'); li.className=`page-item ${active?'active':''} ${disabled?'disabled':''}`;
          const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.innerHTML=label;
          a.onclick=(e)=>{ e.preventDefault(); if (p<1||p>totalPages||p===bhtn_page) return; bhtn_page=p; bhtn_renderAll(); };
          li.appendChild(a); el.appendChild(li);
        };
        add(bhtn_page-1,'Trước',false,bhtn_page===1);
        let minP=Math.max(1,bhtn_page-2), maxP=Math.min(totalPages,bhtn_page+2);
        if (minP>1) add(1,'1');
        if (minP>2) { const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; el.appendChild(li); }
        for (let p=minP;p<=maxP;p++) add(p,String(p),p===bhtn_page,false);
        if (maxP<totalPages-1) { const li=document.createElement('li'); li.className='page-item disabled'; li.innerHTML='<span class="page-link">...</span>'; el.appendChild(li); }
        if (maxP<totalPages) add(totalPages,String(totalPages));
        add(bhtn_page+1,'Sau',false,bhtn_page===totalPages);
      }

      function bhtn_sortIcon(field){ if(bhtn_sortField!==field) return ''; return bhtn_sortDir===1 ? '<span class="sort-icon">&#9650;</span>' : '<span class="sort-icon">&#9660;</span>'; }
      window.bhtn_doSort = function(field){ if(bhtn_sortField===field) bhtn_sortDir=-bhtn_sortDir; else { bhtn_sortField=field; bhtn_sortDir=1; } bhtn_renderAll(); };

      function bhtn_renderTable(ds){
        const wrap = document.getElementById('bhtn-ds'); if(!wrap) return;
        if (!ds || ds.length===0){ wrap.innerHTML = `<div class='text-center text-secondary mt-4'>Không có học sinh chưa tham gia BHTN trong lựa chọn này.</div>`; return; }
        let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
          <th style="width:42px;"><input type="checkbox" id="bhtn-chk-all" onchange="bhtn_toggleAll(this)"></th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="bhtn_doSort('ho_ten_hoc_sinh')">Họ tên học sinh ${bhtn_sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="bhtn_doSort('ngay_sinh')">Ngày sinh ${bhtn_sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="bhtn_doSort('so_dinh_danh')">Số định danh cá nhân ${bhtn_sortIcon('so_dinh_danh')}</th>
        </tr></thead><tbody>`;
        ds.forEach(hs=>{
          if (hs._bhtn_trangthai===1) return;
          const hasOld = !!parseVNDate(hs.ngay_het_han_bhtn);
          const nopDisabled = (hs._bhtn_trangthai===0) || !hasOld;
          const nopLabel = (hs._bhtn_trangthai===0) ? "Chờ duyệt" : (!hasOld ? "Thiếu hạn cũ" : "Nộp hồ sơ");
          html += `<tr>
            <td><input type="checkbox" class="bhtn-chk" data-stt="${hs.stt}" onchange="bhtn_onSelect('${hs.stt}', this)" ${hs._bhtn_trangthai===0?'disabled':''}></td>
            <td>
              <div class="action-btns">
                ${
                  (hs._bhtn_trangthai === 0)
                    ? `<span class="text-success fw-semibold">Chờ duyệt</span>`
                    : `<button class="btn btn-success btn-sm" onclick="bhtn_openNop('${hs.stt}')" ${nopDisabled ? 'disabled' : ''}>${nopLabel}</button>`
                }
                ${!hasOld ? '<div class="text-danger small mt-1">Chưa có ngày hết hạn cũ (BHTN)</div>' : ''}
                ${(hs._bhtn_trangthai===0 || hs._bhtn_trangthai===1) ? `
                  <button class="btn btn-warning btn-sm" onclick="bhtn_openSua('${hs.stt}')" title="Sửa hồ sơ">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="bhtn_inPhieu('${hs.stt}')" title="In phiếu thu">
                    <i class="bi bi-printer"></i>
                  </button>
                ` : ``}
              </div>
            </td>
            <td>${hs.ho_ten_hoc_sinh||""}</td>
            <td>${displayNgaySinh(hs.ngay_sinh)||""}</td>
            <td>${hs.so_dinh_danh||""}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
        wrap.innerHTML = html;
      }

      // Bulk select
      window.bhtn_onSelect = function(stt, el){ if (el.checked){ if (!bhtn_bulk.includes(stt)) bhtn_bulk.push(stt); } else { bhtn_bulk = bhtn_bulk.filter(x=>x!==stt); const all=document.getElementById('bhtn-chk-all'); if(all) all.checked=false; } bhtn_updateBulkBtn(); };
      window.bhtn_toggleAll = function(el){
        document.querySelectorAll('.bhtn-chk').forEach(cb=>{
          if (cb.disabled) return;
          cb.checked = el.checked;
          const stt = cb.getAttribute('data-stt');
          if (el.checked){ if (!bhtn_bulk.includes(stt)) bhtn_bulk.push(stt); } else { bhtn_bulk = bhtn_bulk.filter(x=>x!==stt); }
        }); bhtn_updateBulkBtn();
      };
      function bhtn_getSelectedData(){
        const map={}; (bhtn_lastFiltered||bhtn_allData).forEach(h=>{ map[String(h.stt)] = h; });
        return bhtn_bulk.map(stt=>map[String(stt)]).filter(Boolean).filter(hs => !(hs._bhtn_trangthai===0 || hs._bhtn_trangthai===1));
      }
      function bhtn_updateBulkBtn(){
        const btn = document.getElementById('bhtn-btn-bulk'); const c = bhtn_getSelectedData().length;
        if (!btn) return; if (c>0){ btn.style.display=''; btn.innerText=`Nộp nhiều hồ sơ (${c})`; } else { btn.style.display='none'; btn.innerText='Nộp nhiều hồ sơ (0)'; }
      }

      // NỘP / SỬA HỒ SƠ (đơn)
      let _curHS = null, _curHS_Sua = null;

      window.bhtn_openNop = function(stt){
        const hs = (bhtn_lastFiltered||bhtn_allData).find(h=>String(h.stt)===String(stt)); if(!hs) return;
        _curHS = hs;

        showLoading();

        document.getElementById('bhtn-nhs-hoten').value = hs.ho_ten_hoc_sinh||"";
        document.getElementById('bhtn-nhs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh||"");
        document.getElementById('bhtn-nhs-error').innerText = "";

        (async ()=>{
          const gia = await ensureGiaBHTN();
          const { exp, note } = computeExp12M(_curHS.ngay_het_han_bhtn);
          document.getElementById('bhtn-nhs-exp').innerText = exp;
          document.getElementById('bhtn-nhs-expnote').innerText = note||"";
          const isCN = document.getElementById('bhtn-nhs-cat-cn').checked;
          const { so_tien } = calcAmountCommissionByCategory(gia, isCN?'Cận nghèo':'Học sinh');
          document.getElementById('bhtn-nhs-amount').innerText = (Number(so_tien)||0).toLocaleString('vi-VN');
        })().finally(()=> { hideLoading(); new bootstrap.Modal(document.getElementById('modalNopHoSoBHTN_Admin')).show() });

        // lắng nghe radio để cập nhật amount
        const rHS = document.getElementById('bhtn-nhs-cat-hs');
        const rCN = document.getElementById('bhtn-nhs-cat-cn');
        [rHS,rCN].forEach(el=>{
          el?.addEventListener('change', async ()=>{
            const gia = await ensureGiaBHTN();
            const isCN = document.getElementById('bhtn-nhs-cat-cn').checked;
            const { so_tien } = calcAmountCommissionByCategory(gia, isCN?'Cận nghèo':'Học sinh');
            document.getElementById('bhtn-nhs-amount').innerText = (Number(so_tien)||0).toLocaleString('vi-VN');
          }, {once:false});
        });
      };

      window.bhtn_submitNop = async function(){
        if (!_curHS) return;
        const hasOld = !!parseVNDate(_curHS.ngay_het_han_bhtn);
        if (!hasOld){ document.getElementById('bhtn-nhs-error').innerText='Chưa có "Ngày hết hạn hạn BHTN cũ". Vui lòng cập nhật trước khi nộp.';
            return;
        }
        showLoading();
        try{
          const gia = await ensureGiaBHTN();
          const isCN = document.getElementById('bhtn-nhs-cat-cn').checked;
          const selectedCat = isCN ? 'Cận nghèo' : 'Học sinh';
          const { so_tien, hoa_hong } = calcAmountCommissionByCategory(gia, selectedCat);

          const payload = {
            ho_ten_hoc_sinh: _curHS.ho_ten_hoc_sinh || "null",
            ngay_sinh: displayNgaySinh(_curHS.ngay_sinh) || "null",
            gioi_tinh: _curHS.gioi_tinh || "null",
            dia_chi: _curHS.dia_chi || "null",
            ngay_het_han_bhtn_cu: _curHS.ngay_het_han_bhtn || "null",
            so_thang_dong: 12,
            lop_hoc: _curHS.lop_hoc || "null",
            sdt_lienhe: _curHS.sdt_lienhe || "null",
            so_dinh_danh: _curHS.so_dinh_danh || "null",
            ten_cha_me: _curHS.ten_cha_me || "null",
            doi_tuong_dong: selectedCat,
            ghi_chu: "null",
            so_tien, hoa_hong,
            trang_thai: 0,
            so_ho_so: "null",
            ma_truong: bhtn_user.ma_truong || "null"
          };

          const res = await nopHoSoBHTN(payload);
          if (res?.success){
            bootstrap.Modal.getInstance(document.getElementById('modalNopHoSoBHTN_Admin'))?.hide();
            if (typeof showToast === 'function') showToast("Nộp hồ sơ BHTN thành công!", 'success');
            await bhtn_fetchUnpaid();
          } else {
            document.getElementById('bhtn-nhs-error').innerText = res?.message || "Nộp hồ sơ thất bại!";
          }
        } catch(err){
          document.getElementById('bhtn-nhs-error').innerText = err?.message || "Có lỗi xảy ra!";
        } finally { hideLoading(); }
      };

      window.bhtn_openSua = async function(stt){
        showLoading();
        try{
          const hs = (bhtn_lastFiltered||bhtn_allData).find(h=>String(h.stt)===String(stt));
          if (!hs || hs._bhtn_trangthai !== 0){
            if (typeof showToast === 'function') showToast("Chỉ sửa được hồ sơ đang chờ duyệt!", 'warning');
            hideLoading(); return;
          }
          _curHS_Sua = hs;
          document.getElementById('bhtn-shs-hoten').value = hs.ho_ten_hoc_sinh || "";
          document.getElementById('bhtn-shs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh || "");
          document.getElementById('bhtn-shs-error').innerText = "";

          // Lấy hồ sơ hiện tại để set đối tượng đóng
          try{
            const hsRes = await getHosoBHTNByHS(hs.so_dinh_danh, bhtn_user.ma_truong, hs.lop_hoc || "");
            const r = hsRes?.data || {};
            const catLower = String(r.doi_tuong_dong || 'Học sinh').trim().toLowerCase();
            const shsHS = document.getElementById('bhtn-shs-cat-hs');
            const shsCN = document.getElementById('bhtn-shs-cat-cn');
            if (shsHS && shsCN){
              if (catLower === 'cận nghèo' || catLower === 'can ngheo'){ shsCN.checked = true; } else { shsHS.checked = true; }
            }
          }catch(_){}

          const gia = await ensureGiaBHTN();
          const { exp, note } = computeExp12M(hs.ngay_het_han_bhtn);
          document.getElementById('bhtn-shs-exp').innerText = exp;
          document.getElementById('bhtn-shs-expnote').innerText = note || "";

          // Preview tiền theo radio
          const refreshAmount = ()=>{
            const isCN = document.getElementById('bhtn-shs-cat-cn').checked;
            const { so_tien } = calcAmountCommissionByCategory(gia, isCN?'Cận nghèo':'Học sinh');
            document.getElementById('bhtn-shs-amount').innerText = (Number(so_tien)||0).toLocaleString('vi-VN');
          };
          refreshAmount();
          document.getElementById('bhtn-shs-cat-hs')?.addEventListener('change', refreshAmount);
          document.getElementById('bhtn-shs-cat-cn')?.addEventListener('change', refreshAmount);

          new bootstrap.Modal(document.getElementById('modalSuaHoSoBHTN_Admin')).show();
        } finally { hideLoading(); }
      };

      window.bhtn_submitSua = async function(){
        if (!_curHS_Sua) return;
        showLoading();
        try{
          const gia = await ensureGiaBHTN();
          const selectedCat = document.getElementById('bhtn-shs-cat-cn').checked ? 'Cận nghèo' : 'Học sinh';
          const { so_tien, hoa_hong } = calcAmountCommissionByCategory(gia, selectedCat);

          const payload = {
            so_dinh_danh: _curHS_Sua.so_dinh_danh,
            ma_truong: bhtn_user.ma_truong,
            lop_hoc: _curHS_Sua.lop_hoc,
            doi_tuong_dong: selectedCat,
            so_tien, hoa_hong,
            trang_thai: 0
          };

          const res = await suaHoSoBHTN(payload);
          if (res?.success){
            bootstrap.Modal.getInstance(document.getElementById('modalSuaHoSoBHTN_Admin'))?.hide();
            if (typeof showToast === 'function') showToast("Đã cập nhật hồ sơ BHTN!", 'success');
            await bhtn_fetchUnpaid();
          } else {
            document.getElementById('bhtn-shs-error').innerText = res?.message || "Cập nhật thất bại!";
          }
        } catch(err){
          document.getElementById('bhtn-shs-error').innerText = err?.message || "Có lỗi xảy ra!";
        } finally { hideLoading(); }
      };

      // Nộp nhiều hồ sơ
      window.bhtn_showBulkModal = async function(){
        const selected = bhtn_getSelectedData();
        if (selected.length===0) return;
        document.getElementById('bhtn-bulk-count').innerText = String(selected.length);
        document.getElementById('bhtn-bulk-error').innerText = '';

        const invalidOld = selected.filter(h => !parseVNDate(h.ngay_het_han_bhtn));
        const bulkBtn = document.getElementById('bhtn-btn-bulk-nop');
        if (invalidOld.length>0){
          document.getElementById('bhtn-bulk-error').innerText='Một số học sinh thiếu "Ngày hết hạn BHTN cũ". Hãy cập nhật trước.';
          if (bulkBtn) bulkBtn.disabled = true;
        } else { if (bulkBtn) bulkBtn.disabled = false; }

        const gia = await ensureGiaBHTN();
        const price = Number(String((gia?.gia_tien)||0).replace(/[^\d]/g,'')) || 0; // Bulk mặc định "Học sinh"
        const first = selected[0];
        const { exp, note } = computeExp12M(first?.ngay_het_han_bhtn || "");
        document.getElementById('bhtn-bulk-exp').innerText = exp;
        document.getElementById('bhtn-bulk-amount').innerText = price.toLocaleString('vi-VN');
        document.getElementById('bhtn-bulk-expnote').innerText = note || "";

        new bootstrap.Modal(document.getElementById('modalBulkNopHoSoBHTN_Admin')).show();
      };

      window.bhtn_submitBulk = async function(){
        const selected = bhtn_getSelectedData();
        if (selected.length===0) return;

        const invalidOld = selected.filter(h => !parseVNDate(h.ngay_het_han_bhtn));
        if (invalidOld.length>0){
          document.getElementById('bhtn-bulk-error').innerText='Có học sinh thiếu "Ngày hết hạn BHTN cũ". Vui lòng cập nhật trước khi nộp.';
          return;
        }

        const btn = document.getElementById('bhtn-btn-bulk-nop'); if(btn) btn.disabled=true;
        showLoading();
        try{
          const gia = await ensureGiaBHTN();
          const price = Number(String((gia?.gia_tien)||0).replace(/[^\d]/g,'')) || 0;
          const rateNum = _toRate(gia?.hoa_hong_12_thang);
          const hoa_hong = Math.round(price * rateNum); // bulk = Học sinh

          let ok=0, fail=0;
          for (const hs of selected){
            const payload = {
              ho_ten_hoc_sinh: hs.ho_ten_hoc_sinh || "null",
              ngay_sinh: displayNgaySinh(hs.ngay_sinh) || "null",
              gioi_tinh: hs.gioi_tinh || "null",
              dia_chi: hs.dia_chi || "null",
              ngay_het_han_bhtn_cu: hs.ngay_het_han_bhtn || "null",
              so_thang_dong: 12,
              lop_hoc: hs.lop_hoc || "null",
              sdt_lienhe: hs.sdt_lienhe || "null",
              so_dinh_danh: hs.so_dinh_danh || "null",
              ten_cha_me: hs.ten_cha_me || "null",
              doi_tuong_dong: "Học sinh",
              ghi_chu: "null",
              so_tien: price, hoa_hong,
              trang_thai: 0,
              so_ho_so: "null",
              ma_truong: bhtn_user.ma_truong || "null"
            };
            const res = await nopHoSoBHTN(payload);
            if (res?.success) ok++; else fail++;
          }

          bootstrap.Modal.getInstance(document.getElementById('modalBulkNopHoSoBHTN_Admin'))?.hide();
          if (typeof showToast === 'function'){
            showToast(fail===0 ? `Đã nộp thành công ${ok} hồ sơ!` : `Nộp xong: thành công ${ok}, thất bại ${fail}.`, fail===0?'success':'warning');
          }
          await bhtn_fetchUnpaid();
        } catch(err){
          document.getElementById('bhtn-bulk-error').innerText = err?.message || "Có lỗi xảy ra!";
        } finally {
          hideLoading();
          if (btn) btn.disabled=false;
        }
      };

      // In phiếu thu A5 dùng modal sẵn có #modalPhieuThu (re-use cách BHYT/BHTN teacher)
      function numberToVietnamese(n){
        const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
        function readTriple(num){ let tr=Math.floor(num/100), ch=Math.floor((num%100)/10), dv=num%10, s="";
          if(tr>0){ s += VI_DIGITS[tr]+" trăm"; if(ch==0 && dv>0) s+=" lẻ"; }
          if(ch>1){ s += (s?" ":"")+VI_DIGITS[ch]+" mươi"; if(dv==1) s+=" mốt"; else if(dv==5) s+=" lăm"; else if(dv>0) s+=" "+VI_DIGITS[dv]; }
          else if(ch==1){ s += (s?" ":"")+"mười"; if(dv==5) s+=" lăm"; else if(dv>0) s+=" "+VI_DIGITS[dv]; }
          else if(ch==0 && dv>0){ s += (s?" ":"")+VI_DIGITS[dv]; }
          return s.trim();
        }
        n = Math.round(Number(n)||0); if (n===0) return "Không đồng";
        const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0,str="";
        while(n>0 && i<units.length){ const block=n%1000; if(block>0){ const part=readTriple(block); str = part+units[i]+(str?" "+str:""); } n=Math.floor(n/1000); i++; }
        return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();
      }
      function stripVN(str){ return String(str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,'d').replace(/Đ/g,'D'); }
      function initials(str){ return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase(); }
      function buildQRPayload(schoolCode, school, classCode, name, months, endDate){
        const mt=String(schoolCode||"").slice(0,24);
        const s=stripVN(school).slice(0,60);
        const c=String(classCode||"").slice(0,12);
        const n=stripVN(name).slice(0,60);
        const m=String(months||""); const e=String(endDate||"").slice(0,10);
        return `MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`;
      }
      function calcRangeBHTN(oldEndStr){
        const od=parseVNDate(oldEndStr);
        if (!od) return {startText:"—", endText:"(không xác định)"};
        const start=addDaysExact(od,1);
        const end=new Date(start.getFullYear(), start.getMonth()+12, 0);
        return { startText: formatVNDate(start), endText: formatVNDate(end) };
      }

      window.bhtn_inPhieu = async function(stt){
        try{
          showLoading();
          const hs = (bhtn_lastFiltered||bhtn_allData).find(h=>String(h.stt)===String(stt));
          if (!hs){ hideLoading(); return; }
          const hoSo = await getHosoBHTNByHS(hs.so_dinh_danh, bhtn_user.ma_truong, hs.lop_hoc||"");
          if (!hoSo || !hoSo.success || !hoSo.data){ hideLoading(); if (typeof showToast==='function') showToast("Không tìm thấy hồ sơ BHTN để in.", 'warning'); return; }

          const months = 12;
          const amount = parseInt(String(hoSo.data.so_tien||"0").replace(/[^\d]/g,''),10)||0;
          const { startText, endText } = calcRangeBHTN(hs.ngay_het_han_bhtn);
          const schoolName = (bhtn_user.ten_truong || (await (await fetch(`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(bhtn_user.ma_truong)}`)).json())?.ten_truong || bhtn_user.ma_truong || '—');
          const classCode = hoSo.data.lop_hoc || hs.lop_hoc || "";

          // Gán vào modal phiếu thu chung (#modalPhieuThu đã tồn tại)
          document.getElementById('rec-school-bhtn').innerText = schoolName;
          document.getElementById('rec-class-bhtn').innerText = classCode;
          const d=new Date(); document.getElementById('rec-date-today-bhtn').innerText = `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`;
          document.getElementById('rec-student-name-bhtn').innerText = hs.ho_ten_hoc_sinh || "";
          document.getElementById('rec-address-bhtn').innerText = hs.dia_chi || "";
          document.getElementById('rec-content-bhtn').innerText = `Thu tiền BHTN - ${classCode}`;
          document.getElementById('rec-months-bhtn').innerText = String(months);
          document.getElementById('rec-range-bhtn').innerText = `từ ngày ${startText} đến ngày ${endText}`;
          document.getElementById('rec-amount-bhtn').innerText = Number(amount).toLocaleString('vi-VN');
          document.getElementById('rec-amount-text-bhtn').innerText = numberToVietnamese(amount);
          document.getElementById('rec-teacher-name-bhtn').innerText = bhtn_user.ho_ten || "(Cán bộ)";

          const qrBox=document.getElementById('receipt-qr-bhtn'); qrBox.innerHTML="";
          const primaryText = buildQRPayload(bhtn_user.ma_truong, schoolName, classCode, hs.ho_ten_hoc_sinh||"", months, endText);
          try{ new QRCode(qrBox,{text:primaryText,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
          catch(e){
            const fb = `MT=${String(bhtn_user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hs.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
            try{ new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }catch(_){ qrBox.innerHTML='<small>QR quá dài</small>'; }
          }

          new bootstrap.Modal(document.getElementById('modalPhieuThuBHTN')).show();
        } finally { hideLoading(); }
      };


      window.printReceiptOnlyBHTN = function() {
        // Lấy phần nội dung phiếu thu BHTN
        const receipt = document.getElementById('receiptA5-bhtn');
        if (!receipt) {
          if (typeof showToast === 'function') showToast("Không tìm thấy nội dung phiếu thu BHTN để in", 'warning');
          return;
        }

        // Tạo iframe ẩn để in
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.top = '-1000px';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        document.body.appendChild(iframe);

        // CSS in giống BHYT
        const css = `
          <style>
            @page { size: A5 portrait; margin: 10mm; }
            html,body{ background:#fff; margin:0; padding:0; height:auto !important; }
            .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000;
                      margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px;
                      page-break-inside: avoid; }
            .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
            .receipt-sub{ font-style:italic; }
            .receipt-meta{ font-size:13px; }
            .receipt-line{ margin:2mm 0; }
            .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
            .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
            .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
            .row{ display:flex; flex-wrap:nowrap; width:100%; }
            .col{ flex:1 1 0; }
            .text-center{ text-align:center; }
          </style>
        `;

        // Ghi nội dung vào iframe
        const content = receipt.outerHTML;
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Phiếu thu BHTN</title>
              ${css}
            </head>
            <body>${content}</body>
          </html>
        `);
        doc.close();

        // Đợi QR render xong
        const check = () => {
          if (iframe.contentDocument.querySelector('#receipt-qr-bhtn img')?.complete) {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            setTimeout(() => {
              if (document.body.contains(iframe)) document.body.removeChild(iframe);
            }, 500);
          } else {
            setTimeout(check, 50);
          }
        };
        check();
      }

      /* Tải ảnh PNG của phiếu thu BHTN */
      window.downloadReceiptImageBHTN = async function(){
        const el = document.getElementById('receiptA5-bhtn'); 
        if(!el) {
          if (typeof showToast === 'function') showToast("Không tìm thấy nội dung phiếu thu BHTN để lưu ảnh", 'warning');
          return;
        }
        const canvas = await html2canvas(el,{useCORS:true,scale:2});
        const link = document.createElement('a'); 
        link.download='phieu_thu_a5_bhtn.png'; 
        link.href=canvas.toDataURL('image/png'); 
        link.click();
      }




      // Wire UI
      function bhtn_bindUI(){
        document.getElementById('bhtn-btn-reload')?.addEventListener('click', bhtn_fetchUnpaid);
        document.getElementById('bhtn-search')?.addEventListener('input', bhtn_doSearch);
        document.getElementById('bhtn-btn-all')?.addEventListener('click', ()=>{
          const sel = document.getElementById('bhtn-classes'); if(!sel) return;
          [...sel.options].forEach(o => o.selected = false);
          bhtn_fetchUnpaid();
        });
      }

      // Router/tab loader
      window.bhtn_unpaid_wireTab = async function(){
        if (window._bhtnUnpaidWired) return;
        window._bhtnUnpaidWired = true;
        await bhtn_loadClassOptions();
        bhtn_bindUI();
        await bhtn_fetchUnpaid();
      };

      // Expose reload
      window.bhtn_unpaid_reload = bhtn_fetchUnpaid;
    })();
  </script>
  <!-- ====== KHỐI BHTN CHƯA THU ===== -->





  <!-- ====== KHỐI BHTN ĐÃ THU ===== -->
  <script>
    /* ================== BHTN – ĐÃ THU (Admin) ================== */
    (function(){
      let bhtnp_user = JSON.parse(localStorage.getItem("user")||"{}");
      let bhtnp_all = [], bhtnp_last = [];
      let bhtnp_pageSize=20, bhtnp_page=1, bhtnp_sortField="ho_ten_hoc_sinh", bhtnp_sortDir=1;

      // Namespace riêng cho BHTN - Đã thu
      window.BHTNP = window.BHTNP || {};
      window.BHTNP.state = {
        all: [],        // toàn bộ bản ghi đã thu
        filtered: [],   // sau lọc/search
        bySdd: new Map(),     // index theo số định danh
        bySoHoSo: new Map(),  // index theo số hồ sơ
        current: null
      };


      const norm = v => String(v??"").replace(/^'/,'').trim();
      const toTrangThai = v => {const n=Number(norm(v));return isNaN(n)?undefined:n;}
      const cleanVal = v => {const s=norm(v);return (!s||s==='null'||s==='undefined'||s==='NaN')?"":s}
      function displayDate(raw){
        if(!raw)return "";
        if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
        if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(raw)){const [y,m,d]=raw.split('-');return `${d}/${m}/${y}`}
        return raw;
      }
      function getSoHoSo(row){return cleanVal(row.so_ho_so??row.sohoso??row.so_hs)}

      // Load lớp (multi)
      async function bhtnp_loadClasses(){
        try{
          const res = await getAllDanhSachHocsinh(bhtnp_user.ma_truong, "");
          const el = document.getElementById('bhtnp-classes'); if(!el) return; el.innerHTML="";
          if(res?.success && Array.isArray(res.data)){
            [...new Set(res.data.map(x=>String(x.lop_hoc||"").trim()).filter(Boolean))]
              .sort()
              .forEach(cls=>{ const opt=document.createElement('option'); opt.value=cls; opt.textContent=cls; el.appendChild(opt); });
          }
        }catch(_){}
      }

      async function bhtnp_fetchPaid(){
        showLoading();
        try{
          const sel = document.getElementById('bhtnp-classes');
          const selected = sel ? [...sel.querySelectorAll('option:checked')].map(o=>o.value) : [];
          const classes = selected.length ? selected : [""]; // "" = cả trường

          const rowsAll = [];
          for (const cls of classes){
            const rs = await getDanhSachBHTN(bhtnp_user.ma_truong, cls);
            const rows = Array.isArray(rs?.data) ? rs.data : [];
            rows.forEach(r=>{
              rowsAll.push({
                ...r,
                trang_thai: toTrangThai(r.trang_thai),
                so_ho_so: getSoHoSo(r),
                ma_so_bhtn: cleanVal(r.ma_so_bhtn)
              });
            });
          }
          bhtnp_all = rowsAll.filter(r=>r && r.so_dinh_danh);
          bhtnp_page = 1;
          bhtnp_doSearchPaid();
        } finally { hideLoading(); }
      }

      function sortIcon(field){ if(bhtnp_sortField!==field) return ''; return bhtnp_sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
      function statusCell(row){
        const st=toTrangThai(row.trang_thai), shs=getSoHoSo(row);
        if (st===0) return `<span class="status-badge status-pending">Chờ duyệt</span>`;
        if (st===1 && !shs) return `<span class="status-badge status-paid-wait">Đã nộp, chờ kích hoạt</span>`;
        if (st===1 && shs) return `<div><span class="status-badge status-active">Đã kích hoạt</span><span class="hoso-text">${shs}</span></div>`;
        return `<span class="status-badge status-pending">Đang xử lý</span>`;
      }
      function actionsCell(i,row){
        const st = toTrangThai(row.trang_thai);
        const shs = getSoHoSo(row);
        if (st===1 && shs){
          return `<div class="action-btns">
            <button class="btn btn-sm btn-info" onclick="bhtnp_onViewCardIdx(${i})">Xem thẻ</button>
            <button class="btn btn-sm btn-primary" onclick="bhtnp_onPrintReceiptIdx(${i})" title="In phiếu thu"><i class="bi bi-printer"></i></button>
          </div>`;
        }
        return `<div class="action-btns">
          <button class="btn btn-sm btn-primary" onclick="bhtnp_onPrintReceiptIdx(${i})" title="In phiếu thu"><i class="bi bi-printer"></i></button>
        </div>`;
      }

      function buildHead(){
        return `<thead><tr>
          <th class="th-action">Thao tác</th>
          <th>Trạng thái</th>
          <th class="sortable th-hoten" data-field="ho_ten_hoc_sinh">Họ tên ${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" data-field="ngay_sinh">Ngày sinh ${sortIcon('ngay_sinh')}</th>
          <th class="sortable" data-field="so_dinh_danh">Số định danh ${sortIcon('so_dinh_danh')}</th>
          <th class="sortable" data-field="doi_tuong_dong">Đối tượng đóng ${sortIcon('doi_tuong_dong')}</th>
          <th class="sortable text-center" data-field="so_thang_dong">Số tháng đóng ${sortIcon('so_thang_dong')}</th>
          <th class="sortable" data-field="han_su_dung_bhtn_moi">Hạn BHTN mới ${sortIcon('han_su_dung_bhtn_moi')}</th>
        </tr></thead>`;
      }
      function attachSort(){
        document.querySelectorAll('#bhtnp-ds th.sortable').forEach(th=>{
          th.onclick = ()=>{ const f=th.getAttribute('data-field'); if(!f) return;
            if (bhtnp_sortField===f) bhtnp_sortDir=-bhtnp_sortDir; else { bhtnp_sortField=f; bhtnp_sortDir=1; }
            renderAll();
          };
        });
      }

      function renderTable(ds,startIdx){
        const wrap = document.getElementById('bhtnp-ds'); if(!wrap) return;
        if (!ds || !ds.length){
          wrap.innerHTML = `<div class="text-center text-secondary mt-4">Không có hồ sơ BHTN trong lựa chọn này.</div>`;
          return;
        }
        const rows = ds.map((r,i)=>`<tr>
          <td>${actionsCell(startIdx+i,r)}</td>
          <td>${statusCell(r)}</td>
          <td class="td-hoten">${(r.ho_ten_hoc_sinh||"")}</td>
          <td>${displayDate(r.ngay_sinh)||""}</td>
          <td>${(r.so_dinh_danh||"")}</td>
          <td>${(r.doi_tuong_dong||"Học sinh")}</td>
          <td class="text-center">${(r.so_thang_dong||"")}</td>
          <td>${displayDate(r.han_su_dung_bhtn_moi||"")}</td>
        </tr>`).join('');
        wrap.innerHTML = `<table class="table table-bordered table-hs align-middle">${buildHead()}<tbody>${rows}</tbody></table>`;
        attachSort();
      }

      function detectPageSize(){
        const width = document.querySelector('#page-bhtn')?.offsetWidth || window.innerWidth;
        if (width <= 999) bhtnp_pageSize = Number.MAX_SAFE_INTEGER; else bhtnp_pageSize = 20;
      }
      addEventListener('resize', ()=>{ const old=bhtnp_pageSize; detectPageSize(); if (old!==bhtnp_pageSize){ bhtnp_page=1; renderAll(); } });

      function renderPagin(total){
        const el=document.getElementById('bhtnp-pagin'); if(!el) return;
        if (bhtnp_pageSize===Number.MAX_SAFE_INTEGER){ el.innerHTML=''; return; } // no paging on small
        let totalPages = Math.max(1, Math.ceil(total / bhtnp_pageSize));
        if (totalPages<=1){ el.innerHTML=''; return; }
        const add=(p,lab,act=false,dis=false)=>`<li class="page-item ${act?'active':''} ${dis?'disabled':''}"><a class="page-link" href="javascript:void(0)" onclick="bhtnp_goto(${p})">${lab}</a></li>`;
        let html=''; html += add(Math.max(1,bhtnp_page-1),'&laquo;',false,bhtnp_page===1);
        for(let i=1;i<=totalPages;i++) html += add(i,i,bhtnp_page===i,false);
        html += add(Math.min(totalPages,bhtnp_page+1),'&raquo;',false,bhtnp_page===totalPages);
        el.innerHTML = html;
      }
      window.bhtnp_goto = (p)=>{ const totalPages = Math.max(1, Math.ceil((bhtnp_last||bhtnp_all).length / bhtnp_pageSize)); if(p<1||p>totalPages) return; bhtnp_page=p; renderAll(); };

      function bhtnp_doSearchPaid(){
        const q = (document.getElementById('bhtnp-search')?.value||'').trim().toLowerCase();
        bhtnp_last = !q ? bhtnp_all : bhtnp_all.filter(h=>
          (String(h.ho_ten_hoc_sinh||"").toLowerCase().includes(q)) ||
          (String(displayDate(h.ngay_sinh)||"").toLowerCase().includes(q)) ||
          (String(h.so_dinh_danh||"").toLowerCase().includes(q)) ||
          (String(h.doi_tuong_dong||"").toLowerCase().includes(q))
        );
        bhtnp_page=1; renderAll();

        //Alias toàn cục cho doSearch
        window.bhtnp_doSearchPaid = bhtnp_doSearchPaid;
      }
      function renderAll(){
        let data = bhtnp_last || bhtnp_all;
        if (bhtnp_sortField){
          data = [...data].sort((a,b)=>{
            // giữ đúng logic sort như trang GV: ưu tiên theo tên (given name) nếu cần
            if (bhtnp_sortField === 'ho_ten_hoc_sinh'){
              const av = toSortKeyVN(getTen(a.ho_ten_hoc_sinh)); const bv = toSortKeyVN(getTen(b.ho_ten_hoc_sinh));
              if (av<bv) return -bhtnp_sortDir; if (av>bv) return bhtnp_sortDir;
              const af = toSortKeyVN(a.ho_ten_hoc_sinh||''); const bf = toSortKeyVN(b.ho_ten_hoc_sinh||'');
              if (af<bf) return -bhtnp_sortDir; if (af>bf) return bhtnp_sortDir; return 0;
            }
            let av=(a[bhtnp_sortField]??"").toString().toLowerCase(), bv=(b[bhtnp_sortField]??"").toString().toLowerCase();
            if(!isNaN(+av)&&!isNaN(+bv)){ av=+av; bv=+bv; }
            if (av<bv) return -bhtnp_sortDir; if (av>bv) return bhtnp_sortDir; return 0;
          });
        }
        // LƯU lại danh sách đã lọc/sắp xếp để thao tác theo index đúng
        if (window.BHTNP && BHTNP.state) BHTNP.state.filtered = data;

        const total = data.length;
        document.getElementById('bhtnp-total').innerText = total;
        detectPageSize();
        const start=(bhtnp_page-1)*bhtnp_pageSize;
        renderTable(data.slice(start, start+bhtnp_pageSize), start);
        renderPagin(total);
      }

      // ===== Xem thẻ / In phiếu (giữ nguyên logic trang GV, đổi selector id modal) =====
      function parseDate(s){
        if(!s) return null;
        if(typeof s==='string'&&/^\d{2}\/\d{2}\/\d{4}$/.test(s)){const[d,m,y]=s.split('/').map(Number);return new Date(y,m-1,d)}
        if(typeof s==='string'&&/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
        return null;
      }
      function formatDateVN(d){ return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` }
      function makeRangeBHTN(row){
        const end=row.han_su_dung_bhtn_moi||"";
        const months=Number(row.so_thang_dong||0);
        const e=parseDate(end);
        if(!e||!months) return {tu:"",den:""};
        const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);
        return {tu:formatDateVN(s), den:formatDateVN(e)};
      }
      const toVND=n=>Number(n||0).toLocaleString('vi-VN');
      function stripVN(s){ return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D'); }
      function getTen(fullname){ const s=String(fullname||'').trim().replace(/\s+/g,' '); if(!s) return ''; const parts=s.split(' '); return parts[parts.length-1]; }
      function toSortKeyVN(s){ return stripVN(String(s||'')).toLowerCase(); }
      function numberToVietnamese(n){
        const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
        function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s="";if(tr>0){s+=VI_DIGITS[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ"}if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv]}return s.trim()}
        n=Math.round(Number(n)||0);if(n===0)return"Không đồng";const u=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";while(n>0&&i<u.length){const b=n%1000;if(b>0){const p=readTriple(b);str=p+u[i]+(str?" "+str:"")}n=Math.floor(n/1000);i++}return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim()
      }
      function todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }
      function buildQRPayload(mt,school,cls,name,months,endDate){
        const _mt=String(mt||"").slice(0,24),
          s=stripVN(school).slice(0,60),
          c=String(cls||"").slice(0,12),
          n=stripVN(name).slice(0,60),
          m=String(months||""),
          e=String(endDate||"").slice(0,10);
        return `MT=${_mt};S=${s};L=${c};N=${n};M=${m};E=${e}`;
      }

        window.bhtnp_onViewCardIdx = (i)=>{ const row=(BHTNP?.state?.filtered||bhtnp_last||bhtnp_all)[i]; if(!row) return; showLoading(); setTimeout(()=>bhtnp_onViewCard(row),50); };
        window.bhtnp_onPrintReceiptIdx = (i)=>{ const row=(BHTNP?.state?.filtered||bhtnp_last||bhtnp_all)[i]; if(!row) return; showLoading(); setTimeout(()=>bhtnp_onPrintReceipt(row),50); };

      function bhtnp_onViewCard(row){
        const {tu,den} = makeRangeBHTN(row);
        const sohoso = getSoHoSo(row)||"—";
        const lop = row.lop_hoc || bhtnp_user.lop_hoc || "—";

        // Map sang modal thẻ Admin (ID khác)
        document.getElementById('c-doituong-bhtn').innerText = row.doi_tuong_dong || 'Học sinh';
        document.getElementById('c-so-the-bhtn').innerText   = cleanVal(row.ma_so_bhtn)||'—';
        document.getElementById('c-hoten-bhtn').innerText    = row.ho_ten_hoc_sinh||'—';
        document.getElementById('c-ngaysinh-bhtn').innerText = displayDate(row.ngay_sinh)||'—';
        document.getElementById('c-tu-bhtn').innerText       = tu||'—';
        document.getElementById('c-den-bhtn').innerText      = den||'—';
        document.getElementById('c-diachi-bhtn').innerText   = cleanVal(row.dia_chi)||'—';
        document.getElementById('c-sdt-bhtn').innerText      = cleanVal(row.sdt_lienhe||row.sdt)||'—';
        document.getElementById('c-tencha-bhtn').innerText   = cleanVal(row.ten_cha_me)||'—';
        document.getElementById('c-gioitinh-bhtn').innerText = cleanVal(row.gioi_tinh)||'—';
        document.getElementById('c-lop-bhtn').innerText      = lop;
        document.getElementById('c-lop-big-bhtn').innerText  = lop;
        document.getElementById('c-sotien-bhtn').innerText   = toVND(row.so_tien||0);
        document.getElementById('c-badge-bhtn').innerText    = sohoso;

        const qrBox = document.getElementById('card-qr-bhtn'); qrBox.innerHTML='';
        const months=parseInt(row.so_thang_dong||"12",10);
        const qrText=buildQRPayload(bhtnp_user.ma_truong,(bhtnp_user.ten_truong||''),lop,(row.ho_ten_hoc_sinh||""),months,den);
        try{ new QRCode(qrBox,{text:qrText,width:92,height:92,correctLevel:QRCode.CorrectLevel.L}); }catch(_){ qrBox.innerHTML='<small>QR</small>'; }

        new bootstrap.Modal(document.getElementById('modalTheBHTN_Admin')).show();
        hideLoading();
      }

      function bhtnp_onPrintReceipt(row){
        getTenTruong(bhtnp_user.ma_truong).then(truong=>{
          const lop=row.lop_hoc||bhtnp_user.lop_hoc||"—";
          const months=parseInt(row.so_thang_dong||"12",10);
          const amount=parseInt((row.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
          const end=row.han_su_dung_bhtn_moi||""; const e=parseDate(end);
          let startText="—",endText="(không xác định)";
          if(e&&months>0){const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);startText=formatDateVN(s);endText=formatDateVN(e)}
          document.getElementById('rec-school-bhtn').innerText=truong;
          document.getElementById('rec-class-bhtn').innerText=lop;
          document.getElementById('rec-date-today-bhtn').innerText=todayText();
          document.getElementById('rec-student-name-bhtn').innerText=row.ho_ten_hoc_sinh||"";
          document.getElementById('rec-address-bhtn').innerText=row.dia_chi||"";
          document.getElementById('rec-content-bhtn').innerText=`Thu tiền BHTN - ${lop}`;
          document.getElementById('rec-months-bhtn').innerText=String(months);
          document.getElementById('rec-range-bhtn').innerText=`từ ngày ${startText} đến ngày ${endText}`;
          document.getElementById('rec-amount-bhtn').innerText=toVND(amount);
          document.getElementById('rec-amount-text-bhtn').innerText=numberToVietnamese(amount);
          document.getElementById('rec-teacher-name-bhtn').innerText=bhtnp_user.ho_ten||"(Cán bộ)";
          const qrBox=document.getElementById('receipt-qr-bhtn'); qrBox.innerHTML="";
          const payload=buildQRPayload(bhtnp_user.ma_truong,truong,lop,row.ho_ten_hoc_sinh||"",months,endText);
          try{ new QRCode(qrBox,{text:payload,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }catch(_){ qrBox.innerHTML='<small>QR</small>'; }
          new bootstrap.Modal(document.getElementById('modalPhieuThuBHTN')).show();
          hideLoading();
        }).catch(()=>hideLoading());
      }

      async function getTenTruong(ma_truong){ try{ const u=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`; const r=await fetch(u); const j=await r.json(); return j?.ten_truong||j?.data?.ten_truong||bhtnp_user.ten_truong||ma_truong||'—'; }catch(e){ return bhtnp_user.ten_truong||ma_truong||'—'; } }

      // Bind UI
      function bind(){
        document.getElementById('bhtnp-btn-reload')?.addEventListener('click', bhtnp_fetchPaid);
        document.getElementById('bhtnp-search')?.addEventListener('input', bhtnp_doSearchPaid);
        document.getElementById('bhtnp-btn-all')?.addEventListener('click', ()=>{
          const sel = document.getElementById('bhtnp-classes'); if(!sel) return;
          [...sel.options].forEach(o=>o.selected=false);
          bhtnp_fetchPaid();
        });
      }

      window.bhtn_paid_wireTab = async function(){
        if (window._bhtnPaidWired) return;
        window._bhtnPaidWired = true;
        await bhtnp_loadClasses();
        bind();
        await bhtnp_fetchPaid();
      };
      window.bhtn_paid_reload = bhtnp_fetchPaid;
    })();
  </script>



  <script>
    /* ===== BHTN – xem thẻ (Admin) responsive + Lưu ảnh thẻ ===== */
    (function(){
      function parseDateBHTN(s){
        if(!s) return null;
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,m-1,d); }
        if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
        return null;
      }
      function fmtVN(d){return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`}
      function makeRange(row){
        const end=row.han_su_dung_bhtn_moi||row.ngay_het_han_bhtn||""; const m=parseInt(row.so_thang_dong||12,10);
        const e=parseDateBHTN(end); if(!e||!m) return {tu:"",den:""};
        const s=new Date(e.getFullYear(),e.getMonth()-m,e.getDate()+1); return {tu:fmtVN(s),den:fmtVN(e)};
      }
      const toVND = n => Number(n||0).toLocaleString('vi-VN');
      const clean  = v => { const s=String(v??"").replace(/^'/,'').trim(); return (!s||s==='null'||s==='undefined'||s==='NaN')?"":s; };

      // === Điền dữ liệu vào thẻ
      window.bhtnp_fillCardAdmin = function(row, userCtx={}){
        const {tu,den}=makeRange(row);
        const lop = row.lop_hoc || userCtx.lop_hoc || "—";
        document.getElementById('c-doituong-bhtn').innerText = row.doi_tuong_dong || 'Học sinh';
        document.getElementById('c-so-the-bhtn').innerText   = clean(row.ma_so_bhtn)||'—';
        document.getElementById('c-hoten-bhtn').innerText    = row.ho_ten_hoc_sinh||'—';
        document.getElementById('c-ngaysinh-bhtn').innerText = row.ngay_sinh?fmtVN(parseDateBHTN(row.ngay_sinh)):'—';
        document.getElementById('c-tu-bhtn').innerText       = tu||'—';
        document.getElementById('c-den-bhtn').innerText      = den||'—';
        document.getElementById('c-diachi-bhtn').innerText   = clean(row.dia_chi)||'—';
        document.getElementById('c-sdt-bhtn').innerText      = clean(row.sdt_lienhe||row.sdt)||'—';
        document.getElementById('c-tencha-bhtn').innerText   = clean(row.ten_cha_me)||'—';
        document.getElementById('c-gioitinh-bhtn').innerText = clean(row.gioi_tinh)||'—';
        document.getElementById('c-lop-bhtn').innerText      = lop;
        document.getElementById('c-lop-big-bhtn').innerText  = lop;
        document.getElementById('c-sotien-bhtn').innerText   = toVND(row.so_tien||row.so_tien_bhtn||0);
        document.getElementById('c-badge-bhtn').innerText    = clean(row.so_ho_so||row.sohoso||row.so_hs||'—');

        // QR
        const qrBox=document.getElementById('card-qr-bhtn'); qrBox.innerHTML='';
        const months=parseInt(row.so_thang_dong||12,10);
        const qrText=[
          `MT=${(userCtx.ma_truong||'').slice(0,24)}`,
          `S=${(userCtx.ten_truong||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')}`,
          `L=${lop}`, `N=${(row.ho_ten_hoc_sinh||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')}`,
          `M=${months}`, `E=${(den||'').slice(0,10)}`
        ].join(';');
        try{ new QRCode(qrBox,{text:qrText,width:92,height:92,correctLevel:QRCode.CorrectLevel.L}); }catch(_){ qrBox.innerHTML='<small>QR</small>'; }
      };

      // === Mở modal + auto-scale
      window.bhtnp_openCardAdmin = function(row, userCtx={}){
        bhtnp_fillCardAdmin(row, userCtx);
        new bootstrap.Modal(document.getElementById('modalTheBHTN_Admin')).show();
        setTimeout(bhtnp_scaleCardToViewport_Admin, 10);
      };

      window.bhtnp_scaleCardToViewport_Admin = function(){
        const wrap=document.getElementById('cardScaleWrapBHTN_Admin'); if(!wrap) return;
        const W=900, H=560;
        const mb=document.querySelector('#modalTheBHTN_Admin .modal-body');
        const pad=24, vw=Math.max(300, mb.clientWidth-pad), vh=Math.max(260, mb.clientHeight-pad);
        wrap.style.transform=`scale(${Math.min(vw/W, vh/H)})`;
      };

      // gắn/huỷ listener khi show/hide để responsive theo xoay màn hình
      document.getElementById('modalTheBHTN_Admin')?.addEventListener('shown.bs.modal', ()=>{
        setTimeout(bhtnp_scaleCardToViewport_Admin,10);
        window.addEventListener('resize', bhtnp_scaleCardToViewport_Admin);
      });
      document.getElementById('modalTheBHTN_Admin')?.addEventListener('hidden.bs.modal', ()=>{
        window.removeEventListener('resize', bhtnp_scaleCardToViewport_Admin);
      });

      // === Lưu ảnh thẻ (sửa lỗi not defined)
      window.bhtnp_downloadCardImage = async function(){
        const wrap = document.getElementById('cardScaleWrapBHTN_Admin');
        const card = document.getElementById('cardAreaBHTN_Admin');
        if (!card) return;

        // lưu transform gốc
        const oldTransform = wrap.style.transform;
        wrap.style.transform = 'none';   // bỏ scale khi chụp

        if (window.html2canvas){
          const canvas = await html2canvas(card, {backgroundColor:'#ffffff', scale:2});
          const link = document.createElement('a');
          link.download = `the_BHTN_${Date.now()}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        }

        // khôi phục lại
        wrap.style.transform = oldTransform;
      };

    })();
    /* ===== BHTN – xem thẻ (Admin) responsive + Lưu ảnh thẻ ===== */
  </script>

  <!-- ====== KHỐI BHTN ĐÃ THU ===== -->


  <!-- Khi click vào tab BHTN, nạp dữ liệu tương ứng -->
  <script>
    // Khi user click vào tab BHTN, nạp dữ liệu tương ứng
    document.getElementById('bhtn-unpaid-tab')?.addEventListener('shown.bs.tab', async ()=>{
      await window.bhtn_unpaid_wireTab?.();
    });
    document.getElementById('bhtn-paid-tab')?.addEventListener('shown.bs.tab', async ()=>{
      await window.bhtn_paid_wireTab?.();
    });

    // Nếu muốn auto-wire khi lần đầu vào trang BHTN của admin_dashboard
    // Hãy thêm vào hàm setActivePage('bhtn') đã có sẵn:
    // if (page === 'bhtn') {
    //   if (!sec.dataset.wired) { /* no-op; tabs sẽ tự wire khi được bấm */ sec.dataset.wired = '1'; }
    //   // Tuỳ chọn: tự nạp tab đầu tiên
    //   window.bhtn_unpaid_wireTab?.();
    // }
  </script>












  <!-- ====== KHỐI THỐNG KÊ (Admin) ===== -->
  <script>
    (()=>{ if (window.__STATS_SCRIPT_LOADED__) return; window.__STATS_SCRIPT_LOADED__ = true;

    /** ===== THỐNG KÊ (Admin) =====
     * Kế thừa công thức thống kê từ 2 trang GV:
     * - BHYT: paid = (đã đóng theo bảng BHYT) + (Đối tượng khác xác định từ danh sách HS)
     * - BHTN: paid = học sinh có so_tien>0 hoặc trang_thai=='1' trong bảng BHTN
     * Cho phép: chọn nhiều lớp hoặc toàn trường.
     * Nguồn tham chiếu: thong_ke_bhyt_giaovien.html, thong_ke_bhtn_giaovien.html
     */

    /* Helpers (đưa vào scope cục bộ để tránh trùng tên) */
    const pct = (num, den)=> den>0 ? (num*100/den) : 0;
    function fmtPercent(x){ return x.toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + '%'; }
    const stripVN = (s)=> String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');
    const keyVN   = (s)=> stripVN(String(s||'')).toLowerCase();
    /* HS thuộc “Đối tượng khác” nếu doi_tuong_dong KHÁC 'HS' / 'Học sinh' */
    function isOtherDoiTuongFromHS(hs){
      const raw = (hs?.doi_tuong_dong ?? "").toString().trim();
      if (!raw || raw.toLowerCase() === "null") return false;
      const k = keyVN(raw);
      return !(k === "hs" || k === "hoc sinh");
    }

    let STATS = {
      inited: false,
      charts: { bhyt: null, bhtn: null },
      allHS: [],
      classes: []
    };

    /* Khởi tạo danh sách lớp cho select multiple */
    async function stats_buildClassList(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const res = await getAllDanhSachHocsinh(user.ma_truong||'', ''); // toàn trường
      STATS.allHS = Array.isArray(res?.data) ? res.data : [];
      const classes = [...new Set(STATS.allHS.map(r => String(r.lop_hoc||'').trim()).filter(Boolean))].sort();
      STATS.classes = classes;
      const sel = document.getElementById('stats-classes');
      if (sel) sel.innerHTML = classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    /* Lấy các lớp đang chọn (mảng) – rỗng = Toàn trường */
    function stats_getSelectedClasses(){
      const sel = document.getElementById('stats-classes');
      if (!sel) return [];
      return Array.from(sel.selectedOptions).map(o=>o.value.trim()).filter(Boolean);
    }

    /* Tải & tính KPI cho BHYT */
    async function stats_loadBHYT(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const selected = stats_getSelectedClasses();

      // 1) Tổng số HS theo lọc lớp
      const allHS = STATS.allHS.filter(h => selected.length===0 || selected.includes(String(h.lop_hoc||'').trim()));
      const total = allHS.length;

      // 1b) “Đối tượng khác” lấy trực tiếp từ HS
      const otherSet = new Set();
      for (const hs of allHS) {
        const id = String(hs?.so_dinh_danh || '').trim();
        if (!id) continue;
        if (isOtherDoiTuongFromHS(hs)) otherSet.add(id);
      }
      const paidOther = otherSet.size;

      // 2) Danh sách BHYT – gọi toàn trường rồi lọc theo lớp
      const resBHYT = await getDanhSachBHYT(user.ma_truong||'', '');
      const ds = Array.isArray(resBHYT?.data) ? resBHYT.data : [];
      const dsFilt = ds.filter(r => {
        if (selected.length===0) return true;
        const lop = String(r.lop_hoc||'').trim();
        return selected.includes(lop);
      });

      // đã đóng theo bảng BHYT (loại trừ “đối tượng khác” để tránh đếm hai lần)
      const paidHSSet = new Set();
      for (const r of dsFilt) {
        const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
        const trang_thai = String(r.trang_thai ?? '');
        const isPaid = (so_tien > 0) || (trang_thai === '1');
        if (!isPaid) continue;
        const id = String(r.so_dinh_danh || '').trim();
        if (!id) continue;
        if (!otherSet.has(id)) paidHSSet.add(id);
      }

      const paidThucTe = paidHSSet.size;
      const paidTotal  = paidThucTe + paidOther;
      const unpaid     = Math.max(0, (total - paidThucTe) - paidOther);
      const rate       = pct(paidTotal, total);

      // Cập nhật KPI
      const elTotal  = document.getElementById('bhyt-kpi-total');
      const elPaid   = document.getElementById('bhyt-kpi-paid');
      const elUnpaid = document.getElementById('bhyt-kpi-unpaid');
      const elOther  = document.getElementById('bhyt-kpi-other');
      const elRate   = document.getElementById('bhyt-kpi-rate');
      if (elTotal)  elTotal.innerText  = total.toLocaleString('vi-VN');
      if (elPaid)   elPaid.innerText   = paidTotal.toLocaleString('vi-VN');
      if (elUnpaid) elUnpaid.innerText = unpaid.toLocaleString('vi-VN');
      if (elOther)  elOther.innerText  = paidOther.toLocaleString('vi-VN');
      if (elRate)   elRate.innerText   = fmtPercent(rate);

      // Vẽ biểu đồ
      const cnv = document.getElementById('bhytChart');
      if (!cnv) return;
      const ctx = cnv.getContext('2d');
      if (STATS.charts.bhyt) STATS.charts.bhyt.destroy();
      if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
      }
      STATS.charts.bhyt = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Chưa đóng', 'Đã đóng'],
          datasets: [{
            data: [unpaid, paidTotal],
            backgroundColor: ['#fca5a5','#86efac'],
            borderColor: ['#ffffff','#ffffff'],
            borderWidth: 2,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '55%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: {
              label: (ctx)=> {
                const v = ctx.parsed, p = total>0 ? (v*100/total):0;
                return `${ctx.label}: ${v.toLocaleString('vi-VN')} (${p.toLocaleString('vi-VN',{maximumFractionDigits:1})}%)`;
              }
            }},
            datalabels: {
              color:'#111827', font:{weight:'700', size:12},
              formatter: (value, context)=>{
                const data = context.chart.data.datasets[0].data;
                const sum = data.reduce((a,b)=>a+b,0), p = sum>0 ? value*100/sum : 0;
                return `${p.toFixed(1)}%\n${value.toLocaleString('vi-VN')}`;
              }
            }
          }
        }
      });
    }

    /* Tải & tính KPI cho BHTN */
    async function stats_loadBHTN(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const selected = stats_getSelectedClasses();

      // Tổng HS theo lọc lớp
      const allHS = STATS.allHS.filter(h => selected.length===0 || selected.includes(String(h.lop_hoc||'').trim()));
      const total = allHS.length;

      // Danh sách BHTN – gọi toàn trường rồi lọc lớp
      const resBHTN = await getDanhSachBHTN(user.ma_truong||'', '');
      const ds = Array.isArray(resBHTN?.data) ? resBHTN.data : [];
      const dsFilt = ds.filter(r => {
        if (selected.length===0) return true;
        const lop = String(r.lop_hoc||'').trim();
        return selected.includes(lop);
      });

      // paidSet: so_tien>0 hoặc trang_thai=='1'
      const paidSet = new Set();
      for (const r of dsFilt) {
        const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
        const trang_thai = String(r.trang_thai ?? '');
        const isPaid = (so_tien > 0) || (trang_thai === '1');
        if (isPaid && r.so_dinh_danh) paidSet.add(String(r.so_dinh_danh));
      }
      const paid = paidSet.size;
      const unpaid = Math.max(0, total - paid);
      const rate = pct(paid, total);

      // KPI
      const elTotal  = document.getElementById('bhtn-kpi-total');
      const elPaid   = document.getElementById('bhtn-kpi-paid');
      const elUnpaid = document.getElementById('bhtn-kpi-unpaid');
      const elRate   = document.getElementById('bhtn-kpi-rate');
      if (elTotal)  elTotal.innerText  = total.toLocaleString('vi-VN');
      if (elPaid)   elPaid.innerText   = paid.toLocaleString('vi-VN');
      if (elUnpaid) elUnpaid.innerText = unpaid.toLocaleString('vi-VN');
      if (elRate)   elRate.innerText   = fmtPercent(rate);

      // Chart
      const cnv = document.getElementById('bhtnChart');
      if (!cnv) return;
      const ctx = cnv.getContext('2d');
      if (STATS.charts.bhtn) STATS.charts.bhtn.destroy();
      if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
      }
      STATS.charts.bhtn = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Chưa đóng', 'Đã đóng'],
          datasets: [{
            data: [unpaid, paid],
            backgroundColor: ['#fca5a5','#86efac'],
            borderColor: ['#ffffff','#ffffff'],
            borderWidth: 2,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '55%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: {
              label: (ctx)=> {
                const v = ctx.parsed, p = total>0 ? (v*100/total):0;
                return `${ctx.label}: ${v.toLocaleString('vi-VN')} (${p.toLocaleString('vi-VN',{maximumFractionDigits:1})}%)`;
              }
            }},
            datalabels: {
              color:'#111827', font:{weight:'700', size:12},
              formatter: (value, context)=>{
                const data = context.chart.data.datasets[0].data;
                const sum = data.reduce((a,b)=>a+b,0), p = sum>0 ? value*100/sum : 0;
                return `${p.toFixed(1)}%\n${value.toLocaleString('vi-VN')}`;
              }
            }
          }
        }
      });
    }

    /* Sự kiện & khởi tạo 1 lần khi vào trang Thống kê */
    async function stats_initOnce(){
      if (STATS.inited) return;
      STATS.inited = true;

      // Build lớp
      await stats_buildClassList();

      // Nút “Toàn trường” => bỏ chọn tất cả + tải lại ngay
      const btnAll = document.getElementById('stats-btn-all');
      if (btnAll) btnAll.addEventListener('click', ()=>{
        const sel = document.getElementById('stats-classes');
        if (!sel) return;

        // Bỏ chọn tất cả lớp
        Array.from(sel.options).forEach(o=>o.selected=false);

        // Tải lại dữ liệu toàn trường (tận dụng handler của nút Tải dữ liệu)
        const btnLoad = document.getElementById('stats-btn-load');
        if (btnLoad) btnLoad.click();
      });


      // Nút “Tải dữ liệu”
      const btnLoad = document.getElementById('stats-btn-load');
      if (btnLoad) btnLoad.addEventListener('click', async ()=>{
        try{
          if (typeof showLoading === 'function') showLoading();
          await stats_loadBHYT();
          await stats_loadBHTN();
        } finally {
          if (typeof hideLoading === 'function') hideLoading();
        }
      });

      // Tải lần đầu
      if (btnLoad) btnLoad.click();
    }

    /* Gắn vào điều hướng sidebar (khi bấm Thống kê) — hiển thị loading ngay */
    const sidebar = document.getElementById('sidebarMenu');
    if (sidebar) {
      sidebar.addEventListener('click', (e)=>{
        const item = e.target.closest('.nav-item[data-page="stats"]');
        if (!item) return;

        // Chỉ bật loading ngay từ lúc bấm trong lần khởi tạo đầu tiên
        if (!STATS.inited && typeof showLoading === 'function') {
          showLoading();
        }
        setTimeout(stats_initOnce, 0);
      });
    }

    /* Nếu trang Thống kê đang hiển thị (ví dụ sau khi reload) thì vẫn init */
    const pg = document.getElementById('page-stats');
    if (pg && !pg.classList.contains('d-none')) {
      if (!STATS.inited && typeof showLoading === 'function') {
        showLoading();
      }
      stats_initOnce();
    }

    })();

  </script>

  <!-- ====== KHỐI THỐNG KÊ (Admin) ===== -->

















  <!-- ====== KHỐI THÙ LAO (Admin) ===== -->
  <script>
    (()=>{ if (window.__REWARDS_SCRIPT_LOADED__) return; window.__REWARDS_SCRIPT_LOADED__ = true;
    /** ===== THÙ LAO (Admin) =====
     * Tabs: Thù lao BHYT & Thù lao BHTN
     * - Chọn nhiều lớp / Toàn trường
     * - Không trùng tên với phần khác (prefix rw- / RW)
     * Yêu cầu có sẵn: showLoading()/hideLoading(), getAllDanhSachHocsinh(), getDanhSachBHYT(), getDanhSachBHTN(), sidebarMenu có item data-page="rewards"
     */

    const RW = { inited:false, charts:{ bhyt:null, bhtn:null }, allHS:[], classes:[] };

    // Helpers (cục bộ)
    const rw_toNum = (v) => {
      if (v === null || v === undefined) return 0;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const s = v.replaceAll(',', '').replaceAll(' ', '');
        const n = Number(s);
        return isNaN(n) ? 0 : n;
      }
      return 0;
    };
    const rw_fmtMoney = (n) => {
      const x = Number(n); if (!isFinite(x)) return "0";
      return x.toLocaleString('vi-VN', { style:'currency', currency:'VND', maximumFractionDigits:0 });
    };

    function rw_getSelectedClasses(){
      const sel = document.getElementById('rw-classes');
      if (!sel) return [];
      return Array.from(sel.selectedOptions).map(o=>o.value.trim()).filter(Boolean);
    }

    async function rw_buildClassList(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const res = await getAllDanhSachHocsinh(user.ma_truong||'', '');
      RW.allHS = Array.isArray(res?.data) ? res.data : [];
      const classes = [...new Set(RW.allHS.map(r => String(r.lop_hoc||'').trim()).filter(Boolean))].sort();
      RW.classes = classes;
      const sel = document.getElementById('rw-classes');
      if (sel) sel.innerHTML = classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    /* ====== Load & render: BHYT ====== */
    async function rw_loadBHYT(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const selected = rw_getSelectedClasses();

      // Tổng HS theo lọc lớp
      const allHS = RW.allHS.filter(h => selected.length===0 || selected.includes(String(h.lop_hoc||'').trim()));
      const total = allHS.length;

      // Danh sách BHYT toàn trường -> lọc lớp
      const resBHYT = await getDanhSachBHYT(user.ma_truong||'', '');
      const ds = Array.isArray(resBHYT?.data) ? resBHYT.data : [];
      const dsFilt = ds.filter(r => {
        if (selected.length===0) return true;
        const lop = String(r.lop_hoc||'').trim();
        return selected.includes(lop);
      });

      // KPI: submitted, money, commission + buckets 3/6/12
      let submitted = 0, money = 0, commission = 0;
      const buckets = {3:{count:0, commission:0}, 6:{count:0, commission:0}, 12:{count:0, commission:0}};

      for (const r of dsFilt){
        submitted += 1;
        const so_tien = rw_toNum(r.so_tien);
        const hoa_hong = rw_toNum(r.hoa_hong);
        money += so_tien;
        commission += hoa_hong;

        const thang = Number(r.so_thang_dong) || 0;
        if (buckets[thang] && so_tien > 0){
          buckets[thang].count += 1;
          buckets[thang].commission += hoa_hong;
        }
      }

      // Update KPI
      const $ = (id)=>document.getElementById(id);
      $('rw-bhyt-kpi-total').innerText = total.toLocaleString('vi-VN');
      $('rw-bhyt-kpi-submitted').innerText = submitted.toLocaleString('vi-VN');
      $('rw-bhyt-kpi-money').innerText = rw_fmtMoney(money);
      $('rw-bhyt-kpi-commission').innerText = rw_fmtMoney(commission);
      $('rw-bhyt-kpi-3m-count').innerText = buckets[3].count.toLocaleString('vi-VN');
      $('rw-bhyt-kpi-6m-count').innerText = buckets[6].count.toLocaleString('vi-VN');
      $('rw-bhyt-kpi-12m-count').innerText = buckets[12].count.toLocaleString('vi-VN');
      $('rw-bhyt-kpi-3m-commission').innerText = rw_fmtMoney(buckets[3].commission);
      $('rw-bhyt-kpi-6m-commission').innerText = rw_fmtMoney(buckets[6].commission);
      $('rw-bhyt-kpi-12m-commission').innerText = rw_fmtMoney(buckets[12].commission);

      // Chart
      const cnv = document.getElementById('rw-bhyt-chart');
      if (cnv && typeof Chart !== 'undefined'){
        const ctx = cnv.getContext('2d');
        if (RW.charts.bhyt) RW.charts.bhyt.destroy();
        RW.charts.bhyt = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['3 tháng','6 tháng','12 tháng'],
            datasets: [
              { label: 'Số hồ sơ (đã đóng)', data: [buckets[3].count, buckets[6].count, buckets[12].count], yAxisID: 'yCount', borderWidth: 1 },
              { label: 'Tổng thù lao (VND)', data: [buckets[3].commission, buckets[6].commission, buckets[12].commission], yAxisID: 'yMoney', borderWidth: 1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode:'index', intersect:false },
            scales: {
              yCount: { position:'left', beginAtZero:true, ticks:{ callback:v=>Number(v).toLocaleString('vi-VN') }, grid:{ drawOnChartArea:true } },
              yMoney: { position:'right', beginAtZero:true, ticks:{ callback:v=>Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0}) }, grid:{ drawOnChartArea:false } },
              x: { grid: { display:false } }
            },
            plugins: {
              legend: { position:'bottom' },
              tooltip: { mode:'index', callbacks:{
                label: (ctx)=>{
                  const name = ctx.dataset.label || '';
                  const v = ctx.parsed.y;
                  return name.includes('VND')
                    ? `${name}: ${Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0})}`
                    : `${name}: ${Number(v).toLocaleString('vi-VN')}`;
                }
              }}
            }
          }
        });
      }
    }

    /* ====== Load & render: BHTN ====== */
    async function rw_loadBHTN(){
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const selected = rw_getSelectedClasses();

      // Tổng HS theo lọc lớp
      const allHS = RW.allHS.filter(h => selected.length===0 || selected.includes(String(h.lop_hoc||'').trim()));
      const total = allHS.length;

      // Danh sách BHTN toàn trường -> lọc lớp
      const resBHTN = await getDanhSachBHTN(user.ma_truong||'', '');
      const ds = Array.isArray(resBHTN?.data) ? resBHTN.data : [];
      const dsFilt = ds.filter(r => {
        if (selected.length===0) return true;
        const lop = String(r.lop_hoc||'').trim();
        return selected.includes(lop);
      });

      // KPI
      let submitted = 0, money = 0, commission = 0;
      let count12 = 0, commission12 = 0;

      for (const r of dsFilt){
        submitted += 1;
        const so_tien = rw_toNum(r.so_tien);
        const hoa_hong = rw_toNum(r.hoa_hong);
        money += so_tien;
        commission += hoa_hong;

        const thang = Number(r.so_thang_dong) || 0;
        if (thang === 12 && so_tien > 0){
          count12 += 1;
          commission12 += hoa_hong;
        }
      }

      // Update KPI
      const $ = (id)=>document.getElementById(id);
      $('rw-bhtn-kpi-total').innerText = total.toLocaleString('vi-VN');
      $('rw-bhtn-kpi-submitted').innerText = submitted.toLocaleString('vi-VN');
      $('rw-bhtn-kpi-money').innerText = rw_fmtMoney(money);
      $('rw-bhtn-kpi-commission').innerText = rw_fmtMoney(commission);
      $('rw-bhtn-kpi-12m-count').innerText = count12.toLocaleString('vi-VN');
      $('rw-bhtn-kpi-12m-commission').innerText = rw_fmtMoney(commission12);

      // Chart
      const cnv = document.getElementById('rw-bhtn-chart');
      if (cnv && typeof Chart !== 'undefined'){
        const ctx = cnv.getContext('2d');
        if (RW.charts.bhtn) RW.charts.bhtn.destroy();
        RW.charts.bhtn = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['12 tháng'],
            datasets: [
              { label: 'Số hồ sơ (đã đóng)', data: [count12], yAxisID: 'yCount', borderWidth: 1 },
              { label: 'Tổng thù lao (VND)', data: [commission12], yAxisID: 'yMoney', borderWidth: 1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode:'index', intersect:false },
            scales: {
              yCount: { position:'left', beginAtZero:true, ticks:{ callback:v=>Number(v).toLocaleString('vi-VN') }, grid:{ drawOnChartArea:true } },
              yMoney: { position:'right', beginAtZero:true, ticks:{ callback:v=>Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0}) }, grid:{ drawOnChartArea:false } },
              x: { grid: { display:false } }
            },
            plugins: {
              legend: { position:'bottom' },
              tooltip: { mode:'index', callbacks:{
                label: (ctx)=>{
                  const name = ctx.dataset.label || '';
                  const v = ctx.parsed.y;
                  return name.includes('VND')
                    ? `${name}: ${Number(v).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0})}`
                    : `${name}: ${Number(v).toLocaleString('vi-VN')}`;
                }
              }}
            }
          }
        });
      }
    }

    /* ====== Init Once ====== */
    async function rw_initOnce(){
      if (RW.inited) return;
      RW.inited = true;

      await rw_buildClassList();

      const btnAll = document.getElementById('rw-btn-all');
      const btnLoad = document.getElementById('rw-btn-load');

      if (btnAll) btnAll.addEventListener('click', ()=>{
        const sel = document.getElementById('rw-classes');
        if (sel) Array.from(sel.options).forEach(o=>o.selected=false);
        if (btnLoad) btnLoad.click(); // tải toàn trường ngay
      });

      if (btnLoad) btnLoad.addEventListener('click', async ()=>{
        try{
          if (typeof showLoading === 'function') showLoading();
          await rw_loadBHYT();
          await rw_loadBHTN();
        } finally {
          if (typeof hideLoading === 'function') hideLoading();
        }
      });

      // Tải lần đầu
      if (btnLoad) btnLoad.click();
    }

    /* ====== Bind sidebar: click "Thù lao" → show loading ngay & init ====== */
    const sidebar = document.getElementById('sidebarMenu');
    if (sidebar){
      sidebar.addEventListener('click', (e)=>{
        const item = e.target.closest('.nav-item[data-page="rewards"]');
        if (!item) return;
        if (!RW.inited && typeof showLoading === 'function') { showLoading(); }
        setTimeout(rw_initOnce, 0);
      });
    }

    /* Nếu reload đang ở trang Thù lao thì init */
    const rwPage = document.getElementById('page-rewards');
    if (rwPage && !rwPage.classList.contains('d-none')){
      if (!RW.inited && typeof showLoading === 'function') { showLoading(); }
      rw_initOnce();
    }

    })();
  </script>
  <!-- ====== KHỐI THÙ LAO (Admin) ===== -->

  









  <!-- Main script -->
  <script>

    // === Vietnamese text processing ===
    function stripVN(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D'); }
    function keyVN(s){ return stripVN(String(s||'')).toLowerCase().trim(); }
    function isOtherDoiTuong(val){
      const raw = (val ?? '').toString().trim();
      if (!raw || raw.toLowerCase()==='null') return false;
      const k = keyVN(raw);
      return !(k === 'hs' || k === 'hoc sinh');
    }







    // === Utilities ===
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

    function ensureLoggedInAsAdmin() {
      const raw = localStorage.getItem('user');
      if (!raw) { window.location.href = '../index.html'; return null; }
      let user; try { user = JSON.parse(raw); } catch(e){ localStorage.removeItem('user'); window.location.href='../index.html'; return null; }
      const role = String(user.phan_quyen||'').toLowerCase();
      if (!(role === 'admin' || role === 'super_admin' || role === 'superadmin')) {
        alert('Bạn không có quyền truy cập trang này.');
        window.location.href = '../index.html';
        return null;
      }
      return user;
    }

    function setActivePage(page){
      $$('#sidebarMenu .nav-item').forEach(el=> el.classList.toggle('active', el.dataset.page === page));
      $$('[id^="page-"]').forEach(sec => sec.classList.add('d-none'));
      const sec = $(`#page-${page}`); sec?.classList.remove('d-none');

      // NEW: khi vào trang học sinh, khởi tạo UI 1 lần và reload dữ liệu
      if (page === 'students') {
        if (!sec.dataset.wired) {
          adm_wireStudentsPage();
          sec.dataset.wired = '1';
        }
        adm_reloadStudents();
      }


      // NEW: khi vào trang Đối tượng khác, khởi tạo UI 1 lần và reload dữ liệu
      if (page === 'others') {
        if (!sec.dataset.wired) { others_wirePage(); sec.dataset.wired = '1'; }
        showLoading();
        Promise.resolve(window.others_reload?.())
          .finally(hideLoading);
      }





      // NEW: khi vào trang BHYT, khởi tạo UI 1 lần và reload dữ liệu
      if (page === 'bhyt') {
        if (!sec.dataset.wired) { bhyt_wirePage(); sec.dataset.wired = '1'; }
        bhyt_reload();
      }



      // if (page === 'bhtn') {
      //   if (!sec.dataset.wired) {sec.dataset.wired = '1'; }
      //   // Tuỳ chọn: tự nạp tab đầu tiên
      //   window.bhtn_unpaid_wireTab?.();
      // }

      if (page === 'bhtn') {
        if (!sec.dataset.wired) { sec.dataset.wired = '1'; }
        showLoading();
        Promise.resolve(window.bhtn_unpaid_wireTab?.())
          .finally(hideLoading);
      }


    }


    function toggleSidebar(open){
      const sb = $('#sidebar');
      const bd = $('#backdrop');
      const willOpen = open ?? !sb.classList.contains('show');
      sb.classList.toggle('show', willOpen);
      bd.classList.toggle('show', willOpen);
    }

    // loading & toast
    function showLoading(){ $('#loadingSpinner').style.display='flex'; }

    function hideLoading(){ $('#loadingSpinner').style.display='none'; }

    function showToast(msg, type="primary"){
      const t = $('#toastNoti');
      $('#toastNotiBody').innerText = msg;
      t.className = `toast align-items-center text-white bg-${type} border-0`;
      new bootstrap.Toast(t, { delay: 3500 }).show();
    }


    // === State for filters ===
    let STATE = { students: [], bhytPaid: [], bhtnPaid: [] };
    function applyFilters(){
      const scope = $('#filterScope')?.value || 'school';
      const cls = ($('#filterClass')?.value || '').trim();
      let students = STATE.students;
      let bhyt = STATE.bhytPaid;
      let bhtn = STATE.bhtnPaid;
      if (scope === 'class' && cls){
        const byCls = r => String(r.lop_hoc||'').trim() === cls;
        students = students.filter(byCls);
        bhyt = bhyt.filter(byCls);
        bhtn = bhtn.filter(byCls);
      }
      // BHYT: đã thu = unique SDD (không tính ĐTK) + Đối tượng khác
      renderRanking('#rankBHYT', buildClassRankingBHYT(students, bhyt));
      // BHTN: xếp hạng theo số DÒNG đã thu
      renderRanking('#rankBHTN', buildClassRankingBHTN(students, bhtn));
    }






    
    async function reloadOverview(ma_truong){
      try{
        showLoading();
        const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
          countStudentsBySchool(ma_truong),
          fetchBHYT(ma_truong),
          fetchBHTN(ma_truong)
        ]);

        const isPaid = r => {
          const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
          const trang_thai = String(r.trang_thai ?? '');
          const so_ho_so = String(r.so_ho_so||'');
          return so_tien>0 || trang_thai==='1' || !!so_ho_so;
        };


        const { otherCount, bhytPaidAdjusted, bhtnPaidCount } = calcOverviewNumbers(students, bhytRows, bhtnRows);

        renderKPIs(studentsTotal, bhytPaidAdjusted, bhtnPaidCount, otherCount);

        const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
        const sel = $('#filterClass');
        sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

        STATE = { students, bhytPaid: bhytRows, bhtnPaid: bhtnRows };
        applyFilters();

        // Users overview
        const rs = await listUsers();
        const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
        const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
        const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
        const parentCount = uSchool.filter(u => {
          const r = String(u.phan_quyen||'').trim().toLowerCase();
          return r === 'phu_huynh' || r === 'user';
        }).length;
        $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
        $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
        $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
        $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');

        showToast('Đã tải lại dữ liệu tổng quan!', 'success');
      } catch(e){
        console.error(e);
        showToast('Không tải lại được dữ liệu tổng quan', 'danger');
      } finally{
        hideLoading();
      }
    }






    // === API helpers (use functions from ../js/api.js) ===
    async function listUsers(){
      try{
        const url = `${API_BASE}?func=ListUsers`;
        const res = await fetch(url);
        return await res.json();
      }catch(e){ return { success:false, data:[] }; }
    }
    async function countStudentsBySchool(ma_truong){
      const resp = await getAllDanhSachHocsinh(ma_truong||'', '');
      const arr = Array.isArray(resp?.data) ? resp.data : [];
      return { total: arr.length, rows: arr };
    }
    async function fetchBHYT(ma_truong){
      const resp = await getDanhSachBHYT(ma_truong||'', '');
      return Array.isArray(resp?.data) ? resp.data : [];
    }
    async function fetchBHTN(ma_truong){
      try{ const resp = await getDanhSachBHTN(ma_truong||'', ''); return Array.isArray(resp?.data) ? resp.data : []; }
      catch(e){ return []; }
    }





    function calcOverviewNumbers(students, bhytRows, bhtnRows){
      // Đối tượng khác (từ DS học sinh)
      const otherSet = new Set();
      (students||[]).forEach(s=>{
        const id = String(s?.so_dinh_danh||'').trim();
        if (!id) return;
        if (isOtherDoiTuong(s.doi_tuong_dong)) otherSet.add(id);
      });

      // Đã thu BHYT (unique theo SDD) từ bảng BHYT
      const isPaid = r => {
        const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
        const trang_thai = String(r.trang_thai ?? '');
        const so_ho_so = String(r.so_ho_so||'');
        return so_tien>0 || trang_thai==='1' || !!so_ho_so;
      };
      const paidSet = new Set();
      (bhytRows||[]).forEach(r=>{
        if (!isPaid(r)) return;
        const sdd = String(r.so_dinh_danh||'').replace(/^'/,'').trim();
        if (sdd) paidSet.add(sdd);
      });

      // Tránh đếm đôi: tách phần HS “thực tế” (không thuộc đối tượng khác)
      let paidHSOnly = 0;
      paidSet.forEach(id=>{ if (!otherSet.has(id)) paidHSOnly++; });

      const bhytPaidAdjusted = paidHSOnly + otherSet.size;
      const bhtnPaidCount   = (bhtnRows||[]).filter(isPaid).length;

      return {
        otherCount: otherSet.size,
        bhytPaidAdjusted,
        bhtnPaidCount
      };
    }









    // === Rendering ===
    function renderKPIs(studentsTotal, bhytPaidCountAdjusted, bhtnPaidCount, otherCount){
      $('#kpiStudents').textContent  = (studentsTotal||0).toLocaleString('vi-VN');
      $('#kpiBHYTCount').textContent = (bhytPaidCountAdjusted||0).toLocaleString('vi-VN');
      $('#kpiBHTNCount').textContent = (bhtnPaidCount||0).toLocaleString('vi-VN');
      const rateBHYT = studentsTotal ? Math.round((bhytPaidCountAdjusted||0) * 100 / studentsTotal) : 0;
      const rateBHTN = studentsTotal ? Math.round((bhtnPaidCount||0) * 100 / studentsTotal) : 0;
      $('#progressBHYTText').textContent     = rateBHYT + '%';
      $('#progressBHTNTextCard').textContent = rateBHTN + '%';
      // KPI card “Đối tượng khác”
      const elOther = document.getElementById('kpiOther');
      if (elOther) elOther.textContent = (otherCount||0).toLocaleString('vi-VN');
    }


    function renderRanking(tbodySel, items){
      const tbody = $(tbodySel);
      if (!tbody) return;
      const rows = items.map((r,i)=>{
        const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
        return `<tr>
          <td><span class="rank-num ${rankCls}">${i+1}</span></td>
          <td>${r.cls}</td>
          <td class="text-end">${r.done}</td>
          <td class="text-end">${r.total}</td>
          <td class="text-end fw-bold">${r.pct}%</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="5" class="text-center text-secondary">Không có dữ liệu</td></tr>`;
    }

    function buildClassRankingBHYT(students, bhytRows){
      // Tổng HS & Đối tượng khác theo lớp
      const totalByClass = new Map();
      const otherByClass = new Map();
      (students||[]).forEach(s=>{
        const cls = String(s.lop_hoc||'').trim(); if(!cls) return;
        totalByClass.set(cls, (totalByClass.get(cls)||0)+1);
        if (isOtherDoiTuong(s.doi_tuong_dong)){
          otherByClass.set(cls, (otherByClass.get(cls)||0)+1);
        }
      });

      // Map SDD -> lớp (fallback khi dòng BHYT thiếu lớp)
      const sddToClass = new Map();
      (students||[]).forEach(s=>{
        const sdd = String(s.so_dinh_danh||'').trim();
        const cls = String(s.lop_hoc||'').trim();
        if (sdd && cls) sddToClass.set(sdd, cls);
      });

      // Tập SDD đã nộp theo lớp (unique)
      const isPaid = r => {
        const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
        const trang_thai = String(r.trang_thai ?? '');
        const so_ho_so = String(r.so_ho_so||'');
        return so_tien>0 || trang_thai==='1' || !!so_ho_so;
      };
      const paidSetByClass = new Map();
      (bhytRows||[]).forEach(r=>{
        if (!isPaid(r)) return;
        const sdd = String(r.so_dinh_danh||'').replace(/^'/,'').trim();
        if (!sdd) return;
        let cls = String(r.lop_hoc||'').trim();
        if (!cls) cls = sddToClass.get(sdd)||'';
        if (!cls) return;
        if (!paidSetByClass.has(cls)) paidSetByClass.set(cls, new Set());
        paidSetByClass.get(cls).add(sdd);
      });

      // Loại trùng với “Đối tượng khác”: done = paidUnique(non-Other) + Other
      const result = [];
      for (const [cls,total] of totalByClass.entries()){
        const paidUnique = paidSetByClass.get(cls) || new Set();
        let paidHSOnly = 0;
        paidUnique.forEach(sdd=>{
          // nếu sdd thuộc other => KHÔNG cộng vào paidHSOnly
          // dựng set other theo lớp nhanh
          const otherCount = otherByClass.get(cls)||0; // dùng sẵn cho done
          // Không có danh sách SDD-other theo lớp => ước lượng bằng cách:
          //   Nếu học sinh sdd đó trong 'students' của lớp này và isOtherDoiTuong=true ⇒ loại
          //   (đã có map sdd->class; ở đây class đang xét)
          const s = (students||[]).find(x => String(x.so_dinh_danh||'').trim()===sdd);
          if (!s || !isOtherDoiTuong(s?.doi_tuong_dong)) paidHSOnly++;
        });
        const otherCls = otherByClass.get(cls)||0;
        const done = paidHSOnly + otherCls;
        const pct  = total ? Math.round(done*100/total) : 0;
        result.push({ cls, done, total, pct });
      }

      return result.sort((a,b)=> b.pct - a.pct || b.done - a.done || a.cls.localeCompare(b.cls));
    }



    // Xếp hạng tiến độ đóng BHTN (đếm dòng đã thu theo lớp)
    function buildClassRankingBHTN(students, bhtnRows){
      // Tổng HS theo lớp
      const totalByClass = new Map();
      (students || []).forEach(s => {
        const cls = String(s.lop_hoc || '').trim();
        if (!cls) return;
        totalByClass.set(cls, (totalByClass.get(cls) || 0) + 1);
      });

      // Map SDD -> lớp (fallback khi dòng BHTN thiếu lớp)
      const sddToClass = new Map();
      (students || []).forEach(s => {
        const sdd = String(s.so_dinh_danh || '').trim();
        const cls = String(s.lop_hoc || '').trim();
        if (sdd && cls) sddToClass.set(sdd, cls);
      });

      // Tiêu chí "đã thu"
      const isPaid = (r) => {
        const so_tien = Number(String(r.so_tien || '').replaceAll(',', ''));
        const trang_thai = String(r.trang_thai ?? '');
        const so_ho_so  = String(r.so_ho_so || '');
        return (so_tien > 0) || (trang_thai === '1') || !!so_ho_so;
      };

      // Đếm số dòng đã thu theo lớp (KHÔNG unique theo SDD cho BHTN)
      const doneByClass = new Map();
      (bhtnRows || []).forEach(r => {
        if (!isPaid(r)) return;
        let cls = String(r.lop_hoc || '').trim();
        if (!cls) {
          const sdd = String(r.so_dinh_danh || '').replace(/^'/, '').trim();
          if (sdd) cls = sddToClass.get(sdd) || '';
        }
        if (!cls) return;
        doneByClass.set(cls, (doneByClass.get(cls) || 0) + 1);
      });

      // Kết quả
      const result = [];
      for (const [cls, total] of totalByClass.entries()) {
        const done = doneByClass.get(cls) || 0;
        const pct  = total ? Math.round(done * 100 / total) : 0;
        result.push({ cls, done, total, pct });
      }

      // Sort: % giảm → đã thu giảm → tên lớp
      return result.sort((a, b) => b.pct - a.pct || b.done - a.done || a.cls.localeCompare(b.cls));
    }



    function wireSidebar(){
      setActivePage('overview');
      $$('#sidebarMenu .nav-item').forEach(item=>{
        item.addEventListener('click', ()=>{
          const page = item.dataset.page; if (!page) return; setActivePage(page);
        });
      });
      $('#btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); window.location.href = '../index.html'; });
      $('#btnToggleSidebar')?.addEventListener('click', ()=> toggleSidebar(true));
      $('#backdrop')?.addEventListener('click', ()=> toggleSidebar(false));
      $('#filterScope').addEventListener('change', (e)=>{
        const v = e.target.value; const clsSel = $('#filterClass');
        clsSel.classList.toggle('d-none', v !== 'class');
        if (v !== 'class') clsSel.value = '';
        applyFilters();
      });
      $('#filterClass').addEventListener('change', applyFilters);
    }

    // === Boot ===
    (async function init(){
      const user = ensureLoggedInAsAdmin(); if (!user) return;
      $('#userName').textContent = user.ho_ten||user.sdt||'Admin';
      $('#userRole').textContent = user.phan_quyen||'admin';
      $('#schoolName').textContent = user.ten_truong || (user.ma_truong||'');

      // reload overview on click
      $('#btnOverviewReload')?.addEventListener('click', ()=> reloadOverview(user.ma_truong||''));


      wireSidebar();
      setActivePage('overview');

      try{
        showLoading();
        const ma_truong = (user.ma_truong||'').trim();

        const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
          countStudentsBySchool(ma_truong),
          fetchBHYT(ma_truong),
          fetchBHTN(ma_truong)
        ]);

        const isPaid = r => { const so_tien = Number(String(r.so_tien||'').replaceAll(',','')); const trang_thai = String(r.trang_thai ?? ''); const so_ho_so = String(r.so_ho_so||''); return so_tien>0 || trang_thai==='1' || !!so_ho_so; };
        const { otherCount, bhytPaidAdjusted, bhtnPaidCount } = calcOverviewNumbers(students, bhytRows, bhtnRows);

        renderKPIs(studentsTotal, bhytPaidAdjusted, bhtnPaidCount, otherCount);

        const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
        const sel = $('#filterClass');
        sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

        STATE = { students, bhytPaid: bhytRows, bhtnPaid: bhtnRows };
        applyFilters();

        // Users overview
        try{
          const rs = await listUsers();
          const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
          const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
          const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
          const parentCount = uSchool.filter(u => {
            const r = String(u.phan_quyen||'').trim().toLowerCase();
            return r === 'phu_huynh' || r === 'user';
          }).length;
          $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
          $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
          $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
          $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
          $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
        } catch(e){
          $('#uAll').textContent = '-';
          $('#uAdmin').textContent = '-';
          $('#uTeacher').textContent = '-';
          $('#uParent').textContent = '-';
          $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
        }

      } catch(err){
        console.error(err);
        alert('Không tải được dữ liệu tổng quan. Vui lòng kiểm tra API_BASE trong js/api.js');
      } finally{
        hideLoading();
      }
    })();
  </script>



  <script>
    function downloadMauHS() { window.open("../mau_nhap_hocsinh.xlsx", "_blank"); }
  </script>
</body>
</html>
