<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard – ABT Medu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{
      --sidebar-w: 260px;
      --brand: #0d47a1;
      --brand-2: #2563eb;
      --muted: #6b7280;
      --card-radius: 14px;
    }
    body{ background:#f5f7fb; min-height:100vh; overflow-x:hidden; }

    /* ===== Layout ===== */
    .app{ display:flex; min-height:100vh; width:100%; }

    /* ===== Sidebar (match superadmin) ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(180deg, #0d47a1, #1e3a8a 60%, #0f172a); color:#fff; padding:16px 14px; position:sticky; top:0; height:100vh; }
    .brand{ display:flex; gap:10px; align-items:center; padding:10px 10px 18px 6px; border-bottom:1px solid rgba(255,255,255,.12); margin-bottom:8px; }
    .brand .logo{ width:44px; height:44px; border-radius:12px; background:rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; font-size:22px; }
    .brand .name{ font-weight:800; letter-spacing:.3px; line-height:1.1 }
    .nav-section{ margin-top:10px; }
    .nav-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; color:#dbeafe; text-decoration:none; margin:4px 0; cursor:pointer; }
    .nav-item:hover{ background:rgba(255,255,255,.08); color:#fff; }
    .nav-item.active{ background:rgba(59,130,246,.35); color:#fff; }
    .nav-item .bi{ font-size:18px; width:22px; text-align:center; }

    /* ===== Content ===== */
    .content{ flex:1; padding:18px; max-width:1600px; margin:0 auto; }
    .page-title{ font-weight:800; letter-spacing:.3px; color:#0f172a; }
    .sub-muted{ color:var(--muted); }

    /* ===== Cards / KPI ===== */
    .kpi-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .kpi-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .kpi-card .icon{ width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:26px; flex:0 0 auto; }
    .kpi-card .val{ font-size:28px; font-weight:900; line-height:1; }
    .kpi-card .lbl{ font-size:13px; color:#334155; margin-top:2px; }
    .ic-emerald{ background:#10b981; }
    .ic-indigo{ background:#6366f1; }
    .ic-orange{ background:#f59e0b; }
    .ic-blue{ background:#2563eb; }
    @media (min-width: 576px){ .kpi-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .kpi-card{ grid-column: span 3; } }

    /* ===== Panels & Tables ===== */
    .panel{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .table-box{ background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .table thead th{ background:#f1f5f9; font-weight:700; }
    .rank-num{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; font-weight:800; border-radius:999px; color:#0f172a; background:#e2e8f0; }
    .rank-1{ background:#fde047; }
    .rank-2{ background:#d1d5db; }
    .rank-3{ background:#f59e0b; color:#fff; }

    /* ===== User overview ===== */
    .user-grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .user-card{ grid-column: span 12; display:flex; gap:14px; align-items:center; padding:16px; background:#fff; border-radius: var(--card-radius); box-shadow: 0 2px 12px rgba(0,0,0,.06); }
    .user-card .icon{ width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:22px; }
    .uc-all .icon{ background:#0ea5e9; }
    .uc-admin .icon{ background:#f97316; }
    .uc-teacher .icon{ background:#22c55e; }
    .uc-parent .icon{ background:#06b6d4; }
    .user-card .val{ font-weight:800; font-size:22px; }
    .user-card .lbl{ color:#334155; font-size:13px; }
    @media (min-width: 576px){ .user-card{ grid-column: span 6; } }
    @media (min-width: 1200px){ .user-card{ grid-column: span 3; } }

    /* ===== Top split ===== */
    .top-split{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 1200px){ .top-split{ grid-template-columns: 2fr 1fr; } }

    /* ===== Responsive sidebar ===== */
    .toggle-btn{ display:none; }
    @media (max-width: 991px){
      .sidebar{ position:fixed; left:-100%; z-index:1045; transition:left .25s ease; }
      .sidebar.show{ left:0; }
      .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; }
      .backdrop.show{ display:block; }
      .toggle-btn{ display:inline-flex; }
    }

    /* Loading overlay */
    #loadingSpinner{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(255,255,255,.6); backdrop-filter: blur(1px); align-items:center; justify-content:center; }
  
  
  
    






    /* ===== BHYT (copy tinh gọn từ 2 file GV) ===== */
    #page-bhyt .bhyt-sticky{position:sticky;top:0;z-index:10;background:#fff;padding-bottom:4px;margin-bottom:8px}
    #page-bhyt .table-hs{background:#fff;border-radius:var(--card-radius);box-shadow:0 2px 12px rgba(0,0,0,.06)}
    #page-bhyt th.sortable{cursor:pointer;user-select:none}
    #page-bhyt .status-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    #page-bhyt .status-pending{color:#b91c1c;background:#fee2e2}
    #page-bhyt .status-paid-wait{color:#b91c1c;background:#ffe4e6}
    #page-bhyt .status-active{color:#065f46;background:#d1fae5}
    #page-bhyt .rank-num{width:32px;height:32px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-weight:800}
    #page-bhyt .a5-paper{width:210mm;min-height:148mm;background:#fff;border:1px solid #ddd;box-shadow:0 1px 8px #0002;padding:12mm}
    #page-bhyt .bhyt-card{width:86mm;height:54mm;border:1px solid #ddd;background:#fff;box-shadow:0 1px 8px #0002;padding:10px}

    /* ==== Thẻ BHYT chuẩn ==== */
    .bhyt-card{
      max-width: 920px; width: 86mm; height: 54mm; background:#fff;
      border:8px solid #2d66d5; border-radius:14px; padding:6px; box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .bhyt-inner{
      border:3px solid #2d66d5; border-radius:12px; padding: 18px 22px 34px;
      height: 100%; display: flex; flex-direction: column;
    }
    .bhyt-title{ text-align:center; font-weight:900; color:#ef4444; letter-spacing:1px; font-size:30px; }
    .bhyt-ms{ text-align:center; font-weight:800; font-size:30px; margin:4px 0 2px }
    .bhyt-sdd-line{ text-align:center; color:#4b5563; font-weight:700; }
    .bhyt-sdd{ color:#0b53ff; font-weight:900; font-size:22px; margin-left:8px }
    .bhyt-grid{ display:grid; grid-template-columns: 1.3fr 1fr; gap:18px; margin-top:8px; }
    .bhyt-col .kv{display:flex;gap:12px;margin:6px 0;align-items:flex-start}
    .kv .k{min-width:120px;color:#6b7280;font-weight:800}
    .kv .v{color:#111827;font-weight:800}
    .kv .v.v-blue  { color:#0b53ff !important; }
    .kv .v.v-red   { color:#e11d48 !important; }
    .kv .v.v-green { color:#0f9d58 !important; }
    .bhyt-lop-big{ text-align:right; font-size:44px; font-weight:900; color:#9ca3af; }
    .bhyt-footer{display:flex;justify-content:center;gap:16px;margin-top:8px}
    .bhyt-stamp{font-weight:900;color:#16a34a;font-size:28px}
    .bhyt-sohoso{padding:6px 14px;border-radius:6px;background:#fff3b0;border:2px solid #facc15;font-weight:900;color:#1d4ed8;display:inline-block}
    @media print{
      .bhyt-card{ width: 148mm !important; height: 105mm !important; }
      #bhyt-card-wrap{ width: 148mm !important; height: 105mm !important; }
    }
    .a5-paper{ width:148mm; min-height:210mm; background:#fff; margin:0 auto; padding:10mm 12mm; color:#000; box-shadow:0 1px 10px #0002; font-size:13px; line-height:1.35; }
    @media print{ .a5-paper{ box-shadow:none !important; margin:0 !important; } }
  
  </style>


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="brand mb-3">
        <div class="logo"><i class="bi bi-shield-check"></i></div>
        <div>
          <div class="name">ABT Medu</div>
          <div class="small" style="opacity:.8">Admin trường</div>
        </div>
      </div>

      <div class="nav-section" id="sidebarMenu">
        <div class="nav-item active" data-page="overview"><i class="bi bi-speedometer2"></i><span>Tổng quan</span></div>
        <div class="nav-item" data-page="students"><i class="bi bi-people"></i><span>Danh sách học sinh</span></div>
        <div class="nav-item" data-page="teachers"><i class="bi bi-person-badge"></i><span>Danh sách giáo viên</span></div>
        <div class="nav-item" data-page="bhyt"><i class="bi bi-hospital"></i><span>Bảo hiểm y tế</span></div>
        <div class="nav-item" data-page="bhtn"><i class="bi bi-heart-pulse"></i><span>Bảo Hiểm Tai Nạn</span></div>
        <div class="nav-item" data-page="stats"><i class="bi bi-bar-chart"></i><span>Thống kê</span></div>
        <div class="nav-item" data-page="rewards"><i class="bi bi-cash-coin"></i><span>Thù lao</span></div>
        <div class="nav-item" data-page="profile"><i class="bi bi-person-badge"></i><span>Cá nhân</span></div>
        <div class="nav-item" data-page="settings"><i class="bi bi-gear-wide-connected"></i><span>Cài đặt</span></div>
        <div class="nav-item" id="btnLogout"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></div>
      </div>
    </aside>

    <div class="backdrop" id="backdrop"></div>

    <!-- Content -->
    <main class="content w-100">
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <button id="btnToggleSidebar" class="btn btn-light border toggle-btn">
            <i class="bi bi-list"></i>
          </button>
          <div class="page-title h4 mb-1">Bảng điều khiển – <span id="schoolName">Trường ...</span></div>
          <div class="sub-muted">Người dùng: <strong id="userName">—</strong> • Quyền: <span id="userRole">admin</span></div>
        </div>
      </div>

      <!-- TRANG TỔNG QUAN (default) -->
      <section id="page-overview">
        <!-- Top split: KPIs + Filters -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 fw-bold mb-0">Tổng quan</div>
          <button id="btnOverviewReload" class="btn btn-sm btn-primary">
            <i class="bi bi-arrow-repeat"></i> Tải lại
          </button>
        </div>


        <div class="top-split mb-3">
          <!-- Left: KPIs (5 cards) -->
          <div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="icon ic-emerald"><i class="bi bi-people"></i></div>
                <div>
                  <div class="val" id="kpiStudents">0</div>
                  <div class="lbl">Tổng số học sinh</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-indigo"><i class="bi bi-hospital"></i></div>
                <div>
                  <div class="val" id="kpiBHYTCount">0</div>
                  <div class="lbl">Tổng số BHYT đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-orange"><i class="bi bi-heart-pulse"></i></div>
                <div>
                  <div class="val" id="kpiBHTNCount">0</div>
                  <div class="lbl">Tổng số BHTN đã thu</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer2"></i></div>
                <div>
                  <div class="val" id="progressBHYTText">0%</div>
                  <div class="lbl">Tiến độ thu BHYT</div>
                </div>
              </div>
              <div class="kpi-card">
                <div class="icon ic-blue"><i class="bi bi-speedometer"></i></div>
                <div>
                  <div class="val" id="progressBHTNTextCard">0%</div>
                  <div class="lbl">Tiến độ thu BHTN</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Filters only -->
          <div class="panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">Bộ lọc dữ liệu</div>
              <small class="text-secondary">Áp dụng cho bảng xếp hạng</small>
            </div>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" id="filterScope" style="width:auto">
                <option value="school" selected>Cả trường</option>
                <option value="class">Theo lớp</option>
              </select>
              <select class="form-select form-select-sm d-none" id="filterClass" style="width:auto"></select>
            </div>
          </div>
        </div>

        <!-- Rankings -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-primary">BHYT</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHYT"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="table-box p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">Bảng xếp hạng tiến độ đóng <span class="text-warning">BHTN</span></div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th style="width:90px">Xếp hạng</th>
                      <th>Lớp</th>
                      <th class="text-end">Đã thu</th>
                      <th class="text-end">Tổng HS</th>
                      <th class="text-end">%</th>
                    </tr>
                  </thead>
                  <tbody id="rankBHTN"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Users overview -->
        <div class="mt-3">
          <div class="fw-bold mb-2">Tổng quan người dùng</div>
          <div class="user-grid">
            <div class="user-card uc-all">
              <div class="icon"><i class="bi bi-people-fill"></i></div>
              <div>
                <div class="val" id="uAll">0</div>
                <div class="lbl">Tổng user của trường</div>
              </div>
            </div>
            <div class="user-card uc-admin">
              <div class="icon"><i class="bi bi-building-gear"></i></div>
              <div>
                <div class="val" id="uAdmin">0</div>
                <div class="lbl">Số Admin trường</div>
              </div>
            </div>
            <div class="user-card uc-teacher">
              <div class="icon"><i class="bi bi-mortarboard"></i></div>
              <div>
                <div class="val" id="uTeacher">0</div>
                <div class="lbl">Số giáo viên</div>
              </div>
            </div>
            <div class="user-card uc-parent">
              <div class="icon"><i class="bi bi-person-heart"></i></div>
              <div>
                <div class="val" id="uParent">0</div>
                <div class="lbl">Số phụ huynh</div>
              </div>
            </div>
            <div class="user-card">
              <div class="icon" style="background:#22c55e;"><i class="bi bi-emoji-smile"></i></div>
              <div>
                <div class="val" id="uStudent">0</div>
                <div class="lbl">Số học sinh</div>
              </div>
            </div>
          </div>
        </div>
      </section>










      <!-- DANH SÁCH HỌC SINH (embedded, for admin) -->
      <section id="page-students" class="d-none">
        <div class="mb-2">
          <div class="h5 fw-bold mb-2">Danh sách học sinh</div>

          <!-- Hàng filter + search + actions (giống ds_hocsinh.html) -->
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <input id="adm-loc-lop" class="form-control" style="max-width:280px" placeholder="Lọc theo lớp (để trống = tất cả)" list="admClassList">
            <datalist id="admClassList"></datalist>

            <input id="adm-search" class="form-control flex-grow-1" placeholder="Tìm theo tên, BHXH, SĐT, Số định danh..." />

            <button id="adm-btn-reload" class="btn btn-primary">Tải lại</button>
            <button id="adm-btn-add" class="btn btn-success">Thêm học sinh</button>
            <button id="adm-btn-import" class="btn btn-outline-primary">Nhập Excel</button>
            <button id="adm-btn-delmany" class="btn btn-danger d-none">Xóa đã chọn</button>
          </div>

          <div class="text-secondary mb-2">Lớp: <span id="adm-lop-text">tất cả</span> • Tổng: <span id="adm-total">0</span></div>

          <div id="adm-tablebox" class="table-responsive table-box p-0"></div>
          <nav class="mt-2"><ul class="pagination justify-content-center" id="adm-pagin"></ul></nav>
        </div>

        <!-- Modal Thêm -->
        <div class="modal fade" id="admModalAdd" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Thêm mới học sinh</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="adm-form-add" onsubmit="event.preventDefault();">
                <div class="row g-2">
                  <div class="col-md-4"><label class="form-label">Mã số BHXH</label><input class="form-control" id="add-msbhxh"></div>
                  <div class="col-md-4"><label class="form-label">Họ tên</label><input class="form-control" id="add-hoten"></div>
                  <div class="col-md-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="add-ngaysinh" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>

                  <div class="col-md-4">
                    <label class="form-label d-block">Giới tính</label>
                    <div class="d-flex gap-3">
                      <div class="form-check"><input class="form-check-input" type="radio" name="add_gt" id="add-gt-nam" value="Nam" checked><label class="form-check-label" for="add-gt-nam">Nam</label></div>
                      <div class="form-check"><input class="form-check-input" type="radio" name="add_gt" id="add-gt-nu" value="Nữ"><label class="form-check-label" for="add-gt-nu">Nữ</label></div>
                    </div>
                  </div>
                  <div class="col-md-4"><label class="form-label">Lớp</label><input class="form-control" id="add-lop" list="admClassList" placeholder="VD: 3A"></div>
                  <div class="col-md-4"><label class="form-label">Địa chỉ</label><input class="form-control" id="add-diachi"></div>

                  <div class="col-md-4"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="add-sdt"></div>
                  <div class="col-md-4"><label class="form-label">Số định danh</label><input class="form-control" id="add-sdd"></div>
                  <div class="col-md-4"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="add-chaMe"></div>

                  <div class="col-md-4"><label class="form-label">Hạn BHYT</label><input class="form-control" id="add-bhyt" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Hạn BHTN</label><input class="form-control" id="add-bhtn" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="add-noikham"></div>

                  <div class="col-md-6"><label class="form-label">Đối tượng đóng (tùy chọn)</label><input class="form-control" id="add-doituong"></div>
                  <div class="col-md-6"><label class="form-label">Ghi chú (tùy chọn)</label><input class="form-control" id="add-ghichu"></div>
                </div>
              </form>
              <div id="adm-add-err" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-add-save" class="btn btn-primary">Thêm mới</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Sửa -->
        <div class="modal fade" id="admModalEdit" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Sửa thông tin học sinh</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="adm-form-edit" onsubmit="event.preventDefault();">
                <input type="hidden" id="edit-stt">
                <div class="row g-2">
                  <div class="col-md-4"><label class="form-label">Mã số BHXH</label><input class="form-control" id="edit-msbhxh"></div>
                  <div class="col-md-4"><label class="form-label">Họ tên</label><input class="form-control" id="edit-hoten"></div>
                  <div class="col-md-4"><label class="form-label">Ngày sinh</label><input class="form-control" id="edit-ngaysinh" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>

                  <div class="col-md-4">
                    <label class="form-label d-block">Giới tính</label>
                    <div class="d-flex gap-3">
                      <div class="form-check"><input class="form-check-input" type="radio" name="edit_gt" id="edit-gt-nam" value="Nam"><label class="form-check-label" for="edit-gt-nam">Nam</label></div>
                      <div class="form-check"><input class="form-check-input" type="radio" name="edit_gt" id="edit-gt-nu" value="Nữ"><label class="form-check-label" for="edit-gt-nu">Nữ</label></div>
                    </div>
                  </div>
                  <div class="col-md-4"><label class="form-label">Lớp</label><input class="form-control" id="edit-lop" list="admClassList"></div>
                  <div class="col-md-4"><label class="form-label">Địa chỉ</label><input class="form-control" id="edit-diachi"></div>

                  <div class="col-md-4"><label class="form-label">SĐT liên hệ</label><input class="form-control" id="edit-sdt"></div>
                  <div class="col-md-4"><label class="form-label">Số định danh</label><input class="form-control" id="edit-sdd"></div>
                  <div class="col-md-4"><label class="form-label">Tên cha/mẹ</label><input class="form-control" id="edit-chaMe"></div>

                  <div class="col-md-4"><label class="form-label">Hạn BHYT</label><input class="form-control" id="edit-bhyt" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Hạn BHTN</label><input class="form-control" id="edit-bhtn" type="text" autocomplete="off" placeholder="dd/mm/yyyy"></div>
                  <div class="col-md-4"><label class="form-label">Nơi khám BHYT</label><input class="form-control" id="edit-noikham"></div>

                  <div class="col-md-6"><label class="form-label">Đối tượng đóng (tùy chọn)</label><input class="form-control" id="edit-doituong"></div>
                  <div class="col-md-6"><label class="form-label">Ghi chú (tùy chọn)</label><input class="form-control" id="edit-ghichu"></div>
                </div>
              </form>
              <div id="adm-edit-err" class="text-danger mt-2"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-edit-save" class="btn btn-primary">Lưu thay đổi</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Import -->
        <div class="modal fade" id="admModalImport" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <input type="file" id="adm-import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
              <div id="adm-import-err" class="text-danger" style="min-height:20px;"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="adm-btn-import-run" class="btn btn-primary">Nhập danh sách</button>
            </div>
          </div></div>
        </div>

        <!-- Modal Xác nhận dùng chung -->
        <div class="modal fade" id="admModalConfirm" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="admConfirmTitle">Xác nhận</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="admConfirmBody"></div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
              <button id="admConfirmBtn" class="btn btn-danger">Đồng ý</button>
            </div>
          </div></div>
        </div>
      </section>






      <section id="page-teachers" class="d-none">
        <div class="panel"><div>Danh sách giáo viên (đang phát triển).</div></div>
      </section>









      <!-- BẢO HIỂM Y TẾ (embedded, for admin) -->
      <section id="page-bhyt" class="d-none">
        <div class="mb-2">
          <div class="h5 fw-bold">Bảo hiểm y tế</div>
          <div class="text-secondary">Dựa trên giao diện & logic từ <code>ds_hocsinh_chuathu_giaovien.html</code> / <code>ds_hocsinh_dathu_giaovien.html</code>.</div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="bhytTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-chuathu" data-bs-toggle="tab" data-bs-target="#bhyt-chuathu" type="button" role="tab">
              Danh sách chưa thu BHYT
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dathu" data-bs-toggle="tab" data-bs-target="#bhyt-dathu" type="button" role="tab">
              Danh sách đã thu BHYT
            </button>
          </li>
        </ul>

        <div class="tab-content">

          <!-- Tab CHƯA THU -->
          <div class="tab-pane fade show active" id="bhyt-chuathu" role="tabpanel">
            <!-- Filter row (giống giao diện GV) -->
            <div class="bhyt-sticky">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                <select id="bhyt-ct-lop" class="form-select" style="max-width:220px">
                  <option value="">Theo lớp</option>
                </select>
                <input id="bhyt-ct-search" class="form-control flex-grow-1 search-input" placeholder="Tìm theo tên, SĐĐ, SĐT..." />
                <button id="bhyt-ct-reload" class="btn btn-outline-primary"><i class="bi bi-arrow-repeat"></i> Tải lại</button>
                <button id="bhyt-ct-bulk" class="btn btn-success"><i class="bi bi-upload"></i> Nộp nhiều</button>
              </div>
              <div class="text-secondary">Tổng: <span id="bhyt-ct-total">0</span></div>
            </div>

            <div class="table-responsive table-hs" id="bhyt-ct-tablebox"></div>
            <nav class="mt-2"><ul class="pagination justify-content-center" id="bhyt-ct-pagin"></ul></nav>
          </div>

          <!-- Tab ĐÃ THU -->
          <div class="tab-pane fade" id="bhyt-dathu" role="tabpanel">
            <div class="bhyt-sticky">
              <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                <select id="bhyt-dt-lop" class="form-select" style="max-width:220px">
                  <option value="">Theo lớp</option>
                </select>
                <input id="bhyt-dt-search" class="form-control flex-grow-1 search-input" placeholder="Tìm theo tên, số hồ sơ, SĐĐ..." />
                <button id="bhyt-dt-reload" class="btn btn-outline-primary"><i class="bi bi-arrow-repeat"></i> Tải lại</button>
              </div>
              <div class="text-secondary">Tổng: <span id="bhyt-dt-total">0</span></div>
            </div>

            <div class="table-responsive table-hs" id="bhyt-dt-tablebox"></div>
            <nav class="mt-2"><ul class="pagination justify-content-center" id="bhyt-dt-pagin"></ul></nav>
          </div>
        </div>

        <!-- ===== Modals (được rút từ 2 file GV, rút gọn tên id để khỏi đụng) ===== -->
        <!-- NỘP HỒ SƠ (1 học sinh) -->
        <div class="modal fade" id="bhytModalNop" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nộp hồ sơ BHYT</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <input type="hidden" id="bhyt-nop-sdd">
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Số tháng</label>
                  <input id="bhyt-nop-thang" type="number" min="1" max="12" value="12" class="form-control">
                </div>
                <div class="col-md-8">
                  <label class="form-label">Nơi khám BHYT</label>
                  <input id="bhyt-nop-noikham" class="form-control" list="bhytNoiKhamList" placeholder="VD: BVĐK TP Cần Thơ">
                  <datalist id="bhytNoiKhamList"></datalist>
                </div>
                <div class="col-12">
                  <label class="form-label">Ghi chú (tùy chọn)</label>
                  <input id="bhyt-nop-ghichu" class="form-control">
                </div>
              </div>
              <div class="mt-2 small">
                <div><strong class="text-danger">Hạn sử dụng dự kiến:</strong> <span id="bhyt-nop-exp" class="fw-bold text-danger">—</span></div>
                <div id="bhyt-nop-expnote" class="text-muted" style="min-height:18px"></div>
                <div><strong class="text-danger">Số tiền cần đóng:</strong> <span id="bhyt-nop-amount" class="fw-bold text-danger">—</span></div>
              </div>
              <div id="bhyt-nop-err" class="text-danger mt-1" style="min-height:18px"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="bhyt-btn-nop" class="btn btn-primary">Nộp hồ sơ</button>
            </div>
          </div></div>
        </div>

        <!-- NỘP NHIỀU -->
        <div class="modal fade" id="bhytModalBulk" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nộp nhiều hồ sơ BHYT</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-1">Số HS đã chọn: <strong id="bhyt-bulk-count">0</strong></div>
              <div class="row g-2">
                <div class="col-md-4"><label class="form-label">Số tháng</label><input id="bhyt-bulk-thang" type="number" min="1" max="12" value="12" class="form-control"></div>
                <div class="col-md-8"><label class="form-label">Nơi khám BHYT</label><input id="bhyt-bulk-noikham" class="form-control" list="bhytNoiKhamList"></div>
                <div class="col-12"><label class="form-label">Ghi chú (tùy chọn)</label><input id="bhyt-bulk-ghichu" class="form-control"></div>
              </div>
              <div class="mt-2 small">
                <div><strong class="text-danger">Hạn dự kiến:</strong> <span id="bhyt-bulk-exp" class="fw-bold text-danger">—</span></div>
                <div id="bhyt-bulk-expnote" class="text-muted" style="min-height:18px"></div>
                <div><strong class="text-danger">Số tiền (mỗi HS):</strong> <span id="bhyt-bulk-amount" class="fw-bold text-danger">—</span></div>
              </div>
              <div id="bhyt-bulk-err" class="text-danger mt-1" style="min-height:18px"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="bhyt-btn-bulk" class="btn btn-primary">Nộp nhiều hồ sơ</button>
            </div>
          </div></div>
        </div>

        <!-- SỬA HỒ SƠ (tab ĐÃ THU) -->
        <div class="modal fade" id="bhytModalSua" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHYT</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <input type="hidden" id="bhyt-sua-sdd">
              <div class="row g-2">
                <div class="col-md-4"><label class="form-label">Số tháng</label><input id="bhyt-sua-thang" type="number" min="1" max="12" class="form-control"></div>
                <div class="col-md-4"><label class="form-label">Số hồ sơ</label><input id="bhyt-sua-sohoso" class="form-control"></div>
                <div class="col-md-4"><label class="form-label">Số tiền</label><input id="bhyt-sua-sotien" type="number" class="form-control"></div>
                <div class="col-md-8"><label class="form-label">Nơi khám BHYT</label><input id="bhyt-sua-noikham" class="form-control" list="bhytNoiKhamList"></div>
                <div class="col-md-4"><label class="form-label">Hoa hồng (tuỳ chọn)</label><input id="bhyt-sua-hoahong" type="number" class="form-control" value="0"></div>
                <div class="col-12"><label class="form-label">Ghi chú</label><input id="bhyt-sua-ghichu" class="form-control"></div>
              </div>
              <div id="bhyt-sua-err" class="text-danger mt-1" style="min-height:18px"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="bhyt-btn-sua" class="btn btn-primary">Lưu thay đổi</button>
            </div>
          </div></div>
        </div>

        <!-- Xem trước & In Phiếu thu A5 -->
        <div class="modal fade" id="bhytModalPhieu" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
              <div class="d-flex gap-2"><button class="btn btn-secondary btn-sm" id="bhyt-btn-saveimg">Lưu ảnh</button><button class="btn btn-primary btn-sm" id="bhyt-btn-print">In</button></div>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="display:flex;justify-content:center;">
              <div id="bhyt-receipt" class="a5-paper"></div>
            </div>
          </div></div>
        </div>

        <!-- XEM THẺ -->
        <div class="modal fade" id="bhytModalCard" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Thẻ bảo hiểm y tế</h5><div class="d-flex gap-2"><button class="btn btn-secondary btn-sm" id="bhyt-btn-card-save">Lưu ảnh thẻ</button></div><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><div id="bhyt-card-wrap"><div id="bhyt-card" class="bhyt-card"></div></div></div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
          </div></div>
        </div>
      </section>

      <!-- BẢO HIỂM Y TẾ (embedded, for admin) -->





      




      <section id="page-bhtn" class="d-none">
        <div class="panel"><div>Đi tới <a href="bhtn_giaovien.html">BHTN</a>.</div></div>
      </section>
      <section id="page-stats" class="d-none"><div class="panel"><div>Trang thống kê nâng cao (đang phát triển).</div></div></section>
      <section id="page-rewards" class="d-none"><div class="panel"><div>Trang thù lao (đang phát triển).</div></div></section>
      <section id="page-profile" class="d-none"><div class="panel"><div>Thông tin cá nhân (đang phát triển).</div></div></section>
      <section id="page-settings" class="d-none"><div class="panel"><div> Cài đặt (đang phát triển).</div></div></section>

    </main>
  </div>

  <!-- Loading -->
  <div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>



  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
    <div id="toastNoti" class="toast align-items-center text-white bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastNotiBody">—</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Datetime Picker -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- QR code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


  <script src="../js/api.js"></script>


  <script>
  // ====== KHỐI HỌC SINH CHO ADMIN ======
  let ADM = {
    all: [],           // toàn bộ HS trường
    filtered: [],      // sau lọc + search + sort
    pageSize: 20,
    page: 1,
    sortField: "",
    sortDir: 1,
    lastPageData: [],
    selected: new Set(),
    fpAdd: {}, fpEdit: {}
  };

  // utils ngày (từ ds_hocsinh.html)
  function adm_displayNgay(raw){
    if (!raw) return "";
    if (typeof raw === "number"){
      var utc_days = Math.floor(raw - 25569), date = new Date(utc_days*86400*1000); date.setUTCHours(0,0,0,0);
      const dd=String(date.getDate()).padStart(2,'0'), mm=String(date.getMonth()+1).padStart(2,'0'), yy=date.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    if (/^\d{4}-\d{2}-\d{2}T/.test(raw)){ const d=new Date(raw);
      return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
    return raw;
  }
  function adm_isValidDateVN(s){ if(!/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return false; const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d; }
  function adm_readDateStr(sel){ const el=document.querySelector(sel); return (el && el.value)? el.value.trim() : ""; }




  // phát hiện kích thước trang
  function adm_detectPageSize(){
    const w = window.innerWidth;
    // mobile <= 576 → 3; tablet <= 991 → 5; desktop → 10
    ADM.pageSize = (w <= 576) ? 3 : (w <= 991) ? 5 : 10;
  }
  window.addEventListener('resize', () => {
    const prev = ADM.pageSize;
    adm_detectPageSize();
    if (ADM.pageSize !== prev){
      ADM.page = 1;
      adm_renderTable();
      adm_renderPagin();
    }
  });







  function adm_isValidPhone(s){ return /^0\d{9}$/.test(String(s||'').trim()); }
  function adm_isValidSdd(s){ return /^\d{12}$/.test(String(s||'').trim()); }

  // Validate từng dòng import (tham khảo validateImportRowNew bên ds_hocsinh.html)
  function adm_validateImportRowNew(
    row, rowNum,
    soDinhDanhSet, maSoBHXHSet,
    existedSoDinhDanhSet, existedMaSoBHXHSet,
    requiredMaTruong
  ){
    const required = [
      ['ma_so_bhxh', 'Mã số BHXH'],
      ['ho_ten_hoc_sinh', 'Họ tên học sinh'],
      ['ngay_sinh', 'Ngày sinh'],
      ['gioi_tinh', 'Giới tính'],
      ['dia_chi', 'Địa chỉ'],
      ['ngay_het_han_bhyt', 'Hạn BHYT'],
      ['ngay_het_han_bhtn', 'Hạn BHTN'],
      ['lop_hoc', 'Lớp'],
      ['sdt_lienhe', 'SĐT liên hệ'],
      ['so_dinh_danh', 'Số định danh'],
      ['noi_kham_bhyt', 'Nơi khám BHYT'],
      ['ten_cha_me', 'Tên cha/mẹ'],
      ['ma_truong', 'Mã trường']
    ];
    for (const [k,label] of required){
      if (!row[k] || String(row[k]).trim()===''){
        return `Dòng ${rowNum}: Trường "${label}" không được để trống.`;
      }
    }
    if (!adm_isValidDateVN(row.ngay_sinh)) return `Dòng ${rowNum}: Ngày sinh "${row.ngay_sinh}" không hợp lệ.`;
    if (!adm_isValidDateVN(row.ngay_het_han_bhyt)) return `Dòng ${rowNum}: Hạn BHYT "${row.ngay_het_han_bhyt}" không hợp lệ.`;
    if (!adm_isValidDateVN(row.ngay_het_han_bhtn)) return `Dòng ${rowNum}: Hạn BHTN "${row.ngay_het_han_bhtn}" không hợp lệ.`;
    if (!adm_isValidPhone(row.sdt_lienhe)) return `Dòng ${rowNum}: SĐT "${row.sdt_lienhe}" không hợp lệ.`;
    if (!adm_isValidSdd(row.so_dinh_danh)) return `Dòng ${rowNum}: Số định danh "${row.so_dinh_danh}" không hợp lệ. Số định danh phải gồm 12 số!`;

    if (requiredMaTruong && String(row.ma_truong).trim() !== String(requiredMaTruong).trim()){
      return `Dòng ${rowNum}: Mã trường "${row.ma_truong}" không khớp với tài khoản hiện tại.`;
    }

    const ms = String(row.ma_so_bhxh).trim();
    const sdd = String(row.so_dinh_danh).trim();

    if (maSoBHXHSet.has(ms)) return `Dòng ${rowNum}: Mã số BHXH "${ms}" bị trùng trong file import.`;
    if (soDinhDanhSet.has(sdd)) return `Dòng ${rowNum}: Số định danh "${sdd}" bị trùng trong file import.`;

    if (existedMaSoBHXHSet.has(ms)) return `Dòng ${rowNum}: Mã số BHXH "${ms}" đã tồn tại trong hệ thống.`;
    if (existedSoDinhDanhSet.has(sdd)) return `Dòng ${rowNum}: Số định danh "${sdd}" đã tồn tại trong hệ thống.`;

    maSoBHXHSet.add(ms);
    soDinhDanhSet.add(sdd);
    return "";
  }




  // fetch toàn trường 1 lần – client-side filter/search/paginate
  async function adm_reloadStudents(){
    try{
      showLoading();
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      const resp = await getAllDanhSachHocsinh(user.ma_truong||'', ''); // lop_hoc = '' → toàn trường
      ADM.all = Array.isArray(resp?.data) ? resp.data : [];
      // build datalist lớp
      const classes = [...new Set(ADM.all.map(r => String(r.lop_hoc||'').trim()).filter(Boolean))].sort();
      $('#admClassList').innerHTML = classes.map(c=>`<option value="${c}">`).join('');
      adm_detectPageSize();      // << thêm dòng này
      adm_applyFilters();
    } finally { hideLoading(); }
  }

  // áp dụng lọc + search + sort + phân trang
  function adm_applyFilters(){
    const q = $('#adm-search').value.trim().toLowerCase();
    const cls = $('#adm-loc-lop').value.trim();
    let arr = ADM.all.filter(r => (!cls || String(r.lop_hoc||'').trim()===cls));
    if (q){
      arr = arr.filter(r =>
        String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
        String(r.ma_so_bhxh||'').toLowerCase().includes(q) ||
        String(r.sdt_lienhe||'').toLowerCase().includes(q) ||
        String(r.so_dinh_danh||'').toLowerCase().includes(q) ||
        String(r.ten_cha_me||'').toLowerCase().includes(q)
      );
    }
    // sort
    if (ADM.sortField){
      const f = ADM.sortField, dir = ADM.sortDir;
      arr.sort((a,b)=>{
        let av = (a[f]??'').toString().toLowerCase(), bv=(b[f]??'').toString().toLowerCase();
        if(!isNaN(av) && !isNaN(bv)) { av=Number(av); bv=Number(bv); }
        if (av<bv) return -dir; if (av>bv) return dir; return 0;
      });
    }
    ADM.filtered = arr;
    ADM.page = Math.min(ADM.page, Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize))) || 1;
    $('#adm-lop-text').textContent = cls || 'tất cả';
    $('#adm-total').textContent = ADM.filtered.length.toLocaleString('vi-VN');
    adm_renderTable();
    adm_renderPagin();
  }

  // render bảng
  function adm_renderTable(){
    ADM.selected.clear();
    const start = (ADM.page-1)*ADM.pageSize;
    const data = ADM.filtered.slice(start, start+ADM.pageSize);
    ADM.lastPageData = data;

    const sortIcon = f => (ADM.sortField!==f)? '' : (ADM.sortDir===1?' ▲':' ▼');

    let html = `<table class="table table-hover align-middle mb-0">
      <thead class="table-light"><tr>
        <th style="width:42px"><input type="checkbox" id="adm-chk-all"></th>
        <th style="width:120px">Thao tác</th>
        <th class="text-nowrap" role="button" data-sort="ma_so_bhxh">MS BHXH${sortIcon('ma_so_bhxh')}</th>
        <th role="button" data-sort="ho_ten_hoc_sinh">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
        <th role="button" data-sort="ngay_sinh">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th role="button" data-sort="gioi_tinh">Giới tính${sortIcon('gioi_tinh')}</th>
        <th role="button" data-sort="lop_hoc">Lớp${sortIcon('lop_hoc')}</th>
        <th role="button" data-sort="so_dinh_danh">Số định danh${sortIcon('so_dinh_danh')}</th>
        <th role="button" data-sort="sdt_lienhe">SĐT${sortIcon('sdt_lienhe')}</th>
      </tr></thead><tbody>`;

    if (!data.length){
      html += `<tr><td colspan="9" class="text-center text-secondary py-4">Không có dữ liệu</td></tr>`;
    } else {
      data.forEach((r, i)=>{
        html += `<tr>
          <td><input type="checkbox" class="adm-chk" value="${r.stt}"></td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-warning me-1" data-action="edit" data-idx="${i}">Sửa</button>
            <button class="btn btn-sm btn-danger" data-action="del" data-id="${r.stt}">Xóa</button>
          </td>
          <td>${r.ma_so_bhxh||''}</td>
          <td>${r.ho_ten_hoc_sinh||''}</td>
          <td>${adm_displayNgay(r.ngay_sinh)}</td>
          <td>${r.gioi_tinh||''}</td>
          <td>${r.lop_hoc||''}</td>
          <td>${r.so_dinh_danh||''}</td>
          <td>${r.sdt_lienhe||''}</td>
        </tr>`;
      });
    }
    html += `</tbody></table>`;
    $('#adm-tablebox').innerHTML = html;

    // events: sort, check-all, row actions
    $('#adm-tablebox thead').addEventListener('click', e=>{
      const th = e.target.closest('[data-sort]');
      if (!th) return;
      const f = th.dataset.sort;
      ADM.sortField === f ? ADM.sortDir = -ADM.sortDir : (ADM.sortField=f, ADM.sortDir=1);
      adm_applyFilters();
    });
    $('#adm-chk-all')?.addEventListener('change', e=>{
      ADM.selected.clear();
      $$('.adm-chk').forEach(cb => { cb.checked=e.target.checked; if (e.target.checked) ADM.selected.add(cb.value); });
      $('#adm-btn-delmany').classList.toggle('d-none', ADM.selected.size===0);
    });
    $$('.adm-chk').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        cb.checked ? ADM.selected.add(cb.value) : ADM.selected.delete(cb.value);
        $('#adm-btn-delmany').classList.toggle('d-none', ADM.selected.size===0);
      });
    });
    $('#adm-tablebox tbody').addEventListener('click', e=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.dataset.action;
      if (action==='edit'){ adm_openEditModal(ADM.lastPageData[Number(btn.dataset.idx)||0]); }
      if (action==='del'){ adm_confirmDelete(btn.dataset.id); }
    });
  }

  function adm_renderPagin(){
    const ul = $('#adm-pagin'); ul.innerHTML='';
    const totalPages = Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize));
    if (totalPages<=1) return;
    const add = (p, active=false, disabled=false, label=p) => {
      ul.insertAdjacentHTML('beforeend', `<li class="page-item ${active?'active':''} ${disabled?'disabled':''}">
        <a class="page-link" href="#" data-page="${p}">${label}</a></li>`);
    };
    add(ADM.page-1, false, ADM.page===1, '«');
    const minP=Math.max(1,ADM.page-2), maxP=Math.min(totalPages,ADM.page+2);
    if (minP>1){ add(1); if(minP>2) ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>'); }
    for(let p=minP;p<=maxP;p++) add(p, ADM.page===p);
    if (maxP<totalPages-1){ ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>'); }
    if (maxP<totalPages) add(totalPages);
    add(ADM.page+1, false, ADM.page===totalPages, '»');

    ul.addEventListener('click', e=>{
      const a = e.target.closest('a[data-page]'); if(!a) return;
      e.preventDefault(); const p = Number(a.dataset.page);
      const totalPages = Math.max(1, Math.ceil(ADM.filtered.length/ADM.pageSize));
      if (p>=1 && p<=totalPages && p!==ADM.page){ ADM.page = p; adm_renderTable(); adm_renderPagin(); }
    }, {once:true});
  }

  // mở modal Thêm
  function adm_openAddModal(){
    $('#adm-form-add').reset?.();
    $('#adm-add-err').textContent = '';
    // init datepickers
    ADM.fpAdd.ngay = ADM.fpAdd.ngay || flatpickr('#add-ngaysinh', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpAdd.bhyt = ADM.fpAdd.bhyt || flatpickr('#add-bhyt', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpAdd.bhtn = ADM.fpAdd.bhtn || flatpickr('#add-bhtn', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });

    new bootstrap.Modal('#admModalAdd').show();
  }

  // lưu thêm
  async function adm_saveAdd(){
    const user = JSON.parse(localStorage.getItem('user')||'{}');
    const hs = {
      ma_so_bhxh: $('#add-msbhxh').value.trim(),
      ho_ten_hoc_sinh: $('#add-hoten').value.trim(),
      ngay_sinh: adm_readDateStr('#add-ngaysinh'),
      gioi_tinh: $('input[name="add_gt"]:checked')?.value || '',
      dia_chi: $('#add-diachi').value.trim(),
      ngay_het_han_bhyt: adm_readDateStr('#add-bhyt'),
      ngay_het_han_bhtn: adm_readDateStr('#add-bhtn'),
      lop_hoc: $('#add-lop').value.trim(),
      sdt_lienhe: $('#add-sdt').value.trim(),
      so_dinh_danh: $('#add-sdd').value.trim(),
      noi_kham_bhyt: $('#add-noikham').value.trim(),
      ten_cha_me: $('#add-chaMe').value.trim(),
      doi_tuong_dong: ($('#add-doituong').value||'null').trim()||'null',
      ghi_chu: ($('#add-ghichu').value||'null').trim()||'null',
      ma_truong: user.ma_truong
    };
    // bắt buộc đơn giản
    const req = ['ma_so_bhxh','ho_ten_hoc_sinh','ngay_sinh','gioi_tinh','dia_chi','ngay_het_han_bhyt','ngay_het_han_bhtn','lop_hoc','sdt_lienhe','so_dinh_danh','noi_kham_bhyt','ten_cha_me'];
    for (const k of req){ if(!hs[k]) { $('#adm-add-err').textContent='Vui lòng nhập đầy đủ trường bắt buộc.'; return; } }
    if (!adm_isValidDateVN(hs.ngay_sinh) || !adm_isValidDateVN(hs.ngay_het_han_bhyt) || !adm_isValidDateVN(hs.ngay_het_han_bhtn)){
      $('#adm-add-err').textContent='Ngày không hợp lệ (dd/mm/yyyy).'; return;
    }
    showLoading();
    const rs = await themHocsinh(hs);
    hideLoading();
    if (rs.success){
      bootstrap.Modal.getInstance($('#admModalAdd')).hide();
      showToast('Thêm học sinh thành công!', 'success');
      await adm_reloadStudents();
    } else {
      $('#adm-add-err').textContent = rs.message || 'Thêm thất bại';
      showToast($('#adm-add-err').textContent, 'danger');
    }
  }

  // mở modal Sửa
  function adm_openEditModal(hs){
    if (!hs) return;
    // init pickers 1 lần
    ADM.fpEdit.ngay = ADM.fpEdit.ngay || flatpickr('#edit-ngaysinh', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpEdit.bhyt = ADM.fpEdit.bhyt || flatpickr('#edit-bhyt', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });
    ADM.fpEdit.bhtn = ADM.fpEdit.bhtn || flatpickr('#edit-bhtn', {
      dateFormat:'d/m/Y', allowInput:true, disableMobile:true
    });


    $('#adm-edit-err').textContent='';
    $('#edit-stt').value = hs.stt;
    $('#edit-msbhxh').value = hs.ma_so_bhxh||'';
    $('#edit-hoten').value = hs.ho_ten_hoc_sinh||'';
    $('#edit-ngaysinh').value = adm_displayNgay(hs.ngay_sinh)||'';
    $('#edit-gt-nam').checked = (hs.gioi_tinh==='Nam'); $('#edit-gt-nu').checked = (hs.gioi_tinh==='Nữ');
    $('#edit-lop').value = hs.lop_hoc||'';
    $('#edit-diachi').value = hs.dia_chi||'';
    $('#edit-sdt').value = hs.sdt_lienhe||'';
    $('#edit-sdd').value = hs.so_dinh_danh||'';
    $('#edit-chaMe').value = hs.ten_cha_me||'';
    $('#edit-bhyt').value = adm_displayNgay(hs.ngay_het_han_bhyt)||'';
    $('#edit-bhtn').value = adm_displayNgay(hs.ngay_het_han_bhtn)||'';
    $('#edit-noikham').value = hs.noi_kham_bhyt||'';
    $('#edit-doituong').value = (hs.doi_tuong_dong && hs.doi_tuong_dong!=='null')? hs.doi_tuong_dong : '';
    $('#edit-ghichu').value = (hs.ghi_chu && hs.ghi_chu!=='null')? hs.ghi_chu : '';

    // set lại giá trị cho datepickers
    if (ADM.fpEdit.ngay) ADM.fpEdit.ngay.setDate($('#edit-ngaysinh').value || null, true, 'd/m/Y');
    if (ADM.fpEdit.bhyt) ADM.fpEdit.bhyt.setDate($('#edit-bhyt').value || null, true, 'd/m/Y');
    if (ADM.fpEdit.bhtn) ADM.fpEdit.bhtn.setDate($('#edit-bhtn').value || null, true, 'd/m/Y');


    new bootstrap.Modal('#admModalEdit').show();
  }

  // lưu sửa
  async function adm_saveEdit(){
    const user = JSON.parse(localStorage.getItem('user')||'{}');
    const hs = {
      stt: $('#edit-stt').value,
      ma_so_bhxh: $('#edit-msbhxh').value.trim(),
      ho_ten_hoc_sinh: $('#edit-hoten').value.trim(),
      ngay_sinh: adm_readDateStr('#edit-ngaysinh'),
      gioi_tinh: $('input[name="edit_gt"]:checked')?.value || '',
      dia_chi: $('#edit-diachi').value.trim(),
      ngay_het_han_bhyt: adm_readDateStr('#edit-bhyt'),
      ngay_het_han_bhtn: adm_readDateStr('#edit-bhtn'),
      lop_hoc: $('#edit-lop').value.trim(),
      sdt_lienhe: $('#edit-sdt').value.trim(),
      so_dinh_danh: $('#edit-sdd').value.trim(),
      noi_kham_bhyt: $('#edit-noikham').value.trim(),
      ten_cha_me: $('#edit-chaMe').value.trim(),
      doi_tuong_dong: ($('#edit-doituong').value||'null').trim()||'null',
      ghi_chu: ($('#edit-ghichu').value||'null').trim()||'null',
      ma_truong: user.ma_truong
    };
    // required đơn giản
    const req = ['stt','ma_so_bhxh','ho_ten_hoc_sinh','ngay_sinh','gioi_tinh','dia_chi','lop_hoc','sdt_lienhe','so_dinh_danh','ten_cha_me'];
    for (const k of req){ if(!hs[k]){ $('#adm-edit-err').textContent='Vui lòng nhập đủ trường bắt buộc.'; return; } }
    if (!adm_isValidDateVN(hs.ngay_sinh)){ $('#adm-edit-err').textContent='Ngày sinh không hợp lệ (dd/mm/yyyy).'; return; }

    showLoading();
    const rs = await suaHocsinh(hs);
    hideLoading();
    if (rs.success){
      bootstrap.Modal.getInstance($('#admModalEdit')).hide();
      showToast('Cập nhật học sinh thành công!', 'success');
      await adm_reloadStudents();
    } else {
      $('#adm-edit-err').textContent = rs.message || 'Cập nhật thất bại';
      showToast($('#adm-edit-err').textContent, 'danger');
    }
  }

  // xóa 1 / xóa nhiều
  function adm_confirmDelete(stt){
    $('#admConfirmTitle').textContent='Xác nhận xóa';
    $('#admConfirmBody').innerHTML='Bạn có chắc chắn muốn xóa học sinh này?';
    const btn = $('#admConfirmBtn');
    btn.onclick = async ()=>{
      // Ẩn modal NGAY lập tức trước khi xóa (fix lỗi “modal treo”)
      const m = bootstrap.Modal.getInstance($('#admModalConfirm'));
      m?.hide();

      showLoading();
      const rs = await xoaHocsinh(stt);
      hideLoading();
      if (rs.success){
        // Ẩn nút xóa nhiều + bỏ chọn tất cả checkbox (nếu còn hiển thị)
        $('#adm-btn-delmany').classList.add('d-none');
        const chkAll = $('#adm-chk-all');
        if (chkAll) chkAll.checked = false;
        $$('.adm-chk').forEach(cb => { cb.checked = false; });

        
        showToast('Xóa học sinh thành công!', 'success');
        await adm_reloadStudents();
      } else {
        showToast(rs.message || 'Xóa học sinh thất bại!', 'danger');
      }
    };
    new bootstrap.Modal('#admModalConfirm').show();
  }

  function adm_confirmDeleteMany(){
    if (!ADM.selected.size) return;
    $('#admConfirmTitle').textContent='Xác nhận xóa nhiều';
    $('#admConfirmBody').innerHTML=`Bạn có chắc chắn muốn xóa <b>${ADM.selected.size}</b> học sinh đã chọn?`;
    const btn = $('#admConfirmBtn');
    btn.onclick = async ()=>{
      // Ẩn modal trước khi xóa
      const m = bootstrap.Modal.getInstance($('#admModalConfirm'));
      m?.hide();

      showLoading();
      const rs = await xoaNhieuHocsinh([...ADM.selected]);
      hideLoading();
      if (rs.success){
        ADM.selected.clear();
        
        // Ẩn nút xóa nhiều + bỏ chọn tất cả checkbox (nếu còn hiển thị)
        $('#adm-btn-delmany').classList.add('d-none');
        const chkAll = $('#adm-chk-all');
        if (chkAll) chkAll.checked = false;
        $$('.adm-chk').forEach(cb => { cb.checked = false; });


        showToast('Xóa nhiều học sinh thành công!', 'success');
        await adm_reloadStudents();
      } else {
        showToast(rs.message || 'Xóa nhiều học sinh thất bại!', 'danger');
      }
    };
    new bootstrap.Modal('#admModalConfirm').show();
  }


  // wire UI
  function adm_wireStudentsPage(){

    // detect page size
    adm_detectPageSize();


    // inputs
    $('#adm-loc-lop').addEventListener('input', ()=>{ ADM.page=1; adm_applyFilters(); });
    $('#adm-search').addEventListener('input', ()=>{ ADM.page=1; adm_applyFilters(); });
    $('#adm-btn-reload').addEventListener('click', ()=> {
      adm_reloadStudents().then(()=> showToast('Đã tải lại danh sách học sinh', 'success'));
    });

    $('#adm-btn-add').addEventListener('click', adm_openAddModal);
    $('#adm-btn-add-save').addEventListener('click', adm_saveAdd);
    $('#adm-btn-edit-save').addEventListener('click', adm_saveEdit);
    $('#adm-btn-import').addEventListener('click', ()=> new bootstrap.Modal('#admModalImport').show());
    $('#adm-btn-delmany').addEventListener('click', adm_confirmDeleteMany);
    // import: (tận dụng API importDanhSachHocsinh giống trang ds_hocsinh nếu bạn đã expose; nếu chưa dùng tạm thời ẩn nút)
    $('#adm-btn-import-run').addEventListener('click', async ()=>{
      const f = $('#adm-import-file'); const err = $('#adm-import-err'); err.textContent='';
      if (!f.files.length){ err.textContent='Vui lòng chọn file!'; return; }
      // Có thể tái dùng logic trong ds_hocsinh.html nếu muốn validate kỹ hơn.
      showLoading();
      try{
        const data = await f.files[0].arrayBuffer();
        const wb = XLSX.read(data, {type:'array'}); const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''}); rows.shift();

        // validate + chuẩn hóa dữ liệu
        const user = JSON.parse(localStorage.getItem('user')||'{}');
        const existedSoDinhDanhSet = new Set(ADM.all.map(r => String(r.so_dinh_danh||'').trim()).filter(Boolean));
        const existedMaSoBHXHSet  = new Set(ADM.all.map(r => String(r.ma_so_bhxh||'').trim()).filter(Boolean));

        const soDinhDanhSet = new Set();
        const maSoBHXHSet   = new Set();

        const list = rows.map(r => ({
          ma_so_bhxh:String(r[1]||'').trim(),
          ho_ten_hoc_sinh:(r[2]||'').toString().trim(),
          ngay_sinh:adm_displayNgay(r[3])||'',
          gioi_tinh:(r[4]||'').toString().trim(),
          dia_chi:(r[5]||'').toString().trim(),
          ngay_het_han_bhyt:adm_displayNgay(r[6])||'',
          ngay_het_han_bhtn:adm_displayNgay(r[7])||'',
          lop_hoc:String(r[8]||'').trim(),
          sdt_lienhe:String(r[9]||'').trim(),
          so_dinh_danh:String(r[10]||'').trim(),
          noi_kham_bhyt:String(r[11]||'').trim(),
          ten_cha_me:String(r[12]||'').trim(),
          doi_tuong_dong:(r[13]&&String(r[13]).trim())?String(r[13]).trim():'null',
          ghi_chu:(r[14]&&String(r[14]).trim())?String(r[14]).trim():'null',
          ma_truong:String(r[15]||user.ma_truong).trim()
        }));

        for (let i=0;i<list.length;i++){
          const errMsg = adm_validateImportRowNew(
            list[i], i+2,
            soDinhDanhSet, maSoBHXHSet,
            existedSoDinhDanhSet, existedMaSoBHXHSet,
            user.ma_truong
          );
          if (errMsg){
            hideLoading();
            err.textContent = errMsg;
            showToast(errMsg, 'danger');
            return;
          }
        }

        const rs = await importDanhSachHocsinh(list);
        hideLoading();
        if (rs.success){
          bootstrap.Modal.getInstance($('#admModalImport')).hide();
          showToast('Import danh sách thành công!', 'success');
          await adm_reloadStudents();
        } else {
          const msg = rs.message || 'Import thất bại';
          err.textContent = msg;
          showToast(msg, 'danger');
        }

      } finally { hideLoading(); }
    });
  }
  </script>







  <script>
    /* ===== BHYT Admin Tabs ===== */
    const BHYT = {
      // state
      allStudents: [],         // toàn trường
      paidRows: [],            // danh sách đã thu (API)
      price: null,             // cấu hình giá (GetGiaBHYT)
      sClassCT: '', qCT: '',   // filter tab Chưa thu
      sClassDT: '', qDT: '',   // filter tab Đã thu
      sortCT: {f:'ho_ten_hoc_sinh', dir:1},  // sort mặc định
      sortDT: {f:'ho_ten_hoc_sinh', dir:1},
      pageCT: 1, pageDT: 1, pageSize: 10,
      selectedCT: new Set(),   // chọn để nộp nhiều
      wired: false,

      // ======= Utils ngày/tiền (giống GV) =======
      vn(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; },
      parseVN(s){ if(!/^\d{2}\/\d{2}\/\d{4}$/.test(s||'')) return null; const [d,m,y]=s.split('/').map(Number); return new Date(y,m-1,d); },
      addMonthsVN(start, months){ const d=this.parseVN(start)||new Date(); const dt=new Date(d); dt.setMonth(dt.getMonth()+months); dt.setDate(dt.getDate()-1); return this.vn(dt); },
      fmt(n){ return Number(n||0).toLocaleString('vi-VN'); },

      // lấy giá BHYT (rút logic từ GV)
      async ensureGia(){
        if (this.price) return this.price;
        try{
          const url = `${API_BASE}?func=GetGiaBHYT`;
          const rs = await (await fetch(url)).json();
          this.price = rs?.data || rs; // cấu trúc trên Apps Script: {so_tien_1_thang, ...}
          return this.price;
        }catch(e){ this.price = {so_tien_1_thang:73710}; return this.price; }
      },
      calcAmount(thang){ const p=this.price?.so_tien_1_thang||73710; return p*Number(thang||0); },

      // xét 1 bản ghi BHYT đã đóng? (giống điều kiện ở trang tổng quan)
      isPaidRow(r){
        const money = Number(String(r.so_tien||'').replaceAll(',',''));
        const tt = String(r.trang_thai??'');
        const sohs = String(r.so_ho_so||'');
        return money>0 || tt==='1' || !!sohs;
      },

      // ======= LOAD =======
      async reloadAll(ma_truong){
        showLoading();
        try{
          const [stRes, bhytRes] = await Promise.all([
            getAllDanhSachHocsinh(ma_truong||'', ''),
            getDanhSachBHYT(ma_truong||'', '')
          ]);
          this.allStudents = Array.isArray(stRes?.data)? stRes.data : [];
          const rawPaid = Array.isArray(bhytRes?.data)? bhytRes.data : [];
          this.paidRows = rawPaid.filter(r => this.isPaidRow(r));
          // build lớp cho 2 select
          const classes = [...new Set(this.allStudents.map(x=>String(x.lop_hoc||'').trim()).filter(Boolean))].sort();
          const opt = '<option value="">Theo lớp</option>'+classes.map(c=>`<option value="${c}">${c}</option>`).join('');
          $('#bhyt-ct-lop').innerHTML = opt; $('#bhyt-dt-lop').innerHTML = opt;
          // nạp datalist nơi khám (giống GV)
          const SUG = [
            'BVĐK TP Cần Thơ','BVĐK Trung Ương Cần Thơ','BV Nhi Đồng TP Cần Thơ','TTYT Quận Ninh Kiều',
            'TTYT Quận Bình Thủy','TTYT Huyện Phong Điền','TTYT Huyện Cờ Đỏ','TTYT Huyện Thới Lai'
          ];
          $('#bhytNoiKhamList').innerHTML = SUG.map(x=>`<option value="${x}">`).join('');
          // giá
          await this.ensureGia();

          this.applyCT(); this.applyDT();
        } finally{ hideLoading(); }
      },

      // ======= FILTER + RENDER (CHƯA THU) =======
      applyCT(){
        const cls=this.sClassCT, q=this.qCT.toLowerCase();
        // học sinh chưa có bản ghi paid (theo SĐĐ)
        const paidBySdd = new Set(this.paidRows.map(r => String(r.so_dinh_danh||'').trim()).filter(Boolean));
        let arr = this.allStudents.filter(s => !paidBySdd.has(String(s.so_dinh_danh||'').trim()));
        if (cls) arr = arr.filter(s => String(s.lop_hoc||'').trim()===cls);
        if (q){
          arr = arr.filter(r =>
            String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
            String(r.so_dinh_danh||'').toLowerCase().includes(q) ||
            String(r.sdt_lienhe||'').toLowerCase().includes(q)
          );
        }
        // sort
        const {f,dir}=this.sortCT;
        arr.sort((a,b)=>{ const av=(a[f]??'').toString().toLowerCase(), bv=(b[f]??'').toString().toLowerCase(); return av<bv?-dir:av>bv?dir:0; });

        this._ct = arr;
        $('#bhyt-ct-total').textContent = arr.length.toLocaleString('vi-VN');
        this.pageCT = Math.max(1, Math.min(this.pageCT, Math.ceil(arr.length/this.pageSize) || 1));
        this.renderCT();
      },
      renderCT(){
        const start=(this.pageCT-1)*this.pageSize, data=this._ct.slice(start,start+this.pageSize);
        const sortIcon = f => (this.sortCT.f!==f? '' : (this.sortCT.dir===1?' ▲':' ▼'));
        let html = `<table class="table table-hover align-middle mb-0"><thead class="table-light">
          <tr>
            <th style="width:40px"><input type="checkbox" id="bhyt-ct-chkall"></th>
            <th class="th-action" style="min-width:130px">Thao tác</th>
            <th data-sort="ho_ten_hoc_sinh" class="sortable">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
            <th data-sort="lop_hoc" class="sortable">Lớp${sortIcon('lop_hoc')}</th>
            <th>Ngày sinh</th>
            <th>Số định danh</th>
            <th>Hạn thẻ cũ</th>
            <th>Trạng thái</th>
          </tr></thead><tbody>`;
        if (!data.length){
          html+=`<tr><td colspan="8" class="text-center text-secondary py-4">Không có dữ liệu</td></tr>`;
        }else{
          data.forEach((r,i)=>{
            const chk = `<input type="checkbox" class="bhyt-ct-chk" value="${r.so_dinh_danh||''}">`;
            html+=`<tr>
              <td>${chk}</td>
              <td class="text-nowrap"><button class="btn btn-sm btn-primary" data-act="nop" data-idx="${i}">Nộp hồ sơ</button></td>
              <td>${r.ho_ten_hoc_sinh||''}</td>
              <td>${r.lop_hoc||''}</td>
              <td>${adm_displayNgay(r.ngay_sinh)||''}</td>
              <td>${r.so_dinh_danh||''}</td>
              <td>${adm_displayNgay(r.ngay_het_han_bhyt)||''}</td>
              <td><span class="status-badge status-pending">Chưa có hồ sơ</span></td>
            </tr>`;
          });
        }
        html+=`</tbody></table>`;
        $('#bhyt-ct-tablebox').innerHTML = html;

        // head events
        $('#bhyt-ct-tablebox thead').addEventListener('click', e=>{
          const th=e.target.closest('[data-sort]'); if(!th) return;
          const f=th.dataset.sort; this.sortCT.f===f? (this.sortCT.dir*=-1) : (this.sortCT={f,dir:1}); this.applyCT();
        });
        $('#bhyt-ct-chkall')?.addEventListener('change',e=>{
          this.selectedCT.clear();
          $$('.bhyt-ct-chk').forEach(cb=>{ cb.checked=e.target.checked; if(cb.checked) this.selectedCT.add(cb.value); });
        });
        $$('.bhyt-ct-chk').forEach(cb=> cb.addEventListener('change',()=>{ cb.checked? this.selectedCT.add(cb.value):this.selectedCT.delete(cb.value); }));

        // row buttons
        $('#bhyt-ct-tablebox tbody').addEventListener('click', e=>{
          const b=e.target.closest('button[data-act]'); if(!b) return;
          if (b.dataset.act==='nop'){
            const st = this._ct[(this.pageCT-1)*this.pageSize + Number(b.dataset.idx)];
            this.openNopModal(st);
          }
        }, {once:true});

        this.renderPaginate('#bhyt-ct-pagin', this._ct.length, 'CT');
      },

      // ======= FILTER + RENDER (ĐÃ THU) =======
      applyDT(){
        const cls=this.sClassDT, q=this.qDT.toLowerCase();
        let arr = [...this.paidRows];
        if (cls) arr = arr.filter(r => String(r.lop_hoc||'').trim()===cls);
        if (q){
          arr = arr.filter(r =>
            String(r.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
            String(r.so_ho_so||'').toLowerCase().includes(q) ||
            String(r.so_dinh_danh||'').toLowerCase().includes(q)
          );
        }
        const {f,dir}=this.sortDT;
        arr.sort((a,b)=>{ const av=(a[f]??'').toString().toLowerCase(), bv=(b[f]??'').toString().toLowerCase(); return av<bv?-dir:av>bv?dir:0; });
        this._dt = arr;
        $('#bhyt-dt-total').textContent = arr.length.toLocaleString('vi-VN');
        this.pageDT = Math.max(1, Math.min(this.pageDT, Math.ceil(arr.length/this.pageSize) || 1));
        this.renderDT();
      },

      renderDT(){
        const start=(this.pageDT-1)*this.pageSize, data=this._dt.slice(start,start+this.pageSize);
        const sortIcon = f => (this.sortDT.f!==f? '' : (this.sortDT.dir===1?' ▲':' ▼'));
        let html = `<table class="table table-hover align-middle mb-0"><thead class="table-light">
          <tr>
            <th class="th-action" style="min-width:180px">Thao tác</th>
            <th data-sort="ho_ten_hoc_sinh" class="sortable">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
            <th data-sort="lop_hoc" class="sortable">Lớp${sortIcon('lop_hoc')}</th>
            <th>Số hồ sơ</th>
            <th class="text-end">Số tháng</th>
            <th class="text-end">Số tiền</th>
            <th class="text-end">Hạn mới</th>
          </tr></thead><tbody>`;
        if (!data.length){
          html+=`<tr><td colspan="7" class="text-center text-secondary py-4">Không có dữ liệu</td></tr>`;
        }else{
          data.forEach((r,i)=>{
            const soThang = Number(r.so_thang_dong||r.so_thang||0);
            const soTien = Number(String(r.so_tien||'').replaceAll(',',''));
            const exp = (()=>{ const start = r.ngay_het_han_cu ? adm_displayNgay(r.ngay_het_han_cu) : (adm_displayNgay(r.ngay_het_han_bhyt)||'01/01/2024'); return BHYT.addMonthsVN(start, soThang); })();
            html+=`<tr>
              <td class="text-nowrap action-btns">
                <button class="btn btn-sm btn-warning" data-act="sua" data-idx="${i}">Sửa</button>
                <button class="btn btn-sm btn-outline-secondary" data-act="phieu" data-idx="${i}">In phiếu</button>
                <button class="btn btn-sm btn-info" data-act="card" data-idx="${i}">Xem thẻ</button>
              </td>
              <td>${r.ho_ten_hoc_sinh||''}<span class="hoso-text">SĐĐ: ${r.so_dinh_danh||''}</span></td>
              <td>${r.lop_hoc||''}</td>
              <td>${r.so_ho_so||'—'}</td>
              <td class="text-end">${soThang}</td>
              <td class="text-end">${this.fmt(soTien)}</td>
              <td class="text-end">${exp}</td>
            </tr>`;
          });
        }
        html+=`</tbody></table>`;
        $('#bhyt-dt-tablebox').innerHTML = html;

        $('#bhyt-dt-tablebox thead').addEventListener('click', e=>{
          const th=e.target.closest('[data-sort]'); if(!th) return;
          const f=th.dataset.sort; this.sortDT.f===f? (this.sortDT.dir*=-1) : (this.sortDT={f,dir:1}); this.applyDT();
        });

        $('#bhyt-dt-tablebox tbody').addEventListener('click', e=>{
          const b=e.target.closest('button[data-act]'); if(!b) return;
          const rec = this._dt[(this.pageDT-1)*this.pageSize + Number(b.dataset.idx)];
          if (b.dataset.act==='sua') this.openSuaModal(rec);
          if (b.dataset.act==='phieu') this.openReceipt(rec);
          if (b.dataset.act==='card') this.openCardModal(rec);
        }, {once:true});

        this.renderPaginate('#bhyt-dt-pagin', this._dt.length, 'DT');
      },


      renderPaginate(target, totalItems, key){
        const ul=$(target); ul.innerHTML='';
        const totalPages=Math.max(1, Math.ceil(totalItems/this.pageSize));
        const cur = (key==='CT'?this.pageCT:this.pageDT);
        if (totalPages<=1) return;
        const add = (p,active=false,disabled=false,label=p)=> ul.insertAdjacentHTML('beforeend',
          `<li class="page-item ${active?'active':''} ${disabled?'disabled':''}"><a class="page-link" href="#" data-p="${p}">${label}</a></li>`);
        add(cur-1,false,cur===1,'«');
        const minP=Math.max(1,cur-2), maxP=Math.min(totalPages,cur+2);
        if (minP>1){ add(1); if(minP>2) ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>'); }
        for(let p=minP;p<=maxP;p++) add(p,cur===p);
        if (maxP<totalPages-1){ ul.insertAdjacentHTML('beforeend','<li class="page-item disabled"><span class="page-link">…</span></li>');}
        if (maxP<totalPages) add(totalPages);
        add(cur+1,false,cur===totalPages,'»');

        ul.addEventListener('click', e=>{
          const a=e.target.closest('a[data-p]'); if(!a) return; e.preventDefault();
          if (key==='CT'){ this.pageCT=Number(a.dataset.p); this.renderCT(); }
          else { this.pageDT=Number(a.dataset.p); this.renderDT(); }
        }, {once:true});
      },

      // ====== MODALS & SUBMIT ======
      openNopModal(st){
        $('#bhyt-nop-sdd').value = st.so_dinh_danh||'';
        $('#bhyt-nop-noikham').value = st.noi_kham_bhyt||'';
        $('#bhyt-nop-ghichu').value = '';
        $('#bhyt-nop-thang').value = 12;
        this.previewNop();
        new bootstrap.Modal('#bhytModalNop').show();
      },
      previewNop(){
        const t = Number($('#bhyt-nop-thang').value||12);
        $('#bhyt-nop-amount').textContent = this.fmt(this.calcAmount(t));
        // hạn mới = hạn cũ + t tháng (lấy theo học sinh đang mở nếu có dữ liệu)
        $('#bhyt-nop-exp').textContent = 'Sau khi duyệt';
        $('#bhyt-nop-expnote').textContent = 'Hạn chính xác sẽ do cơ quan BHXH xác nhận.';
      },
      async submitNop(ma_truong){
        const so_dinh_danh = $('#bhyt-nop-sdd').value.trim();
        const so_thang_dong = Number($('#bhyt-nop-thang').value||12);
        const noi_kham = $('#bhyt-nop-noikham').value.trim();
        const ghi_chu = $('#bhyt-nop-ghichu').value.trim();
        $('#bhyt-nop-err').textContent='';

        if (!so_dinh_danh || !noi_kham){ $('#bhyt-nop-err').textContent='Vui lòng chọn nơi khám.'; return; }
        const amount = this.calcAmount(so_thang_dong);

        showLoading();
        try{
          const rs = await nopHoSoBHYT({ so_dinh_danh, so_thang_dong, so_tien: amount, noi_kham, ghi_chu, ma_truong });
          if (rs.success){
            bootstrap.Modal.getInstance($('#bhytModalNop'))?.hide();
            showToast('Đã nộp hồ sơ!', 'success');
            await this.reloadAll(ma_truong);
          } else {
            $('#bhyt-nop-err').textContent = rs.message || 'Nộp hồ sơ thất bại';
          }
        } finally{ hideLoading(); }
      },

      openBulk(){
        $('#bhyt-bulk-count').textContent = this.selectedCT.size;
        $('#bhyt-bulk-thang').value = 12; $('#bhyt-bulk-noikham').value=''; $('#bhyt-bulk-ghichu').value='';
        this.previewBulk();
        new bootstrap.Modal('#bhytModalBulk').show();
      },
      previewBulk(){
        const t = Number($('#bhyt-bulk-thang').value||12);
        $('#bhyt-bulk-amount').textContent = this.fmt(this.calcAmount(t));
        $('#bhyt-bulk-exp').textContent = 'Sau khi duyệt';
        $('#bhyt-bulk-expnote').textContent = 'Hạn chính xác sẽ do cơ quan BHXH xác nhận.';
      },
      async submitBulk(ma_truong){
        const list = [...this.selectedCT];
        if (!list.length){ $('#bhyt-bulk-err').textContent='Chưa chọn học sinh nào!'; return; }
        const so_thang_dong = Number($('#bhyt-bulk-thang').value||12);
        const noi_kham = $('#bhyt-bulk-noikham').value.trim();
        const ghi_chu = $('#bhyt-bulk-ghichu').value.trim();
        $('#bhyt-bulk-err').textContent='';
        if (!noi_kham){ $('#bhyt-bulk-err').textContent='Vui lòng nhập nơi khám.'; return; }
        const amount = this.calcAmount(so_thang_dong);

        showLoading();
        try{
          // gọi lần lượt để chắc chắn (Apps Script thường hạn chế batch)
          for (const sdd of list){
            await nopHoSoBHYT({ so_dinh_danh: sdd, so_thang_dong, so_tien: amount, noi_kham, ghi_chu, ma_truong });
          }
          bootstrap.Modal.getInstance($('#bhytModalBulk'))?.hide();
          showToast('Đã nộp nhiều hồ sơ!', 'success');
          this.selectedCT.clear();
          await this.reloadAll(ma_truong);
        } finally{ hideLoading(); }
      },

      openSuaModal(r){
        $('#bhyt-sua-sdd').value = r.so_dinh_danh||'';
        $('#bhyt-sua-thang').value = r.so_thang_dong||r.so_thang||12;
        $('#bhyt-sua-sohoso').value = r.so_ho_so||'';
        $('#bhyt-sua-sotien').value = Number(String(r.so_tien||'').replaceAll(',',''));
        $('#bhyt-sua-noikham').value = r.noi_kham||r.noi_kham_bhyt||'';
        $('#bhyt-sua-hoahong').value = r.hoa_hong||0;
        $('#bhyt-sua-ghichu').value = r.ghi_chu||'';
        $('#bhyt-sua-err').textContent='';
        new bootstrap.Modal('#bhytModalSua').show();
      },
      async submitSua(ma_truong){
        const so_dinh_danh=$('#bhyt-sua-sdd').value.trim();
        const so_thang_dong=Number($('#bhyt-sua-thang').value||12);
        const so_ho_so=$('#bhyt-sua-sohoso').value.trim();
        const so_tien=Number($('#bhyt-sua-sotien').value||0);
        const noi_kham=$('#bhyt-sua-noikham').value.trim();
        const hoa_hong=Number($('#bhyt-sua-hoahong').value||0);
        const ghi_chu=$('#bhyt-sua-ghichu').value.trim();
        $('#bhyt-sua-err').textContent='';

        if (!so_dinh_danh){ $('#bhyt-sua-err').textContent='Thiếu số định danh'; return; }

        showLoading();
        try{
          const rs = await suaHoSoBHYT({ so_dinh_danh, so_thang_dong, so_tien, noi_kham, hoa_hong, so_ho_so, ghi_chu, ma_truong });
          if (rs.success){
            bootstrap.Modal.getInstance($('#bhytModalSua'))?.hide();
            showToast('Đã cập nhật hồ sơ!', 'success');
            await this.reloadAll(ma_truong);
          } else {
            $('#bhyt-sua-err').textContent = rs.message || 'Cập nhật thất bại';
          }
        } finally{ hideLoading(); }
      },

      openReceipt(rec){
        // ở bản rút gọn này mình dựng nội dung nhanh cho phiếu:
        $('#bhyt-receipt').innerHTML = `
          <div class="mb-2"><strong id="rec-school">${($('#schoolName').textContent||'Trường')}</strong> • Lớp: <strong>${rec.lop_hoc||''}</strong></div>
          <div><b>Họ tên:</b> ${rec.ho_ten_hoc_sinh||''}</div>
          <div><b>Nội dung:</b> Thu BHYT ${Number(rec.so_thang_dong||rec.so_thang||0)} tháng</div>
          <div><b>Số tiền:</b> ${this.fmt(Number(String(rec.so_tien||'').replaceAll(',','')))} đ</div>
          <div class="mt-3">——</div>
        `;
        new bootstrap.Modal('#bhytModalPhieu').show();
      },

      // ======= Wiring =======
      wireOnce(){
        if (this.wired) return; this.wired = true;

        // tìm page size giống học sinh admin
        const setPS=()=>{ const w=window.innerWidth; this.pageSize = (w<=576)?3:(w<=991)?5:10; this.applyCT(); this.applyDT(); };
        window.addEventListener('resize', ()=>{ const p=this.pageSize; setPS(); if (p!==this.pageSize){ this.pageCT=1; this.pageDT=1; }});
        setPS();

        // inputs CT
        $('#bhyt-ct-lop').addEventListener('change', e=>{ this.sClassCT=e.target.value; this.pageCT=1; this.applyCT(); });
        $('#bhyt-ct-search').addEventListener('input', e=>{ this.qCT=e.target.value; this.pageCT=1; this.applyCT(); });
        $('#bhyt-ct-reload').addEventListener('click', ()=> this.reloadAll(JSON.parse(localStorage.getItem('user')||'{}').ma_truong||''));
        $('#bhyt-ct-bulk').addEventListener('click', ()=> this.openBulk());
        $('#bhyt-btn-bulk').addEventListener('click', ()=> this.submitBulk(JSON.parse(localStorage.getItem('user')||'{}').ma_truong||''));
        $('#bhyt-bulk-thang').addEventListener('input', ()=> this.previewBulk());

        // inputs NOP
        $('#bhyt-nop-thang').addEventListener('input', ()=> this.previewNop());
        $('#bhyt-btn-nop').addEventListener('click', ()=> this.submitNop(JSON.parse(localStorage.getItem('user')||'{}').ma_truong||''));

        // inputs DT
        $('#bhyt-dt-lop').addEventListener('change', e=>{ this.sClassDT=e.target.value; this.pageDT=1; this.applyDT(); });
        $('#bhyt-dt-search').addEventListener('input', e=>{ this.qDT=e.target.value; this.pageDT=1; this.applyDT(); });
        $('#bhyt-dt-reload').addEventListener('click', ()=> this.reloadAll(JSON.parse(localStorage.getItem('user')||'{}').ma_truong||''));

        // sửa
        $('#bhyt-btn-sua').addEventListener('click', ()=> this.submitSua(JSON.parse(localStorage.getItem('user')||'{}').ma_truong||''));
      }
    };

    // ===== Glue cho router hiện có (đừng ghi đè setActivePage)
    function bhyt_wirePage() {
      BHYT.wireOnce();
      // ==== Xem thẻ BHYT (modal) ====
      // Gọi: BHYT.openCardModal(rec)
      BHYT.openCardModal = function(rec) {
        // Build nội dung thẻ
        const school = $('#schoolName').textContent || 'Trường';
        const logo = "../assets/image/bhxh-logo.png";
        const sohoso = rec.so_ho_so || "—";
        const lop = rec.lop_hoc || "—";
        const thang = rec.so_thang_dong || rec.so_thang || "—";
        const soTien = rec.so_tien || "";
        const gioiTinh = rec.gioi_tinh || "";
        const sdt = rec.sdt_lienhe || rec.sdt || "";
        const ghichu = rec.ghi_chu || "";
        const han = rec.ngay_het_han_bhyt_moi || rec.han_su_dung_bhyt_moi || rec.ngay_het_han_bhyt || "";
        const sdd = rec.so_dinh_danh || "";
        const ms = rec.ma_so_bhxh || "";
        const ten = rec.ho_ten_hoc_sinh || "";
        const dt = rec.doi_tuong_dong || "Học sinh";
        const {tu,den} = (() => {
          const e = BHYT.parseVN(han); const months = Number(thang||0);
          if(!e||!months) return {tu:"",den:""};
          const s = new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);
          return {tu:BHYT.vn(s),den:BHYT.vn(e)};
        })();

        $('#bhyt-card').innerHTML = `
          <div class="bhyt-inner">
            <div class="bhyt-title">THẺ BẢO HIỂM Y TẾ</div>
            <div class="bhyt-ms">${ms}</div>
            <div class="bhyt-sdd-line">Số định danh:<span class="bhyt-sdd">${sdd}</span></div>
            <div class="bhyt-grid">
              <div class="bhyt-col">
                <div class="kv"><span class="k">Họ tên:</span><span class="v">${ten}</span></div>
                <div class="kv"><span class="k">Giới tính:</span><span class="v">${gioiTinh}</span></div>
                <div class="kv"><span class="k">Lớp:</span><span class="v">${lop}</span></div>
                <div class="kv"><span class="k">Từ:</span><span class="v v-blue">${tu}</span></div>
                <div class="kv"><span class="k">Đến:</span><span class="v v-red">${den}</span></div>
              </div>
              <div class="bhyt-col">
                <div class="kv"><span class="k">Đối tượng:</span><span class="v">${dt}</span></div>
                <div class="kv"><span class="k">Số tháng:</span><span class="v">${thang}</span></div>
                <div class="kv"><span class="k">Số tiền:</span><span class="v v-green">${BHYT.fmt(soTien)}</span></div>
                <div class="kv"><span class="k">SĐT:</span><span class="v">${sdt}</span></div>
              </div>
            </div>
            <div class="bhyt-footer">
              <span class="bhyt-stamp">ĐÃ ĐÓNG</span>
              <span class="bhyt-sohoso">Số hồ sơ: ${sohoso}</span>
            </div>
          </div>
        `;
        new bootstrap.Modal('#bhytModalCard').show();
      };

      // ==== Lưu ảnh thẻ BHYT ====
      $('#bhyt-btn-card-save').addEventListener('click', async ()=>{
        const node = $('#bhyt-card');
        if (!node) return;
        showLoading();
        try {
          const canvas = await html2canvas(node, {scale:2,backgroundColor:'#fff'});
          const a = document.createElement('a');
          a.download = 'the-bhyt.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        } finally { hideLoading(); }
      });

      // ==== In phiếu thu A5 (chuẩn) ====
      // Gọi: BHYT.openReceipt(rec)
      BHYT.openReceipt = function(rec) {
        // Build nội dung phiếu thu
        const school = $('#schoolName').textContent || 'Trường';
        const lop = rec.lop_hoc || '';
        const ten = rec.ho_ten_hoc_sinh || '';
        const soThang = rec.so_thang_dong || rec.so_thang || 0;
        const soTien = BHYT.fmt(Number(String(rec.so_tien||'').replaceAll(',','')));
        const today = (()=>{const d=new Date();return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`})();
        $('#bhyt-receipt').innerHTML = `
          <div style="text-align:center;font-weight:700;font-size:22px;">PHIẾU THU BẢO HIỂM Y TẾ</div>
          <div style="margin-bottom:8px;text-align:center;">${school} • Lớp: <b>${lop}</b></div>
          <div><b>Họ tên:</b> ${ten}</div>
          <div><b>Nội dung:</b> Thu BHYT ${soThang} tháng</div>
          <div><b>Số tiền:</b> ${soTien} đ</div>
          <div style="margin-top:24px;text-align:right;">${today}</div>
        `;
        new bootstrap.Modal('#bhytModalPhieu').show();
      };

      // ==== Lưu ảnh phiếu thu ====
      $('#bhyt-btn-saveimg').addEventListener('click', async ()=>{
        const node = $('#bhyt-receipt');
        if (!node) return;
        showLoading();
        try {
          const canvas = await html2canvas(node, {scale:2,backgroundColor:'#fff'});
          const a = document.createElement('a');
          a.download = 'phieu-thu-bhyt.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        } finally { hideLoading(); }
      });

      // ==== In phiếu thu (mở cửa sổ in riêng) ====
      $('#bhyt-btn-print').addEventListener('click', ()=>{
        const src = $('#bhyt-receipt');
        if (!src) return;
        const w = window.open('', '_blank', 'width=900,height=650');
        if (!w) { alert('Trình duyệt đang chặn popup in. Hãy cho phép rồi thử lại.'); return; }
        w.document.open();
        w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In phiếu thu</title><style>.a5-paper{width:148mm;min-height:210mm;padding:10mm 12mm;font-size:13px;line-height:1.35;}</style></head><body>${src.outerHTML}</body></html>`);
        w.document.close();
        w.focus();
        setTimeout(()=>{w.print(); setTimeout(()=>{try{w.close()}catch(_){}} ,500);}, 300);
      });
    }
    function bhyt_reload() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      BHYT.reloadAll(user.ma_truong || '');
    }

  </script>










  <script>
  // === Utilities ===
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  function ensureLoggedInAsAdmin() {
    const raw = localStorage.getItem('user');
    if (!raw) { window.location.href = '../index.html'; return null; }
    let user; try { user = JSON.parse(raw); } catch(e){ localStorage.removeItem('user'); window.location.href='../index.html'; return null; }
    const role = String(user.phan_quyen||'').toLowerCase();
    if (!(role === 'admin' || role === 'super_admin' || role === 'superadmin')) {
      alert('Bạn không có quyền truy cập trang này.');
      window.location.href = '../index.html';
      return null;
    }
    return user;
  }

  function setActivePage(page){
    $$('#sidebarMenu .nav-item').forEach(el=> el.classList.toggle('active', el.dataset.page === page));
    $$('[id^="page-"]').forEach(sec => sec.classList.add('d-none'));
    const sec = $(`#page-${page}`); sec?.classList.remove('d-none');

    // NEW: khi vào trang học sinh, khởi tạo UI 1 lần và reload dữ liệu
    if (page === 'students') {
      if (!sec.dataset.wired) {
        adm_wireStudentsPage();
        sec.dataset.wired = '1';
      }
      adm_reloadStudents();
    }




    // NEW: khi vào trang BHYT, khởi tạo UI 1 lần và reload dữ liệu
    if (page === 'bhyt') {
      if (!sec.dataset.wired) { bhyt_wirePage(); sec.dataset.wired = '1'; }
      bhyt_reload();
    }
  }


  function toggleSidebar(open){
    const sb = $('#sidebar');
    const bd = $('#backdrop');
    const willOpen = open ?? !sb.classList.contains('show');
    sb.classList.toggle('show', willOpen);
    bd.classList.toggle('show', willOpen);
  }

  // loading & toast
  function showLoading(){ $('#loadingSpinner').style.display='flex'; }

  function hideLoading(){ $('#loadingSpinner').style.display='none'; }

  function showToast(msg, type="primary"){
    const t = $('#toastNoti');
    $('#toastNotiBody').innerText = msg;
    t.className = `toast align-items-center text-white bg-${type} border-0`;
    new bootstrap.Toast(t, { delay: 3500 }).show();
  }


  // === State for filters ===
  let STATE = { students: [], bhytPaid: [], bhtnPaid: [] };
  function applyFilters(){
    const scope = $('#filterScope')?.value || 'school';
    const cls = ($('#filterClass')?.value || '').trim();
    let students = STATE.students;
    let bhyt = STATE.bhytPaid;
    let bhtn = STATE.bhtnPaid;
    if (scope === 'class' && cls){
      const byCls = r => String(r.lop_hoc||'').trim() === cls;
      students = students.filter(byCls);
      bhyt = bhyt.filter(byCls);
      bhtn = bhtn.filter(byCls);
    }
    renderRanking('#rankBHYT', buildClassRanking(students, bhyt));
    renderRanking('#rankBHTN', buildClassRanking(students, bhtn));
  }






  
  async function reloadOverview(ma_truong){
    try{
      showLoading();
      const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
        countStudentsBySchool(ma_truong),
        fetchBHYT(ma_truong),
        fetchBHTN(ma_truong)
      ]);

      const isPaid = r => {
        const so_tien = Number(String(r.so_tien||'').replaceAll(',',''));
        const trang_thai = String(r.trang_thai ?? '');
        const so_ho_so = String(r.so_ho_so||'');
        return so_tien>0 || trang_thai==='1' || !!so_ho_so;
      };
      const bhytPaid = bhytRows.filter(isPaid);
      const bhtnPaid = bhtnRows.filter(isPaid);

      renderKPIs(studentsTotal, bhytPaid.length, bhtnPaid.length);

      const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
      const sel = $('#filterClass');
      sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

      STATE = { students, bhytPaid, bhtnPaid };
      applyFilters();

      // Users overview
      const rs = await listUsers();
      const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
      const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
      const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
      const parentCount = uSchool.filter(u => {
        const r = String(u.phan_quyen||'').trim().toLowerCase();
        return r === 'phu_huynh' || r === 'user';
      }).length;
      $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
      $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
      $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
      $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
      $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');

      showToast('Đã tải lại dữ liệu tổng quan!', 'success');
    } catch(e){
      console.error(e);
      showToast('Không tải lại được dữ liệu tổng quan', 'danger');
    } finally{
      hideLoading();
    }
  }






  // === API helpers (use functions from ../js/api.js) ===
  async function listUsers(){
    try{
      const url = `${API_BASE}?func=ListUsers`;
      const res = await fetch(url);
      return await res.json();
    }catch(e){ return { success:false, data:[] }; }
  }
  async function countStudentsBySchool(ma_truong){
    const resp = await getAllDanhSachHocsinh(ma_truong||'', '');
    const arr = Array.isArray(resp?.data) ? resp.data : [];
    return { total: arr.length, rows: arr };
  }
  async function fetchBHYT(ma_truong){
    const resp = await getDanhSachBHYT(ma_truong||'', '');
    return Array.isArray(resp?.data) ? resp.data : [];
  }
  async function fetchBHTN(ma_truong){
    try{ const resp = await getDanhSachBHTN(ma_truong||'', ''); return Array.isArray(resp?.data) ? resp.data : []; }
    catch(e){ return []; }
  }

  // === Rendering ===
  function renderKPIs(studentsTotal, bhytPaidCount, bhtnPaidCount){
    $('#kpiStudents').textContent = studentsTotal.toLocaleString('vi-VN');
    $('#kpiBHYTCount').textContent = bhytPaidCount.toLocaleString('vi-VN');
    $('#kpiBHTNCount').textContent = bhtnPaidCount.toLocaleString('vi-VN');
    const rateBHYT = studentsTotal ? Math.round(bhytPaidCount * 100 / studentsTotal) : 0;
    const rateBHTN = studentsTotal ? Math.round(bhtnPaidCount * 100 / studentsTotal) : 0;
    $('#progressBHYTText').textContent = rateBHYT + '%';
    $('#progressBHTNTextCard').textContent = rateBHTN + '%';
  }

  function renderRanking(tbodySel, items){
    const tbody = $(tbodySel);
    if (!tbody) return;
    const rows = items.map((r,i)=>{
      const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'';
      return `<tr>
        <td><span class="rank-num ${rankCls}">${i+1}</span></td>
        <td>${r.cls}</td>
        <td class="text-end">${r.done}</td>
        <td class="text-end">${r.total}</td>
        <td class="text-end fw-bold">${r.pct}%</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="5" class="text-center text-secondary">Không có dữ liệu</td></tr>`;
  }

  function buildClassRanking(students, paidRows){
    const totalByClass = students.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    const paidByClass = paidRows.reduce((m, r)=>{ const cls = String(r.lop_hoc||'').trim(); if(!cls) return m; m[cls]=(m[cls]||0)+1; return m; }, {});
    return Object.entries(totalByClass).map(([cls,total])=>{ const done = paidByClass[cls]||0; const pct = total? Math.round(done*100/total):0; return { cls, done, total, pct }; })
      .sort((a,b)=> b.pct - a.pct || b.done - a.done || a.cls.localeCompare(b.cls));
  }

  function wireSidebar(){
    setActivePage('overview');
    $$('#sidebarMenu .nav-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        const page = item.dataset.page; if (!page) return; setActivePage(page);
      });
    });
    $('#btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('user'); window.location.href = '../index.html'; });
    $('#btnToggleSidebar')?.addEventListener('click', ()=> toggleSidebar(true));
    $('#backdrop')?.addEventListener('click', ()=> toggleSidebar(false));
    $('#filterScope').addEventListener('change', (e)=>{
      const v = e.target.value; const clsSel = $('#filterClass');
      clsSel.classList.toggle('d-none', v !== 'class');
      if (v !== 'class') clsSel.value = '';
      applyFilters();
    });
    $('#filterClass').addEventListener('change', applyFilters);
  }

  // === Boot ===
  (async function init(){
    const user = ensureLoggedInAsAdmin(); if (!user) return;
    $('#userName').textContent = user.ho_ten||user.sdt||'Admin';
    $('#userRole').textContent = user.phan_quyen||'admin';
    $('#schoolName').textContent = user.ten_truong || (user.ma_truong||'');

    // reload overview on click
    $('#btnOverviewReload')?.addEventListener('click', ()=> reloadOverview(user.ma_truong||''));


    wireSidebar();
    setActivePage('overview');

    try{
      showLoading();
      const ma_truong = (user.ma_truong||'').trim();

      const [{ total:studentsTotal, rows:students }, bhytRows, bhtnRows] = await Promise.all([
        countStudentsBySchool(ma_truong),
        fetchBHYT(ma_truong),
        fetchBHTN(ma_truong)
      ]);

      const isPaid = r => { const so_tien = Number(String(r.so_tien||'').replaceAll(',','')); const trang_thai = String(r.trang_thai ?? ''); const so_ho_so = String(r.so_ho_so||''); return so_tien>0 || trang_thai==='1' || !!so_ho_so; };
      const bhytPaid = bhytRows.filter(isPaid);
      const bhtnPaid = bhtnRows.filter(isPaid);

      renderKPIs(studentsTotal, bhytPaid.length, bhtnPaid.length);

      const classes = [...new Set(students.map(s => String(s.lop_hoc||'').trim()).filter(Boolean))].sort();
      const sel = $('#filterClass');
      sel.innerHTML = '<option value="">-- Chọn lớp --</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');

      STATE = { students, bhytPaid, bhtnPaid };
      applyFilters();

      // Users overview
      try{
        const rs = await listUsers();
        const users = Array.isArray(rs?.data||rs?.users) ? (rs.data||rs.users) : [];
        const uSchool = users.filter(u => String(u.ma_truong||'').trim() === ma_truong);
        const roleEq = r => uSchool.filter(u => String(u.phan_quyen||'').trim().toLowerCase() === r).length;
        const parentCount = uSchool.filter(u => {
          const r = String(u.phan_quyen||'').trim().toLowerCase();
          return r === 'phu_huynh' || r === 'user';
        }).length;
        $('#uAll').textContent = uSchool.length.toLocaleString('vi-VN');
        $('#uAdmin').textContent = roleEq('admin').toLocaleString('vi-VN');
        $('#uTeacher').textContent = roleEq('giao_vien').toLocaleString('vi-VN');
        $('#uParent').textContent = parentCount.toLocaleString('vi-VN');
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      } catch(e){
        $('#uAll').textContent = '-';
        $('#uAdmin').textContent = '-';
        $('#uTeacher').textContent = '-';
        $('#uParent').textContent = '-';
        $('#uStudent').textContent = studentsTotal.toLocaleString('vi-VN');
      }

    } catch(err){
      console.error(err);
      alert('Không tải được dữ liệu tổng quan. Vui lòng kiểm tra API_BASE trong js/api.js');
    } finally{
      hideLoading();
    }
  })();
</script>
</body>
</html>
