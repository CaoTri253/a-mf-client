<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã thu - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:4px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px}
    .search-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:sticky;top:48px;z-index:998;background:#f8f9fa}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .total-count{color:#444}
    th.sortable{cursor:pointer;user-select:none}
    th.th-action{min-width:180px}
    .sort-icon{font-size:14px;margin-left:4px}
    .status-wait{color:#dc2626;font-weight:600}         /* đỏ */
    .status-submitted{color:#dc2626;font-weight:600}    /* đỏ */
    .status-active{color:#16a34a;font-weight:700}       /* xanh lá */
    .sophieu{color:#1d4ed8;font-weight:700}             /* xanh dương */
    /* --- A5 receipt print (reuse from file gốc) --- */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}
    @media print{
      @page{size:A5 portrait;margin:10mm}
      .no-print{display:none!important}
      .a5-paper{box-shadow:none!important;margin:0!important}
      body{background:#fff!important}
    }
    /* --- Card BHYT preview --- */
    .card-bhyt{width:900px;max-width:100%;background:#fff;border:2px solid #3b82f6;border-radius:8px;box-shadow:0 1px 10px #0002;padding:14px}
    .card-bhyt .title{font-size:34px;font-weight:800;color:#ef4444;text-align:center}
    .card-bhyt .rowline{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .card-bhyt .label{min-width:150px;color:#6b7280;font-weight:600}
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THU LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row mb-2">
      <input class="form-control" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <!-- Modal phiếu thu (giữ nguyên như file gốc) -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col"><div class="receipt-meta"><div><strong id="rec-school">Trường …</strong></div><div>Lớp: <strong id="rec-class">—</strong></div></div></div>
            <div class="col text-center">
              <div class="receipt-meta">
                <div><strong>Mẫu số:</strong> C45-BB</div>
                <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                <div>ngày 10/10/2017 của Bộ Tài Chính</div>
              </div>
            </div>
          </div>
          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center"><div class="receipt-title">BIÊN LAI THU TIỀN</div><div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div></div>
          </div>
          <div class="mt-3">
            <div>Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div>Địa chỉ: <span id="rec-address">—</span></div>
            <div>Nội dung thu: <span id="rec-content">—</span></div>
            <div>Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div>Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>
          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xem thẻ BHYT -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="theBHYT" class="card-bhyt">
          <div class="title">THẺ BẢO HIỂM Y TẾ</div>
          <div class="rowline"><span class="label">Mã số:</span> <strong id="card-mabhxh">—</strong></div>
          <div class="rowline"><span class="label">HS - Số định danh:</span> <strong id="card-sdd">—</strong></div>
          <div class="rowline"><span class="label">Họ và tên:</span> <strong id="card-name">—</strong></div>
          <div class="rowline"><span class="label">Ngày sinh:</span> <strong id="card-dob">—</strong> <span class="label">Giới tính:</span> <strong id="card-gender">—</strong> <span class="label">Lớp:</span> <strong id="card-class">—</strong></div>
          <div class="rowline"><span class="label">Nơi ĐK KCB ban đầu:</span> <strong id="card-noikham">—</strong></div>
          <div class="rowline"><span class="label">Sử dụng từ:</span> <strong id="card-start">—</strong> <span class="label">Số tháng đóng:</span> <strong id="card-months">—</strong></div>
          <div class="rowline"><span class="label">Ngày hết hạn:</span> <strong id="card-end">—</strong> <span class="label">Số tiền đóng:</span> <strong id="card-amount">—</strong></div>
          <div class="rowline"><span class="label">Đã kích hoạt:</span> <strong id="card-active" class="text-success">ĐÃ KÍCH HOẠT</strong></div>
          <div class="rowline"><span class="label">Số hồ sơ:</span> <strong id="card-sohoso" class="sophieu">—</strong></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex"><div class="toast-body" id="toast-message">Thành công!</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    /* ==== Auth & state ==== */
    const logPrefix='[BHYT-ĐãThu]';
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1,allData=[],lastFiltered=[];
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    function showLoading(){ document.body.style.cursor='progress'; }
    function hideLoading(){ document.body.style.cursor=''; }

    function displayNgaySinh(raw){
      if(!raw) return "";
      if(raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)){ const d=new Date(raw); return d.toLocaleDateString('vi-VN');}
      if(raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`;}
      return raw;
    }
    function detectPageSize(){ const w=window.innerWidth; pageSize = w<=600?5 : w<=999?10 : 20; }
    window.addEventListener('resize',()=>{ const old=pageSize; detectPageSize(); if(old!==pageSize){ currentPage=1; window.renderAllView(); } });

    /* ==== Global render helpers (giữ giống file gốc) ==== */
    window.renderAllView = function(){
      let dataToShow = lastFiltered && lastFiltered.length ? lastFiltered : allData;
      if(sortField){
        dataToShow = [...dataToShow].sort((a,b)=>{
          let av=(a[sortField]||"").toString().toLowerCase(), bv=(b[sortField]||"").toString().toLowerCase();
          if(!isNaN(av) && !isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if(av<bv) return -sortDir; if(av>bv) return sortDir; return 0;
        });
      }
      totalRecords=dataToShow.length; totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));
      document.getElementById('total-hs').innerText=`(${totalRecords} học sinh)`;
      const start=(currentPage-1)*pageSize; renderDanhSachHS(dataToShow.slice(start,start+pageSize)); renderPagination();
    };
    window.doSort = function(field){ if(sortField===field) sortDir=-sortDir; else{sortField=field; sortDir=1;} window.renderAllView(); };
    function doSearch(){ const q=document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q? allData : allData.filter(hs => (hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q)
        || (displayNgaySinh(hs.ngay_sinh)||"").toLowerCase().includes(q)
        || (hs.so_dinh_danh||"").toLowerCase().includes(q));
      currentPage=1; window.renderAllView();
    }
    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">▲</span>':'<span class="sort-icon">▼</span>'; }
    function renderPagination(){
      const el=document.getElementById('pagination'); el.innerHTML=''; if(totalPages<=1) return;
      el.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      const minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
      if(minP>1) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if(minP>2) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for(let p=minP;p<=maxP;p++) el.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      if(maxP<totalPages-1) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if(maxP<totalPages) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage=function(p){ if(p<1||p>totalPages||p===currentPage) return; currentPage=p; window.renderAllView(); };

    /* ==== API giống file gốc ==== */
    async function getAllBHYT(ma_truong, lop){ const url=`${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`; const res=await fetch(url); return await res.json(); } /* :contentReference[oaicite:3]{index=3} */
    async function getHosoBHYTByHS(so_dinh_danh, ma_truong, lop_hoc){ const url=`${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`; const res=await fetch(url); return await res.json(); }
    async function getTenTruong(ma_truong){ try{ const url=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`; const res=await fetch(url); const j=await res.json(); return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—'; }catch(e){ return user.ten_truong || ma_truong || '—'; } }

    /* ==== Load danh sách ĐÃ THU: học theo nguyên lý merge của file gốc ==== */
    async function fetchDaThuHocsinh(){
      try{
        detectPageSize(); showLoading();
        // 1) Danh sách học sinh
        const hsUrl = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(user.ma_truong)}&lop_hoc=${encodeURIComponent(user.lop_hoc)}`;
        const hsRes = await fetch(hsUrl); const hsJson = await hsRes.json();
        // 2) Danh sách BHYT của lớp
        const bhytRes = await getAllBHYT(user.ma_truong, user.lop_hoc);
        const dsBHYT = Array.isArray(bhytRes.data) ? bhytRes.data : [];
        const bhytMap = {};
        dsBHYT.forEach(row => { const key=String(row.so_dinh_danh).replace(/^'/,'').trim(); bhytMap[key]=row; }); // giữ cả row

        // 3) Merge & lấy những HS có hồ sơ BHYT (0 & 1)
        if(hsJson.success && Array.isArray(hsJson.data)){
          allData = hsJson.data.map(hs=>{
            const r = bhytMap[hs.so_dinh_danh];
            if(!r) return null;   // chỉ lấy các bạn đã nộp hồ sơ
            return {
              ...hs,
              ...r, // gồm: ngay_het_han_bhyt_cu, han_su_dung_bhyt_moi, so_thang_dong, so_tien, trang_thai, so_ho_so, ...
              _bhyt_trangthai: (r.trang_thai===undefined? undefined : Number(r.trang_thai))
            };
          }).filter(Boolean);
        } else { allData=[]; }

        currentPage=1; doSearch();
      }catch(e){ console.error(logPrefix,'fetchDaThuHocsinh error',e); }
      finally{ hideLoading(); }
    }

    /* ==== Bảng ==== */
    function renderDanhSachHS(ds){
      if(!ds || ds.length===0){ document.getElementById('ds-container').innerHTML = `<div class="text-center text-secondary mt-4">Không có học sinh đã thu trong lớp này.</div>`; return; }
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh${sortIcon('so_dinh_danh')}</th>
        <th>Trạng thái</th>
        <th class="th-action">Thao tác</th>
      </tr></thead><tbody>`;

      ds.forEach(hs=>{
        const tt = Number(hs.trang_thai||hs._bhyt_trangthai||0);
        const sohoso = (hs.so_ho_so && String(hs.so_ho_so).trim()) ? String(hs.so_ho_so).trim() : "";
        let statusHtml = '';
        if(tt===0) statusHtml = `<span class="status-wait">Chờ duyệt</span>`;
        else if(tt===1 && !sohoso) statusHtml = `<span class="status-submitted">Đã nộp, chờ kích hoạt</span>`;
        else if(tt===1 && sohoso) statusHtml = `<div class="status-active">Đã kích hoạt</div><div class="sophieu">${sohoso}</div>`;

        let actionHtml = '';
        if(tt===1 && sohoso){
          actionHtml = `<div class="d-flex gap-1 flex-wrap">
            <button class="btn btn-success btn-sm" onclick="xemThe('${hs.stt}')">Xem thẻ</button>
            <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${hs.stt}')">In phiếu thu</button>
          </div>`;
        } else {
          actionHtml = `<button class="btn btn-primary btn-sm" onclick="inPhieuThu('${hs.stt}')">In phiếu thu</button>`;
        }

        html += `<tr>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
          <td>${statusHtml}</td>
          <td>${actionHtml}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ==== Helpers ngày/tiền & in (reuse từ file gốc) ==== */
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1])?d:null; }
    function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function addDaysExact(dateObj,days){ const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
    function todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }
    function pad3(n){ n=parseInt(n,10)||0; return String(n).padStart(3,'0'); }
    function calcRange(oldEndStr, months){ const od=parseVNDate(oldEndStr); const m=parseInt(months,10)||0; if(!od||m<=0) return {startText:"—",endText:"(không xác định)"}; const start=addDaysExact(od,1); const end=new Date(start.getFullYear(), start.getMonth()+m, 0); return {startText:formatVNDate(start), endText:formatVNDate(end)}; }
    const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s=""; if(tr>0){s+=VI_DIGITS[tr]+" trăm"; if(ch==0&&dv>0) s+=" lẻ";} if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi"; if(dv==1)s+=" mốt"; else if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI_DIGITS[dv];} else if(ch==1){s+=(s?" ":"")+"mười"; if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI_DIGITS[dv];} else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv];} return s.trim();}
    function numberToVietnamese(n){n=Math.round(Number(n)||0); if(n===0) return "Không đồng"; const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0,str=""; while(n>0&&i<units.length){const b=n%1000; if(b>0){const p=readTriple(b,i>0); str=p+units[i]+(str?" "+str:"");} n=Math.floor(n/1000); i++;} str=str.charAt(0).toUpperCase()+str.slice(1)+" đồng"; return str.replace(/\s+/g," ").trim(); }

    async function getTenTruongSafe(){ try{ return await getTenTruong(user.ma_truong);}catch(e){return user.ten_truong||"Trường …";} }
    function stripVN(s){return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase();}
    function buildQRPayload(schoolCode, school, classCode, name, months, endDate){ const mt=String(schoolCode||"").slice(0,24); const s=stripVN(school).slice(0,60); const c=String(classCode||"").slice(0,12); const n=stripVN(name).slice(0,60); const m=String(months||""); const e=String(endDate||"").slice(0,10); return `MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`; }

    /* ==== In phiếu thu (y nguyên file gốc) ==== */
    async function inPhieuThu(stt){
      try{
        showLoading();
        const hs = (lastFiltered.length?lastFiltered:allData).find(h=>String(h.stt)===String(stt)); if(!hs){hideLoading();return;}
        const hoSo = await getHosoBHYTByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
        if(!hoSo || !hoSo.success || !hoSo.data){ hideLoading(); alert("Không tìm thấy hồ sơ BHYT để in."); return; }
        const months=parseInt(hoSo.data.so_thang_dong||"12",10);
        const amount=parseInt((hoSo.data.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
        const {startText,endText}=calcRange(hs.ngay_het_han_bhyt, months);
        const schoolName = await getTenTruongSafe();
        const classCode = hoSo.data.lop_hoc || hs.lop_hoc || user.lop_hoc || "";
        const seq = pad3(hs.stt);
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";
        document.getElementById('rec-school').innerText=schoolName;
        document.getElementById('rec-class').innerText=classCode;
        document.getElementById('rec-date-today').innerText=todayText();
        document.getElementById('rec-student-name').innerText=hs.ho_ten_hoc_sinh||"";
        document.getElementById('rec-address').innerText=hs.dia_chi||"";
        document.getElementById('rec-content').innerText=`Thu tiền BHYT - ${classCode}${seq}`;
        document.getElementById('rec-months').innerText=String(months);
        document.getElementById('rec-range').innerText=`từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText=amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText=numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText=teacherName;

        const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const primaryText = buildQRPayload(user.ma_truong, schoolName, classCode, hs.ho_ten_hoc_sinh||"", months, endText);
        try{ new QRCode(qrBox,{text:primaryText,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
        catch(e){ const fallback=`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hs.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
          try{ new QRCode(qrBox,{text:fallback,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); } catch(e2){ qrBox.innerHTML='<small>QR quá dài</small>'; }
        }
        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }finally{ hideLoading(); }
    }
    function getReceiptPrintCSS(){return `<style>@page{size:A5 portrait;margin:10mm}html,body{background:#fff;margin:0}.a5-paper{width:148mm;min-height:210mm;background:#fff;color:#000;margin:0 auto;padding:10mm 12mm;line-height:1.35;font-size:13px}.receipt-title{font-weight:700;font-size:20px}.qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}.sign-col{text-align:center;margin-top:10mm;font-weight:500}.sign-name{margin-top:20mm;text-align:center;font-weight:600}.row{display:flex;flex-wrap:nowrap;width:100%}.col{flex:1 1 0}.text-center{text-align:center}</style>`;}
    function printReceiptOnly(){ const src=document.getElementById('receiptA5'); const win=window.open('','_blank'); win.document.write(`<html><head><title>In phiếu</title>${getReceiptPrintCSS()}</head><body>${src.outerHTML}</body></html>`); win.document.close(); win.focus(); setTimeout(()=>win.print(),350);}
    async function downloadReceiptImage(){ const node=document.getElementById('receiptA5'); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'}); const dataURL=canvas.toDataURL('image/png'); if('download' in document.createElement('a') && !isIOS()){const a=document.createElement('a'); a.href=dataURL; a.download='phieu-thu-bhyt.png'; document.body.appendChild(a); a.click(); a.remove();} else { const w=window.open(); w.document.write(`<img src="${dataURL}" style="max-width:100%"/>`); w.document.close(); } }

    /* ==== Xem thẻ BHYT ==== */
    function parseAmount(v){ return parseInt((v||"0").toString().replace(/[^\d]/g,''),10)||0; }
    async function xemThe(stt){
      const hs = (lastFiltered.length?lastFiltered:allData).find(h=>String(h.stt)===String(stt)); if(!hs) return;
      // Lấy lại hồ sơ để chắc thông tin mới nhất
      const hoSo = await getHosoBHYTByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
      const r = hoSo && hoSo.success && hoSo.data ? hoSo.data : hs;
      const months = parseInt(r.so_thang_dong||"12",10);
      const {startText,endText}=calcRange(hs.ngay_het_han_bhyt, months);
      document.getElementById('card-mabhxh').innerText = r.ma_so_bhxh || hs.ma_so_bhxh || '—';
      document.getElementById('card-sdd').innerText   = hs.so_dinh_danh || '—';
      document.getElementById('card-name').innerText  = hs.ho_ten_hoc_sinh || '—';
      document.getElementById('card-dob').innerText   = displayNgaySinh(hs.ngay_sinh) || '—';
      document.getElementById('card-gender').innerText= hs.gioi_tinh || '—';
      document.getElementById('card-class').innerText = r.lop_hoc || hs.lop_hoc || user.lop_hoc || '—';
      document.getElementById('card-noikham').innerText= r.noi_kham_bhyt || r.noi_kham || hs.noi_kham_bhyt || '—';
      document.getElementById('card-start').innerText = startText;
      document.getElementById('card-end').innerText   = r.han_su_dung_bhyt_moi || endText;
      document.getElementById('card-months').innerText= months;
      document.getElementById('card-amount').innerText= parseAmount(r.so_tien).toLocaleString('vi-VN');
      document.getElementById('card-sohoso').innerText= r.so_ho_so || hs.so_ho_so || '—';
      new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
    }
    async function saveCardImage(){
      const node=document.getElementById('theBHYT');
      const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
      const dataURL=canvas.toDataURL('image/png');
      const a=document.createElement('a'); a.href=dataURL; a.download='the-bhyt.png'; document.body.appendChild(a); a.click(); a.remove();
    }

    window.onload = fetchDaThuHocsinh;
  </script>
</body>
</html>
