<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã tham gia - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f8f9fa; min-height:100vh; padding:20px; }
    .sticky-header-box { position:sticky; top:0; z-index:999; background:#f8f9fa; padding-bottom:2px; }
    .header { font-size:22px; font-weight:bold; margin-bottom:8px; padding-bottom:6px; }
    .search-row { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-bottom:10px; position:sticky; top:52px; z-index:998; background:#f8f9fa; padding-bottom:4px; }
    .search-input { flex:1; min-width:180px; }
    .table-hs { background:#fff; border-radius:8px; box-shadow:0 1px 6px #0002; }
    .table-responsive{ overflow-x:auto; }
    th.th-action { min-width:210px; }
    th.th-status { min-width:140px; }
    th.sortable { cursor:pointer; user-select:none; }
    th.sortable:hover{ background:#f1f1f1; }
    .sort-icon{ font-size:15px; vertical-align:middle; margin-left:3px; }

    .status-badge { display:inline-block; font-weight:700; }
    .status-wait { color:#c62828; }       /* đỏ */
    .status-pending { color:#c62828; }    /* đỏ */
    .status-done { color:#1b5e20; }       /* xanh lá */
    .status-code { color:#1565c0; font-weight:700; font-size:14px; }

    .btn-back{
      position:fixed; bottom:26px; right:20px; z-index:1099;
      border-radius:50%; width:54px; height:54px;
      box-shadow:0 2px 14px #0003; font-size:25px;
      display:flex; align-items:center; justify-content:center;
      background:#fff; border:2px solid #eee; color:#2563eb; transition:box-shadow .12s;
    }
    .btn-back:hover{ box-shadow:0 4px 24px #2563eb33; color:#fff; background:#2563eb; }

    @media (max-width: 600px){
      .header{ font-size:18px; }
      th.th-action{ min-width:150px; }
      .action-btns{ display:flex; flex-direction:column; gap:6px; }
      .action-btns .btn{ width:100%; }
    }
    @media (min-width: 601px){
      .action-btns{ display:flex; flex-direction:row; gap:6px; }
    }

    /* ===== CSS phiếu thu A5 (giữ nguyên logic như trang "chưa thu") ===== */
    .a5-paper{
      width:148mm; min-height:210mm; background:#fff; margin:0 auto; padding:10mm 12mm;
      color:#000; box-shadow:0 1px 10px #0002; font-size:13px; line-height:1.35;
    }
    .receipt-title{ font-weight:700; font-size:22px; text-transform:uppercase; letter-spacing:.4px; }
    .receipt-sub{ font-style:italic; }
    .receipt-meta{ font-size:13px; }
    .receipt-line{ margin:2mm 0; }
    .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
    .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
    .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
    @media print{
      @page{ size:A5 portrait; margin:10mm; }
      body{ background:#fff!important; }
      .modal{ position:static!important; }
      .modal-dialog{ width:auto!important; max-width:none!important; }
      .modal-content{ box-shadow:none!important; border:none!important; }
      .no-print{ display:none!important; }
      .a5-paper{ box-shadow:none!important; margin:0!important; }
    }

    /* ===== CSS "Thẻ BHYT" trong modal (xem thẻ) ===== */
    .card-bhyt{
      width: 800px; max-width: 100%; background:#fff; border:2px solid #2a75f3; border-radius:10px; padding:18px 16px;
      box-shadow:0 1px 12px #0002; font-family: Arial, Helvetica, sans-serif;
    }
    .card-bhyt .title{ text-align:right; color:#f44336; font-weight:800; font-size:26px; letter-spacing:1px; }
    .card-bhyt .row-line{ display:flex; flex-wrap:wrap; gap:12px; margin:8px 0; align-items:center; }
    .card-bhyt .lbl{ color:#666; font-weight:600; }
    .card-bhyt .val{ color:#000; font-weight:700; }
    .card-bhyt .val.blue{ color:#0d47a1; }
    .card-bhyt .val.red{ color:#c62828; }
    .card-bhyt .val.green{ color:#1b5e20; }
    .card-bhyt .big{ font-size:18px; }
    .card-bhyt .code-box{ margin-top:6px; background:#fffde7; border-left:6px solid #1976d2; display:inline-block; padding:4px 10px; font-weight:800; color:#1a237e; border-radius:6px; }
    .card-bhyt .logo{
      width:64px; height:64px; border-radius:50%; background:#e3f2fd; display:flex; align-items:center; justify-content:center;
      font-weight:800; color:#1565c0; border:2px solid #90caf9; margin-right:10px;
    }
    .card-bhyt .header-line{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .card-bhyt .hr{ height:1px; background:#e0e0e0; margin:10px 0; }
  </style>
</head>
<body>
  <!-- Sticky header & search -->
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal XEM THẺ BHYT -->
  <div class="modal fade" id="modalBHYTCard" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="downloadBHYTCard()">Lưu ảnh thẻ</button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <div id="bhytCard" class="card-bhyt">
            <div class="header-line">
              <div class="d-flex align-items-center">
                <div class="logo">YT</div>
                <div class="fs-5 fw-bold">THẺ BẢO HIỂM Y TẾ</div>
              </div>
              <div class="title">THẺ BẢO HIỂM Y TẾ</div>
            </div>

            <div class="row-line big"><span class="lbl">Mã số:</span> <span class="val" id="c_ma_so">—</span>
              <span class="lbl ms-3">Số định danh:</span> <span class="val blue" id="c_sdd">—</span>
            </div>
            <div class="hr"></div>

            <div class="row-line"><span class="lbl">HS</span>
              <span class="lbl">Họ và tên:</span> <span class="val" id="c_hoten">—</span>
            </div>
            <div class="row-line"><span class="lbl">Ngày sinh:</span> <span class="val" id="c_ngaysinh">—</span>
              <span class="lbl ms-3">Giới tính:</span> <span class="val" id="c_gioitinh">—</span>
              <span class="val fw-bold ms-auto" id="c_lop">—</span>
            </div>
            <div class="row-line"><span class="lbl">Nơi ĐK KCB BĐ:</span> <span class="val" id="c_noikham">—</span></div>
            <div class="row-line"><span class="lbl">Sử dụng từ:</span> <span class="val blue" id="c_from">—</span>
              <span class="lbl ms-3">Số tháng đóng:</span> <span class="val" id="c_thang">—</span>
            </div>
            <div class="row-line"><span class="lbl">Ngày hết hạn:</span> <span class="val red" id="c_to">—</span>
              <span class="lbl ms-3">Số tiền đóng:</span> <span class="val green" id="c_tien">—</span>
            </div>
            <div class="row-line"><span class="lbl">Địa chỉ:</span> <span class="val" id="c_diachi">—</span></div>
            <div class="row-line"><span class="lbl">Điện thoại:</span> <span class="val" id="c_sdt">—</span></div>
            <div class="row-line"><span class="lbl">Ghi chú:</span> <span class="val" id="c_ghichu">—</span></div>

            <div class="hr"></div>
            <div class="row-line">
              <span class="val green" id="c_status">ĐÃ KÍCH HOẠT</span>
            </div>
            <div class="row-line">
              <span class="code-box" id="c_sohoso">—</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-outline-secondary" onclick="downloadBHYTCard()">Lưu ảnh thẻ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Xem trước & In Phiếu thu A5 -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
          <div class="no-print d-flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
            <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="display:flex;justify-content:center;">
          <div id="receiptA5" class="a5-paper">
            <div class="row">
              <div class="col">
                <div class="receipt-meta">
                  <div><strong id="rec-school">Trường …</strong></div>
                  <div>Lớp: <strong id="rec-class">—</strong></div>
                </div>
              </div>
              <div class="col text-center">
                <div class="receipt-meta">
                  <div><strong>Mẫu số:</strong> C45-BB</div>
                  <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                  <div>ngày 10/10/2017 của Bộ Tài Chính</div>
                </div>
              </div>
            </div>

            <div class="row align-items-center mt-3">
              <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
              <div class="col text-center">
                <div class="receipt-title">BIÊN LAI THU TIỀN</div>
                <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
              </div>
            </div>

            <div class="mt-3">
              <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
              <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
              <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
              <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
              <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
              <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
            </div>

            <div class="row">
              <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
              <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small>
                <div class="sign-name" id="rec-teacher-name">—</div>
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer no-print">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thao tác thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== Khởi tạo ====== */
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    function showLoading(){ document.getElementById('loadingSpinner').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingSpinner').style.display='none'; }
    function showToast(msg){ document.getElementById('toast-message').innerText = msg; bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show(); }

    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    /* ====== Helpers ngày & định dạng ====== */
    function parseVNDate(str){
      const m = String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const d = new Date(+m[3], +m[2]-1, +m[1]);
      return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1]) ? d : null;
    }
    function formatVNDate(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function addDaysExact(dateObj, days){
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0);
      d.setDate(d.getDate()+days);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    function calcRangeFromOld(oldEndStr, months){
      const od = parseVNDate(oldEndStr); const m = parseInt(months,10)||0;
      if (!od || m<=0) return {startText:"—", endText:"(không xác định)"};
      const start = addDaysExact(od,1);
      const end   = new Date(start.getFullYear(), start.getMonth()+m, 0);
      return { startText: formatVNDate(start), endText: formatVNDate(end) };
    }
    function displayNgaySinh(raw){
      if (!raw) return "";
      if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
      if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) { const [y,m,d] = raw.split('-'); return `${d}/${m}/${y}`; }
      return raw;
    }

    /* ====== API phụ trợ tại trang (do api.js chưa có GetDanhSachBHYT/GetTenTruong) ====== */
    async function getAllBHYT(ma_truong, lop_hoc){
      const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getTenTruong(ma_truong){
      try{
        const res = await fetch(`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`);
        const j = await res.json();
        return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—';
      }catch(e){ return user.ten_truong || ma_truong || '—'; }
    }

    /* ====== State & phân trang ====== */
    let pageSize = 20, currentPage = 1, totalRecords = 0, totalPages = 1, sortField = "ho_ten_hoc_sinh", sortDir = 1, allData = [], lastFiltered = [];
    function detectPageSize(){
      const w=window.innerWidth; pageSize = w<=600? 6 : (w<=999? 10: 20);
    }
    window.addEventListener('resize', () => { const prev=pageSize; detectPageSize(); if (prev!==pageSize){ currentPage=1; renderAllView(); } });

    function doSearch(){
      const q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q ? allData : allData.filter(r =>
        (r.ho_ten_hoc_sinh||"").toLowerCase().includes(q) ||
        (displayNgaySinh(r.ngay_sinh)||"").toLowerCase().includes(q) ||
        (r.so_dinh_danh||"").toLowerCase().includes(q)
      );
      currentPage=1; renderAllView();
    }
    function sortIcon(field){ if (sortField!==field) return ''; return sortDir===1? '<span class="sort-icon">&#9650;</span>' : '<span class="sort-icon">&#9660;</span>'; }
    window.doSort = function(field){ if (sortField===field) sortDir=-sortDir; else { sortField=field; sortDir=1; } renderAllView(); };

    function renderAllView(){
      let dataToShow = lastFiltered || allData;
      if (sortField){
        dataToShow = [...dataToShow].sort((a,b)=>{
          let av = (a[sortField]||"").toString().toLowerCase();
          let bv = (b[sortField]||"").toString().toLowerCase();
          if (!isNaN(av) && !isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if (av<bv) return -sortDir; if (av>bv) return sortDir; return 0;
        });
      }
      totalRecords = dataToShow.length;
      totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} hồ sơ)`;

      const start = (currentPage-1)*pageSize;
      renderDanhSach(dataToShow.slice(start, start+pageSize));
      renderPagination();
    }
    function renderPagination(){
      const el = document.getElementById('pagination'); el.innerHTML='';
      if (totalPages<=1) return;
      el.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
      if (minP>1) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP>2) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for(let p=minP;p<=maxP;p++){ el.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`; }
      if (maxP<totalPages-1) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP<totalPages) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function(p){ if (p<1||p>totalPages||p===currentPage) return; currentPage=p; renderAllView(); };

    /* ====== Lấy dữ liệu ====== */
    async function fetchDanhSachDaThu(){
      try{
        detectPageSize(); showLoading();
        const res = await getAllBHYT(user.ma_truong, user.lop_hoc);
        const ds = Array.isArray(res?.data) ? res.data : [];

        // Chỉ giữ hồ sơ của lớp hiện tại (đề phòng backend trả rộng)
        allData = ds.filter(r => String(r.lop_hoc||"").trim() === String(user.lop_hoc||"").trim());
        lastFiltered = allData;
        currentPage = 1;
        renderAllView();
      }catch(e){
        console.error('[DaThu] fetch error', e);
        allData=[]; lastFiltered=[]; renderAllView();
      }finally{ hideLoading(); }
    }

    /* ====== Render danh sách ====== */
    function statusCell(row){
      const tt = Number(row.trang_thai||0);
      const sohoso = (row.so_ho_so===null || String(row.so_ho_so).toLowerCase()==='null' || String(row.so_ho_so).trim()==='') ? null : String(row.so_ho_so);
      if (tt===0){
        return `<div class="status-badge status-wait">Chờ duyệt</div>`;
      }
      if (tt===1 && !sohoso){
        return `<div class="status-badge status-pending">Đã nộp, chờ kích hoạt</div>`;
      }
      if (tt===1 && sohoso){
        return `<div class="status-badge status-done">Đã kích hoạt</div><div class="status-code">${sohoso}</div>`;
      }
      return '';
    }
    function actionButtons(row){
      const tt = Number(row.trang_thai||0);
      const sohoso = (row.so_ho_so===null || String(row.so_ho_so).toLowerCase()==='null' || String(row.so_ho_so).trim()==='') ? null : String(row.so_ho_so);

      // Yêu cầu:
      // - tt=1 & sohoso=null -> chỉ "In phiếu thu"
      // - tt=1 & sohoso!=null -> "Xem thẻ" + "In phiếu thu"
      // - tt=0 -> chỉ "In phiếu thu" (hồ sơ chờ duyệt chưa kích hoạt)
      const btnIn = `<button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.so_dinh_danh}')">In phiếu thu</button>`;
      const btnXem = `<button class="btn btn-success btn-sm" onclick="xemThe('${row.so_dinh_danh}')">Xem thẻ</button>`;

      if (tt===0) return `<div class="action-btns">${btnIn}</div>`;
      if (tt===1 && !sohoso) return `<div class="action-btns">${btnIn}</div>`;
      if (tt===1 && sohoso) return `<div class="action-btns">${btnXem}${btnIn}</div>`;
      return `<div class="action-btns">${btnIn}</div>`;
    }

    function renderDanhSach(ds){
      if (!ds || ds.length===0){
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Không có hồ sơ BHYT trong lớp này.</div>`;
        return;
      }
      let html = `<table class="table table-bordered table-hs align-middle"><thead>
        <tr>
          <th class="th-status">Trạng thái</th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
        </tr></thead><tbody>`;
      ds.forEach(row=>{
        html += `<tr>
          <td>${statusCell(row)}</td>
          <td>${actionButtons(row)}</td>
          <td>${row.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(row.ngay_sinh||"")}</td>
          <td>${row.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ====== In Phiếu thu (giống trang chưa thu) ====== */
    function pad3(n){ n = parseInt(n,10)||0; return String(n).padStart(3,'0'); }
    function todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }
    function numberToVietnamese(n){
      const VI_DIGITS = ["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
      function readTriple(x){
        let tr=Math.floor(x/100), ch=Math.floor((x%100)/10), dv=x%10, s="";
        if (tr>0){ s += VI_DIGITS[tr]+" trăm"; if (ch==0 && dv>0) s+=" lẻ"; }
        if (ch>1){ s += (s?" ":"")+VI_DIGITS[ch]+" mươi"; if (dv==1) s+=" mốt"; else if (dv==5) s+=" lăm"; else if (dv>0) s+=" "+VI_DIGITS[dv]; }
        else if (ch==1){ s += (s?" ":"")+"mười"; if (dv==5) s+=" lăm"; else if (dv>0) s+=" "+VI_DIGITS[dv]; }
        else if (ch==0 && dv>0){ s += (s?" ":"")+VI_DIGITS[dv]; }
        return s.trim();
      }
      n = Math.round(Number(n)||0);
      if (n===0) return "Không đồng";
      const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0, str="";
      while(n>0 && i<units.length){ const block=n%1000; if (block>0){ const part=readTriple(block); str = part+units[i]+(str?" "+str:""); } n=Math.floor(n/1000); i++; }
      str = str.charAt(0).toUpperCase()+str.slice(1)+" đồng"; return str.replace(/\s+/g," ").trim();
    }
    function stripVN(str){
      return String(str||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');
    }
    function initials(str){ return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase(); }
    function buildQRPayload(schoolCode, school, classCode, name, months, endDate){
      const mt=String(schoolCode||"").slice(0,24), s=stripVN(school).slice(0,60), c=String(classCode||"").slice(0,12), n=stripVN(name).slice(0,60), m=String(months||""), e=String(endDate||"").slice(0,10);
      return `MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`;
    }
    async function getHosoBHYTByHS_local(so_dinh_danh, ma_truong, lop_hoc){
      // dùng api.js (đã có getHosoBHYTByHS) để đảm bảo đồng nhất
      return await getHosoBHYTByHS(so_dinh_danh, ma_truong, lop_hoc);
    }
    async function inPhieuThu(so_dinh_danh){
      try{
        showLoading();
        const row = (lastFiltered||allData).find(r => String(r.so_dinh_danh)===String(so_dinh_danh));
        if (!row){ hideLoading(); return; }

        const hoSo = await getHosoBHYTByHS_local(row.so_dinh_danh, user.ma_truong, row.lop_hoc||user.lop_hoc||"");
        if (!hoSo || !hoSo.success || !hoSo.data){ hideLoading(); showToast("Không tìm thấy hồ sơ BHYT để in."); return; }

        const months = parseInt(hoSo.data.so_thang_dong || row.so_thang_dong || "12",10);
        const amount = parseInt(String(hoSo.data.so_tien||row.so_tien||"0").replace(/[^\d]/g,''),10) || 0;

        const {startText, endText} = calcRangeFromOld(row.ngay_het_han_bhyt_cu || row.ngay_het_han_bhyt || "", months);
        const schoolName = await getTenTruong(user.ma_truong);
        const classCode  = hoSo.data.lop_hoc || row.lop_hoc || user.lop_hoc || "";
        const seq = pad3(row.stt || 1);
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText = schoolName;
        document.getElementById('rec-class').innerText = classCode;
        document.getElementById('rec-date-today').innerText = todayText();
        document.getElementById('rec-student-name').innerText = row.ho_ten_hoc_sinh || "";
        document.getElementById('rec-address').innerText = row.dia_chi || "";
        document.getElementById('rec-content').innerText = `Thu tiền BHYT - ${classCode}${seq}`;
        document.getElementById('rec-months').innerText = String(months);
        document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText = teacherName;

        const qrBox = document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const primaryText = buildQRPayload(user.ma_truong, schoolName, classCode, row.ho_ten_hoc_sinh||"", months, endText);
        try{ new QRCode(qrBox, { text: primaryText, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L }); }
        catch(e){
          const fallbackText = `MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(row.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
          try{ new QRCode(qrBox, { text: fallbackText, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L }); }
          catch(e2){ qrBox.innerHTML = '<small>QR quá dài</small>'; }
        }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(err){
        console.error('[DaThu] inPhieuThu error', err); showToast('Không thể tạo phiếu thu.');
      }finally{ hideLoading(); }
    }

    function getReceiptPrintCSS(){
      return `
      <style>
        @page { size: A5 portrait; margin: 10mm; }
        html,body{ background:#fff; margin:0; padding:0; }
        .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000; margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px; }
        .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
        .receipt-sub{ font-style:italic; } .receipt-meta{ font-size:13px; } .receipt-line{ margin: 2mm 0; }
        .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
        .sign-col{ text-align:center; margin-top:10mm; font-weight:500; } .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
        .row{ display:flex; flex-wrap:nowrap; width:100%; } .col{ flex:1 1 0; } .text-center{ text-align:center; }
      </style>`;
    }
    async function downloadReceiptImage(){
      try{
        const node = document.getElementById('receiptA5');
        const canvas = await html2canvas(node, {scale:2, backgroundColor:'#ffffff'});
        const dataURL = canvas.toDataURL("image/png");
        const canDownload = 'download' in document.createElement('a') && !isIOS();
        if (canDownload){ const a=document.createElement('a'); a.href=dataURL; a.download='phieu-thu-bhyt.png'; document.body.appendChild(a); a.click(); a.remove(); }
        else { const win=window.open(); if (win){ win.document.write(`<html><head><title>Lưu ảnh</title></head><body style="margin:0"><img src="${dataURL}" style="max-width:100%;display:block"/></body></html>`); win.document.close(); } else { window.location.href=dataURL; } }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }
    function printReceiptOnly(){
      const src = document.getElementById('receiptA5');
      if (!src){ console.error('printReceiptOnly: #receiptA5 not found'); return; }
      const head = getReceiptPrintCSS();
      const w = window.open('', '_blank', 'noopener,noreferrer');
      if (!w){ alert('Trình duyệt đang chặn cửa sổ in. Hãy cho phép popup.'); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8">${head}</head><body>${src.outerHTML}</body></html>`);
      w.document.close();
      w.onload = ()=>{ w.focus(); w.print(); setTimeout(()=>w.close(), 200); };
    }

    /* ====== XEM THẺ BHYT ====== */
    async function xemThe(so_dinh_danh){
      try{
        showLoading();
        const row = (lastFiltered||allData).find(r => String(r.so_dinh_danh)===String(so_dinh_danh));
        if (!row){ hideLoading(); return; }

        const months = parseInt(row.so_thang_dong||"12",10);
        const range = calcRangeFromOld(row.ngay_het_han_bhyt_cu || row.ngay_het_han_bhyt || "", months);
        const from = range.startText;
        const to   = range.endText;

        // Fill card
        document.getElementById('c_ma_so').innerText = row.ma_so_bhxh || "—";
        document.getElementById('c_sdd').innerText = row.so_dinh_danh || "—";
        document.getElementById('c_hoten').innerText = row.ho_ten_hoc_sinh || "—";
        document.getElementById('c_ngaysinh').innerText = displayNgaySinh(row.ngay_sinh||"") || "—";
        document.getElementById('c_gioitinh').innerText = row.gioi_tinh || "—";
        document.getElementById('c_lop').innerText = row.lop_hoc || user.lop_hoc || "—";
        document.getElementById('c_noikham').innerText = row.noi_kham_bhyt || "—";
        document.getElementById('c_from').innerText = from;
        document.getElementById('c_thang').innerText = String(months);
        document.getElementById('c_to').innerText = to;
        document.getElementById('c_tien').innerText = (parseInt(String(row.so_tien||"0").replace(/[^\d]/g,''),10)||0).toLocaleString('vi-VN');
        document.getElementById('c_diachi').innerText = row.dia_chi || "—";
        document.getElementById('c_sdt').innerText = row.sdt_lienhe || "—";
        document.getElementById('c_ghichu').innerText = (String(row.ghi_chu||"").toLowerCase()==="null")? "" : (row.ghi_chu||"");

        const tt = Number(row.trang_thai||0);
        const sohoso = (row.so_ho_so===null || String(row.so_ho_so).toLowerCase()==='null' || String(row.so_ho_so).trim()==='')? null : String(row.so_ho_so);
        const statusEl = document.getElementById('c_status');
        if (tt===1 && sohoso){ statusEl.className='val green'; statusEl.innerText='ĐÃ KÍCH HOẠT'; }
        else if (tt===1 && !sohoso){ statusEl.className='val red'; statusEl.innerText='ĐÃ NỘP, CHỜ KÍCH HOẠT'; }
        else { statusEl.className='val red'; statusEl.innerText='CHỜ DUYỆT'; }
        document.getElementById('c_sohoso').innerText = sohoso || '—';

        new bootstrap.Modal(document.getElementById('modalBHYTCard')).show();
      }catch(e){
        console.error('[DaThu] xemThe error', e);
      }finally{ hideLoading(); }
    }

    async function downloadBHYTCard(){
      try{
        const node = document.getElementById('bhytCard');
        const canvas = await html2canvas(node, {scale:2, backgroundColor:'#ffffff'});
        const dataURL = canvas.toDataURL("image/png");
        const a = document.createElement('a'); a.href = dataURL; a.download = 'the-bhyt.png'; document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ alert('Không thể lưu ảnh thẻ: '+(e.message||e)); }
    }

    /* ====== Điều hướng ====== */
    function goBack(){ showLoading(); window.location.href = "bhyt_giaovien.html"; }

    /* ====== Start ====== */
    window.onload = fetchDanhSachDaThu;
  </script>
</body>
</html>
