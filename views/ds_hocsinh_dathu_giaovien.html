<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DS học sinh đã thu - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px}
    .search-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{color:#444}
    th.th-action{min-width:185px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:15px;vertical-align:middle;margin-left:3px}
    .status-badge{font-weight:600}
    .status-pending{color:#dc2626}
    .status-wait-activate{color:#dc2626}
    .status-active{color:#059669}
    .status-sohoso{color:#1d4ed8;font-weight:700;font-size:.92rem}
    .action-btns{display:flex;gap:6px;flex-wrap:wrap}
    .btn-back{position:fixed;right:20px;bottom:26px;z-index:1099;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 14px #0003;font-size:25px;display:flex;justify-content:center;align-items:center;background:#fff;border:2px solid #eee;color:#2563eb}
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;background:#2563eb;color:#fff}
    @media(max-width:600px){.header{font-size:18px}th.th-action{min-width:160px}.action-btns{flex-direction:column}}
    /* A5 for receipt */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;box-shadow:0 1px 10px #0002;color:#000;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}
    /* PRINT ONLY THE RECEIPT INSIDE MODAL */
    @media print{
      @page{size:A5 portrait;margin:10mm}
      body *{visibility:hidden !important}
      #receiptA5, #receiptA5 *{visibility:visible !important}
      #receiptA5{position:absolute;left:0;top:0;box-shadow:none}
      .modal{position:static !important}
    }
    /* --- Card (xem thẻ) --- */
    .card-bhyt{width:980px;max-width:100%;margin:0 auto;background:#fff;border:2px solid #3b82f6;border-radius:10px;box-shadow:0 1px 8px #0002;padding:14px}
    .card-bhyt h3{color:#ef4444;text-align:center;margin:0 0 6px}
    .card-row{display:flex;flex-wrap:wrap;gap:10px;font-size:18px}
    .card-row div{flex:1}
    .card-title{font-weight:700}
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THU LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input id="search-box" class="form-control search-input" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()"/>
    </div>
  </div>

  <div id="ds-container" class="table-responsive"></div>
  <nav><ul id="pagination" class="pagination justify-content-center"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,.5);align-items:center;justify-content:center">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal: xem trước & in phiếu A5 -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col">
              <div class="receipt-meta">
                <div><strong id="rec-school">Trường …</strong></div>
                <div>Lớp: <strong id="rec-class">—</strong></div>
              </div>
            </div>
            <div class="col text-center">
              <div class="receipt-meta">
                <div><strong>Mẫu số:</strong> C45-BB</div>
                <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                <div>ngày 10/10/2017 của Bộ Tài Chính</div>
              </div>
            </div>
          </div>

          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm">
              <div class="qr-box"><div id="receipt-qr"></div></div>
            </div>
            <div class="col text-center">
              <div class="receipt-title">BIÊN LAI THU TIỀN</div>
              <div id="rec-date-today" class="receipt-sub">Ngày … tháng … năm …</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ … đến …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>

          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small>
              <div id="rec-teacher-name" class="sign-name">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Modal: Xem thẻ BHYT -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ BHYT</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh</button>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="the-bhyt" class="card-bhyt">
          <h3>THẺ BẢO HIỂM Y TẾ</h3>
          <div class="card-row">
            <div><span class="card-title">Mã số:</span> <span id="c-ma-so">—</span></div>
            <div><span class="card-title">Số định danh:</span> <span id="c-sdd">—</span></div>
            <div style="flex:0 0 60px"></div>
          </div>
          <hr/>
          <div class="card-row">
            <div><span class="card-title">Họ và tên:</span> <span id="c-hoten">—</span></div>
            <div><span class="card-title">Giới tính:</span> <span id="c-gioitinh">—</span></div>
            <div><span class="card-title">Lớp:</span> <span id="c-lop">—</span></div>
          </div>
          <div class="card-row">
            <div><span class="card-title">Ngày sinh:</span> <span id="c-ngaysinh">—</span></div>
            <div><span class="card-title">Số tháng đóng:</span> <span id="c-thang">—</span></div>
            <div><span class="card-title">Số tiền:</span> <span id="c-tien">—</span></div>
          </div>
          <div class="card-row">
            <div><span class="card-title">Nơi ĐK KCB ban đầu:</span> <span id="c-noikham">—</span></div>
          </div>
          <div class="card-row">
            <div><span class="card-title">Sử dụng từ:</span> <span id="c-start">—</span></div>
            <div><span class="card-title">Ngày hết hạn:</span> <span id="c-end">—</span></div>
          </div>
          <div class="text-center mt-3">
            <span class="badge bg-success" id="c-activated" style="font-size:16px;display:none">ĐÃ KÍCH HOẠT</span>
            <div id="c-sohoso" class="status-sohoso mt-2"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div id="toast-message" class="toast-body">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== Base & state ====== */
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const logPrefix = '[DaThu]';

    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    let pageSize = 20, currentPage = 1, totalRecords = 0, totalPages = 1, sortField = "ho_ten_hoc_sinh", sortDir = 1;
    let allData = [], lastFiltered=[];

    function showLoading(){document.getElementById('loadingSpinner').style.display='flex'}
    function hideLoading(){document.getElementById('loadingSpinner').style.display='none'}
    function showToast(msg){document.getElementById('toast-message').innerText=msg; bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show();}

    function detectPageSize(){
      const w = innerWidth;
      pageSize = w<=600?6 : (w<=999?12:20);
    }
    addEventListener('resize',()=>{ const old=pageSize; detectPageSize(); if(old!==pageSize){ currentPage=1; renderAllView(); } });

    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1 ? '<span class="sort-icon">&#9650;</span>' : '<span class="sort-icon">&#9660;</span>'; }
    function doSort(field){ if(sortField===field) sortDir=-sortDir; else{sortField=field;sortDir=1;} renderAllView(); }

    function displayNgaySinh(raw){
      if(!raw) return "";
      if(/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
      if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
      return raw;
    }

    function safeStr(v){
      const s = String(v ?? '').trim();
      if(!s) return '';
      const low = s.toLowerCase();
      return (low==='null'||low==='undefined'||low==='nan'||low==='0') ? '' : s;
    }
    function hasSoHoSo(row){
      return safeStr(row.so_ho_so || row.sohoso || row['so hồ sơ'] || row['so_ho_so ']);
    }

    /* ====== API ====== */
    async function getDanhSachBHYT(ma_truong, lop){
      const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getHosoBHYTByHS(sdd, ma_truong, lop){
      const url = `${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(sdd)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getTenTruong(ma_truong){
      try{
        const url = `${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;
        const j = await (await fetch(url)).json();
        return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—';
      }catch(_){ return user.ten_truong || ma_truong || '—'; }
    }
    async function getGiaBHYT(){ const j = await (await fetch(`${API_BASE}?func=GetGiaBHYT`)).json(); return j; }
    let _cachedGiaBHYT=null;
    async function ensureGiaBHYT(){ if(_cachedGiaBHYT) return _cachedGiaBHYT; const j=await getGiaBHYT(); _cachedGiaBHYT=j?.data?.[0]||null; return _cachedGiaBHYT; } /* :contentReference[oaicite:3]{index=3} */

    /* ====== Helpers date/money (y như trang gốc) ====== */
    const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s="";
      if(tr>0){s+=VI_DIGITS[tr]+" trăm"; if(ch==0&&dv>0)s+=" lẻ";}
      if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi"; if(dv==1)s+=" mốt"; else if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI_DIGITS[dv];}
      else if(ch==1){s+=(s?" ":"")+"mười"; if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI_DIGITS[dv];}
      else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv];}
      return s.trim();
    }
    function numberToVietnamese(n){
      n=Math.round(Number(n)||0); if(n===0) return "Không đồng";
      const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0,str="";
      while(n>0&&i<units.length){const b=n%1000; if(b>0){const p=readTriple(b); str=p+units[i]+(str?" "+str:"");} n=Math.floor(n/1000); i++; }
      return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();
    }
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3]&&d.getMonth()==+m[2]-1&&d.getDate()==+m[1])?d:null; }
    function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function addDaysExact(dateObj,days){ const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
    function calcRange(oldEndStr,months){ const od=parseVNDate(oldEndStr); const m=parseInt(months,10)||0; if(!od||m<=0) return {startText:"—",endText:"(không xác định)"}; const start=addDaysExact(od,1); const end=new Date(start.getFullYear(),start.getMonth()+m,0); return {startText:formatVNDate(start),endText:formatVNDate(end)}; } /* :contentReference[oaicite:4]{index=4} */

    /* ====== Fetch list (sheet DanhSach_BHYT) ====== */
    async function fetchDaThuList(){
      try{
        detectPageSize(); showLoading();
        const res = await getDanhSachBHYT(user.ma_truong, user.lop_hoc);
        const rows = Array.isArray(res?.data) ? res.data : [];
        // chỉ lấy các hồ sơ đã tham gia (0 hoặc 1), ưu tiên hiển thị 1 trước
        allData = rows
          .filter(r => String(r.trang_thai)==="0" || String(r.trang_thai)==="1")
          .map(r => ({ ...r, trang_thai: Number(r.trang_thai||0), so_ho_so: safeStr(r.so_ho_so) }))
          .sort((a,b)=> (b.trang_thai - a.trang_thai) || String(a.ho_ten_hoc_sinh||"").localeCompare(String(b.ho_ten_hoc_sinh||"")));
        currentPage = 1;
        doSearch();
      }catch(e){ console.error(logPrefix,'fetchDaThuList',e); }
      finally{ hideLoading(); }
    }

    /* ====== Search / render / paginate (giống trang gốc) ====== */
    function doSearch(){
      const q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q ? allData : allData.filter(hs =>
        String(hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q) ||
        String(displayNgaySinh(hs.ngay_sinh)||"").toLowerCase().includes(q) ||
        String(hs.so_dinh_danh||"").toLowerCase().includes(q)
      );
      currentPage = 1; renderAllView();
    }
    function gotoPage(p){ if(p<1||p>totalPages||p===currentPage) return; currentPage=p; renderAllView(); }
    function renderPagination(){
      const el = document.getElementById('pagination'); el.innerHTML='';
      if(totalPages<=1) return;
      el.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
      if(minP>1) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if(minP>2) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for(let p=minP;p<=maxP;p++){ el.innerHTML += `<li class="page-item ${p===currentPage?'active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`; }
      if(maxP<totalPages-1) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if(maxP<totalPages) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    function renderAllView(){
      let data = lastFiltered||[];
      if(sortField){
        data = [...data].sort((a,b)=>{
          let av=String(a[sortField]||"").toLowerCase(), bv=String(b[sortField]||"").toLowerCase();
          if(!isNaN(av)&&!isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if(av<bv) return -sortDir; if(av>bv) return sortDir; return 0;
        });
      }
      totalRecords = data.length; totalPages = Math.max(1,Math.ceil(totalRecords/pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
      const start=(currentPage-1)*pageSize;
      renderTable(data.slice(start,start+pageSize));
      renderPagination();
    }

    function renderStatusCell(row){
      if(row.trang_thai===0) return `<div class="status-badge status-pending">Chờ duyệt</div>`;
      if(row.trang_thai===1){
        const sohoso = hasSoHoSo(row);
        if(sohoso){
          return `<div class="status-badge status-active">Đã kích hoạt</div><div class="status-sohoso">${sohoso}</div>`;
        }
        return `<div class="status-badge status-wait-activate">Đã nộp, chờ kích hoạt</div>`;
      }
      return '';
    }
    function renderActionCell(row){
      const sohoso = hasSoHoSo(row);
      if(row.trang_thai===1 && !sohoso){
        // chỉ in phiếu thu
        return `<div class="action-btns">
                  <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button>
                </div>`;
      }
      if(row.trang_thai===1 && sohoso){
        return `<div class="action-btns">
                  <button class="btn btn-success btn-sm" onclick="xemThe('${row.stt}')">Xem thẻ</button>
                  <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button>
                </div>`;
      }
      // trang_thai = 0
      return `<div class="action-btns">
                <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button>
              </div>`;
    }

    function renderTable(ds){
      if(!ds || ds.length===0){
        document.getElementById('ds-container').innerHTML = `<div class="text-center text-secondary mt-4">Không có dữ liệu.</div>`;
        return;
      }
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
        <th style="width:42px;"></th>
        <th class="sortable" onclick="doSort('trang_thai')">Trạng thái ${sortIcon('trang_thai')}</th>
        <th class="th-action">Thao tác</th>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh ${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh ${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân ${sortIcon('so_dinh_danh')}</th>
      </tr></thead><tbody>`;
      ds.forEach(r=>{
        html += `<tr>
          <td></td>
          <td>${renderStatusCell(r)}</td>
          <td>${renderActionCell(r)}</td>
          <td>${r.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(r.ngay_sinh)}</td>
          <td>${r.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ====== In phiếu thu (dựa sát trang gốc) ====== */
    function pad3(n){return String(parseInt(n||0,10)).padStart(3,'0')}
    function todayText(){const d=new Date();return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`;}
    function stripVN(str){return String(str||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D')}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase()}
    function buildQRPayload(schoolCode, school, classCode, name, months, endDate){
      const mt=String(schoolCode||"").slice(0,24), s=stripVN(school).slice(0,60), c=String(classCode||"").slice(0,12), n=stripVN(name).slice(0,60), m=String(months||""), e=String(endDate||"").slice(0,10);
      return `MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`;
    } /* :contentReference[oaicite:5]{index=5} */

    async function inPhieuThu(stt){
      try{
        showLoading();
        const hs = (lastFiltered||allData).find(h => String(h.stt)===String(stt));
        if(!hs){ hideLoading(); return; }

        // lấy hồ sơ chi tiết
        const hoSo = await getHosoBHYTByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
        if(!hoSo || !hoSo.success || !hoSo.data){
          hideLoading(); showToast("Không tìm thấy hồ sơ BHYT để in."); return;
        }

        const months = parseInt(hoSo.data.so_thang_dong || hs.so_thang_dong || "12", 10);
        // số tiền: ưu tiên API, fallback giá * tháng (để hết lỗi 1)
        let amount = parseInt(String(hoSo.data.so_tien ?? hs.so_tien ?? "0").replace(/[^\d]/g,''),10) || 0;
        if(!amount){
          const gia = await ensureGiaBHYT(); amount = (parseInt(gia?.gia_tien||0,10) || 0) * (months||0);
        } /* nguyên lý đọc giá từ ensureGiaBHYT của trang gốc */ /* :contentReference[oaicite:6]{index=6} */

        const {startText, endText} = calcRange(hs.ngay_het_han_bhyt_cu || hoSo.data.ngay_het_han_bhyt_cu || "", months);
        const schoolName = await getTenTruong(user.ma_truong);
        const classCode  = hoSo.data.lop_hoc || hs.lop_hoc || user.lop_hoc || "";
        const seq = pad3(hs.stt);
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText = schoolName;
        document.getElementById('rec-class').innerText = classCode;
        document.getElementById('rec-date-today').innerText = todayText();
        document.getElementById('rec-student-name').innerText = hs.ho_ten_hoc_sinh || "";
        document.getElementById('rec-address').innerText = hs.dia_chi || "";
        document.getElementById('rec-content').innerText = `Thu tiền BHYT - ${classCode}${seq}`;
        document.getElementById('rec-months').innerText = String(months);
        document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText = teacherName;

        const qrBox = document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const text = buildQRPayload(user.ma_truong, schoolName, classCode, hs.ho_ten_hoc_sinh||"", months, endText);
        try{
          new QRCode(qrBox,{text,width:90,height:90,correctLevel:QRCode.CorrectLevel.L});
        }catch(e){
          new QRCode(qrBox,{text:`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hs.ho_ten_hoc_sinh)};M=${months};E=${endText}`,width:90,height:90,correctLevel:QRCode.CorrectLevel.L});
        }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(e){ console.error(logPrefix,'inPhieuThu',e); showToast('Không thể tạo phiếu thu.'); }
      finally{ hideLoading(); }
    }

    // In ngay trong modal (không mở tab): clone QR -> IMG rồi window.print
    function printReceiptOnly(){
      const src = document.getElementById('receiptA5'); if(!src) return;
      const qr = src.querySelector('#receipt-qr');
      const canvas = qr?.querySelector('canvas'); const img0 = qr?.querySelector('img');
      if(qr && (canvas || img0)){
        try{
          const dataURL = img0 ? img0.src : canvas.toDataURL('image/png');
          qr.innerHTML=''; const img=document.createElement('img'); img.src=dataURL; img.width=90; img.height=90; qr.appendChild(img);
        }catch(_){}
      }
      setTimeout(()=>{ window.print(); }, 150); /* giữ giống “đợi ảnh sẵn sàng” của bản gốc mở tab. :contentReference[oaicite:7]{index=7} */
    }

    async function downloadReceiptImage(){
      try{
        const node=document.getElementById('receiptA5');
        const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
        const url=canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=url; a.download='phieu-thu-bhyt.png';
        if('download' in a && !isIOS()){ document.body.appendChild(a); a.click(); a.remove(); }
        else{ const w=window.open(); if(w){ w.document.write(`<img src="${url}" style="max-width:100%"/>`); w.document.close(); } else { window.location.href=url; } }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }

    /* ====== Xem thẻ ====== */
    async function xemThe(stt){
      try{
        showLoading();
        const hs = (lastFiltered||allData).find(h=>String(h.stt)===String(stt));
        if(!hs) return;

        const hoSo = await getHosoBHYTByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
        const months = parseInt(hoSo?.data?.so_thang_dong || hs.so_thang_dong || "12", 10);
        const sohoso = hasSoHoSo(hs) || hasSoHoSo(hoSo?.data||{});
        let amount = parseInt(String(hoSo?.data?.so_tien ?? hs.so_tien ?? "0").replace(/[^\d]/g,''),10) || 0;
        if(!amount){ const gia=await ensureGiaBHYT(); amount=(parseInt(gia?.gia_tien||0,10)||0)*months; } /* :contentReference[oaicite:8]{index=8} */

        const {startText, endText} = calcRange(hs.ngay_het_han_bhyt_cu || hoSo?.data?.ngay_het_han_bhyt_cu || "", months);

        // fill card
        document.getElementById('c-ma-so').innerText = hs.ma_so_bhxh || "—";
        document.getElementById('c-sdd').innerText = hs.so_dinh_danh || "—";
        document.getElementById('c-hoten').innerText = hs.ho_ten_hoc_sinh || "—";
        document.getElementById('c-gioitinh').innerText = hs.gioi_tinh || "—";
        document.getElementById('c-lop').innerText = hs.lop_hoc || user.lop_hoc || "—";
        document.getElementById('c-ngaysinh').innerText = displayNgaySinh(hs.ngay_sinh) || "—";
        document.getElementById('c-thang').innerText = String(months);
        document.getElementById('c-tien').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('c-noikham').innerText = hoSo?.data?.noi_kham || hs.noi_kham_bhyt || "—";
        document.getElementById('c-start').innerText = startText;
        document.getElementById('c-end').innerText   = hoSo?.data?.han_su_dung_bhyt_moi || hs.han_su_dung_bhyt_moi || endText;
        document.getElementById('c-sohoso').innerText = sohoso || "";
        document.getElementById('c-activated').style.display = sohoso ? '' : 'none';

        new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
      }catch(e){ console.error(logPrefix,'xemThe',e); showToast('Không xem được thẻ.'); }
      finally{ hideLoading(); }
    }
    async function saveCardImage(){
      try{
        const node = document.getElementById('the-bhyt');
        const canvas = await html2canvas(node,{scale:2,backgroundColor:'#fff'});
        const url = canvas.toDataURL('image/png');
        const a=document.createElement('a'); a.href=url; a.download='the-bhyt.png';
        if('download' in a && !isIOS()){ document.body.appendChild(a); a.click(); a.remove(); }
        else{ const w=window.open(); if(w){ w.document.write(`<img src="${url}" style="max-width:100%"/>`); w.document.close(); } else { window.location.href=url; } }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }

    function goBack(){ showLoading(); location.href='bhyt_giaovien.html'; }

    window.onload = fetchDaThuList;
    window.doSort = doSort;
  </script>
</body>
</html>
