<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã tham gia - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .sticky-header-box { position: sticky; top: 0; z-index: 999; background: #f8f9fa; padding-bottom: 2px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 8px; padding-bottom: 6px; background: #f8f9fa; }
    .search-row { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; gap: 10px; position: sticky; top: 52px; z-index: 998; background: #f8f9fa; padding-bottom: 4px; }
    .search-input { flex: 1; min-width: 180px;}
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002; }
    .table-responsive { overflow-x: auto; }
    .total-count { font-size: 1rem; font-weight: 400; color: #444;}
    th.th-action { min-width: 190px; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: #f1f1f1; }

    /* Nút back nổi */
    .btn-back { position: fixed; bottom: 26px; right: 20px; z-index: 1099; border-radius: 50%; width: 54px; height: 54px; box-shadow: 0 2px 14px #0003; font-size: 25px; display: flex; align-items: center; justify-content: center; background: #fff; border: 2px solid #eee; color: #2563eb; transition: box-shadow 0.12s; }
    .btn-back:hover { box-shadow: 0 4px 24px #2563eb33; color: #fff; background: #2563eb; }

    @media (max-width: 600px) {
      .header { font-size: 18px; }
      th.th-action { min-width: 140px; }
      .search-row { flex-direction: column; align-items: stretch; }
      .action-btns { display: flex; flex-direction: column; gap: 6px; }
      .action-btns .btn { width: 100%; }
    }
    @media (min-width: 601px) { .action-btns { display: flex; flex-direction: row; gap: 4px; } }

    /* ==== Receipt A5 & print only receipt ==== */
    .a5-paper { width: 148mm; min-height: 210mm; background: #fff; margin: 0 auto; padding: 10mm 12mm; box-shadow: 0 1px 6px #0002; }
    .receipt-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:6px; }
    .receipt-title { font-size:18px; font-weight:700; }
    .receipt-meta { font-size:13px; color:#555; }
    .line { border-top:1px dashed #777; margin:8px 0; }
    .receipt-row { display:flex; gap:8px; margin:2px 0; }
    .receipt-row .label { width:160px; color:#333; }
    .receipt-row .value { flex:1; font-weight:600; }
    .text-small { font-size: 12px; }

    /* Print mode: chỉ in khu vực phiếu thu */
    @media print {
      body * { visibility: hidden; }
      #receipt-print-area, #receipt-print-area * { visibility: visible; }
      #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }

    /* Modal xem thẻ */
    .card-bhyt { width: 320px; aspect-ratio: 1.586/1; background: linear-gradient(135deg,#e6f3ff,#ffffff); border: 1px solid #bcd6ff; border-radius: 10px; padding: 14px; box-shadow: 0 2px 10px #0001; margin: 0 auto; }
    .card-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .card-head .org { font-weight:700; font-size:14px; color:#0b56c4; }
    .card-body { font-size:13px; line-height:1.25; color:#123; }
    .card-body .row { display:flex; gap:6px; }
    .card-body .row .label { width:110px; color:#333; }
    .card-body .row .value { flex:1; font-weight:600; }
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">DS học sinh đã tham gia - LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, số định danh, ngày sinh...">
      <div class="text-secondary">Nhấp tiêu đề cột để sắp xếp</div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background:#0003; z-index:1100; display:none;">
    <div class="spinner-border text-light" role="status"></div>
  </div>

  <div class="table-responsive" id="ds-container"></div>

  <a class="btn btn-light btn-back" href="./bhyt_giaovien.html" title="Quay lại">
    ⟵
  </a>

  <!-- Modal Phiếu thu & print area -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Phiếu thu BHYT (A5)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="receipt-print-area">
            <div class="a5-paper" id="receiptA5">
              <div class="receipt-header">
                <div>
                  <div class="receipt-title">PHIẾU THU BẢO HIỂM Y TẾ</div>
                  <div class="receipt-meta">Trường: <span id="r-school"></span></div>
                </div>
                <div class="text-end">
                  <div class="receipt-meta">Ngày: <span id="r-date"></span></div>
                  <div class="receipt-meta">Số: <span id="r-number"></span></div>
                </div>
              </div>
              <div class="line"></div>
              <div class="receipt-row"><div class="label">Họ tên học sinh</div><div class="value" id="r-hoten"></div></div>
              <div class="receipt-row"><div class="label">Ngày sinh</div><div class="value" id="r-ngaysinh"></div></div>
              <div class="receipt-row"><div class="label">Số định danh</div><div class="value" id="r-sdd"></div></div>
              <div class="receipt-row"><div class="label">Lớp</div><div class="value" id="r-lop"></div></div>
              <div class="receipt-row"><div class="label">Địa chỉ</div><div class="value" id="r-diachi"></div></div>
              <div class="receipt-row"><div class="label">Nơi KCB ban đầu</div><div class="value" id="r-noikham"></div></div>
              <div class="receipt-row"><div class="label">Số tháng đóng</div><div class="value" id="r-thang"></div></div>
              <div class="receipt-row"><div class="label">Hạn sử dụng mới</div><div class="value" id="r-exp"></div></div>
              <div class="line"></div>
              <div class="receipt-row"><div class="label">Thành tiền</div><div class="value" id="r-amount"></div></div>
              <div class="text-small text-secondary mt-2" id="r-note"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="printReceiptInModal()">In phiếu</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Xem thẻ BHYT -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div id="card-wrapper" class="card-bhyt">
            <div class="card-head">
              <div class="org">BẢO HIỂM XÃ HỘI VIỆT NAM</div>
              <img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Emblem_of_Vietnam.svg" style="height:22px"/>
            </div>
            <div class="card-body text-start">
              <div class="row"><div class="label">Họ tên</div><div class="value" id="c-hoten"></div></div>
              <div class="row"><div class="label">Ngày sinh</div><div class="value" id="c-ngaysinh"></div></div>
              <div class="row"><div class="label">Số định danh</div><div class="value" id="c-sdd"></div></div>
              <div class="row"><div class="label">Số hồ sơ</div><div class="value" id="c-sohoso"></div></div>
              <div class="row"><div class="label">Nơi KCB</div><div class="value" id="c-noikham"></div></div>
              <div class="row"><div class="label">HSD đến</div><div class="value" id="c-exp"></div></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-primary" onclick="downloadCardImage()">Tải ảnh thẻ</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <iframe id="print-iframe" style="display:none"></iframe>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    const logPrefix = '[dathuGV]';
    const API_BASE = window.API_BASE || 'https://script.google.com/macros/s/AKfycbwfsTcpgpduAP6bsQnDu1vsUTzMrtYNRMyZLsqKDJu-5j910xP69GXmdS1OaOAdKbNJ/exec';

    // ====== Utils ngày & tiền ======
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3]&&d.getMonth()==+m[2]-1&&d.getDate()==+m[1])?d:null; }
    function formatVNDate(d){ if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function addDaysExact(dateObj, days){ const d=new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function displayNgaySinh(s){ const d=parseVNDate(s)||null; return d?formatVNDate(d):String(s||''); }
    function formatMoney(n){ const x=parseInt(n||0,10)||0; return x.toLocaleString('vi-VN'); }
    function validText(v){ return v!==undefined && v!==null && String(v).trim()!=='' && String(v).toLowerCase()!=='null' && String(v).toLowerCase()!=='undefined'; }

    // ====== Cache giá BHYT ======
    let _cachedGiaBHYT = null;
    async function getGiaBHYT(){ const url = `${API_BASE}?func=GetGiaBHYT`; const res = await fetch(url); return await res.json(); }
    async function ensureGiaBHYT(){
      if(_cachedGiaBHYT) return _cachedGiaBHYT;
      const giaRes = await getGiaBHYT();
      _cachedGiaBHYT = giaRes?.data?.[0] || null;
      console.log(logPrefix, 'ensureGiaBHYT', _cachedGiaBHYT);
      return _cachedGiaBHYT;
    }
    function computeAmountAndExp(oldEndStr, months, basePrice){
      const oldEnd = parseVNDate(oldEndStr);
      const m = parseInt(months,10)||0; let exp='—', note='';
      if (oldEnd && m>0){ const start=addDaysExact(oldEnd,1); const last=new Date(start.getFullYear(), start.getMonth()+m, 0); exp = formatVNDate(last); }
      else { exp='(không xác định)'; note='Không xác định do thiếu "ngày hết hạn thẻ cũ" trong DanhSach_Hocsinh.'; }
      const amount = (parseInt(basePrice||0,10)||0) * m; return {exp, amount, note};
    }

    // ====== API lấy dữ liệu ======
    async function getAllDanhSachHocsinh(ma_truong, lop_hoc){
      const url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getDanhSachBHYT(ma_truong, lop_hoc){
      const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getHosoBHYTByHS(so_dinh_danh, ma_truong, lop_hoc){
      const url = `${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`;
      const res = await fetch(url); return await res.json();
    }

    // ====== State ======
    let currentUser = null; // {sdt, ho_ten, phan_quyen, ma_truong, lop_hoc, ten_truong}
    let allData = [];       // danh sách học sinh (đã join trạng thái & hồ sơ)
    let lastFiltered = null;
    let sortField = 'ho_ten_hoc_sinh';
    let sortDir = 1; // 1: asc, -1: desc

    function showLoading(){ document.getElementById('loading').style.display='flex'; }
    function hideLoading(){ document.getElementById('loading').style.display='none'; }

    function loadUser(){
      const userStr = localStorage.getItem('user');
      try { currentUser = JSON.parse(userStr||'{}'); } catch(_) { currentUser=null; }
      if(!currentUser || !currentUser.ma_truong || !currentUser.lop_hoc){
        alert('Không tìm thấy thông tin lớp. Vui lòng đăng nhập lại.');
        location.href = './index.html';
        return false;
      }
      document.getElementById('lop-hoc').innerText = currentUser.lop_hoc;
      console.log(logPrefix, 'user', currentUser);
      return true;
    }

    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1 ? ' ▲' : ' ▼'; }

    function applyFilter(){
      const q = (document.getElementById('search-box').value||'').trim().toLowerCase();
      let ds = [...allData];
      if(q){ ds = ds.filter(h => [h.ho_ten_hoc_sinh, h.so_dinh_danh, displayNgaySinh(h.ngay_sinh)].some(v => String(v||'').toLowerCase().includes(q))); }
      // Chỉ hiển thị các bản ghi thuộc DanhSach_BHYT trả về (đã có _bhyt_trangthai gắn vào)
      lastFiltered = ds.filter(h => h._hasBHYT === true);
      renderTable(lastFiltered);
    }

    function doSort(field){
      if (sortField === field) sortDir *= -1; else { sortField = field; sortDir = 1; }
      const arr = (lastFiltered || allData).slice();
      arr.sort((a,b)=>{ const va=String(a[field]||'').toLowerCase(); const vb=String(b[field]||'').toLowerCase(); if(va<vb) return -1*sortDir; if(va>vb) return 1*sortDir; return 0; });
      lastFiltered = arr; renderTable(arr);
    }

    function buildTrangThaiCell(h){
      const st = parseInt(h._bhyt_trangthai,10);
      const sohoso = h._hoso && validText(h._hoso.so_ho_so) ? String(h._hoso.so_ho_so) : '';
      if (st===0) return `<span class='text-danger'>Chờ duyệt</span>`;
      if (st===1 && !sohoso) return `<span class='text-danger'>Đã nộp, chờ kích hoạt</span>`;
      if (st===1 && sohoso) return `<div class='text-success fw-bold'>Đã kích hoạt</div><div class='text-primary small'>Số hồ sơ: ${sohoso}</div>`;
      return '';
    }

    function buildActionBtns(h){
      const st = parseInt(h._bhyt_trangthai,10);
      const hasSoHoSo = !!(h._hoso && validText(h._hoso.so_ho_so));
      if (st===1 && hasSoHoSo) {
        return `<div class="action-btns">
          <button class="btn btn-info btn-sm" onclick="xemThe('${h.stt}')">Xem thẻ</button>
          <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${h.stt}')">In phiếu thu</button>
        </div>`;
      }
      if (st===1 && !hasSoHoSo) {
        return `<div class="action-btns">
          <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${h.stt}')">In phiếu thu</button>
        </div>`;
      }
      // trang_thai = 0 -> chỉ hiển thị thông tin, không thao tác
      return `<div class="text-muted small">—</div>`;
    }

    function renderTable(ds){
      if(!ds || ds.length===0){ document.getElementById('total-hs').innerText='(0)'; document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Không có dữ liệu.</div>`; return; }
      document.getElementById('total-hs').innerText = `(${ds.length})`;
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
        <th style="width:42px;"><input type="checkbox" disabled></th>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
        <th class="sortable" onclick="doSort('_bhyt_trangthai')">Trạng thái${sortIcon('_bhyt_trangthai')}</th>
        <th class="th-action">Thao tác</th>
      </tr></thead><tbody>`;

      ds.forEach(hs => {
        html += `<tr>
          <td></td>
          <td>${hs.ho_ten_hoc_sinh || ''}</td>
          <td>${displayNgaySinh(hs.ngay_sinh || '')}</td>
          <td>${hs.so_dinh_danh || ''}</td>
          <td>${buildTrangThaiCell(hs)}</td>
          <td>${buildActionBtns(hs)}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    async function hydrateHosoForJoined(list){
      const tasks = list.map(async (h) => {
        if (parseInt(h._bhyt_trangthai,10)!==1) { h._hoso = null; return h; }
        try {
          const res = await getHosoBHYTByHS(h.so_dinh_danh, currentUser.ma_truong, h.lop_hoc||currentUser.lop_hoc);
          if (res && res.success && Array.isArray(res.data) && res.data.length>0) {
            h._hoso = res.data[0];
          } else if (res && res.data && !Array.isArray(res.data)) {
            h._hoso = res.data; // phòng trường hợp trả về object đơn
          } else {
            h._hoso = null;
          }
          console.log(logPrefix, 'hoso', h.so_dinh_danh, h._hoso);
        } catch (e) {
          console.error(logPrefix, 'getHosoBHYTByHS error', h.so_dinh_danh, e);
          h._hoso = null;
        }
        return h;
      });
      return Promise.all(tasks);
    }

    async function loadData(){
      if(!loadUser()) return;
      showLoading();
      try{
        // 1) Lấy full danh sách HS để có địa chỉ, lớp, hạn cũ...
        const hsRes = await getAllDanhSachHocsinh(currentUser.ma_truong, currentUser.lop_hoc);
        console.log(logPrefix, 'GetAllDanhSachHocsinh', hsRes);
        const hsList = (hsRes && hsRes.success && Array.isArray(hsRes.data)) ? hsRes.data : [];

        // 2) Lấy danh sách BHYT (chỉ có sdd, tên, ns, trạng_thai)
        const bhytRes = await getDanhSachBHYT(currentUser.ma_truong, currentUser.lop_hoc);
        console.log(logPrefix, 'GetDanhSachBHYT', bhytRes);
        const bhyt = (bhytRes && bhytRes.success && Array.isArray(bhytRes.data)) ? bhytRes.data : [];

        // 3) Join theo so_dinh_danh
        const bhytMap = new Map(bhyt.map(x => [String(x.so_dinh_danh), x]));
        const joined = hsList.map(h => {
          const b = bhytMap.get(String(h.so_dinh_danh));
          if (!b) return h; // HS chưa có dòng trong DanhSach_BHYT
          return {
            ...h,
            _hasBHYT: true,
            _bhyt_trangthai: parseInt(b.trang_thai,10) || 0,
          };
        }).filter(x => x._hasBHYT===true);

        console.log(logPrefix, 'joined size', joined.length);

        // 4) Bổ sung hồ sơ cho các dòng trạng_thai=1
        const hydrated = await hydrateHosoForJoined(joined);
        allData = hydrated;
        lastFiltered = null;
        applyFilter();
      }catch(err){
        console.error(logPrefix, 'loadData error', err);
        document.getElementById('ds-container').innerHTML = `<div class='alert alert-danger'>Không tải được dữ liệu. Chi tiết xem Console.</div>`;
      }finally{ hideLoading(); }
    }

    // ====== In phiếu thu (in thẳng trong modal, chỉ in phiếu) ======
    function fillReceipt(h){
      const gia = _cachedGiaBHYT; // đã ensure khi cần
      let months = 12, amount = 0, exp='—', note='';
      if (h._hoso && (h._hoso.so_thang_dong || h._hoso.so_thang)) months = parseInt(h._hoso.so_thang_dong||h._hoso.so_thang,10)||12;
      const price = gia ? parseInt(gia.gia_tien,10) : 0;
      const calc = computeAmountAndExp(h.ngay_het_han_bhyt, months, price);
      exp = calc.exp; amount = calc.amount; note = calc.note;
      if (h._hoso && validText(h._hoso.so_tien)) amount = parseInt(h._hoso.so_tien,10)||amount;

      document.getElementById('r-school').innerText = currentUser.ten_truong || currentUser.ma_truong || '';
      document.getElementById('r-date').innerText = formatVNDate(new Date());
      document.getElementById('r-number').innerText = (h._hoso && validText(h._hoso.so_ho_so)) ? String(h._hoso.so_ho_so) : '—';
      document.getElementById('r-hoten').innerText = h.ho_ten_hoc_sinh || '';
      document.getElementById('r-ngaysinh').innerText = displayNgaySinh(h.ngay_sinh||'');
      document.getElementById('r-sdd').innerText = h.so_dinh_danh || '';
      document.getElementById('r-lop').innerText = h.lop_hoc || currentUser.lop_hoc || '';
      document.getElementById('r-diachi').innerText = h.dia_chi || '';
      document.getElementById('r-noikham').innerText = (h._hoso && h._hoso.noi_kham_bhyt) ? h._hoso.noi_kham_bhyt : (h.noi_kham_bhyt||'');
      document.getElementById('r-thang').innerText = months;
      document.getElementById('r-exp').innerText = exp;
      document.getElementById('r-amount').innerText = formatMoney(amount) + ' đ';
      document.getElementById('r-note').innerText = note || '';
    }

    async function inPhieuThu(stt){
      try{
        showLoading();
        const target = (lastFiltered||allData).find(h=>String(h.stt)===String(stt));
        if(!target){ alert('Không tìm thấy học sinh.'); return; }
        // đảm bảo đã có giá
        await ensureGiaBHYT();
        // đảm bảo đã có hồ sơ cho HS này (đặc biệt khi \"đã nộp, chờ kích hoạt\")
        if (!target._hoso && parseInt(target._bhyt_trangthai,10)===1){
          const res = await getHosoBHYTByHS(target.so_dinh_danh, currentUser.ma_truong, target.lop_hoc||currentUser.lop_hoc);
          if (res && res.success) target._hoso = Array.isArray(res.data)? (res.data[0]||null) : res.data;
        }
        fillReceipt(target);
        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(err){
        console.error(logPrefix, 'inPhieuThu', err);
        alert('Không tìm thấy hồ sơ BHYT để in.');
      }finally{ hideLoading(); }
    }

    function printReceiptInModal(){
      // In trực tiếp vùng #receipt-print-area bằng iframe ẩn (không mở tab mới)
      const iframe = document.getElementById('print-iframe');
      const doc = iframe.contentWindow.document;
      const css = `<!DOCTYPE html><html><head><meta charset='utf-8'>
        <style> @page{ size:A5 portrait; margin:10mm 12mm; } body{ -webkit-print-color-adjust: exact; }
        .a5-paper{ width:148mm; min-height:210mm; }
        </style></head><body></body></html>`;
      doc.open(); doc.write(css); doc.close();
      const clone = document.getElementById('receipt-print-area').cloneNode(true);
      doc.body.appendChild(clone);
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    }

    // ====== Xem thẻ ======
    function xemThe(stt){
      const h = (lastFiltered||allData).find(x=>String(x.stt)===String(stt));
      if(!h) return;
      const sohoso = h._hoso && validText(h._hoso.so_ho_so) ? String(h._hoso.so_ho_so) : '';
      document.getElementById('c-hoten').innerText = h.ho_ten_hoc_sinh || '';
      document.getElementById('c-ngaysinh').innerText = displayNgaySinh(h.ngay_sinh||'');
      document.getElementById('c-sdd').innerText = h.so_dinh_danh || '';
      document.getElementById('c-sohoso').innerText = sohoso || '—';
      document.getElementById('c-noikham').innerText = (h._hoso && h._hoso.noi_kham_bhyt) ? h._hoso.noi_kham_bhyt : (h.noi_kham_bhyt||'');
      document.getElementById('c-exp').innerText = (h._hoso && (h._hoso.han_su_dung_bhyt_moi||h._hoso.han_moi)) ? (h._hoso.han_su_dung_bhyt_moi||h._hoso.han_moi) : '—';
      new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
    }

    async function downloadCardImage(){
      const el = document.getElementById('card-wrapper');
      const canvas = await html2canvas(el, {scale:2});
      const link = document.createElement('a');
      link.download = 'the-bhyt.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // ====== Khởi chạy ======
    window.addEventListener('DOMContentLoaded', async ()=>{
      if(!loadUser()) return;
      // Hiệu ứng: search realtime
      document.getElementById('search-box').addEventListener('input', ()=>applyFilter());
      await ensureGiaBHYT();
      await loadData();
    });
  </script>
</body>
</html>
