<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DS học sinh đã tham gia - Giáo viên</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{background:#f8f9fa;min-height:100vh;padding:20px}
  .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
  .header{font-size:22px;font-weight:700;margin-bottom:8px;padding-bottom:6px}
  .search-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
  .search-input{flex:1;min-width:180px}
  .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
  .table-responsive{overflow-x:auto}
  .total-count{color:#444}
  th.sortable{cursor:pointer;user-select:none}
  th.sortable:hover{background:#f1f1f1}
  .sort-icon{font-size:15px;vertical-align:middle;margin-left:3px}
  th.th-action{min-width:190px}
  th.th-status{min-width:160px}
  .action-btns{display:flex;gap:6px;flex-wrap:wrap}
  .status-badge{display:inline-block;font-weight:700}
  .status-wait{color:#dc2626}
  .status-pending{color:#dc2626}
  .status-done{color:#16a34a}
  .status-code{color:#1d4ed8;font-weight:700;font-size:14px}
  .btn-back{position:fixed;bottom:26px;right:20px;z-index:1099;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 14px #0003;font-size:25px;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid #eee;color:#2563eb}
  .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}
  /* A5 receipt */
  .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
  .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
  .receipt-sub{font-style:italic}
  .receipt-meta{font-size:13px}
  .receipt-line{margin:2mm 0}
  .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
  .sign-col{text-align:center;margin-top:10mm;font-weight:500}
  .sign-name{margin-top:20mm;text-align:center;font-weight:600}
  /* In chỉ nội dung phiếu trong modal */
  @media print{
    @page{size:A5 portrait;margin:10mm}
    body *{visibility:hidden !important}
    #receiptA5, #receiptA5 *{visibility:visible !important}
    #receiptA5{position:absolute;left:0;top:0;box-shadow:none}
    .modal{position:static !important}
  }
</style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA LỚP <span id="lop-hoc"></span>
      <span id="total-hs" class="total-count"></span>
    </div>
    <div class="search-row">
      <input id="search-box" class="form-control search-input" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()"/>
    </div>
  </div>

  <div id="ds-container" class="table-responsive"></div>
  <nav><ul id="pagination" class="pagination justify-content-center"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading overlay -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal phiếu thu -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col"><div class="receipt-meta">
              <div><strong id="rec-school">Trường …</strong></div>
              <div>Lớp: <strong id="rec-class">—</strong></div>
            </div></div>
            <div class="col text-center"><div class="receipt-meta">
              <div><strong>Mẫu số:</strong> C45-BB</div>
              <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
              <div>ngày 10/10/2017 của Bộ Tài Chính</div>
            </div></div>
          </div>
          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center">
              <div class="receipt-title">BIÊN LAI THU TIỀN</div>
              <div id="rec-date-today" class="receipt-sub">Ngày … tháng … năm …</div>
            </div>
          </div>
          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>
          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div id="rec-teacher-name" class="sign-name">—</div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xem thẻ -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
        <div class="d-flex gap-2"><button class="btn btn-outline-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh</button></div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="theBHYT" class="p-3 border rounded bg-white">
          <h5 class="text-danger text-center fw-bold">THẺ BẢO HIỂM Y TẾ</h5>
          <div class="row g-2">
            <div class="col-sm-6"><strong>Mã số:</strong> <span id="c_ma_so">—</span></div>
            <div class="col-sm-6"><strong>Số định danh:</strong> <span id="c_sdd">—</span></div>
            <div class="col-sm-12"><strong>Họ và tên:</strong> <span id="c_hoten">—</span></div>
            <div class="col-sm-6"><strong>Ngày sinh:</strong> <span id="c_ngaysinh">—</span></div>
            <div class="col-sm-6"><strong>Giới tính:</strong> <span id="c_gioitinh">—</span></div>
            <div class="col-sm-6"><strong>Lớp:</strong> <span id="c_lop">—</span></div>
            <div class="col-sm-6"><strong>Nơi ĐK KCB BĐ:</strong> <span id="c_noikham">—</span></div>
            <div class="col-sm-6"><strong>Sử dụng từ:</strong> <span id="c_from">—</span></div>
            <div class="col-sm-6"><strong>Ngày hết hạn:</strong> <span id="c_to">—</span></div>
            <div class="col-sm-6"><strong>Số tháng đóng:</strong> <span id="c_thang">—</span></div>
            <div class="col-sm-6"><strong>Số tiền:</strong> <span id="c_tien">—</span></div>
            <div class="col-sm-12 text-center">
              <span id="c_status" class="fw-bold text-success">ĐÃ KÍCH HOẠT</span>
              <div id="c_sohoso" class="status-code mt-1"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div id="toast-message" class="toast-body">Thành công!</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
  /* ===================== LOG & UTIL ===================== */
  const LOG_PREFIX='[DaThu]';
  const log = (...args)=>console.log(LOG_PREFIX, ...args);
  const warn = (...args)=>console.warn(LOG_PREFIX, ...args);
  const err  = (...args)=>console.error(LOG_PREFIX, ...args);

  const user = JSON.parse(localStorage.getItem("user")||"{}");
  if(!user.sdt || user.phan_quyen!=="giao_vien"){ location.href="../index.html"; }
  document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

  const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

  function showLoading(){ document.getElementById('loadingSpinner').style.display='flex'; }
  function hideLoading(){ document.getElementById('loadingSpinner').style.display='none'; }
  function showToast(msg){ document.getElementById('toast-message').innerText=msg; bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show(); }

  const safeStr = v => {
    const s = (v===undefined||v===null) ? '' : String(v).trim();
    if (!s) return '';
    const l = s.toLowerCase();
    return (l==='null'||l==='undefined'||l==='nan') ? '' : s;
  };
  const normalizeSdd = s => safeStr(s).replace(/^'/,''); // gỡ dấu nháy đầu nếu có
  const toNum = (v,def=0)=>{ const n=Number(v); return isNaN(n)?def:n; };

  function displayNgaySinh(raw){
    if(!raw) return "";
    if(/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN');
    if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
    return raw;
  }
  function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3]&&d.getMonth()==+m[2]-1&&d.getDate()==+m[1])?d:null; }
  function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
  function addDaysExact(dateObj,days){ const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
  function calcRangeFromOld(oldEndStr, months){ const od=parseVNDate(oldEndStr); const m=parseInt(months,10)||0; if(!od||m<=0) return {startText:'—', endText:'(không xác định)'}; const start=addDaysExact(od,1); const end=new Date(start.getFullYear(), start.getMonth()+m, 0); return { startText: formatVNDate(start), endText: formatVNDate(end) }; }
  function numberToVietnamese(n){
    const VI=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function triple(x){let tr=Math.floor(x/100),ch=Math.floor((x%100)/10),dv=x%10,s=""; if(tr>0){s+=VI[tr]+" trăm"; if(ch==0&&dv>0)s+=" lẻ";} if(ch>1){ s+=(s?" ":"")+VI[ch]+" mươi"; if(dv==1)s+=" mốt"; else if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI[dv]; } else if(ch==1){ s+=(s?" ":"")+"mười"; if(dv==5)s+=" lăm"; else if(dv>0)s+=" "+VI[dv]; } else if(ch==0&&dv>0){ s+=(s?" ":"")+VI[dv]; } return s.trim(); }
    n=Math.round(Number(n)||0); if(n===0) return "Không đồng";
    const U=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0,str="";
    while(n>0&&i<U.length){const b=n%1000;if(b>0){const part=triple(b); str=part+U[i]+(str?" "+str:"");} n=Math.floor(n/1000); i++;} return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();
  }
  function stripVN(s){return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');}
  function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase();}

  /* ===================== STATE ===================== */
  let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1;
  let allData=[], lastFiltered=[];
  const DETAILS_BY_SDD = {}; // lưu hoSo chi tiết sau khi gọi GetHosoBHYTByHS
  const HS_MAP_BY_SDD = {}; // để lấy địa chỉ/lớp từ DanhSach_Hocsinh

  addEventListener('resize',()=>{ const old=pageSize; pageSize = innerWidth<=600?6 : (innerWidth<=999?12:20); if(old!==pageSize){ currentPage=1; renderAllView(); } });

  /* ===================== API ===================== */
  async function apiGetAllHS(ma_truong, lop){
    const url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
    log('Fetch HS URL', url);
    const j = await (await fetch(url)).json();
    log('Fetch HS resp', { success:j?.success, len: Array.isArray(j?.data)? j.data.length : 0 });
    return j;
  }
  async function apiGetDanhSachBHYT(ma_truong, lop){
    const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
    log('Fetch DanhSach_BHYT URL', url);
    const j = await (await fetch(url)).json();
    log('Fetch DanhSach_BHYT resp', { success:j?.success, len: Array.isArray(j?.data)? j.data.length : 0 });
    return j;
  }
  async function apiGetHosoBHYTByHS(sdd, ma_truong, lop){
    const url = `${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(sdd)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
    log('Fetch Hoso URL', url);
    const j = await (await fetch(url)).json();
    log('Fetch Hoso resp', { success:j?.success, hasData: !!j?.data, keys: j?.data? Object.keys(j.data): [] });
    return j;
  }
  async function apiGetTenTruong(ma_truong){
    try{
      const url = `${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;
      const j = await (await fetch(url)).json();
      return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—';
    }catch{ return user.ten_truong || ma_truong || '—'; }
  }
  async function apiGetGiaBHYT(){
    const url = `${API_BASE}?func=GetGiaBHYT`;
    log('Fetch GiaBHYT URL', url);
    const j = await (await fetch(url)).json();
    log('Fetch GiaBHYT resp', { success:j?.success, len: Array.isArray(j?.data)? j.data.length : 0 });
    return j;
  }
  let _GIA_BHYT=null;
  async function ensureGiaBHYT(){ if(_GIA_BHYT) return _GIA_BHYT; const j=await apiGetGiaBHYT(); _GIA_BHYT = j?.data?.[0]||null; return _GIA_BHYT; }

  /* ===================== LOAD & MERGE ===================== */
  async function fetchDanhSachDaThu(){
    try{
      showLoading();
      pageSize = innerWidth<=600?6 : (innerWidth<=999?12:20);

      // 1) Học sinh của lớp (để lấy địa chỉ/lớp)
      const hs = await apiGetAllHS(user.ma_truong, user.lop_hoc);
      if(hs?.success && Array.isArray(hs.data)){
        hs.data.forEach(h => { HS_MAP_BY_SDD[normalizeSdd(h.so_dinh_danh)] = h; });
        log('HS_MAP_BY_SDD ready', Object.keys(HS_MAP_BY_SDD).length);
      } else warn('HS list empty or failed');

      // 2) DanhSach_BHYT
      const bh = await apiGetDanhSachBHYT(user.ma_truong, user.lop_hoc);
      const raw = Array.isArray(bh?.data) ? bh.data : [];
      // merge theo SDD
      allData = raw.map(r=>{
        const sdd = normalizeSdd(r.so_dinh_danh);
        const hsRow = HS_MAP_BY_SDD[sdd] || {};
        return {
          ...hsRow,
          ...r,
          so_dinh_danh: sdd,
          trang_thai: toNum(r.trang_thai,0),
          dia_chi: hsRow.dia_chi || r.dia_chi || ''
        };
      });

      log('Merged rows', { count: allData.length, sample: allData[0] });

      // 3) Enrich chi tiết cho các dòng đã nộp (tt=1) để lấy so_ho_so, so_tien...
      const needsDetail = allData.filter(x => x.trang_thai===1);
      log('Need details for trang_thai=1', needsDetail.map(x=>x.so_dinh_danh));

      await enrichDetails(needsDetail);

      lastFiltered = allData; currentPage=1; renderAllView();
    }catch(e){ err('fetchDanhSachDaThu error', e); allData=[]; lastFiltered=[]; renderAllView(); }
    finally{ hideLoading(); }
  }

  async function enrichDetails(rows){
    const conc=4; // giới hạn đồng thời
    for(let i=0;i<rows.length;i+=conc){
      const chunk = rows.slice(i,i+conc);
      await Promise.all(chunk.map(async (row)=>{
        const sdd = normalizeSdd(row.so_dinh_danh);
        const j = await apiGetHosoBHYTByHS(sdd, user.ma_truong, row.lop_hoc || user.lop_hoc || "");
        if(j?.success && j.data){
          DETAILS_BY_SDD[sdd] = j.data;
          // cập nhật row hiện tại
          row.so_ho_so = safeStr(j.data.so_ho_so);
          row.so_tien = j.data.so_tien ?? row.so_tien;
          row.so_thang_dong = j.data.so_thang_dong ?? row.so_thang_dong;
          row.noi_kham_bhyt = j.data.noi_kham ?? row.noi_kham_bhyt;
          row.han_su_dung_bhyt_moi = j.data.han_su_dung_bhyt_moi ?? row.han_su_dung_bhyt_moi;
          row.ngay_het_han_bhyt_cu = j.data.ngay_het_han_bhyt_cu ?? row.ngay_het_han_bhyt_cu;
        } else {
          warn('No detail for', sdd);
        }
      }));
    }
    log('DETAILS_BY_SDD ready', Object.keys(DETAILS_BY_SDD).length);
  }

  /* ===================== TABLE & UI ===================== */
  function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
  function doSort(field){ if(sortField===field) sortDir=-sortDir; else{ sortField=field; sortDir=1; } renderAllView(); }
  function gotoPage(p){ if(p<1||p>totalPages||p===currentPage) return; currentPage=p; renderAllView(); }

  function doSearch(){
    const q = document.getElementById('search-box').value.trim().toLowerCase();
    lastFiltered = !q ? allData : allData.filter(r=>{
      return (safeStr(r.ho_ten_hoc_sinh)).toLowerCase().includes(q) ||
             (displayNgaySinh(r.ngay_sinh)||"").toLowerCase().includes(q) ||
             (safeStr(r.so_dinh_danh)).toLowerCase().includes(q);
    });
    currentPage=1; renderAllView();
  }

  function renderStatusCell(r){
    const sdd = normalizeSdd(r.so_dinh_danh);
    const detail = DETAILS_BY_SDD[sdd] || {};
    const sohoso = safeStr(r.so_ho_so || detail.so_ho_so);
    const tt = toNum(r.trang_thai,0);
    const html =
      (tt===0) ? `<span class="status-badge status-wait">Chờ duyệt</span>` :
      (tt===1 && !sohoso) ? `<span class="status-badge status-pending">Đã nộp, chờ kích hoạt</span>` :
      `<div class="status-badge status-done">Đã kích hoạt</div><div class="status-code">${sohoso}</div>`;
    log('statusCell', { sdd, tt, sohoso });
    return html;
  }
  function renderActionCell(r){
    const sdd = normalizeSdd(r.so_dinh_danh);
    const detail = DETAILS_BY_SDD[sdd] || {};
    const sohoso = safeStr(r.so_ho_so || detail.so_ho_so);
    const tt = toNum(r.trang_thai,0);
    if (tt===1 && sohoso) {
      return `<div class="action-btns">
        <button class="btn btn-success btn-sm" onclick="xemThe('${sdd}')">Xem thẻ</button>
        <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${sdd}')">In phiếu thu</button>
      </div>`;
    }
    return `<div class="action-btns">
      <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${sdd}')">In phiếu thu</button>
    </div>`;
  }

  function renderTable(ds){
    if(!ds || ds.length===0){ document.getElementById('ds-container').innerHTML = `<div class="text-center text-secondary mt-4">Không có dữ liệu.</div>`; return; }
    let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
      <th class="th-status">Trạng thái</th>
      <th class="th-action">Thao tác</th>
      <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh ${sortIcon('ho_ten_hoc_sinh')}</th>
      <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh ${sortIcon('ngay_sinh')}</th>
      <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân ${sortIcon('so_dinh_danh')}</th>
    </tr></thead><tbody>`;
    ds.forEach(r=>{
      html += `<tr>
        <td>${renderStatusCell(r)}</td>
        <td>${renderActionCell(r)}</td>
        <td>${safeStr(r.ho_ten_hoc_sinh)}</td>
        <td>${displayNgaySinh(r.ngay_sinh)||""}</td>
        <td>${safeStr(r.so_dinh_danh)}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('ds-container').innerHTML = html;
  }

  function renderPagination(){
    const el=document.getElementById('pagination'); el.innerHTML=''; if(totalPages<=1) return;
    el.innerHTML+=`<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
    const minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
    if(minP>1) el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
    if(minP>2) el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
    for(let p=minP;p<=maxP;p++){ el.innerHTML+=`<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`; }
    if(maxP<totalPages-1) el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
    if(maxP<totalPages) el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
    el.innerHTML+=`<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
  }

  function renderAllView(){
    let data = lastFiltered||[];
    if(sortField){
      data = [...data].sort((a,b)=>{
        let av=(a[sortField]??"").toString().toLowerCase(), bv=(b[sortField]??"").toString().toLowerCase();
        if(!isNaN(av)&&!isNaN(bv)){ av=Number(av); bv=Number(bv); }
        if(av<bv) return -sortDir; if(av>bv) return sortDir; return 0;
      });
    }
    totalRecords=data.length; totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));
    document.getElementById('total-hs').innerText=`(${totalRecords} hồ sơ)`;
    const start=(currentPage-1)*pageSize;
    renderTable(data.slice(start, start+pageSize));
    renderPagination();
  }

  /* ===================== IN PHIẾU THU ===================== */
  function todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }
  function buildQRPayload(mt,school,classCode,name,months,endDate){
    const s=stripVN(school).slice(0,60), c=String(classCode||"").slice(0,12), n=stripVN(name).slice(0,60), m=String(months||""), e=String(endDate||"").slice(0,10);
    return `MT=${String(mt).slice(0,24)};S=${s};L=${c};N=${n};M=${m};E=${e}`;
  }

  async function inPhieuThu(sddRaw){
    try{
      showLoading();
      const sdd = normalizeSdd(sddRaw);
      log('> inPhieuThu START', { sdd });

      let row = (lastFiltered.length?lastFiltered:allData).find(x => normalizeSdd(x.so_dinh_danh)===sdd);
      log('Row selected', row);

      // Lấy detail nếu chưa có
      let detail = DETAILS_BY_SDD[sdd];
      if(!detail){
        const j = await apiGetHosoBHYTByHS(sdd, user.ma_truong, row?.lop_hoc || user.lop_hoc || "");
        if(j?.success && j.data){ DETAILS_BY_SDD[sdd]=detail=j.data; }
      }
      log('Detail used', detail);

      // Số tháng & tiền
      const months = toNum(detail?.so_thang_dong, toNum(row?.so_thang_dong, 12));
      let amount = toNum(String(detail?.so_tien ?? row?.so_tien ?? "0").replace(/[^\d]/g,''), 0);
      if(!amount){ const gia = await ensureGiaBHYT(); amount = (toNum(gia?.gia_tien,0))*months; }
      log('Amount computed', { months, amount });

      // Khoảng thời gian từ hạn cũ
      const oldEnd = row?.ngay_het_han_bhyt_cu || detail?.ngay_het_han_bhyt_cu || "";
      const {startText, endText} = calcRangeFromOld(oldEnd, months);

      // Thông tin trường, lớp
      const schoolName = await apiGetTenTruong(user.ma_truong);
      const classCode  = detail?.lop_hoc || row?.lop_hoc || user.lop_hoc || "";
      const teacherName= user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

      // Gán lên phiếu
      document.getElementById('rec-school').innerText = schoolName;
      document.getElementById('rec-class').innerText = classCode;
      document.getElementById('rec-date-today').innerText = todayText();
      document.getElementById('rec-student-name').innerText = row?.ho_ten_hoc_sinh || "";
      document.getElementById('rec-address').innerText = row?.dia_chi || HS_MAP_BY_SDD[sdd]?.dia_chi || "";
      document.getElementById('rec-content').innerText = `Thu tiền BHYT - ${classCode}`;
      document.getElementById('rec-months').innerText = String(months);
      document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
      document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
      document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
      document.getElementById('rec-teacher-name').innerText = teacherName;

      // QR
      const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
      const payload = buildQRPayload(user.ma_truong, schoolName, classCode, row?.ho_ten_hoc_sinh||"", months, endText);
      try{ new QRCode(qrBox,{text:payload,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
      catch(e){ const fb=`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(row?.ho_ten_hoc_sinh)};M=${months};E=${endText}`; new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }

      new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      log('< inPhieuThu DONE show modal');
    }catch(e){ err('inPhieuThu error', e); showToast('Không thể tạo phiếu thu.'); }
    finally{ hideLoading(); }
  }

  function printReceiptOnly(){
    log('> printReceiptOnly');
    const src=document.getElementById('receiptA5');
    const qr=src.querySelector('#receipt-qr'); const canvas=qr?.querySelector('canvas'); const img0=qr?.querySelector('img');
    if(qr && (canvas || img0)){
      try{ const dataURL = img0? img0.src : canvas.toDataURL('image/png'); qr.innerHTML=''; const img=document.createElement('img'); img.src=dataURL; img.width=90; img.height=90; qr.appendChild(img); }catch(_){}
    }
    setTimeout(()=>window.print(), 150);
  }
  async function downloadReceiptImage(){
    const node=document.getElementById('receiptA5');
    const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
    const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='phieu-thu-bhyt.png';
    if('download' in a && !isIOS()){ document.body.appendChild(a); a.click(); a.remove(); }
    else { const w=window.open(); if(w){ w.document.write(`<img src="${url}" style="max-width:100%"/>`); w.document.close(); } else { window.location.href=url; } }
  }

  /* ===================== XEM THẺ ===================== */
  async function xemThe(sddRaw){
    try{
      showLoading();
      const sdd = normalizeSdd(sddRaw);
      log('> xemThe START', { sdd });

      const row = (lastFiltered.length?lastFiltered:allData).find(x=>normalizeSdd(x.so_dinh_danh)===sdd) || {};
      let detail = DETAILS_BY_SDD[sdd];
      if(!detail){ const j=await apiGetHosoBHYTByHS(sdd, user.ma_truong, row?.lop_hoc||user.lop_hoc||""); if(j?.success&&j.data){ DETAILS_BY_SDD[sdd]=detail=j.data; } }

      const months = toNum(detail?.so_thang_dong, toNum(row?.so_thang_dong, 12));
      const oldEnd = row?.ngay_het_han_bhyt_cu || detail?.ngay_het_han_bhyt_cu || "";
      const {startText,endText} = calcRangeFromOld(oldEnd, months);
      const amount = (toNum(String(detail?.so_tien ?? row?.so_tien ?? "0").replace(/[^\d]/g,''),0) || 0);

      document.getElementById('c_ma_so').innerText = row.ma_so_bhxh || detail?.ma_so_bhxh || '—';
      document.getElementById('c_sdd').innerText = sdd || '—';
      document.getElementById('c_hoten').innerText = row.ho_ten_hoc_sinh || '—';
      document.getElementById('c_ngaysinh').innerText = displayNgaySinh(row.ngay_sinh) || '—';
      document.getElementById('c_gioitinh').innerText = row.gioi_tinh || detail?.gioi_tinh || '—';
      document.getElementById('c_lop').innerText = row.lop_hoc || detail?.lop_hoc || user.lop_hoc || '—';
      document.getElementById('c_noikham').innerText = detail?.noi_kham || row.noi_kham_bhyt || '—';
      document.getElementById('c_from').innerText = startText;
      document.getElementById('c_to').innerText = detail?.han_su_dung_bhyt_moi || endText;
      document.getElementById('c_thang').innerText = String(months);
      document.getElementById('c_tien').innerText = amount? amount.toLocaleString('vi-VN') : '—';

      const sohoso = safeStr(detail?.so_ho_so || row.so_ho_so);
      const stEl=document.getElementById('c_status');
      if(sohoso){ stEl.classList.remove('text-danger'); stEl.classList.add('text-success'); stEl.innerText='ĐÃ KÍCH HOẠT'; }
      else { stEl.classList.remove('text-success'); stEl.classList.add('text-danger'); stEl.innerText='ĐÃ NỘP, CHỜ KÍCH HOẠT'; }
      document.getElementById('c_sohoso').innerText = sohoso || '';

      new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
      log('< xemThe DONE show modal');
    }catch(e){ err('xemThe error', e); showToast('Không xem được thẻ.'); }
    finally{ hideLoading(); }
  }
  async function saveCardImage(){
    const node=document.getElementById('theBHYT');
    const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});
    const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='the-bhyt.png';
    if('download' in a && !isIOS()){ document.body.appendChild(a); a.click(); a.remove(); } else { const w=window.open(); if(w){ w.document.write(`<img src="${url}" style="max-width:100%"/>`); w.document.close(); } else { window.location.href=url; } }
  }

  function goBack(){ showLoading(); location.href='bhyt_giaovien.html'; }

  // Khởi động
  window.onload = fetchDanhSachDaThu;
  window.doSort = doSort;
  </script>
</body>
</html>
