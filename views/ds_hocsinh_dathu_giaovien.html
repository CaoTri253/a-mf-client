<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã tham gia - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px;padding-bottom:6px}
    .search-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{font-size:1rem;font-weight:400;color:#444}
    .th-action{min-width:190px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:15px;vertical-align:middle;margin-left:3px}
    .btn-back{position:fixed;bottom:26px;right:20px;z-index:1099;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 14px #0003;font-size:25px;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid #eee;color:#2563eb}
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}
    @media (max-width:600px){
      .header{font-size:18px}
      .th-action{min-width:150px}
      .action-btns{display:flex;flex-direction:column;gap:6px}
      .action-btns .btn{width:100%}
    }
    @media (min-width:601px){.action-btns{display:flex;gap:6px}}

    /* A5 biên lai */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}
    @media print{@page{size:A5 portrait;margin:10mm}body{background:#fff!important}.modal{position:static!important}.modal-dialog{width:auto!important;max-width:none!important}.modal-content{box-shadow:none!important;border:none!important}.no-print{display:none!important}.a5-paper{box-shadow:none!important;margin:0!important}}

    /* Card thẻ BHYT */
    .card-bhyt{width:900px;max-width:100%;background:#fff;border:2px solid #2c6bed;border-radius:10px;padding:16px;box-shadow:0 1px 10px #0002}
    .card-bhyt .title{font-weight:800;color:#ff5a5a;text-align:center;font-size:28px}
    .card-bhyt .rowline{display:flex;gap:16px;flex-wrap:wrap;margin:6px 0}
    .badge-green{color:#0a7a13;font-weight:800}
    .badge-blue{color:#0a44c2;font-weight:700}
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row mb-2">
      <input id="search-box" class="form-control search-input" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:#ffffff80;align-items:center;justify-content:center">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal xem thẻ -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
          <div class="no-print d-flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh</button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <div id="the-bhyt" class="card-bhyt">
            <div class="title">THẺ BẢO HIỂM Y TẾ</div>
            <div class="rowline"><b>Mã số:</b> <span id="c-ma-bhxh" class="badge-blue">—</span></div>
            <div class="rowline"><b>Số định danh:</b> <span id="c-so-dd" class="badge-blue">—</span></div>
            <div class="rowline"><b>Họ và tên:</b> <span id="c-hoten">—</span></div>
            <div class="rowline"><b>Ngày sinh:</b> <span id="c-ngaysinh">—</span> <b class="ms-4">Giới tính:</b> <span id="c-gioitinh">—</span> <b class="ms-4">Lớp:</b> <span id="c-lop">—</span></div>
            <div class="rowline"><b>Nơi ĐK KCB BD:</b> <span id="c-noikham">—</span></div>
            <div class="rowline"><b>Sử dụng từ:</b> <span id="c-begin" class="badge-blue">—</span> <b class="ms-4">Ngày hết hạn:</b> <span id="c-end" class="text-danger fw-bold">—</span> <b class="ms-4">Số tháng đóng:</b> <span id="c-months">—</span></div>
            <div class="rowline"><b>Số tiền đóng:</b> <span id="c-amount" class="badge-green">—</span></div>
            <hr/>
            <div class="rowline"><span id="c-status" class="badge-green">ĐÃ KÍCH HOẠT</span> &nbsp; <span id="c-sohoso" class="badge-blue"></span></div>
          </div>
        </div>
        <div class="modal-footer no-print">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-outline-secondary" onclick="saveCardImage()">Lưu ảnh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal xem trước & in Phiếu thu A5 -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
          <div class="no-print d-flex gap-2">
            <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
            <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" style="display:flex;justify-content:center;">
          <div id="receiptA5" class="a5-paper">
            <div class="row">
              <div class="col">
                <div class="receipt-meta">
                  <div><strong id="rec-school">Trường …</strong></div>
                  <div>Lớp: <strong id="rec-class">—</strong></div>
                </div>
              </div>
              <div class="col text-center">
                <div class="receipt-meta">
                  <div><strong>Mẫu số:</strong> C45-BB</div>
                  <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                  <div>ngày 10/10/2017 của Bộ Tài Chính</div>
                </div>
              </div>
            </div>
            <div class="row align-items-center mt-3">
              <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
              <div class="col text-center">
                <div class="receipt-title">BIÊN LAI THU TIỀN</div>
                <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
              </div>
            </div>
            <div class="mt-3">
              <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
              <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
              <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
              <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
              <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
              <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
            </div>
            <div class="row">
              <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
              <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
            </div>
          </div>
        </div>
        <div class="modal-footer no-print">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    /* ====== State & utils ====== */
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    let pageSize = 20, currentPage = 1, totalRecords = 0, totalPages = 1, sortField = "ho_ten_hoc_sinh", sortDir = 1;
    let allData = [];       // danh sách BHYT đã merge HS
    let lastFiltered = [];  // sau tìm kiếm
    const logPrefix = "[BHYT-DaThu]";

    function showLoading(){ document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading(){ document.getElementById('loadingSpinner').style.display = 'none'; }

    function displayNgaySinh(raw){
      if(!raw) return "";
      if(/^\d{4}-\d{2}-\d{2}T/.test(raw)){ const d=new Date(raw); return d.toLocaleDateString('vi-VN'); }
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;
      if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
      return raw;
    }
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getMonth()==+m[2]-1)?d:null; }
    function formatVNDate(d){ return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function addDaysExact(d,days){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate(),12,0,0); x.setDate(x.getDate()+days); return new Date(x.getFullYear(),x.getMonth(),x.getDate()); }
    function lastDayAfterMonths(start, m){ return new Date(start.getFullYear(), start.getMonth()+m, 0); }
    function safe(v){ return v===undefined||v===null?null:String(v).trim(); }
    function isEmpty(v){ const s=safe(v); return !s || s.toLowerCase()==='null' || s==='#N/A'; }
    function money(n){ n=Number(String(n).replace(/[^\d]/g,''))||0; return n.toLocaleString('vi-VN'); }

    function detectPageSize(){ const w=window.innerWidth; pageSize = w<=600? 6 : (w<=999? 12 : 20); }
    window.addEventListener('resize',()=>{ const p=pageSize; detectPageSize(); if(p!==pageSize){ currentPage=1; renderAllView(); } });

    /* ====== API giống trang 'chưa thu' ====== */
    async function getAllBHYT(ma_truong, lop){
      const url = `${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getAllHocsinh(ma_truong, lop){
      const url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getHosoBHYTByHS(so_dinh_danh, ma_truong, lop_hoc){
      const url = `${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop_hoc)}`;
      const res = await fetch(url); return await res.json();
    }
    async function getTenTruong(ma_truong){
      try{ const url=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`; const r=await fetch(url); const j=await r.json(); return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—'; }
      catch(_){ return user.ten_truong || ma_truong || '—'; }
    }

    /* ====== Bắt dữ liệu mảng từ response (chịu lỗi) ====== */
    function extractRows(resp){
      if(Array.isArray(resp)) return resp;
      if(Array.isArray(resp?.data)) return resp.data;
      // Một số bản trả về theo key khác → quét key để tìm mảng có trường so_dinh_danh
      if(resp && typeof resp==='object'){
        for(const k of Object.keys(resp)){
          const v = resp[k];
          if(Array.isArray(v) && v.length && typeof v[0]==='object' && ('so_dinh_danh' in v[0] || 'ho_ten_hoc_sinh' in v[0])){
            return v;
          }
        }
      }
      return [];
    }

    /* ====== Load dữ liệu: DanhSach_BHYT + merge địa chỉ/tên/ngày sinh từ DanhSach_Hocsinh ====== */
    async function fetchDathu(){
      try{
        detectPageSize(); showLoading();
        const [bhytRes, hsRes] = await Promise.all([
          getAllBHYT(user.ma_truong, user.lop_hoc),
          getAllHocsinh(user.ma_truong, user.lop_hoc)
        ]);

        const dsBHYTRaw = extractRows(bhytRes);
        const dsHSRaw   = extractRows(hsRes);

        // Map HS để bổ sung địa chỉ/ngày sinh nếu thiếu trên BHYT
        const hsMap = {};
        dsHSRaw.forEach(h=>{ const k=String(h.so_dinh_danh||'').replace(/^'/,'').trim(); hsMap[k]=h; });

        allData = dsBHYTRaw.map((r,idx)=>{
          const key = String(r.so_dinh_danh||'').replace(/^'/,'').trim();
          const hs  = hsMap[key] || {};
          const soHoSo = isEmpty(r.so_ho_so)? null : String(r.so_ho_so).trim();
          const trangThai = Number(r.trang_thai||0);
          return {
            ...r,
            stt: r.stt || idx+1,
            ho_ten_hoc_sinh: r.ho_ten_hoc_sinh || hs.ho_ten_hoc_sinh || '',
            ngay_sinh: r.ngay_sinh || hs.ngay_sinh || '',
            dia_chi: r.dia_chi || hs.dia_chi || '',
            lop_hoc: r.lop_hoc || hs.lop_hoc || user.lop_hoc,
            _so_ho_so: soHoSo,
            _trang_thai_num: trangThai
          };
        });

        currentPage=1; doSearch();
      }catch(e){
        console.error(logPrefix,'fetchDathu error',e);
        allData=[]; renderAllView();
      }
      finally{ hideLoading(); }
    }

    /* ====== Tìm kiếm / sắp xếp / phân trang ====== */
    function doSearch(){
      const q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q? allData : allData.filter(h =>
        (h.ho_ten_hoc_sinh||'').toLowerCase().includes(q) ||
        (displayNgaySinh(h.ngay_sinh)||'').toLowerCase().includes(q) ||
        (String(h.so_dinh_danh||'')).toLowerCase().includes(q)
      );
      currentPage=1; renderAllView();
    }
    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
    function renderAllView(){
      let data = lastFiltered || allData;
      if(sortField){
        data = [...data].sort((a,b)=>{
          let av=(a[sortField]||'').toString().toLowerCase(), bv=(b[sortField]||'').toString().toLowerCase();
          if(!isNaN(av)&&!isNaN(bv)){ av=Number(av); bv=Number(bv); }
          if(av<bv) return -sortDir; if(av>bv) return sortDir; return 0;
        });
      }
      totalRecords=data.length; totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} hồ sơ)`;
      const start=(currentPage-1)*pageSize; const ds=data.slice(start,start+pageSize);
      renderTable(ds); renderPagination();
    }
    function renderPagination(){
      const p = document.getElementById('pagination'); p.innerHTML='';
      if(totalPages<=1) return;
      p.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      const minP=Math.max(1,currentPage-2), maxP=Math.min(totalPages,currentPage+2);
      if(minP>1)p.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if(minP>2)p.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for(let i=minP;i<=maxP;i++){ p.innerHTML+=`<li class="page-item${i===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${i});return false;">${i}</a></li>`; }
      if(maxP<totalPages-1)p.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if(maxP<totalPages)p.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      p.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    function gotoPage(p){ if(p<1||p>totalPages||p===currentPage) return; currentPage=p; renderAllView(); }
    function doSort(field){ if(sortField===field) sortDir=-sortDir; else{ sortField=field; sortDir=1; } renderAllView(); }

    /* ====== Bảng ====== */
    function renderTable(ds){
      if(!ds||ds.length===0){ document.getElementById('ds-container').innerHTML=`<div class="text-center text-secondary mt-4">Không có hồ sơ.</div>`; return; }
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
        <th class="th-action">Thao tác</th>
        <th>Trạng thái</th>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
      </tr></thead><tbody>`;

      ds.forEach(row=>{
        const soHoSo = row._so_ho_so;
        const t = row._trang_thai_num; // 0 or 1
        let statusHtml = '';
        if(t===0){
          statusHtml = `<span class="text-danger fw-bold">Chờ duyệt</span>`;
        }else if(t===1 && !soHoSo){
          statusHtml = `<span class="text-danger fw-bold">Đã nộp, chờ kích hoạt</span>`;
        }else if(t===1 && soHoSo){
          statusHtml = `<div class="text-success fw-bold">Đã kích hoạt</div><div class="badge-blue">${soHoSo}</div>`;
        }else{
          statusHtml = `<span class="text-muted">—</span>`;
        }

        // Thao tác
        let actions = '';
        if(t===1 && soHoSo){
          actions = `
            <div class="action-btns">
              <button class="btn btn-outline-success btn-sm" onclick="xemThe('${row.stt}')">Xem thẻ</button>
              <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button>
            </div>`;
        }else{
          actions = `<div class="action-btns"><button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button></div>`;
        }

        html += `<tr>
          <td>${actions}</td>
          <td>${statusHtml}</td>
          <td>${row.ho_ten_hoc_sinh||''}</td>
          <td>${displayNgaySinh(row.ngay_sinh||'')}</td>
          <td>${row.so_dinh_danh||''}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ====== Xem thẻ ====== */
    function xemThe(stt){
      const r = (lastFiltered||allData).find(x=>String(x.stt)===String(stt)); if(!r) return;
      const begin = parseVNDate(r.ngay_het_han_bhyt_cu) ? addDaysExact(parseVNDate(r.ngay_het_han_bhyt_cu),1) : (parseVNDate(r.han_su_dung_bhyt_moi)||null);
      const months = parseInt(r.so_thang_dong||0,10);
      const end = begin ? lastDayAfterMonths(begin, months>0?months:12) : (parseVNDate(r.han_su_dung_bhyt_moi)||null);
      document.getElementById('c-ma-bhxh').innerText = r.ma_so_bhxh || '';
      document.getElementById('c-so-dd').innerText = r.so_dinh_danh || '';
      document.getElementById('c-hoten').innerText = r.ho_ten_hoc_sinh || '';
      document.getElementById('c-ngaysinh').innerText = displayNgaySinh(r.ngay_sinh || '');
      document.getElementById('c-gioitinh').innerText = r.gioi_tinh || '';
      document.getElementById('c-lop').innerText = r.lop_hoc || user.lop_hoc || '';
      document.getElementById('c-noikham').innerText = r.noi_kham_bhyt || '';
      document.getElementById('c-begin').innerText = begin? formatVNDate(begin) : '—';
      document.getElementById('c-end').innerText = end? formatVNDate(end) : '—';
      document.getElementById('c-months').innerText = r.so_thang_dong || '';
      document.getElementById('c-amount').innerText = money(r.so_tien||0);
      const st = Number(r._trang_thai_num||0);
      const stEl = document.getElementById('c-status');
      if(st===1 && r._so_ho_so){ stEl.classList.add('badge-green'); stEl.classList.remove('text-danger'); stEl.innerText='ĐÃ KÍCH HOẠT'; }
      else if(st===1){ stEl.classList.remove('badge-green'); stEl.classList.add('text-danger','fw-bold'); stEl.innerText='Đã nộp, chờ kích hoạt'; }
      else { stEl.classList.remove('badge-green'); stEl.classList.add('text-danger','fw-bold'); stEl.innerText='Chờ duyệt'; }
      document.getElementById('c-sohoso').innerText = r._so_ho_so || '';
      new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
    }
    async function saveCardImage(){
      const node=document.getElementById('the-bhyt'); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'});
      const dataURL=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataURL; a.download='the-bhyt.png'; document.body.appendChild(a); a.click(); a.remove();
    }

    /* ====== Phiếu thu (y hệt trang 'chưa thu') ====== */
    const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s="";if(tr>0){s+=VI_DIGITS[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ"}if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv]}return s.trim()}
    function numberToVietnamese(n){n=Math.round(Number(n)||0);if(n===0)return"Không đồng";const u=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";while(n>0&&i<u.length){const b=n%1000;if(b>0){const part=readTriple(b,i>0);str=part+u[i]+(str?" "+str:"")}n=Math.floor(n/1000);i++}str=str.charAt(0).toUpperCase()+str.slice(1)+" đồng";return str.replace(/\s+/g," ").trim()}
    function pad3(n){n=parseInt(n,10)||0;return String(n).padStart(3,'0')}
    function todayText(){const d=new Date();return`Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`}
    function calcRange(oldEndStr,months){const od=parseVNDate(oldEndStr);const m=parseInt(months,10)||0;if(!od||m<=0)return{startText:"—",endText:"(không xác định)"};const start=addDaysExact(od,1);const end=new Date(start.getFullYear(),start.getMonth()+m,0);return{startText:formatVNDate(start),endText:formatVNDate(end)}}
    function stripVN(str){return String(str||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D')}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase()}
    function buildQRPayload(schoolCode,school,classCode,name,months,endDate){const mt=String(schoolCode||"").slice(0,24);const s=stripVN(school).slice(0,60);const c=String(classCode||"").slice(0,12);const n=stripVN(name).slice(0,60);const m=String(months||"");const e=String(endDate||"").slice(0,10);return`MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`}

    async function inPhieuThu(stt){
      try{
        showLoading();
        const r=(lastFiltered||allData).find(x=>String(x.stt)===String(stt)); if(!r){ hideLoading(); return; }
        const hoSo=await getHosoBHYTByHS(r.so_dinh_danh,user.ma_truong,r.lop_hoc);
        if(!hoSo||!hoSo.success||!hoSo.data){ hideLoading(); showToast("Không tìm thấy hồ sơ BHYT để in."); return; }
        const months=parseInt(hoSo.data.so_thang_dong||"12",10);
        const amount=parseInt((hoSo.data.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
        const {startText,endText}=calcRange(r.ngay_het_han_bhyt_cu||r.ngay_het_han_bhyt, months);
        const schoolName=await getTenTruong(user.ma_truong);
        const classCode=hoSo.data.lop_hoc || r.lop_hoc || (user.lop_hoc||"");
        const seq=pad3(r.stt);
        const teacherName=user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText=schoolName;
        document.getElementById('rec-class').innerText=classCode;
        document.getElementById('rec-date-today').innerText=todayText();
        document.getElementById('rec-student-name').innerText=r.ho_ten_hoc_sinh||"";
        document.getElementById('rec-address').innerText=r.dia_chi||"";
        document.getElementById('rec-content').innerText=`Thu tiền BHYT - ${classCode}${seq}`;
        document.getElementById('rec-months').innerText=String(months);
        document.getElementById('rec-range').innerText=`từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText=amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText=numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText=teacherName;

        const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const primaryText=buildQRPayload(user.ma_truong,schoolName,classCode,r.ho_ten_hoc_sinh||"",months,endText);
        try{ new QRCode(qrBox,{text:primaryText,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
        catch(e){ const fallback=`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(r.ho_ten_hoc_sinh)};M=${months};E=${endText}`; new QRCode(qrBox,{text:fallback,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(err){ console.error(logPrefix,'inPhieuThu error',err); showToast("Không thể tạo phiếu thu."); }
      finally{ hideLoading(); }
    }

    async function downloadReceiptImage(){
      try{ const node=document.getElementById('receiptA5'); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const dataURL=canvas.toDataURL("image/png");
        const canDownload = 'download' in document.createElement('a') && !isIOS();
        if(canDownload){ const a=document.createElement('a'); a.href=dataURL; a.download=`phieu-thu-bhyt.png`; document.body.appendChild(a); a.click(); a.remove(); }
        else{ const win=window.open(); if(win){ win.document.write(`<html><head><title>Lưu ảnh phiếu thu</title></head><body style="margin:0"><img src="${dataURL}" style="max-width:100%;display:block"/></body></html>`); win.document.close(); } else { window.location.href=dataURL; } }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }

    function getReceiptPrintCSS(){
      return `
        <style>
          @page { size: A5 portrait; margin: 10mm; }
          html,body{ background:#fff; margin:0; padding:0; }
          .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000; margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px; }
          .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
          .receipt-sub{ font-style:italic; }
          .receipt-meta{ font-size:13px; }
          .receipt-line{ margin: 2mm 0; }
          .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
          .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
          .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
          .row{ display:flex; flex-wrap:nowrap; width:100%; }.col{ flex:1 1 0; }.text-center{ text-align:center; }
        </style>
      `;
    }
    function printReceiptOnly(){
      const src=document.getElementById('receiptA5'); if(!src){ console.error('printReceiptOnly: #receiptA5 not found'); return; }
      try{
        const clone=src.cloneNode(true);
        const cloneQR=clone.querySelector('#receipt-qr');
        const origCanvas=document.querySelector('#receipt-qr canvas');
        const origImg=document.querySelector('#receipt-qr img');
        if(cloneQR && (origCanvas||origImg)){
          try{ const dataURL=origImg?origImg.src:origCanvas.toDataURL('image/png'); cloneQR.innerHTML=''; const img=document.createElement('img'); img.src=dataURL; img.style.width='90px'; img.style.height='90px'; cloneQR.appendChild(img); }catch(e){/* ignore */ }
        }
        const html=`<html><head><title>In phiếu thu</title>${getReceiptPrintCSS()}</head><body>${clone.outerHTML}</body></html>`;
        const w=window.open('','_blank','width=900,height=650'); if(!w){ alert('Trình duyệt chặn cửa sổ in. Hãy cho phép pop-up rồi thử lại.'); return; }
        w.document.open(); w.document.write(html); w.document.close();
        const triggerPrint=()=>{ try{ w.focus(); w.print(); if(!isMobile()) setTimeout(()=>{try{w.close()}catch(_){}} ,500); }catch(e){} };
        w.onload=()=>{ try{ const imgs=w.document.images; if(!imgs||imgs.length===0){ setTimeout(triggerPrint,200); return; } let loaded=0; const done=()=>{ if(++loaded>=imgs.length) triggerPrint(); }; for(const img of imgs){ if(img.complete) done(); else { img.onload=done; img.onerror=done; } } setTimeout(triggerPrint,1500); }catch(e){ triggerPrint(); } };
      }catch(e){ alert('Không thể in phiếu: '+(e.message||e)); }
    }

    function showToast(msg){ document.getElementById('toast-message').innerText=msg; bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show(); }
    function goBack(){ showLoading(); window.location.href="bhyt_giaovien.html"; }

    window.onload = fetchDathu;
  </script>
</body>
</html>
