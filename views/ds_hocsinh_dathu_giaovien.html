<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DS học sinh đã tham gia - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:bold;margin-bottom:8px;padding-bottom:6px}
    .search-row{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:10px;gap:10px;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{font-size:1rem;font-weight:400;color:#444}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:15px;vertical-align:middle;margin-left:3px}
    th.th-action{min-width:190px}
    th.th-status{min-width:140px}

    .btn-back{
      position:fixed;bottom:26px;right:20px;z-index:1099;border-radius:50%;width:54px;height:54px;
      box-shadow:0 2px 14px #0003;font-size:25px;display:flex;align-items:center;justify-content:center;
      background:#fff;border:2px solid #eee;color:#2563eb;transition:box-shadow .12s
    }
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}

    @media(max-width:600px){
      .header{font-size:18px}
      th.th-action{min-width:150px}
      .search-row{flex-direction:column;align-items:stretch}
      .action-btns{display:flex;flex-direction:column;gap:6px}
      .action-btns .btn{width:100%}
    }
    @media(min-width:601px){ .action-btns{display:flex;flex-direction:row;gap:6px} }

    /* ====== STATUS ====== */
    .status-badge{display:inline-block;font-weight:700}
    .status-wait{color:#dc2626}        /* Chờ duyệt - đỏ */
    .status-pending{color:#dc2626}     /* Đã nộp, chờ kích hoạt - đỏ */
    .status-done{color:#16a34a}        /* Đã kích hoạt - xanh lá */
    .status-code{color:#1d4ed8;font-weight:700;font-size:14px}  /* Số hồ sơ - xanh dương */

    /* ====== A5 Receipt ====== */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}

    /* ====== BHYT Card ====== */
    .card-bhyt{width:900px;max-width:100%;background:#fff;border:2px solid #3b82f6;border-radius:10px;padding:16px;box-shadow:0 1px 12px #0002}
    .card-bhyt .title{text-align:center;color:#ef4444;font-weight:800;font-size:30px;letter-spacing:.6px}
    .card-bhyt .rowline{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0}
    .card-bhyt .label{min-width:150px;color:#6b7280;font-weight:600}

    /* ====== PRINT IN-MODAL ====== */
    @media print{
      @page{size:A5 portrait;margin:10mm}
      body{background:#fff!important}
      .no-print{display:none!important}
      .modal{position:static!important}
      .modal-dialog{width:auto!important;max-width:none!important}
      .modal-content{box-shadow:none!important;border:none!important}
      .a5-paper{box-shadow:none!important;margin:0!important}
    }
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading overlay -->
  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Modal xem thẻ BHYT -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ bảo hiểm y tế</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="saveCardImage()">Lưu ảnh</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="theBHYT" class="card-bhyt">
          <div class="title">THẺ BẢO HIỂM Y TẾ</div>
          <div class="rowline"><span class="label">Mã số:</span> <strong id="card-mabhxh">—</strong></div>
          <div class="rowline"><span class="label">HS - Số định danh:</span> <strong id="card-sdd">—</strong></div>
          <div class="rowline"><span class="label">Họ và tên:</span> <strong id="card-name">—</strong></div>
          <div class="rowline"><span class="label">Ngày sinh:</span> <strong id="card-dob">—</strong> <span class="label">Giới tính:</span> <strong id="card-gender">—</strong> <span class="label">Lớp:</span> <strong id="card-class">—</strong></div>
          <div class="rowline"><span class="label">Nơi ĐK KCB ban đầu:</span> <strong id="card-noikham">—</strong></div>
          <div class="rowline"><span class="label">Sử dụng từ:</span> <strong id="card-start">—</strong> <span class="label">Số tháng đóng:</span> <strong id="card-months">—</strong></div>
          <div class="rowline"><span class="label">Ngày hết hạn:</span> <strong id="card-end">—</strong> <span class="label">Số tiền đóng:</span> <strong id="card-amount">—</strong></div>
          <div class="rowline"><span class="label">Trạng thái:</span> <strong id="card-active" class="text-success">ĐÃ KÍCH HOẠT</strong></div>
          <div class="rowline"><span class="label">Số hồ sơ:</span> <strong id="card-sohoso" class="status-code">—</strong></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
    </div></div>
  </div>

  <!-- Modal phiếu thu A5 -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col"><div class="receipt-meta">
              <div><strong id="rec-school">Trường …</strong></div>
              <div>Lớp: <strong id="rec-class">—</strong></div>
            </div></div>
            <div class="col text-center"><div class="receipt-meta">
              <div><strong>Mẫu số:</strong> C45-BB</div>
              <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
              <div>ngày 10/10/2017 của Bộ Tài Chính</div>
            </div></div>
          </div>
          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center">
              <div class="receipt-title">BIÊN LAI THU TIỀN</div>
              <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
            </div>
          </div>
          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>
          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== AUTH & COMMON ====== */
    const logPrefix='[DaThu]';
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    function showLoading(){ document.getElementById('loadingSpinner').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingSpinner').style.display='none'; }
    function showToast(msg){ document.getElementById('toast-message').innerText = msg; bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show(); }

    /* ====== HELPERS ====== */
    function safeStr(v){ const s=(v===undefined||v===null)?'':String(v).trim(); return s.toLowerCase()==='null'?'':s; }
    function toNum(v,def=0){ const n=Number(v); return isNaN(n)?def:n; }
    function displayNgaySinh(raw){ if(!raw) return ""; if(/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw).toLocaleDateString('vi-VN'); if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`;} return raw; }
    function parseVNDate(str){const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3]&&d.getMonth()==+m[2]-1&&d.getDate()==+m[1])?d:null;}
    function formatVNDate(d){const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=d.getFullYear();return `${dd}/${mm}/${yy}`;}
    function addDaysExact(dateObj,days){const d=new Date(dateObj.getFullYear(),dateObj.getMonth(),dateObj.getDate(),12,0,0);d.setDate(d.getDate()+days);return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
    function calcRangeFromOld(oldEndStr, months){ const od=parseVNDate(oldEndStr); const m=parseInt(months,10)||0; if(!od||m<=0) return {startText:'—', endText:'(không xác định)'}; const start=addDaysExact(od,1); const end=new Date(start.getFullYear(),start.getMonth()+m,0); return {startText:formatVNDate(start), endText:formatVNDate(end)}; }
    function numberToVietnamese(n){const VI=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];function triple(x){let tr=Math.floor(x/100),ch=Math.floor((x%100)/10),dv=x%10,s="";if(tr>0){s+=VI[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ";}if(ch>1){s+=(s?" ":"")+VI[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI[dv];}else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI[dv];}else if(ch==0&&dv>0){s+=(s?" ":"")+VI[dv];}return s.trim();}n=Math.round(Number(n)||0);if(n===0)return"Không đồng";const U=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";while(n>0&&i<U.length){const b=n%1000;if(b>0){const part=triple(b);str=part+U[i]+(str?" "+str:"");}n=Math.floor(n/1000);i++;}return(str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();}
    function stripVN(s){return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D');}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase();}

    /* ====== STATE & SORT/PAGING ====== */
    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1,allData=[],lastFiltered=[];
    function detectPageSize(){const w=window.innerWidth;pageSize=w<=600?5:(w<=999?10:20);}
    window.addEventListener('resize',()=>{const old=pageSize;detectPageSize();if(old!==pageSize){currentPage=1;renderAllView();}});
    function doSearch(){const q=document.getElementById('search-box').value.trim().toLowerCase();lastFiltered=!q?allData:allData.filter(r=>(safeStr(r.ho_ten_hoc_sinh)).toLowerCase().includes(q)||(displayNgaySinh(r.ngay_sinh)||"").toLowerCase().includes(q)||(safeStr(r.so_dinh_danh)).toLowerCase().includes(q));currentPage=1;renderAllView();}
    function sortIcon(field){if(sortField!==field)return'';return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>';}
    function renderPagination(){const el=document.getElementById('pagination');el.innerHTML='';if(totalPages<=1)return;el.innerHTML+=`<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;let minP=Math.max(1,currentPage-2),maxP=Math.min(totalPages,currentPage+2);if(minP>1)el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;if(minP>2)el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;for(let p=minP;p<=maxP;p++){el.innerHTML+=`<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;}if(maxP<totalPages-1)el.innerHTML+=`<li class="page-item disabled"><span class="page-link">...</span></li>`;if(maxP<totalPages)el.innerHTML+=`<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;el.innerHTML+=`<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;}
    function renderAllView(){let dataToShow=lastFiltered&&lastFiltered.length?lastFiltered:allData;if(sortField){dataToShow=[...dataToShow].sort((a,b)=>{let av=(a[sortField]??"").toString().toLowerCase(),bv=(b[sortField]??"").toString().toLowerCase();if(!isNaN(av)&&!isNaN(bv)){av=Number(av);bv=Number(bv);}if(av<bv)return -sortDir;if(av>bv)return sortDir;return 0;});}totalRecords=dataToShow.length;totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));document.getElementById('total-hs').innerText=`(${totalRecords} hồ sơ)`;const start=(currentPage-1)*pageSize;renderDanhSach(dataToShow.slice(start,start+pageSize));renderPagination();}
    window.doSort=function(field){if(sortField===field)sortDir=-sortDir;else{sortField=field;sortDir=1;}renderAllView();};
    window.gotoPage=function(p){if(p<1||p>totalPages||p===currentPage)return;currentPage=p;renderAllView();};

    /* ====== API ====== */
    async function apiGetAllHS(ma_truong,lop){const url=`${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;const r=await fetch(url);return await r.json();}
    async function apiGetAllBHYT(ma_truong,lop){const url=`${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;const r=await fetch(url);return await r.json();}
    async function apiGetHoso(so_dinh_danh,ma_truong,lop){const url=`${API_BASE}?func=GetHosoBHYTByHS&so_dinh_danh=${encodeURIComponent(so_dinh_danh)}&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;const r=await fetch(url);return await r.json();}
    async function apiGetTenTruong(ma_truong){try{const r=await fetch(`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`);const j=await r.json();return j?.ten_truong||j?.data?.ten_truong||user.ten_truong||ma_truong||'—';}catch{return user.ten_truong||ma_truong||'—';}}

    /* ====== LOAD DATA (map & merge như file gốc) ====== */
    let _bhytMapFull={};  // để in fallback
    async function fetchDanhSachDaThu(){
      try{
        detectPageSize(); showLoading();
        // 1) HS của lớp
        const hs = await apiGetAllHS(user.ma_truong, user.lop_hoc);
        // 2) Danh sách BHYT của lớp
        const bh = await apiGetAllBHYT(user.ma_truong, user.lop_hoc);
        const dsBHYT = Array.isArray(bh.data) ? bh.data : [];
        _bhytMapFull = {};
        dsBHYT.forEach(r => { const k = String(r.so_dinh_danh||"").replace(/^'/,'').trim(); _bhytMapFull[k] = r; });
        // 3) Merge và chỉ giữ các em ĐÃ có hồ sơ trong DanhSach_BHYT (tt 0/1)
        if (hs.success && Array.isArray(hs.data)){
          allData = hs.data.map(h=>{
            const r = _bhytMapFull[h.so_dinh_danh];
            if (!r) return null;      // chỉ lấy hs có hồ sơ BHYT
            const tt = toNum(r.trang_thai, toNum(r.status, 0));
            return { ...h, ...r, trang_thai: tt, _bhyt_trangthai: tt, so_ho_so: safeStr(r.so_ho_so) };
          }).filter(Boolean);
        } else allData=[];
        lastFiltered = allData; currentPage=1; renderAllView();
      }catch(e){ console.error(logPrefix,'fetch error',e); allData=[]; lastFiltered=[]; renderAllView(); }
      finally{ hideLoading(); }
    }

    /* ====== TABLE RENDER (đúng thứ tự cột: Trạng thái → Thao tác → Họ tên → Ngày sinh → SĐD) ====== */
    function statusCell(row){
      const tt = toNum(row.trang_thai, toNum(row._bhyt_trangthai,0));
      const sohoso = safeStr(row.so_ho_so);
      if (tt===0) return `<span class="status-badge status-wait">Chờ duyệt</span>`;
      if (tt===1 && !sohoso) return `<span class="status-badge status-pending">Đã nộp, chờ kích hoạt</span>`;
      if (tt===1 && sohoso) return `<div class="status-badge status-done">Đã kích hoạt</div><div class="status-code">${sohoso}</div>`;
      return '';
    }
    function actionButtons(row){
      const tt=toNum(row.trang_thai, toNum(row._bhyt_trangthai,0));
      const sohoso=safeStr(row.so_ho_so);
      const btnIn = `<button class="btn btn-primary btn-sm" onclick="inPhieuThu('${row.stt}')">In phiếu thu</button>`;
      const btnXem= `<button class="btn btn-success btn-sm" onclick="xemThe('${row.stt}')">Xem thẻ</button>`;
      if (tt===0) return `<div class="action-btns">${btnIn}</div>`;
      if (tt===1 && !sohoso) return `<div class="action-btns">${btnIn}</div>`;
      if (tt===1 && sohoso) return `<div class="action-btns">${btnXem}${btnIn}</div>`;
      return `<div class="action-btns">${btnIn}</div>`;
    }
    function renderDanhSach(ds){
      if(!ds||ds.length===0){ document.getElementById('ds-container').innerHTML=`<div class='text-center text-secondary mt-4'>Không có học sinh đã tham gia trong lớp này.</div>`; return; }
      let html = `<table class="table table-bordered table-hs align-middle"><thead><tr>
        <th class="th-status">Trạng thái</th>
        <th class="th-action">Thao tác</th>
        <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
        <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
        <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
      </tr></thead><tbody>`;
      ds.forEach(r=>{
        html += `<tr>
          <td>${statusCell(r)}</td>
          <td>${actionButtons(r)}</td>
          <td>${safeStr(r.ho_ten_hoc_sinh)}</td>
          <td>${displayNgaySinh(r.ngay_sinh)||""}</td>
          <td>${safeStr(r.so_dinh_danh)}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;
    }

    /* ====== IN PHIẾU THU (IN TRONG MODAL – không mở tab mới) ====== */
    function pad3(n){n=parseInt(n,10)||0;return String(n).padStart(3,'0');}
    function todayText(){const d=new Date();return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`;}
    function buildQRPayload(mt,school,classCode,name,months,endDate){const s=stripVN(school).slice(0,60),c=String(classCode||"").slice(0,12),n=stripVN(name).slice(0,60),m=String(months||""),e=String(endDate||"").slice(0,10);return `MT=${String(mt).slice(0,24)};S=${s};L=${c};N=${n};M=${m};E=${e}`;}

    async function inPhieuThu(stt){
      try{
        showLoading();
        const hs=(lastFiltered.length?lastFiltered:allData).find(h=>String(h.stt)===String(stt));
        if(!hs){hideLoading();return;}
        // Lấy hồ sơ chuẩn; fallback: lấy từ _bhytMapFull (vá lỗi #4)
        let hoSo = await apiGetHoso(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc||user.lop_hoc||"");
        if(!hoSo || !hoSo.success || !hoSo.data){ const r=_bhytMapFull[hs.so_dinh_danh]; if(r) hoSo={success:true,data:r}; }
        if(!hoSo || !hoSo.success || !hoSo.data){ hideLoading(); showToast("Không tìm thấy hồ sơ BHYT để in."); return; }

        const months = toNum(hoSo.data.so_thang_dong, toNum(hs.so_thang_dong, 12));
        const amount = toNum(String(hoSo.data.so_tien ?? hs.so_tien ?? "0").replace(/[^\d]/g,''), 0);
        const range = calcRangeFromOld(hs.ngay_het_han_bhyt_cu || hs.ngay_het_han_bhyt || hoSo.data.ngay_het_han_bhyt_cu || "", months);
        const schoolName = await apiGetTenTruong(user.ma_truong);
        const classCode = hoSo.data.lop_hoc || hs.lop_hoc || user.lop_hoc || "";
        const seq = pad3(hs.stt);
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText = schoolName;
        document.getElementById('rec-class').innerText = classCode;
        document.getElementById('rec-date-today').innerText = todayText();
        document.getElementById('rec-student-name').innerText = hs.ho_ten_hoc_sinh || "";
        document.getElementById('rec-address').innerText = hs.dia_chi || "";
        document.getElementById('rec-content').innerText = `Thu tiền BHYT - ${classCode}${seq}`;
        document.getElementById('rec-months').innerText = String(months);
        document.getElementById('rec-range').innerText = `từ ngày ${range.startText} đến ngày ${range.endText}`;
        document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText = teacherName;

        const qrBox=document.getElementById('receipt-qr'); qrBox.innerHTML="";
        const payload = buildQRPayload(user.ma_truong, schoolName, classCode, hs.ho_ten_hoc_sinh||"", months, range.endText);
        try{ new QRCode(qrBox,{text:payload,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); }
        catch(e){ const fb=`MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hs.ho_ten_hoc_sinh)};M=${months};E=${range.endText}`;
          try{ new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L}); } catch{ qrBox.innerHTML='<small>QR quá dài</small>'; }
        }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(err){ console.error(logPrefix,'inPhieuThu',err); showToast('Không thể tạo phiếu thu.'); }
      finally{ hideLoading(); }
    }

    function printReceiptOnly(){ window.print(); }  // ✅ in thẳng trong modal, không mở tab mới
    async function downloadReceiptImage(){ const node=document.getElementById('receiptA5'); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const dataURL=canvas.toDataURL("image/png"); const a=document.createElement('a'); a.href=dataURL; a.download='phieu-thu-bhyt.png'; document.body.appendChild(a); a.click(); a.remove(); }

    /* ====== XEM THẺ ====== */
    async function xemThe(stt){
      try{
        showLoading();
        const hs=(lastFiltered.length?lastFiltered:allData).find(h=>String(h.stt)===String(stt)); if(!hs){hideLoading();return;}
        const months = toNum(hs.so_thang_dong, 12);
        const range  = calcRangeFromOld(hs.ngay_het_han_bhyt_cu || hs.ngay_het_han_bhyt || "", months);

        document.getElementById('card-mabhxh').innerText = safeStr(hs.ma_so_bhxh) || '—';
        document.getElementById('card-sdd').innerText    = safeStr(hs.so_dinh_danh) || '—';
        document.getElementById('card-name').innerText   = safeStr(hs.ho_ten_hoc_sinh) || '—';
        document.getElementById('card-dob').innerText    = displayNgaySinh(hs.ngay_sinh) || '—';
        document.getElementById('card-gender').innerText = safeStr(hs.gioi_tinh) || '—';
        document.getElementById('card-class').innerText  = safeStr(hs.lop_hoc || user.lop_hoc) || '—';
        document.getElementById('card-noikham').innerText= safeStr(hs.noi_kham_bhyt || hs.noi_kham) || '—';
        document.getElementById('card-start').innerText  = range.startText;
        document.getElementById('card-end').innerText    = hs.han_su_dung_bhyt_moi || range.endText;
        document.getElementById('card-months').innerText = String(months);
        document.getElementById('card-amount').innerText = toNum(String(hs.so_tien||'0').replace(/[^\d]/g,''),0).toLocaleString('vi-VN');

        const tt=toNum(hs.trang_thai, toNum(hs._bhyt_trangthai,0));
        const sohoso=safeStr(hs.so_ho_so);
        const stEl=document.getElementById('card-active');
        if (tt===1 && sohoso){ stEl.classList.remove('text-danger'); stEl.classList.add('text-success'); stEl.innerText='ĐÃ KÍCH HOẠT'; }
        else if (tt===1 && !sohoso){ stEl.classList.remove('text-success'); stEl.classList.add('text-danger'); stEl.innerText='ĐÃ NỘP, CHỜ KÍCH HOẠT'; }
        else { stEl.classList.remove('text-success'); stEl.classList.add('text-danger'); stEl.innerText='CHỜ DUYỆT'; }
        document.getElementById('card-sohoso').innerText = sohoso || '—';

        new bootstrap.Modal(document.getElementById('modalTheBHYT')).show();
      }finally{ hideLoading(); }
    }
    async function saveCardImage(){ const node=document.getElementById('theBHYT'); const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const dataURL=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataURL; a.download='the-bhyt.png'; document.body.appendChild(a); a.click(); a.remove(); }

    function goBack(){ showLoading(); window.location.href='bhyt_giaovien.html'; }

    window.onload = fetchDanhSachDaThu;
  </script>
</body>
</html>
