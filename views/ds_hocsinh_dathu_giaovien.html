<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS học sinh đã tham gia - Giáo viên</title>
  
  <!-- Disable Devtool -->
  <script src="/js/anti-devtools.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;min-height:100vh;padding:20px}
    .sticky-header-box{position:sticky;top:0;z-index:999;background:#f8f9fa;padding-bottom:2px}
    .header{font-size:22px;font-weight:700;margin-bottom:8px;padding-bottom:6px}
    .search-row{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:10px;gap:10px;position:sticky;top:52px;z-index:998;background:#f8f9fa;padding-bottom:4px}
    .search-input{flex:1;min-width:180px}
    .table-hs{background:#fff;border-radius:8px;box-shadow:0 1px 6px #0002}
    .table-responsive{overflow-x:auto}
    .total-count{font-size:1rem;font-weight:400;color:#444}
    th.th-action{min-width:170px}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#f1f1f1}
    .sort-icon{font-size:13px;margin-left:4px;vertical-align:middle}

    .btn-back{position:fixed;bottom:26px;right:20px;z-index:1099;border-radius:50%;width:54px;height:54px;box-shadow:0 2px 14px #0003;font-size:25px;display:flex;align-items:center;justify-content:center;background:#fff;border:2px solid #eee;color:#2563eb}
    .btn-back:hover{box-shadow:0 4px 24px #2563eb33;color:#fff;background:#2563eb}

    @media(max-width:600px){
      .header{font-size:18px}
      th.th-action{min-width:120px}
      .search-row{flex-direction:column;align-items:stretch}
      .action-btns{display:flex;flex-direction:column;gap:6px}
      .action-btns .btn{width:100%}
    }
    @media(min-width:601px){.action-btns{display:flex;flex-direction:row;gap:6px}}

    /* trạng thái */
    .status-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .status-pending{color:#b91c1c;background:#fee2e2}
    .status-paid-wait{color:#b91c1c;background:#ffe4e6}
    .status-active{color:#065f46;background:#d1fae5}
    .hoso-text{display:block;font-size:12px;color:#1d4ed8;margin-top:4px}

    /* khung A5 xem trước */
    .a5-paper{width:148mm;min-height:210mm;background:#fff;margin:0 auto;padding:10mm 12mm;color:#000;box-shadow:0 1px 10px #0002;font-size:13px;line-height:1.35}
    .receipt-title{font-weight:700;font-size:22px;text-transform:uppercase;letter-spacing:.4px}
    .receipt-sub{font-style:italic}
    .receipt-meta{font-size:13px}
    .receipt-line{margin:2mm 0}
    .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .sign-col{text-align:center;margin-top:10mm;font-weight:500}
    .sign-name{margin-top:20mm;text-align:center;font-weight:600}

    @media print{ @page{size:A5 portrait;margin:10mm} .no-print{display:none!important} }

    /* ==== THẺ BHYT – giống mẫu ==== */
  .bhyt-card{
    max-width: 980px;
    margin: 0 auto;
    background:#fff;
    border:8px solid #2d66d5;             /* viền ngoài đậm */
    border-radius:14px;
    padding:6px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);
  }
  .bhyt-inner{
    border:3px solid #2d66d5;             /* viền trong mảnh hơn */
    border-radius:12px;
    padding: 18px 22px 34px;  /* tăng padding-bottom để footer không chạm viền */
  }

  .bhyt-top{
    display:grid;
    grid-template-columns: 120px 1fr 120px;
    align-items:center;
    column-gap:10px;
    margin-bottom:6px;
  }
  .bhyt-logo-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
  .bhyt-logo{
    width:84px; height:84px; border-radius:50%;
    border:4px solid #2d66d5; background:#e6f0ff;
    display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .bhyt-logo img{width:86%;height:86%;object-fit:contain}
  .bhyt-obj{font-weight:800;color:#4b5563;letter-spacing:.5px} /* Đối tượng đóng */

  .bhyt-title{
    text-align:center;
    font-weight:900; color:#ef4444; letter-spacing:1px; font-size:30px;
  }

  /* dòng Mã số, Số định danh */
  .bhyt-ms{ text-align:center; font-weight:800; font-size:30px; margin:4px 0 2px }
  .bhyt-sdd-line{ text-align:center; color:#4b5563; font-weight:700; }
  .bhyt-sdd{ color:#0b53ff; font-weight:900; font-size:22px; margin-left:8px }

  /* cột thông tin chi tiết */
  .bhyt-grid{
    display:grid; grid-template-columns: 1.3fr 1fr; gap:18px; margin-top:8px;
  }
  .bhyt-col .kv{display:flex;gap:12px;margin:6px 0;align-items:flex-start}
  .kv .k{min-width:160px;color:#6b7280;font-weight:800}
  .kv .v{color:#111827;font-weight:800}
  .kv .v.v-blue  { color:#0b53ff !important; }  /* Sử dụng từ: xanh dương */
  .kv .v.v-red   { color:#e11d48 !important; }  /* Ngày hết hạn: đỏ */
  .kv .v.v-green { color:#0f9d58 !important; }  /* Số tiền đóng: xanh lá */

  /* ô lớp to bên phải như “3B” */
  .bhyt-lop-big{
    text-align:right; font-size:44px; font-weight:900; color:#9ca3af;
  }

  .bhyt-footer{display:flex;justify-content:center;gap:16px;margin-top:8px}
  .bhyt-stamp{font-weight:900;color:#16a34a;font-size:28px}
  .bhyt-sohoso{padding:6px 14px;border-radius:6px;background:#fff3b0;border:2px solid #facc15;font-weight:900;color:#1d4ed8;display:inline-block}
  
  
  /* ===== KÍCH THƯỚC THẺ NGANG + SCALE ===== */

  /* Kích thước “gốc” của thẻ (khổ ngang chuẩn). 
    Có thể tinh chỉnh nếu muốn: */
  :root{
    --cardW: 920px;     /* chiều rộng thẻ ở desktop */
    --cardH: 580px;     /* chiều cao thẻ ở desktop  */
  }

  /* Bọc ngoài để scale: */
  #cardScaleWrap{
    position: relative;
    width: var(--cardW);
    height: var(--cardH);
    transform-origin: top left;
    margin: 0 auto;
  }

  /* Ấn định thẻ theo khổ ngang (không bị kéo dãn):
    phần .bhyt-card hiện có ta chỉ thêm width/height */
  .bhyt-card{
    width: var(--cardW);
    height: var(--cardH);
    overflow: hidden; /* đề phòng tràn chữ */
  }

  /* Giữ padding bên trong hợp lý khi thu nhỏ */
  .bhyt-inner{
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* Khi in riêng phần thẻ: ép khổ ngang */
  @media print{
    @page{ size: A6 landscape; margin: 6mm; }
    #cardScaleWrap{ width: 148mm; height: 105mm; transform: none !important; }
    .bhyt-card{ width: 148mm; height: 105mm; }
  }

  

  /* Khi xuất ảnh: bỏ hạn chế chiều cao & nới đáy cho an toàn */
  .bhyt-card.exporting { height:auto !important; overflow:visible !important; }
  .bhyt-card.exporting .bhyt-inner{ padding-bottom:48px !important; }

  /* Giữ font ổn định & spacing khi render ảnh */
  .bhyt-card.exporting, .bhyt-card.exporting *{
    font-family: Arial, "Helvetica Neue", Helvetica, Roboto, system-ui, sans-serif;
    letter-spacing: .2px;
  }


  
  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH ĐÃ THAM GIA BHYT LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row mb-2">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading overlay -->
  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.6);backdrop-filter: blur(1px);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;"><span class="visually-hidden">Loading...</span></div>
  </div>

  <!-- Modal XEM THẺ -->
  <div class="modal fade" id="modalTheBHYT" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thẻ bảo hiểm y tế  </h5>
        <div class="d-flex gap-2 no-print"><button class="btn btn-secondary btn-sm" onclick="downloadCardImage()">Lưu ảnh thẻ</button></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="cardScaleWrap">
          <div id="cardArea" class="bhyt-card">
            <div class="bhyt-inner">
              <div class="bhyt-top">
                <!-- logo + đối tượng đóng (HS, Cận nghèo, ...) -->
                <div class="bhyt-logo-wrap">
                  <div class="bhyt-logo">
                    <!-- đổi đường dẫn logo nếu bạn để file ở nơi khác -->
                    <img id="c-logo" src="../assets/image/bhxh-logo.png" alt="BHXH VN">
                  </div>
                  <div class="bhyt-obj" id="c-doituong">Học sinh</div>
                </div>

                <!-- tiêu đề -->
                <div class="bhyt-title">THẺ BẢO HIỂM Y TẾ</div>

                <!-- hiển thị lớp to (kiểu 3B) -->
                <div class="bhyt-lop-big" id="c-lop-big"> </div>
              </div>

              <!-- Mã số + Số định danh -->
              <div class="bhyt-ms">Mã số: <span id="c-ms">—</span></div>
              <div class="bhyt-sdd-line">Số định danh:<span class="bhyt-sdd" id="c-sdd">—</span></div>

              <!-- Lưới thông tin -->
              <div class="bhyt-grid">
                <div class="bhyt-col">
                  <div class="kv"><div class="k">Họ và tên</div><div class="v" id="c-hoten">—</div></div>
                  <div class="kv"><div class="k">Ngày sinh</div><div class="v" id="c-ngaysinh">—</div></div>
                  <div class="kv"><div class="k">Nơi ĐK KCB BĐ</div><div class="v" id="c-noikham">—</div></div>
                  <div class="kv"><div class="k">Sử dụng từ</div><div class="v v-blue" id="c-tu">—</div></div>
                  <div class="kv"><div class="k">Ngày hết hạn</div><div class="v v-red" id="c-den">—</div></div>
                  <div class="kv"><div class="k">Địa chỉ</div><div class="v" id="c-diachi">—</div></div>
                  <div class="kv"><div class="k">Điện thoại</div><div class="v" id="c-sdt">—</div></div>
                  <div class="kv"><div class="k">Ghi chú</div><div class="v" id="c-ghichu">—</div></div>
                </div>

                <div class="bhyt-col">
                  <div class="kv"><div class="k">Giới tính</div><div class="v" id="c-gioitinh">—</div></div>
                  <div class="kv"><div class="k">Lớp</div><div class="v" id="c-lop">—</div></div>
                  <div class="kv"><div class="k">Số tháng đóng</div><div class="v" id="c-thang">—</div></div>
                  <div class="kv"><div class="k">Số tiền đóng</div><div class="v v-green" id="c-sotien">—</div></div>
                  <div class="kv"><div class="k">Trường</div><div class="v" id="c-truong">—</div></div>
                  <div class="kv"><div class="k">QR</div><div class="v" id="card-qr"></div></div>
                </div>
              </div>

              <div class="bhyt-footer">
                <div class="bhyt-stamp">ĐÃ KÍCH HOẠT</div>
                <div class="bhyt-sohoso" id="c-sohoso">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex gap-2 no-print"><button class="btn btn-secondary btn-sm" onclick="downloadCardImage()">Lưu ảnh thẻ</button></div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xem trước & in Phiếu thu A5 -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5)</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col"><div class="receipt-meta"><div><strong id="rec-school">Trường …</strong></div><div>Lớp: <strong id="rec-class">—</strong></div></div></div>
            <div class="col text-center"><div class="receipt-meta"><div><strong>Mẫu số:</strong> C45-BB</div><div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div><div>ngày 10/10/2017 của Bộ Tài Chính</div></div></div>
          </div>
          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center"><div class="receipt-title">BIÊN LAI THU TIỀN</div><div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div></div>
          </div>
          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">—</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">—</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>
          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small><div class="sign-name" id="rec-teacher-name">—</div></div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== INIT ====== */
    const isMobile=()=>/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let user=JSON.parse(localStorage.getItem("user")||"{}");
    if(!user.sdt||user.phan_quyen!=="giao_vien") location.href="../index.html";
    document.getElementById("lop-hoc").innerText=user.lop_hoc||"(chưa xác định)";

    let pageSize=20,currentPage=1,totalRecords=0,totalPages=1,sortField="ho_ten_hoc_sinh",sortDir=1,allData=[],lastFiltered=[];
    window._viewData=[];

    function showLoading(){document.getElementById('loadingSpinner').style.display='flex'}
    function hideLoading(){document.getElementById('loadingSpinner').style.display='none'}
    function goBack(){showLoading();location.href="bhyt_giaovien.html"}
    function detectPageSize(){const w=innerWidth;if(w<=600)pageSize=5;else if(w<=999)pageSize=10;else pageSize=20}
    addEventListener('resize',()=>{const old=pageSize;detectPageSize();if(old!==pageSize){currentPage=1;renderAllView()}});

    /* ====== API ====== */
    async function getAllBHYT(ma_truong,lop){const u=`${API_BASE}?func=GetDanhSachBHYT&ma_truong=${encodeURIComponent(ma_truong)}&lop_hoc=${encodeURIComponent(lop)}`;const r=await fetch(u);return await r.json()}
    async function getTenTruong(ma_truong){try{const u=`${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;const r=await fetch(u);const j=await r.json();return j?.ten_truong||j?.data?.ten_truong||user.ten_truong||ma_truong||'—'}catch(e){return user.ten_truong||ma_truong||'—'}}

    function displayDate(raw){if(!raw)return"";if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}T/.test(raw))return new Date(raw).toLocaleDateString('vi-VN');if(typeof raw==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(raw)){const [y,m,d]=raw.split('-');return `${d}/${m}/${y}`}return raw}
    function cleanVal(v){const s=String(v??"").trim();return (!s||s==='null'||s==='NULL'||s==='undefined'||s==='NaN'||s==='-')?"":s}
    function getSoHoSo(row){return cleanVal(row.so_ho_so??row.sohoso??row.so_hs)}

    function sortIcon(field){ if(sortField!==field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }

    async function fetchDaThuBHYT(){
      try{
        detectPageSize();showLoading();
        const bhytRes=await getAllBHYT(user.ma_truong,user.lop_hoc);
        const rows=Array.isArray(bhytRes?.data)?bhytRes.data:[];
        allData=rows.filter(r=>r&&r.so_dinh_danh).map(r=>({...r,trang_thai:r.trang_thai===undefined?undefined:Number(r.trang_thai)}));
        currentPage=1;doSearch();
      }catch(e){allData=[];doSearch()}finally{hideLoading()}
    }

    /* ====== Table ====== */
    function statusCell(row){
      const st=Number(row.trang_thai??-1), shs=getSoHoSo(row);
      if (st===0) return `<span class="status-badge status-pending">Chờ duyệt</span>`;
      if (st===1 && !shs) return `<span class="status-badge status-paid-wait">Đã nộp, chờ kích hoạt</span>`;
      if (st===1 && shs) return `<div><span class="status-badge status-active">Đã kích hoạt</span><span class="hoso-text">${escapeHtml(shs)}</span></div>`;
      return `<span class="status-badge status-pending">Đang xử lý</span>`;
    }
    function actionsCell(i,row){
      const st=Number(row.trang_thai??-1),shs=getSoHoSo(row);
      if (st===1 && shs) return `<div class="action-btns"><button class="btn btn-sm btn-info" onclick="onViewCardIdx(${i})">Xem thẻ</button><button class="btn btn-sm btn-primary" onclick="onPrintReceiptIdx(${i})">In phiếu thu</button></div>`;
      return `<div class="action-btns"><button class="btn btn-sm btn-primary" onclick="onPrintReceiptIdx(${i})">In phiếu thu</button></div>`;
    }

    function buildTableHead(){
      return `
        <thead>
          <tr>
            <th class="th-action">Thao tác</th>
            <th>Trạng thái</th>
            <th class="sortable" data-field="ho_ten_hoc_sinh">Họ tên ${sortIcon('ho_ten_hoc_sinh')}</th>
            <th class="sortable" data-field="ngay_sinh">Ngày sinh ${sortIcon('ngay_sinh')}</th>
            <th class="sortable" data-field="so_dinh_danh">Số định danh ${sortIcon('so_dinh_danh')}</th>
            <th>Nơi khám</th>
            <th class="sortable" data-field="so_thang_dong">Số tháng đóng ${sortIcon('so_thang_dong')}</th>
            <th class="sortable" data-field="han_su_dung_bhyt_moi">Hạn mới ${sortIcon('han_su_dung_bhyt_moi')}</th>
          </tr>
        </thead>`;
    }

    function attachSortHandlers(){
      document.querySelectorAll('th.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const field = th.getAttribute('data-field');
          if (!field) return;
          if (sortField === field) sortDir = -sortDir; else { sortField = field; sortDir = 1; }
          renderAllView();  // re-render & update icon
        }, {once:false});
      });
    }

    function renderDanhSachHS(ds,startIdx){
      if(!ds||ds.length===0){document.getElementById('ds-container').innerHTML=`<div class='text-center text-secondary mt-4'>Không có hồ sơ BHYT trong lớp này.</div>`;return}
      const thead = buildTableHead();
      const rows=ds.map((r,i)=>{
        const iView=startIdx+i,hanMoi=displayDate(r.han_su_dung_bhyt_moi||r.ngay_het_han_bhyt_moi||"");
        return `<tr>
          <td>${actionsCell(iView,r)}</td>
          <td>${statusCell(r)}</td>
          <td>${escapeHtml(r.ho_ten_hoc_sinh||"")}</td>
          <td>${escapeHtml(displayDate(r.ngay_sinh)||"")}</td>
          <td>${escapeHtml(r.so_dinh_danh||"")}</td>
          <td>${escapeHtml(r.noi_kham_bhyt||"")}</td>
          <td class="text-center">${escapeHtml((r.so_thang_dong||"").toString())}</td>
          <td>${escapeHtml(hanMoi)}</td>
        </tr>`;
      }).join('');
      document.getElementById('ds-container').innerHTML=`<table class="table table-bordered table-hs align-middle">${thead}<tbody>${rows}</tbody></table>`;
      attachSortHandlers(); // <= kích hoạt sort sau mỗi lần render
    }

    function renderPagination(){
      const el=document.getElementById('pagination');let html='';if(totalPages<=1){el.innerHTML='';return}
      const add=(p,lab,act=false,dis=false)=>`<li class="page-item ${act?'active':''} ${dis?'disabled':''}"><a class="page-link" href="javascript:void(0)" onclick="gotoPage(${p})">${lab}</a></li>`;
      html+=add(Math.max(1,currentPage-1),'&laquo;',false,currentPage===1);
      for(let i=1;i<=totalPages;i++) html+=add(i,i,i===currentPage,false);
      html+=add(Math.min(totalPages,currentPage+1),'&raquo;',false,currentPage===totalPages);
      el.innerHTML=html;
    }
    function gotoPage(p){if(p<1||p>totalPages) return; currentPage=p; renderAllView()}
    function doSearch(){const q=document.getElementById('search-box').value.trim().toLowerCase();lastFiltered=!q?allData:allData.filter(h=> (h.ho_ten_hoc_sinh||"").toLowerCase().includes(q)||(displayDate(h.ngay_sinh)||"").toLowerCase().includes(q)||(h.so_dinh_danh||"").toLowerCase().includes(q)||(h.noi_kham_bhyt||"").toLowerCase().includes(q));currentPage=1;renderAllView()}
    function renderAllView(){let data=lastFiltered||allData;if(sortField){data=[...data].sort((a,b)=>{let av=(a[sortField]??"").toString().toLowerCase(),bv=(b[sortField]??"").toString().toLowerCase();if(!isNaN(+av)&&!isNaN(+bv)){av=+av;bv=+bv}return av<bv?-sortDir:av>bv?sortDir:0})}window._viewData=data;totalRecords=data.length;totalPages=Math.max(1,Math.ceil(totalRecords/pageSize));document.getElementById('total-hs').innerText=`(${totalRecords} hồ sơ)`;const start=(currentPage-1)*pageSize;renderDanhSachHS(data.slice(start,start+pageSize),start);renderPagination()}

    /* ====== Actions (Xem thẻ / In) – kèm loading ====== */
    function onViewCardIdx(i){const row=window._viewData[i]; if(!row) return; showLoading(); setTimeout(()=>onViewCard(row), 50);}
    function onPrintReceiptIdx(i){const row=window._viewData[i]; if(!row) return; showLoading(); setTimeout(()=>onPrintReceipt(row), 50);}

    function parseDate(s){if(!s)return null;if(typeof s==='string'&&/^\d{2}\/\d{2}\/\d{4}$/.test(s)){const [d,m,y]=s.split('/').map(Number);return new Date(y,m-1,d)}if(typeof s==='string'&&/^\d{4}-\d{2}-\d{2}/.test(s))return new Date(s);return null}
    function formatDateVN2(d){const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');const yy=d.getFullYear();return `${dd}/${mm}/${yy}`}
    function makeRange(row){const end=row.han_su_dung_bhyt_moi||row.ngay_het_han_bhyt_moi||"";const months=Number(row.so_thang_dong||0);const e=parseDate(end);if(!e||!months)return{tu:"",den:""};const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);return {tu:formatDateVN2(s),den:formatDateVN2(e)}}

    function onViewCard(row){
      const LOGO_BHXH = "../assets/image/bhxh-logo.png"; // đổi đường dẫn nếu cần
      const doiTuong = cleanVal(row.doi_tuong_dong) || "Học sinh";
      const sohoso=getSoHoSo(row)||"—";
      const lop=user.lop_hoc||row.lop_hoc||"—";
      const thang=cleanVal(row.so_thang_dong)||"—";
      const soTien=cleanVal(row.so_tien)||"";
      const gioiTinh=cleanVal(row.gioi_tinh)||"";
      const sdt=cleanVal(row.sdt_lienhe||row.sdt||"");
      const ghichu=cleanVal(row.ghi_chu||"");
      const {tu,den}=makeRange(row);

      getTenTruong(user.ma_truong).then(truong=>{
        // Điền dữ liệu vào card theo mẫu
        document.getElementById('c-logo').src = LOGO_BHXH;
        document.getElementById('c-ms').innerText = row.ma_so_bhxh || '—';
        document.getElementById('c-sdd').innerText = row.so_dinh_danh || '—';
        document.getElementById('c-doituong').innerText = doiTuong;
        document.getElementById('c-hoten').innerText = row.ho_ten_hoc_sinh || '—';
        document.getElementById('c-ngaysinh').innerText = displayDate(row.ngay_sinh)||'—';
        document.getElementById('c-noikham').innerText = row.noi_kham_bhyt || '—';
        document.getElementById('c-tu').innerText = tu || '—';
        document.getElementById('c-den').innerText = den || '—';
        document.getElementById('c-diachi').innerText = cleanVal(row.dia_chi) || '—';
        document.getElementById('c-sdt').innerText = sdt || '—';
        document.getElementById('c-ghichu').innerText = ghichu || '—';
        document.getElementById('c-gioitinh').innerText = gioiTinh || '—';
        document.getElementById('c-lop').innerText = lop;
        document.getElementById('c-lop-big').innerText = lop;   // <-- thêm dòng này
        document.getElementById('c-thang').innerText = thang;
        document.getElementById('c-sotien').innerText = soTien ? Number(String(soTien).replace(/[^\d]/g,'')||0).toLocaleString('vi-VN') : '—';
        document.getElementById('c-truong').innerText = truong;
        document.getElementById('c-sohoso').innerText = sohoso;

        const el=document.getElementById('card-qr');el.innerHTML="";
        new QRCode(el,{text:JSON.stringify({so_ho_so:sohoso,so_dinh_danh:row.so_dinh_danh||""}),width:80,height:80,correctLevel:QRCode.CorrectLevel.L});

        const m=new bootstrap.Modal(document.getElementById('modalTheBHYT'));
        m.show(); hideLoading();
      }).catch(()=>hideLoading());
    }

    /* Tính scale để thẻ luôn vừa khung hiển thị (desktop/mobile) */
    function scaleCardToViewport(){
      const wrap = document.getElementById('cardScaleWrap');
      if(!wrap) return;

      const W = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardW')) || 920;
      const H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cardH')) || 560;

      const modalBody = document.querySelector('#modalTheBHYT .modal-body');
      const pad = 24;
      const vw = Math.max(320, modalBody.clientWidth  - pad);
      const vh = Math.max(240, modalBody.clientHeight - pad);

      const s = Math.min(vw / W, vh / H);
      wrap.style.transform = `scale(${s})`;
      wrap.style.marginBottom = '0px';        // <-- thay vì (H*(s-1)) gây âm
    }


    /* Khi modal show: scale 1 lần, sau đó lắng nghe resize để scale lại */
    document.getElementById('modalTheBHYT')?.addEventListener('shown.bs.modal', () => {
      setTimeout(scaleCardToViewport, 10);
      window.addEventListener('resize', scaleCardToViewport);
    });

    /* Khi đóng modal: bỏ listener */
    document.getElementById('modalTheBHYT')?.addEventListener('hidden.bs.modal', () => {
      window.removeEventListener('resize', scaleCardToViewport);
    });






    /* ====== QR & In phiếu thu (giữ nguyên cơ chế đã chạy tốt) ====== */
    function stripVN(s){return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D')}
    function initials(str){return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase()}
    function buildQRPayload(mt,school,cls,name,months,endDate){const _mt=String(mt||"").slice(0,24),s=stripVN(school).slice(0,60),c=String(cls||"").slice(0,12),n=stripVN(name).slice(0,60),m=String(months||""),e=String(endDate||"").slice(0,10);return `MT=${_mt};S=${s};L=${c};N=${n};M=${m};E=${e}`}
    function toVND(n){return Number(n||0).toLocaleString('vi-VN')}
    const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
    function readTriple(n){let tr=Math.floor(n/100),ch=Math.floor((n%100)/10),dv=n%10,s="";if(tr>0){s+=VI_DIGITS[tr]+" trăm";if(ch==0&&dv>0)s+=" lẻ"}if(ch>1){s+=(s?" ":"")+VI_DIGITS[ch]+" mươi";if(dv==1)s+=" mốt";else if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==1){s+=(s?" ":"")+"mười";if(dv==5)s+=" lăm";else if(dv>0)s+=" "+VI_DIGITS[dv]}else if(ch==0&&dv>0){s+=(s?" ":"")+VI_DIGITS[dv]}return s.trim()}
    function numberToVietnamese(n){n=Math.round(Number(n)||0);if(n===0)return"Không đồng";const u=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"];let i=0,str="";while(n>0&&i<u.length){const b=n%1000;if(b>0){const p=readTriple(b);str=p+u[i]+(str?" "+str:"")}n=Math.floor(n/1000);i++}return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim()}
    function todayText(){const d=new Date();return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`}

    function onPrintReceipt(row){
      const after=()=>{new bootstrap.Modal(document.getElementById('modalPhieuThu')).show(); hideLoading();}
      getTenTruong(user.ma_truong).then(truong=>{
        const lop=row.lop_hoc||user.lop_hoc||"—";
        const months=parseInt(row.so_thang_dong||"12",10);
        const amount=parseInt((row.so_tien||"0").toString().replace(/[^\d]/g,''),10)||0;
        const end=row.han_su_dung_bhyt_moi||row.ngay_het_han_bhyt_moi||"";
        const e=parseDate(end);
        let startText="—",endText="(không xác định)";
        if(e&&months>0){const s=new Date(e.getFullYear(),e.getMonth()-months,e.getDate()+1);startText=formatDateVN2(s);endText=formatDateVN2(e)}
        document.getElementById('rec-school').innerText=truong;
        document.getElementById('rec-class').innerText=lop;
        document.getElementById('rec-date-today').innerText=todayText();
        document.getElementById('rec-student-name').innerText=row.ho_ten_hoc_sinh||"";
        document.getElementById('rec-address').innerText=row.dia_chi||"";
        document.getElementById('rec-content').innerText=`Thu tiền BHYT - ${lop}`;
        document.getElementById('rec-months').innerText=String(months);
        document.getElementById('rec-range').innerText=`từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText=toVND(amount);
        document.getElementById('rec-amount-text').innerText=numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText=user.ho_ten||"(Giáo viên)";
        const qrBox=document.getElementById('receipt-qr');qrBox.innerHTML="";
        const text=buildQRPayload(user.ma_truong,truong,lop,row.ho_ten_hoc_sinh||"",months,endText);
        try{new QRCode(qrBox,{text,width:90,height:90,correctLevel:QRCode.CorrectLevel.L})}
        catch(e2){const fb=`MT=${String(user.ma_truong).slice(0,24)};L=${String(lop).slice(0,12)};N=${initials(row.ho_ten_hoc_sinh)};M=${months};E=${endText}`;try{new QRCode(qrBox,{text:fb,width:90,height:90,correctLevel:QRCode.CorrectLevel.L})}catch(_){qrBox.innerHTML='<small>QR quá dài</small>'}}
        after();
      }).catch(()=>hideLoading());
    }

    async function downloadCardImage(){
      try{
        showLoading();

        // Lấy kích thước gốc theo cấu hình (chỉ để set chiều rộng)
        const W = parseFloat(getComputedStyle(document.documentElement)
                    .getPropertyValue('--cardW')) || 920;

        // Clone #cardArea sang offscreen, KHÔNG transform & KHÔNG khóa chiều cao
        const src   = document.getElementById('cardArea');
        const clone = src.cloneNode(true);
        clone.id = 'cardExport';
        clone.classList.add('exporting'); // áp CSS exporting ở trên
        Object.assign(clone.style, {
          position:'fixed',
          left:'-10000px', top:'0',
          width: W + 'px',
          height: 'auto',            // ← không cố định chiều cao
          transform:'none',
          overflow:'visible',        // ← không cắt nội dung đáy
          background:'#ffffff',
          zIndex:'-1'
        });
        document.body.appendChild(clone);

        // Chờ layout ổn định rồi chụp, tăng scale cho nét
        await new Promise(r=>setTimeout(r, 20));
        const canvas = await html2canvas(clone, {
          scale: 3,
          backgroundColor: '#ffffff',
          useCORS: true
        });

        document.body.removeChild(clone);

        const a = document.createElement('a');
        a.download = 'the-bhyt.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      } finally {
        hideLoading();
      }
    }

    async function downloadReceiptImage(){ showLoading(); const node=document.getElementById('receiptA5');const canvas=await html2canvas(node,{scale:2,backgroundColor:'#fff'});const a=document.createElement('a');a.download='phieu-thu-bhyt.png';a.href=canvas.toDataURL('image/png');a.click(); hideLoading();}

    // CSS nhúng cho cửa sổ in riêng
    function getReceiptPrintCSS(){return `
      <style>
        @page{size:A5 portrait;margin:10mm}
        html,body{background:#fff;margin:0;padding:0}
        .a5-paper{width:148mm;min-height:210mm;background:#fff;color:#000;margin:0 auto;padding:10mm 12mm;line-height:1.35;font-size:13px}
        .receipt-title{font-weight:700;font-size:20px;text-transform:uppercase;letter-spacing:.4px}
        .receipt-sub{font-style:italic}.receipt-meta{font-size:13px}.receipt-line{margin:2mm 0}
        .qr-box{width:26mm;height:26mm;border:1px solid #000;display:flex;align-items:center;justify-content:center;margin:0 auto}
        .sign-col{text-align:center;margin-top:10mm;font-weight:500}.sign-name{margin-top:20mm;text-align:center;font-weight:600}
        .row{display:flex;flex-wrap:nowrap;width:100%}.col{flex:1 1 0}.text-center{text-align:center}
      </style>`}

    // In CHỈ phần phiếu: clone node, convert QR -> IMG, chờ ảnh load rồi print
    function printReceiptOnly(){
      const src=document.getElementById('receiptA5'); if(!src) return;
      const clone=src.cloneNode(true);
      const live=src.querySelector('#receipt-qr canvas, #receipt-qr img');
      if(live){
        try{
          const dataURL=(live.tagName.toLowerCase()==='canvas')?live.toDataURL('image/png'):live.src;
          const target=clone.querySelector('#receipt-qr'); target.innerHTML='';
          const img=document.createElement('img'); img.src=dataURL; img.width=90; img.height=90; target.appendChild(img);
        }catch(e){}
      }
      const w=window.open('','_blank','width=900,height=650'); if(!w){ alert('Trình duyệt đang chặn popup in. Hãy cho phép rồi thử lại.'); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>In phiếu thu</title>${getReceiptPrintCSS()}</head><body>${clone.outerHTML}</body></html>`);
      w.document.close();
      const triggerPrint=()=>{ try{ w.focus(); w.print(); setTimeout(()=>{try{w.close()}catch(_){}},500); }catch(e){} };
      w.onload=()=>{ try{ const imgs=w.document.images; if(!imgs||imgs.length===0){ setTimeout(triggerPrint,200); return; } let loaded=0; const done=()=>{ if(++loaded>=imgs.length) triggerPrint(); }; for(const img of imgs){ if(img.complete) done(); else { img.onload=done; img.onerror=done; } } setTimeout(triggerPrint,1500); }catch(e){ triggerPrint(); } };
    }

    function escapeHtml(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}

    (async function(){ await fetchDaThuBHYT(); })();
  </script>
</body>
</html>
