<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DS học sinh chưa tham gia BHTN - Giáo viên</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f8f9fa; min-height:100vh; padding:20px; }
    .sticky-header-box{ position:sticky; top:0; z-index:999; background:#f8f9fa; padding-bottom:6px; }
    .header{ font-size:22px; font-weight:700; margin-bottom:8px; }
    .search-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; position:sticky; top:46px; z-index:998; background:#f8f9fa; padding:4px 0; }
    .search-input{ flex:1; min-width:180px; }
    .table-hs{ background:#fff; border-radius:8px; box-shadow:0 1px 6px #0002; }
    .table-responsive{ overflow-x:auto; }
    .total-count{ color:#444; font-weight:400; }
    th.th-action{ min-width:170px; }
    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable:hover{ background:#f1f1f1; }
    .sort-icon{ font-size:15px; vertical-align:middle; margin-left:3px; }
    .btn-back{
      position:fixed; bottom:26px; right:20px; z-index:1099;
      width:54px; height:54px; border-radius:50%;
      background:#fff; border:2px solid #eee; color:#2563eb; font-size:25px;
      display:flex; align-items:center; justify-content:center; box-shadow:0 2px 14px #0003;
    }
    .btn-back:hover{ box-shadow:0 4px 24px #2563eb33; color:#fff; background:#2563eb; }

    @media (max-width:600px){
      .header{ font-size:18px; }
      th.th-action{ min-width:120px; }
      .search-row{ flex-direction:column; align-items:stretch; }
      .action-btns{ display:flex; flex-direction:column; gap:6px; }
      .action-btns .btn{ width:100%; }
    }
    @media (min-width:601px){
      .action-btns{ display:flex; flex-direction:row; gap:4px; }
    }

    /* A5 preview (biên lai) — giữ nguyên style cốt lõi, chỉ đổi text sang BHTN */
    .a5-paper{ width:148mm; min-height:210mm; background:#fff; margin:0 auto; padding:10mm 12mm; color:#000; box-shadow:0 1px 10px #0002; font-size:13px; line-height:1.35; }
    .receipt-title{ font-weight:700; font-size:22px; text-transform:uppercase; letter-spacing:.4px; }
    .receipt-sub{ font-style:italic; }
    .receipt-meta{ font-size:13px; }
    .receipt-line{ margin:2mm 0; }
    .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
    .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
    .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }

    @media print{
      @page{ size:A5 portrait; margin:10mm; }
      body{ background:#fff!important; }
      .modal{ position:static!important; }
      .modal-content{ box-shadow:none!important; border:none!important; }
      .no-print{ display:none!important; }
      .a5-paper{ box-shadow:none!important; margin:0!important; }
    }

    /* In ngay trong cùng cửa sổ (không mở tab mới) */
    #printArea{ display:none; }

    /* Khi kích hoạt in, chỉ hiển thị printArea */
    body.print-active > *:not(#printArea){ display:none !important; }
    body.print-active #printArea{ display:block !important; }

    @media print{
      body.print-active > *:not(#printArea){ display:none !important; }
      body.print-active #printArea{ display:block !important; }

      /* Giữ nguyên layout và thông số in A5 như cũ */
      @page{ size:A5 portrait; margin:10mm; }
      .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000; margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px; }
      .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
      .receipt-sub{ font-style:italic; }
      .receipt-meta{ font-size:13px; }
      .receipt-line{ margin: 2mm 0; }
      .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
      .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
      .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
      .row{ display:flex; flex-wrap:nowrap; width:100%; }
      .col{ flex:1 1 0; }
      .text-center{ text-align:center; }
    }

  </style>
</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH CHƯA THAM GIA BHTN LỚP <span id="lop-hoc">—</span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div class="search-row">
      <input class="form-control search-input" id="search-box" placeholder="Tìm theo tên, ngày sinh, số định danh..." oninput="doSearch()">
      <button id="btn-bulk-submit" class="btn btn-primary" onclick="showBulkNopHoSoModal()" style="display:none;">Nộp nhiều hồ sơ</button>
    </div>
  </div>

  <div class="table-responsive" id="ds-container"></div>
  <nav><ul class="pagination justify-content-center" id="pagination"></ul></nav>

  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <!-- Loading -->
  <div id="loadingSpinner" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Modal Nộp Hồ Sơ BHTN -->
  <div class="modal fade" id="modalNopHoSoBHTN" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nộp hồ sơ BHTN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="nhs-hoten" readonly></div>
        <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="nhs-ngaysinh" readonly></div>

        <!-- BHTN: số tháng cố định 12 -->
        <div class="mt-2 small">
          <div><strong>Số tháng đóng:</strong> 12 tháng</div>
          <div><strong>Hạn sử dụng dự kiến:</strong> <span id="nhs-exp-preview" class="fw-bold text-danger">—</span></div>
          <div id="nhs-exp-note" class="text-muted" style="min-height:18px"></div>
          <div><strong>Số tiền cần đóng (12T):</strong> <span id="nhs-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>

        <!-- ✅ ĐỐI TƯỢNG ĐÓNG: THÊM MỚI -->
        <div class="mt-3">
          <label class="fw-semibold d-block mb-2">Đối tượng đóng:</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="nhs-doi-tuong" id="nhs-dt-hocsinh" value="Học sinh" checked>
            <label class="form-check-label" for="nhs-dt-hocsinh">Học sinh</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="nhs-doi-tuong" id="nhs-dt-can-ngheo" value="Cận nghèo">
            <label class="form-check-label" for="nhs-dt-can-ngheo">Cận nghèo</label>
          </div>
        </div>

        <div id="nhs-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" id="btnNopHoSo" onclick="submitNopHoSoBHTN()">Nộp hồ sơ</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Sửa Hồ Sơ BHTN -->
  <div class="modal fade" id="modalSuaHoSoBHTN" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Sửa hồ sơ BHTN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><label>Họ tên học sinh:</label><input class="form-control" id="shs-hoten" readonly></div>
        <div class="mb-2"><label>Ngày sinh:</label><input class="form-control" id="shs-ngaysinh" readonly></div>

        <!-- BHTN: số tháng cố định 12 -->
        <div class="mt-2 small">
          <div><strong>Số tháng đóng:</strong> 12 tháng</div>
          <div><strong>Hạn sử dụng dự kiến:</strong> <span id="shs-exp-preview" class="fw-bold text-danger">—</span></div>
          <div id="shs-exp-note" class="text-muted" style="min-height:18px"></div>
          <div><strong>Số tiền cần đóng (12T):</strong> <span id="shs-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>

        <!-- ✅ ĐỐI TƯỢNG ĐÓNG (SỬA): THÊM MỚI -->
        <div class="mt-3">
          <label class="fw-semibold d-block mb-2">Đối tượng đóng:</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="shs-doi-tuong" id="shs-dt-hocsinh" value="Học sinh" checked>
            <label class="form-check-label" for="shs-dt-hocsinh">Học sinh</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="shs-doi-tuong" id="shs-dt-can-ngheo" value="Cận nghèo">
            <label class="form-check-label" for="shs-dt-can-ngheo">Cận nghèo</label>
          </div>
        </div>

        <div id="shs-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="submitSuaHoSoBHTN()">Lưu thay đổi</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Nộp Nhiều Hồ Sơ BHTN -->
  <div class="modal fade" id="modalBulkNopHoSo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nộp nhiều hồ sơ BHTN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><div><b>Đã chọn:</b> <span id="bulk-count-label">0</span> học sinh</div></div>
        <div class="mt-2 small">
          <div><strong class="text-danger">Số tháng đóng:</strong> 12 tháng</div>
          <div><strong class="text-danger">Hạn sử dụng dự kiến (mẫu 1 HS):</strong> <span id="bulk-exp-preview" class="fw-bold text-danger">—</span></div>
          <div id="bulk-exp-note" class="text-muted" style="min-height:18px"></div>
          <div><strong class="text-danger">Số tiền cần đóng (mỗi HS, 12T):</strong> <span id="bulk-amount-preview" class="fw-bold text-danger">—</span></div>
        </div>
        <div id="bulk-error" class="text-danger" style="min-height:18px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" id="btnBulkNop" onclick="submitBulkNopHoSo()">Nộp nhiều hồ sơ</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xem trước & in Phiếu thu A5 (BHTN) -->
  <div class="modal fade" id="modalPhieuThu" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xem trước phiếu thu (A5) – BHTN</h5>
        <div class="no-print d-flex gap-2">
          <button class="btn btn-secondary btn-sm" onclick="downloadReceiptImage()">Lưu ảnh</button>
          <button class="btn btn-primary btn-sm" onclick="printReceiptOnly()">In</button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="display:flex;justify-content:center;">
        <div id="receiptA5" class="a5-paper">
          <div class="row">
            <div class="col">
              <div class="receipt-meta">
                <div><strong id="rec-school">Trường …</strong></div>
                <div>Lớp: <strong id="rec-class">—</strong></div>
              </div>
            </div>
            <div class="col text-center">
              <div class="receipt-meta">
                <div><strong>Mẫu số:</strong> C45-BB</div>
                <div>Ban hành kèm Thông tư số 107/2017/TT-BTC</div>
                <div>ngày 10/10/2017 của Bộ Tài Chính</div>
              </div>
            </div>
          </div>

          <div class="row align-items-center mt-3">
            <div class="col-4" style="max-width:36mm;"><div class="qr-box"><div id="receipt-qr"></div></div></div>
            <div class="col text-center">
              <div class="receipt-title">BIÊN LAI THU TIỀN</div>
              <div class="receipt-sub" id="rec-date-today">Ngày … tháng … năm …</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="receipt-line">Họ và tên học sinh: <strong id="rec-student-name">—</strong></div>
            <div class="receipt-line">Địa chỉ: <span id="rec-address">—</span></div>
            <div class="receipt-line">Nội dung thu: <span id="rec-content">Thu tiền BHTN</span></div>
            <div class="receipt-line">Số tháng đóng: <span id="rec-months">12</span> tháng (<span id="rec-range">từ ngày … đến ngày …</span>)</div>
            <div class="receipt-line">Số tiền thu: <strong id="rec-amount">—</strong> VNĐ</div>
            <div class="receipt-line"><em>Viết bằng chữ:</em> <strong id="rec-amount-text">—</strong>.</div>
          </div>

          <div class="row">
            <div class="col sign-col">NGƯỜI NỘP TIỀN<br><small>(Ký và ghi rõ họ tên)</small></div>
            <div class="col sign-col">NGƯỜI THU TIỀN<br><small>(Ký và ghi rõ họ tên)</small>
              <div class="sign-name" id="rec-teacher-name">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer no-print">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-outline-secondary" onclick="downloadReceiptImage()">Lưu ảnh</button>
        <button class="btn btn-primary" onclick="printReceiptOnly()">In</button>
      </div>
    </div></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="success-toast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toast-message">Thành công!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>




  <div id="printArea"></div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="../js/api.js"></script>

  <script>
    /* ====== State & guards ====== */
    const logPrefix = '[BHTN-ChuaThu]';
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    let pageSize = 20, currentPage = 1, totalRecords = 0, totalPages = 1, sortField = "ho_ten_hoc_sinh", sortDir = 1;
    let allData = [], lastFiltered = [];
    function showLoading(){ document.getElementById('loadingSpinner').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingSpinner').style.display='none'; }
    function goBack(){ showLoading(); window.location.href = "bhtn_giaovien.html"; }

    /* ====== Helpers ====== */
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    function displayNgaySinh(raw){
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) return new Date(raw).toLocaleDateString('vi-VN');
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) { const [y,m,d]=raw.split('-'); return `${d}/${m}/${y}`; }
      return raw;
    }
    function parseVNDate(str){ const m=String(str||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const d=new Date(+m[3],+m[2]-1,+m[1]); return (d.getFullYear()==+m[3] && d.getMonth()==+m[2]-1 && d.getDate()==+m[1]) ? d : null; }
    function formatVNDate(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function addDaysExact(dateObj, days){ const d=new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12,0,0); d.setDate(d.getDate()+days); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function todayText(){ const d=new Date(); return `Ngày ${String(d.getDate()).padStart(2,'0')} tháng ${String(d.getMonth()+1).padStart(2,'0')} năm ${d.getFullYear()}`; }

    function detectPageSize(){
      const width = window.innerWidth;
      if (width <= 600) pageSize = 3;
      else if (width <= 999) pageSize = 7;
      else pageSize = 20;
    }
    window.addEventListener('resize', () => {
      const prev = pageSize; detectPageSize();
      if (pageSize !== prev) { currentPage = 1; window.renderAllView(); }
    });

    /* ====== API phụ: lấy tên trường (tuỳ chọn) ====== */
    async function getTenTruong(ma_truong) {
      try {
        const url = `${API_BASE}?func=GetTenTruong&ma_truong=${encodeURIComponent(ma_truong)}`;
        const res = await fetch(url);
        const j = await res.json();
        return j?.ten_truong || j?.data?.ten_truong || user.ten_truong || ma_truong || '—';
      } catch(e){ return user.ten_truong || ma_truong || '—'; }
    }

    /* ====== Fetch dữ liệu: HS chưa tham gia BHTN ====== */
    async function fetchChuaThuHocsinh() {
      try {
        detectPageSize(); showLoading();
        // 1) Toàn bộ học sinh của lớp
        const allHSRes = await getAllDanhSachHocsinh(user.ma_truong, user.lop_hoc);
        const hsList = (allHSRes && allHSRes.success && Array.isArray(allHSRes.data)) ? allHSRes.data : [];

        // 2) Danh sách BHTN (để map trạng thái)
        const bhtnRes = await getDanhSachBHTN(user.ma_truong, user.lop_hoc);
        const dsBHTN = Array.isArray(bhtnRes?.data) ? bhtnRes.data : [];
        const bhtnMap = {};
        dsBHTN.forEach(row => {
          const key = String(row.so_dinh_danh).replace(/^'/,'').trim();
          const st = Number(String(row.trang_thai).replace(/^'/,'').trim());
          bhtnMap[key] = isNaN(st) ? undefined : st;
        });

        // 3) Merge & filter ra HS chưa đóng (trang_thai != 1)
        allData = hsList.map(hs => {
          const trangThai = bhtnMap[hs.so_dinh_danh];
          return { ...hs, _bhtn_trangthai: (trangThai === undefined ? undefined : Number(trangThai)), trang_thai: trangThai };
        }).filter(hs => hs._bhtn_trangthai !== 1);

        currentPage = 1; doSearch();
      } catch (e) {
        console.error(logPrefix, 'fetchChuaThuHocsinh error', e);
      } finally { hideLoading(); }
    }

    /* ====== Tìm kiếm / sắp xếp / phân trang ====== */
    function doSearch(){
      let q = document.getElementById('search-box').value.trim().toLowerCase();
      lastFiltered = !q ? allData : allData.filter(hs =>
        (hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q) ||
        (displayNgaySinh(hs.ngay_sinh)||"").toLowerCase().includes(q) ||
        (hs.so_dinh_danh||"").toLowerCase().includes(q)
      );
      currentPage = 1; window.renderAllView();
    }
    function sortIcon(field){ if (sortField !== field) return ''; return sortDir===1?'<span class="sort-icon">&#9650;</span>':'<span class="sort-icon">&#9660;</span>'; }
    window.doSort = function(field){ if (sortField===field) sortDir=-sortDir; else { sortField=field; sortDir=1; } window.renderAllView(); };

    window.renderAllView = function(){
      try{
        let dataToShow = lastFiltered || allData;
        if (sortField){
          dataToShow = [...dataToShow].sort((a,b) => {
            let av = (a[sortField]||"").toString().toLowerCase(), bv=(b[sortField]||"").toString().toLowerCase();
            if (!isNaN(av) && !isNaN(bv)) { av=Number(av); bv=Number(bv); }
            if (av < bv) return -sortDir; if (av > bv) return sortDir; return 0;
          });
        }
        totalRecords = dataToShow.length;
        totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
        document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
        const start = (currentPage-1)*pageSize;
        renderDanhSachHS(dataToShow.slice(start, start+pageSize));
        renderPagination();
      }catch(e){ console.error(logPrefix, 'renderAllView error', e); }
    };

    function renderPagination(){
      const el = document.getElementById('pagination'); el.innerHTML='';
      if (totalPages<=1) return;
      el.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP = Math.max(1, currentPage-2), maxP = Math.min(totalPages, currentPage+2);
      if (minP>1) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP>2) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p=minP;p<=maxP;p++) el.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      if (maxP<totalPages-1) el.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP<totalPages) el.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      el.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function(p){ if (p<1||p>totalPages||p===currentPage) return; currentPage=p; window.renderAllView(); };

    /* ====== Bảng danh sách ====== */
    function renderDanhSachHS(ds){
      if (!ds || ds.length===0){
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Không có học sinh chưa tham gia BHTN trong lớp này.</div>`;
        return;
      }
      let html = `<table class="table table-bordered table-hs align-middle"><thead>
        <tr>
          <th style="width:42px;"><input type="checkbox" id="chk-bulk-all" onchange="toggleSelectAllBulk(this)"></th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên học sinh${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh cá nhân${sortIcon('so_dinh_danh')}</th>
        </tr>
      </thead><tbody>`;
      ds.forEach(hs => {
        if (hs._bhtn_trangthai === 1) return; // đã tham gia
        const hasOld = !!parseVNDate(hs.ngay_het_han_bhtn);
        const nopDisabled = (hs._bhtn_trangthai===0) || !hasOld;
        const nopLabel = (hs._bhtn_trangthai===0) ? "Chờ duyệt" : (!hasOld ? "Thiếu hạn cũ" : "Nộp hồ sơ");
        html += `<tr>
          <td><input type="checkbox" class="chk-bulk-row" data-stt="${hs.stt}" onchange="onSelectRowBulk('${hs.stt}', this)" ${hs._bhtn_trangthai===0?'disabled':''}></td>
          <td>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="showNopHoSoModal('${hs.stt}')" ${nopDisabled?'disabled':''}>${nopLabel}</button>
              ${(hs._bhtn_trangthai===0 || hs._bhtn_trangthai===1) ? `
                <button class="btn btn-warning btn-sm" onclick="suaHoSo('${hs.stt}')">Sửa hồ sơ</button>
                <button class="btn btn-primary btn-sm" onclick="inPhieuThu('${hs.stt}')">In phiếu thu</button>` : ``}
              ${!hasOld ? '<div class="text-danger small mt-1">Chưa có ngày hết hạn cũ (BHTN)</div>' : ''}
            </div>
          </td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('ds-container').innerHTML = html;

      document.querySelectorAll('.chk-bulk-row').forEach(cb => {
        const stt = cb.getAttribute('data-stt');
        if (bulkSelected.indexOf(stt)!==-1 && !cb.disabled) cb.checked = true;
      });
      updateBulkButton();
    }

    /* ====== Bulk chọn / nộp ====== */
    let bulkSelected = [];
    function onSelectRowBulk(stt, el){ if (el.checked){ if (bulkSelected.indexOf(stt)===-1) bulkSelected.push(stt); } else { bulkSelected = bulkSelected.filter(x=>x!==stt); const allCb=document.getElementById('chk-bulk-all'); if(allCb) allCb.checked=false; } updateBulkButton(); }
    function toggleSelectAllBulk(el){
      document.querySelectorAll('.chk-bulk-row').forEach(cb=>{
        if (cb.disabled) return;
        cb.checked = el.checked;
        const stt = cb.getAttribute('data-stt');
        if (el.checked){ if (bulkSelected.indexOf(stt)===-1) bulkSelected.push(stt); } else { bulkSelected = bulkSelected.filter(x=>x!==stt); }
      }); updateBulkButton();
    }
    function getSelectedRowsData(){ const map={}; allData.forEach(h=>{ map[String(h.stt)] = h;}); return bulkSelected.map(stt=>map[String(stt)]).filter(Boolean).filter(hs => !(hs._bhtn_trangthai===0 || hs._bhtn_trangthai===1)); }
    function updateBulkButton(){ const btn=document.getElementById('btn-bulk-submit'); const count=getSelectedRowsData().length; if (!btn) return; if (count>0){ btn.style.display=''; btn.innerText=`Nộp nhiều hồ sơ (${count})`; } else { btn.style.display='none'; } }
    function clearBulkSelection(){ bulkSelected=[]; document.querySelectorAll('.chk-bulk-row').forEach(cb=>cb.checked=false); const allCb=document.getElementById('chk-bulk-all'); if(allCb) allCb.checked=false; updateBulkButton(); }

    function setExpNote(elId, note){ document.getElementById(elId).innerText = note || ''; }

    /* ====== Giá & hạn dùng (BHTN 12T) ====== */
    let _cachedGiaBHTN = null;
    function unwrapGiaBHTN(res){
      if (!res) return {};
      const d = (res.data !== undefined) ? res.data : res;
      if (Array.isArray(d)) return d[0] || {};
      return d || {};
    }
    async function ensureGiaBHTN(){
      if (_cachedGiaBHTN) return _cachedGiaBHTN;
      const res = await getGiaBHTN();
      _cachedGiaBHTN = unwrapGiaBHTN(res);
      return _cachedGiaBHTN;
    }

    // Hạn mới: từ ngày sau hạn cũ + 12 tháng, lấy ngày cuối cùng
    function computeExp12M(oldEndStr){
      const oldEnd = parseVNDate(oldEndStr);
      if (!oldEnd) return { exp:'(không xác định)', note:'Chưa nhập Ngày hết hạn BHTN cũ trong DanhSach_Hocsinh.' };
      const start = addDaysExact(oldEnd, 1);
      const end = new Date(start.getFullYear(), start.getMonth()+12, 0);
      return { exp: formatVNDate(end), note: '' };
    }

    /* ====== NỘP/SỬA ĐƠN LẺ (BHTN) ====== */
    let _currentHS = null, _currentHS_Sua = null;

    // === BỔ SUNG HÀM HỖ TRỢ TÍNH HOA HỒNG THEO ĐỐI TƯỢNG ===
    function _toNum(x){ const n = Number(String(x||0).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; }
    function _toRate(x){ const r = _toNum(x); return (r>1)?(r/100):r; }
    // [FIXED] — so_tien phụ thuộc đối tượng (CN dùng gia_tien_can_ngheo)
    function calcAmountCommissionByCategory(gia, category){
      const giaTien = _toNum(gia?.gia_tien);
      const giaTienCanNgheo = _toNum(gia?.gia_tien_can_ngheo);
      const rate = _toRate(gia?.hoa_hong_12_thang);
      const cat = String(category||'Học sinh').toLowerCase();
      const isCN = (cat==='cận nghèo' || cat==='can ngheo');
      const so_tien = isCN ? giaTienCanNgheo : giaTien;          // <— cập nhật đúng quy tắc
      const baseForCommission = isCN ? giaTienCanNgheo : giaTien; // hoa hồng cũng theo giá tương ứng
      const hoa_hong = Math.round(baseForCommission * rate);
      return { so_tien, hoa_hong };
    }

    // === BỔ SUNG: cập nhật preview số tiền theo radio (Nộp)
    function refreshNopAmountPreview(gia){
      const isCN = document.getElementById('nhs-dt-can-ngheo').checked;
      const cat = isCN ? 'Cận nghèo' : 'Học sinh';
      const { so_tien } = calcAmountCommissionByCategory(gia, cat);
      document.getElementById('nhs-amount-preview').innerText = (Number(so_tien)||0).toLocaleString('vi-VN');
    }
    // === BỔ SUNG: cập nhật preview số tiền theo radio (Sửa)
    function refreshSuaAmountPreview(gia){
      const isCN = document.getElementById('shs-dt-can-ngheo').checked;
      const cat = isCN ? 'Cận nghèo' : 'Học sinh';
      const { so_tien } = calcAmountCommissionByCategory(gia, cat);
      document.getElementById('shs-amount-preview').innerText = (Number(so_tien)||0).toLocaleString('vi-VN');
    }

    function showNopHoSoModal(stt){
      showLoading();
      const hs = (lastFiltered || allData).find(h => String(h.stt)===String(stt));
      if (!hs) return;
      _currentHS = hs;
      document.getElementById('nhs-hoten').value = hs.ho_ten_hoc_sinh || "";
      document.getElementById('nhs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh || "");
      document.getElementById('nhs-error').innerText = "";

      ensureGiaBHTN().then(gia=>{
        const { exp, note } = computeExp12M(_currentHS.ngay_het_han_bhtn);
        document.getElementById('nhs-exp-preview').innerText = exp;
        setExpNote('nhs-exp-note', note);

        // === BỔ SUNG: set preview số tiền đúng theo radio đang chọn
        refreshNopAmountPreview(gia);

        // === BỔ SUNG: Lắng nghe thay đổi radio để preview cập nhật ngay
        const rHS = document.getElementById('nhs-dt-hocsinh');
        const rCN = document.getElementById('nhs-dt-can-ngheo');
        if (rHS && rCN){
          const onChange = ()=> refreshNopAmountPreview(gia);
          // remove listener cũ (nếu có)
          rHS.onchange = null; rCN.onchange = null;
          rHS.addEventListener('change', onChange);
          rCN.addEventListener('change', onChange);
        }

        const btn = document.getElementById('btnNopHoSo');
        const hasOld = !!parseVNDate(_currentHS.ngay_het_han_bhtn);
        if (!hasOld){ document.getElementById('nhs-error').innerText = 'Chưa có "Ngày hết hạn BHTN cũ" — cần cập nhật trước khi nộp.'; if (btn) btn.disabled = true; }
        else { document.getElementById('nhs-error').innerText=''; if (btn) btn.disabled=false; }
      }).finally(()=>{ hideLoading(); new bootstrap.Modal(document.getElementById('modalNopHoSoBHTN')).show(); });
    }

    async function submitNopHoSoBHTN(){
      if (!_currentHS) return;
      if (!parseVNDate(_currentHS.ngay_het_han_bhtn)){
        document.getElementById('nhs-error').innerText = 'Chưa có "Ngày hết hạn BHTN cũ". Vui lòng cập nhật trước khi nộp.'; return;
      }
      showLoading();
      try{
        const gia = await ensureGiaBHTN();

        // === BỔ SUNG: đọc đối tượng đóng + tính so_tien/hoa_hong đúng quy tắc
        const selectedCat = document.getElementById('nhs-dt-can-ngheo').checked ? 'Cận nghèo' : 'Học sinh';
        const { so_tien, hoa_hong } = calcAmountCommissionByCategory(gia, selectedCat);

        const payload = {
          // BHTN không yêu cầu ma_so_bhtn lúc đầu
          ho_ten_hoc_sinh: _currentHS.ho_ten_hoc_sinh || "null",
          ngay_sinh: displayNgaySinh(_currentHS.ngay_sinh) || "null",
          gioi_tinh: _currentHS.gioi_tinh || "null",
          dia_chi: _currentHS.dia_chi || "null",
          ngay_het_han_bhtn_cu: _currentHS.ngay_het_han_bhtn || "null",
          so_thang_dong: 12,
          lop_hoc: _currentHS.lop_hoc || "null",
          sdt_lienhe: _currentHS.sdt_lienhe || "null",
          so_dinh_danh: _currentHS.so_dinh_danh || "null",
          ten_cha_me: _currentHS.ten_cha_me || "null",

          // === BỔ SUNG: ghi nhận đối tượng đóng
          doi_tuong_dong: selectedCat,

          ghi_chu: "null",

          // === SỬA QUY TẮC: so_tien & hoa_hong
          so_tien, hoa_hong,

          trang_thai: 0,
          so_ho_so: "null",
          ma_truong: user.ma_truong || "null"
        };

        const res = await nopHoSoBHTN(payload);
        if (res?.success){
          (bootstrap.Modal.getInstance(document.getElementById('modalNopHoSoBHTN'))).hide();
          showToast("Nộp hồ sơ BHTN thành công!");
          await fetchChuaThuHocsinh();
        } else {
          document.getElementById('nhs-error').innerText = res?.message || "Nộp hồ sơ thất bại!";
        }
      }catch(err){
        document.getElementById('nhs-error').innerText = err.message || "Có lỗi xảy ra!";
      }finally{ hideLoading(); }
    }

    async function suaHoSo(stt){
      showLoading();
      const hs = (lastFiltered || allData).find(h => String(h.stt)===String(stt));
      if (!hs || hs._bhtn_trangthai !== 0){ showToast("Chỉ sửa được hồ sơ đang chờ duyệt!"); hideLoading(); return; }
      _currentHS_Sua = hs;
      document.getElementById('shs-hoten').value = hs.ho_ten_hoc_sinh || "";
      document.getElementById('shs-ngaysinh').value = displayNgaySinh(hs.ngay_sinh || "");
      document.getElementById('shs-error').innerText = "";

      try{
        // lấy hồ sơ hiện tại (nếu có)
        const hsRes = await getHosoBHTNByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
        const r = hsRes?.data || {};

        // === BỔ SUNG: Set radio theo doi_tuong_dong trong DB
        const catLower = String(r.doi_tuong_dong || 'Học sinh').trim().toLowerCase();
        const shsHS = document.getElementById('shs-dt-hocsinh');
        const shsCN = document.getElementById('shs-dt-can-ngheo');
        if (shsHS && shsCN){
          if (catLower === 'cận nghèo' || catLower === 'can ngheo'){ shsCN.checked = true; } else { shsHS.checked = true; }
        }

        // hiển thị preview hạn/giá 12T
        const gia = await ensureGiaBHTN();
        const { exp, note } = computeExp12M(hs.ngay_het_han_bhtn);
        document.getElementById('shs-exp-preview').innerText = exp;
        setExpNote('shs-exp-note', note);

        // === BỔ SUNG: set preview số tiền theo radio hiện tại
        refreshSuaAmountPreview(gia);

        // === BỔ SUNG: lắng nghe đổi radio để cập nhật preview
        if (shsHS && shsCN){
          const onChange = ()=> refreshSuaAmountPreview(gia);
          shsHS.onchange = null; shsCN.onchange = null;
          shsHS.addEventListener('change', onChange);
          shsCN.addEventListener('change', onChange);
        }
      }catch(e){ console.error(logPrefix, 'suaHoSo prepare error', e); }
      finally{ hideLoading(); new bootstrap.Modal(document.getElementById('modalSuaHoSoBHTN')).show(); }
    }

    async function submitSuaHoSoBHTN(){
      if (!_currentHS_Sua) return;
      showLoading();
      try{
        const gia = await ensureGiaBHTN();

        // === BỔ SUNG: đọc đối tượng đóng + tính lại so_tien/hoa_hong
        const selectedCat = document.getElementById('shs-dt-can-ngheo').checked ? 'Cận nghèo' : 'Học sinh';
        const { so_tien, hoa_hong } = calcAmountCommissionByCategory(gia, selectedCat);

        const payload = {
          so_dinh_danh: _currentHS_Sua.so_dinh_danh,
          ma_truong: user.ma_truong,
          lop_hoc: _currentHS_Sua.lop_hoc,

          // === BỔ SUNG: gửi đối tượng đóng
          doi_tuong_dong: selectedCat,

          // === SỬA QUY TẮC: so_tien & hoa_hong
          so_tien, hoa_hong,

          trang_thai: 0 // vẫn chờ duyệt
        };
        const res = await suaHoSoBHTN(payload);
        if (res?.success){
          (bootstrap.Modal.getInstance(document.getElementById('modalSuaHoSoBHTN'))).hide();
          showToast("Đã cập nhật hồ sơ BHTN!");
          await fetchChuaThuHocsinh();
        } else {
          document.getElementById('shs-error').innerText = res?.message || "Cập nhật thất bại!";
        }
      }catch(err){
        document.getElementById('shs-error').innerText = err.message || "Có lỗi xảy ra!";
      }finally{ hideLoading(); }
    }

    /* ====== Nộp nhiều hồ sơ (BHTN 12T) ====== */
    function showBulkNopHoSoModal(){
      const selected = getSelectedRowsData();
      if (selected.length===0) return;
      document.getElementById('bulk-count-label').innerText = String(selected.length);
      document.getElementById('bulk-error').innerText = '';
      const invalidOld = selected.filter(h => !parseVNDate(h.ngay_het_han_bhtn));
      const bulkBtn = document.getElementById('btnBulkNop');
      if (invalidOld.length>0){ document.getElementById('bulk-error').innerText='Một số học sinh thiếu "Ngày hết hạn BHTN cũ". Hãy cập nhật trước.'; if (bulkBtn) bulkBtn.disabled = true; }
      else { if (bulkBtn) bulkBtn.disabled = false; }

      ensureGiaBHTN().then(gia=>{
        const price = Number(String((gia?.gia_tien)||0).replace(/[^\d]/g,'')) || 0;
        const { exp, note } = computeExp12M(selected[0]?.ngay_het_han_bhtn || "");
        document.getElementById('bulk-exp-preview').innerText = exp;
        document.getElementById('bulk-amount-preview').innerText = price.toLocaleString('vi-VN');
        setExpNote('bulk-exp-note', note);
      });

      new bootstrap.Modal(document.getElementById('modalBulkNopHoSo')).show();
    }

    async function submitBulkNopHoSo(){
      const selected = getSelectedRowsData();
      if (selected.length===0) return;

      const invalidOld = selected.filter(h => !parseVNDate(h.ngay_het_han_bhtn));
      if (invalidOld.length>0){ document.getElementById('bulk-error').innerText='Có học sinh thiếu "Ngày hết hạn BHTN cũ". Vui lòng cập nhật trước khi nộp.'; return; }

      const btn = document.getElementById('btnBulkNop'); btn.disabled=true; showLoading();
      try{
        const gia = await ensureGiaBHTN();
        const price = Number(String((gia?.gia_tien)||0).replace(/[^\d]/g,'')) || 0;
        const rateNum = _toRate(gia?.hoa_hong_12_thang);
        const hoa_hong = Math.round(price * rateNum); // bulk mặc định "Học sinh"

        let ok=0, fail=0, failNames=[];
        for (const hs of selected){
          const payload = {
            ho_ten_hoc_sinh: hs.ho_ten_hoc_sinh || "null",
            ngay_sinh: displayNgaySinh(hs.ngay_sinh) || "null",
            gioi_tinh: hs.gioi_tinh || "null",
            dia_chi: hs.dia_chi || "null",
            ngay_het_han_bhtn_cu: hs.ngay_het_han_bhtn || "null",
            so_thang_dong: 12,
            lop_hoc: hs.lop_hoc || "null",
            sdt_lienhe: hs.sdt_lienhe || "null",
            so_dinh_danh: hs.so_dinh_danh || "null",
            ten_cha_me: hs.ten_cha_me || "null",
            doi_tuong_dong: "Học sinh",  // giữ nguyên như trước khi chưa có tuỳ chọn bulk
            ghi_chu: "null",
            so_tien: price, hoa_hong,
            trang_thai: 0,
            so_ho_so: "null",
            ma_truong: user.ma_truong || "null"
          };
          const res = await nopHoSoBHTN(payload);
          if (res?.success) ok++; else { fail++; failNames.push(hs.ho_ten_hoc_sinh || hs.so_dinh_danh || hs.stt); }
        }

        (bootstrap.Modal.getInstance(document.getElementById('modalBulkNopHoSo'))).hide();
        clearBulkSelection();
        await fetchChuaThuHocsinh();

        if (fail===0) showToast(`Đã nộp thành công ${ok} hồ sơ!`);
        else { showToast(`Nộp xong: thành công ${ok}, thất bại ${fail}.`); console.log(logPrefix, "Hồ sơ lỗi:", failNames); }
      }catch(err){
        document.getElementById('bulk-error').innerText = err.message || "Có lỗi xảy ra!";
      }finally{ hideLoading(); btn.disabled=false; }
    }

    /* ====== Biên lai (A5) ====== */
    function numberToVietnamese(n){
      const VI_DIGITS=["không","một","hai","ba","bốn","năm","sáu","bảy","tám","chín"];
      function readTriple(num){ let tr=Math.floor(num/100), ch=Math.floor((num%100)/10), dv=num%10, s="";
        if (tr>0){ s += VI_DIGITS[tr]+" trăm"; if (ch==0 && dv>0) s+=" lẻ"; }
        if (ch>1){ s += (s?" ":"")+VI_DIGITS[ch]+" mươi"; if (dv==1) s+=" mốt"; else if (dv==5) s+=" lăm"; else if (dv>0) s+=" "+VI_DIGITS[dv]; }
        else if (ch==1){ s += (s?" ":"")+"mười"; if (dv==5) s+=" lăm"; else if (dv>0) s+=" "+VI_DIGITS[dv]; }
        else if (ch==0 && dv>0){ s += (s?" ":"")+VI_DIGITS[dv]; }
        return s.trim();
      }
      n = Math.round(Number(n)||0); if (n===0) return "Không đồng";
      const units=[""," nghìn"," triệu"," tỷ"," nghìn tỷ"," triệu tỷ"]; let i=0,str="";
      while(n>0 && i<units.length){ const block=n%1000; if(block>0){ const part=readTriple(block); str = part+units[i]+(str?" "+str:""); } n=Math.floor(n/1000); i++; }
      return (str.charAt(0).toUpperCase()+str.slice(1)+" đồng").replace(/\s+/g," ").trim();
    }

    function calcRangeBHTN(oldEndStr){
      const od=parseVNDate(oldEndStr);
      if (!od) return {startText:"—", endText:"(không xác định)"};
      const start=addDaysExact(od,1);
      const end=new Date(start.getFullYear(), start.getMonth()+12, 0);
      return { startText: formatVNDate(start), endText: formatVNDate(end) };
    }

    function stripVN(str){ return String(str||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D'); }
    function initials(str){ return String(str||"").trim().split(/\s+/).map(w=>w[0]||'').join('').toUpperCase(); }
    function buildQRPayload(schoolCode, school, classCode, name, months, endDate){
      const mt=String(schoolCode||"").slice(0,24);
      const s=stripVN(school).slice(0,60);
      const c=String(classCode||"").slice(0,12);
      const n=stripVN(name).slice(0,60);
      const m=String(months||""); const e=String(endDate||"").slice(0,10);
      return `MT=${mt};S=${s};L=${c};N=${n};M=${m};E=${e}`;
    }

    async function inPhieuThu(stt){
      try{
        showLoading();
        const hs = (lastFiltered||allData).find(h=>String(h.stt)===String(stt));
        if (!hs){ hideLoading(); return; }
        const hoSo = await getHosoBHTNByHS(hs.so_dinh_danh, user.ma_truong, hs.lop_hoc);
        if (!hoSo || !hoSo.success || !hoSo.data){ hideLoading(); showToast("Không tìm thấy hồ sơ BHTN để in."); return; }

        const months = 12;
        const amount = parseInt(String(hoSo.data.so_tien||"0").replace(/[^\d]/g,''),10)||0;
        const { startText, endText } = calcRangeBHTN(hs.ngay_het_han_bhtn);
        const schoolName = await getTenTruong(user.ma_truong);
        const classCode = hoSo.data.lop_hoc || hs.lop_hoc || (user.lop_hoc || "");
        const teacherName = user.ho_ten || user.ten_giao_vien || "(Giáo viên)";

        document.getElementById('rec-school').innerText = schoolName;
        document.getElementById('rec-class').innerText = classCode;
        document.getElementById('rec-date-today').innerText = todayText();
        document.getElementById('rec-student-name').innerText = hs.ho_ten_hoc_sinh || "";
        document.getElementById('rec-address').innerText = hs.dia_chi || "";
        document.getElementById('rec-content').innerText = `Thu tiền BHTN - ${classCode}`;
        document.getElementById('rec-months').innerText = String(months);
        document.getElementById('rec-range').innerText = `từ ngày ${startText} đến ngày ${endText}`;
        document.getElementById('rec-amount').innerText = amount.toLocaleString('vi-VN');
        document.getElementById('rec-amount-text').innerText = numberToVietnamese(amount);
        document.getElementById('rec-teacher-name').innerText = teacherName;

        const qrBox = document.getElementById('receipt-qr'); qrBox.innerHTML = "";
        const primaryText = buildQRPayload(user.ma_truong, schoolName, classCode, hs.ho_ten_hoc_sinh||"", months, endText);
        try{
          new QRCode(qrBox, { text: primaryText, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L });
        }catch(e){
          const fallbackText = `MT=${String(user.ma_truong).slice(0,24)};L=${String(classCode).slice(0,12)};N=${initials(hs.ho_ten_hoc_sinh)};M=${months};E=${endText}`;
          try{ new QRCode(qrBox, { text: fallbackText, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L }); }
          catch(e2){ qrBox.innerHTML = '<small>QR quá dài</small>'; }
        }

        new bootstrap.Modal(document.getElementById('modalPhieuThu')).show();
      }catch(err){
        console.error(logPrefix,'inPhieuThu error',err); showToast("Không thể tạo phiếu thu.");
      }finally{ hideLoading(); }
    }

    function getReceiptPrintCSS(){ return `
      <style>
        @page { size: A5 portrait; margin: 10mm; }
        html,body{ background:#fff; margin:0; padding:0; }
        .a5-paper{ width:148mm; min-height:210mm; background:#fff; color:#000; margin:0 auto; padding:10mm 12mm; line-height:1.35; font-size:13px; }
        .receipt-title{ font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
        .receipt-sub{ font-style:italic; }
        .receipt-meta{ font-size:13px; }
        .receipt-line{ margin: 2mm 0; }
        .qr-box{ width:26mm; height:26mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; margin:0 auto; }
        .sign-col{ text-align:center; margin-top:10mm; font-weight:500; }
        .sign-name{ margin-top:20mm; text-align:center; font-weight:600; }
        .row{ display:flex; flex-wrap:nowrap; width:100%; }
        .col{ flex:1 1 0; }
        .text-center{ text-align:center; }
      </style>`; }

    async function downloadReceiptImage(){
      try{
        const node=document.getElementById('receiptA5');
        const canvas=await html2canvas(node,{scale:2, backgroundColor:'#ffffff'});
        const dataURL=canvas.toDataURL("image/png");
        const canDownload='download' in document.createElement('a') && !isIOS();
        if (canDownload){
          const a=document.createElement('a'); a.href=dataURL; a.download='phieu-thu-bhtn.png';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        } else {
          const win=window.open(); if (win){ win.document.write(`<html><head><title>Lưu ảnh phiếu thu</title></head><body style="margin:0"><img src="${dataURL}" style="max-width:100%;display:block"/></body></html>`); win.document.close(); }
          else { alert('Trình duyệt chặn tải trực tiếp. Ảnh sẽ mở ở tab mới để bạn lưu thủ công.'); window.location.href=dataURL; }
        }
      }catch(e){ alert('Không thể lưu ảnh: '+(e.message||e)); }
    }

    function printReceiptOnly(){
      const src = document.getElementById('receiptA5');
      if (!src) return;

      // Tạo/clear vùng in
      let printRoot = document.getElementById('printArea');
      if (!printRoot){
        printRoot = document.createElement('div');
        printRoot.id = 'printArea';
        document.body.appendChild(printRoot);
      }
      printRoot.innerHTML = '';

      // Clone nội dung A5
      const clone = src.cloneNode(true);

      // ✅ Chốt QR: canvas -> <img dataURL>, đảm bảo in được trên mobile
      try{
        const liveQR = src.querySelector('#receipt-qr canvas, #receipt-qr img');
        const cloneQRHolder = clone.querySelector('#receipt-qr');
        if (liveQR && cloneQRHolder){
          const dataURL = (liveQR.tagName.toLowerCase() === 'canvas')
            ? liveQR.toDataURL('image/png')
            : liveQR.src;
          const img = document.createElement('img');
          img.src = dataURL;
          img.style.display = 'block';
          img.style.width = '90px';
          img.style.height = '90px';
          cloneQRHolder.innerHTML = '';
          cloneQRHolder.appendChild(img);
        }
      }catch(e){ /* bỏ qua nếu trình duyệt không hỗ trợ */ }

      printRoot.appendChild(clone);

      // Kích hoạt chế độ in-tại-chỗ
      document.body.classList.add('print-active');

      // In và dọn dẹp (kèm fallback cho mobile không bắn afterprint)
      const cleanup = () => {
        document.body.classList.remove('print-active');
        window.removeEventListener('afterprint', cleanup);
      };
      window.addEventListener('afterprint', cleanup);

      const doPrint = () => window.print();

      // Đợi QR-img nạp xong rồi in (tránh trắng ảnh trên iOS/Android)
      const qrImg = clone.querySelector('#receipt-qr img');
      if (qrImg && !qrImg.complete){
        qrImg.onload = () => setTimeout(doPrint, 50);
        qrImg.onerror = () => setTimeout(doPrint, 50);
        // fallback dọn dẹp nếu mobile không bắn afterprint
        setTimeout(cleanup, 2500);
      } else {
        setTimeout(doPrint, 50);
        setTimeout(cleanup, 2500);
      }
    }



    function showToast(msg){
      document.getElementById('toast-message').innerText = msg;
      bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast')).show();
    }

    /* ====== Boot ====== */
    window.onload = fetchChuaThuHocsinh;
  </script>
</body>
</html>
