<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .sticky-header-box {
      position: sticky; top: 0; z-index: 999;
      background: #f8f9fa; padding-bottom: 2px;
    }
    .header {
      font-size: 22px; font-weight: bold; margin-bottom: 8px;
      padding-bottom: 6px; background: #f8f9fa;
    }
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer;}
    .table-responsive { overflow-x: auto; }
    .search-row {
      display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; gap: 12px;
      position: sticky; top: 52px; z-index: 998; background: #f8f9fa;
      padding-bottom: 6px;
    }
    .search-input { flex: 1; min-width: 180px;}
    .total-count { font-size: 1rem; font-weight: 400; color: #444;}
    th.sortable { cursor: pointer; user-select: none; }
    .sort-icon { font-size: 15px; vertical-align: middle; margin-left: 3px; }
    .th-action { min-width: 90px; }

    @media (max-width: 600px) {
      .header { font-size: 18px; }
      .search-row { flex-direction: column; align-items: stretch; }
      .btn-main { width: 100%; }
      .th-action { min-width: 70px; }
      .action-btns { display: flex; flex-direction: column; gap: 6px; }
      .action-btns .btn { width: 100%; }
    }
    @media (min-width: 601px) and (max-width: 999px) {
      .header { font-size: 20px; }
      .search-row { flex-direction: row; }
      .action-btns { display: flex; flex-direction: row; gap: 4px; }
    }
    @media (min-width: 1000px) {
      .header { font-size: 22px; }
      .search-row { flex-direction: row; }
      .action-btns { display: flex; flex-direction: row; gap: 4px; }
    }

    .btn-back {
      position: fixed;
      bottom: 26px; right: 20px; z-index: 1099;
      border-radius: 50%; width: 54px; height: 54px;
      box-shadow: 0 2px 14px #0003;
      font-size: 25px;
      display: flex; align-items: center; justify-content: center;
      background: #fff;
      border: 2px solid #eee;
      color: #2563eb;
      transition: box-shadow 0.12s;
    }
    .btn-back:hover { box-shadow: 0 4px 24px #2563eb33; color: #fff; background: #2563eb; }
  </style>

  <!-- Bootstrap Datepicker CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet"/>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap Datepicker JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
  <!-- Ngôn ngữ Vietnamese cho Datepicker -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/locales/bootstrap-datepicker.vi.min.js"></script>


</head>
<body>
  <div class="sticky-header-box">
    <div class="header">
      DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span>
      <span class="total-count" id="total-hs"></span>
    </div>
    <div id="ds-actions" style="margin-bottom:8px;"></div>
    <div class="search-row mb-2">
      <input class="form-control search-input" id="search-box" placeholder="Tìm kiếm theo tên, mã BHXH, số ĐT, số định danh..." oninput="doSearch()">
      <button class="btn btn-danger d-none" id="btn-delete-multi" onclick="showConfirmDeleteMany()">Xóa các dòng đã chọn</button>
    </div>
  </div>



  <div class="table-responsive" id="ds-container"></div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

  <!-- Modal thêm mới học sinh -->
  <div class="modal fade" id="modalThemHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Thêm mới học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-themhs" onsubmit="event.preventDefault();handleThemHS();">
          <input class="form-control mb-2" id="inp-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="inp-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="inp-ngay-sinh" type="text" placeholder="dd/mm/yyyy" autocomplete="off"/>

          <label class="mb-1">Giới tính:</label>
          <div class="mb-2" style="display: flex; gap: 16px;">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="gioi_tinh" id="gt-nam" value="Nam" checked>
              <label class="form-check-label" for="gt-nam">Nam</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="gioi_tinh" id="gt-nu" value="Nữ">
              <label class="form-check-label" for="gt-nu">Nữ</label>
            </div>
          </div>
          <input class="form-control mb-2" id="inp-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="inp-lop" placeholder="Lớp" disabled/>
          <input class="form-control mb-2" id="inp-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="inp-so-dinh-danh" placeholder="Số định danh"/>
          <input class="form-control mb-2" id="inp-ten-cha-me" placeholder="Tên cha/mẹ học sinh"/>
        </form>
        <div id="themhs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleThemHS()">Thêm mới</button>
      </div>
    </div></div>
  </div>

  <!-- Modal sửa học sinh -->
  <div class="modal fade" id="modalSuaHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Sửa thông tin học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-suahs" onsubmit="event.preventDefault();handleSuaHS();">
          <input type="hidden" id="sua-stt"/>
          <input class="form-control mb-2" id="sua-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="sua-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="sua-ngay-sinh" type="text" placeholder="dd/mm/yyyy" autocomplete="off"/>

          <label class="mb-1">Giới tính:</label>
          <div class="mb-2" style="display: flex; gap: 16px;">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="sua_gioi_tinh" id="sua-gt-nam" value="Nam">
              <label class="form-check-label" for="sua-gt-nam">Nam</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="sua_gioi_tinh" id="sua-gt-nu" value="Nữ">
              <label class="form-check-label" for="sua-gt-nu">Nữ</label>
            </div>
          </div>
          <input class="form-control mb-2" id="sua-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="sua-lop" placeholder="Lớp" disabled/>
          <input class="form-control mb-2" id="sua-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="sua-so-dinh-danh" placeholder="Số định danh"/>
          <input class="form-control mb-2" id="sua-ten-cha-me" placeholder="Tên cha/mẹ học sinh"/>
        </form>
        <div id="suahs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleSuaHS()">Lưu thay đổi</button>
      </div>
    </div></div>
  </div>

  <!-- Modal nhập file excel -->
  <div class="modal fade" id="modalImportHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
        <div id="import-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleImportHS()">Nhập danh sách</button>
      </div>
    </div></div>
  </div>

  <!-- Modal xác nhận xóa -->
  <div class="modal fade" id="modalConfirm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="modalConfirmTitle">Xác nhận</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalConfirmBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-danger" id="btnConfirmAction">Đồng ý</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast thông báo -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastNoti" class="toast align-items-center text-white bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastNotiBody"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Nút quay về -->
  <button class="btn btn-back" onclick="goBack()" title="Quay về">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
    </svg>
  </button>

  <div id="loadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.5);align-items:center;justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  
  
  
  
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    // ==== XỬ LÝ NGƯỜI DÙNG VÀ BIẾN TOÀN CỤC ====
    // Lấy thông tin user từ localStorage, kiểm tra quyền
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    // Biến cấu hình phân trang, trạng thái
    let pageSize = 20, currentPage = 1, totalPages = 1, totalRecords = 0;
    let sortField = "", sortDir = 1, selectedRows = [], allData = [], lastPageData = [];

    // ==== HÀM XỬ LÝ NGÀY ====
    // Chuyển yyyy-mm-dd => dd/mm/yyyy
    function toDDMMYYYY(dateStr) {
      if (!dateStr) return "";
      if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y, m, d] = dateStr.split("-");
        return `${d}/${m}/${y}`;
      }
      if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateStr;
      return dateStr;
    }
    // Chuyển dd/mm/yyyy => yyyy-mm-dd (cho input type="date")
    function toYYYYMMDD(ddmmyyyy) {
      let parts = ddmmyyyy.split("/");
      return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : "";
    }
    // Đọc số excel -> chuỗi dd/mm/yyyy
    function excelDateToString(dateCell) {
      if (typeof dateCell === 'string') return toDDMMYYYY(dateCell);
      if (typeof dateCell === 'number') {
        var utc_days = Math.floor(dateCell - 25569);
        var date = new Date(utc_days * 86400 * 1000);
        date.setUTCHours(0,0,0,0);
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return "";
    }
    // Hiển thị ngày sinh cho table
    function displayNgaySinh(raw) {
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) {
        let d = new Date(raw);
        let day = String(d.getDate()).padStart(2, '0');
        let month = String(d.getMonth() + 1).padStart(2, '0');
        let year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y, m, d] = raw.split('-');
        return `${d}/${m}/${y}`;
      }
      if (!isNaN(Number(raw))) return excelDateToString(Number(raw));
      return raw;
    }

    // ==== XỬ LÝ LOADING, TOAST, XÁC NHẬN ====
    // Loading overlay
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
    // Thông báo nhanh
    function showToast(msg, type = "primary") {
      const toast = document.getElementById('toastNoti');
      document.getElementById('toastNotiBody').innerText = msg;
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      new bootstrap.Toast(toast, { delay: 3500 }).show();
    }
    // Modal xác nhận
    function showConfirm(msg, onConfirm, title = "Xác nhận") {
      document.getElementById('modalConfirmTitle').innerText = title;
      document.getElementById('modalConfirmBody').innerHTML = msg;
      const btn = document.getElementById('btnConfirmAction');
      btn.onclick = function () {
        bootstrap.Modal.getInstance(document.getElementById('modalConfirm')).hide();
        onConfirm?.();
      };
      new bootstrap.Modal(document.getElementById('modalConfirm')).show();
    }

    // ==== PHÂN TRANG, SẮP XẾP, SEARCH ====
    // Phát hiện thay đổi kích thước màn hình, tự điều chỉnh pageSize
    function detectPageSize() {
      const width = window.innerWidth;
      if (width <= 600) pageSize = 2;
      else if (width <= 999) pageSize = 5;
      else pageSize = 20;
    }
    window.addEventListener('resize', function () {
      const prevPageSize = pageSize;
      detectPageSize();
      if (pageSize !== prevPageSize) {
        currentPage = 1;
        renderAllView();
      }
    });
    // Lọc, sắp xếp dữ liệu
    function getFilteredSortedData() {
      let q = document.getElementById('search-box').value.trim().toLowerCase();
      let filtered = allData.filter(hs =>
        !q ||
        (hs.ho_ten_hoc_sinh || "").toLowerCase().includes(q) ||
        (hs.ma_so_bhxh || "").toLowerCase().includes(q) ||
        (hs.sdt_lienhe || "").toLowerCase().includes(q) ||
        (hs.so_dinh_danh || "").toLowerCase().includes(q) ||
        (hs.ten_cha_me || "").toLowerCase().includes(q)
      );
      if (sortField) {
        filtered.sort(function (a, b) {
          let av = (a[sortField] || "").toLowerCase(), bv = (b[sortField] || "").toLowerCase();
          if (!isNaN(av) && !isNaN(bv)) { av = Number(av); bv = Number(bv); }
          if (av < bv) return -sortDir; if (av > bv) return sortDir; return 0;
        });
      }
      return filtered;
    }
    function doSort(field) {
      if (sortField === field) sortDir = -sortDir;
      else { sortField = field; sortDir = 1; }
      renderAllView();
    }
    // Render nút phân trang
    function renderPagination() {
      const pagin = document.getElementById('pagination');
      pagin.innerHTML = '';
      if (totalPages <= 1) return;
      pagin.innerHTML += `<li class="page-item${currentPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage - 1});return false;">Trước</a></li>`;
      let minP = Math.max(1, currentPage - 2), maxP = Math.min(totalPages, currentPage + 2);
      if (minP > 1) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP > 2) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p = minP; p <= maxP; p++) {
        pagin.innerHTML += `<li class="page-item${p === currentPage ? ' active' : ''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      }
      if (maxP < totalPages - 1) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP < totalPages) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      pagin.innerHTML += `<li class="page-item${currentPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage + 1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function (p) {
      if (p < 1 || p > totalPages || p === currentPage) return;
      currentPage = p;
      renderAllView();
    };
    // Tìm kiếm
    function doSearch() { currentPage = 1; renderAllView(); }

    // ==== LOAD & HIỂN THỊ DANH SÁCH ====
    // Gọi API lấy toàn bộ danh sách học sinh 1 lần
    async function fetchAllHocsinhOnce() {
      detectPageSize();
      showLoading();
      let url = `${API_BASE}?func=GetAllDanhSachHocsinh&ma_truong=${encodeURIComponent(user.ma_truong)}&lop=${encodeURIComponent(user.lop_hoc)}`;
      let res = await fetch(url);
      let data = await res.json();
      hideLoading();
      if (data.success && Array.isArray(data.data)) {
        allData = data.data;
      } else {
        allData = [];
      }
      currentPage = 1;
      renderAllView();
    }
    function renderAllView() {
      let filtered = getFilteredSortedData();
      totalRecords = filtered.length;
      totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
      let start = (currentPage - 1) * pageSize;
      let ds = filtered.slice(start, start + pageSize);
      lastPageData = ds;
      renderDanhSachHS(ds, start);
      renderPagination();
      renderActions();
    }

    // ==== HIỂN THỊ BẢNG VÀ ACTION ====
    // Render bảng danh sách học sinh
    function renderDanhSachHS(ds, offset) {
      selectedRows = [];
      if (!ds || ds.length === 0) {
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Chưa có dữ liệu học sinh cho lớp này.</div>`;
        document.getElementById('btn-delete-multi').classList.add('d-none');
        return;
      }
      function sortIcon(field) {
        if (sortField !== field) return '';
        return sortDir === 1 ? ' ▲' : ' ▼';
      }
      let html = `<table class="table table-bordered table-hs align-middle"><thead>
        <tr>
          <th><input type="checkbox" id="chk-all" onclick="toggleSelectAll(this)"></th>
          <th class="th-action">Thao tác</th>
          <th class="sortable" onclick="doSort('ma_so_bhxh')">Mã số BHXH${sortIcon('ma_so_bhxh')}</th>
          <th class="sortable" onclick="doSort('ho_ten_hoc_sinh')">Họ tên${sortIcon('ho_ten_hoc_sinh')}</th>
          <th class="sortable" onclick="doSort('ngay_sinh')">Ngày sinh${sortIcon('ngay_sinh')}</th>
          <th class="sortable" onclick="doSort('gioi_tinh')">Giới tính${sortIcon('gioi_tinh')}</th>
          <th class="sortable" onclick="doSort('dia_chi')">Địa chỉ${sortIcon('dia_chi')}</th>
          <th class="sortable" onclick="doSort('lop')">Lớp${sortIcon('lop')}</th>
          <th class="sortable" onclick="doSort('sdt_lienhe')">SĐT liên hệ${sortIcon('sdt_lienhe')}</th>
          <th class="sortable" onclick="doSort('so_dinh_danh')">Số định danh${sortIcon('so_dinh_danh')}</th>
          <th class="sortable" onclick="doSort('ten_cha_me')">Tên cha/mẹ${sortIcon('ten_cha_me')}</th>
        </tr></thead><tbody>`;
      ds.forEach((hs, i) => {
        html += `<tr>
          <td><input type="checkbox" class="chk-row" value="${hs.stt}" onchange="onSelectRow('${hs.stt}', this)"></td>
          <td>
            <div class="action-btns">
              <button class="btn btn-sm btn-warning" onclick="showModalSuaHSByIndex(${i})">Sửa</button>
              <button class="btn btn-sm btn-danger" onclick="showConfirmDelete('${hs.stt}')">Xóa</button>
            </div>
          </td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
          <td>${hs.ten_cha_me||""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;
      document.getElementById('btn-delete-multi').classList.add('d-none');
    }
    // Render action bar
    function renderActions() {
      document.getElementById('ds-actions').innerHTML = `
        <button class="btn btn-success btn-main" onclick="showModalThemHS()">Thêm mới học sinh</button>
        <button class="btn btn-primary btn-main" onclick="showModalImportHS()">Thêm học sinh từ danh sách có sẵn</button>
        <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
      `;
    }

    // ==== THÊM, SỬA, XÓA HỌC SINH ====

    function isValidDateVN(str) {
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return false;
      const [d, m, y] = str.split('/').map(Number);
      const date = new Date(y, m-1, d);
      return date.getFullYear() === y && (date.getMonth()+1) === m && date.getDate() === d;
    }

    // --- Hiển thị lỗi ---
    function showError(id, msg) {
      document.getElementById(id).innerText = msg;
    }

    // Hiện modal thêm
    function showModalThemHS() {
      document.getElementById('form-themhs').reset?.();
      document.getElementById('themhs-error').innerText = "";
      document.getElementById('inp-lop').value = user.lop_hoc || "";
      document.getElementById('gt-nam').checked = true;
      new bootstrap.Modal(document.getElementById('modalThemHS')).show();
    }
    // --- Kiểm tra form thêm mới học sinh ---

    // Xử lý thêm mới học sinh
    async function handleThemHS() {
      // Lấy giá trị input
      let hoTen = document.getElementById('inp-ho-ten-hs').value.trim();
      let ngaySinh = document.getElementById('inp-ngay-sinh').value.trim();
      let gioiTinh = document.querySelector('input[name="gioi_tinh"]:checked')?.value || "";
      let diaChi = document.getElementById('inp-dia-chi').value.trim();
      let lop = user.lop_hoc || "";
      let sdtLienHe = document.getElementById('inp-sdt-lienhe').value.trim();
      let soDinhDanh = document.getElementById('inp-so-dinh-danh').value.trim();
      let tenChaMe = document.getElementById('inp-ten-cha-me').value.trim();
      let maSoBHXH = document.getElementById('inp-ma-so-bhxh').value.trim();

      // --- Kiểm tra không trống ---
      if (!hoTen || !ngaySinh || !gioiTinh || !diaChi || !lop || !sdtLienHe || !soDinhDanh || !tenChaMe || !maSoBHXH) {
        showError('themhs-error', "Vui lòng nhập đầy đủ tất cả các trường!");
        return;
      }
      // --- Kiểm tra ngày sinh ---
      if (!isValidDateVN(ngaySinh)) {
        showError('themhs-error', "Ngày sinh không hợp lệ! Định dạng dd/mm/yyyy.");
        return;
      }
      // --- Kiểm tra SĐT liên hệ ---
      if (!/^0\d{9}$/.test(sdtLienHe)) {
        showError('themhs-error', "Số điện thoại không hợp lệ!");
        return;
      }
      // --- Kiểm tra số định danh ---
      if (!/^\d{12}$/.test(soDinhDanh)) {
        showError('themhs-error', "Số định danh phải gồm 12 số!");
        return;
      }

      showLoading();
      const hs = {
        ma_so_bhxh: maSoBHXH,
        ho_ten_hoc_sinh: hoTen,
        ngay_sinh: ngaySinh,
        gioi_tinh: gioiTinh,
        dia_chi: diaChi,
        lop: lop,
        sdt_lienhe: sdtLienHe,
        so_dinh_danh: soDinhDanh,
        ten_cha_me: tenChaMe,
        ma_truong: user.ma_truong
      };
      const res = await themHocsinh(hs);
      hideLoading();
      if (res.success) {
        showToast("Thêm mới học sinh thành công!","success");
        await fetchAllHocsinhOnce();
        bootstrap.Modal.getInstance(document.getElementById('modalThemHS')).hide();
      } else {
        showError('themhs-error', res.message || "Lỗi thêm học sinh!");
      }
    }




    // Hiện modal sửa
    function showModalSuaHSByIndex(i) {
      const hs = lastPageData[i];
      if (!hs) return;
      document.getElementById('form-suahs').reset?.();
      document.getElementById('suahs-error').innerText = "";
      document.getElementById('sua-stt').value = hs.stt;
      document.getElementById('sua-ma-so-bhxh').value = hs.ma_so_bhxh || "";
      document.getElementById('sua-ho-ten-hs').value = hs.ho_ten_hoc_sinh || "";
      // Hiển thị lại ngày sinh đúng dd/mm/yyyy
      let ddmmyyyy = displayNgaySinh(hs.ngay_sinh);
      document.getElementById('sua-ngay-sinh').value = ddmmyyyy;

      if (hs.gioi_tinh === "Nam") document.getElementById('sua-gt-nam').checked = true;
      else if (hs.gioi_tinh === "Nữ") document.getElementById('sua-gt-nu').checked = true;
      document.getElementById('sua-dia-chi').value = hs.dia_chi || "";
      document.getElementById('sua-lop').value = hs.lop || "";
      document.getElementById('sua-sdt-lienhe').value = hs.sdt_lienhe || "";
      document.getElementById('sua-so-dinh-danh').value = hs.so_dinh_danh || "";
      document.getElementById('sua-ten-cha-me').value = hs.ten_cha_me || "";
      new bootstrap.Modal(document.getElementById('modalSuaHS')).show();
    }


    
    // Xử lý sửa
    // --- Kiểm tra form sửa học sinh ---
    async function handleSuaHS() {
      let hoTen = document.getElementById('sua-ho-ten-hs').value.trim();
      let ngaySinh = document.getElementById('sua-ngay-sinh').value.trim();
      let gioiTinh = document.querySelector('input[name="sua_gioi_tinh"]:checked')?.value || "";
      let diaChi = document.getElementById('sua-dia-chi').value.trim();
      let lop = document.getElementById('sua-lop').value.trim();
      let sdtLienHe = document.getElementById('sua-sdt-lienhe').value.trim();
      let soDinhDanh = document.getElementById('sua-so-dinh-danh').value.trim();
      let tenChaMe = document.getElementById('sua-ten-cha-me').value.trim();
      let maSoBHXH = document.getElementById('sua-ma-so-bhxh').value.trim();

      if (!hoTen || !ngaySinh || !gioiTinh || !diaChi || !lop || !sdtLienHe || !soDinhDanh || !tenChaMe || !maSoBHXH) {
        showError('suahs-error', "Vui lòng nhập đầy đủ tất cả các trường!");
        return;
      }
      if (!isValidDateVN(ngaySinh)) {
        showError('suahs-error', "Ngày sinh không hợp lệ! Định dạng dd/mm/yyyy.");
        return;
      }
      if (!/^0\d{9}$/.test(sdtLienHe)) {
        showError('suahs-error', "Số điện thoại không hợp lệ!");
        return;
      }
      if (!/^\d{12}$/.test(soDinhDanh)) {
        showError('suahs-error', "Số định danh phải gồm 12 số!");
        return;
      }

      showLoading();
      const hs = {
        stt: document.getElementById('sua-stt').value,
        ma_so_bhxh: maSoBHXH,
        ho_ten_hoc_sinh: hoTen,
        ngay_sinh: ngaySinh,
        gioi_tinh: gioiTinh,
        dia_chi: diaChi,
        lop: lop,
        sdt_lienhe: sdtLienHe,
        so_dinh_danh: soDinhDanh,
        ten_cha_me: tenChaMe,
        ma_truong: user.ma_truong
      };
      const res = await suaHocsinh(hs);
      hideLoading();
      if (res.success) {
        showToast("Cập nhật học sinh thành công!","success");
        await fetchAllHocsinhOnce();
        bootstrap.Modal.getInstance(document.getElementById('modalSuaHS')).hide();
      } else {
        showError('suahs-error', res.message || "Lỗi cập nhật!");
      }
    }




    // ==== IMPORT EXCEL ====
    // Hiện modal import
    function showModalImportHS() {
      document.getElementById('import-error').innerText = "";
      document.getElementById('import-file').value = "";
      new bootstrap.Modal(document.getElementById('modalImportHS')).show();
    }


    
    // Xử lý import
    async function handleImportHS() {
      const fileInput = document.getElementById('import-file');
      const errorDiv = document.getElementById('import-error');
      errorDiv.innerText = "";
      if (!fileInput.files.length) {
        errorDiv.innerText = "Vui lòng chọn file!";
        return;
      }
      const file = fileInput.files[0];
      showLoading();
      try {
        // Đọc file Excel
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        rows.shift(); // Bỏ dòng tiêu đề

        // Chuẩn bị kiểm tra trùng lặp
        const soDinhDanhSet = new Set();
        const maSoBHXHSet = new Set();
        // Dữ liệu đã tồn tại trên hệ thống (allData đã fetch ở ngoài)
        const existedSoDinhDanhSet = makeSetByField(allData, "so_dinh_danh");
        const existedMaSoBHXHSet = makeSetByField(allData, "ma_so_bhxh");

        let errors = [];
        const ds = rows.map((row, idx) => {
          return {
            ma_so_bhxh: String(row[1] || ""),
            ho_ten_hoc_sinh: row[2] || "",
            ngay_sinh: excelDateToString(row[3]),
            gioi_tinh: row[4] || "",
            dia_chi: row[5] || "",
            lop: row[6] || user.lop_hoc,
            sdt_lienhe: row[7] || "",
            so_dinh_danh: String(row[8] || ""),
            ten_cha_me: row[9] || "",
            ma_truong: user.ma_truong
          }
        });

        // Kiểm tra từng dòng
        ds.forEach((row, idx) => {
          const err = validateImportRow(
            row, idx + 2,
            soDinhDanhSet, maSoBHXHSet,
            existedSoDinhDanhSet, existedMaSoBHXHSet
          );
          if (err) errors.push(err);
        });

        if (errors.length > 0) {
          errorDiv.innerText = "Lỗi dữ liệu:\n" + errors.join("\n");
          hideLoading();
          return;
        }

        // Gửi dữ liệu lên backend
        const res = await importDanhSachHocsinh(ds);
        hideLoading();
        if (res.success) {
          showToast("Import danh sách thành công!", "success");
          await fetchAllHocsinhOnce();
          bootstrap.Modal.getInstance(document.getElementById('modalImportHS')).hide();
        } else {
          errorDiv.innerText = res.message || "Lỗi import dữ liệu!";
        }
      } catch (err) {
        hideLoading();
        errorDiv.innerText = "Lỗi đọc file hoặc dữ liệu không đúng định dạng!\nChi tiết: " + (err.message || err);
      }
    }




    // ==== XÓA HỌC SINH ====
    // Chọn/xóa nhiều dòng
    window.onSelectRow = function (stt, cb) {
      if (cb.checked) selectedRows.push(stt);
      else selectedRows = selectedRows.filter(x => x !== stt);
      updateDeleteMultiButton();
    }
    function toggleSelectAll(mainCb) {
      let all = document.querySelectorAll('.chk-row');
      selectedRows = [];
      all.forEach(cb => {
        cb.checked = mainCb.checked;
        if (mainCb.checked) selectedRows.push(cb.value);
      });
      updateDeleteMultiButton();
    }
    function updateDeleteMultiButton() {
      let btn = document.getElementById('btn-delete-multi');
      if (selectedRows.length > 0) btn.classList.remove('d-none');
      else btn.classList.add('d-none');
    }
    function showConfirmDeleteMany() {
      if (selectedRows.length === 0) return;
      showConfirm(`Bạn có chắc chắn muốn xóa <b>${selectedRows.length}</b> học sinh đã chọn?`, doDeleteMany, "Xác nhận xóa nhiều học sinh");
    }
    async function doDeleteMany() {
      showLoading();
      const res = await xoaNhieuHocsinh(selectedRows);
      hideLoading();
      if (res.success) {
        showToast("Xóa nhiều học sinh thành công!","success");
        await fetchAllHocsinhOnce();
        selectedRows = [];
      } else {
        showToast(res.message || "Xóa nhiều học sinh thất bại!","danger");
      }
    }
    // Xóa 1 dòng
    window.showConfirmDelete = function (stt) {
      showConfirm("Bạn có chắc chắn muốn xóa học sinh này?", () => doDelete(stt), "Xác nhận xóa");
    }
    async function doDelete(stt) {
      showLoading();
      const res = await xoaHocsinh(stt);
      hideLoading();
      if (res.success) {
        showToast("Xóa học sinh thành công!","success");
        await fetchAllHocsinhOnce();
      } else {
        showToast(res.message || "Xóa học sinh thất bại!","danger");
      }
    }

    // ==== KHÁC ====
    // Download file mẫu
    function downloadMauHS() {
      window.open("../mau_nhap_hocsinh.xlsx", "_blank");
    }
    // Quay lại dashboard
    function goBack() { showLoading(); window.location.href = "dashboard.html"; }

    // ==== KHỞI TẠO ====
    // Expose hàm cho window
    window.showModalSuaHSByIndex = showModalSuaHSByIndex;
    window.onload = fetchAllHocsinhOnce;

  </script>




  <script>
    function validateImportRow(
      row, rowNum,
      soDinhDanhSet, maSoBHXHSet,
      existedSoDinhDanhSet, existedMaSoBHXHSet
    ) {
      // Danh sách trường cần kiểm tra trống
      const fields = [
        { key: 'ma_so_bhxh', label: "Mã số BHXH" },
        { key: 'ho_ten_hoc_sinh', label: "Họ tên học sinh" },
        { key: 'ngay_sinh', label: "Ngày sinh" },
        { key: 'gioi_tinh', label: "Giới tính" },
        { key: 'dia_chi', label: "Địa chỉ" },
        { key: 'lop', label: "Lớp" },
        { key: 'sdt_lienhe', label: "SĐT liên hệ" },
        { key: 'so_dinh_danh', label: "Số định danh" },
        { key: 'ten_cha_me', label: "Tên cha/mẹ" }
      ];
      for (let f of fields) {
        if (!row[f.key] || String(row[f.key]).trim() === "") {
          return `Dòng ${rowNum}: Trường "${f.label}" không được để trống.`;
        }
      }
      // Kiểm tra định dạng ngày sinh dd/mm/yyyy
      if (!/^([0-2]\d|3[01])\/(0\d|1[0-2])\/\d{4}$/.test(row.ngay_sinh)) {
        return `Dòng ${rowNum}: Ngày sinh "${row.ngay_sinh}" không đúng định dạng dd/mm/yyyy.`;
      }
      // Kiểm tra định dạng số điện thoại
      if (!isValidPhoneNumber(row.sdt_lienhe)) {
        return `Dòng ${rowNum}: SĐT "${row.sdt_lienhe}" không hợp lệ.`;
      }
      // Kiểm tra định dạng số định danh (giả sử là 12 số, bạn chỉnh lại nếu cần)
      if (!isValidSoDinhDanh(row.so_dinh_danh)) {
        return `Dòng ${rowNum}: Số định danh "${row.so_dinh_danh}" không hợp lệ.`;
      }
      // Kiểm tra trùng trong file import
      if (soDinhDanhSet.has(row.so_dinh_danh)) {
        return `Dòng ${rowNum}: Số định danh "${row.so_dinh_danh}" bị trùng trong file import.`;
      }
      if (maSoBHXHSet.has(row.ma_so_bhxh)) {
        return `Dòng ${rowNum}: Mã số BHXH "${row.ma_so_bhxh}" bị trùng trong file import.`;
      }
      soDinhDanhSet.add(row.so_dinh_danh);
      maSoBHXHSet.add(row.ma_so_bhxh);
      // Kiểm tra trùng với dữ liệu đã có
      if (existedSoDinhDanhSet.has(row.so_dinh_danh)) {
        return `Dòng ${rowNum}: Số định danh "${row.so_dinh_danh}" đã tồn tại trên hệ thống.`;
      }
      if (existedMaSoBHXHSet.has(row.ma_so_bhxh)) {
        return `Dòng ${rowNum}: Mã số BHXH "${row.ma_so_bhxh}" đã tồn tại trên hệ thống.`;
      }
      return null;
    }

    // Kiểm tra SĐT hợp lệ (10 số, bắt đầu bằng 0)
    function isValidPhoneNumber(phone) {
      return /^0\d{9}$/.test(phone.trim());
    }

    // Kiểm tra số định danh hợp lệ (giả sử là 12 số)
    function isValidSoDinhDanh(s) {
      return /^\d{12}$/.test(s.trim());
    }

    // Lấy set theo trường bất kỳ từ mảng dữ liệu đã có
    function makeSetByField(arr, field) {
      const set = new Set();
      arr.forEach(row => {
        if (row[field]) set.add(String(row[field]).trim());
      });
      return set;
    }


  </script>





  <script>
    $(function() {
      // Khởi tạo Datepicker cho input thêm và sửa
      $('#inp-ngay-sinh, #sua-ngay-sinh').datepicker({
        format: 'dd/mm/yyyy',
        language: 'vi',
        autoclose: true,
        todayHighlight: true,
        clearBtn: true
      });

      // Reset ngày sinh khi mở modal Thêm mới
      $('#modalThemHS').on('show.bs.modal', function() {
        $('#inp-ngay-sinh').datepicker('update', '');
      });

      // Chuyển đổi yyyy-mm-dd sang dd/mm/yyyy khi mở modal Sửa
      $('#modalSuaHS').on('shown.bs.modal', function () {
        let val = $('#sua-ngay-sinh').val();
        if (val && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
          let [y,m,d] = val.split('-');
          $('#sua-ngay-sinh').datepicker('update', `${d}/${m}/${y}`);
        }
      });
    });
  </script>


</body>
</html>
