<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 12px; }
    .total-hs { font-size: 16px; color: #555; margin-left: 8px;}
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer;}
    .table-responsive { overflow-x: auto; }
    .pagination { justify-content: center; }
    .search-row { margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .search-input { flex: 1 1 220px; max-width: 320px; }
  </style>
</head>
<body>
  <div class="header">
    DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span>
    <span class="total-hs" id="total-hs"></span>
  </div>
  <div id="ds-actions" style="margin-bottom:12px;"></div>
  <div class="search-row">
    <input class="form-control search-input" id="search-box" placeholder="Tìm kiếm theo tên, số định danh, mã số BHXH, SĐT"/>
    <button class="btn btn-secondary" onclick="doSearch()">Tìm kiếm</button>
    <button class="btn btn-outline-secondary" onclick="clearSearch()">Xóa lọc</button>
  </div>
  <div class="table-responsive" id="ds-container"></div>
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>

  <!-- Modal thêm mới học sinh -->
  <div class="modal fade" id="modalThemHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Thêm mới học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="form-themhs">
          <input class="form-control mb-2" id="inp-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="inp-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="inp-ngay-sinh" type="date" placeholder="Ngày sinh"/>
          <input class="form-control mb-2" id="inp-gioi-tinh" placeholder="Giới tính"/>
          <input class="form-control mb-2" id="inp-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="inp-lop" placeholder="Lớp"/>
          <input class="form-control mb-2" id="inp-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="inp-so-dinh-danh" placeholder="Số định danh"/>
        </div>
        <div id="themhs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleThemHS()">Thêm mới</button>
      </div>
    </div></div>
  </div>

  <!-- Modal nhập file excel -->
  <div class="modal fade" id="modalImportHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
        <div id="import-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleImportHS()">Nhập danh sách</button>
      </div>
    </div></div>
  </div>

  <div id="loadingSpinner" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background:rgba(255,255,255,0.5); 
      align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    // --- Data/Pagination State ---
    let dsHocsinhAll = [];
    let dsHocsinhFiltered = [];
    let currentPage = 1, pageSize = 10, totalPages = 1;

    // --- Format Ngày ---
    function excelDateToString(dateCell) {
      if (typeof dateCell === 'string') {
        if (dateCell.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) return dateCell;
        if (dateCell.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          let [y,m,d] = dateCell.split('-');
          return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
        }
        return dateCell;
      }
      if (typeof dateCell === 'number') {
        var utc_days = Math.floor(dateCell - 25569);
        var date = new Date(utc_days * 86400 * 1000);
        date.setUTCHours(0,0,0,0);
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return "";
    }

    function displayNgaySinh(raw) {
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) {
        let d = new Date(raw);
        let day = String(d.getDate()).padStart(2, '0');
        let month = String(d.getMonth() + 1).padStart(2, '0');
        let year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y,m,d] = raw.split('-');
        return `${d}/${m}/${y}`;
      }
      if (!isNaN(Number(raw))) return excelDateToString(Number(raw));
      return raw;
    }

    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

    // --- Fetch & Render ---
    async function fetchAndRenderAll() {
      showLoading();
      const res = await getDanhSachHocsinh(user.ma_truong, user.lop_hoc);
      dsHocsinhAll = res.hocsinhs || res.data || [];
      dsHocsinhFiltered = [...dsHocsinhAll];
      currentPage = 1;
      renderDanhSachHS();
      renderPagination();
      hideLoading();
    }

    // --- Search ---
    function doSearch() {
      const q = document.getElementById('search-box').value.trim().toLowerCase();
      dsHocsinhFiltered = !q
        ? [...dsHocsinhAll]
        : dsHocsinhAll.filter(hs =>
            (hs.ho_ten_hoc_sinh||"").toLowerCase().includes(q) ||
            (hs.so_dinh_danh||"").toLowerCase().includes(q) ||
            (hs.ma_so_bhxh||"").toLowerCase().includes(q) ||
            (hs.sdt_lienhe||"").toLowerCase().includes(q)
          );
      currentPage = 1;
      renderDanhSachHS();
      renderPagination();
    }
    function clearSearch() {
      document.getElementById('search-box').value = "";
      dsHocsinhFiltered = [...dsHocsinhAll];
      currentPage = 1;
      renderDanhSachHS();
      renderPagination();
    }

    // --- Render Table + Tổng số + Pagination ---
    function renderDanhSachHS() {
      const total = dsHocsinhFiltered.length;
      document.getElementById('total-hs').innerText = total > 0 ? `(${total} học sinh)` : "(0 học sinh)";
      if (total === 0) {
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Chưa có dữ liệu học sinh cho lớp này.</div>`;
        return;
      }
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = dsHocsinhFiltered.slice(start, end);
      let html = `<table class="table table-bordered table-hs">
        <thead>
        <tr>
          <th>STT</th><th>Mã số BHXH</th><th>Họ tên</th><th>Ngày sinh</th>
          <th>Giới tính</th><th>Địa chỉ</th><th>Lớp</th>
          <th>SĐT liên hệ</th><th>Số định danh</th>
        </tr></thead><tbody>`;
      pageData.forEach((hs, i) => {
        html += `<tr>
          <td>${start + i + 1}</td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;
    }

    function renderPagination() {
      const total = dsHocsinhFiltered.length;
      totalPages = Math.ceil(total / pageSize) || 1;
      const pagin = document.getElementById('pagination');
      pagin.innerHTML = '';
      if (totalPages <= 1) return;
      pagin.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      for (let p = 1; p <= totalPages; p++) {
        pagin.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      }
      pagin.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function(p) {
      if (p<1||p>totalPages||p===currentPage) return;
      currentPage = p;
      renderDanhSachHS();
      renderPagination();
    };

    // Tải file mẫu nhập học sinh
    function downloadMauHS() {
      window.open("../mau_nhap_hocsinh.xlsx", "_blank");
    }

    // Thêm mới học sinh đơn lẻ (show modal)
    function showModalThemHS() {
      document.getElementById('form-themhs').reset?.(); 
      document.getElementById('themhs-error').innerText = "";
      new bootstrap.Modal(document.getElementById('modalThemHS')).show();
    }
    async function handleThemHS() {
      let ngaySinhRaw = document.getElementById('inp-ngay-sinh').value;
      let ngaySinh = "";
      if (ngaySinhRaw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y, m, d] = ngaySinhRaw.split("-");
        ngaySinh = `${d}/${m}/${y}`;
      } else ngaySinh = ngaySinhRaw;
      const hs = {
        ma_so_bhxh: String(document.getElementById('inp-ma-so-bhxh').value.trim()),
        ho_ten_hoc_sinh: document.getElementById('inp-ho-ten-hs').value.trim(),
        ngay_sinh: ngaySinh,
        gioi_tinh: document.getElementById('inp-gioi-tinh').value.trim(),
        dia_chi: document.getElementById('inp-dia-chi').value.trim(),
        lop: user.lop_hoc,
        sdt_lienhe: document.getElementById('inp-sdt-lienhe').value.trim(),
        so_dinh_danh: String(document.getElementById('inp-so-dinh-danh').value.trim()),
        ma_truong: user.ma_truong
      };
      if (!hs.ho_ten_hoc_sinh || !hs.lop) {
        document.getElementById('themhs-error').innerText = "Vui lòng nhập đủ thông tin bắt buộc!";
        return;
      }
      showLoading();
      const res = await themHocsinh(hs);
      hideLoading();
      if (res.success) {
        await fetchAndRenderAll();
        bootstrap.Modal.getInstance(document.getElementById('modalThemHS')).hide();
      } else {
        document.getElementById('themhs-error').innerText = res.message || "Lỗi thêm học sinh!";
      }
    }

    // Thêm học sinh từ file (show modal)
    function showModalImportHS() {
      document.getElementById('import-error').innerText = "";
      document.getElementById('import-file').value = "";
      new bootstrap.Modal(document.getElementById('modalImportHS')).show();
    }

    async function handleImportHS() {
      const fileInput = document.getElementById('import-file');
      const errorDiv = document.getElementById('import-error');
      errorDiv.innerText = "";
      if (!fileInput.files.length) {
        errorDiv.innerText = "Vui lòng chọn file!";
        return;
      }
      const file = fileInput.files[0];
      showLoading();
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        rows.shift();
        const ds = rows.map(row => ({
          ma_so_bhxh: String(row[1] || ""),
          ho_ten_hoc_sinh: row[2] || "",
          ngay_sinh: excelDateToString(row[3]),
          gioi_tinh: row[4] || "",
          dia_chi: row[5] || "",
          lop: row[6] || user.lop_hoc,
          sdt_lienhe: row[7] || "",
          so_dinh_danh: String(row[8] || ""),
          ma_truong: user.ma_truong
        }));
        const res = await importDanhSachHocsinh(ds);
        hideLoading();
        if (res.success) {
          await fetchAndRenderAll();
          bootstrap.Modal.getInstance(document.getElementById('modalImportHS')).hide();
        } else {
          errorDiv.innerText = res.message || "Lỗi import dữ liệu!";
        }
      } catch (err) {
        hideLoading();
        errorDiv.innerText = "Lỗi đọc file hoặc dữ liệu không đúng định dạng!";
      }
    }

    // --- Init ---
    window.onload = fetchAndRenderAll;
  </script>
</body>
</html>
