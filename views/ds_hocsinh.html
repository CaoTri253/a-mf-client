<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 18px; }
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer;}
  </style>
</head>
<body>
  <div class="header">DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span></div>
  <div id="ds-actions" style="margin-bottom:18px;"></div>
  <div id="ds-container"></div>

  <!-- Modal thêm mới học sinh -->
  <div class="modal fade" id="modalThemHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Thêm mới học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="form-themhs">
          <input class="form-control mb-2" id="inp-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="inp-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="inp-ngay-sinh" type="date" placeholder="Ngày sinh"/>
          <input class="form-control mb-2" id="inp-gioi-tinh" placeholder="Giới tính"/>
          <input class="form-control mb-2" id="inp-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="inp-lop" placeholder="Lớp"/>
          <input class="form-control mb-2" id="inp-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="inp-so-dinh-danh" placeholder="Số định danh"/>
        </div>
        <div id="themhs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleThemHS()">Thêm mới</button>
      </div>
    </div></div>
  </div>

  <!-- Modal nhập file excel -->
  <div class="modal fade" id="modalImportHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
        <div id="import-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleImportHS()">Nhập danh sách</button>
      </div>
    </div></div>
  </div>

  <div id="loadingSpinner" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background:rgba(255,255,255,0.5); 
      align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    // Show loading helpers
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

    // Khởi tạo trang: lấy danh sách học sinh
    window.onload = async function() {
    showLoading();
    const res = await getDanhSachHocsinh(user.ma_truong, user.lop_hoc);
    hideLoading();
    if (res.success && res.hocsinhs && res.hocsinhs.length > 0) {
      renderDanhSachHS(res.hocsinhs);
    } else {
      // Nếu chưa có học sinh, show các nút thêm/import + tải mẫu
      document.getElementById('ds-actions').innerHTML = `
        <button class="btn btn-success btn-main" onclick="showModalThemHS()">Thêm mới học sinh</button>
        <button class="btn btn-primary btn-main" onclick="showModalImportHS()">Thêm học sinh từ danh sách có sẵn</button>
        <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
      `;
      document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Chưa có dữ liệu học sinh cho lớp này.</div>`;
    }
  };


    // Render danh sách học sinh ra bảng
    function renderDanhSachHS(ds) {
      let html = `<div class="table-responsive"><table class="table table-bordered table-hs">
        <thead>
        <tr>
          <th>STT</th><th>Mã số BHXH</th><th>Họ tên</th><th>Ngày sinh</th>
          <th>Giới tính</th><th>Địa chỉ</th><th>Lớp</th>
          <th>SĐT liên hệ</th><th>Số định danh</th>
        </tr></thead><tbody>`;
      ds.forEach((hs, i) => {
        html += `<tr>
          <td>${i+1}</td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${hs.ngay_sinh||""}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += "</tbody></table></div>";
      document.getElementById('ds-actions').innerHTML = `
          <button class="btn btn-success btn-main" onclick="showModalThemHS()">Thêm mới học sinh</button>
          <button class="btn btn-primary btn-main" onclick="showModalImportHS()">Thêm học sinh từ danh sách có sẵn</button>
          <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
      `;
      document.getElementById('ds-container').innerHTML = html;
    }

    // Tải file mẫu nhập học sinh
    function downloadMauHS() {
      window.open("../mau_nhap_hocsinh.xlsx", "_blank");
    }

    // Thêm mới học sinh đơn lẻ (show modal)
    function showModalThemHS() {
      document.getElementById('form-themhs').reset?.(); // Nếu là form
      document.getElementById('themhs-error').innerText = "";
      new bootstrap.Modal(document.getElementById('modalThemHS')).show();
    }
    // Xử lý submit thêm mới
    async function handleThemHS() {
      const hs = {
        ma_so_bhxh: document.getElementById('inp-ma-so-bhxh').value.trim(),
        ho_ten_hoc_sinh: document.getElementById('inp-ho-ten-hs').value.trim(),
        ngay_sinh: document.getElementById('inp-ngay-sinh').value,
        gioi_tinh: document.getElementById('inp-gioi-tinh').value.trim(),
        dia_chi: document.getElementById('inp-dia-chi').value.trim(),
        lop: user.lop_hoc,
        sdt_lienhe: document.getElementById('inp-sdt-lienhe').value.trim(),
        so_dinh_danh: document.getElementById('inp-so-dinh-danh').value.trim(),
        ma_truong: user.ma_truong
      };
      if (!hs.ho_ten_hoc_sinh || !hs.lop) {
        document.getElementById('themhs-error').innerText = "Vui lòng nhập đủ thông tin bắt buộc!";
        return;
      }
      showLoading();
      const res = await themHocsinh(hs);
      hideLoading();
      if (res.success) {
        location.reload();
      } else {
        document.getElementById('themhs-error').innerText = res.message || "Lỗi thêm học sinh!";
      }
    }

    // Thêm học sinh từ file (show modal)
    function showModalImportHS() {
      document.getElementById('import-error').innerText = "";
      document.getElementById('import-file').value = "";
      new bootstrap.Modal(document.getElementById('modalImportHS')).show();
    }

    // Xử lý import danh sách học sinh
    async function handleImportHS() {
      const fileInput = document.getElementById('import-file');
      const errorDiv = document.getElementById('import-error');
      errorDiv.innerText = "";
      if (!fileInput.files.length) {
        errorDiv.innerText = "Vui lòng chọn file!";
        return;
      }
      const file = fileInput.files[0];
      showLoading();
      try {
        // Đọc file excel bằng SheetJS
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        // Bỏ header
        rows.shift();
        // Map thành object
        const ds = rows.map(row => ({
          ma_so_bhxh: row[1],
          ho_ten_hoc_sinh: row[2],
          ngay_sinh: row[3],
          gioi_tinh: row[4],
          dia_chi: row[5],
          lop: row[6] || user.lop_hoc,
          sdt_lienhe: row[7],
          so_dinh_danh: row[8],
          ma_truong: user.ma_truong
        }));
        // Gửi lên backend
        const res = await importDanhSachHocsinh(ds);
        hideLoading();
        if (res.success) {
          location.reload();
        } else {
          errorDiv.innerText = res.message || "Lỗi import dữ liệu!";
        }
      } catch (err) {
        hideLoading();
        errorDiv.innerText = "Lỗi đọc file hoặc dữ liệu không đúng định dạng!";
      }
    }
  </script>
</body>
</html>
