<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 18px; }
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer;}
    .table-responsive { overflow-x: auto; }
    .search-row { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 10px; gap: 12px;}
    .search-input { flex: 1; min-width: 180px;}
    .total-count { font-size: 1rem; font-weight: 400; color: #444;}
    @media (max-width: 600px) {
      .header { font-size: 18px; }
      .search-row { flex-direction: column; align-items: stretch; }
      .btn-main { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="header">
    DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span>
    <span class="total-count" id="total-hs"></span>
  </div>

  <div id="ds-actions" style="margin-bottom:14px;"></div>
  <div class="search-row mb-2">
    <input class="form-control search-input" id="search-box" placeholder="Tìm kiếm theo tên, mã BHXH, số ĐT, số định danh...">
    <button class="btn btn-outline-primary" onclick="doSearch()">Tìm kiếm</button>
    <button class="btn btn-outline-secondary" onclick="clearSearch()">Xóa tìm</button>
  </div>
  <div class="table-responsive" id="ds-container"></div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>

  <!-- Modal thêm mới học sinh -->
  <div class="modal fade" id="modalThemHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Thêm mới học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-themhs" onsubmit="event.preventDefault();handleThemHS();">
          <input class="form-control mb-2" id="inp-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="inp-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="inp-ngay-sinh" type="date" placeholder="Ngày sinh"/>

          <label class="mb-1">Giới tính:</label>
          <div class="mb-2" style="display: flex; gap: 16px;">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="gioi_tinh" id="gt-nam" value="Nam" checked>
              <label class="form-check-label" for="gt-nam">Nam</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="gioi_tinh" id="gt-nu" value="Nữ">
              <label class="form-check-label" for="gt-nu">Nữ</label>
            </div>
          </div>

          <input class="form-control mb-2" id="inp-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="inp-lop" placeholder="Lớp" disabled/>
          <input class="form-control mb-2" id="inp-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="inp-so-dinh-danh" placeholder="Số định danh"/>
          <input class="form-control mb-2" id="inp-ten-cha-me" placeholder="Tên cha/mẹ học sinh"/>
        </form>
        <div id="themhs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleThemHS()">Thêm mới</button>
      </div>
    </div></div>
  </div>

  <!-- Modal nhập file excel -->
  <div class="modal fade" id="modalImportHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
        <div id="import-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleImportHS()">Nhập danh sách</button>
      </div>
    </div></div>
  </div>

  <div id="loadingSpinner" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background:rgba(255,255,255,0.5); 
      align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    // ==== Cấu hình phân trang ====
    let pageSize = 10;
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;

    // ==== Hàm tiện ích ngày/tháng ====
    function excelDateToString(dateCell) {
      if (typeof dateCell === 'string') {
        if (dateCell.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) return dateCell;
        if (dateCell.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          let [y,m,d] = dateCell.split('-');
          return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
        }
        return dateCell;
      }
      if (typeof dateCell === 'number') {
        var utc_days = Math.floor(dateCell - 25569);
        var date = new Date(utc_days * 86400 * 1000);
        date.setUTCHours(0,0,0,0);
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return "";
    }
    function displayNgaySinh(raw) {
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) {
        let d = new Date(raw);
        let day = String(d.getDate()).padStart(2, '0');
        let month = String(d.getMonth() + 1).padStart(2, '0');
        let year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y,m,d] = raw.split('-');
        return `${d}/${m}/${y}`;
      }
      if (!isNaN(Number(raw))) return excelDateToString(Number(raw));
      return raw;
    }

    // ==== Hiện/tắt loading ====
    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

    // ==== Tìm kiếm & phân trang ====
    async function fetchAndRenderAll() {
      showLoading();
      const start = (currentPage - 1) * pageSize;
      const query = document.getElementById('search-box').value.trim();
      const res = await getDanhSachHocsinhPaginated(user.ma_truong, user.lop_hoc, start, pageSize, query);
      hideLoading();
      const ds = res.data || [];
      totalRecords = res.total || 0;
      totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
      document.getElementById('total-hs').innerText = `(${totalRecords} học sinh)`;
      renderDanhSachHS(ds, start);
      renderPagination();
      renderActions();
    }

    function doSearch() {
      currentPage = 1;
      fetchAndRenderAll();
    }
    function clearSearch() {
      document.getElementById('search-box').value = "";
      doSearch();
    }

    function renderDanhSachHS(ds, offset) {
      if (!ds || ds.length === 0) {
        document.getElementById('ds-container').innerHTML = `<div class='text-center text-secondary mt-4'>Chưa có dữ liệu học sinh cho lớp này.</div>`;
        return;
      }
      let html = `<table class="table table-bordered table-hs">
        <thead>
        <tr>
          <th>STT</th><th>Mã số BHXH</th><th>Họ tên</th><th>Ngày sinh</th>
          <th>Giới tính</th><th>Địa chỉ</th><th>Lớp</th>
          <th>SĐT liên hệ</th><th>Số định danh</th><th>Tên cha/mẹ</th>
        </tr></thead><tbody>`;
      ds.forEach((hs, i) => {
        html += `<tr>
          <td>${offset + i + 1}</td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
          <td>${hs.ten_cha_me||""}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById('ds-container').innerHTML = html;
    }

    function renderPagination() {
      const pagin = document.getElementById('pagination');
      pagin.innerHTML = '';
      if (totalPages <= 1) return;
      pagin.innerHTML += `<li class="page-item${currentPage===1?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage-1});return false;">Trước</a></li>`;
      let minP = Math.max(1, currentPage-2), maxP = Math.min(totalPages, currentPage+2);
      if (minP > 1) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(1);return false;">1</a></li>`;
      if (minP > 2) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      for (let p = minP; p <= maxP; p++) {
        pagin.innerHTML += `<li class="page-item${p===currentPage?' active':''}"><a class="page-link" href="#" onclick="gotoPage(${p});return false;">${p}</a></li>`;
      }
      if (maxP < totalPages-1) pagin.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
      if (maxP < totalPages) pagin.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(${totalPages});return false;">${totalPages}</a></li>`;
      pagin.innerHTML += `<li class="page-item${currentPage===totalPages?' disabled':''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage+1});return false;">Sau</a></li>`;
    }
    window.gotoPage = function(p) {
      if (p<1||p>totalPages||p===currentPage) return;
      currentPage = p;
      fetchAndRenderAll();
    };

    function renderActions() {
      document.getElementById('ds-actions').innerHTML = `
        <button class="btn btn-success btn-main" onclick="showModalThemHS()">Thêm mới học sinh</button>
        <button class="btn btn-primary btn-main" onclick="showModalImportHS()">Thêm học sinh từ danh sách có sẵn</button>
        <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
      `;
    }

    function downloadMauHS() {
      window.open("../mau_nhap_hocsinh.xlsx", "_blank");
    }

    // ==== Thêm mới/Import ====
    function showModalThemHS() {
      document.getElementById('form-themhs').reset?.();
      document.getElementById('themhs-error').innerText = "";
      // Thiết lập lại lớp mặc định và radio giới tính mặc định
      document.getElementById('inp-lop').value = user.lop_hoc || "";
      document.getElementById('gt-nam').checked = true;
      new bootstrap.Modal(document.getElementById('modalThemHS')).show();
    }
    async function handleThemHS() {
      let ngaySinhRaw = document.getElementById('inp-ngay-sinh').value;
      let ngaySinh = "";
      if (ngaySinhRaw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y, m, d] = ngaySinhRaw.split("-");
        ngaySinh = `${d}/${m}/${y}`;
      } else ngaySinh = ngaySinhRaw;

      // Lấy giới tính từ radio
      let gioiTinh = document.querySelector('input[name="gioi_tinh"]:checked')?.value || "";

      const hs = {
        ma_so_bhxh: String(document.getElementById('inp-ma-so-bhxh').value.trim()),
        ho_ten_hoc_sinh: document.getElementById('inp-ho-ten-hs').value.trim(),
        ngay_sinh: ngaySinh,
        gioi_tinh: gioiTinh,
        dia_chi: document.getElementById('inp-dia-chi').value.trim(),
        lop: user.lop_hoc,
        sdt_lienhe: document.getElementById('inp-sdt-lienhe').value.trim(),
        so_dinh_danh: String(document.getElementById('inp-so-dinh-danh').value.trim()),
        ten_cha_me: document.getElementById('inp-ten-cha-me').value.trim(),
        ma_truong: user.ma_truong
      };
      
      if (!hs.ho_ten_hoc_sinh || !hs.lop) {
        document.getElementById('themhs-error').innerText = "Vui lòng nhập đủ thông tin bắt buộc!";
        return;
      }
      showLoading();
      const res = await themHocsinh(hs);
      hideLoading();
      if (res.success) {
        await fetchAndRenderAll();
        bootstrap.Modal.getInstance(document.getElementById('modalThemHS')).hide();
      } else {
        document.getElementById('themhs-error').innerText = res.message || "Lỗi thêm học sinh!";
      }
    }

    function showModalImportHS() {
      document.getElementById('import-error').innerText = "";
      document.getElementById('import-file').value = "";
      new bootstrap.Modal(document.getElementById('modalImportHS')).show();
    }

    async function handleImportHS() {
      const fileInput = document.getElementById('import-file');
      const errorDiv = document.getElementById('import-error');
      errorDiv.innerText = "";
      if (!fileInput.files.length) {
        errorDiv.innerText = "Vui lòng chọn file!";
        return;
      }
      const file = fileInput.files[0];
      showLoading();
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        rows.shift();
        const ds = rows.map(row => ({
          ma_so_bhxh: String(row[1] || ""),
          ho_ten_hoc_sinh: row[2] || "",
          ngay_sinh: excelDateToString(row[3]),
          gioi_tinh: row[4] || "",
          dia_chi: row[5] || "",
          lop: row[6] || user.lop_hoc,
          sdt_lienhe: row[7] || "",
          so_dinh_danh: String(row[8] || ""),
          ten_cha_me: row[9] || "",
          ma_truong: user.ma_truong
        }));
        const res = await importDanhSachHocsinh(ds);
        hideLoading();
        if (res.success) {
          await fetchAndRenderAll();
          bootstrap.Modal.getInstance(document.getElementById('modalImportHS')).hide();
        } else {
          errorDiv.innerText = res.message || "Lỗi import dữ liệu!";
        }
      } catch (err) {
        hideLoading();
        errorDiv.innerText = "Lỗi đọc file hoặc dữ liệu không đúng định dạng!";
      }
    }

    // Khởi tạo trang
    window.onload = fetchAndRenderAll;
  </script>
</body>
</html>
