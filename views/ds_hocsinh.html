<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách học sinh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; min-height: 100vh; padding: 20px; }
    .header { font-size: 22px; font-weight: bold; margin-bottom: 18px; }
    .total-count { font-size: 17px; font-weight: normal; color: #007bff; margin-left: 8px; }
    .btn-main { margin: 5px 8px 10px 0; }
    .table-hs { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #0002;}
    .download-link { margin-left: 15px; color: #007bff; cursor: pointer;}
    .table-responsive { overflow-x: auto; }
    .pagination-wrapper { display: flex; justify-content: center; align-items: center; margin-top: 18px; gap: 10px; flex-wrap: wrap;}
    .pagination-btn { min-width: 36px; border-radius: 6px !important;}
    .pagination-btn.active, .pagination-btn.btn-primary { background: #0d6efd !important; color: #fff !important; border-color: #0d6efd !important;}
    .pagination-info { font-weight: 500; color: #444; }
    .pagination-quick { min-width: 70px;}
    @media (max-width: 600px) {
      .header { font-size: 17px;}
      .table-hs th, .table-hs td { font-size: 13px;}
      .btn-main, .btn, .pagination-btn { font-size: 13px !important; padding: 7px 8px;}
      .pagination-info { font-size: 12px;}
    }
  </style>
</head>
<body>
  <div class="header">
    DANH SÁCH HỌC SINH LỚP <span id="lop-hoc"></span>
    <span class="total-count" id="total-count"></span>
  </div>
  <!-- Thanh tìm kiếm -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Tìm tên, số định danh, mã BHXH, SĐT..." oninput="onSearchChange()">
  </div>
  <div id="ds-actions" style="margin-bottom:18px;"></div>
  <div class="table-responsive" id="ds-container"></div>
  <div id="pagination" class="pagination-wrapper"></div>

  <!-- Modal thêm mới học sinh -->
  <div class="modal fade" id="modalThemHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Thêm mới học sinh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="form-themhs">
          <input class="form-control mb-2" id="inp-ma-so-bhxh" placeholder="Mã số BHXH"/>
          <input class="form-control mb-2" id="inp-ho-ten-hs" placeholder="Họ tên học sinh"/>
          <input class="form-control mb-2" id="inp-ngay-sinh" type="date" placeholder="Ngày sinh"/>
          <input class="form-control mb-2" id="inp-gioi-tinh" placeholder="Giới tính"/>
          <input class="form-control mb-2" id="inp-dia-chi" placeholder="Địa chỉ"/>
          <input class="form-control mb-2" id="inp-lop" placeholder="Lớp"/>
          <input class="form-control mb-2" id="inp-sdt-lienhe" placeholder="Số ĐT liên hệ"/>
          <input class="form-control mb-2" id="inp-so-dinh-danh" placeholder="Số định danh"/>
        </div>
        <div id="themhs-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleThemHS()">Thêm mới</button>
      </div>
    </div></div>
  </div>

  <!-- Modal nhập file excel -->
  <div class="modal fade" id="modalImportHS" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nhập từ danh sách có sẵn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="import-file" class="form-control mb-2" accept=".xlsx,.xls"/>
        <div id="import-error" class="text-danger" style="min-height:20px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button class="btn btn-primary" onclick="handleImportHS()">Nhập danh sách</button>
      </div>
    </div></div>
  </div>

  <div id="loadingSpinner" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background:rgba(255,255,255,0.5); 
      align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.sdt || user.phan_quyen !== "giao_vien") window.location.href = "../index.html";
    document.getElementById("lop-hoc").innerText = user.lop_hoc || "(chưa xác định)";

    // Pagination state
    let dsHocsinhAll = [];
    let page = 1, pageSize = 20, total = 0, lastQuery = "";

    function showLoading() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

    // Lấy danh sách tất cả (áp dụng search trên frontend)
    async function fetchAndRenderAll(query = "", gotoPage = 1) {
      showLoading();
      let res = await getDanhSachHocsinh(user.ma_truong, user.lop_hoc);
      hideLoading();
      dsHocsinhAll = res.hocsinhs || res.data || [];
      // Filter theo search
      if (query && query.length > 0) {
        let q = query.toLowerCase();
        dsHocsinhAll = dsHocsinhAll.filter(hs =>
          (hs.ho_ten_hoc_sinh || "").toLowerCase().includes(q) ||
          (hs.so_dinh_danh || "").toLowerCase().includes(q) ||
          (hs.ma_so_bhxh || "").toLowerCase().includes(q) ||
          (hs.sdt_lienhe || "").toLowerCase().includes(q)
        );
      }
      total = dsHocsinhAll.length;
      page = gotoPage || 1;
      renderDanhSachHS();
      renderPagination();
    }

    function onSearchChange() {
      lastQuery = document.getElementById('searchInput').value.trim();
      fetchAndRenderAll(lastQuery, 1);
    }
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
      if (e.key === "Enter") onSearchChange();
    });

    window.onload = function() {
      fetchAndRenderAll();
    };

    // Chuyển đổi ngày từ Excel serial/chuỗi sang dd/mm/yyyy
    function excelDateToString(dateCell) {
      if (typeof dateCell === 'string') {
        if (dateCell.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) return dateCell;
        if (dateCell.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          let [y,m,d] = dateCell.split('-');
          return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
        }
        return dateCell;
      }
      if (typeof dateCell === 'number') {
        var utc_days = Math.floor(dateCell - 25569);
        var date = new Date(utc_days * 86400 * 1000);
        date.setUTCHours(0,0,0,0);
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return "";
    }
    function displayNgaySinh(raw) {
      if (!raw) return "";
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}T/)) {
        let d = new Date(raw);
        let day = String(d.getDate()).padStart(2, '0');
        let month = String(d.getMonth() + 1).padStart(2, '0');
        let year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      if (raw.match && raw.match(/^\d{2}\/\d{2}\/\d{4}$/)) return raw;
      if (raw.match && raw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y,m,d] = raw.split('-');
        return `${d}/${m}/${y}`;
      }
      if (!isNaN(Number(raw))) return excelDateToString(Number(raw));
      return raw;
    }

    function renderDanhSachHS() {
      document.getElementById('total-count').innerText = `(Tổng số: ${total})`;
      let ds = dsHocsinhAll.slice((page-1)*pageSize, page*pageSize);
      let html = `<table class="table table-bordered table-hs">
        <thead>
        <tr>
          <th>STT</th><th>Mã số BHXH</th><th>Họ tên</th><th>Ngày sinh</th>
          <th>Giới tính</th><th>Địa chỉ</th><th>Lớp</th>
          <th>SĐT liên hệ</th><th>Số định danh</th>
        </tr></thead><tbody>`;
      ds.forEach((hs, i) => {
        html += `<tr>
          <td>${(page-1)*pageSize + i + 1}</td>
          <td>${hs.ma_so_bhxh||""}</td>
          <td>${hs.ho_ten_hoc_sinh||""}</td>
          <td>${displayNgaySinh(hs.ngay_sinh)}</td>
          <td>${hs.gioi_tinh||""}</td>
          <td>${hs.dia_chi||""}</td>
          <td>${hs.lop||""}</td>
          <td>${hs.sdt_lienhe||""}</td>
          <td>${hs.so_dinh_danh||""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('ds-actions').innerHTML = `
          <button class="btn btn-success btn-main" onclick="showModalThemHS()">Thêm mới học sinh</button>
          <button class="btn btn-primary btn-main" onclick="showModalImportHS()">Thêm học sinh từ danh sách có sẵn</button>
          <span class="download-link" onclick="downloadMauHS()">Tải mẫu excel nhập học sinh</span>
      `;
      document.getElementById('ds-container').innerHTML = html;
    }

    function renderPagination() {
      const pagDiv = document.getElementById('pagination');
      pagDiv.innerHTML = "";
      if (total <= pageSize) return;
      const totalPages = Math.ceil(total / pageSize);
      let html = `
        <button class="btn btn-secondary pagination-btn pagination-quick" ${page==1?"disabled":""} onclick="goPage(1)">« Đầu</button>
        <button class="btn btn-secondary pagination-btn" ${page==1?"disabled":""} onclick="goPage(${page-1})">← Trước</button>`;
      // Hiển thị tối đa 5 trang lân cận
      let start = Math.max(1, page-2), end = Math.min(totalPages, page+2);
      if (page <= 3) end = Math.min(5, totalPages);
      if (page >= totalPages-2) start = Math.max(1, totalPages-4);
      for (let i = start; i <= end; i++) {
        html += `<button class="btn pagination-btn ${i==page?'active btn-primary':''}" onclick="goPage(${i})">${i}</button>`;
      }
      html += `
        <button class="btn btn-secondary pagination-btn" ${page==totalPages?"disabled":""} onclick="goPage(${page+1})">Tiếp →</button>
        <button class="btn btn-secondary pagination-btn pagination-quick" ${page==totalPages?"disabled":""} onclick="goPage(${totalPages})">Cuối »</button>
        <span class="pagination-info ms-2">Trang ${page}/${totalPages}</span>
        `;
      pagDiv.innerHTML = html;
    }
    function goPage(p) {
      page = p;
      renderDanhSachHS();
      renderPagination();
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // Các chức năng thêm/import
    function downloadMauHS() {
      window.open("../mau_nhap_hocsinh.xlsx", "_blank");
    }
    function showModalThemHS() {
      document.getElementById('form-themhs').reset?.(); 
      document.getElementById('themhs-error').innerText = "";
      new bootstrap.Modal(document.getElementById('modalThemHS')).show();
    }
    async function handleThemHS() {
      let ngaySinhRaw = document.getElementById('inp-ngay-sinh').value;
      let ngaySinh = "";
      if (ngaySinhRaw.match(/^\d{4}-\d{2}-\d{2}$/)) {
        let [y, m, d] = ngaySinhRaw.split("-");
        ngaySinh = `${d}/${m}/${y}`;
      } else ngaySinh = ngaySinhRaw;
      const hs = {
        ma_so_bhxh: String(document.getElementById('inp-ma-so-bhxh').value.trim()),
        ho_ten_hoc_sinh: document.getElementById('inp-ho-ten-hs').value.trim(),
        ngay_sinh: ngaySinh,
        gioi_tinh: document.getElementById('inp-gioi-tinh').value.trim(),
        dia_chi: document.getElementById('inp-dia-chi').value.trim(),
        lop: user.lop_hoc,
        sdt_lienhe: document.getElementById('inp-sdt-lienhe').value.trim(),
        so_dinh_danh: String(document.getElementById('inp-so-dinh-danh').value.trim()),
        ma_truong: user.ma_truong
      };
      if (!hs.ho_ten_hoc_sinh || !hs.lop) {
        document.getElementById('themhs-error').innerText = "Vui lòng nhập đủ thông tin bắt buộc!";
        return;
      }
      showLoading();
      const res = await themHocsinh(hs);
      hideLoading();
      if (res.success) location.reload();
      else document.getElementById('themhs-error').innerText = res.message || "Lỗi thêm học sinh!";
    }
    function showModalImportHS() {
      document.getElementById('import-error').innerText = "";
      document.getElementById('import-file').value = "";
      new bootstrap.Modal(document.getElementById('modalImportHS')).show();
    }
    async function handleImportHS() {
      const fileInput = document.getElementById('import-file');
      const errorDiv = document.getElementById('import-error');
      errorDiv.innerText = "";
      if (!fileInput.files.length) {
        errorDiv.innerText = "Vui lòng chọn file!";
        return;
      }
      const file = fileInput.files[0];
      showLoading();
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        rows.shift();
        const ds = rows.map(row => ({
          ma_so_bhxh: String(row[1] || ""),
          ho_ten_hoc_sinh: row[2] || "",
          ngay_sinh: excelDateToString(row[3]),
          gioi_tinh: row[4] || "",
          dia_chi: row[5] || "",
          lop: row[6] || user.lop_hoc,
          sdt_lienhe: row[7] || "",
          so_dinh_danh: String(row[8] || ""),
          ma_truong: user.ma_truong
        }));
        const res = await importDanhSachHocsinh(ds);
        hideLoading();
        if (res.success) location.reload();
        else errorDiv.innerText = res.message || "Lỗi import dữ liệu!";
      } catch (err) {
        hideLoading();
        errorDiv.innerText = "Lỗi đọc file hoặc dữ liệu không đúng định dạng!";
      }
    }
  </script>
</body>
</html>
