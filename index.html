<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quản Lý Y Tế Trường Học</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
      body {
        background: url("https://source.unsplash.com/1080x1920/?education,school") no-repeat center center/cover;
        min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0;
      }
      .auth-box { background: rgba(255,255,255,0.95); padding: 3rem 2rem; border-radius: 16px; width: 90vw; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.25);}
      .auth-title { font-weight: bold; margin-bottom: 2rem; color: #001f54; font-size: 1.8rem;}
      .form-control { font-size: 1.1rem; padding: 0.8rem 1rem; border-radius: 30px;}
      .btn-primary { background-color: #001f54; border: none; font-size: 1.1rem; padding: 0.8rem; border-radius: 30px;}
      .toggle-link { cursor: pointer; color: #001f54; font-size: 1rem; display: block; margin-top: 0.5rem;}
    </style>
  </head>
  <body>
    <div class="auth-box">
      <h3 class="auth-title">QUẢN LÝ<br />Y TẾ TRƯỜNG HỌC</h3>
      <!-- Đăng nhập -->
      <div id="login-section">
        <input type="text" id="login-sdt" class="form-control mb-3" placeholder="Số điện thoại" required/>
        <input type="password" id="login-password" class="form-control mb-3" placeholder="Mật khẩu" required/>
        <button class="btn btn-primary w-100 mb-3" onclick="handleLogin()">ĐĂNG NHẬP</button>
        <div class="toggle-link" onclick="showRegister()">Chưa có tài khoản? Đăng ký</div>
        <div class="toggle-link" onclick="showForgotPassword()">Quên mật khẩu?</div>
      </div>
      <!-- Đăng ký -->
      <div id="register-section" style="display:none;">
        <input type="text" id="reg-ho-ten" class="form-control mb-3" placeholder="Họ và tên" required/>
        <input type="text" id="reg-sdt" class="form-control mb-3" placeholder="Số điện thoại" required/>
        <input type="password" id="reg-password" class="form-control mb-3" placeholder="Mật khẩu" required/>
        <input type="text" id="reg-ma-truong" class="form-control mb-3" placeholder="Mã trường"/>
        <div class="mb-3 text-start">
          <label class="form-label d-block mb-2">Bạn là giáo viên hay phụ huynh?</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="reg-loai-user" id="radio-phu-huynh" value="phu_huynh" checked/>
            <label class="form-check-label" for="radio-phu-huynh">Phụ huynh học sinh</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="reg-loai-user" id="radio-giao-vien" value="giao_vien"/>
            <label class="form-check-label" for="radio-giao-vien">Giáo viên</label>
          </div>
        </div>
        <button class="btn btn-primary w-100 mb-3" onclick="handleRegister()">ĐĂNG KÝ</button>
        <div class="toggle-link" onclick="showLogin()">Đã có tài khoản? Đăng nhập</div>
      </div>
    </div>

    <!-- Modal Thông báo -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thông báo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div></div>
    </div>
    <!-- Modal Quên mật khẩu -->
    <div class="modal fade" id="forgotModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yêu cầu cấp lại mật khẩu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="forgot-sdt" class="form-control mb-2" placeholder="Nhập số điện thoại tài khoản"/>
          <div id="forgot-error" class="text-danger" style="min-height:20px;"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-primary" onclick="handleForgot()">Gửi yêu cầu</button>
        </div>
      </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
      function showRegister() { document.getElementById("login-section").style.display = "none"; document.getElementById("register-section").style.display = "block";}
      function showLogin() { document.getElementById("register-section").style.display = "none"; document.getElementById("login-section").style.display = "block";}
      function showModal(title, message) {
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalMessage").innerText = message;
        const modal = new bootstrap.Modal(document.getElementById("messageModal"));
        modal.show();
      }
      async function handleLogin() {
        showLoading();
        const sdt = document.getElementById("login-sdt").value.trim();
        const password = document.getElementById("login-password").value;

        if (!sdt || !password) { 
          showModal("Lỗi", "Vui lòng nhập số điện thoại và mật khẩu."); 
          hideLoading(); 
          return; 
        }

        const res = await login(sdt, password);
        if (res.success) {
          showModal("Thành công", "Đăng nhập thành công!");
          localStorage.setItem("user", JSON.stringify(res.user));
          hideLoading();

          // ✅ Điều hướng theo quyền
          setTimeout(() => { 
            const role = String(res.user.phan_quyen || "").toLowerCase();
            if (role === "super_admin" || role === "superadmin") {
              window.location.href = "views/superadmin_dashboard.html";
            } else if (role === "admin") {
              window.location.href = "views/admin_dashboard.html";
            } else {
              window.location.href = "views/dashboard.html";
            }
          }, 1200);

        } else {
          showModal("Lỗi đăng nhập", res.message); 
          hideLoading();
        }
      }
      
      async function handleRegister() {
        const hoTen = document.getElementById("reg-ho-ten").value.trim();
        const sdt = document.getElementById("reg-sdt").value.trim();
        const password = document.getElementById("reg-password").value;
        const maTruong = document.getElementById("reg-ma-truong").value.trim();
        const loaiUser = document.querySelector('input[name="reg-loai-user"]:checked').value;

        if (!hoTen || !sdt || !password || !maTruong) { showModal("Cảnh báo", "Vui lòng nhập đầy đủ thông tin."); return; }
        const phoneRegex = /^[0-9]{9,11}$/; if (!phoneRegex.test(sdt)) { showModal("Cảnh báo", "Số điện thoại không hợp lệ."); return; }
        if (password.length < 6) { showModal("Cảnh báo", "Mật khẩu phải từ 6 ký tự trở lên."); return; }
        const user = { ho_ten: hoTen, sdt: sdt, password: password, ma_truong: maTruong, loai_user: loaiUser };
        const res = await register(user);
        if (res.success) {
          showLoading(); // <-- Thêm dòng này
          showModal("Thành công", "Tạo tài khoản thành công. Vui lòng đăng nhập!");
          setTimeout(() => { showLogin(); }, 1500);
          hideLoading(); // <-- Thêm dòng này
        } else {
          // Hiển thị lỗi mã trường không hợp lệ riêng biệt (nếu muốn UX tốt hơn)
          if (res.message && res.message.indexOf("Mã trường không hợp lệ") !== -1) {
            showModal("Lỗi đăng ký", "Mã trường không hợp lệ, vui lòng kiểm tra lại!");
          } else {
            showModal("Lỗi đăng ký", res.message || "Đăng ký thất bại.");
          }
        }
      }

      function showForgotPassword() {
        const modal = new bootstrap.Modal(document.getElementById("forgotModal"));
        modal.show();
      }
      async function handleForgot() {
        const sdt = document.getElementById("forgot-sdt").value.trim();
        const errorDiv = document.getElementById("forgot-error");
        errorDiv.innerText = "";
        const phoneRegex = /^[0-9]{9,11}$/;
        if (!sdt) { errorDiv.innerText = "Vui lòng nhập số điện thoại."; return; }
        if (!phoneRegex.test(sdt)) { errorDiv.innerText = "Số điện thoại không hợp lệ."; return; }
        const res = await forgotPassword(sdt); // Gọi qua api.js
        if (res.success) {
          const forgotModal = bootstrap.Modal.getInstance(document.getElementById("forgotModal"));
          forgotModal.hide();
          showLoading(); // <-- Thêm dòng này
          setTimeout(() => { showModal("Thành công", res.message); }, 300);
          hideLoading(); // <-- Thêm dòng này
        } else { errorDiv.innerText = res.message; }
      }




      function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'flex';
      }
      function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
      }

    </script>


    <!-- Loading Spinner -->
    <div id="loadingSpinner" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background:rgba(255,255,255,0.5); 
      align-items:center; justify-content:center;">
      <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

  </body>
</html>
